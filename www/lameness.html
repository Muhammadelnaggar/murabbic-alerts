<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/forms.css">
  <title>تسجيل العرج</title>
  <style>
    body {
      background-color: #fff9db;
      direction: rtl;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      margin: 0;
    }
    h2 {
      color: #2e7d32;
      text-align: center;
      margin-bottom: 25px;
      font-size: 24px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 560px;
      margin: 0 auto;
      background: #fffef4;
      padding: 16px;
      border: 1px solid #ffe08a;
      border-radius: 10px;
    }
    label {
      font-weight: bold;
      font-size: 18px;
    }
    input, select, button {
      padding: 14px;
      font-size: 18px;
      border-radius: 8px;
      border: 1px solid #2e7d32; /* ✅ تصحيح كود اللون */
      box-sizing: border-box;
      background: #fff;
    }
    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 17px;
      background-color: #e8f5e9;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #2e7d32;
      cursor: pointer;
    }
    button[type="submit"] {
      background-color: #2e7d32;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    /* رسالة داخلية */
    #msg {
      display: none;
      text-align: center;
      font-weight: bold;
      margin: 10px auto 0;
      padding: 10px;
      border-radius: 8px;
      max-width: 560px;
    }
    #msg.success { background:#d1e7dd; color:#0f5132; border:1px solid #a3cfbb; }
    #msg.error   { background:#f8d7da; color:#842029; border:1px solid #f1aeb5; }
  </style>
</head>
<body>
  <h2>تسجيل حالة العرج</h2>

  <div id="msg"></div>

  <form id="lamenessForm">
    <label for="animalId">رقم الحيوان</label>
    <input type="text" id="animalId" name="animalId" required>

    <label for="lamenessDate">تاريخ العرج</label>
    <input type="date" id="lamenessDate" name="lamenessDate" required>

    <label>الحافر المصاب</label>
    <div class="radio-group">
      <label><input type="radio" name="affectedLeg" value="أمام يمين" required> أمام يمين</label>
      <label><input type="radio" name="affectedLeg" value="أمام شمال"> أمام شمال</label>
      <label><input type="radio" name="affectedLeg" value="خلف يمين"> خلف يمين</label>
      <label><input type="radio" name="affectedLeg" value="خلف شمال"> خلف شمال</label>
    </div>

    <label for="lamenessType">نوع العرج</label>
    <select id="lamenessType" name="lamenessType" required>
      <option value="">اختر</option>
      <option value="قرحة">قرحة</option>
      <option value="تعفن الحافر">تعفن الحافر</option>
      <option value="خراج الحافر">خراج الحافر</option>
      <option value="جسم معدني">جسم معدني</option>
      <option value="التهاب ما بين الأظلاف">التهاب ما بين الأظلاف</option>
      <option value="التهاب الصفائح الحساسة">التهاب الصفائح الحساسة</option>
    </select>

    <label for="vet">اسم الطبيب البيطري المعالج</label>
    <input type="text" id="vet" name="vet" placeholder="اختياري">

    <button type="submit" id="saveBtn">تسجيل الحالة</button>
  </form>

  <!-- تتبّع بسيط -->
  <script>
    (function () {
      window.dataLayer = window.dataLayer || [];
      window.__sentEvents = window.__sentEvents || new Set();
      window.t = window.t || {
        event: function (name, props) {
          try {
            props = props || {};
            if (name === 'page_view') {
              var key = 'pv:' + (props.page || location.pathname);
              if (window.__sentEvents.has(key)) return;
              window.__sentEvents.add(key);
            }
            dataLayer.push({ event: name, ts: Date.now(), ...props });
          } catch (e) {}
        }
      };
      t.event('page_view', { page: location.pathname, feature: 'lameness' });
    })();
  </script>

  <!-- اختياري -->
  <script src="/js/app-core.js" defer></script>

  <!-- Firebase config (murabbikdata) -->
  <script type="module">
    import { db, auth, ensureAuth } from '/js/firebase-config.js';
    import {
      addDoc, collection, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // إعدادات رسائل وتوجيه
    const REDIRECT_DELAY_MS = 3200; // مدة انتظار قبل التحويل بعد النجاح

    const form = document.getElementById('lamenessForm');
    const msg  = document.getElementById('msg');
    const btn  = document.getElementById('saveBtn');

    // اليوم المحلي YYYY-MM-DD
    function todayLocal(){
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().slice(0,10);
    }

    // تهيئة الحقول من URL أو التخزين
    function hydrate(){
      const qs = new URLSearchParams(location.search);
      const id = qs.get('animalId') || qs.get('number') || qs.get('animalNumber')
               || localStorage.getItem('currentAnimalId') || localStorage.getItem('lastAnimalId') || '';
      const dt = qs.get('date') || qs.get('eventDate') || todayLocal();
      document.getElementById('animalId').value     = id;
      document.getElementById('lamenessDate').value = dt;
      try {
        localStorage.setItem('currentAnimalId', id);
        localStorage.setItem('lastAnimalId', id);
        localStorage.setItem('lastEventDate', dt);
      } catch {}
      try { history.replaceState(null, '', location.pathname); } catch {}
    }
    hydrate();

    function showMsg(text, ok){
      msg.textContent = text;
      msg.className = ok ? 'success' : 'error';
      msg.style.display = 'block';
      try { msg.scrollIntoView({ behavior:'smooth', block:'center' }); } catch {}
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg.style.display = 'none';
      btn.disabled = true;

      try {
        // التحقق من تسجيل الدخول (متوافق مع قواعد Firestore)
        await ensureAuth();
        const uid = auth.currentUser?.uid || null;
        if(!uid){
          showMsg('⚠️ يجب تسجيل الدخول أولًا.', false);
          btn.disabled = false;
          return;
        }

        // جمع المدخلات
        const animalId     = document.getElementById('animalId').value.trim();
        const lamenessDate = document.getElementById('lamenessDate').value;
        const affectedLegEl= document.querySelector('input[name="affectedLeg"]:checked');
        const affectedLeg  = affectedLegEl ? affectedLegEl.value : '';
        const lamenessType = document.getElementById('lamenessType').value;
        const vet          = (document.getElementById('vet').value || '').trim() || null;

        if(!animalId || !lamenessDate || !affectedLeg || !lamenessType){
          showMsg('يرجى استكمال البيانات المطلوبة.', false);
          btn.disabled = false;
          return;
        }

        // تجهيز الحمولة بما يراعي القواعد: userId يجب يساوي uid
        const tenantId = localStorage.getItem('tenantId') || null;

        const payload = {
          type: 'عرج',                 // للعرض بالعربي
          eventType: 'lameness',       // للتصنيف في القوائم
          eventDate: lamenessDate,
          animalId,
          animalNumber: animalId,      // توافق مع صفحات أخرى
          affectedLeg,
          lamenessType,
          vet,
          userId: uid,                 // ✅ حسب قواعد Firestore
          tenantId,
          source: location.pathname,
          createdAt: serverTimestamp()
        };

        // الحفظ في مجموعة events
        const ref = await addDoc(collection(db, 'events'), payload);
        if(!ref?.id) throw new Error('NO_ID');

        // تتبّع نجاح
        try { window.t && window.t.event('lameness_save', { animalId, date: lamenessDate }); } catch {}

        // رسالة نجاح + تحويل للوحة التحكم
        try {
          localStorage.setItem('lastAnimalId', animalId);
          localStorage.setItem('lastEventDate', lamenessDate);
        } catch {}

        showMsg('✅ تم تسجيل حالة العرج بنجاح! سيتم تحويلك تلقائيًا…', true);
        setTimeout(()=>{ location.href = 'dashboard.html'; }, REDIRECT_DELAY_MS);
      } catch (err) {
        console.error('[lameness save] FAILED', err);
        showMsg('❌ تعذّر الحفظ في فايرستور. تأكّد من تسجيل الدخول والصلاحيات.', false);
        btn.disabled = false;
      } finally {
        // إعادة تفعيل الزر لو فشل فقط (لو نجح هنحوّل بعد ثواني)
        setTimeout(()=>{ btn.disabled = false; }, 800);
      }
    });
  </script>
</body>
</html>
