<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <title>Ø§Ù„ØªØ¬ÙÙŠÙ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</title>

  <!-- âœ… Murabbik global styles + central validation/gate -->
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <!-- (Ø§ØªØ±ÙƒÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ Ø§Ù„Ø¢Ù† Ø­ØªÙ‰ Ù„Ø§ Ù†ÙƒØ³Ø± Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ) -->
 <script type="module" src="/js/animal-update.js"></script>



  <style>
    /* âœ… Header (Murabbik standard) */
    header{
      position: sticky;
      top: 0;
      z-index: 20;
      background: #fff;
      border-bottom: 1px solid var(--border, #e2e8f0);
    }
    .mbk-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
    }
    .mbk-logo{
      width:auto;
      height:48px;
      object-fit:contain;
      opacity:.95;
      flex-shrink:0;
    }
    .mbk-center{
      flex:1;
      text-align:center;
      line-height:1.2;
    }
    .mbk-page-title{
      font-size:18px;
      font-weight:900;
      color: var(--ink, #0f172a);
    }
    .mbk-app-name{
      font-size:13px;
      font-weight:800;
      color: var(--brand-600, #0b7f47);
      opacity:.9;
    }
    .mbk-back{
      width:42px;
      height:42px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      font-weight:900;
      color: var(--brand-600, #0b7f47);
      border:2px solid var(--brand-600, #0b7f47);
      background:#fff;
      flex-shrink:0;
    }

    /* âœ… Page layout uses forms.css tokens */
    .wrap{
      max-width:520px;
      margin:12px auto 24px;
      padding:0 12px;
    }
    .mbk-card{
      background:#fff;
      border:1px solid var(--border, #e2e8f0);
      border-radius:16px;
      padding:14px;
      box-shadow:0 1px 0 rgba(15,23,42,.04);
    }
    .field{ margin-bottom:12px; }

    /* âœ… option-group chips (Murabbik style) */
    .option-group{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:8px;
      margin-bottom:8px;
    }
    .option-group label{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border, #e2e8f0);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      font-size:14px;
    }
    .option-group input{ width:auto; padding:0; margin:0; }

    /* âœ… Bottom actions (Murabbik style) */
    .btn-row{
      position: sticky;
      bottom: 10px;
      background: #fff;
      padding: 10px;
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 16px;
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    .btn-row .save-btn,
    .btn-row .open-card{
      flex:1;
      width:auto;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    .btn-row .save-btn{
      background: var(--brand, #0ea05a);
      color:#fff;
      border:0;
    }
    .btn-row .open-card{
      background:#fff !important;
      color: var(--brand-600, #0b7f47) !important;
      border:2px solid var(--brand-600, #0b7f47) !important;
    }
     .gest-box{
  display:flex; gap:10px; align-items:center;
}
.gest-box input{
  flex:1;
}
.gest-badge{
  min-width:44px;
  height:38px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  padding:0 10px;
  font-weight:900;
  border:2px solid #cbd5e1;
  background:#f8fafc;
  color:#0f172a;
}
.gest-badge.ok{
  border-color:#16a34a;
  background:#ecfdf5;
  color:#065f46;
}
.gest-badge.warn{
  border-color:#f59e0b;
  background:#fffbeb;
  color:#92400e;
}
.gest-badge.bad{
  border-color:#ef4444;
  background:#fff1f2;
  color:#991b1b;
}
.gest-note{
  display:block;
  margin-top:6px;
  color:#64748b;
  font-weight:700;
  font-size:12px;
}

    /* âœ… keep infobar clean */
    #info.infobar{ display:none; }
  </style>
</head>

<body>
  <!-- âœ… Murabbik Standard Header -->
  <header>
    <div class="mbk-head">
      <a class="mbk-back" href="add-event.html" title="Ø±Ø¬ÙˆØ¹">Ø±Ø¬ÙˆØ¹</a>

      <div class="mbk-center">
        <div class="mbk-page-title">Ø§Ù„ØªØ¬ÙÙŠÙ</div>
        <div class="mbk-app-name">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
      </div>

      <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
    </div>
  </header>

  <div class="wrap">
    <!-- âœ… Infobar (Ø³ÙŠØ³ØªØ®Ø¯Ù…Ù‡ showMsg) -->
    <div id="info" class="infobar"></div>

    <form id="dryOffForm" class="mbk-card">
      <div class="field">
        <label for="animal-id">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
        <input type="text" id="animal-id" required />
      </div>

      <div class="field">
        <label for="date">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¬ÙÙŠÙ</label>
        <input type="date" id="date" required />
      </div>
<label>Ø´Ù‡ÙˆØ± Ø§Ù„Ø­Ù…Ù„ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
<div class="gest-box">
  <input id="gestMonths" type="text" readonly value="â€”" />
  <span id="gestBadge" class="gest-badge">â€”</span>
</div>
<small class="gest-note" id="gestNote"></small>

      <div class="field">
        <label>Ø³Ø¨Ø¨ Ø§Ù„ØªØ¬ÙÙŠÙ</label>
        <div class="option-group">
          <label><input type="radio" name="reason" value="Ø·Ø¨ÙŠØ¹ÙŠ" required /> Ø·Ø¨ÙŠØ¹ÙŠ</label>
          <label><input type="radio" name="reason" value="Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ" required /> Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ</label>
        </div>
      </div>

      <div class="field">
        <label>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ù…Ù„</label>
        <div class="option-group">
          <label><input type="radio" name="pregnancy" value="Ø¹Ø´Ø§Ø±" required /> Ø¹Ø´Ø§Ø±</label>
          <label><input type="radio" name="pregnancy" value="ÙØ§Ø±ØºØ©" required /> ÙØ§Ø±ØºØ©</label>
        </div>
      </div>

      <div class="field">
        <label>ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø­Ø§Ù‚Ù† Ø§Ù„ØªØ¬ÙÙŠÙØŸ</label>
        <div class="option-group">
          <label><input type="radio" name="antibiotics" value="Ù†Ø¹Ù…" required /> Ù†Ø¹Ù…</label>
          <label><input type="radio" name="antibiotics" value="Ù„Ø§" required /> Ù„Ø§</label>
        </div>
      </div>

      <!-- âœ… Bottom actions -->
      <div class="btn-row">
        <button class="save-btn" type="submit">Ø­ÙØ¸ Ø§Ù„ØªØ¬ÙÙŠÙ</button>
        <button class="open-card" id="openCowCard" type="button">ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
      </div>
    </form>
  </div>

  <script type="module">
    import { db, auth, requireAuth } from "/js/firebase-config.js";
  import {
  collection, doc, getDoc, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


    const form  = document.getElementById("dryOffForm");
    const idEl  = document.getElementById("animal-id");
    const dateEl= document.getElementById("date");
    const info  = document.getElementById("info");
    const openCardBtn = document.getElementById("openCowCard");
    const gestEl   = document.getElementById("gestMonths");
const badgeEl  = document.getElementById("gestBadge");
const noteEl   = document.getElementById("gestNote");


   function showMsg(txt, isErr=false){
  if(!info) return;

  info.style.display = "block";
  info.className = "infobar " + (isErr ? "error" : "show");

  if (isErr){
    info.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <span>${txt}</span>
        <button type="button" id="infoOkBtn"
          style="border:0;border-radius:12px;padding:8px 12px;font-weight:900;cursor:pointer;
                 background:#fff;color:inherit;border:1px solid rgba(0,0,0,.12)">
          Ø­Ø³Ù†Ù‹Ø§
        </button>
      </div>
    `;
    const ok = document.getElementById("infoOkBtn");
    ok?.addEventListener("click", ()=>{ info.style.display="none"; });
  } else {
    info.textContent = txt;
    setTimeout(()=>{ info.style.display = "none"; }, 3500);
  }

  try{ info.scrollIntoView({behavior:"smooth", block:"start"}); }catch{}
}

    function todayYYYYMMDD(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${m}-${day}`;
    }
    function daysBetween(aISO, bISO){
  const a = new Date(aISO + "T00:00:00");
  const b = new Date(bISO + "T00:00:00");
  const ms = b - a;
  return Math.floor(ms / 86400000);
}

function setGestBadge(months){
  if (!badgeEl) return;

  badgeEl.classList.remove("ok","warn","bad");

  // ğŸŸ¢ 6â€“7 / ğŸ”´ <6 / ğŸ”´ >7.5 / ğŸŸ  7â€“7.5
  if (months >= 6 && months <= 7){
    badgeEl.textContent = "âœ”";
    badgeEl.classList.add("ok");
  } else if (months < 6 || months > 7.5){
    badgeEl.textContent = "âœ–";
    badgeEl.classList.add("bad");
  } else {
    badgeEl.textContent = "!";
    badgeEl.classList.add("warn");
  }
}


async function calcGestation(){
  if (!gestEl || !badgeEl) return;

  const animalNumber = (idEl.value || "").trim();
  const dryDate      = (dateEl.value || "").trim();

  gestEl.value = "â€”";
  badgeEl.textContent = "â€”";
  badgeEl.classList.remove("ok","warn","bad");
  if (noteEl) noteEl.textContent = "";

  if (!animalNumber || !dryDate) return;

  // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† login Ø¹Ù„Ø´Ø§Ù† Ù†Ù‚Ø±Ø£ events
  try { await requireAuth(); } catch { return; }

  const uid = auth.currentUser?.uid;
  if (!uid) return;

 // Ø¬Ù„Ø¨ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
const animalRef = doc(db, "animals", animalNumber);
const animalSnap = await getDoc(animalRef);

if (!animalSnap.exists()) {
  gestEl.value = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ÙŠÙˆØ§Ù†";
  if (noteEl) noteEl.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†";
  return;
}

const animalData = animalSnap.data() || {};
const insDate = animalData.lastInseminationDate || "";

if (!insDate) {
  gestEl.value = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ„Ù‚ÙŠØ­";
  if (noteEl) noteEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­ Ù…Ø³Ø¬Ù„ ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†";
  return;
}


  if (!insDate){
    gestEl.value = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ„Ù‚ÙŠØ­";
    if (noteEl) noteEl.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­ Ù…Ø³Ø¬Ù‘Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù†.";
    return;
  }

  const d = daysBetween(insDate, dryDate);
  const months = +(d / 30.5).toFixed(1);

  gestEl.value = `${months} Ø´Ù‡Ø±`;
  setGestBadge(months);

  if (noteEl) {
    noteEl.textContent = `Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­: ${insDate} â€” ÙØ±Ù‚ ${d} ÙŠÙˆÙ…`;
  }
}

    window.onload = function () {
      const qp = new URLSearchParams(location.search);
      const qpId = qp.get('animalId') || qp.get('number') || qp.get('animalNumber') || "";
      const storedAnimalId = localStorage.getItem("lastAnimalId") || "";
      const id = qpId || storedAnimalId;

      if (id) {
        idEl.value = id;
        idEl.readOnly = true;
      } else {
        showMsg("â— Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­ÙŠÙˆØ§Ù† â€” Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„ØªØ³Ø¬ÙŠÙ„ Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯", true);
        setTimeout(()=>{ window.location.href = "add-animal.html"; }, 900);
        return;
      }

      if (qpId) { try { localStorage.setItem("lastAnimalId", qpId); } catch {} }
      if (!dateEl.value) dateEl.value = todayYYYYMMDD();
      calcGestation().catch(()=>{});
    

    };
 
    // âœ… ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
    openCardBtn?.addEventListener("click", ()=>{
      const n = (idEl.value || "").trim();
      if (!n) return;
      location.href = `/cow-card.html?number=${encodeURIComponent(n)}`;
    });

    // (Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ…Ø§ Ù‡Ùˆ â€” Ù„Ù… Ù†ÙƒÙ…Ù„Ù‡ Ø§Ù„Ø¢Ù†)
    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      try { await requireAuth(); }
      catch {
        window.location.href = "/login.html?next=" + encodeURIComponent(location.href);
        return;
      }

      const data = {
        animalId: idEl.value.trim(),
        dryOffDate: dateEl.value,
        eventDate: dateEl.value,
        reason: document.querySelector('input[name="reason"]:checked')?.value || null,
        pregnancyStatus: document.querySelector('input[name="pregnancy"]:checked')?.value || null,
        usedDryingAntibiotics: document.querySelector('input[name="antibiotics"]:checked')?.value || null,
        type: "ØªØ¬ÙÙŠÙ",
        eventType: "dry_off",
        tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC",
        source: location.href,
        userId: auth.currentUser?.uid || null,
        isSmartAlert: true,
        alertRule: "ØªØ¬ÙÙŠÙ",
        createdAt: serverTimestamp()
      };

      if (!data.animalId || !data.dryOffDate) {
        showMsg("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¬ÙÙŠÙ Ø£ÙˆÙ„Ù‹Ø§", true);
        return;
      }

      try {
        const btn = form.querySelector('button[type="submit"]');
        if (btn) btn.disabled = true;

        await addDoc(collection(db, "events"), data);
        if (window.updateAnimalByEvent) await window.updateAnimalByEvent(data);

        try { localStorage.setItem("lastAnimalId", data.animalId); } catch {}
        showMsg("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¬ÙÙŠÙ Ø¨Ù†Ø¬Ø§Ø­");

        // (Ø§ØªØ±Ùƒ Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¹Ù†Ø¯Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹)
        setTimeout(()=>{ window.location.href = "dashboard.html"; }, 900);

      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£:", error);
        showMsg("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆÙ‚ÙˆØ§Ø¹Ø¯ ÙØ§ÙŠØ±Ø³ØªÙˆØ±.", true);
        const btn = form.querySelector('button[type="submit"]');
        if (btn) btn.disabled = false;
      }
    });
   
    dateEl?.addEventListener("change", ()=>{ calcGestation().catch(()=>{}); });
idEl?.addEventListener("input", ()=>{ calcGestation().catch(()=>{}); });

  </script>
</body>
</html>






