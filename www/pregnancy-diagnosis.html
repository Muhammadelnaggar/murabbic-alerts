<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تشخيص الحمل — مُرَبِّك</title>
  <link rel="stylesheet" href="css/forms.css" />
  <style>
    :root{
      --green:#2e7d32; --green-600:#1b5e20;
      --bg:#fff9db; --card:#ffffff; --ink:#143b24;
      --border:#c5e1a5;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,'Cairo','Segoe UI',Tahoma,Arial}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px}
    header .t{font-weight:800;color:var(--green-600)}
    .wrap{max-width:720px;margin:12px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .label{font-weight:700;margin:8px 0 6px}
    input[type="text"],input[type="date"]{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--ink)
    }
    fieldset{border:2px solid var(--green-600);border-radius:12px;padding:12px;margin:14px 0}
    legend{font-weight:800;color:var(--green-600);padding:0 8px}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1 1 240px;min-width:240px}
    .radios label{display:inline-flex;align-items:center;gap:6px;margin-inline-end:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;background:var(--green);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;width:100%}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .infobar{margin-top:12px;padding:10px;border-radius:10px;font-weight:800;display:none}
    .infobar.ok{display:block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .hint{display:inline-block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46;border-radius:999px;padding:2px 10px;font-size:12px;margin-inline-start:6px}
  </style>
</head>
<body>

<header><span class="t">تشخيص الحمل — مُرَبِّك</span></header>

<div class="wrap">
  <form class="card" id="diagnosisForm" autocomplete="off">
    <div class="label">رقم الحيوان <span class="hint">مطلوب</span></div>
    <input type="text" name="animalId" inputmode="numeric" placeholder="اكتب رقم الحيوان" />

    <div class="label">تاريخ التشخيص <span class="hint">مطلوب</span></div>
    <input type="date" name="eventDate" />

    <fieldset>
      <legend>تشخيص الحمل</legend>
      <div class="row">
        <div class="col">
          <div class="label">طريقة التشخيص <span class="hint">سونار ≥ 26 • جس يدوي ≥ 40</span></div>
          <div class="radios">
            <label><input type="radio" name="method" value="سونار" /> سونار</label>
            <label><input type="radio" name="method" value="جس يدوي" /> جس يدوي</label>
          </div>
        </div>

        <div class="col">
          <div class="label">النتيجة</div>
          <div class="radios">
            <label><input type="radio" name="result" value="عشار" /> عشار</label>
            <label><input type="radio" name="result" value="فارغة" /> فارغة</label>
          </div>
        </div>
      </div>
    </fieldset>

    <div class="label">اسم الطبيب البيطري (اختياري)</div>
    <input type="text" name="vet" />

    <button type="submit" id="saveBtn" class="btn" disabled>تسجيل التشخيص</button>
    <div id="okbar" class="infobar ok" role="status" aria-live="polite" style="display:none"></div>
  </form>
</div>

<script>window.dataLayer = window.dataLayer || [];</script>

<!-- Prefill من add-event/localStorage (بدون أي تغيير بصري) -->
<script type="module">
  (function prefill(){
    const qs = new URLSearchParams(location.search);
    const animal =
      (qs.get("number") ?? qs.get("animalId") ?? qs.get("animalNumber") ??
       localStorage.getItem("currentAnimalId") ?? localStorage.getItem("lastAnimalId") ?? "").toString().trim();

    const date =
      (qs.get("date") ?? qs.get("eventDate") ?? localStorage.getItem("currentEventDate") ??
       localStorage.getItem("lastEventDate") ?? new Date().toISOString().slice(0,10));

    const form = document.getElementById("diagnosisForm");
    if (animal) form.elements.animalId.value = animal;
    if (date)   form.elements.eventDate.value = date;

    if (animal) {
      localStorage.setItem("currentAnimalId", animal);
      localStorage.setItem("lastAnimalId", animal);
    }
    if (date) {
      localStorage.setItem("currentEventDate", date);
      localStorage.setItem("lastEventDate", date);
    }
  })();
</script>

<!-- منطق الصفحة: فاليديشن مركزي من DB فقط + حفظ -->
<script type="module">
  import { db, auth, ensureAuth } from "/js/firebase-config.js";
  import {
    addDoc, collection, serverTimestamp, query, where, getDocs, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { validateEvent } from "/js/form-rules.js";   // ✅ مصدر وحيد للفاليديشن

  try { window.dataLayer.push({event:"page_view", page: location.pathname}); } catch {}

  const $      = (s)=>document.querySelector(s);
  const form   = $("#diagnosisForm");
  const okbar  = $("#okbar");
  const saveBtn= $("#saveBtn");

  await ensureAuth("/login.html");

  // ————— جلب سياق الفاليديشن من قاعدة البيانات —————
// ————— جلب سياق الفاليديشن من قاعدة البيانات —————
async function getCtx(animalId, untilDate){
  const userId = auth.currentUser?.uid;
  let reproStatus = null, animalDocId = null, lastInseminationDate = null;

  // 1) animals: نلتقط الحالة التناسلية بأي معرّف محفوظ
  try {
    const animalsRef = collection(db, "animals");
    const q1 = query(animalsRef, where("userId","==", userId));
    const snap = await getDocs(q1);
    const match = snap.docs.find(d=>{
      const a = d.data() || {};
      const ids = [a.animalId, a.number, a.animalNumber, a.tag, a.earTag]
        .filter(Boolean).map(v=>String(v).trim());
      return ids.includes(String(animalId));
    });
    if (match){
      animalDocId = match.id;
      const a = match.data() || {};
      reproStatus = a.reproductiveStatus || a.reproStatus || null;
    }
  } catch {}

  // 2) events: نبحث بسجلات محفوظة بـ animalNumber أو animalId
  try {
    const evRef = collection(db, "events");
    const qNum = query(evRef, where("userId","==", userId), where("animalNumber","==", String(animalId)));
    const qId  = query(evRef, where("userId","==", userId), where("animalId","==", String(animalId)));
    const [snapNum, snapId] = await Promise.all([getDocs(qNum).catch(()=>null), getDocs(qId).catch(()=>null)]);

    // نغطي كل المسميات المحتملة لنوع حدث التلقيح
    const INSEM_TYPES = new Set([
      "تلقيح","تلقيح مخصب","تلقيح مُخصِّب","خدمة",
      "AI","Insemination","insemination","Service","service"
    ]);

    const ed = new Date(untilDate).setHours(0,0,0,0);
    let latest = null;

    const consider = (s)=> s && s.forEach(docu=>{
      const e = docu.data() || {};
      const evType = String(e.eventType ?? e.type ?? "").trim();   // ← دعم eventType أو type
      if (!e?.eventDate || !evType) return;
      if (!INSEM_TYPES.has(evType)) return;
      const t = new Date(e.eventDate).setHours(0,0,0,0);
      if (t <= ed && (!latest || t > latest)) latest = t;
    });

    consider(snapNum);
    consider(snapId);

    if (latest) lastInseminationDate = new Date(latest).toISOString().slice(0,10);
  } catch {}

  return { reproStatus, lastInseminationDate, animalDocId };
}
  
  // ————— تشغيل فاليديشن صامت لتمكين/تعطيل زر الحفظ فقط —————
  let lastCheckSig = 0;
  async function silentValidateAndToggle(){
    const sig = ++lastCheckSig;

    const animalId  = form.elements.animalId.value.trim();
    const eventDate = form.elements.eventDate.value;
    const methodEl  = form.querySelector('input[name="method"]:checked');
    const resultEl  = form.querySelector('input[name="result"]:checked');

    // مدخلات أساسية
    if(!animalId || !eventDate || !methodEl || !resultEl){
      saveBtn.disabled = true; return;
    }

    const ctx = await getCtx(animalId, eventDate);
    if (sig !== lastCheckSig) return; // تجاهل نتائج قديمة

    const v = validateEvent("تشخيص حمل", {
      animalId,
      eventDate,
      method: methodEl.value,      // "سونار" | "جس يدوي"
      result: resultEl.value,      // "عشار" | "فارغة"
      reproStatus: ctx.reproStatus,
      lastInseminationDate: ctx.lastInseminationDate
    });

    saveBtn.disabled = !v?.ok;     // لا نعرض أخطاء؛ مجرد تعطيل/تمكين
  }

  // نراقب كل المدخلات لإعادة الفحص الصامت
  ["input","change"].forEach(evt=>{
    form.addEventListener(evt, (e)=>{
      if (e.target && (e.target.name==="animalId" || e.target.name==="eventDate" || e.target.name==="method" || e.target.name==="result")){
        silentValidateAndToggle();
      }
    });
  });
  // فحص أولي بعد التحميل/التهيئة
  window.addEventListener("load", silentValidateAndToggle);

  // ————— الحفظ —————
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();

    // لو الزر مفعّل فالفاليديشن مركزي مرّ بالفعل
    const animalId  = form.elements.animalId.value.trim();
    const eventDate = form.elements.eventDate.value;
    const method    = form.querySelector('input[name="method"]:checked')?.value;
    const result    = form.querySelector('input[name="result"]:checked')?.value;

    const payload = {
      userId: auth.currentUser.uid,
      animalId, animalNumber: String(animalId),
      eventDate, type: "تشخيص حمل",
      method, result,
      vet: form.elements.vet.value?.trim() || "",
      source: location.pathname,
      createdAt: serverTimestamp()
    };

    try {
      await addDoc(collection(db,"events"), payload);

      // كاش محلي
      localStorage.setItem("currentAnimalId", animalId);
      localStorage.setItem("lastAnimalId", animalId);
      localStorage.setItem("currentEventDate", eventDate);
      localStorage.setItem("lastEventDate", eventDate);

      // تحديث وثيقة الحيوان
      try{
        const { animalDocId } = await getCtx(animalId, eventDate);
        if (animalDocId){
          const updates = { lastDiagnosis:"تشخيص حمل", lastDiagnosisDate:eventDate };
          if (result === "عشار")  updates.reproductiveStatus = "عشار";
          if (result === "فارغة") updates.reproductiveStatus = "مفتوحة";
          await updateDoc(doc(db,"animals",animalDocId), updates);
        }
      }catch{}

      // تأكيد أخضر فقط
      okbar.textContent = "✅ تم تسجيل تشخيص الحمل بنجاح";
      okbar.style.display = "block";

      setTimeout(()=>{
        location.href = `add-event.html?number=${encodeURIComponent(animalId)}&date=${encodeURIComponent(eventDate)}`;
      }, 1200);

    } catch (err){
      // لا نعرض أخطاء في الواجهة حسب طلبك
      console.error("Firestore save failed", err);
      // إعادة التعطيل لتفادي تكرار الضغط
      saveBtn.disabled = true;
      // إعادة فحص صامت (في حال تحسّنت الظروف/المدخلات)
      silentValidateAndToggle();
    }
  });
</script>

</body>
</html>
