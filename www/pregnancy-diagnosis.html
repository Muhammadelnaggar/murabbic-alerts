<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تشخيص الحمل — مُرَبِّك</title>
  <link rel="stylesheet" href="css/forms.css" />
  <style>
    :root{
      --green:#2e7d32; --green-600:#1b5e20;
      --bg:#fff9db; --card:#ffffff; --ink:#143b24;
      --border:#c5e1a5;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,'Cairo','Segoe UI',Tahoma,Arial}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px}
    header .t{font-weight:800;color:var(--green-600)}
    .wrap{max-width:720px;margin:12px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .label{font-weight:700;margin:8px 0 6px}
    input[type="text"],input[type="date"]{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--ink)
    }
    fieldset{border:2px solid var(--green-600);border-radius:12px;padding:12px;margin:14px 0}
    legend{font-weight:800;color:var(--green-600);padding:0 8px}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1 1 240px;min-width:240px}
    .radios label{display:inline-flex;align-items:center;gap:6px;margin-inline-end:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;background:var(--green);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;width:100%}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .infobar{margin-top:12px;padding:10px;border-radius:10px;font-weight:800;display:none}
    .infobar.ok{display:block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .hint{display:inline-block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46;border-radius:999px;padding:2px 10px;font-size:12px;margin-inline-start:6px}
  </style>
</head>
<body>

<header><span class="t">تشخيص الحمل — مُرَبِّك</span></header>

<div class="wrap">
  <form class="card" id="diagnosisForm" autocomplete="off">
    <div class="label">رقم الحيوان <span class="hint">مطلوب</span></div>
    <input type="text" name="animalId" inputmode="numeric" placeholder="اكتب رقم الحيوان" />

    <div class="label">تاريخ التشخيص <span class="hint">مطلوب</span></div>
    <input type="date" name="eventDate" />

    <fieldset>
      <legend>تشخيص الحمل</legend>
      <div class="row">
        <div class="col">
          <div class="label">طريقة التشخيص <span class="hint">سونار ≥ 26 • جس يدوي ≥ 40</span></div>
          <div class="radios">
            <label><input type="radio" name="method" value="سونار" /> سونار</label>
            <label><input type="radio" name="method" value="جس يدوي" /> جس يدوي</label>
          </div>
        </div>

        <div class="col">
          <div class="label">النتيجة</div>
          <div class="radios">
            <label><input type="radio" name="result" value="عشار" /> عشار</label>
            <label><input type="radio" name="result" value="فارغة" /> فارغة</label>
          </div>
        </div>
      </div>
    </fieldset>

    <div class="label">اسم الطبيب البيطري (اختياري)</div>
    <input type="text" name="vet" />

    <button type="submit" id="saveBtn" class="btn" disabled>تسجيل التشخيص</button>
    <div id="okbar" class="infobar ok" role="status" aria-live="polite" style="display:none"></div>
  </form>
</div>

<script>window.dataLayer = window.dataLayer || [];</script>

<!-- Prefill من add-event/localStorage (بدون أي تغيير بصري) -->
<script type="module">
  (function prefill(){
    const qs = new URLSearchParams(location.search);
    const animal =
      (qs.get("number") ?? qs.get("animalId") ?? qs.get("animalNumber") ??
       localStorage.getItem("currentAnimalId") ?? localStorage.getItem("lastAnimalId") ?? "").toString().trim();

    const date =
      (qs.get("date") ?? qs.get("eventDate") ?? localStorage.getItem("currentEventDate") ??
       localStorage.getItem("lastEventDate") ?? new Date().toISOString().slice(0,10));

    const form = document.getElementById("diagnosisForm");
    if (animal) form.elements.animalId.value = animal;
    if (date)   form.elements.eventDate.value = date;

    if (animal) {
      localStorage.setItem("currentAnimalId", animal);
      localStorage.setItem("lastAnimalId", animal);
    }
    if (date) {
      localStorage.setItem("currentEventDate", date);
      localStorage.setItem("lastEventDate", date);
    }
  })();
</script>

<!-- منطق الصفحة: فاليديشن مركزي من DB فقط + حفظ -->
<script type="module">
  import { db, auth, ensureAuth } from "/js/firebase-config.js";
  import {
    addDoc, collection, serverTimestamp, query, where, limit, getDocs, orderBy, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { validateEvent } from "/js/form-rules.js";   // نفس المصدر المركزي

  try { window.dataLayer.push({event:"page_view", page: location.pathname}); } catch {}

  await ensureAuth("/login.html");

  const $       = (s)=>document.querySelector(s);
  const form    = $("#diagnosisForm");
  const okbar   = $("#okbar");
  const numEl   = form.elements.animalId;   // نفس أسلوب الولادة: الرقم من الحقل
  const dateEl  = form.elements.eventDate;

  // ===== أدوات مساعدة (نفس روح صفحة الولادة) =====
  function show(msg, isErr=false){
    okbar.textContent = msg;
    okbar.className = "infobar ok" + (isErr ? " error" : "");
    okbar.style.display = "block";
  }
  function hide(){ okbar.style.display = "none"; }
  function todayISO(){
    const d=new Date(); d.setHours(0,0,0,0);
    return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  }
  async function getUid(){
    if (auth.currentUser) return auth.currentUser.uid;
    const u = await new Promise(res => onAuthStateChanged(auth, u=>res(u)));
    return u?.uid || "";
  }
  // البحث عن وثيقة الحيوان بأي حقل شائع (كما في الولادة)
  async function fetchAnimalDocByNumber(number){
    const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9',
                 '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
    const raw = String(number||'').trim().replace(/[^\d٠-٩۰-۹]/g,'').replace(/[٠-٩۰-۹]/g, d=>map[d]);
    const asStr = raw; const asNum = raw ? Number(raw) : NaN;

    const tries = [
      ['animalNumber','==',asStr], ['animalNumber','==',asNum],
      ['number','==',asStr],       ['number','==',asNum],
      ['animalId','==',asStr],     ['animalId','==',asNum],
      ['tag','==',asStr],          ['earTag','==',asStr],
    ].filter(t => !(typeof t[2]==='number' && Number.isNaN(t[2])));

    for (const [field,op,val] of tries){
      const q1 = query(collection(db,'animals'), where(field,op,val), limit(1));
      const snap = await getDocs(q1);
      if (!snap.empty) return { id: snap.docs[0].id, data: snap.docs[0].data()||{} };
    }
    return null;
  }
  // آخر تلقيح (مع userId) وأنواع عربية/إنجليزية
  async function fetchLastInseminationDate(number, untilISO){
    const uid = await getUid();
    const num = String(number||'').trim();
    const qEv = query(
      collection(db,'events'),
      where('userId','==', uid),
      where('animalNumber','==', num),
      orderBy('eventDate','desc'),
      limit(80)
    );
    const snap = await getDocs(qEv);
    const isInsemination = (t)=>{
      const s = String(t||'').trim().toLowerCase();
      return s && (s.includes('تلقيح') || s==='خدمة' || s.includes('insemin') || s==='ai' || s==='service');
    };
    const until = new Date(untilISO).setHours(0,0,0,0);
    let last = null;
    for (const d of snap.docs){
      const ev = d.data()||{};
      const type = ev.eventType ?? ev.type;
      const dt = ev.eventDate;
      if (!dt || !isInsemination(type)) continue;
      const t = new Date(dt).setHours(0,0,0,0);
      if (t <= until && (!last || t > last)) last = t;
      if (t < until && last) break;
    }
    return last ? new Date(last).toISOString().slice(0,10) : "";
  }
  function daysBetweenISO(a,b){
    const A=new Date(a), B=new Date(b);
    if (isNaN(A)||isNaN(B)) return NaN;
    A.setHours(0,0,0,0); B.setHours(0,0,0,0);
    return Math.round((B-A)/86400000);
  }

  // ===== Precheck عند التحميل + عند تغيّر الرقم/التاريخ =====
  async function precheck(){
    hide();
    const number = (numEl?.value||"").trim();
    const evISO  = (dateEl?.value||"").trim() || todayISO();
    if (!number){ show("اكتب رقم الحيوان.", true); return; }
    if (!evISO){  show("اختر تاريخ التشخيص.", true); return; }

    const a = await fetchAnimalDocByNumber(number);
    if (!a){ show("رقم الحيوان غير موجود في قاعدة البيانات.", true); return; }

    // الحالة من كارت الحيوان
    const rs = String(
      a.data.reproductiveStatus || a.data.reproStatus || a.data.repro || ""
    ).trim();

    const okStatus = new Set(["ملقح","ملقّح","ملقحة","ملقّحة"]);
    if (!okStatus.has(rs)){
      show('لا يُسمح بتشخيص الحمل: الحالة التناسلية ليست "ملقّح/ملقّحة".', true);
      return;
    }

    // أقل Gate عام قبل اختيار الطريقة (مثل أسلوب الولادة)
    const lastIns = await fetchLastInseminationDate(number, evISO);
    if (!lastIns){
      show("لا يوجد تلقيح سابق مسجَّل قبل هذا التاريخ.", true);
      return;
    }
    const d = daysBetweenISO(lastIns, evISO);
    if (Number.isNaN(d) || d < 26){
      show(`غير مؤهَّل الآن: يلزم مرور ≥ 26 يوم من آخر تلقيح للتشخيص (سونار). تاريخ آخر تلقيح: ${lastIns}`, true);
      return;
    }

    show("جاهز للتسجيل ✅"); // نفس الأسلوب الودي
  }

  // شغّل الفحص عند التحميل وأي تغيير في الرقم/التاريخ
  window.addEventListener("DOMContentLoaded", precheck);
  numEl?.addEventListener("change", precheck);
  numEl?.addEventListener("blur", precheck);
  dateEl?.addEventListener("change", precheck);

  // ===== الحفظ: فاليديشن مركزي ثم حفظ =====
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();

    hide();

    const animalId  = (numEl?.value||"").trim();
    const eventDate = (dateEl?.value||"").trim() || todayISO();
    const method    = form.querySelector('input[name="method"]:checked')?.value || "";
    const result    = form.querySelector('input[name="result"]:checked')?.value || "";

    // جلب سياق DB كما يعتمد عليه الملف المركزي
    const lastInseminationDate = await fetchLastInseminationDate(animalId, eventDate);
    const a = await fetchAnimalDocByNumber(animalId);
    const reproStatus = String(
      a?.data?.reproductiveStatus || a?.data?.reproStatus || a?.data?.repro || ""
    ).trim();

    const v = validateEvent("تشخيص حمل", {
      animalId, eventDate, method, result,
      reproStatus, lastInseminationDate
    });

    if (!v.ok){
      // نفس أسلوب الولادة: نعرض رسالة فقط
      show("لا يمكن تسجيل التشخيص: " + (v.errors?.join(" — ") || "تحقق من البيانات"), true);
      return;
    }

    // الحفظ
    const payload = {
      userId: await getUid(),
      animalId, animalNumber: String(animalId),
      eventDate,
      type: "تشخيص حمل",
      eventType: "تشخيص حمل",
      method, result,
      vet: form.elements.vet?.value?.trim() || "",
      source: location.pathname,
      createdAt: serverTimestamp()
    };

    try {
      await addDoc(collection(db,"events"), payload);

      // تحديث بطاقة الحيوان (كما اعتدتَ)
      try{
        if (a?.id){
          const updates = { lastDiagnosis:"تشخيص حمل", lastDiagnosisDate:eventDate };
          if (result === "عشار")  updates.reproductiveStatus = "عشار";
          if (result === "فارغة") updates.reproductiveStatus = "مفتوحة";
          await updateDoc(doc(db,"animals", a.id), updates);
        }
      }catch{}

      show("تم تسجيل تشخيص الحمل ✅");
      // رجوع لمسار الأحداث
      setTimeout(()=> {
        location.href = `add-event.html?number=${encodeURIComponent(animalId)}&date=${encodeURIComponent(eventDate)}`;
      }, 700);

    } catch (err){
      console.error(err);
      show("تعذّر الحفظ، حاول لاحقًا.", true);
    }
  });
</script>


</body>
</html>
