<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تشخيص الحمل — مُرَبِّك</title>
  <link rel="stylesheet" href="css/forms.css" />
  <style>
    :root{
      --green:#2e7d32; --green-600:#1b5e20;
      --bg:#fff9db; --card:#ffffff; --ink:#143b24;
      --border:#c5e1a5;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,'Cairo','Segoe UI',Tahoma,Arial}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px}
    header .t{font-weight:800;color:var(--green-600)}
    .wrap{max-width:720px;margin:12px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .label{font-weight:700;margin:8px 0 6px}
    input[type="text"],input[type="date"]{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--ink)
    }
    fieldset{border:2px solid var(--green-600);border-radius:12px;padding:12px;margin:14px 0}
    legend{font-weight:800;color:var(--green-600);padding:0 8px}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1 1 240px;min-width:240px}
    .radios label{display:inline-flex;align-items:center;gap:6px;margin-inline-end:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;background:var(--green);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;width:100%}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .infobar{margin-top:12px;padding:10px;border-radius:10px;font-weight:800;display:none}
    .infobar.ok{display:block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .infobar.err{display:block;background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
    .hint{display:inline-block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46;border-radius:999px;padding:2px 10px;font-size:12px;margin-inline-start:6px}
  </style>
</head>
<body>

<header><span class="t">تشخيص الحمل — مُرَبِّك</span></header>

<div class="wrap">
  <form class="card" id="diagnosisForm" autocomplete="off">
    <div class="label">رقم الحيوان <span class="hint">مطلوب</span></div>
    <input type="text" name="animalId" inputmode="numeric" placeholder="اكتب رقم الحيوان" />

    <div class="label">تاريخ التشخيص <span class="hint">مطلوب</span></div>
    <input type="date" name="eventDate" />

    <fieldset>
      <legend>تشخيص الحمل</legend>
      <div class="row">
        <div class="col">
          <div class="label">طريقة التشخيص <span class="hint">سونار ≥ 26 • جس يدوي ≥ 40</span></div>
          <div class="radios">
            <label><input type="radio" name="method" value="سونار" /> سونار</label>
            <label><input type="radio" name="method" value="جس يدوي" /> جس يدوي</label>
          </div>
        </div>

        <div class="col">
          <div class="label">النتيجة</div>
          <div class="radios">
            <label><input type="radio" name="result" value="عشار" /> عشار</label>
            <label><input type="radio" name="result" value="فارغة" /> فارغة</label>
          </div>
        </div>
      </div>
    </fieldset>

    <div class="label">اسم الطبيب البيطري (اختياري)</div>
    <input type="text" name="vet" />

    <button type="submit" id="saveBtn" class="btn">تسجيل التشخيص</button>
    <div id="infobar" class="infobar" role="status" aria-live="polite"></div>
  </form>
</div>

<script>window.dataLayer = window.dataLayer || [];</script>

<!-- تهيئة الحقول من add-event والـlocalStorage -->
<script type="module">
  (function prefillFromAddEvent(){
    const qs = new URLSearchParams(location.search);
    const animal =
      (qs.get("number") ?? qs.get("animalId") ?? qs.get("animalNumber") ??
       localStorage.getItem("currentAnimalId") ?? localStorage.getItem("lastAnimalId") ?? "").toString().trim();

    const date =
      (qs.get("date") ?? qs.get("eventDate") ?? localStorage.getItem("currentEventDate") ??
       localStorage.getItem("lastEventDate") ?? new Date().toISOString().slice(0,10));

    const form = document.getElementById("diagnosisForm");
    const animalEl = form.elements.animalId;
    const dateEl   = form.elements.eventDate;

    if (animal) animalEl.value = animal;
    if (date)   dateEl.value   = date;

    if (animal) {
      localStorage.setItem("currentAnimalId", animal);
      localStorage.setItem("lastAnimalId", animal);
    }
    if (date) {
      localStorage.setItem("currentEventDate", date);
      localStorage.setItem("lastEventDate", date);
    }
  })();
</script>

<!-- منطق الصفحة + الفاليديشن المركزي + الحفظ -->
<script type="module">
  import { db, auth, ensureAuth } from "/js/firebase-config.js";
  import {
    addDoc, collection, serverTimestamp, query, where, getDocs, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { validateEvent } from "/js/form-rules.js";

  try { window.dataLayer.push({event:"page_view", page: location.pathname}); } catch {}

  const $ = (s)=>document.querySelector(s);
  const form    = $("#diagnosisForm");
  const bar     = $("#infobar");
  const saveBtn = $("#saveBtn");

  function showBar(kind, txt){
    bar.className = "infobar " + (kind === "ok" ? "ok" : "err");
    bar.textContent = txt;
    bar.style.display = "block";
    bar.scrollIntoView({behavior:"smooth", block:"center"});
  }

  // تأكيد تسجيل الدخول
  await ensureAuth("/login.html");

  // جلب الحالة التناسلية + آخر تلقيح حتى تاريخ التشخيص
  async function getCtx(animalId, untilDate){
    const userId = auth.currentUser?.uid;
    let reproStatus = null, animalDocId = null, lastInseminationDate = null;

    // من animals
    try {
      const animalsRef = collection(db, "animals");
      const q1 = query(animalsRef, where("userId","==", userId));
      const snap = await getDocs(q1);
      const match = snap.docs.find(d=>{
        const a = d.data() || {};
        const ids = [a.animalId, a.number, a.animalNumber, a.tag, a.earTag]
          .filter(Boolean).map(v=>String(v).trim());
        return ids.includes(String(animalId));
      });
      if (match){
        animalDocId = match.id;
        const a = match.data() || {};
        reproStatus = a.reproductiveStatus || a.reproStatus || null;
      }
    } catch {}

    // من events (آخر تلقيح ≤ تاريخ التشخيص)
    try {
      const evRef = collection(db, "events");
      // نفلتر بالـ animalNumber لأننا بنحفظه بنفس رقم الحيوان
      const q2 = query(evRef, where("userId","==", userId), where("animalNumber","==", String(animalId)));
      const snap2 = await getDocs(q2);
      const INSEM_TYPES = new Set(["تلقيح","تلقيح مخصب","تلقيح مُخصِّب","Insemination","AI","خدمة"]);
      const ed = new Date(untilDate).setHours(0,0,0,0);
      let latest = null;
      snap2.forEach(docu=>{
        const e = docu.data() || {};
        if (!e?.eventDate || !e?.type) return;
        if (!INSEM_TYPES.has(String(e.type).trim())) return;
        const t = new Date(e.eventDate).setHours(0,0,0,0);
        if (t <= ed && (!latest || t > latest)) latest = t;
      });
      if (latest) lastInseminationDate = new Date(latest).toISOString().slice(0,10);
    } catch {}

    return { reproStatus, lastInseminationDate, animalDocId };
  }

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    bar.style.display = "none";
    saveBtn.disabled = true;

    const animalId  = form.elements.animalId.value.trim();
    const eventDate = form.elements.eventDate.value;
    const methodEl  = form.querySelector('input[name="method"]:checked');
    const resultEl  = form.querySelector('input[name="result"]:checked');

    if(!animalId){ showBar("err","اكتب رقم الحيوان."); saveBtn.disabled=false; return; }
    if(!eventDate){ showBar("err","اختر تاريخ التشخيص."); saveBtn.disabled=false; return; }
    if(!methodEl){ showBar("err","اختر طريقة التشخيص (سونار/جس يدوي)."); saveBtn.disabled=false; return; }
    if(!resultEl){ showBar("err","اختر نتيجة التشخيص."); saveBtn.disabled=false; return; }

    // سياق الفاليديشن
    const ctx = await getCtx(animalId, eventDate);

    // ✅ الفاليديشن المركزي (اسم الحدث بالعربي حسب الاتفاق)
    const v = validateEvent("تشخيص حمل", {
      animalId,
      eventDate,
      method: methodEl.value,            // "سونار" | "جس يدوي"
      result: resultEl.value,            // "عشار" | "فارغة"
      reproStatus: ctx.reproStatus,      // يجب أن تكون "ملقح"
      lastInseminationDate: ctx.lastInseminationDate
    });

    if (!v?.ok){
      const msg = Array.isArray(v?.errors) && v.errors.length ? v.errors.join(" — ") : "مدخلات غير مكتملة أو غير صحيحة.";
      showBar("err", msg);
      saveBtn.disabled = false;
      return;
    }

    // الحفظ في Firestore (events)
    const payload = {
      userId: auth.currentUser.uid,
      animalId, animalNumber: String(animalId),
      eventDate, type: "تشخيص حمل",
      method: methodEl.value, result: resultEl.value,
      vet: form.elements.vet.value?.trim() || "",
      source: location.pathname,
      createdAt: serverTimestamp()
    };

    try {
      await addDoc(collection(db,"events"), payload);

      // تحديث الكاش المحلي
      localStorage.setItem("currentAnimalId", animalId);
      localStorage.setItem("lastAnimalId", animalId);
      localStorage.setItem("currentEventDate", eventDate);
      localStorage.setItem("lastEventDate", eventDate);

      // تحديث وثيقة الحيوان
      try{
        const { animalDocId } = await getCtx(animalId, eventDate);
        if (animalDocId){
          const updates = { lastDiagnosis:"تشخيص حمل", lastDiagnosisDate:eventDate };
          if (payload.result === "عشار")  updates.reproductiveStatus = "عشار";
          if (payload.result === "فارغة") updates.reproductiveStatus = "مفتوحة";
          await updateDoc(doc(db,"animals",animalDocId), updates);
        }
      }catch{}

      showBar("ok","✅ تم تسجيل تشخيص الحمل بنجاح");
      setTimeout(()=> {
        location.href = `add-event.html?number=${encodeURIComponent(animalId)}&date=${encodeURIComponent(eventDate)}`;
      }, 1200);

    } catch (err){
      console.error(err);
      showBar("err","❌ تعذّر الحفظ: تأكد من الاتصال والصلاحيات.");
      saveBtn.disabled = false;
    }
  });
</script>

</body>
</html>
