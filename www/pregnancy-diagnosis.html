<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تشخيص الحمل — مُرَبِّك</title>
  <link rel="stylesheet" href="css/forms.css">
  <style>
    :root{
      --green:#2e7d32; --green-600:#1b5e20;
      --bg:#fff9db; --card:#ffffff; --ink:#143b24;
      --border:#c5e1a5; --muted:#f6fff2;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,'Cairo','Segoe UI',Tahoma,Arial}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px}
    header .t{font-weight:800;color:var(--green-600)}
    .wrap{max-width:720px;margin:12px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .label{font-weight:700;margin:8px 0 6px}
    input[type="text"],input[type="date"]{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--ink)
    }
    fieldset{border:2px solid var(--green-600);border-radius:12px;padding:12px;margin:14px 0}
    legend{font-weight:800;color:var(--green-600);padding:0 8px}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1 1 240px;min-width:240px}
    .radios label{display:inline-flex;align-items:center;gap:6px;margin-inline-end:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;background:var(--green);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;width:100%}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .infobar{margin-top:12px;padding:10px;border-radius:10px;font-weight:800;display:none}
    .infobar.ok{display:block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .infobar.err{display:block;background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
    .hint{display:inline-block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46;border-radius:999px;padding:2px 10px;font-size:12px;margin-inline-start:6px}
  </style>
</head>
<body>

<header><span class="t">تشخيص الحمل — مُرَبِّك</span></header>

<div class="wrap">
  <form class="card" id="diagnosisForm" autocomplete="off">
    <div class="label">رقم الحيوان <span class="hint">مطلوب</span></div>
    <input type="text" name="animalId" inputmode="numeric" placeholder="اكتب رقم الحيوان">

    <div class="label">تاريخ التشخيص <span class="hint">مطلوب</span></div>
    <input type="date" name="eventDate">

    <fieldset>
      <legend>تشخيص الحمل</legend>
      <div class="row">
        <div class="col">
          <div class="label">طريقة التشخيص <span class="hint">سونار ≥ 26 • جس يدوي ≥ 40</span></div>
          <div class="radios">
            <label><input type="radio" name="method" value="سونار"> سونار</label>
            <label><input type="radio" name="method" value="جس يدوي"> جس يدوي</label>
          </div>
        </div>

        <div class="col">
          <div class="label">النتيجة</div>
          <div class="radios">
            <label><input type="radio" name="result" value="عشار"> عشار</label>
            <label><input type="radio" name="result" value="فارغة"> فارغة</label>
          </div>
        </div>
      </div>
    </fieldset>

    <div class="label">اسم الطبيب البيطري (اختياري)</div>
    <input type="text" name="vet">

    <button type="submit" id="saveBtn" class="btn">تسجيل التشخيص</button>
    <div id="infobar" class="infobar" role="status" aria-live="polite"></div>
  </form>
</div>

<script>window.dataLayer = window.dataLayer || [];</script>
<script src="js/app-core.js"></script>

<!-- نتجاوز timeline/smart-checks مؤقتًا إن كان فيهما خطأ -->
<script type="module">
  Promise.allSettled([
    import('/js/timeline.js'),
    import('/js/smart-checks.js')
  ]);
</script>

<!-- لا تحمل api.js الآن لأنه راجع 404/MIME HTML -->
<!-- <script src="/js/api.js"></script> -->

<script type="module">
  import { db, auth, ensureAuth } from "/js/firebase-config.js";
  import { addDoc, collection, serverTimestamp, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { validateEvent } from "/js/form-rules.js";   // ✅ الفاليديشن المركزي

  try { window.dataLayer.push({event:"page_view", page: location.pathname}); } catch {}
  try { if (window.t?.event) t.event("page_view", {page: location.pathname}); } catch {}

  const $ = (s)=>document.querySelector(s);
  const form    = $("#diagnosisForm");
  const bar     = $("#infobar");
  const saveBtn = $("#saveBtn");

  function showBar(kind, txt){
    bar.className = "infobar " + (kind === "ok" ? "ok" : "err");
    bar.textContent = txt;
    bar.style.display = "block";
    bar.scrollIntoView({behavior:"smooth", block:"center"});
  }

  // Prefill من URL/LocalStorage
  const qp = new URLSearchParams(location.search);
  const animalFromURL = qp.get("animalId") || qp.get("number") || qp.get("animalNumber") || localStorage.getItem("lastAnimalId") || "";
  const dateFromURL   = qp.get("eventDate") || qp.get("date") || localStorage.getItem("lastEventDate") || "";
  form.elements.animalId.value  = (animalFromURL||"").toString().trim();
  form.elements.eventDate.value = dateFromURL || new Date().toISOString().slice(0,10);

  // تأكيد الدخول
  await ensureAuth("/login.html");

  // === سياق الفاليديشن: آخر تلقيح + الحالة الحالية ===
  async function getCtx(animalId, untilDate){
    const userId = auth.currentUser.uid;

    // 1) جلب الحالة من animals
    let reproStatus = null, animalDocId = null;
    {
      const animalsRef = collection(db, "animals");
      const q1 = query(animalsRef, where("userId","==", userId));
      const snap = await getDocs(q1);
      const match = snap.docs.find(d=>{
        const a = d.data() || {};
        const ids = [a.animalId, a.number, a.animalNumber, a.tag, a.earTag].filter(Boolean).map(v=>String(v).trim());
        return ids.includes(String(animalId));
      });
      if (match){
        animalDocId = match.id;
        const a = match.data() || {};
        reproStatus = a.reproductiveStatus || a.reproStatus || null;
      }
    }

    // 2) جلب آخر تلقيح من events لنفس الحيوان حتى تاريخ التشخيص
    let lastInseminationDate = null;
    {
      const evRef = collection(db, "events");
      const q2 = query(evRef, where("userId","==", userId), where("animalNumber","==", String(animalId)));
      const snap = await getDocs(q2);
      const INSEM_TYPES = new Set(["تلقيح","تلقيح مخصب","تلقيح مُخصِّب","Insemination","AI","خدمة"]);
      const ed = new Date(untilDate).setHours(0,0,0,0);
      const candidates = [];
      snap.forEach(docu=>{
        const e = docu.data() || {};
        if (!e?.eventDate || !e?.type) return;
        if (!INSEM_TYPES.has(String(e.type).trim())) return;
        const t = new Date(e.eventDate).setHours(0,0,0,0);
        if (t <= ed) candidates.push(t);
      });
      if (candidates.length){
        candidates.sort((a,b)=>b-a);
        lastInseminationDate = new Date(candidates[0]).toISOString().slice(0,10);
      }
    }

    return { reproStatus, lastInseminationDate, animalDocId };
  }

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    bar.style.display = "none";
    saveBtn.disabled = true;

    const animalId  = form.elements.animalId.value.trim();
    const eventDate = form.elements.eventDate.value;
    const methodEl  = form.querySelector('input[name="method"]:checked');
    const resultEl  = form.querySelector('input[name="result"]:checked');

    // تحقق أساسي سريع
    if(!animalId){ showBar("err","اكتب رقم الحيوان."); saveBtn.disabled=false; return; }
    if(!eventDate){ showBar("err","اختر تاريخ التشخيص."); saveBtn.disabled=false; return; }
    if(!methodEl){ showBar("err","اختر طريقة التشخيص (سونار/جس يدوي)."); saveBtn.disabled=false; return; }
    if(!resultEl){ showBar("err","اختر نتيجة التشخيص."); saveBtn.disabled=false; return; }

    // جلب السياق للفاليديشن المركزي
    const ctx = await getCtx(animalId, eventDate);

    // الفاليديشن المركزي (كما في /js/form-rules.js)
    const v = validateEvent("تشخيص حمل", {
      animalId,
      eventDate,
      method: methodEl.value,              // "سونار" | "جس يدوي"
      result: resultEl.value,              // "عشار" | "فارغة"
      reproStatus: ctx.reproStatus,        // لازم تطلع "ملقح" ليعدّي
      lastInseminationDate: ctx.lastInseminationDate
    });

    if (!v.ok){
      showBar("err", v.errors.join(" — "));
      saveBtn.disabled = false;
      return;
    }

    // حفظ الحدث بعد النجاح
    const payload = {
      userId: auth.currentUser.uid,
      animalId, animalNumber: animalId,
      eventDate, type: "تشخيص حمل",
      method: methodEl.value, result: resultEl.value,
      vet: form.elements.vet.value || "",
      source: location.pathname, createdAt: serverTimestamp()
    };

    try {
      await addDoc(collection(db,"events"), payload);

      localStorage.setItem("lastAnimalId", animalId);
      localStorage.setItem("lastEventDate", eventDate);

      // تحديث بطاقة الحيوان (اختياري)
      try{
        if (ctx.animalDocId){
          const updates = { lastDiagnosis:"تشخيص حمل", lastDiagnosisDate:eventDate };
          if (payload.result === "عشار")  updates.reproductiveStatus = "عشار";
          if (payload.result === "فارغة") updates.reproductiveStatus = "مفتوحة";
          await updateDoc(doc(db,"animals",ctx.animalDocId), updates);
        }
      }catch{}

      showBar("ok","✅ تم تسجيل تشخيص الحمل بنجاح");
      setTimeout(()=>{ location.href = `add-event.html?number=${encodeURIComponent(animalId)}&date=${encodeURIComponent(eventDate)}`; }, 1500);

    } catch (err){
      console.error(err);
      showBar("err","❌ تعذّر الحفظ: تأكد من الاتصال والصلاحيات.");
      saveBtn.disabled = false;
    }
  });
</script>

</body>
</html>
