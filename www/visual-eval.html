<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>مُرَبِّك — تقييم بالكاميرا (موبايل)</title>
  <style>
    /* ===== Mobile-first, بدون أي حيل vh ===== */
    html,body{margin:0;padding:0;width:100%;max-width:100%;overflow-x:hidden;background:#f7faf7;color:#0f172a;font-family:system-ui,'Segoe UI','Cairo',Tahoma,Arial,sans-serif}
    .container{max-width:960px;margin:16px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.04);overflow:hidden}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0;padding:12px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    header>*{min-width:0}
    .title{margin:0;font-weight:800;color:#0ea05a}
    .badge{background:#e6f8ef;color:#0b7f47;padding:4px 8px;border-radius:999px;font-size:12px}
    .device-info{margin-inline-start:auto;color:#64748b;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:880px){.row{grid-template-columns:1.25fr .75fr}}

    .angles{display:flex;gap:8px;padding:12px;border-bottom:1px solid #e2e8f0;overflow-x:auto;-webkit-overflow-scrolling:touch}
    .angle-tab{padding:10px 12px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:700;min-height:44px;white-space:nowrap}
    .angle-tab.active{background:#0ea05a;color:#fff;border-color:#0ea05a}

    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:12px}
    .controls .select,.controls .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px;min-height:44px}
    .controls .btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:800;min-height:44px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .btn-primary{background:#0ea05a;color:#fff}.btn-light{background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1}.btn-danger{background:#c2410c;color:#fff}
    .controls>*{min-width:0;max-width:100%}
    @media (max-width:540px){.controls{display:grid;grid-template-columns:1fr 1fr}.controls .select{grid-column:1/-1}.controls .btn{width:100%}}

    .preview-wrap{position:relative;background:#000;border-radius:16px;overflow:hidden}
    video#preview{display:block;width:100%;height:auto;background:#000}
    canvas#overlay{position:absolute;inset:0;pointer-events:none}

    .capture-bar{display:flex;gap:8px;padding:12px;border-top:1px solid #e2e8f0;justify-content:space-between;flex-wrap:wrap;align-items:stretch}
    .status{display:flex;gap:8px;overflow-x:auto;-webkit-overflow-scrolling:touch}
    .thumb{flex:0 0 auto;width:72px;height:72px;border-radius:12px;overflow:hidden;border:2px solid #e2e8f0;background:#f8fafc;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .label{position:absolute;inset-inline:0;bottom:0;background:rgba(0,0,0,.45);color:#fff;font-size:11px;text-align:center}

    .helper{padding:12px;color:#64748b;line-height:1.8}
    .checklist{padding:12px;display:grid;gap:8px}
    .checklist h3{margin:8px 0;color:#0b7f47}
    .checklist label{display:flex;align-items:center;gap:8px}

    .metrics{padding:12px;border-top:1px solid #e2e8f0;display:grid;gap:10px}
    .metrics h3{margin:8px 0;color:#0b7f47}
    .score{display:grid;gap:10px;padding:10px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
    .score-badge{display:inline-block;padding:6px 10px;border:1px solid transparent;border-radius:999px;font-weight:800;width:max-content}
    .score-bar{height:10px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;overflow:hidden}
    .score-bar .fill{height:100%}
    .score-note{color:#64748b;font-weight:700}

    .save-bar{display:flex;gap:8px;padding:12px;border-top:1px solid #e2e8f0}

    img,video,canvas,svg{max-width:100%;height:auto;display:block}
    editor-card,.editor-card{display:none!important}
  </style>
</head>
<body>
  <header>
    <h1 class="title">تقييم بالكاميرا</h1>
    <span class="badge">مُرَبِّك</span>
    <div class="device-info">رقم الحيوان: <span class="animal-number">—</span></div>
  </header>

  <div class="container row">
    <section class="card" id="cameraCard">
      <div class="angles">
        <button class="angle-tab active" data-angle="rear-udder">خلفية الضرع</button>
        <button class="angle-tab" data-angle="side">جانبية</button>
        <button class="angle-tab" data-angle="front">أمامية</button>
        <button class="angle-tab" data-angle="udder-close">قريبة للضرع</button>
      </div>

      <div class="controls">
        <select id="cameraSelect" class="select" title="اختيار الكاميرا"></select>
        <button id="toggleFlash" class="btn btn-light" aria-pressed="false">الفلاش</button>
        <button id="restartBtn" class="btn btn-light">إعادة التهيئة</button>
        <div style="margin-inline-start:auto"></div>
        <button id="captureBtn" class="btn btn-primary">التقاط</button>
        <button id="retakeBtn" class="btn btn-danger" disabled>إعادة الالتقاط</button>
        <button id="uploadBtn" class="btn btn-light">رفع صورة</button>
        <input id="uploadInput" type="file" accept="image/*" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0"/>
        <button id="nextAngleBtn" class="btn btn-light">التالي ▸</button>
      </div>

      <div class="preview-wrap">
        <video id="preview" playsinline autoplay muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="capture-bar">
        <div class="status" id="thumbs"></div>
        <div class="helper" id="helperText"></div>
      </div>
    </section>

    <aside class="card">
      <form id="metaForm" style="padding:12px">
        <input type="hidden" id="animalId" name="animalId"/>
        <label style="display:block;margin:6px 0">تاريخ التقييم
          <input type="date" id="eventDate" name="eventDate" class="input" required/>
        </label>
      </form>

      <div class="checklist">
        <h3>ملاحظات سريعة</h3>
        <label><input type="checkbox" id="isClean"/> الحيوان نظيف وجاف</label>
        <label><input type="checkbox" id="goodLight"/> الإضاءة كافية</label>
        <label><input type="checkbox" id="onFlat"/> الأرض مستوية</label>
        <label><input type="checkbox" id="animalStanding"/> الحيوان واقف بثبات</label>
        <label><input type="checkbox" id="teatsVisible"/> الحلمات واضحة</label>
      </div>

      <div class="metrics" id="metrics">
        <h3>التقييم</h3>
        <div class="helper">التقط/ارفع الصور لكل الكوادر لعرض النتيجة.</div>
      </div>

      <div class="save-bar">
        <button id="saveBtn" type="button" class="btn btn-primary" style="width:100%">حفظ التقييم والصور</button>
      </div>
    </aside>
  </div>

  <script>
    'use strict';
    const qs=new URLSearchParams(location.search);
    const $=(s,p=document)=>p.querySelector(s);
    const $$=(s,p=document)=>[...p.querySelectorAll(s)];
    function todayCairo(){const now=new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'}));return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;}
    function getCtx(){const id=qs.get('animalId')||'';const date=qs.get('date')||todayCairo();return {id,date};}

    const anglesOrder=['rear-udder','side','front','udder-close'];
    const angleLabels={ 'rear-udder':'خلفية الضرع','side':'جانبية','front':'أمامية','udder-close':'قريبة للضرع' };
    const helpers={
      'rear-udder':'خلفية: تقييم <em>تماثل أرباع الضرع/udder cleft/توزيع الحلمات</em> + <em>استقامة واتساع الأرجل الخلفية</em>.',
      'side':'جانبية: <em>استقامة الظهر</em> (المثالي مستقيم) + <em>زاوية الرامب</em> (ميل خفيف مثالي) + <em>عمق الجسم ومحيط الصدر</em> + <em>علامات الأنوثة</em>.',
      'front':'أمامية: <em>اتساع الصدر</em> و<em>توازي الأرجل الأمامية</em>.',
      'udder-close':'قريبة للضرع: <em>طول/حجم الحلمات</em> و<em>تماثلها</em>.'
    };

    const state={currentAngle:'rear-udder',stream:null,track:null,capabilities:null,torchOn:false,captures:{},k:{}};
    anglesOrder.forEach(a=>state.captures[a]=null);

    const preview=$('#preview'),overlay=$('#overlay'),cameraSelect=$('#cameraSelect');
    const captureBtn=$('#captureBtn'),retakeBtn=$('#retakeBtn'),nextAngleBtn=$('#nextAngleBtn');
    const thumbs=$('#thumbs'),helperText=$('#helperText');
    const animalIdInput=$('#animalId'),eventDateInput=$('#eventDate'),numberSpan=$('.animal-number');

    function initHeader(){const ctx=getCtx();if(animalIdInput)animalIdInput.value=ctx.id||'';if(eventDateInput)eventDateInput.value=ctx.date||todayCairo();if(numberSpan)numberSpan.textContent=ctx.id||'—';helperText.innerHTML=helpers[state.currentAngle];}

    function fitOverlay(){if(!preview||!overlay)return;const r=preview.getBoundingClientRect();overlay.width=Math.max(1,Math.floor(r.width*devicePixelRatio));overlay.height=Math.max(1,Math.floor(r.height*devicePixelRatio));overlay.style.width=r.width+'px';overlay.style.height=r.height+'px';}
    function drawGuide(){if(!overlay)return;const ctx=overlay.getContext('2d');if(!ctx)return;ctx.clearRect(0,0,overlay.width,overlay.height);const w=overlay.width,h=overlay.height;ctx.strokeStyle='rgba(255,255,255,.35)';ctx.lineWidth=1*devicePixelRatio;for(let i=1;i<3;i++){ctx.beginPath();ctx.moveTo((w/3)*i,0);ctx.lineTo((w/3)*i,h);ctx.stroke();ctx.beginPath();ctx.moveTo(0,(h/3)*i);ctx.lineTo(w,(h/3)*i);ctx.stroke();}ctx.strokeStyle='rgba(14,160,90,.9)';ctx.lineWidth=4*devicePixelRatio;let rx=w*.08,ry=h*.12,rw=w*.84,rh=h*.76;const a=state.currentAngle;if(a==='side'){rx=w*.05;ry=h*.15;rw=w*.9;rh=h*.7;}else if(a==='rear-udder'){rx=w*.15;ry=h*.12;rw=w*.7;rh=h*.76;ctx.beginPath();ctx.moveTo(w*.4,ry);ctx.lineTo(w*.4,ry+rh);ctx.stroke();ctx.beginPath();ctx.moveTo(w*.6,ry);ctx.lineTo(w*.6,ry+rh);ctx.stroke();}else if(a==='front'){rx=w*.12;ry=h*.12;rw=w*.76;rh=h*.76;ctx.beginPath();ctx.moveTo(w/2,ry);ctx.lineTo(w/2,ry+rh);ctx.stroke();}else if(a==='udder-close'){rx=w*.25;ry=h*.25;rw=w*.5;rh=h*.5;ctx.beginPath();ctx.moveTo(w/2,h*.2);ctx.lineTo(w/2,h*.8);ctx.stroke();ctx.beginPath();ctx.moveTo(w*.2,h/2);ctx.lineTo(w*.8,h/2);ctx.stroke();}if(ctx.roundRect){ctx.beginPath();ctx.roundRect(rx,ry,rw,rh,20*devicePixelRatio);ctx.stroke();}else{ctx.strokeRect(rx,ry,rw,rh);}}

    function renderThumbs(){if(!thumbs)return;thumbs.innerHTML='';for(const a of anglesOrder){const w=document.createElement('div');w.className='thumb';const img=document.createElement('img');if(state.captures[a])img.src=state.captures[a];w.appendChild(img);const lb=document.createElement('div');lb.className='label';lb.textContent=angleLabels[a];w.appendChild(lb);w.title=angleLabels[a];w.addEventListener('click',()=>setAngle(a));thumbs.appendChild(w);}}
    function updateButtons(){const has=!!state.captures[state.currentAngle];if(retakeBtn)retakeBtn.disabled=!has;}
    function setAngle(a){state.currentAngle=a;$$('.angle-tab').forEach(el=>el.classList.toggle('active',el.dataset.angle===a));helperText.innerHTML=helpers[a];drawGuide();updateButtons();refreshMetricsFor(a);}

    function dataURLFromVideo(){if(!preview)return'';const w=preview.videoWidth||preview.clientWidth||0;const h=preview.videoHeight||preview.clientHeight||0;if(!w||!h)return'';const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(preview,0,0,w,h);return c.toDataURL('image/jpeg',0.92);}
    function makePlaceholder(label){const c=document.createElement('canvas');c.width=1280;c.height=720;const g=c.getContext('2d');const grd=g.createLinearGradient(0,0,1280,720);grd.addColorStop(0,'#e6f8ef');grd.addColorStop(1,'#c7f9e9');g.fillStyle=grd;g.fillRect(0,0,1280,720);g.fillStyle='#0ea05a';g.fillRect(60,60,1160,600);g.fillStyle='#fff';g.font='bold 60px Cairo, Arial';g.textAlign='center';g.textBaseline='middle';g.fillText('Demo — '+label,640,360);g.font='26px Cairo, Arial';g.fillText('Murabbik Visual Evaluation',640,430);return c.toDataURL('image/jpeg',0.9);}

    /* الأوزان: ضرع 40% — ظهر/رامب 30% — جسم/أرجل 20% — أنوثة 10% */
    const WEIGHTS={UDDER:40,BACK_RUMP:30,BODY_LEGS:20,FEMININITY:10};
    // تفصيل الأوزان داخل كل فئة (النِّسب دي تتجمع = 100 داخل الفئة)
const SUB = {
  // ضرع 40%: تماثل الشق/التوازن/توزيع الحلمات + طول/حجم وتماثل الحلمات (من اللقطة القريبة)
  UDDER: {
    udderCleft: 25,
    udderBalance: 20,
    teatDistribution: 20,
    teatSize: 15,
    teatSymmetry: 20
  },
  // ظهر/رامب 30%: استقامة الظهر ثم زاوية الرامب
  BACK_RUMP: {
    backStraight: 55,
    rumpAngle:   45
  },
  // جسم/أرجل 20%: صدر + عمق جسم + توازي أمامي + استقامة/اتساع خلفي
  BODY_LEGS: {
    chestWidth:        25,
    bodyDepth:         25,
    frontLegsParallel: 20,
    rearLegsStraight:  15,
    rearLegsWidth:     15
  },
  // أنوثة 10%
  FEMININITY: { femininity: 100 }
};

    // تفصيل الأوزان داخل كل فئة (النِّسب دي تتجمع = 100 داخل الفئة)
const SUB = {
  // ضرع 40%: تماثل الشق/التوازن/توزيع الحلمات + طول/حجم وتماثل الحلمات (من اللقطة القريبة)
  UDDER: {
    udderCleft: 25,
    udderBalance: 20,
    teatDistribution: 20,
    teatSize: 15,
    teatSymmetry: 20
  },
  // ظهر/رامب 30%: استقامة الظهر ثم زاوية الرامب
  BACK_RUMP: {
    backStraight: 55,
    rumpAngle:   45
  },
  // جسم/أرجل 20%: صدر + عمق جسم + توازي أمامي + استقامة/اتساع خلفي
  BODY_LEGS: {
    chestWidth:        25,
    bodyDepth:         25,
    frontLegsParallel: 20,
    rearLegsStraight:  15,
    rearLegsWidth:     15
  },
  // أنوثة 10%
  FEMININITY: { femininity: 100 }
};

    function hashString(s){let h=0;for(let i=0;i<s.length;i++){h=(h<<5)-h+s.charCodeAt(i);h|=0}return Math.abs(h)}
    function seeded(seed,min,max){const x=Math.sin(seed)*10000;const f=x-Math.floor(x);return Math.round(min+f*(max-min))}
    function computeKPIs(dataUrl,angle){return new Promise(res=>{const img=new Image();img.onload=()=>{const c=document.createElement('canvas');c.width=320;c.height=Math.max(1,Math.round(320*(img.height/img.width)));const g=c.getContext('2d');g.drawImage(img,0,0,c.width,c.height);const id=g.getImageData(0,0,c.width,c.height);let sum=0;for(let i=0;i<id.data.length;i+=4){sum+=0.2126*id.data[i]+0.7152*id.data[i+1]+0.0722*id.data[i+2]}const avg=sum/(id.data.length/4);const lighting=Math.max(0,Math.min(100,Math.round((avg/255)*100)));const ratio=img.width/img.height;const framing=Math.max(0,Math.min(100,Math.round(100-Math.abs(ratio-1.6)*80)));const seed=hashString(angle+dataUrl.slice(0,64));const k={lighting,framing};if(angle==='rear-udder'){k.udderCleft=seeded(seed+1,60,95);k.teatDistribution=seeded(seed+2,60,95);k.udderBalance=seeded(seed+3,60,95);k.rearLegsStraight=seeded(seed+4,60,95);k.rearLegsWidth=seeded(seed+5,60,95)}if(angle==='side'){k.backStraight=seeded(seed+11,60,95);k.rumpAngle=seeded(seed+12,60,95);k.bodyDepth=seeded(seed+13,60,95);k.femininity=seeded(seed+14,60,95)}if(angle==='front'){k.chestWidth=seeded(seed+21,60,95);k.frontLegsParallel=seeded(seed+22,60,95)}if(angle==='udder-close'){k.teatSize=seeded(seed+31,60,95);k.teatSymmetry=seeded(seed+32,60,95)}res(k)};img.onerror=()=>res({lighting:0,framing:0});img.src=dataUrl})}
   function computeScores(){
  const all = Object.assign(
    {},
    state.k['rear-udder'],
    state.k['side'],
    state.k['front'],
    state.k['udder-close']
  );
  if (!Object.keys(all).length) return null;

  // متوسط موزَّن داخل الفئة
  const w = (map) => {
    let sum = 0, sw = 0;
    for (const k in map) {
      const v = all[k], ww = map[k];
      if (typeof v === 'number') { sum += v * ww; sw += ww; }
    }
    return sw ? Math.round(sum / sw) : 0;
  };

  const UDDER      = w(SUB.UDDER);
  const BACK_RUMP  = w(SUB.BACK_RUMP);
  const BODY_LEGS  = w(SUB.BODY_LEGS);
  const FEMININITY = w(SUB.FEMININITY);

  const totalW = WEIGHTS.UDDER + WEIGHTS.BACK_RUMP + WEIGHTS.BODY_LEGS + WEIGHTS.FEMININITY;
  const MVS = Math.round(
    (UDDER*WEIGHTS.UDDER + BACK_RUMP*WEIGHTS.BACK_RUMP + BODY_LEGS*WEIGHTS.BODY_LEGS + FEMININITY*WEIGHTS.FEMININITY) / totalW
  );

  return { UDDER, BACK_RUMP, BODY_LEGS, FEMININITY, MVS };
}


    function gradeInfo(m){if(m>=85)return{label:'ممتاز',bg:'#dcfce7',border:'#86efac',fg:'#14532d'};if(m>=75)return{label:'جيد جدًا',bg:'#e0f2fe',border:'#7dd3fc',fg:'#075985'};if(m>=60)return{label:'متوسط',bg:'#fef9c3',border:'#facc15',fg:'#92400e'};return{label:'ضعيف',bg:'#fee2e2',border:'#fecaca',fg:'#7f1d1d'}}
    function renderScoreWidget(s){const g=gradeInfo(s.MVS);return `<div class="score"><div class="score-badge" style="background:${g.bg};color:${g.fg};border-color:${g.border}">${g.label}</div><div class="score-bar"><div class="fill" style="width:${s.MVS}%;background:${g.border}"></div></div><div class="score-note">MVS: ${s.MVS} / 100</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-weight:700;color:#0f172a"><div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:6px 8px">ضرع: ${s.UDDER}<small style="color:#64748b;font-weight:400"> (40%)</small></div><div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:6px 8px">ظهر/رامب: ${s.BACK_RUMP}<small style="color:#64748b;font-weight:400"> (30%)</small></div><div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:6px 8px">جسم/أرجل: ${s.BODY_LEGS}<small style="color:#64748b;font-weight:400"> (20%)</small></div><div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:6px 8px">أنوثة: ${s.FEMININITY}<small style="color:#64748b;font-weight:400"> (10%)</small></div></div></div>`}
    function refreshMetricsFor(angle){const url=state.captures[angle];if(!url){$('#metrics').innerHTML='<h3>التقييم</h3><div class="helper">التقط/ارفع الصور لكل الكوادر لعرض النتيجة.</div>';return}computeKPIs(url,angle).then(k=>{state.k[angle]=Object.assign({},state.k[angle]||{},k);const scores=computeScores();if(!scores){$('#metrics').innerHTML='<h3>التقييم</h3><div class="helper">التقط/ارفع الصور لكل الكوادر لعرض النتيجة.</div>';return}$('#metrics').innerHTML='<h3>التقييم</h3>'+renderScoreWidget(scores)})}

    (function init(){
      // ترويسه + نص مساعد
      const ctx=getCtx(); if(animalIdInput)animalIdInput.value=ctx.id||''; if(eventDateInput)eventDateInput.value=ctx.date||todayCairo(); if(numberSpan)numberSpan.textContent=ctx.id||'—'; helperText.innerHTML=helpers[state.currentAngle];
      renderThumbs(); setAngle('rear-udder');
      $$('.angle-tab').forEach(btn=>btn.addEventListener('click',()=>setAngle(btn.dataset.angle)));
      const uploadBtn=$('#uploadBtn'),uploadInput=$('#uploadInput');
      if(uploadBtn)uploadBtn.addEventListener('click',()=>uploadInput&&uploadInput.click());
      if(uploadInput)uploadInput.addEventListener('change',e=>{const f=e.target.files&&e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{state.captures[state.currentAngle]=r.result;renderThumbs();updateButtons();refreshMetricsFor(state.currentAngle)};r.readAsDataURL(f);});
      if(captureBtn)captureBtn.addEventListener('click',()=>{const url=dataURLFromVideo();if(!url)return;state.captures[state.currentAngle]=url;renderThumbs();updateButtons();refreshMetricsFor(state.currentAngle)});
      if(retakeBtn)retakeBtn.addEventListener('click',()=>{state.captures[state.currentAngle]=null;renderThumbs();updateButtons();refreshMetricsFor(state.currentAngle)});
      if(nextAngleBtn)nextAngleBtn.addEventListener('click',()=>{const i=anglesOrder.indexOf(state.currentAngle);setAngle(anglesOrder[(i+1)%anglesOrder.length])});
      addEventListener('resize',()=>{fitOverlay();drawGuide()});
      addEventListener('orientationchange',()=>{setTimeout(()=>{fitOverlay();drawGuide()},150)});

      const SECURE=(window.isSecureContext&&location.protocol==='https:')||location.hostname==='localhost';
      if(SECURE && navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
        startCamera().then(async()=>{ // قائمة الكاميرات
          try{const devs=await navigator.mediaDevices.enumerateDevices();const cams=devs.filter(d=>d.kind==='videoinput');const sel=cameraSelect; if(sel){sel.innerHTML='';cams.forEach((c,i)=>{const o=document.createElement('option');o.value=c.deviceId;o.textContent=c.label||`كاميرا ${i+1}`;sel.appendChild(o);});}}
          catch{}
        });
        setTimeout(()=>{const notReady=!state.stream||(preview&&preview.readyState<2);if(notReady){anglesOrder.forEach(a=>state.captures[a]=makePlaceholder(angleLabels[a]));renderThumbs();updateButtons();refreshMetricsFor(state.currentAngle)}},2200);
      } else {
        // ملف محلي أو http: اعرض ديمو فوري
        anglesOrder.forEach(a=>state.captures[a]=makePlaceholder(angleLabels[a]));renderThumbs();updateButtons();refreshMetricsFor(state.currentAngle);
      }
    })();

    async function startCamera(deviceId){
      try{
        if(state.stream){state.stream.getTracks().forEach(t=>t.stop())}
        const cs=deviceId?{video:{deviceId:{exact:deviceId}}}:{video:{facingMode:{ideal:'environment'}}};
        const stream=await navigator.mediaDevices.getUserMedia(cs);
        state.stream=stream; if(preview) preview.srcObject=stream;
        const track=stream.getVideoTracks()[0]; state.track=track; state.capabilities=(track.getCapabilities&&track.getCapabilities())||null;
        try{await preview.play()}catch{}
        if(preview.readyState<2) preview.addEventListener('loadedmetadata',()=>{fitOverlay();drawGuide()},{once:true}); else {fitOverlay();drawGuide()}
      }catch(e){
        // fallback: ديمو
        anglesOrder.forEach(a=>state.captures[a]=makePlaceholder(angleLabels[a]));renderThumbs();updateButtons();refreshMetricsFor(state.currentAngle);
      }
    }
  </script>
</body>
</html>
