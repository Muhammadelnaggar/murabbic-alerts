<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- احفظ الملف بهذا الاسم: www/visual-eval.html -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تقييم الحيوان بالكاميرا — مُرَبِّك</title>
  <style>
    :root{
      --green:#0ea05a; /* الأخضر الأساسي */
      --green-600:#0b7f47;
      --bg:#f7faf7;    /* خلفية خفيفة */
      --text:#0f172a;  /* أسود مائل للأزرق لقراءة جيدة */
      --muted:#64748b; /* رمادي للنصوص الثانوية */
      --card:#ffffff;  /* خلفيات البطاقات */
      --danger:#c2410c; /* تنبيه */
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, 'Segoe UI', 'Cairo', Tahoma, Arial, sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10; background:var(--card);
      border-bottom:1px solid #e2e8f0; padding:12px 16px;
      display:flex; align-items:center; gap:12px;
    }
    .title{font-weight:800; color:var(--green); margin:0}
    .badge{background:#e6f8ef; color:var(--green-600); padding:4px 8px; border-radius:999px; font-size:12px}
    .container{max-width:960px; margin:16px auto; padding:0 16px}
    .card{background:var(--card); border:1px solid #e2e8f0; border-radius:16px; box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:860px){.row{grid-template-columns: 1.2fr .8fr}}

    .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center; padding:12px}
    .controls .select, .controls .input{padding:10px 12px; border:1px solid #cbd5e1; border-radius:12px; background:#fff; font-size:16px}
    .controls .btn{padding:12px 14px; border:none; border-radius:12px; cursor:pointer; font-weight:700; min-height:44px; box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .btn-primary{background:var(--green); color:#fff}
    .btn-light{background:#f1f5f9; color:#0f172a; border:1px solid #cbd5e1}
    .btn-danger{background:var(--danger); color:#fff}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .angles{display:flex; gap:8px; padding:12px; border-bottom:1px solid #e2e8f0}
    .angle-tab{padding:10px 12px; border-radius:999px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; font-weight:700; color:#0f172a; min-height:44px}
    .angle-tab.active{background:var(--green); color:#fff; border-color:var(--green)}

    .preview-wrap{position:relative; border-radius:16px; overflow:hidden; background:#000}
    video#preview{width:100%; height:auto; display:block; background:#000}
    canvas#overlay{position:absolute; inset:0; pointer-events:none}

    .capture-bar{display:flex; gap:8px; padding:12px; border-top:1px solid #e2e8f0; justify-content:space-between}
    .status{display:flex; gap:8px; flex-wrap:wrap}
    .thumb{width:72px; height:72px; border-radius:12px; overflow:hidden; border:2px solid #e2e8f0; background:#f8fafc; position:relative}
    .thumb img{width:100%; height:100%; object-fit:cover}
    .thumb .label{position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,.5); color:#fff; font-size:11px; text-align:center}

    .helper{padding:12px; color:var(--muted); line-height:1.8}
    .helper strong{color:var(--green-600)}

    .checklist{padding:12px; display:grid; gap:8px}
    .checklist h3{margin:8px 0; color:var(--green-600)}
    .checklist label{display:flex; align-items:center; gap:8px}
    .save-bar{display:flex; gap:8px; padding:12px; border-top:1px solid #e2e8f0}
      .drop-hint{position:absolute; inset:0; display:none; align-items:center; justify-content:center; font-weight:800; color:var(--green-600); background:rgba(255,255,255,.6); text-align:center; padding:16px}
    .preview-wrap.dragover .drop-hint{display:flex}
    .metrics{padding:12px; border-top:1px solid #e2e8f0; display:grid; gap:8px}
    .metrics h3{margin:8px 0; color:var(--green-600)}
    .metric{display:flex; justify-content:space-between; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:8px 12px; font-weight:700}
    .metric small{font-weight:400; color:var(--muted)}
    @media(max-width:520px){
      .controls{display:grid; grid-template-columns:1fr 1fr; gap:10px}
      .controls .select{grid-column:1 / -1}
      .controls .btn{width:100%; font-size:16px}
      .angles{flex-wrap:wrap}
      .angle-tab{flex:1; text-align:center; font-size:15px}
    }
  </style>
</head>
<body>
  <header>
    <h1 class="title">تقييم بالكاميرا</h1>
    <span class="badge">مُرَبِّك</span> <span class="badge" id="demoBadge" style="display:none;background:#fff3cd;color:#92400e;border:1px solid #facc15">وضع العرض</span>
    <div style="margin-inline-start:auto; color:var(--muted); font-weight:700">رقم الحيوان: <span class="animal-number">—</span></div>
  </header>

  <div class="container row">
    <!-- عمود الكاميرا -->
    <section class="card" id="cameraCard">
      <div class="angles">
        <button class="angle-tab active" data-angle="side">جانب</button>
        <button class="angle-tab" data-angle="udder-front">ضرع أمامي</button>
        <button class="angle-tab" data-angle="udder-rear">ضرع خلفي</button>
        <button class="angle-tab" data-angle="teat-close">قريب الحلمات</button>
        <button class="angle-tab" data-angle="front-body">أمام الجسم</button>
        <button class="angle-tab" data-angle="head-neck">الرأس والرقبة</button>
      </div>

      <div class="controls">
        <select id="cameraSelect" class="select" title="اختيار الكاميرا"></select>
        <button id="demoBtn" class="btn btn-light" title="تشغيل وضع العرض">وضع العرض</button>
        <button id="toggleFlash" class="btn btn-light" title="تشغيل الفلاش" aria-pressed="false">الفلاش</button>
        <button id="restartBtn" class="btn btn-light">إعادة التهيئة</button>
        <div style="margin-inline-start:auto"></div>
        <button id="captureBtn" class="btn btn-primary">التقاط</button>
        <button id="retakeBtn" class="btn btn-danger" disabled>إعادة الالتقاط</button>
        <button id="uploadBtn" class="btn btn-light">رفع صورة بديلة</button>
        <input id="uploadInput" type="file" accept="image/*" style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;" />
        <button id="nextAngleBtn" class="btn btn-light">التالي ▸</button>
      </div>

      <div class="preview-wrap">
        <video id="preview" playsinline autoplay muted></video>
        <canvas id="overlay"></canvas>
        <div class="drop-hint" id="dropHint">أفلت الصورة هنا لتعيينها لزاوية <span id="dropAngleLabel">—</span></div>
      </div>

      <div class="capture-bar">
        <div class="status" id="thumbs"></div>
        <div class="helper" id="helperText">وجّه الكاميرا من <strong>جانب الحيوان</strong>؛ الإطار يجب أن يضم من الكتف إلى نهاية الحوض، مع وجود الأرضية في أسفل الإطار.</div>
      </div>
    </section>

    <!-- عمود الملاحظات السريعة -->
    <aside class="card">
      <form id="metaForm" style="padding:12px">
        <input type="hidden" id="animalId" name="animalId" />
        <label style="display:block; margin:6px 0">تاريخ التقييم
          <input type="date" id="eventDate" name="eventDate" class="input" required />
        </label>
      </form>

      <div class="checklist">
        <h3>ملاحظات سريعة (اختياري)</h3>
        <label><input type="checkbox" id="isClean"/> الحيوان نظيف وجاف</label>
        <label><input type="checkbox" id="goodLight"/> الإضاءة كافية (بدون ظلال قوية)</label>
        <label><input type="checkbox" id="onFlat"/> الأرض مستوية</label>
        <label><input type="checkbox" id="animalStanding"/> الحيوان واقف بثبات</label>
        <label><input type="checkbox" id="teatsVisible"/> الحلمات واضحة</label>
      </div>

      <div class="metrics" id="metrics">
        <h3>مؤشرات تقديرية (Demo)</h3>
        <div class="helper">التقط/ارفع صورة لعرض المؤشرات.</div>
      </div>

      <div class="save-bar">
        <button id="saveBtn" class="btn btn-primary" style="width:100%">حفظ التقييم والصور</button>
      </div>
    </aside>
  </div>

  <script type="module">
    /*
      اسم الملف المُعتمد للحفظ: www/visual-eval.html
      ملاحظة مهمة: هذا الملف يتوقع أن لديك ملف تهيئة Firebase على المسار التالي
      www/js/firebase-config.js
      الذي يصدّر (db, storage, serverTimestamp, addDoc, collection, ref, uploadString, getDownloadURL)
      بنفس أسلوب مشروع مُرَبِّك الحالي.
      إن اختلفت صادراتك، عدّل أسطر الاستيراد أدناه بما يلائم.
    */
    

    // ---------- أدوات مساعدة عامة ----------
    const qs = new URLSearchParams(location.search);
    const $ = (s, p=document)=> p.querySelector(s);
    const $$ = (s, p=document)=> [...p.querySelectorAll(s)];

    // وضع العرض للمستثمرين عبر ?demo=1
    const isDemo = qs.get('demo')==='1' || qs.get('mode')==='demo';

    function todayCairo(){
      const now = new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'}));
      const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    function getAnimalFromContext(){
      const id = qs.get('animalId') || localStorage.getItem('currentAnimalId') || '';
      const number = qs.get('number') || localStorage.getItem('currentAnimalNumber') || '';
      const date = qs.get('date') || sessionStorage.getItem('currentEventDate') || localStorage.getItem('currentEventDate') || todayCairo();
      if(id) localStorage.setItem('currentAnimalId', id);
      if(number) localStorage.setItem('currentAnimalNumber', number);
      if(date){ localStorage.setItem('currentEventDate', date); sessionStorage.setItem('currentEventDate', date); }
      return {id, number, date};
    }

    // ---------- حالة الصفحة ----------
    const anglesOrder = ['side','udder-front','udder-rear','teat-close','front-body','head-neck'];
    const angleLabels = { 'side':'جانب', 'udder-front':'ضرع أمامي', 'udder-rear':'ضرع خلفي', 'teat-close':'قريب الحلمات', 'front-body':'أمام الجسم', 'head-neck':'الرأس والرقبة' };
    const helperByAngle = {
      'side': 'وجّه الكاميرا من <strong>جانب الحيوان</strong>؛ الإطار يجب أن يضم من الكتف إلى نهاية الحوض، مع وجود الأرضية في أسفل الإطار.',
      'udder-front': 'صوّر <strong>الضرع من الأمام</strong>؛ احرص أن تكون الأرجل الأمامية خارج الإطار قدر الإمكان والحلمات ظاهرة.',
      'udder-rear': 'صوّر <strong>الضرع من الخلف</strong>؛ اجعل الذيل خارج الوسط والحلمات الأربع داخل الإطار.',
      'teat-close': 'التقط <strong>قريب للحلمات</strong>؛ مركز الإطار بين الحلمات الأربع لمسح التموضع والطول.',
      'front-body': 'التقط <strong>واجهة الحيوان</strong>؛ الهدف قياس <em>اتساع الصدر</em> و<em>اتساع الأرجل الأمامية</em>. اجعل الكاميرا على ارتفاع الصدر وخط المنتصف في مركز الإطار.',
      'head-neck': 'التقط <strong>الرأس والرقبة</strong> من الجانب؛ نقيّم علامات الأنوثة (رقبة رفيعة وطويلة، رأس أنعم). اجعل الكادر من مقدمة الكتف حتى فتحتي الأنف.'
    };

    let state = {
      currentAngle: 'side',
      stream: null,
      track: null,
      capabilities: null,
      torchOn: false,
      captures: /** @type {Record<string,string|null>} */ ({
        'side': null,
        'udder-front': null,
        'udder-rear': null,
        'teat-close': null,
        'front-body': null,
        'head-neck': null,
      }),
      k: /** @type {Record<string, any>} */ ({})
    };

    // === DOM references ===
    const preview = document.querySelector('#preview');
    const overlay = document.querySelector('#overlay');
    const cameraSelect = document.querySelector('#cameraSelect');
    const toggleFlash = document.querySelector('#toggleFlash');
    const restartBtn = document.querySelector('#restartBtn');
    const captureBtn = document.querySelector('#captureBtn');
    const retakeBtn = document.querySelector('#retakeBtn');
    const nextAngleBtn = document.querySelector('#nextAngleBtn');
    const thumbs = document.querySelector('#thumbs');
    const helperText = document.querySelector('#helperText');
    const metaForm = document.querySelector('#metaForm');
    const animalIdInput = document.querySelector('#animalId');
    const eventDateInput = document.querySelector('#eventDate');
    const saveBtn = document.querySelector('#saveBtn');
    const numberSpan = document.querySelector('.animal-number');

    // === Camera helpers ===
    async function listCameras(){
      if(!navigator.mediaDevices?.enumerateDevices) return [];
      const devs = await navigator.mediaDevices.enumerateDevices();
      const cams = devs.filter(d=> d.kind === 'videoinput');
      if(cameraSelect){
        cameraSelect.innerHTML = '';
        cams.forEach((c,i)=>{
          const opt = document.createElement('option');
          opt.value = c.deviceId; opt.textContent = c.label || `كاميرا ${i+1}`;
          cameraSelect.appendChild(opt);
        });
      }
      return cams;
    }

    async function startCamera(deviceId){
      try{
        if(state.stream){ state.stream.getTracks().forEach(t=>t.stop()); }
        const constraints = deviceId ? { video: { deviceId: { exact: deviceId } } } : { video: { facingMode: { ideal: 'environment' } } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        state.stream = stream;
        if(preview) preview.srcObject = stream;
        const [track] = stream.getVideoTracks();
        state.track = track;
        state.capabilities = (track.getCapabilities && track.getCapabilities()) || null;
        if(preview){ await preview.play(); }
        fitOverlay();
        drawGuide();
        await populateTorchSupport();
      }catch(err){ console.warn('startCamera error', err); }
    }

    async function populateTorchSupport(){
      const cap = state.capabilities;
      const hasTorch = !!(cap && 'torch' in cap);
      if(toggleFlash) toggleFlash.disabled = !hasTorch;
    }

    async function toggleTorch(){
      try{
        if(!state.track) return;
        state.torchOn = !state.torchOn;
        await state.track.applyConstraints({ advanced: [{ torch: state.torchOn }] });
        if(toggleFlash){
          toggleFlash.setAttribute('aria-pressed', String(state.torchOn));
          toggleFlash.textContent = state.torchOn ? 'الفلاش: يعمل' : 'الفلاش';
        }
      }catch(err){ console.warn('Torch not supported', err); }
    }

    function fitOverlay(){
      if(!preview || !overlay) return;
      const rect = preview.getBoundingClientRect();
      overlay.width = Math.max(1, Math.floor(rect.width * devicePixelRatio));
      overlay.height = Math.max(1, Math.floor(rect.height * devicePixelRatio));
      overlay.style.width = rect.width + 'px';
      overlay.style.height = rect.height + 'px';
    }

    function drawGuide(){
      if(!overlay) return;
      const ctx2d = overlay.getContext('2d'); if(!ctx2d) return;
      ctx2d.clearRect(0,0,overlay.width, overlay.height);
      const w = overlay.width, h = overlay.height;
      // grid
      ctx2d.strokeStyle = 'rgba(255,255,255,0.35)';
      ctx2d.lineWidth = 1 * devicePixelRatio;
      for(let i=1;i<3;i++){
        ctx2d.beginPath(); ctx2d.moveTo((w/3)*i,0); ctx2d.lineTo((w/3)*i,h); ctx2d.stroke();
        ctx2d.beginPath(); ctx2d.moveTo(0,(h/3)*i); ctx2d.lineTo(w,(h/3)*i); ctx2d.stroke();
      }
      // frame per angle
      ctx2d.strokeStyle = 'rgba(14,160,90,0.9)';
      ctx2d.lineWidth = 4 * devicePixelRatio;
      let rx= w*0.08, ry= h*0.12, rw= w*0.84, rh= h*0.76;
      const a = state.currentAngle;
      if(a==='side'){
        rx = w*0.05; ry=h*0.15; rw=w*0.9; rh=h*0.7;
      }else if(a==='udder-front'){
        rx = w*0.18; ry=h*0.12; rw=w*0.64; rh=h*0.76;
        ctx2d.beginPath(); ctx2d.moveTo(w/2, ry); ctx2d.lineTo(w/2, ry+rh); ctx2d.stroke();
      }else if(a==='udder-rear'){
        rx = w*0.15; ry=h*0.12; rw=w*0.7; rh=h*0.76;
        ctx2d.beginPath(); ctx2d.moveTo(w*0.4, ry); ctx2d.lineTo(w*0.4, ry+rh); ctx2d.stroke();
        ctx2d.beginPath(); ctx2d.moveTo(w*0.6, ry); ctx2d.lineTo(w*0.6, ry+rh); ctx2d.stroke();
      }else if(a==='teat-close'){
        rx = w*0.25; ry=h*0.25; rw=w*0.5; rh=h*0.5;
        ctx2d.beginPath(); ctx2d.moveTo(w/2, h*0.2); ctx2d.lineTo(w/2, h*0.8); ctx2d.stroke();
        ctx2d.beginPath(); ctx2d.moveTo(w*0.2, h/2); ctx2d.lineTo(w*0.8, h/2); ctx2d.stroke();
      }else if(a==='front-body'){
        rx = w*0.12; ry=h*0.12; rw=w*0.76; rh=h*0.76;
        ctx2d.beginPath(); ctx2d.moveTo(w/2, ry); ctx2d.lineTo(w/2, ry+rh); ctx2d.stroke();
        ctx2d.beginPath(); ctx2d.moveTo(w*0.35, ry); ctx2d.lineTo(w*0.35, ry+rh); ctx2d.stroke();
        ctx2d.beginPath(); ctx2d.moveTo(w*0.65, ry); ctx2d.lineTo(w*0.65, ry+rh); ctx2d.stroke();
      }else if(a==='head-neck'){
        rx = w*0.2; ry=h*0.2; rw=w*0.6; rh=h*0.6;
        ctx2d.setLineDash([8*devicePixelRatio, 10*devicePixelRatio]);
        ctx2d.strokeRect(w*0.6, h*0.35, w*0.18, h*0.18);
        ctx2d.setLineDash([]);
      }
      if(ctx2d.roundRect){ ctx2d.beginPath(); ctx2d.roundRect(rx, ry, rw, rh, 20 * devicePixelRatio); ctx2d.stroke(); }
      else { ctx2d.strokeRect(rx, ry, rw, rh); }
    }

    function dataURLFromVideo(){
      if(!preview) return '';
      const w = preview.videoWidth || preview.clientWidth || 0;
      const h = preview.videoHeight || preview.clientHeight || 0;
      if(!w || !h) return '';
      const c = document.createElement('canvas'); c.width = w; c.height = h;
      const ctx2d = c.getContext('2d'); ctx2d.drawImage(preview,0,0,w,h);
      return c.toDataURL('image/jpeg', 0.92);
    }

    // === KPI helpers ===
    function hashString(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0; } return Math.abs(h); }
    function seededValue(seed, min, max){ const x = Math.sin(seed)*10000; const frac = x - Math.floor(x); return Math.round(min + frac*(max-min)); }

    // Minimal wrappers so earlier calls don't crash
    function metricRow(name, value){ return '<div class="metric"><div>'+name+'</div><div>'+value+'</div></div>'; }
    function refreshMetrics(angle){ if(typeof refreshMetricsEx==='function') return refreshMetricsEx(angle); }

    // Demo placeholders + sequence
    function makePlaceholder(label){
      const c = document.createElement('canvas');
      c.width = 1280; c.height = 720;
      const g = c.getContext('2d');
      const grd = g.createLinearGradient(0,0,1280,720);
      grd.addColorStop(0,'#e6f8ef'); grd.addColorStop(1,'#c7f9e9');
      g.fillStyle = grd; g.fillRect(0,0,1280,720);
      g.fillStyle = '#0ea05a'; g.fillRect(60,60,1160,600);
      g.fillStyle = '#ffffff'; g.font = 'bold 60px Cairo, Arial';
      g.textAlign='center'; g.textBaseline='middle';
      g.fillText('عرض توضيحي — '+label, 640, 360);
      g.font = '26px Cairo, Arial';
      g.fillText('Murabbik Visual Evaluation (Prototype)', 640, 430);
      return c.toDataURL('image/jpeg', 0.9);
    }

    async function runDemo(){
      const badge = document.getElementById('demoBadge');
      if(badge) badge.style.display='inline-block';
      for(const a of anglesOrder){
        setAngle(a);
        await new Promise(r=> setTimeout(r, 250));
        state.captures[a] = makePlaceholder(angleLabels[a]);
        renderThumbs();
        refreshMetrics(a);
        if(typeof refreshMetricsEx==='function') refreshMetricsEx(a);
      }
    }

        function setAngle(angle){
      state.currentAngle = angle;
      $$('.angle-tab').forEach(el=> el.classList.toggle('active', el.dataset.angle===angle));
      helperText.innerHTML = helperByAngle[angle];
      drawGuide();
      updateButtons();
      // النسخة الأصلية من المؤشرات
      refreshMetrics(angle);
      // نسخة موسعة لحساب MVS
      if(typeof refreshMetricsEx==='function') refreshMetricsEx(angle);
      if(typeof updateDropHint==='function') updateDropHint();
    }

    function updateButtons(){
      const hasCapture = !!state.captures[state.currentAngle];
      retakeBtn.disabled = !hasCapture;
    }

    function renderThumbs(){
      thumbs.innerHTML = '';
      for(const a of anglesOrder){
        const wrap = document.createElement('div'); wrap.className='thumb';
        const img = document.createElement('img');
        if(state.captures[a]){ img.src = state.captures[a]; }
        wrap.appendChild(img);
        const lb = document.createElement('div'); lb.className='label'; lb.textContent = angleLabels[a];
        wrap.appendChild(lb);
        wrap.title = angleLabels[a];
        wrap.addEventListener('click', ()=> setAngle(a));
        thumbs.appendChild(wrap);
      }
    }

    // ---------- أحداث واجهة ----------
    window.addEventListener('resize', ()=>{ fitOverlay(); drawGuide(); });

    $$('.angle-tab').forEach(btn=>{
      btn.addEventListener('click', ()=> setAngle(btn.dataset.angle));
    });

    const demoBtn = $('#demoBtn');
    if(demoBtn) demoBtn.addEventListener('click', runDemo);

    const uploadBtn = $('#uploadBtn');
    const uploadInput = $('#uploadInput');
    if(uploadBtn) uploadBtn.addEventListener('click', ()=> uploadInput && uploadInput.click());
    function onUploadFiles(e){
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{ state.captures[state.currentAngle] = reader.result; renderThumbs(); updateButtons(); refreshMetrics(state.currentAngle); if(typeof refreshMetricsEx==='function') refreshMetricsEx(state.currentAngle); };
      reader.readAsDataURL(file);
      if(uploadInput) uploadInput.value = '';
    }
    if(uploadInput) uploadInput.addEventListener('change', onUploadFiles);

    const previewWrap = document.querySelector('.preview-wrap');
    const dropHint = document.getElementById('dropHint');
    const dropAngleLabel = document.getElementById('dropAngleLabel');
    function updateDropHint(){ if(dropAngleLabel) dropAngleLabel.textContent = angleLabels[state.currentAngle]; }
    if(previewWrap){
      ['dragenter','dragover'].forEach(ev => previewWrap.addEventListener(ev, (e)=>{ e.preventDefault(); previewWrap.classList.add('dragover'); updateDropHint(); }));
      ['dragleave','dragend'].forEach(ev => previewWrap.addEventListener(ev, ()=> previewWrap.classList.remove('dragover')));
      previewWrap.addEventListener('drop', (e)=>{
        e.preventDefault(); previewWrap.classList.remove('dragover');
        const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{ state.captures[state.currentAngle] = reader.result; renderThumbs(); updateButtons(); refreshMetrics(state.currentAngle); };
        reader.readAsDataURL(file);
      });
    }

    toggleFlash.addEventListener('click', toggleTorch);

    restartBtn.addEventListener('click', async ()=>{
      await startCamera(cameraSelect.value);
    });

    cameraSelect.addEventListener('change', async ()=>{
      await startCamera(cameraSelect.value);
    });

    captureBtn.addEventListener('click', ()=>{
      const url = (typeof dataURLFromVideo==='function') ? dataURLFromVideo() : '';
      if(!url){ if(uploadInput) uploadInput.click(); return; }
      state.captures[state.currentAngle] = url;
      renderThumbs();
      updateButtons();
      refreshMetrics(state.currentAngle);
      if(typeof refreshMetricsEx==='function') refreshMetricsEx(state.currentAngle);
    });

    retakeBtn.addEventListener('click', ()=>{
      state.captures[state.currentAngle] = null;
      renderThumbs();
      updateButtons();
      refreshMetrics(state.currentAngle);
      if(typeof refreshMetricsEx==='function') refreshMetricsEx(state.currentAngle);
    });

    nextAngleBtn.addEventListener('click', ()=>{
      const idx = anglesOrder.indexOf(state.currentAngle);
      const next = anglesOrder[(idx+1)%anglesOrder.length];
      setAngle(next);
    });

    saveBtn.addEventListener('click', async ()=>{
      try{
        saveBtn.disabled = true; saveBtn.textContent = 'جارٍ الحفظ…';
        const animalId = animalIdInput.value.trim();
        const date = eventDateInput.value || todayCairo();
        if(!animalId){ alert('رقم/معرّف الحيوان غير موجود'); return; }

        if(isDemo){
          const uploaded = {};
          for(const [angle, dataUrl] of Object.entries(state.captures)){ if(dataUrl) uploaded[angle] = dataUrl; }
          const doc = {
            type: 'تقييم بصري بالكاميرا (عرض)', animalId, date, images: uploaded,
            notes: {
              isClean: $('#isClean').checked || false,
              goodLight: $('#goodLight').checked || false,
              onFlat: $('#onFlat').checked || false,
              animalStanding: $('#animalStanding').checked || false,
              teatsVisible: $('#teatsVisible').checked || false,
            },
            createdAt: Date.now()
          };
          localStorage.setItem('murabbik_demo_last', JSON.stringify(doc));
          alert('تم الحفظ (وضع العرض) — بدون رفع سحابي.');
          return;
        }

        // تحميل Firebase عند الحاجة فقط (كي لا يمنع خطأ الاستيراد تشغيل الكاميرا)
        const { db, storage, serverTimestamp, addDoc, collection, ref, uploadString, getDownloadURL } = await import('./js/firebase-config.js');
        // نستخدم animalId/date المُعرفَيْن بالأعلى قبل وضع العرض

        // رفع الصور إلى Firebase Storage
        const uploaded = {};
        for(const [angle, dataUrl] of Object.entries(state.captures)){
          if(!dataUrl) continue;
          const path = `camera-evaluations/${animalId}/${date}/${angle}.jpg`;
          const r = ref(storage, path);
          await uploadString(r, dataUrl, 'data_url');
          const url = await getDownloadURL(r);
          uploaded[angle] = url;
        }

        const doc = {
          type: 'تقييم بصري بالكاميرا',
          animalId, date,
          images: uploaded,
          notes: {
            isClean: $('#isClean').checked || false,
            goodLight: $('#goodLight').checked || false,
            onFlat: $('#onFlat').checked || false,
            animalStanding: $('#animalStanding').checked || false,
            teatsVisible: $('#teatsVisible').checked || false,
          },
          createdAt: serverTimestamp()
        };
        await addDoc(collection(db,'events'), doc);

        if(Object.keys(uploaded).length === 0){
          alert('تم حفظ التقييم بدون صور (لم تُلتقط صور).');
        } else {
          alert('تم الحفظ ورفع الصور بنجاح.');
        }

        // العودة لبطاقة الحيوان
        const go = confirm('هل تريد فتح بطاقة الحيوان الآن؟');
        if(go){
          const q = new URLSearchParams({ animalId, date });
          location.href = `cow-card.html?${q.toString()}`;
        }
      }catch(err){
        console.error(err);
        alert('حدث خطأ أثناء الحفظ/الرفع. تحقق من الاتصال وإعدادات Firebase.');
      }finally{
        saveBtn.disabled = false; saveBtn.textContent = 'حفظ التقييم والصور';
      }
    });

    // ---------- تشغيل مبدئي ----------
    (async function init(){
      try{
        if(isDemo){
          const badge = document.getElementById('demoBadge');
          if(badge) badge.style.display='inline-block';
          renderThumbs();
        setAngle('side');
        refreshMetrics('side');
        if(typeof refreshMetricsEx==='function') refreshMetricsEx('side');
          await runDemo();
          return;
        }
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
          alert('المتصفح لا يدعم تشغيل الكاميرا عبر الويب. جرّب Chrome/Edge أو جهاز موبايل.');
          return;
        }
        if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
          console.warn('غير آمن: يجب https أو localhost لتشغيل الكاميرا');
          alert('هذه الصفحة تحتاج https أو localhost لتشغيل الكاميرا.');
        }
        // ابدأ بالكاميرا الافتراضية للمطالبة بالإذن أولاً
        await startCamera();
        // ثم اعرض قائمة الكاميرات بعد الحصول على الإذن
        await listCameras();
        if(!cameraSelect.value && cameraSelect.options.length){ cameraSelect.value = cameraSelect.options[0].value; }
        renderThumbs();
        setAngle('side');
      }catch(err){
        console.warn(err);
        alert('تعذّر الوصول للكاميرا. تأكد من السماح بالأذونات واستخدام https.');
      }
    })();
  // نسخة موسّعة من لوحة المؤشرات وفق المطلوب
    function refreshMetricsEx(angle){
      const box = document.getElementById('metrics'); if(!box) return;
      const dataUrl = state.captures[angle];
      if(!dataUrl){ box.innerHTML = '<h3>مؤشرات تقديرية (Demo)</h3><div class="helper">التقط/ارفع صورة لزاوية <strong>'+angleLabels[angle]+'</strong> لعرض المؤشرات.</div>'; return; }
      computeKPIs(dataUrl, angle).then(k=>{
        state.k[angle] = Object.assign({}, state.k[angle]||{}, k);
        const all = Object.assign({}, state.k['side'], state.k['udder-rear'], state.k['udder-front'], state.k['teat-close'], state.k['front-body'], state.k['head-neck']);
        if(!all.rearLegsWidth && (state.k['udder-rear']?.teatDistribution)) all.rearLegsWidth = state.k['udder-rear'].teatDistribution;
        const overall = computeOverallMVS(all||{});
        box.innerHTML = '<h3>مؤشرات تقديرية (Demo) — '+angleLabels[angle]+'</h3>' +
          renderAngleMetrics(angle, k) +
          '<div class="metric" style="margin-top:6px"><div>النتيجة الإجمالية (MVS)</div><div>'+overall.mvs+' — <small>'+overall.grade+'</small></div></div>';
      });
    }
  // === OVERRIDES: اعتماد Rump Angle بدل Body Depth على الصورة الجانبية ===
    function computeKPIs(dataUrl, angle){
      try{
        const img = new Image(); img.src = dataUrl; return img.decode().then(()=>{
          const c = document.createElement('canvas'); c.width = 320; c.height = Math.max(1, Math.round(320*(img.height/img.width)));
          const g = c.getContext('2d'); g.drawImage(img,0,0,c.width,c.height);
          const id = g.getImageData(0,0,c.width,c.height);
          let sum=0; for(let i=0;i<id.data.length;i+=4){ sum += 0.2126*id.data[i]+0.7152*id.data[i+1]+0.0722*id.data[i+2]; }
          const avg = sum/(id.data.length/4);
          const lighting = Math.max(0, Math.min(100, Math.round((avg/255)*100)));
          const ratio = img.width/img.height; const framing = Math.max(0, Math.min(100, Math.round(100 - Math.abs(ratio-1.6)*80)));
          const seed = hashString(angle + dataUrl.slice(0,64));
          const k = { lighting, framing };
          if(angle==='side'){
            k.rumpAngle = seededValue(seed+101, 60, 95); // زاوية الحوض/العجز — المؤثر الأساسي على سهولة الولادة والخصوبة
            k.backRump  = seededValue(seed+102, 60, 95); // سلامة الظهر والحوض
          }
          if(angle==='udder-rear'){
            k.udderCleft       = seededValue(seed+103, 60, 95);
            k.udderHeightHock  = seededValue(seed+104, 60, 95);
            k.teatDistribution = seededValue(seed+105, 60, 95);
          }
          if(angle==='udder-front'){
            k.foreAttachment   = seededValue(seed+106, 60, 95);
          }
          if(angle==='teat-close'){
            k.teatLengthDia    = seededValue(seed+107, 60, 95);
          }
          if(angle==='front-body'){
            k.chestWidth       = seededValue(seed+108, 60, 95);
            k.frontLegsWidth   = seededValue(seed+109, 60, 95);
          }
          if(angle==='head-neck'){
            k.femininity       = seededValue(seed+110, 60, 95);
          }
          return k;
        });
      }catch(e){
        return Promise.resolve({ lighting: 0, framing: 0 });
      }
    }

    function renderAngleMetrics(angle, k){
      const rows = [];
      if(angle==='side'){
        rows.push(metricRow('زاوية الحوض/العجز (Rump Angle)', (k.rumpAngle||0)+'%'));
        rows.push(metricRow('الظهر والحوض (Back & Rump)', (k.backRump||0)+'%'));
      }
      if(angle==='udder-rear'){
        rows.push(metricRow('رابطة وسطية/الشق (Udder Cleft)', (k.udderCleft||0)+'%'));
        rows.push(metricRow('ارتفاع الضرع عن العرقوب', (k.udderHeightHock||0)+'%'));
        rows.push(metricRow('توزيع الحلمات (Spacing/Balance)', (k.teatDistribution||0)+'%'));
      }
      if(angle==='udder-front'){
        rows.push(metricRow('التحام/اتصال الضرع الأمامي', (k.foreAttachment||0)+'%'));
      }
      if(angle==='teat-close'){
        rows.push(metricRow('طول/قطر الحلمات (نسبي)', (k.teatLengthDia||0)+'%'));
      }
      if(angle==='front-body'){
        rows.push(metricRow('اتساع الصدر (Chest Width)', (k.chestWidth||0)+'%'));
        rows.push(metricRow('اتساع الأرجل الأمامية', (k.frontLegsWidth||0)+'%'));
      }
      if(angle==='head-neck'){
        rows.push(metricRow('أنوثة الرأس/الرقبة', (k.femininity||0)+'%'));
      }
      rows.push(metricRow('جودة الإضاءة', (k.lighting||0)+'%'));
      rows.push(metricRow('اتساق الإطار', (k.framing||0)+'%'));
      return rows.join('');
    }

    function computeOverallMVS(all){
      const weights = {
        // 40% Udder (توزّع داخلي)
        udderCleft:12, udderHeightHock:8, teatDistribution:10, foreAttachment:6, teatLengthDia:4,
        // 30% Rump Angle
        rumpAngle:30,
        // 20% Legs (خلفية/أمامية + اتساع صدر كمؤشّر أمامي)
        rearLegsWidth:10, frontLegsWidth:6, chestWidth:4,
        // 10% Femininity
        femininity:10
      };
      let score=0, weightSum=0;
      for(const [k,v] of Object.entries(weights)){
        if(all && all[k]!=null){ score += (v * all[k])/100; weightSum += v; }
      }
      const mvs = weightSum? Math.round((score/weightSum)*100):0;
      let grade='';
      if(mvs>=85) grade='ممتاز'; else if(mvs>=70) grade='جيد'; else if(mvs>=55) grade='يحتاج انتباه'; else grade='تنبيه';
      return { mvs, grade };
    }
  </script>
</body>
</html>
