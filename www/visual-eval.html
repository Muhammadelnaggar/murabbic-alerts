<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨ØµØ±ÙŠ â€” Murabbik</title>
  <style>
    :root{--bg:#fff9db;--card:#f1f8e9;--border:#c5e1a5;--green:#2e7d32}
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;color:#1b5e20;padding:12px}
    h1{margin:0 0 10px;text-align:center;color:var(--green);font-size:22px}
    .wrap{max-width:980px;margin:0 auto}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#dcedc8;font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px}
    button{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:bold;cursor:pointer}
    .btn{background:#fff;border:1px solid var(--green);color:var(--green)}
    .btn-primary{background:var(--green);color:#fff}
    .muted{opacity:.9}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}

    .stepper{display:flex;gap:8px;flex-wrap:wrap}
    .step{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:bold}
    .step.active{background:#2e7d32;color:#fff;border-color:#2e7d32}

    .media{position:relative;background:#000;border-radius:12px;overflow:hidden;min-height:240px}
    video,canvas{width:100%;height:auto;display:block}
    .overlay{position:absolute;inset:0;pointer-events:none}
    .overlay::before{content:"";position:absolute;inset:10% 8%;border:2px dashed rgba(255,255,255,.6);border-radius:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    .pointsHint{font-size:13px;color:#1b5e20}
    .pointsBar{display:flex;gap:6px;flex-wrap:wrap}
    .ptBadge{padding:6px 8px;border-radius:8px;border:1px dashed #8bc34a;background:#f7fff4}
    .ptBadge.done{background:#dcedc8;border-style:solid}

    .kpi{background:#eafbe7;border:1px solid #e0ebd3;border-radius:10px;padding:10px;text-align:center}
    .kpi b{display:block;font-size:18px;margin-top:4px;color:#1b5e20}

    .notice{display:none;border:1px solid var(--border);background:#fff;padding:12px;border-radius:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨ØµØ±ÙŠ â€” Murabbik</h1>
  <div class="row" id="hdrInfo">
    <span class="pill">ğŸ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†: <b id="who">â€”</b></span>
    <span class="pill">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: <b id="when">â€”</b></span>
    <span class="pill">ğŸ‘ï¸ Ø§Ù„Ù„Ù‚Ø·Ø©: <b id="viewLbl">â€”</b></span>
  </div>

  <div class="card">
    <div class="stepper" id="stepper"></div>
    <div class="media" id="mediaBox">
      <video id="preview" playsinline muted></video>
      <canvas id="snap" style="display:none"></canvas>
      <div class="overlay"></div>
    </div>
    <div class="controls">
      <button id="startCam" class="btn">ğŸ¥ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="capture" class="btn-primary">ğŸ“¸ Ø§Ù„ØªÙ‚Ø·</button>
      <button id="retake" class="btn">â†©ï¸ Ø¥Ø¹Ø§Ø¯Ø©</button>
      <label class="btn" style="position:relative;overflow:hidden">
        â¬†ï¸ Ø±ÙØ¹ ØµÙˆØ±Ø©
        <input id="uploader" type="file" accept="image/*" capture="environment" style="position:absolute;inset:0;opacity:0"/>
      </label>
      <button id="next" class="btn">Ø§Ù„ØªØ§Ù„ÙŠ â–¶ï¸</button>
    </div>
    <div class="notice" id="camMsg"></div>
  </div>

  <div class="card" id="rearTools" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div class="pointsHint">
        Ø¶Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨:
        <ol style="margin:6px 0 0 18px">
          <li>Ø­Ù„Ù…Ø© Ø®Ù„ÙÙŠØ© ÙŠØ³Ø§Ø±</li>
          <li>Ø­Ù„Ù…Ø© Ø®Ù„ÙÙŠØ© ÙŠÙ…ÙŠÙ†</li>
          <li>Ø­Ù„Ù…Ø© Ø£Ù…Ø§Ù…ÙŠØ© ÙŠØ³Ø§Ø±</li>
          <li>Ø­Ù„Ù…Ø© Ø£Ù…Ø§Ù…ÙŠØ© ÙŠÙ…ÙŠÙ†</li>
          <li>Ø¹Ø±Ø¶ Ø§Ù„Ø¶Ø±Ø¹ â€” ÙŠØ³Ø§Ø±</li>
          <li>Ø¹Ø±Ø¶ Ø§Ù„Ø¶Ø±Ø¹ â€” ÙŠÙ…ÙŠÙ†</li>
        </ol>
      </div>
      <div class="pointsBar" id="pointsBar"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="undoPoint" class="btn">ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ù†Ù‚Ø·Ø©</button>
      <button id="clearPoints" class="btn">Ù…Ø³Ø­ Ø§Ù„Ù†Ù‚Ø§Ø·</button>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div class="kpi"><span class="muted">ØªÙ…Ø§Ø«Ù„ Ø§Ù„Ø¶Ø±Ø¹</span><b id="kSym">â€”</b></div>
      <div class="kpi"><span class="muted">Ø§ØªØ³Ø§Ø¹ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ù„Ù…Ø§Øª</span><b id="kPlace">â€”</b></div>
      <div class="kpi"><span class="muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span><b id="kNotes">â€”</b></div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="saveEval" class="btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      </div>
      <div class="row">
        <button id="gotoCard" class="btn">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
        <button id="gotoDash" class="btn">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // === Firebase setup (Ù…Ø±Ù†) ===
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { getStorage, ref as sRef, uploadString } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

  let app, db, auth, storage;
  try{
    const mod = await import('./js/firebase-config.js');
    if (mod?.db && mod?.auth){ app = mod.app; db = mod.db; auth = mod.auth; storage = getStorage(app); }
    else if (mod?.firebaseConfig){ app = initializeApp(mod.firebaseConfig); db = getFirestore(app); auth = getAuth(app); storage = getStorage(app); }
    else { throw new Error('Bad firebase-config.js'); }
  }catch(e){
    console.error('Firebase config load failed', e);
    const fallback = { apiKey:"AIzaSyB0dtFS3R-MQ-LJfd_dB1YOTxiwDVshIYc", authDomain:"murabbik.firebaseapp.com", projectId:"murabbik", storageBucket:"murabbik.appspot.com", messagingSenderId:"402719243568", appId:"1:402719243568:web:631114a260d23202dd5cf5" };
    app = initializeApp(fallback); db = getFirestore(app); auth = getAuth(app); storage = getStorage(app);
  }

  // === Helpers / State ===
  const qs = new URLSearchParams(location.search);
  const animalId = qs.get('animalId') || qs.get('number') || localStorage.getItem('lastAnimalId') || '';
  const today = new Date();
  const whenStr = today.toISOString().slice(0,10);
  const el = (id)=> document.getElementById(id);
  const nf = (x)=> new Intl.NumberFormat('ar-EG',{maximumFractionDigits:1}).format(x||0);

  el('who').textContent = animalId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  el('when').textContent = today.toLocaleDateString('ar-EG');
  el('gotoDash').onclick = ()=> location.href = 'dashboard.html';
  el('gotoCard').onclick = ()=> { if (animalId){ location.href = `cow-card.html?animalId=${encodeURIComponent(animalId)}&number=${encodeURIComponent(animalId)}` } };

  if (!animalId){
    const msg = el('camMsg');
    msg.textContent = 'âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· Ù…Ø§ Ù„Ù… ØªØ¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ù„Ø§Ø­Ù‚Ù‹Ø§.';
    msg.style.display = 'block';
  }

  const views = [
    {key:'left',   label:'Ø¬Ø§Ù†Ø¨ ÙŠØ³Ø§Ø±'},
    {key:'right',  label:'Ø¬Ø§Ù†Ø¨ ÙŠÙ…ÙŠÙ†'},
    {key:'rear',   label:'Ø®Ù„Ù â€” Ø§Ù„Ø¶Ø±Ø¹'},
    {key:'rear34', label:'Â¾ Ø®Ù„ÙÙŠ'}
  ];
  let cur = 0; // index of view
  let mediaStream = null;
  const images = {}; // key -> dataURL
  const points = { rear: [] }; // array of points for rear view

  // Build stepper
  const stepper = el('stepper');
  function renderStepper(){
    stepper.innerHTML = '';
    views.forEach((v,i)=>{
      const s = document.createElement('div');
      s.className = 'step'+(i===cur?' active':'');
      s.textContent = `${i+1}) ${v.label}${images[v.key]? ' âœ…':''}`;
      stepper.appendChild(s);
    });
    el('viewLbl').textContent = views[cur].label;
  }
  renderStepper();

  // Camera controls
  const video = el('preview');
  const canvas = el('snap');
  const ctx = canvas.getContext('2d');
  const camMsg = el('camMsg');

  async function startCam(){
    try{
      stopCam();
      mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal:'environment' } }, audio:false });
      video.srcObject = mediaStream; await video.play();
      video.style.display='block'; canvas.style.display='none';
      camMsg.style.display='none';
    }catch(err){
      console.error(err);
      camMsg.textContent = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ.';
      camMsg.style.display = 'block';
    }
  }
  function stopCam(){
    if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
  }

  function capture(){
    const vw = video.videoWidth || video.clientWidth; const vh = video.videoHeight || video.clientHeight;
    if (!vw || !vh){ camMsg.textContent='Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯.'; camMsg.style.display='block'; return; }
    canvas.width = vw; canvas.height = vh;
    ctx.drawImage(video, 0, 0, vw, vh);
    video.style.display='none'; canvas.style.display='block';
    const url = canvas.toDataURL('image/jpeg', 0.9);
    images[views[cur].key] = url;
    renderStepper();
    maybeShowRearTools();
  }

  function retake(){
    // Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù†ÙØ³ Ø§Ù„Ø®Ø·ÙˆØ© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    delete images[views[cur].key];
    renderStepper();
    video.style.display='block'; canvas.style.display='none';
    points.rear = [];
    drawPoints(); updateMetrics();
    el('rearTools').style.display = 'none';
  }

  function handleUpload(file){
    const reader = new FileReader();
    reader.onload = () =>{
      const img = new Image();
      img.onload = ()=>{
        canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img,0,0);
        video.style.display='none'; canvas.style.display='block';
        images[views[cur].key] = canvas.toDataURL('image/jpeg',0.9);
        renderStepper();
        maybeShowRearTools();
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  }

  function next(){
    if (cur < views.length-1){ cur++; renderStepper(); points.rear=[]; drawPoints(); updateMetrics(); el('rearTools').style.display='none'; }
    else { camMsg.textContent = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø®Ø·ÙˆØ§Øª. ÙŠÙ…ÙƒÙ†Ùƒ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¢Ù†.'; camMsg.style.display='block'; }
  }

  function maybeShowRearTools(){
    if (views[cur].key === 'rear' && images['rear']){ el('rearTools').style.display='block'; drawPoints(); updateMetrics(); }
    else { el('rearTools').style.display='none'; }
  }

  // === Rear points marking on canvas ===
  const pointsOrder = [
    'Ø­Ù„Ù…Ø© Ø®Ù„ÙÙŠØ© ÙŠØ³Ø§Ø±','Ø­Ù„Ù…Ø© Ø®Ù„ÙÙŠØ© ÙŠÙ…ÙŠÙ†','Ø­Ù„Ù…Ø© Ø£Ù…Ø§Ù…ÙŠØ© ÙŠØ³Ø§Ø±','Ø­Ù„Ù…Ø© Ø£Ù…Ø§Ù…ÙŠØ© ÙŠÙ…ÙŠÙ†','Ø¹Ø±Ø¶ Ø§Ù„Ø¶Ø±Ø¹ â€” ÙŠØ³Ø§Ø±','Ø¹Ø±Ø¶ Ø§Ù„Ø¶Ø±Ø¹ â€” ÙŠÙ…ÙŠÙ†'
  ];
  const pointsBar = el('pointsBar');
  function renderPointsBar(){
    pointsBar.innerHTML='';
    pointsOrder.forEach((lbl,i)=>{
      const div = document.createElement('div');
      div.className = 'ptBadge'+(points.rear[i]? ' done':'');
      div.textContent = (i+1)+') '+lbl;
      pointsBar.appendChild(div);
    });
  }
  function drawPoints(){
    if (!images['rear']) return;
    // redraw current image
    const img = new Image(); img.onload = ()=>{
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#ff5252'; ctx.strokeStyle = '#2e7d32'; ctx.lineWidth = 2;
      points.rear.forEach((p,idx)=>{
        ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fill();
        ctx.font = '14px Arial'; ctx.fillStyle = '#2e7d32'; ctx.fillText(String(idx+1), p.x+8, p.y-8);
        ctx.fillStyle = '#ff5252';
      });
    }; img.src = images['rear'];
    renderPointsBar();
  }
  canvas.addEventListener('click', (e)=>{
    if (views[cur].key !== 'rear' || !images['rear']) return;
    if (points.rear.length >= pointsOrder.length) return;
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) * (canvas.width/rect.width);
    const y = (e.clientY - rect.top)  * (canvas.height/rect.height);
    points.rear.push({x,y});
    drawPoints(); updateMetrics();
  });
  el('undoPoint').onclick = ()=>{ points.rear.pop(); drawPoints(); updateMetrics(); };
  el('clearPoints').onclick= ()=>{ points.rear=[]; drawPoints(); updateMetrics(); };

  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
  function updateMetrics(){
    // Compute simple metrics when we have at least width points
    const kSym = el('kSym'); const kPlace = el('kPlace'); const kNotes = el('kNotes');
    if (points.rear.length < 6){ kSym.textContent='â€”'; kPlace.textContent='â€”'; kNotes.textContent='â€”'; return; }
    const [rrL, rrR, rfL, rfR, uL, uR] = points.rear; // naming: rear-left teat, rear-right teat, fore-left, fore-right
    const w = Math.max(1, dist(uL,uR));

    // ØªÙ…Ø§Ø«Ù„: ÙØ±Ù‚ ØªÙ…Ø±ÙƒØ² Ø­Ù„Ù…Ø§Øª Ø§Ù„ÙŠØ³Ø§Ø±/Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø¹Ø±Ø¶
    const leftAvgX  = (rrL.x + rfL.x)/2; const rightAvgX = (rrR.x + rfR.x)/2;
    const leftGap   = Math.abs(leftAvgX - uL.x); const rightGap = Math.abs(uR.x - rightAvgX);
    const asym      = Math.abs(leftGap - rightGap)/w; // 0 Ø£ÙØ¶Ù„
    const scoreSym  = Math.max(0, Math.min(100, Math.round(100*(1 - asym*2))));

    // Ø§ØªØ³Ø§Ø¹ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ù„Ù…Ø§Øª: Ø£ØµØºØ± Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø£ÙŠ Ø­Ù…ØªÙŠÙ† Ù†Ø³Ø¨Ø©Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ (ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯Øª ÙƒØ§Ù† Ø£ÙØ¶Ù„ Ø­ØªÙ‰ Ø­Ø¯ Ù…Ø¹ÙŠÙ†)
    const teats = [rrL, rrR, rfL, rfR];
    let minD = Infinity; for(let i=0;i<4;i++){ for(let j=i+1;j<4;j++){ minD = Math.min(minD, dist(teats[i], teats[j])); } }
    const spread = minD / w; // Ø·Ø¨ÙŠØ¹ÙŠ ~0.08â€“0.18 ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ø­Ø³Ø¨ Ø§Ù„ØµÙˆØ±Ø© â€” Ù†Ø­ÙˆÙ„ Ù„Ø¯Ø±Ø¬Ø©
    let scorePlace = Math.round(Math.max(0, Math.min(100, (spread-0.06)/0.12*100))); // 0.06â†’0 ØŒ 0.18â†’100 ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§

    kSym.textContent   = scoreSym+' / 100';
    kPlace.textContent = scorePlace+' / 100';
    const notes=[]; if (scoreSym<60) notes.push('ØªÙ…Ø§Ø«Ù„ Ø§Ù„Ø¶Ø±Ø¹ Ù…Ù†Ø®ÙØ¶ â€” Ø±Ø§Ø¬Ø¹ Ø§Ù†ØªØ¸Ø§Ù… Ø§Ù„ÙŠÙ…ÙŠÙ†/Ø§Ù„ÙŠØ³Ø§Ø±.'); if (scorePlace<60) notes.push('Ø§Ù„Ø­Ù„Ù…Ø§Øª Ù…ØªÙ‚Ø§Ø±Ø¨Ø© â€” Ø±Ø§Ø¬Ø¹ Ø§ØªØ³Ø§Ø¹ Ø§Ù„ÙˆØ¶Ø¹.');
    kNotes.textContent = notes.length? notes.join(' | ') : 'Ø¬ÙŠØ¯';
  }

  // === Save ===
  async function saveEvaluation(){
    const user = auth.currentUser; if (!user){ location.href='login.html'; return; }
    const uid = user.uid; const ts = Date.now();
    // upload available images
    const imagePaths = {};
    for (const v of views){
      const key = v.key; const url = images[key]; if (!url) continue;
      const path = `evaluations/${uid}/${animalId||'unknown'}/${ts}_${key}.jpg`;
      const ref = sRef(storage, path);
      await uploadString(ref, url, 'data_url');
      imagePaths[key] = path;
    }

    const docData = {
      userId: uid,
      animalId: animalId || null,
      eventDate: whenStr,
      views: views.map(v=>v.key),
      images: imagePaths,
      points: { rear: points.rear },
      scores: {
        udder_symmetry: (el('kSym').textContent==='â€”'? null : parseInt(el('kSym').textContent)),
        teat_placement: (el('kPlace').textContent==='â€”'? null : parseInt(el('kPlace').textContent))
      },
      createdAt: serverTimestamp()
    };

    // save evaluation
    const evalRef = await addDoc(collection(db,'evaluations'), docData);

    // optional: Ø³Ø¬Ù„ Ø­Ø¯Ø« Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠØ©
    await addDoc(collection(db,'events'), {
      userId: uid,
      animalId: animalId || null,
      eventDate: whenStr,
      type: 'ØªÙ‚ÙŠÙŠÙ… Ø¨ØµØ±ÙŠ',
      eventType: 'ØªÙ‚ÙŠÙŠÙ… Ø¨ØµØ±ÙŠ (Ø¶Ø±Ø¹)',
      context: { source: 'visual-eval', evalId: evalRef.id },
      createdAt: serverTimestamp()
    });

    const n = el('camMsg');
    n.textContent = 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­';
    n.style.display = 'block';
  }

  // === Wire UI ===
  el('startCam').onclick = startCam;
  el('capture').onclick  = capture;
  el('retake').onclick   = retake;
  el('uploader').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if (f) handleUpload(f); });
  el('next').onclick     = next;
  el('saveEval').onclick = saveEvaluation;

  // start with camera off for privacy; auto-start if permission previously granted
  if (navigator.permissions && navigator.permissions.query){
    try{ const st = await navigator.permissions.query({name:'camera'}); if (st.state==='granted') startCam(); }catch{}
  }

  onAuthStateChanged(auth, (user)=>{ if (!user) location.href='login.html'; });
  window.addEventListener('beforeunload', ()=> stopCam());
</script>
</body>
</html>
