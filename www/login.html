<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تسجيل الدخول — مُرَبِّيك</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0b7f47">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="/icons/icon-192.png">

  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f7faf7;
      --bg-top:#eef7f1;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --brand:#0ea05a;
      --brand-600:#0b7f47;
      --danger:#c2410c;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Cairo',sans-serif;
      background:linear-gradient(180deg,var(--bg-top) 0%, var(--bg) 60%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      color:var(--text);
      padding:20px;
    }

    /* Header */
    .topbar{
      position:absolute;
      top:20px;
      left:0;
      right:0;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand img{
      width:48px;
      height:48px;
      object-fit:contain;
    }

    .brand-text{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }

    .brand-text .main{
      font-weight:900;
      font-size:26px;
    }

    .brand-text .sub{
      font-size:14px;
      color:var(--brand-600);
      font-weight:800;
      opacity:.8;
    }

    /* Card */
    .card{
      width:100%;
      max-width:380px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 10px 26px rgba(2,6,23,.08);
      padding:24px 20px 18px;
      text-align:center;
    }

    .card h2{
      margin:0 0 6px;
      font-size:22px;
      font-weight:900;
      color:var(--brand-600);
    }

    .desc{
      font-size:13px;
      color:var(--muted);
      margin-bottom:18px;
    }

    .msg{
      display:none;
      margin-bottom:12px;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      font-size:14px;
      border:1px solid transparent;
    }
    .msg.ok{ display:block;background:#dcfce7;border-color:#86efac;color:#14532d;}
    .msg.err{ display:block;background:#fee2e2;border-color:#fca5a5;color:#7f1d1d;}

    input{
      width:100%;
      padding:13px;
      border-radius:14px;
      border:1px solid var(--border);
      font-size:15px;
      margin-bottom:12px;
      outline:none;
    }

    input:focus{
      border-color:rgba(14,160,90,.55);
      box-shadow:0 0 0 4px rgba(14,160,90,.12);
    }

    button{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--brand);
      background:var(--brand);
      color:#fff;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      transition:.15s ease;
    }

    button:hover{
      background:var(--brand-600);
      border-color:var(--brand-600);
    }

    button:disabled{
      opacity:.7;
      cursor:not-allowed;
    }

    .hint{
      margin-top:14px;
      font-size:14px;
      color:var(--muted);
    }

    footer{
      position:absolute;
      bottom:16px;
      font-size:14px;
      color:var(--muted);
    }

  </style>
</head>

<body>

  <div class="topbar">
    <div class="brand">
      <img src="/images/logo.png" alt="مُرَبِّيك">
      <div class="brand-text">
        <div class="main">مُرَبِّيك</div>
        <div class="sub">نظام خبير يصنع القرار.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>تسجيل الدخول</h2>
    <div class="desc">أدخل رقم هاتفك للمتابعة</div>

    <div id="formMsg" class="msg"></div>

    <form id="loginForm">
      <input type="text" id="phone" placeholder="رقم الهاتف" required />
      <input type="password" id="password" placeholder="كلمة المرور" required />
      <button id="submitBtn" type="submit">دخول</button>
    </form>

    <div class="hint">
      نظام ذكي لتحليل القطيع وتبسيط القرار للمربي
    </div>
  </div>
<div style="margin-top:12px; font-size:14px;">
  ليس لديك حساب؟
  <a href="register.html" 
     style="color:#0ea05a; font-weight:900; text-decoration:none;">
     أنشئ حساب جديد
  </a>
</div>

  <footer>
    © 2026 Murabbik. All rights reserved.
  </footer>

<script type="module">
  import { db } from "./js/firebase-config.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const form = document.getElementById("loginForm");
  const btn  = document.getElementById("submitBtn");
  const msg  = document.getElementById("formMsg");

  function setMsg(t, ok=false){
    msg.textContent = t;
    msg.className   = "msg " + (ok ? "ok" : "err");
    msg.style.display = "block";
  }

  function phoneKeyOf(raw){
    const s = (raw||"").trim()
      .replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d))
      .replace(/\D/g,'');
    return s;
  }

  form.addEventListener("submit", async (e)=>{
    e.preventDefault(); 
    msg.style.display="none";
    const prev = btn.textContent; 
    btn.disabled=true; 
    btn.textContent="جارٍ التحقق…";

    try{
      const phoneIn = document.getElementById("phone").value;
      const passIn  = document.getElementById("password").value;
      const phoneKey = phoneKeyOf(phoneIn);

      if (!phoneKey || !passIn){ 
        setMsg("أدخل رقم الهاتف وكلمة المرور."); 
        return; 
      }

      const auth = getAuth();
      const pseudoEmail = `${phoneKey}@murabbik.local`;

      const cred = await signInWithEmailAndPassword(auth, pseudoEmail, passIn);
      const uid  = cred.user.uid;

      const snap = await getDoc(doc(db,"users", uid));
      const u = snap.exists() ? snap.data() : {};
      const tenant = u.userId || uid;

      localStorage.setItem("userId", tenant);

      setMsg("✅ تم تسجيل الدخول — تحويل…", true);
      setTimeout(()=> location.href="dashboard.html", 600);

    }catch(err){
      setMsg("رقم الهاتف أو كلمة المرور غير صحيحة.");
    }finally{
      btn.disabled=false; 
      btn.textContent=prev;
    }
  });
</script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(()=>{});
  }
</script>


</body>
</html>

