<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>قالب الأحداث – مربيك</title>

  <!-- تتبع موحّد -->
  <script>window.dataLayer = window.dataLayer || [];</script>
  <script src="js/app-core.js"></script>
  <script type="module" src="js/timeline.js"></script>
  <script type="module" src="js/smart-checks.js"></script>
  <script src="js/tenant-bootstrap.js"></script>
  <script src="js/api.js"></script>
  <!-- سكربت مشترك للأحداث -->
<script src="js/event-core.js"></script>


  <!-- فايربيز -->
  <script type="module" src="js/firebase-config.js"></script>

  <!-- التنبيهات الذكية -->
  <script src="js/smart-alerts.js"></script>

  <style>
    body { font-family: 'Cairo', sans-serif; background:#f9f9f9; margin:0; }
    .hidden-template { display:none; }
  </style>
</head>
<body>
  <div class="hidden-template">
    <!-- هذه الصفحة Template فقط – لا تُعرَض للمربي -->
    <h3>قالب الأحداث الذكي – مربيك</h3>
  </div>

  <script>
    // تسجيل Page View (مرة واحدة فقط)
    t.event('page_view', { page: location.pathname });

    // تمرير السياق (animalId, date) لأي صفحة ابن
    function buildTargetUrl(base) {
      const params = new URLSearchParams();
      const animalId = localStorage.getItem("lastAnimalId") || "";
      const date = localStorage.getItem("lastEventDate") || "";
      if (animalId) params.set("animalId", animalId);
      if (date) params.set("date", date);
      return base + "?" + params.toString();
    }

    // الحفظ الذكي الموحد لكل الأحداث
    window.saveEvent = async function(eventData) {
      // تحقق من القواعد (smart-checks)
      const check = window.smart?.validate ? smart.validate(eventData) : null;
      if (check?.severity === "critical") {
        window.smartAlerts?.show(check.message, { type:"error", block:true });
        return;
      }

      try {
        const res = await fetch("/api/events", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(eventData)
        });
        if (res.ok) {
          window.t?.event("event_save", { eventType: eventData.eventType });
          window.smartAlerts?.show("✅ تم الحفظ بنجاح", { type:"success" });
          // بعد النجاح → رجوع للداشبورد
          location.href = "dashboard.html";
        } else {
          const msg = await res.text();
          window.smartAlerts?.show("❌ فشل في التسجيل: " + msg, { type:"error" });
        }
      } catch (err) {
        console.error(err);
        window.smartAlerts?.show("⚠️ خطأ في الاتصال بالخادم", { type:"error" });
      }
    };
  </script>
</body>
</html>
