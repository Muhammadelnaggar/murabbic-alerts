<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ§  Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© â€” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø©</title>
  <style>
    :root{--bg:#fff9db;--card:#f1f8e9;--border:#c5e1a5;--green:#2e7d32}
    *{box-sizing:border-box}
    body{direction:rtl;background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;color:#1b5e20;padding:12px}
    h1{margin:0 0 10px;text-align:center;color:var(--green);font-size:22px}
    .wrap{max-width:1080px;margin:0 auto}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#dcedc8;font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px}
    input,select,button{min-height:44px;font-size:14px}
    input,select{padding:10px;border:1px solid #ccc;border-radius:10px}
    button{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:bold;cursor:pointer}
    .btn{background:#fff;border:1px solid var(--green);color:var(--green)}
    .btn-primary{background:var(--green);color:#fff}
    .muted{opacity:.85}
    .warn{color:#c62828}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
    .kpi{background:#eafbe7;border:1px solid #e0ebd3;border-radius:10px;padding:10px;text-align:center}
    .kpi b{display:block;font-size:18px;margin-top:4px;color:#1b5e20}
    .table-wrap{display:none}
    @media(max-width:640px){.grid{grid-template-columns:1fr 1fr}}
    /* Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØºØ°ÙŠØ© */
    .quality{display:flex;align-items:center;gap:10px;margin-top:8px}
    .quality .bar{flex:1;height:14px;border-radius:999px;background:#eceff1;border:1px solid var(--border);overflow:hidden}
    .quality .bar span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#e53935,#fdd835,#43a047);transition:width .4s ease}
    .quality .score{min-width:64px;text-align:center;font-weight:bold}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ§  Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© â€” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø©</h1>
  <div class="row" id="hdrInfo">
    <span class="pill">ğŸ„ Ø§Ù„Ù‡Ø¯Ù: <b id="who">â€”</b></span>
    <span class="pill">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø©: <b id="date">â€”</b></span>
    <span class="pill">âš™ï¸ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„: <b id="mode">â€”</b></span>
    <span class="pill">ğŸƒ Ø§Ù„Ù†ÙˆØ¹: <b id="species">â€”</b></span>
    <span class="pill">ğŸ•’ DIM: <b id="dim">â€”</b></span>
    <span class="pill">ğŸ¤° DCC: <b id="dcc">â€”</b></span>
  </div>

  <!-- Ù…Ø¤Ø´Ø± Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØºØ°ÙŠØ© -->
  <div class="card" id="qualityCard">
    <div class="row" style="align-items:center">
      <span class="pill">ğŸŒˆ Ù…Ø¤Ø´Ø± Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØºØ°ÙŠØ©: <b id="qLabel">â€”</b></span>
      <div class="quality" style="flex:1">
        <div class="bar"><span id="qFill"></span></div>
        <div class="score" id="qScore">â€”</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div class="kpi"><span class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒØ¬Ù… DM/Ø±Ø£Ø³</span><b id="kpiDM">â€”</b></div>
      <div class="kpi"><span class="muted">ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³/ÙŠÙˆÙ…</span><b id="kpiCost">â€”</b></div>
      <div class="kpi"><span class="muted">Ø³Ø¹Ø± Ø·Ù† Ø§Ù„Ø®Ù„Ø·Ø© (DM)</span><b id="kpiMix">â€”</b></div>
      <div class="kpi"><span class="muted">Ø®Ø´ÙÙ† : Ù…Ø±ÙƒØ² (DM)</span><b id="kpiFC">â€”</b></div>
      <div class="kpi"><span class="muted">% DM Ù„Ù„Ø®Ù„Ø·Ø©</span><b id="kpiDmpct">â€”</b></div>
      <div class="kpi"><span class="muted">Ø³Ø¹Ø± ÙƒÙŠÙ„Ùˆ Ø§Ù„Ù„Ø¨Ù†</span>
        <div class="row"><input id="milkPrice" type="number" inputmode="decimal" step="0.01" style="width:120px"><button id="saveMilkPrice" class="btn">Ø­ÙØ¸</button></div>
      </div>
      <div class="kpi"><span class="muted">ØªÙƒÙ„ÙØ© Ø§Ù„ØªØºØ°ÙŠØ©/ÙƒØ¬Ù… Ù„Ø¨Ù†</span><b id="kpiFeedPerKg">â€”</b></div>
      <div class="kpi"><span class="muted">Ù‡Ø§Ù…Ø´ ÙÙˆÙ‚ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù/Ø±Ø£Ø³</span><b id="kpiMargin">â€”</b></div>
      <div class="kpi"><span class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ù„Ø·Ø© asâ€‘fed/Ø±Ø£Ø³</span><b id="kpiAsFedTotal">â€”</b></div>
      <div class="kpi"><span class="muted">% Ø¨Ø±ÙˆØªÙŠÙ† Ø®Ø§Ù… (DM)</span><b id="kpiCPpct">â€”</b></div>
      <div class="kpi"><span class="muted">Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù„ÙŠÙ‚Ø© (Ù…ÙŠØ¬Ø§ Ø¬ÙˆÙ„/ÙŠÙˆÙ…)</span><b id="kpiEnergy">â€”</b></div>
      <div class="kpi"><span class="muted">% Ø¯Ù‡ÙˆÙ† (DM)</span><b id="kpiFatPct">â€”</b></div>
      <div class="kpi"><span class="muted">ÙƒØ¬Ù… DM / ÙƒØ¬Ù… Ù„Ø¨Ù†</span><b id="kpiDMIperKg">â€”</b></div>
      <div class="kpi"><span class="muted">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©/ÙƒØ¬Ù… Ù„Ø¨Ù† (+25%)</span><b id="kpiMilkCostTotal">â€”</b></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="pill">ğŸ¥› Ù…ØªÙˆØ³Ø· Ø¥Ù†ØªØ§Ø¬/Ø±Ø£Ø³: <input id="avgMilk" type="number" inputmode="decimal" step="0.1" style="width:90px"></div>
      <div class="pill" id="afBox" style="display:none">âš–ï¸ ØªÙ‚Ø¯ÙŠØ± ÙƒÙ…ÙŠØ© Ø§Ù„Ø®Ù„Ø·Ø© as-fed/Ø±Ø£Ø³: <input id="asFedKg" type="number" inputmode="decimal" step="0.1" style="width:90px"></div>
      <div class="pill warn" id="msg"></div>
    </div>
  </div>

  <div class="card" id="diagnostics" style="display:none">
    <div class="pill">ğŸ©º Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø°ÙƒÙŠØ©</div>
    <ul id="notes" style="margin:8px 16px"></ul>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="pill">ğŸ“‹ ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø¢Ø®Ø± ØªØ±ÙƒÙŠØ¨Ø© Ù…Ø­ÙÙˆØ¸Ø© â€” Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ø®ÙÙŠØ© Ù‡Ù†Ø§</div>
      <div class="row">
        <button id="gotoEdit" class="btn">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø©</button>
        <button id="gotoEvents" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</button>
        <button id="gotoDash" class="btn">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      </div>
    </div>
  </div>

  <div class="table-wrap"> <!-- Ù…Ø®ÙÙŠ Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ -->
    <table id="tbl">
      <thead><tr>
        <th>Ø§Ù„Ø®Ø§Ù…Ø©</th><th>Ø§Ù„ÙØ¦Ø©</th><th>% DM</th><th>Ø³Ø¹Ø± Ø·Ù† asâ€‘fed</th><th>Ø³Ø¹Ø±/Ø·Ù† DM</th>
        <th>Ùª asâ€‘fed</th><th>ÙƒØ¬Ù… asâ€‘fed/Ø±Ø£Ø³</th><th>ÙƒØ¬Ù… DM/Ø±Ø£Ø³</th><th>ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <div class="row">
      <button class="btn-primary" id="refresh">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
    </div>
  </div>
</div>

<script type="module">
  import { db, auth } from './js/firebase-config.js';
  import { collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

  const qs = new URLSearchParams(location.search);
  const animalId = qs.get('animalId') || qs.get('number') || localStorage.getItem('lastAnimalId') || '';
  const group    = qs.get('group') || '';

  const el = (id)=> document.getElementById(id);
  const nf = (x)=> new Intl.NumberFormat('ar-EG',{maximumFractionDigits:2}).format(x||0);
  const clamp=(v,min,max)=> Math.min(max, Math.max(min, v));
  function bandScore(v, min, goodMin, goodMax, max){
    if (v==null || isNaN(v)) return null;
    if (v<=min || v>=max) return 0;
    if (v>=goodMin && v<=goodMax) return 100;
    if (v<goodMin) return 100 * ( (v - min) / (goodMin - min) );
    return 100 * ( (max - v) / (max - goodMax) );
  }
  function gradeLabel(score){
    if (score==null) return 'â€”';
    if (score>=85) return 'Ù…Ù…ØªØ§Ø² ğŸŸ¢';
    if (score>=70) return 'Ø¬ÙŠØ¯ âœ…';
    if (score>=55) return 'Ù…Ù‚Ø¨ÙˆÙ„ âš ï¸';
    return 'ØºÙŠØ± Ù…ØªØ²Ù† ğŸ”´';
  }
  const qFill = document.getElementById('qFill');
  const qScore= document.getElementById('qScore');
  const qLabel= document.getElementById('qLabel');
  let lastEv = null;

  // Ù‚ÙŠÙ… ØºØ°Ø§Ø¦ÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„ÙƒÙ„ Ø®Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø§ÙØ© (DM)
  // cp: % Ø¨Ø±ÙˆØªÙŠÙ† Ø®Ø§Ù… Ø¹Ù„Ù‰ DMØŒ fat: % Ø¯Ù‡ÙˆÙ† Ø¹Ù„Ù‰ DMØŒ nel: Ø·Ø§Ù‚Ø© Ù„Ø¨Ù†ÙŠØ© ØµØ§ÙÙŠØ© (Ù…ÙŠØ¬Ø§ Ø¬ÙˆÙ„/ÙƒØ¬Ù… DM)
  const NUT = {
    'Ø°Ø±Ø© ØµÙØ±Ø§Ø¡ Ù…Ø¬Ø±ÙˆØ´Ø©':        {cp:9,  fat:4,  nel:8.45},
    'Ø´Ø¹ÙŠØ±':                     {cp:12, fat:2.1,nel:7.95},
    'Ù‚Ù…Ø­ Ù…Ø·Ø­ÙˆÙ†':               {cp:13, fat:1.9,nel:8.55},
    'Ø±Ø¯Ø© Ù‚Ù…Ø­ (Ù†Ø®Ø§Ù„Ø©)':         {cp:16, fat:4,  nel:6.8},
    'Ø±Ø¯Ø© Ø£Ø±Ø²':                  {cp:14, fat:14, nel:7.6},
    'Ø°Ø±Ø© Ø±ÙÙŠØ¹Ø© (Ø³ÙˆØ±Ø¬Ù…)':       {cp:10, fat:3.2,nel:7.9},
    'Ø´ÙˆÙØ§Ù†':                    {cp:12, fat:5,  nel:7.6},
    'ÙÙˆÙ„ Ø¨Ù„Ø¯ÙŠ (ÙØ§Ø¨Ø§)':         {cp:26, fat:1.5,nel:6.8},
    'Ø¨Ø§Ø²Ù„Ø§Ø¡ Ø¹Ù„ÙÙŠØ©':            {cp:23, fat:1.5,nel:7.0},

    'DDGS (Ø°Ø±Ø©)':              {cp:30, fat:10, nel:8.4},
    'Ø¬Ù„ÙˆØªÙŠÙ† ÙÙŠØ¯ (CGF)':        {cp:23, fat:3,  nel:6.9},
    'Ø¬Ù„ÙˆØªÙŠÙ† Ù…ÙŠÙ„ (CGM)':        {cp:60, fat:2,  nel:7.2},
    'Ù‚Ø´ÙˆØ± ÙÙˆÙ„ ØµÙˆÙŠØ§ (Soy Hulls)':{cp:10, fat:2, nel:6.3},
    'Ù„Ø¨ Ø¨Ù†Ø¬Ø± Ù…Ø¬ÙÙ':            {cp:10, fat:0.7,nel:6.4},
    'Ù„Ø¨ Ø¨Ù†Ø¬Ø± Ù…Ø¨Ù„Ù„':            {cp:10, fat:0.7,nel:6.4},
    'Ù„Ø¨ Ø­Ù…Ø¶ÙŠØ§Øª Ù…Ø¬ÙÙ':          {cp:7,  fat:1.6,nel:6.5},
    'Ù…ÙˆÙ„Ø§Ø³':                   {cp:5,  fat:0,  nel:5.4},

    'ÙƒØ³Ø¨ ÙÙˆÙ„ ØµÙˆÙŠØ§ 44%':        {cp:44, fat:1.5,nel:7.0},
    'ÙƒØ³Ø¨ ÙÙˆÙ„ ØµÙˆÙŠØ§ 48%':        {cp:48, fat:1.5,nel:7.2},
    'ÙƒØ³Ø¨ Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø´Ù…Ø³':          {cp:32, fat:1.5,nel:6.0},
    'ÙƒØ³Ø¨ ÙƒØ§Ù†ÙˆÙ„Ø§':              {cp:38, fat:3,  nel:6.6},
    'ÙƒØ³Ø¨ Ù‚Ø·Ù†':                 {cp:24, fat:2,  nel:6.5},
    'ÙƒØ³Ø¨ Ù†Ø®ÙŠÙ„':                {cp:17, fat:8,  nel:6.5},
    'ÙƒØ³Ø¨ ÙÙˆÙ„ Ø³ÙˆØ¯Ø§Ù†ÙŠ':          {cp:45, fat:1,  nel:7.1},
    'ÙƒØ³Ø¨ Ø³Ù…Ø³Ù…':                {cp:38, fat:10, nel:6.8},
    'ÙƒØ³Ø¨ ÙƒØªØ§Ù†':                {cp:33, fat:8,  nel:6.6},

    'Ø¨Ø°Ø±Ø© Ù‚Ø·Ù† ÙƒØ§Ù…Ù„Ø©':         {cp:23, fat:18, nel:7.2},
    'Ù‚Ø´ÙˆØ± Ø¨Ø°Ø±Ø© Ù‚Ø·Ù† (Hulls)':  {cp:4,  fat:2,  nel:4.0},

    'Ø³ÙŠÙ„Ø§Ø¬ Ø°Ø±Ø©':               {cp:8,  fat:3,  nel:6.7},
    'Ø³ÙŠÙ„Ø§Ø¬ Ø³ÙˆØ±Ø¬Ù…':            {cp:7,  fat:2.5,nel:6.0},
    'Ø¨Ø±Ø³ÙŠÙ… Ø£Ø®Ø¶Ø±':              {cp:19, fat:2.5,nel:5.4},
    'Ø¯Ø±ÙŠØ³ Ø¨Ø±Ø³ÙŠÙ…':              {cp:18, fat:2,  nel:4.9},
    'Ø¯Ø±ÙŠØ³ Ø­Ø´ÙŠØ´Ø©/Ù†Ø¬ÙŠÙ„':        {cp:12, fat:2,  nel:4.6},
    'ØªØ¨Ù† Ù‚Ù…Ø­':                 {cp:4,  fat:1.5,nel:3.3},
    'Ù‚Ø´ Ø£Ø±Ø²':                  {cp:4,  fat:1.5,nel:3.0},

    'Ø¯Ù‡ÙˆÙ† Ù…Ø­Ù…ÙŠØ©':              {cp:0,  fat:99, nel:25.0},
    'Ø²ÙŠØª Ù†Ø¨Ø§ØªÙŠ Ø¹Ù„ÙÙŠ':         {cp:0,  fat:99, nel:25.0},
    'ÙŠÙˆØ±ÙŠØ§ Ø¹Ù„ÙÙŠØ©':             {cp:281,fat:0,  nel:0},
    'Ø­Ø¬Ø± Ø¬ÙŠØ±ÙŠ (ÙƒØ§Ù„Ø³ÙŠÙˆÙ…)':     {cp:0,  fat:0,  nel:0},
    'ÙÙˆØ³ÙØ§Øª Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ… (DCP)':{cp:0,fat:0,nel:0},
    'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…':                {cp:0,  fat:0,  nel:0},
    'Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª ØµÙˆØ¯ÙŠÙˆÙ…':       {cp:0,  fat:0,  nel:0},
    'Ø£ÙƒØ³ÙŠØ¯ Ù…Ø§ØºÙ†Ø³ÙŠÙˆÙ…':         {cp:0,  fat:0,  nel:0},
    'Ø¨Ù†ØªÙˆÙ†ÙŠØª':                 {cp:0,  fat:0,  nel:0},
    'Ø®Ù…ÙŠØ±Ø© Ø­ÙŠØ©/Ù…Ø³ØªÙ†Ø¨Øª Ø®Ù…Ø§Ø¦Ø±ÙŠ':{cp:40, fat:1,  nel:5.0},
    'Ù…Ø®Ù„ÙˆØ· Ù…Ø¹Ø§Ø¯Ù†/ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª':  {cp:0,  fat:0,  nel:0},
  };
  function getNut(name, cat){
    const n = NUT[name?.trim?.()] || null;
    if (n) return n;
    // ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ùˆ Ø§Ù„Ø®Ø§Ù…Ø© Ù…Ø´ Ù…Ø¹Ø±Ù‘ÙØ©
    if ((cat||'conc')==='rough') return {cp:12, fat:2, nel:4.8};
    return {cp:16, fat:3, nel:7.5};
  }

  // Header
  el('who').textContent = group || animalId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  el('gotoDash').onclick   = ()=> location.href='dashboard.html';
  el('gotoEvents').onclick = ()=> location.href=`add-event.html?animalId=${encodeURIComponent(animalId||'')}`;
  el('gotoEdit').onclick   = ()=> location.href=`nutrition.html?animalId=${encodeURIComponent(animalId||'')}&return=smart-feeding.html`;

  // Milk price local setting
  const milkPriceInput = el('milkPrice');
  milkPriceInput.value = localStorage.getItem('milkPrice') || '';
  el('saveMilkPrice').onclick = ()=> localStorage.setItem('milkPrice', milkPriceInput.value||'');

  async function fetchLastNutrition(){
    let docs = [];
    async function run(q){ const s=await getDocs(q); s.forEach(d=>docs.push({id:d.id,...d.data()})); }
    // 1) by animal
    if (animalId){
      try{ await run(query(collection(db,'events'), where('animalId','==',String(animalId)), where('eventType','==','ØªØºØ°ÙŠØ©'), orderBy('createdAt','desc'), limit(1))); }catch{}
      if(!docs.length){ try{ await run(query(collection(db,'events'), where('animalId','==',String(animalId)), where('type','==','ØªØºØ°ÙŠØ©'), orderBy('createdAt','desc'), limit(1))); }catch{} }
      if(!docs.length){ try{ await run(query(collection(db,'events'), where('animalId','==',String(animalId)), orderBy('createdAt','desc'), limit(10))); }catch{} docs = docs.filter(x=> x.eventType==='ØªØºØ°ÙŠØ©' || x.type==='ØªØºØ°ÙŠØ©'); docs = docs.slice(0,1); }
    }
    // 2) by group
    if (!docs.length && group){
      try{ await run(query(collection(db,'events'), where('context.group','==',group), where('eventType','==','ØªØºØ°ÙŠØ©'), orderBy('createdAt','desc'), limit(1))); }catch{}
      if(!docs.length){ try{ await run(query(collection(db,'events'), where('eventType','==','ØªØºØ°ÙŠØ©'), orderBy('createdAt','desc'), limit(30))); }catch{} docs = docs.filter(x=> x.context?.group===group); docs = docs.slice(0,1); }
    }
    return docs[0] || null;
  }

  function clearTable(){ el('tbl').querySelector('tbody').innerHTML=''; }
  function addRow(r){
    const tr=document.createElement('tr');
    const pDM = r.dm>0? (r.price/(r.dm/100)) : 0;
    tr.innerHTML = `<td>${r.name||''}</td><td>${r.cat||''}</td><td>${r.dm||''}</td><td>${r.price||''}</td><td>${pDM?nf(pDM):'â€”'}</td>`+
                   `<td>${r.pct||''}</td><td>${r.kg||''}</td><td>${r.kgDM?nf(r.kgDM):'â€”'}</td><td>${r.cost?nf(r.cost):'â€”'}</td>`;
    el('tbl').querySelector('tbody').appendChild(tr);
  }

  function analyze(ev){
    const mode = ev?.nutrition?.mode || ev?.kpis?.mode || 'tmr_asfed';
    const rows = (ev?.nutrition?.rows||[]).map(r=>({...r}));
    el('mode').textContent = mode;
    el('date').textContent = (ev?.eventDate ? new Date(ev.eventDate).toLocaleDateString('ar-EG') : 'â€”');
    el('species').textContent = ev?.context?.species || 'â€”';
    el('dim').textContent = ev?.context?.daysInMilk ?? 'â€”';
    el('dcc').textContent = ev?.context?.pregnancyDays ?? 'â€”';
    el('avgMilk').value = ev?.context?.avgMilkKg ?? '';

    clearTable();

    // helpers
    let totDM=0, totCost=0, roughDM=0, concDM=0, dmFracMix=0, asFedMix=0; let msg='';
    let asFedTotal=0; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ as-fed/Ø±Ø£Ø³
    let cpKg=0, fatKg=0, energyMcal=0; // Ù…Ø¬Ø§Ù…ÙŠØ¹ Ù…ØºØ°ÙŠØ§Øª Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ DM
    const setMsg=(t)=>{ el('msg').textContent=t; };

    if (mode==='tmr_asfed'){
      rows.forEach(r=>{
        const pDM = r.dm>0? (r.price/(r.dm/100)) : 0;
        const kgDM = (r.kg||0)*(r.dm||0)/100; r.kgDM=kgDM;
        const cost = (kgDM/1000)*pDM; r.cost=cost;
        const nut = getNut(r.name, r.cat);
        cpKg   += kgDM * (nut.cp/100);
        fatKg  += kgDM * (nut.fat/100);
        energyMcal += kgDM * (nut.nel);
        asFedTotal += (r.kg||0);
        if ((r.cat||'conc')==='rough') roughDM+=kgDM; else concDM+=kgDM;
        totDM+=kgDM; totCost+=cost; addRow(r);
      });
      // mix price DM
      let mixDM=0; rows.forEach(r=>{ const pDM=r.dm>0? (r.price/(r.dm/100)) : 0; const share = totDM>0? (r.kgDM/totDM):0; mixDM += share*pDM; });
      el('kpiMix').textContent = mixDM? nf(mixDM):'â€”';
      // DM% of mix
      const dmPct = (asFedTotal>0 && totDM>0)? (totDM/asFedTotal*100) : 0;
      el('kpiDmpct').textContent = dmPct? nf(dmPct)+'%':'â€”';
      el('afBox').style.display='none';
    } else if (mode==='tmr_percent'){
      // show percent column; need as-fed total to compute DM/cost
      el('afBox').style.display='inline-flex';
      const totalAf = parseFloat(el('asFedKg').value)||0;
      rows.forEach(r=>{ dmFracMix += (r.pct||0)/100 * (r.dm||0)/100; asFedMix += (r.pct||0)/100 * (r.price||0); });
      const mixPriceDM = dmFracMix>0 ? (asFedMix/dmFracMix) : 0;
      el('kpiMix').textContent = mixPriceDM? nf(mixPriceDM):'â€”';
      el('kpiDmpct').textContent = dmFracMix? nf(dmFracMix*100)+'%':'â€”';
      if (Math.abs(rows.reduce((a,b)=>a+(b.pct||0),0) - 100) > 0.5) setMsg('âš ï¸ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ Ù„Ø§ ÙŠØ³Ø§ÙˆÙŠ 100%');

      if (totalAf>0){
        rows.forEach(r=>{
          const kg = totalAf * (r.pct||0)/100; r.kg = kg;
          const kgDM = kg * (r.dm||0)/100; r.kgDM = kgDM;
          const pDM = r.dm>0? (r.price/(r.dm/100)) : 0; r.cost = (kgDM/1000)*pDM;
          const nut = getNut(r.name, r.cat);
          cpKg   += kgDM * (nut.cp/100);
          fatKg  += kgDM * (nut.fat/100);
          energyMcal += kgDM * (nut.nel);
          asFedTotal += kg;
          if ((r.cat||'conc')==='rough') roughDM+=kgDM; else concDM+=kgDM;
          totDM+=kgDM; totCost+=r.cost; addRow(r);
        });
      } else {
        rows.forEach(r=> addRow(r));
        setMsg('Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© Ø§Ù„Ø®Ù„Ø·Ø© as-fed/Ø±Ø£Ø³ Ù„Ø­Ø³Ø§Ø¨ DM ÙˆØ§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ù‚ÙŠÙ… Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©.');
      }
    } else { // split
      // concentrate block from percents + concKgAf
      const concKgAf = parseFloat(ev?.nutrition?.concKgAf||0) || 0;
      const concRows = rows.filter(r=> (r.cat||'conc')==='conc');
      const roughRows= rows.filter(r=> (r.cat||'conc')==='rough');
      let concDmFrac=0, concAs=0, concCPfrac=0, concFatFrac=0, concNELfrac=0;
      concRows.forEach(r=>{ 
        const dmfr = (r.pct||0)/100 * (r.dm||0)/100; 
        const nut = getNut(r.name, r.cat);
        concDmFrac += dmfr; concAs += (r.pct||0)/100 * (r.price||0);
        concCPfrac  += dmfr * (nut.cp/100);
        concFatFrac += dmfr * (nut.fat/100);
        concNELfrac += dmfr * (nut.nel);
      });
      const concPriceDM = concDmFrac>0? (concAs/concDmFrac) : 0;
      const concKgDM = concKgAf * concDmFrac; const concCost = (concKgDM/1000) * concPriceDM;
      const concCPpct = concDmFrac>0? (concCPfrac/concDmFrac*100) : 0;
      const concFatpct= concDmFrac>0? (concFatFrac/concDmFrac*100) : 0;
      const concNEL   = concDmFrac>0? (concNELfrac/concDmFrac) : 0; // MJ/kg DM
      // accumulate concentrate nutrients
      cpKg   += concKgDM * (concCPpct/100);
      fatKg  += concKgDM * (concFatpct/100);
      energyMcal += concKgDM * concNEL;
      concDM += concKgDM; totCost += concCost; asFedTotal += concKgAf;

      roughRows.forEach(r=>{
        const pDM = r.dm>0? (r.price/(r.dm/100)) : 0;
        const kgDM = (r.kg||0)*(r.dm||0)/100; r.kgDM=kgDM; r.cost=(kgDM/1000)*pDM; 
        const nut = getNut(r.name, r.cat);
        cpKg   += kgDM * (nut.cp/100);
        fatKg  += kgDM * (nut.fat/100);
        energyMcal += kgDM * (nut.nel);
        asFedTotal += (r.kg||0);
        roughDM+=kgDM; totCost+=r.cost; addRow(r);
      });
      // Add a synthetic row for concentrate result
      addRow({ name:'Ù…Ø±ÙƒØ² â€” Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø®Ù„Ø·Ø©', cat:'conc', dm: nf(concDmFrac*100), price: '', pct: 'â€”', kg: nf(concKgAf), kgDM: concKgDM, cost: concCost });
      totDM = roughDM + concDM;
      // mix price DM weighted
      let mixDM=0; const allRows=[...roughRows,{dm:concDmFrac*100, kgDM:concKgDM, price: (concDmFrac>0? (concAs/concDmFrac*(concDmFrac*100/100)):0)}];
      allRows.forEach(r=>{ const pDM=r.dm>0? ((r.price && typeof r.price==='number')? r.price/(r.dm/100) : (concPriceDM)) : 0; const share = totDM>0? (r.kgDM/totDM):0; mixDM += share*pDM; });
      el('kpiMix').textContent = mixDM? nf(mixDM):'â€”';
      el('kpiDmpct').textContent = 'â€”';
    }

    // === Ù…Ø¤Ø´Ø± Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØºØ°ÙŠØ© ===
    const energyPerDM = (totDM>0) ? (energyMcal / totDM) : null; // MJ/kg DM
    const speciesTxt = (ev?.context?.species||'Ø¨Ù‚Ø±');
    const cpBand    = (speciesTxt==='Ø¬Ø§Ù…ÙˆØ³') ? [11,13,16,18] : [12,14,18,20]; // [min,goodMin,goodMax,max] %
    const roughBand = [35,40,60,70];
    const fatBand   = [2,3,6,8];
    const enBand    = [5.5,6.2,7.2,8.0];
    const milkKgQ   = parseFloat(el('avgMilk').value)||0;
    const dmiPerKg  = (milkKgQ>0 && totDM>0) ? (totDM/milkKgQ) : null;
    const effBand   = [0.7,0.8,1.0,1.3];

    const roughPct = (totDM>0)? (roughDM/totDM*100):null;
    const cpPctVal = (totDM>0)? (cpKg/totDM*100):null;
    const fatPctVal= (totDM>0)? (fatKg/totDM*100):null;

    let scores=[]; 
    const sRough = bandScore(roughPct, ...roughBand); if (sRough!=null) scores.push({w:0.25,s:sRough});
    const sCP    = bandScore(cpPctVal, ...cpBand);   if (sCP   !=null) scores.push({w:0.25,s:sCP});
    const sEn    = bandScore(energyPerDM, ...enBand);if (sEn   !=null) scores.push({w:0.25,s:sEn});
    const sFat   = bandScore(fatPctVal, ...fatBand); if (sFat  !=null) scores.push({w:0.10,s:sFat});
    const sEff   = bandScore(dmiPerKg, ...effBand);  if (sEff  !=null) scores.push({w:0.15,s:sEff});

    const wsum = scores.reduce((a,b)=>a+b.w,0);
    let q = (wsum>0)? (scores.reduce((a,b)=> a + b.w*b.s, 0) / wsum) : null;
    if (q!=null){ q = Math.round(q); qFill.style.width = q+'%'; qScore.textContent = q.toString(); qLabel.textContent = gradeLabel(q); }
    else { qFill.style.width='0%'; qScore.textContent='â€”'; qLabel.textContent='â€”'; }

    // KPIs
    el('kpiDM').textContent   = totDM? nf(totDM):'â€”';
    el('kpiCost').textContent = (totCost||totCost===0)? nf(totCost):'â€”';
    const fPct = totDM>0? (roughDM/totDM*100):0, cPct=100-fPct; el('kpiFC').textContent = (totDM>0? `${nf(fPct)}% : ${nf(cPct)}%` : 'â€”');

    el('kpiAsFedTotal').textContent = asFedTotal? nf(asFedTotal):'â€”';
    const cpPct = totDM>0? (cpKg/totDM*100) : 0; el('kpiCPpct').textContent = cpPct? nf(cpPct)+'%':'â€”';
    const fatPct= totDM>0? (fatKg/totDM*100): 0; el('kpiFatPct').textContent= fatPct? nf(fatPct)+'%':'â€”';
    el('kpiEnergy').textContent = energyMcal? nf(energyMcal):'â€”';

    const milkKg = parseFloat(el('avgMilk').value)||0; const milkPrice = parseFloat(milkPriceInput.value)||0;
    if (milkKg>0){
      const feedPerKg = totCost>0? (totCost/milkKg) : 0; el('kpiFeedPerKg').textContent = nf(feedPerKg);
      const dmiPerKg  = totDM>0? (totDM/milkKg) : 0; el('kpiDMIperKg').textContent = dmiPerKg? nf(dmiPerKg):'â€”';
      const milkCostTotal = feedPerKg * 1.25; el('kpiMilkCostTotal').textContent = nf(milkCostTotal);
      if (milkPrice>0){ const margin = milkKg*milkPrice - totCost; el('kpiMargin').textContent = nf(margin); } else el('kpiMargin').textContent='â€”';
    } else {
      el('kpiFeedPerKg').textContent='â€”';
      el('kpiMargin').textContent='â€”';
      el('kpiDMIperKg').textContent='â€”';
      el('kpiMilkCostTotal').textContent='â€”';
    }

    // Diagnostics (Ø¨Ø³ÙŠØ·Ø© ÙƒØ¨Ø¯Ø§ÙŠØ©)
    const notes=[]; const species = (ev?.context?.species||'Ø¨Ù‚Ø±');
    if (mode!=='tmr_percent' && totDM>0){
      if (fPct<40) notes.push('Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø´Ù†Ø© Ù…Ù†Ø®ÙØ¶Ø© (<40% DM).');
      if (species==='Ø¨Ù‚Ø±' && (milkKg>0 && (totDM/milkKg)<0.8)) notes.push('Ù…Ø¯Ø®ÙˆÙ„ DM/Ø¥Ù†ØªØ§Ø¬ Ù…Ù†Ø®ÙØ¶ â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø§Ù‚Ø©/Ø§Ù„Ø£Ù„ÙŠØ§Ù.');
    }
    const box = el('diagnostics'); const ul=el('notes');
    if (notes.length){ box.style.display='block'; ul.innerHTML=''; notes.forEach(n=>{ const li=document.createElement('li'); li.textContent=n; ul.appendChild(li); }); }
    else { box.style.display='none'; ul.innerHTML=''; }
  }

  async function refresh(){
    el('msg').textContent=''; clearTable();
    const ev = await fetchLastNutrition();
    if (!ev){ el('msg').textContent='Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¯Ø« ØªØºØ°ÙŠØ© Ù…Ø­ÙÙˆØ¸ Ø¨Ø¹Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯Ù.'; return; }
    lastEv = ev;
    analyze(ev);
  }

  el('refresh').onclick = refresh;
  el('avgMilk').addEventListener('input', ()=> lastEv? analyze(lastEv):refresh());
  el('milkPrice').addEventListener('input', ()=> lastEv? analyze(lastEv):refresh());
  el('asFedKg').addEventListener('input', ()=> lastEv? analyze(lastEv):refresh());

 function boot(){
  const hasLS = !!localStorage.getItem('userId'); // Ø¬Ù„Ø³Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§

  if (auth && typeof onAuthStateChanged === 'function') {
    onAuthStateChanged(auth, (user) => {
      if (user || hasLS) {
        refresh();
      } else {
        location.href = 'login.html';
      }
    });
  } else {
    // ÙÙŠ Ø­Ø§Ù„ Ù…Ø§ ÙÙŠØ´ Firebase Auth Ø£ØµÙ„Ø§Ù‹
    if (hasLS) { 
      refresh(); 
    } else { 
      location.href = 'login.html'; 
    }
  }
}
boot();

</script>
</body>
</html>
