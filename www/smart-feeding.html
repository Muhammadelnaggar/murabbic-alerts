<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ุงูุชุบุฐูุฉ ุงูุฐููุฉ (ูุงุฏุฉ ุฌุงูุฉ)</title>
  <style>
    :root{--bg:#fff9db;--card:#f1f8e9;--border:#c5e1a5;--green:#2e7d32;--muted:#5f6f64}
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;color:#1b5e20;padding:12px}
    h1{margin:0 0 8px;text-align:center;color:var(--green);font-size:22px}
    .wrap{max-width:1080px;margin:0 auto}
    .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#dcedc8;color:#1b5e20;font-size:13px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row>.grow{flex:1}
    select,input,button{font-size:14px}
    input,select{padding:10px;border:1px solid #ccc;border-radius:10px}
    input,select,button{min-height:44px}
    button{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:bold;cursor:pointer}
    .btn{background:#fff;border:1px solid var(--green);color:var(--green)}
    .btn-primary{background:var(--green);color:#fff}

    .table-wrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:collapse;margin-top:10px;min-width:1060px}
    th,td{border:1px solid #e0ebd3;padding:8px;text-align:center}
    th{background:#eafbe7;color:#1b5e20}
    tbody tr:nth-child(odd){background:#fcfff5}

    .total{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
    .total .pill{background:#fff}

    .muted{color:var(--muted);font-size:12px}

    /* ===== Mobile-first: ุจุทุงูุงุช ุจุฏู ุงูุฌุฏูู ุนูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ ===== */
    @media (max-width: 640px){
      .bar{justify-content:stretch}
      .row.stack > *{flex:1 1 100%}
      .table-wrap{overflow:visible}
      table, thead, tbody, th, td, tr{display:block;min-width:unset}
      thead{display:none}
      tbody tr{margin:0 0 12px 0;border:1px solid #e0ebd3;border-radius:12px;background:#fff}
      tbody tr > td{display:flex;justify-content:space-between;align-items:center;border:0;border-bottom:1px solid #eef3e4;padding:10px 12px}
      tbody tr > td:last-child{border-bottom:0}
      td::before{content:attr(data-label);font-weight:bold;color:#2e7d32;flex:0 0 48%}
      td > input, td > select{width:48%}
      .total{justify-content:center}
      .pill{font-size:12px}
      h1{font-size:20px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ุงูุชุบุฐูุฉ ุงูุฐููุฉ โ ุญุณุงุจ ุงููุงุฏุฉ ุงูุฌุงูุฉ</h1>
  <div class="bar">
    <span class="pill">๐ ุงูููู: <span id="today">โ</span></span>
    <span class="pill">๐ผ ุณุนุฑ ุงููุจู:
      <input id="milkPriceTop" type="number" inputmode="decimal" step="0.01" placeholder="ุฌููู/ูุชุฑ" style="width:110px;border:1px solid #8bc34a;border-radius:8px;padding:6px;background:#fff">
    </span>
    <span class="pill">๐ฐ ุงูุนููุฉ: <b id="currency">ุฌููู/ุทู</b></span>
    <span class="pill">๐ ูุตุฏุฑ ุงูุฃุณุนุงุฑ: ูุฏูู / ุนุงููู<span id="srcHint" class="muted"></span></span>
  </div>

  <div class="card">
    <div class="row stack">
      <div class="grow">
        <label class="muted">ุทุฑููุฉ ุงูุฅุฏุฎุงู</label>
       <select id="mode" style="width:100%">
  <option value="tmr_asfed" selected>ุฎูุทุฉ ูุงููุฉ TMR โ as-fed/ุฑุฃุณ</option>
  <option value="tmr_percent">ุฎูุทุฉ ูุงููุฉ TMR โ ูุณุจ as-fed ููุทู</option>
  <option value="split">ูุฑูุฒุงุช ูุฎุดู โ ูููุตู</option>
</select>

      </div>
      <div class="grow">
        <label class="muted">ุฅุถุงูุฉ ุฎุงูุฉ ุฌุงูุฒุฉ</label>
        <select id="preset" style="width:100%">
          <option value="">โ ุงุฎุชุฑ โ</option>
        </select>
      </div>
      <button id="addPreset" class="btn" style="flex:1">ุฅุถุงูุฉ</button>
      <button id="fetchGlobal" class="btn" style="flex:1">ุชุญุฏูุซ ุงูุฃุณุนุงุฑ ูู ุงูุณูู ุงูุนุงููู</button>
      <button id="saveLocal" class="btn" style="flex:1">ุญูุธ ูุญูููุง</button>
      <button id="clearAll" class="btn" style="flex:1">ูุณุญ</button>
    </div>

    <!-- ูุฏุฎูุงุช ุฅุถุงููุฉ ููุถุน ุงููุตู ุจูู ุงูุฎุดู ูุงููุฑูุฒ -->
    <div id="splitBox" class="row stack" style="margin-top:8px;display:none">
      <div class="grow">
        <label class="muted">ูููุฉ ุงูุนูู ุงููุฑูุฒ (asโfed) ูุฌู/ุฑุฃุณ/ููู</label>
        <input id="concKgInput" type="number" inputmode="decimal" step="0.01" placeholder="ูุซุงู: 6.0" style="width:160px">
      </div>
      <div class="pill" id="splitHint">ูู ูุฐุง ุงููุถุน: ูู ุตู ูู "ูุฆุฉ" = ุฎุดู ุฃู ูุฑูุฒ. ุงูุฎุดู ููุญุณุจ ุจุงููุฌู/ุฑุฃุณุ ูุงููุฑูุฒ ููุจูู ููู ุณุนุฑ ุทู ูุฑูุฒ (asโfedโDM) ุซู ููุทุจููู ุนูู ูููุฉ ุงููุฑูุฒ ุงููุฏุฎูุฉ.</div>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th data-col="name">ุงูุฎุงูุฉ (ุนุงููุฉ ูุฑุจูู)</th>
            <th data-col="cat">ุงููุฆุฉ</th>
            <th data-col="dm">% ูุงุฏุฉ ุฌุงูุฉ</th>
            <th data-col="pTon">ุณุนุฑ ุงูุทู (ููุง ูู)</th>
            <th data-col="pTonDM">ุณุนุฑ/ุทู ูุงุฏุฉ ุฌุงูุฉ</th>
            <th data-col="pct">ูุณุจุฉ asโfed %</th>
            <th data-col="kg">ูููุฉ asโfed ูุฌู/ุฑุฃุณ/ููู</th>
            <th data-col="kgDM">ูุฌู ูุงุฏุฉ ุฌุงูุฉ/ุฑุฃุณ</th>
            <th data-col="cost">ุชูููุฉ/ุฑุฃุณ/ููู</th>
            <th data-col="src">ุงููุตุฏุฑ</th>
            <th data-col="rm">ุญุฐู</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="total" id="totalsBase">
      <span class="pill" id="pillSumPct" style="display:none">ูุฌููุน ุงููููุณุจ: <b id="sumPct">0%</b></span>
      <span class="pill">ุฅุฌูุงูู ูุฌู ูุงุฏุฉ ุฌุงูุฉ/ุฑุฃุณ: <b id="totDM">0</b></span>
      <span class="pill">ุชูููุฉ ุงูุนูููุฉ/ุฑุฃุณ/ููู: <b id="totCost">0</b></span>
      <span class="pill" id="pillMix">ุณุนุฑ ุทู ุงูุนูู (ูุงุฏุฉ ุฌุงูุฉ): <b id="mixPriceDM">โ</b></span>
    </div>

    <!-- ุฅุฌูุงููุงุช ุฅุถุงููุฉ ุชุธูุฑ ููุท ูู ูุถุน ุงููุตู -->
    <div class="total" id="totalsSplit" style="display:none">
      <span class="pill">ุฎุดู โ ูุฌู DM/ุฑุฃุณ: <b id="roughDM">โ</b></span>
      <span class="pill">ุฎุดู โ ุชูููุฉ/ุฑุฃุณ: <b id="roughCost">โ</b></span>
      <span class="pill">ูุฑูุฒ โ ูุฌููุน ุงููููุณุจ: <b id="sumPctConc">โ%</b></span>
      <span class="pill">ูุฑูุฒ โ %DM ููุฎูุทุฉ: <b id="concDMpct">โ%</b></span>
      <span class="pill">ูุฑูุฒ โ ุณุนุฑ ุทู (DM): <b id="concPriceDM">โ</b></span>
      <span class="pill">ูุฑูุฒ โ ูููุฉ asโfed/ุฑุฃุณ: <b id="concKgShow">โ</b></span>
      <span class="pill">ูุฑูุฒ โ ูุฌู DM/ุฑุฃุณ: <b id="concKgDM">โ</b></span>
      <span class="pill">ูุฑูุฒ โ ุชูููุฉ/ุฑุฃุณ: <b id="concCost">โ</b></span>
      <span class="pill">ุงูุฅุฌูุงูู โ ุชูููุฉ/ุฑุฃุณ: <b id="totalCostAll">โ</b></span>
    </div>

    <div class="muted" style="margin-top:6px">* ูู ูุถุน ุงููููุณุจ asโfedุ ูุชู ุญุณุงุจ **ุณุนุฑ ุทู ุงูุนูู (ูุงุฏุฉ ุฌุงูุฉ)** = ูุชูุณุท ุณุนุฑ ุงูุทู ููุง ูู รท ูุณุจุฉ ุงููDM ุงููููุฉ ููุฎููุท.</div>
  </div>

  <div class="card">
    <div class="row stack">
      <div class="grow">
        <label class="muted">ุฅุนุฏุงุฏุงุช ุงูุงูุชุตุงุฏ ุงูุณุฑูุนุฉ (ููุฏashboard)</label>
        <div class="row stack">
          <label class="muted">ุณุนุฑ ุงููุชุฑ (ุฌููู): <input id="econPrice" type="number" inputmode="decimal" step="0.01" style="width:140px"></label>
          <label class="muted">ุชูููุฉ ุนูู/ุจูุฑุฉ/ููู: <input id="econFeed" type="number" inputmode="decimal" step="0.01" style="width:160px"></label>
          <label class="muted">ุญุฌู ุงููุทูุน: <input id="econHerd" type="number" inputmode="numeric" step="1" style="width:120px"></label>
          <button id="saveEcon" class="btn" style="width:160px">ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // ===== ุจูุงูุงุช ุงูุฎุงูุงุช (ุนุงููุฉ ูุฑุจูู) + DM% ุงูุชุฑุงุถู + ุฑูุฒ ุณููู ูุณุชูุจูู =====
  const FEEDS = [
    { name:'ุฐุฑุฉ ุตูุฑุงุก ูุฌุฑูุดุฉ', dm:88, symbol:'CORN' },
    { name:'ุดุนูุฑ', dm:88, symbol:'BARLEY' },
    { name:'ููุญ ูุทุญูู', dm:88, symbol:'WHEAT' },
    { name:'ุฑุฏุฉ ููุญ (ูุฎุงูุฉ)', dm:89, symbol:'WHEAT_BRAN' },
    { name:'ูุณุจ ููู ุตููุง 44%', dm:89, symbol:'SOYMEAL_44' },
    { name:'ูุณุจ ููู ุตููุง 48%', dm:89, symbol:'SOYMEAL_48' },
    { name:'ูุณุจ ุนุจุงุฏ ุงูุดูุณ', dm:89, symbol:'SUNFLOWER_MEAL' },
    { name:'ูุณุจ ูุงูููุง', dm:90, symbol:'CANOLA_MEAL' },
    { name:'DDGS (ุฐุฑุฉ)', dm:90, symbol:'DDGS' },
    { name:'ุฌููุชูู ููุฏ (CGF)', dm:90, symbol:'CORN_GLUTEN_FEED' },
    { name:'ุฌููุชูู ููู (CGM)', dm:90, symbol:'CORN_GLUTEN_MEAL' },
    { name:'ูุจ ุจูุฌุฑ ูุฌูู', dm:90, symbol:'BEET_PULP_DRY' },
    { name:'ูุจ ุจูุฌุฑ ูุจูู', dm:25, symbol:'BEET_PULP_WET' },
    { name:'ูููุงุณ', dm:75, symbol:'MOLASSES' },
    { name:'ุณููุงุฌ ุฐุฑุฉ', dm:33, symbol:'CORN_SILAGE' },
    { name:'ุจุฑุณูู ุฃุฎุถุฑ', dm:18, symbol:'FRESH_BERSEEM' },
    { name:'ุฏุฑูุณ ุจุฑุณูู', dm:90, symbol:'ALFALFA_HAY' },
    { name:'ูุด ุฃุฑุฒ', dm:90, symbol:'RICE_STRAW' },
    { name:'ุชุจู ููุญ/ุดุนูุฑ', dm:90, symbol:'WHEAT_STRAW' },
    { name:'ุจุฐุฑุฉ ูุทู ูุงููุฉ', dm:92, symbol:'WHOLE_COTTONSEED' },
    { name:'ูุณุจ ูุทู', dm:92, symbol:'COTTONSEED_MEAL' },
    { name:'ูุณุจ ูุฎูู', dm:90, symbol:'PALM_KERNEL_MEAL' },
    { name:'ุฐุฑุฉ ุฑููุนุฉ (ุณูุฑุฌู)', dm:88, symbol:'SORGHUM' },
    { name:'ุดููุงู', dm:90, symbol:'OATS' },
    { name:'ููู ุจูุฏู (ูุงุจุง)', dm:88, symbol:'FABA_BEANS' },
    { name:'ุจุงุฒูุงุก ุนูููุฉ', dm:88, symbol:'FIELD_PEAS' },
    { name:'ุฏููู ูุญููุฉ', dm:99, symbol:'PROTECTED_FAT' },
    { name:'ููุฑูุง ุนูููุฉ', dm:100, symbol:'UREA' },
    { name:'ุจููุฑุจููุงุช ุตูุฏููู', dm:100, symbol:'SODIUM_BICARB' },
    { name:'ููุญ', dm:100, symbol:'SALT' },
    { name:'ุญุฌุฑ ุฌูุฑู (ูุงูุณููู)', dm:100, symbol:'LIMESTONE' },
    { name:'ูุฎููุท ูุนุงุฏู/ููุชุงูููุงุช', dm:95, symbol:'VIT_MIN_PREMIX' },
  ];

  // ููุงุฆู ูุชุฎููู ุงููุฆุฉ ุชููุงุฆููุง
  const ROUGH_HINTS = ['ุณููุงุฌ','ุจุฑุณูู','ุฏุฑูุณ','ูุด','ุชุจู','benjer','ุจูุฌุฑ','pulp','hay','silage','straw','fresh','green'];

  // ===== ุนูุงุตุฑ ูุงุฌูุฉ
  const todayEl = document.getElementById('today');
  const currencyEl = document.getElementById('currency');
  const presetSel = document.getElementById('preset');
  const addPresetBtn = document.getElementById('addPreset');
  const fetchBtn = document.getElementById('fetchGlobal');
  const saveBtn = document.getElementById('saveLocal');
  const clearBtn= document.getElementById('clearAll');
  const tbody = document.querySelector('#tbl tbody');
  const totDM = document.getElementById('totDM');
  const totCost = document.getElementById('totCost');
  const mixPriceDM = document.getElementById('mixPriceDM');
  const pillSumPct = document.getElementById('pillSumPct');
  const sumPctEl = document.getElementById('sumPct');
  const modeSel = document.getElementById('mode');
  const splitBox = document.getElementById('splitBox');

  // ุฅุฌูุงููุงุช ูุถุน ุงููุตู
  const totalsBase = document.getElementById('totalsBase');
  const totalsSplit= document.getElementById('totalsSplit');
  const roughDMEl  = document.getElementById('roughDM');
  const roughCostEl= document.getElementById('roughCost');
  const sumPctConcEl = document.getElementById('sumPctConc');
  const concDMpctEl  = document.getElementById('concDMpct');
  const concPriceDMEl= document.getElementById('concPriceDM');
  const concKgShowEl = document.getElementById('concKgShow');
  const concKgDMEl   = document.getElementById('concKgDM');
  const concCostEl   = document.getElementById('concCost');
  const totalCostAllEl = document.getElementById('totalCostAll');
  const concKgInput = document.getElementById('concKgInput');

  // Econ quick settings (for dashboard) + ูุฒุงููุฉ ุณุนุฑ ุงููุจู ุฃุนูู ุงูุตูุญุฉ
  const econPrice = document.getElementById('econPrice');
  const econFeed  = document.getElementById('econFeed');
  const econHerd  = document.getElementById('econHerd');
  const milkTop   = document.getElementById('milkPriceTop');

  function syncMilkInputs(fromTop){
    if (fromTop){
      econPrice.value = milkTop.value;
    }else{
      milkTop.value = econPrice.value;
    }
    localStorage.setItem('econPrice', (milkTop.value||econPrice.value||'0'));
  }

  document.getElementById('saveEcon').onclick = ()=>{
    localStorage.setItem('econPrice', econPrice.value||'0');
    localStorage.setItem('econFeed',  econFeed.value||'0');
    localStorage.setItem('econHerd',  econHerd.value||'0');
    milkTop.value = econPrice.value||'';
    alert('โ๏ธ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุงูุชุตุงุฏ');
  };
  econPrice.value = localStorage.getItem('econPrice')||'';
  milkTop.value   = econPrice.value;
  econFeed.value  = localStorage.getItem('econFeed')||'';
  econHerd.value  = localStorage.getItem('econHerd')||'';
  milkTop.addEventListener('input', ()=> syncMilkInputs(true));
  econPrice.addEventListener('input', ()=> syncMilkInputs(false));

  // ุงูููู ุงููุญูู
  const todayLocal = ()=>{ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };
  try{ todayEl.textContent = new Date(todayLocal()).toLocaleDateString('ar-EG'); }catch{ todayEl.textContent = todayLocal(); }

  // ุชููุฆุฉ ูุงุฆูุฉ ุงูุฎุงูุงุช ุงูุฌุงูุฒุฉ
  FEEDS.forEach((f,i)=>{
    const opt = document.createElement('option'); opt.value = String(i); opt.textContent = f.name; presetSel.appendChild(opt);
  });

  // ุชุญููู ูู ุงูุชุฎุฒูู ุงููุญูู
  let rows = [];
  try{ rows = JSON.parse(localStorage.getItem('rationRows')||'[]'); }catch{ rows=[]; }

  function td(label, inner, col){ const td=document.createElement('td'); if(col) td.dataset.col = col; td.setAttribute('data-label', label); td.innerHTML=inner; return td; }

  function guessCat(name){
    const s = (name||'').toLowerCase();
    return ROUGH_HINTS.some(k=> s.includes(k) ) ? 'rough' : 'conc';
  }

  function addRow(feed){
    const tr = document.createElement('tr');
    const catVal = feed?.cat || guessCat(feed?.name);
    tr.appendChild(td('ุงูุฎุงูุฉ', `<input class="name" value="${feed?.name||''}" list="feedlist" placeholder="ุงูุชุจ ุงุณู ุงูุฎุงูุฉ" style="width:200px">`, 'name'));
    tr.appendChild(td('ุงููุฆุฉ', `<select class="cat"><option value="rough" ${catVal==='rough'?'selected':''}>ุฎุดู</option><option value="conc" ${catVal==='conc'?'selected':''}>ูุฑูุฒ</option></select>`, 'cat'));
    tr.appendChild(td('% ูุงุฏุฉ ุฌุงูุฉ', `<input class="dm" type="number" inputmode="decimal" step="0.1" value="${feed?.dm ?? ''}" placeholder="%" style="width:100px">`, 'dm'));
    tr.appendChild(td('ุณุนุฑ ุงูุทู', `<input class="pTon" type="number" inputmode="decimal" step="0.01" value="${feed?.price||''}" placeholder="ุฌููู/ุทู" style="width:140px">`, 'pTon'));
    tr.appendChild(td('ุณุนุฑ/ุทู ูุงุฏุฉ ุฌุงูุฉ', `<span class="pTonDM">โ</span>`, 'pTonDM'));
    tr.appendChild(td('ูุณุจุฉ asโfed %', `<input class="pct" type="number" inputmode="decimal" step="0.01" value="${feed?.pct||''}" placeholder="%" style="width:100px">`, 'pct'));
    tr.appendChild(td('ูููุฉ as-fed', `<input class="kg" type="number" inputmode="decimal" step="0.01" value="${feed?.kg||''}" placeholder="ูุฌู" style="width:120px">`, 'kg'));
    tr.appendChild(td('ูุฌู DM/ุฑุฃุณ', `<span class="kgDM">โ</span>`, 'kgDM'));
    tr.appendChild(td('ุชูููุฉ/ุฑุฃุณ/ููู', `<span class="cost">โ</span>`, 'cost'));
    tr.appendChild(td('ุงููุตุฏุฑ', `<span class="src">${feed?.src||'ูุฏูู'}</span>`, 'src'));
    tr.appendChild(td('ุญุฐู', `<button class="rm btn" aria-label="ุญุฐู ุงูุณุทุฑ">ร</button>`, 'rm'));
    tbody.appendChild(tr);
    hookRow(tr, feed);
  }

  // datalist ููุงูุชุฑุงุญุงุช
  const dl = document.createElement('datalist'); dl.id = 'feedlist';
  FEEDS.forEach(f=>{ const o=document.createElement('option'); o.value=f.name; dl.appendChild(o); });
  document.body.appendChild(dl);

  function recalc(){
    const mode = modeSel.value; // 'asfed' | 'percent' | 'split'
    let totalDM=0, totalCost=0, mix=0, sumPct=0, mixAsFed=0, dmFrac=0;
    let roughDM=0, roughCost=0; // split
    let concMixAsFed=0, concDmFrac=0, concSumPct=0; // split
    const concKg = parseFloat(concKgInput.value)||0; // split

    const items = [];

    tbody.querySelectorAll('tr').forEach(tr=>{
      const name = tr.querySelector('.name').value.trim();
      const cat  = (tr.querySelector('.cat')?.value)||'conc';
      const dm   = parseFloat(tr.querySelector('.dm').value)||0; // %
      const pTon = parseFloat(tr.querySelector('.pTon').value)||0; // as-fed
      const kg   = parseFloat(tr.querySelector('.kg').value)||0; // as-fed kg/head/day
      const pct  = parseFloat(tr.querySelector('.pct').value)||0; // % of as-fed
      const pTonDM = (dm>0? (pTon / (dm/100)) : 0);
      tr.querySelector('.pTonDM').textContent = pTonDM? nf(pTonDM):'โ';

      if (mode === 'asfed'){
        const kgDM   = kg * (dm/100);
        const cost   = (kgDM/1000) * pTonDM; // kgDM -> tonDM
        tr.querySelector('.kgDM').textContent   = kgDM? nf(kgDM):'โ';
        tr.querySelector('.cost').textContent   = cost? nf(cost):'โ';
        totalDM  += kgDM;
        totalCost+= cost;
      } else if (mode === 'percent'){
        tr.querySelector('.kgDM').textContent = 'โ';
        tr.querySelector('.cost').textContent = 'โ';
        if (pct>0){
          mixAsFed += (pct/100) * pTon;      // ูุชูุณุท ุณุนุฑ ุงูุทู ููุง ูู
          dmFrac  += (pct/100) * (dm/100);   // ูุณุจุฉ DM ุงููููุฉ ูู ุทู as-fed
          sumPct  += pct;
        }
      } else { // split
        if (cat==='rough'){
          const kgDM   = kg * (dm/100);
          const cost   = (kgDM/1000) * pTonDM;
          tr.querySelector('.kgDM').textContent   = kgDM? nf(kgDM):'โ';
          tr.querySelector('.cost').textContent   = cost? nf(cost):'โ';
          roughDM  += kgDM;
          roughCost+= cost;
        } else { // conc
          tr.querySelector('.kgDM').textContent = 'โ';
          tr.querySelector('.cost').textContent = 'โ';
          if (pct>0){
            concMixAsFed += (pct/100) * pTon;
            concDmFrac   += (pct/100) * (dm/100);
            concSumPct   += pct;
          }
        }
      }

      items.push({ name, cat, dm, price:pTon, kg, pct, src: tr.querySelector('.src').textContent||'ูุฏูู' });
    });

    if (mode === 'asfed'){
      totDM.textContent   = nf(totalDM);
      totCost.textContent = nf(totalCost);
      // ุญุณุงุจ ุณุนุฑ ุทู DM ููุฎูุทุฉ ูู ูุณุงููุงุช DM
      if (totalDM>0){
        mix = 0;
        tbody.querySelectorAll('tr').forEach(tr=>{
          const dm=parseFloat(tr.querySelector('.dm').value)||0;
          const pTon=parseFloat(tr.querySelector('.pTon').value)||0;
          const kg=parseFloat(tr.querySelector('.kg').value)||0;
          const pTonDM = (dm>0? (pTon/(dm/100)) : 0);
          const share  = (kg*(dm/100)) / totalDM; // DM share
          mix += share * pTonDM;
        });
      }
      pillSumPct.style.display = 'none';
      document.getElementById('pillMix').style.display = '';
      totalsSplit.style.display = 'none';
    } else if (mode === 'percent'){
      totDM.textContent   = 'โ';
      totCost.textContent = 'โ';
      sumPctEl.textContent = nf(sumPct) + '%';
      pillSumPct.style.display = 'inline-flex';
      mix = dmFrac>0 ? (mixAsFed / dmFrac) : 0; // ุชุญููู ูุชูุณุท ุงูุณุนุฑ ููุง ูู ุฅูู ุณุนุฑ/ุทู DM
      document.getElementById('pillMix').style.display = '';
      totalsSplit.style.display = 'none';
    } else { // split
      // ุงุญุณุจ ุณุนุฑ ุทู ุงููุฑูุฒ DM
      const concPriceDM = (concDmFrac>0) ? (concMixAsFed / concDmFrac) : 0;
      const concKgDM    = concKg * concDmFrac;
      const concCost    = (concKgDM/1000) * concPriceDM;

      const totalDMAll  = roughDM + concKgDM;
      const totalCostAll= roughCost + concCost;

      // ุงุนุฑุถ ุงูููู
      roughDMEl.textContent   = nf(roughDM);
      roughCostEl.textContent = nf(roughCost);
      sumPctConcEl.textContent= nf(concSumPct) + '%';
      concDMpctEl.textContent = nf(concDmFrac*100) + '%';
      concPriceDMEl.textContent = concPriceDM ? nf(concPriceDM) : 'โ';
      concKgShowEl.textContent  = concKg ? nf(concKg) : 'โ';
      concKgDMEl.textContent    = concKgDM ? nf(concKgDM) : 'โ';
      concCostEl.textContent    = concCost ? nf(concCost) : 'โ';
      totalCostAllEl.textContent= (totalCostAll || totalCostAll===0) ? nf(totalCostAll) : 'โ';

      totDM.textContent   = totalDMAll ? nf(totalDMAll) : 'โ';
      totCost.textContent = totalCostAll ? nf(totalCostAll) : 'โ';

      // ุฅุธูุงุฑ/ุฅุฎูุงุก ุนูุงุตุฑ
      pillSumPct.style.display = 'none';
      document.getElementById('pillMix').style.display = 'none';
      totalsSplit.style.display = 'flex';
    }

    mixPriceDM.textContent = mix? nf(mix):'โ';
    localStorage.setItem('rationRows', JSON.stringify(items));
  }

  const nf = (x)=> new Intl.NumberFormat('ar-EG',{maximumFractionDigits:2}).format(x||0);

  function setSplitRowState(tr){
    const mode = modeSel.value;
    const cat  = (tr.querySelector('.cat')?.value)||'conc';
    const kgEl  = tr.querySelector('.kg');
    const pctEl = tr.querySelector('.pct');
    if (mode!== 'split'){
      kgEl.disabled = (mode==='percent');
      pctEl.disabled= (mode==='asfed');
      kgEl.style.opacity  = kgEl.disabled? .5 : 1;
      pctEl.style.opacity = pctEl.disabled? .5 : 1;
      return;
    }
    if (cat==='rough'){
      kgEl.disabled = false; pctEl.disabled = true;
    } else {
      kgEl.disabled = true;  pctEl.disabled = false;
    }
    kgEl.style.opacity  = kgEl.disabled? .5 : 1;
    pctEl.style.opacity = pctEl.disabled? .5 : 1;
  }

  function hookRow(tr, feed){
    const nameEl = tr.querySelector('.name');
    const dmEl   = tr.querySelector('.dm');
    const pEl    = tr.querySelector('.pTon');
    const kgEl   = tr.querySelector('.kg');
    const pctEl  = tr.querySelector('.pct');
    const catEl  = tr.querySelector('.cat');
    tr.querySelector('.rm').onclick = ()=>{ tr.remove(); recalc(); };

    // ูู ูุชุจ ุงุณู ุฎุงูุฉ ููุฌูุฏุฉุ ุนุจูู DM ุชููุงุฆููุง ูุชุฎููู ุงููุฆุฉ
    nameEl.addEventListener('change', ()=>{
      const f = FEEDS.find(x=>x.name===nameEl.value.trim());
      if (f && !dmEl.value){ dmEl.value = f.dm; tr.querySelector('.src').textContent = 'ูุฏูู'; }
      if (!catEl.value){ catEl.value = guessCat(nameEl.value); }
      setSplitRowState(tr);
      recalc();
    });
    ;[dmEl,pEl,kgEl,pctEl,catEl].forEach(el=> el.addEventListener('input', ()=>{ setSplitRowState(tr); recalc(); }));

    setSplitRowState(tr);
  }

  function updateModeUI(){
    const mode = modeSel.value;
    const tbl = document.getElementById('tbl');
    tbl.classList.toggle('mode-percent', mode==='percent');

    // ุฅุธูุงุฑ/ุฅุฎูุงุก ุนูุงุตุฑ ุนููุง
    splitBox.style.display  = (mode==='split') ? '' : 'none';
    totalsSplit.style.display = (mode==='split') ? 'flex' : 'none';

    // ุฅุธูุงุฑ/ุฅุฎูุงุก ุงูุฃุนูุฏุฉ ุญุณุจ ุงููุถุน
    let showCols = [];
    if (mode==='asfed'){
      showCols = ['name','cat','dm','pTon','pTonDM','kg','kgDM','cost','src','rm'];
    }else if (mode==='percent'){
      showCols = ['name','cat','dm','pTon','pTonDM','pct','src','rm'];
    }else{ // split
      showCols = ['name','cat','dm','pTon','pTonDM','pct','kg','kgDM','cost','src','rm'];
    }
    const shouldShow = new Set(showCols);

    // th
    document.querySelectorAll('th').forEach(th=>{
      const col = th.dataset.col; if(!col) return;
      th.style.display = shouldShow.has(col) ? '' : 'none';
    });
    // td
    document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
      tr.querySelectorAll('td').forEach(td=>{
        const col = td.dataset.col; if(!col) return;
        td.style.display = shouldShow.has(col) ? '' : 'none';
      });
      setSplitRowState(tr);
    });

    // ุชุญูู ูู ุดุฑูุท ุงูุฅุฌูุงููุงุช ุงูุฃุณุงุณู
    document.getElementById('pillMix').style.display = (mode==='split') ? 'none' : '';
    pillSumPct.style.display = (mode==='percent') ? 'inline-flex' : 'none';

    recalc();
  }

  // ุชุญููู ุงูุตููู ุงููุฎุฒูุฉ ุฃู ุณุทุฑ ูุงุฑุบ
  if (rows.length){ rows.forEach(addRow); } else { addRow({}); }

  // ุฅุถุงูุฉ ุฎุงูุฉ ุฌุงูุฒุฉ
  addPresetBtn.onclick = ()=>{
    const idx = parseInt(presetSel.value); if (isNaN(idx)) return;
    const f = FEEDS[idx]; addRow({ name:f.name, dm:f.dm, price:'', kg:'', pct:'', cat: guessCat(f.name), src:'ูุฏูู' }); recalc();
  };

  saveBtn.onclick = ()=>{ alert('โ๏ธ ุชู ุญูุธ ุงูุฎูุทุฉ ูุญูููุง'); };
  clearBtn.onclick = ()=>{ if(confirm('ูุณุญ ูู ุงูุตูููุ')){ tbody.innerHTML=''; addRow({}); recalc(); } };

  // ุฒุฑ ุชุญุฏูุซ ุงูุฃุณุนุงุฑ ูู ุงูุณูู ุงูุนุงููู (ุฌุงูุฒ ูููุณุชูุจู) โ ูุญุงูู ุงููุฑุงุกุฉ ูู Firestore feedPrices/{symbol}
  fetchBtn.onclick = async ()=>{
    try{
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
      const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
      const cfgMod = await import('./js/firebase-config.js');
      const app = initializeApp(cfgMod.firebaseConfig);
      const db  = getFirestore(app);

      // ููู ุตูุ ูู ุงูุงุณู ูุนุฑูู ููู ุฑูุฒุ ุญุงูู ุฌูุจ priceEGP ุฃู (priceUSDรusdToEgp)
      const trs = Array.from(tbody.querySelectorAll('tr'));
      for (const tr of trs){
        const name = tr.querySelector('.name').value.trim();
        const f = FEEDS.find(x=>x.name===name);
        if(!f || !f.symbol) continue;
        const ref = doc(db, 'feedPrices', f.symbol);
        const snap= await getDoc(ref);
        if (snap.exists()){
          const data = snap.data();
          const price = (data.priceEGP || (data.priceUSD && data.usdToEgp ? data.priceUSD*data.usdToEgp : null));
          if (price){ tr.querySelector('.pTon').value = price; tr.querySelector('.src').textContent = 'ุนุงููู'; }
        }
      }
      recalc();
      document.getElementById('srcHint').textContent = ' (ุชู ุงูุชุญุฏูุซ ุฅู ููุฌุฏุช ุจูุงูุงุช)';
    }catch(e){
      console.warn('Global price fetch not configured', e);
      alert('โน๏ธ ูู ูุชู ุชูุนูู ุฑุจุท ุงูุณูู ุงูุนุงููู ุจุนุฏ. ุงุณุชุฎุฏู ุงูุฃุณุนุงุฑ ุงููุฏููุฉ ูุคูุชูุง.');
    }
  };

  modeSel.addEventListener('change', updateModeUI);
  document.getElementById('concKgInput').addEventListener('input', recalc);
  updateModeUI();

  // ุงูููู ุงููุญูู
  const todayLocal2 = ()=>{ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };
  try{ document.getElementById('today').textContent = new Date(todayLocal2()).toLocaleDateString('ar-EG'); }catch{ document.getElementById('today').textContent = todayLocal2(); }

  function nf(x){ return new Intl.NumberFormat('ar-EG',{maximumFractionDigits:2}).format(x||0); }
</script>
</body>
</html>
