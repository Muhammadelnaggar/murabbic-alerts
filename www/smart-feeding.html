<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🧠 التغذية الذكية — تحليل التركيبة</title>
  <style>
    :root{--bg:#fff9db;--card:#f1f8e9;--border:#c5e1a5;--green:#2e7d32}
    *{box-sizing:border-box}
    body{direction:rtl;background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;color:#1b5e20;padding:12px}
    h1{margin:0 0 10px;text-align:center;color:var(--green);font-size:22px}
    .wrap{max-width:1080px;margin:0 auto}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#dcedc8;font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px}
    input,select,button{min-height:44px;font-size:14px}
    input,select{padding:10px;border:1px solid #ccc;border-radius:10px}
    button{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:bold;cursor:pointer}
    .btn{background:#fff;border:1px solid var(--green);color:var(--green)}
    .btn-primary{background:var(--green);color:#fff}
    .muted{opacity:.85}
    .warn{color:#c62828}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
    .kpi{background:#eafbe7;border:1px solid #e0ebd3;border-radius:10px;padding:10px;text-align:center}
    .kpi b{display:block;font-size:18px;margin-top:4px;color:#1b5e20}
    .table-wrap{display:none}
    @media(max-width:640px){.grid{grid-template-columns:1fr 1fr}}
    /* جودة التغذية */
    .quality{display:flex;align-items:center;gap:10px;margin-top:8px}
    .quality .bar{flex:1;height:14px;border-radius:999px;background:#eceff1;border:1px solid var(--border);overflow:hidden}
    .quality .bar span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#e53935,#fdd835,#43a047);transition:width .4s ease}
    .quality .score{min-width:64px;text-align:center;font-weight:bold}
  </style>
</head>
<body>
<div class="wrap">
  <h1>🧠 التغذية الذكية — تحليل التركيبة</h1>
  <div class="row" id="hdrInfo">
    <span class="pill">🐄 الهدف: <b id="who">—</b></span>
    <span class="pill">📅 تاريخ التركيبة: <b id="date">—</b></span>
    <span class="pill">⚙️ طريقة الإدخال: <b id="mode">—</b></span>
    <span class="pill">🐃 النوع: <b id="species">—</b></span>
    <span class="pill">🕒 DIM: <b id="dim">—</b></span>
    <span class="pill">🤰 DCC: <b id="dcc">—</b></span>
  </div>

  <!-- مؤشر جودة التغذية -->
  <div class="card" id="qualityCard">
    <div class="row" style="align-items:center">
      <span class="pill">🌈 مؤشر جودة التغذية: <b id="qLabel">—</b></span>
      <div class="quality" style="flex:1">
        <div class="bar"><span id="qFill"></span></div>
        <div class="score" id="qScore">—</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div class="kpi"><span class="muted">إجمالي كجم DM/رأس</span><b id="kpiDM">—</b></div>
      <div class="kpi"><span class="muted">تكلفة/رأس/يوم</span><b id="kpiCost">—</b></div>
      <div class="kpi"><span class="muted">سعر طن الخلطة (DM)</span><b id="kpiMix">—</b></div>
      <div class="kpi"><span class="muted">خشِن : مركز (DM)</span><b id="kpiFC">—</b></div>
      <div class="kpi"><span class="muted">% DM للخلطة</span><b id="kpiDmpct">—</b></div>
      <div class="kpi"><span class="muted">سعر كيلو اللبن</span>
        <div class="row"><input id="milkPrice" type="number" inputmode="decimal" step="0.01" style="width:120px"><button id="saveMilkPrice" class="btn">حفظ</button></div>
      </div>
      <div class="kpi"><span class="muted">تكلفة التغذية/كجم لبن</span><b id="kpiFeedPerKg">—</b></div>
      <div class="kpi"><span class="muted">هامش فوق تكلفة العلف/رأس</span><b id="kpiMargin">—</b></div>
      <div class="kpi"><span class="muted">إجمالي الخلطة as‑fed/رأس</span><b id="kpiAsFedTotal">—</b></div>
      <div class="kpi"><span class="muted">% بروتين خام (DM)</span><b id="kpiCPpct">—</b></div>
      <div class="kpi"><span class="muted">طاقة العليقة (ميجا جول/يوم)</span><b id="kpiEnergy">—</b></div>
      <div class="kpi"><span class="muted">% دهون (DM)</span><b id="kpiFatPct">—</b></div>
      <div class="kpi"><span class="muted">كجم DM / كجم لبن</span><b id="kpiDMIperKg">—</b></div>
      <div class="kpi"><span class="muted">التكلفة الكلية/كجم لبن (+25%)</span><b id="kpiMilkCostTotal">—</b></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="pill">🥛 متوسط إنتاج/رأس: <input id="avgMilk" type="number" inputmode="decimal" step="0.1" style="width:90px"></div>
      <div class="pill" id="afBox" style="display:none">⚖️ تقدير كمية الخلطة as-fed/رأس: <input id="asFedKg" type="number" inputmode="decimal" step="0.1" style="width:90px"></div>
      <div class="pill warn" id="msg"></div>
    </div>
  </div>

  <div class="card" id="diagnostics" style="display:none">
    <div class="pill">🩺 ملاحظات ذكية</div>
    <ul id="notes" style="margin:8px 16px"></ul>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="pill">📋 تم التحليل من آخر تركيبة محفوظة — التفاصيل مخفية هنا</div>
      <div class="row">
        <button id="gotoEdit" class="btn">تعديل التركيبة</button>
        <button id="gotoEvents" class="btn">تسجيل حدث جديد</button>
        <button id="gotoDash" class="btn">لوحة التحكم</button>
      </div>
    </div>
  </div>

  <div class="table-wrap"> <!-- مخفي حسب رغبتك -->
    <table id="tbl">
      <thead><tr>
        <th>الخامة</th><th>الفئة</th><th>% DM</th><th>سعر طن as‑fed</th><th>سعر/طن DM</th>
        <th>٪ as‑fed</th><th>كجم as‑fed/رأس</th><th>كجم DM/رأس</th><th>تكلفة/رأس</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <div class="row">
      <button class="btn-primary" id="refresh">🔄 تحديث التحليل</button>
    </div>
  </div>
</div>

<script type="module">
  import { db, auth } from './js/firebase-config.js';
  import { collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

  const qs = new URLSearchParams(location.search);
  const animalId = qs.get('animalId') || qs.get('number') || localStorage.getItem('lastAnimalId') || '';
  const group    = qs.get('group') || '';

  const el = (id)=> document.getElementById(id);
  const nf = (x)=> new Intl.NumberFormat('ar-EG',{maximumFractionDigits:2}).format(x||0);
  const clamp=(v,min,max)=> Math.min(max, Math.max(min, v));
  function bandScore(v, min, goodMin, goodMax, max){
    if (v==null || isNaN(v)) return null;
    if (v<=min || v>=max) return 0;
    if (v>=goodMin && v<=goodMax) return 100;
    if (v<goodMin) return 100 * ( (v - min) / (goodMin - min) );
    return 100 * ( (max - v) / (max - goodMax) );
  }
  function gradeLabel(score){
    if (score==null) return '—';
    if (score>=85) return 'ممتاز 🟢';
    if (score>=70) return 'جيد ✅';
    if (score>=55) return 'مقبول ⚠️';
    return 'غير متزن 🔴';
  }
  const qFill = document.getElementById('qFill');
  const qScore= document.getElementById('qScore');
  const qLabel= document.getElementById('qLabel');
  let lastEv = null;

  // قيم غذائية تقريبية لكل خامة على أساس المادة الجافة (DM)
  // cp: % بروتين خام على DM، fat: % دهون على DM، nel: طاقة لبنية صافية (ميجا جول/كجم DM)
  const NUT = {
    'ذرة صفراء مجروشة':        {cp:9,  fat:4,  nel:8.45},
    'شعير':                     {cp:12, fat:2.1,nel:7.95},
    'قمح مطحون':               {cp:13, fat:1.9,nel:8.55},
    'ردة قمح (نخالة)':         {cp:16, fat:4,  nel:6.8},
    'ردة أرز':                  {cp:14, fat:14, nel:7.6},
    'ذرة رفيعة (سورجم)':       {cp:10, fat:3.2,nel:7.9},
    'شوفان':                    {cp:12, fat:5,  nel:7.6},
    'فول بلدي (فابا)':         {cp:26, fat:1.5,nel:6.8},
    'بازلاء علفية':            {cp:23, fat:1.5,nel:7.0},

    'DDGS (ذرة)':              {cp:30, fat:10, nel:8.4},
    'جلوتين فيد (CGF)':        {cp:23, fat:3,  nel:6.9},
    'جلوتين ميل (CGM)':        {cp:60, fat:2,  nel:7.2},
    'قشور فول صويا (Soy Hulls)':{cp:10, fat:2, nel:6.3},
    'لب بنجر مجفف':            {cp:10, fat:0.7,nel:6.4},
    'لب بنجر مبلل':            {cp:10, fat:0.7,nel:6.4},
    'لب حمضيات مجفف':          {cp:7,  fat:1.6,nel:6.5},
    'مولاس':                   {cp:5,  fat:0,  nel:5.4},

    'كسب فول صويا 44%':        {cp:44, fat:1.5,nel:7.0},
    'كسب فول صويا 48%':        {cp:48, fat:1.5,nel:7.2},
    'كسب عباد الشمس':          {cp:32, fat:1.5,nel:6.0},
    'كسب كانولا':              {cp:38, fat:3,  nel:6.6},
    'كسب قطن':                 {cp:24, fat:2,  nel:6.5},
    'كسب نخيل':                {cp:17, fat:8,  nel:6.5},
    'كسب فول سوداني':          {cp:45, fat:1,  nel:7.1},
    'كسب سمسم':                {cp:38, fat:10, nel:6.8},
    'كسب كتان':                {cp:33, fat:8,  nel:6.6},

    'بذرة قطن كاملة':         {cp:23, fat:18, nel:7.2},
    'قشور بذرة قطن (Hulls)':  {cp:4,  fat:2,  nel:4.0},

    'سيلاج ذرة':               {cp:8,  fat:3,  nel:6.7},
    'سيلاج سورجم':            {cp:7,  fat:2.5,nel:6.0},
    'برسيم أخضر':              {cp:19, fat:2.5,nel:5.4},
    'دريس برسيم':              {cp:18, fat:2,  nel:4.9},
    'دريس حشيشة/نجيل':        {cp:12, fat:2,  nel:4.6},
    'تبن قمح':                 {cp:4,  fat:1.5,nel:3.3},
    'قش أرز':                  {cp:4,  fat:1.5,nel:3.0},

    'دهون محمية':              {cp:0,  fat:99, nel:25.0},
    'زيت نباتي علفي':         {cp:0,  fat:99, nel:25.0},
    'يوريا علفية':             {cp:281,fat:0,  nel:0},
    'حجر جيري (كالسيوم)':     {cp:0,  fat:0,  nel:0},
    'فوسفات ثنائي الكالسيوم (DCP)':{cp:0,fat:0,nel:0},
    'ملح طعام':                {cp:0,  fat:0,  nel:0},
    'بيكربونات صوديوم':       {cp:0,  fat:0,  nel:0},
    'أكسيد ماغنسيوم':         {cp:0,  fat:0,  nel:0},
    'بنتونيت':                 {cp:0,  fat:0,  nel:0},
    'خميرة حية/مستنبت خمائري':{cp:40, fat:1,  nel:5.0},
    'مخلوط معادن/فيتامينات':  {cp:0,  fat:0,  nel:0},
  };
  function getNut(name, cat){
    const n = NUT[name?.trim?.()] || null;
    if (n) return n;
    // تقديرات افتراضية لو الخامة مش معرّفة
    if ((cat||'conc')==='rough') return {cp:12, fat:2, nel:4.8};
    return {cp:16, fat:3, nel:7.5};
  }

  // Header
  el('who').textContent = group || animalId || 'غير محدد';
  el('gotoDash').onclick   = ()=> location.href='dashboard.html';
  el('gotoEvents').onclick = ()=> location.href=`add-event.html?animalId=${encodeURIComponent(animalId||'')}`;
  el('gotoEdit').onclick   = ()=> location.href=`nutrition.html?animalId=${encodeURIComponent(animalId||'')}&return=smart-feeding.html`;

  // Milk price local setting
  const milkPriceInput = el('milkPrice');
  milkPriceInput.value = localStorage.getItem('milkPrice') || '';
  el('saveMilkPrice').onclick = ()=> localStorage.setItem('milkPrice', milkPriceInput.value||'');

  async function fetchLastNutrition(){
    let docs = [];
    async function run(q){ const s=await getDocs(q); s.forEach(d=>docs.push({id:d.id,...d.data()})); }
    // 1) by animal
    if (animalId){
      try{ await run(query(collection(db,'events'), where('animalId','==',String(animalId)), where('eventType','==','تغذية'), orderBy('createdAt','desc'), limit(1))); }catch{}
      if(!docs.length){ try{ await run(query(collection(db,'events'), where('animalId','==',String(animalId)), where('type','==','تغذية'), orderBy('createdAt','desc'), limit(1))); }catch{} }
      if(!docs.length){ try{ await run(query(collection(db,'events'), where('animalId','==',String(animalId)), orderBy('createdAt','desc'), limit(10))); }catch{} docs = docs.filter(x=> x.eventType==='تغذية' || x.type==='تغذية'); docs = docs.slice(0,1); }
    }
    // 2) by group
    if (!docs.length && group){
      try{ await run(query(collection(db,'events'), where('context.group','==',group), where('eventType','==','تغذية'), orderBy('createdAt','desc'), limit(1))); }catch{}
      if(!docs.length){ try{ await run(query(collection(db,'events'), where('eventType','==','تغذية'), orderBy('createdAt','desc'), limit(30))); }catch{} docs = docs.filter(x=> x.context?.group===group); docs = docs.slice(0,1); }
    }
    return docs[0] || null;
  }

  function clearTable(){ el('tbl').querySelector('tbody').innerHTML=''; }
  function addRow(r){
    const tr=document.createElement('tr');
    const pDM = r.dm>0? (r.price/(r.dm/100)) : 0;
    tr.innerHTML = `<td>${r.name||''}</td><td>${r.cat||''}</td><td>${r.dm||''}</td><td>${r.price||''}</td><td>${pDM?nf(pDM):'—'}</td>`+
                   `<td>${r.pct||''}</td><td>${r.kg||''}</td><td>${r.kgDM?nf(r.kgDM):'—'}</td><td>${r.cost?nf(r.cost):'—'}</td>`;
    el('tbl').querySelector('tbody').appendChild(tr);
  }

  function analyze(ev){
    const mode = ev?.nutrition?.mode || ev?.kpis?.mode || 'tmr_asfed';
    const rows = (ev?.nutrition?.rows||[]).map(r=>({...r}));
    el('mode').textContent = mode;
    el('date').textContent = (ev?.eventDate ? new Date(ev.eventDate).toLocaleDateString('ar-EG') : '—');
    el('species').textContent = ev?.context?.species || '—';
    el('dim').textContent = ev?.context?.daysInMilk ?? '—';
    el('dcc').textContent = ev?.context?.pregnancyDays ?? '—';
    el('avgMilk').value = ev?.context?.avgMilkKg ?? '';

    clearTable();

    // helpers
    let totDM=0, totCost=0, roughDM=0, concDM=0, dmFracMix=0, asFedMix=0; let msg='';
    let asFedTotal=0; // إجمالي as-fed/رأس
    let cpKg=0, fatKg=0, energyMcal=0; // مجاميع مغذيات على أساس DM
    const setMsg=(t)=>{ el('msg').textContent=t; };

    if (mode==='tmr_asfed'){
      rows.forEach(r=>{
        const pDM = r.dm>0? (r.price/(r.dm/100)) : 0;
        const kgDM = (r.kg||0)*(r.dm||0)/100; r.kgDM=kgDM;
        const cost = (kgDM/1000)*pDM; r.cost=cost;
        const nut = getNut(r.name, r.cat);
        cpKg   += kgDM * (nut.cp/100);
        fatKg  += kgDM * (nut.fat/100);
        energyMcal += kgDM * (nut.nel);
        asFedTotal += (r.kg||0);
        if ((r.cat||'conc')==='rough') roughDM+=kgDM; else concDM+=kgDM;
        totDM+=kgDM; totCost+=cost; addRow(r);
      });
      // mix price DM
      let mixDM=0; rows.forEach(r=>{ const pDM=r.dm>0? (r.price/(r.dm/100)) : 0; const share = totDM>0? (r.kgDM/totDM):0; mixDM += share*pDM; });
      el('kpiMix').textContent = mixDM? nf(mixDM):'—';
      // DM% of mix
      const dmPct = (asFedTotal>0 && totDM>0)? (totDM/asFedTotal*100) : 0;
      el('kpiDmpct').textContent = dmPct? nf(dmPct)+'%':'—';
      el('afBox').style.display='none';
    } else if (mode==='tmr_percent'){
      // show percent column; need as-fed total to compute DM/cost
      el('afBox').style.display='inline-flex';
      const totalAf = parseFloat(el('asFedKg').value)||0;
      rows.forEach(r=>{ dmFracMix += (r.pct||0)/100 * (r.dm||0)/100; asFedMix += (r.pct||0)/100 * (r.price||0); });
      const mixPriceDM = dmFracMix>0 ? (asFedMix/dmFracMix) : 0;
      el('kpiMix').textContent = mixPriceDM? nf(mixPriceDM):'—';
      el('kpiDmpct').textContent = dmFracMix? nf(dmFracMix*100)+'%':'—';
      if (Math.abs(rows.reduce((a,b)=>a+(b.pct||0),0) - 100) > 0.5) setMsg('⚠️ مجموع النسب لا يساوي 100%');

      if (totalAf>0){
        rows.forEach(r=>{
          const kg = totalAf * (r.pct||0)/100; r.kg = kg;
          const kgDM = kg * (r.dm||0)/100; r.kgDM = kgDM;
          const pDM = r.dm>0? (r.price/(r.dm/100)) : 0; r.cost = (kgDM/1000)*pDM;
          const nut = getNut(r.name, r.cat);
          cpKg   += kgDM * (nut.cp/100);
          fatKg  += kgDM * (nut.fat/100);
          energyMcal += kgDM * (nut.nel);
          asFedTotal += kg;
          if ((r.cat||'conc')==='rough') roughDM+=kgDM; else concDM+=kgDM;
          totDM+=kgDM; totCost+=r.cost; addRow(r);
        });
      } else {
        rows.forEach(r=> addRow(r));
        setMsg('أدخل كمية الخلطة as-fed/رأس لحساب DM والتكلفة والقيم الغذائية.');
      }
    } else { // split
      // concentrate block from percents + concKgAf
      const concKgAf = parseFloat(ev?.nutrition?.concKgAf||0) || 0;
      const concRows = rows.filter(r=> (r.cat||'conc')==='conc');
      const roughRows= rows.filter(r=> (r.cat||'conc')==='rough');
      let concDmFrac=0, concAs=0, concCPfrac=0, concFatFrac=0, concNELfrac=0;
      concRows.forEach(r=>{ 
        const dmfr = (r.pct||0)/100 * (r.dm||0)/100; 
        const nut = getNut(r.name, r.cat);
        concDmFrac += dmfr; concAs += (r.pct||0)/100 * (r.price||0);
        concCPfrac  += dmfr * (nut.cp/100);
        concFatFrac += dmfr * (nut.fat/100);
        concNELfrac += dmfr * (nut.nel);
      });
      const concPriceDM = concDmFrac>0? (concAs/concDmFrac) : 0;
      const concKgDM = concKgAf * concDmFrac; const concCost = (concKgDM/1000) * concPriceDM;
      const concCPpct = concDmFrac>0? (concCPfrac/concDmFrac*100) : 0;
      const concFatpct= concDmFrac>0? (concFatFrac/concDmFrac*100) : 0;
      const concNEL   = concDmFrac>0? (concNELfrac/concDmFrac) : 0; // MJ/kg DM
      // accumulate concentrate nutrients
      cpKg   += concKgDM * (concCPpct/100);
      fatKg  += concKgDM * (concFatpct/100);
      energyMcal += concKgDM * concNEL;
      concDM += concKgDM; totCost += concCost; asFedTotal += concKgAf;

      roughRows.forEach(r=>{
        const pDM = r.dm>0? (r.price/(r.dm/100)) : 0;
        const kgDM = (r.kg||0)*(r.dm||0)/100; r.kgDM=kgDM; r.cost=(kgDM/1000)*pDM; 
        const nut = getNut(r.name, r.cat);
        cpKg   += kgDM * (nut.cp/100);
        fatKg  += kgDM * (nut.fat/100);
        energyMcal += kgDM * (nut.nel);
        asFedTotal += (r.kg||0);
        roughDM+=kgDM; totCost+=r.cost; addRow(r);
      });
      // Add a synthetic row for concentrate result
      addRow({ name:'مركز — نتيجة الخلطة', cat:'conc', dm: nf(concDmFrac*100), price: '', pct: '—', kg: nf(concKgAf), kgDM: concKgDM, cost: concCost });
      totDM = roughDM + concDM;
      // mix price DM weighted
      let mixDM=0; const allRows=[...roughRows,{dm:concDmFrac*100, kgDM:concKgDM, price: (concDmFrac>0? (concAs/concDmFrac*(concDmFrac*100/100)):0)}];
      allRows.forEach(r=>{ const pDM=r.dm>0? ((r.price && typeof r.price==='number')? r.price/(r.dm/100) : (concPriceDM)) : 0; const share = totDM>0? (r.kgDM/totDM):0; mixDM += share*pDM; });
      el('kpiMix').textContent = mixDM? nf(mixDM):'—';
      el('kpiDmpct').textContent = '—';
    }

    // === مؤشر جودة التغذية ===
    const energyPerDM = (totDM>0) ? (energyMcal / totDM) : null; // MJ/kg DM
    const speciesTxt = (ev?.context?.species||'بقر');
    const cpBand    = (speciesTxt==='جاموس') ? [11,13,16,18] : [12,14,18,20]; // [min,goodMin,goodMax,max] %
    const roughBand = [35,40,60,70];
    const fatBand   = [2,3,6,8];
    const enBand    = [5.5,6.2,7.2,8.0];
    const milkKgQ   = parseFloat(el('avgMilk').value)||0;
    const dmiPerKg  = (milkKgQ>0 && totDM>0) ? (totDM/milkKgQ) : null;
    const effBand   = [0.7,0.8,1.0,1.3];

    const roughPct = (totDM>0)? (roughDM/totDM*100):null;
    const cpPctVal = (totDM>0)? (cpKg/totDM*100):null;
    const fatPctVal= (totDM>0)? (fatKg/totDM*100):null;

    let scores=[]; 
    const sRough = bandScore(roughPct, ...roughBand); if (sRough!=null) scores.push({w:0.25,s:sRough});
    const sCP    = bandScore(cpPctVal, ...cpBand);   if (sCP   !=null) scores.push({w:0.25,s:sCP});
    const sEn    = bandScore(energyPerDM, ...enBand);if (sEn   !=null) scores.push({w:0.25,s:sEn});
    const sFat   = bandScore(fatPctVal, ...fatBand); if (sFat  !=null) scores.push({w:0.10,s:sFat});
    const sEff   = bandScore(dmiPerKg, ...effBand);  if (sEff  !=null) scores.push({w:0.15,s:sEff});

    const wsum = scores.reduce((a,b)=>a+b.w,0);
    let q = (wsum>0)? (scores.reduce((a,b)=> a + b.w*b.s, 0) / wsum) : null;
    if (q!=null){ q = Math.round(q); qFill.style.width = q+'%'; qScore.textContent = q.toString(); qLabel.textContent = gradeLabel(q); }
    else { qFill.style.width='0%'; qScore.textContent='—'; qLabel.textContent='—'; }

    // KPIs
    el('kpiDM').textContent   = totDM? nf(totDM):'—';
    el('kpiCost').textContent = (totCost||totCost===0)? nf(totCost):'—';
    const fPct = totDM>0? (roughDM/totDM*100):0, cPct=100-fPct; el('kpiFC').textContent = (totDM>0? `${nf(fPct)}% : ${nf(cPct)}%` : '—');

    el('kpiAsFedTotal').textContent = asFedTotal? nf(asFedTotal):'—';
    const cpPct = totDM>0? (cpKg/totDM*100) : 0; el('kpiCPpct').textContent = cpPct? nf(cpPct)+'%':'—';
    const fatPct= totDM>0? (fatKg/totDM*100): 0; el('kpiFatPct').textContent= fatPct? nf(fatPct)+'%':'—';
    el('kpiEnergy').textContent = energyMcal? nf(energyMcal):'—';

    const milkKg = parseFloat(el('avgMilk').value)||0; const milkPrice = parseFloat(milkPriceInput.value)||0;
    if (milkKg>0){
      const feedPerKg = totCost>0? (totCost/milkKg) : 0; el('kpiFeedPerKg').textContent = nf(feedPerKg);
      const dmiPerKg  = totDM>0? (totDM/milkKg) : 0; el('kpiDMIperKg').textContent = dmiPerKg? nf(dmiPerKg):'—';
      const milkCostTotal = feedPerKg * 1.25; el('kpiMilkCostTotal').textContent = nf(milkCostTotal);
      if (milkPrice>0){ const margin = milkKg*milkPrice - totCost; el('kpiMargin').textContent = nf(margin); } else el('kpiMargin').textContent='—';
    } else {
      el('kpiFeedPerKg').textContent='—';
      el('kpiMargin').textContent='—';
      el('kpiDMIperKg').textContent='—';
      el('kpiMilkCostTotal').textContent='—';
    }

    // Diagnostics (بسيطة كبداية)
    const notes=[]; const species = (ev?.context?.species||'بقر');
    if (mode!=='tmr_percent' && totDM>0){
      if (fPct<40) notes.push('نسبة المادة الخشنة منخفضة (<40% DM).');
      if (species==='بقر' && (milkKg>0 && (totDM/milkKg)<0.8)) notes.push('مدخول DM/إنتاج منخفض — راجع الطاقة/الألياف.');
    }
    const box = el('diagnostics'); const ul=el('notes');
    if (notes.length){ box.style.display='block'; ul.innerHTML=''; notes.forEach(n=>{ const li=document.createElement('li'); li.textContent=n; ul.appendChild(li); }); }
    else { box.style.display='none'; ul.innerHTML=''; }
  }

  async function refresh(){
    el('msg').textContent=''; clearTable();
    const ev = await fetchLastNutrition();
    if (!ev){ el('msg').textContent='لا يوجد حدث تغذية محفوظ بعد لهذا الهدف.'; return; }
    lastEv = ev;
    analyze(ev);
  }

  el('refresh').onclick = refresh;
  el('avgMilk').addEventListener('input', ()=> lastEv? analyze(lastEv):refresh());
  el('milkPrice').addEventListener('input', ()=> lastEv? analyze(lastEv):refresh());
  el('asFedKg').addEventListener('input', ()=> lastEv? analyze(lastEv):refresh());

 function boot(){
  const hasLS = !!localStorage.getItem('userId'); // جلسة تسجيل الدخول الخاصة بنا

  if (auth && typeof onAuthStateChanged === 'function') {
    onAuthStateChanged(auth, (user) => {
      if (user || hasLS) {
        refresh();
      } else {
        location.href = 'login.html';
      }
    });
  } else {
    // في حال ما فيش Firebase Auth أصلاً
    if (hasLS) { 
      refresh(); 
    } else { 
      location.href = 'login.html'; 
    }
  }
}
boot();

</script>
</body>
</html>
