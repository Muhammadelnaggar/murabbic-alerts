<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- ستايل ونظام الفورم المركزي -->
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <style>
  /* Fix infobar layout on mobile (page-only) */
  #sysbar{
    box-sizing: border-box;
    width: min(520px, calc(100% - 24px));
    margin: 10px auto 0;
    height: auto !important;
    min-height: 0 !important;
    padding: 10px 12px;
    line-height: 1.5;
    white-space: normal;
  }
    /* تصغير كارت التحقق */
.gate-box,
.validation-info,
.form-gate{
  padding: 12px !important;
  min-height: auto !important;
}
  #sysbar.show{ display:block !important; }
    /* ✅ Make Gate/Infobar clickable (page-only, no central edits) */
#sysbar{
  position: relative;
  z-index: 50;
  pointer-events: auto;
}

#sysbar *{
  pointer-events: auto;
}

/* لو زر "حسناً" Button أو Link */
#sysbar button,
#sysbar a{
  pointer-events: auto;
  cursor: pointer;
}
</style>

  <title>تسجيل التلقيح — مُرَبِّيك</title>
</head>

<body>

  <!-- نفس هيدر الولادة القياسي -->
  <header>
    <div class="mbk-head">
      <img class="mbk-logo" src="/images/logo.png" alt="مُرَبِّيك">
      <div class="mbk-center">
        <div class="mbk-page-title">تسجيل التلقيح</div>
        <div class="mbk-app-name">مُرَبِّيك</div>
      </div>
      <a class="mbk-back" href="add-event.html">رجوع</a>
    </div>
  </header>

  <script>window.dataLayer = window.dataLayer || [];</script>

  <main class="mbk-form">
<div id="sysbar" class="infobar mbk-infobar" style="display:none;"></div>
    <form id="eventForm"
          data-validate="true"
          data-event="تلقيح"
          autocomplete="off"
          novalidate>


      <label>رقم الحيوان *</label>
      <input data-field="animalNumber" inputmode="numeric" />

      <label>تاريخ التلقيح *</label>
      <input type="date" data-field="eventDate" />

      <label>طريقة التلقيح *</label>
      <select data-field="inseminationMethod">
        <option value="">اختر</option>
        <option>طبيعي</option>
        <option>اصطناعي</option>
      </select>

      <label>كود السائل المنوي *</label>
      <input data-field="semenCode" />

      <label>اسم الملقّح *</label>
      <input data-field="inseminator" />

      <label>وقت التلقيح *</label>
      <div class="radio-group">
        <label><input type="radio" name="inseminationTime" value="صباحا" data-field="inseminationTime"> صباحا</label>
        <label><input type="radio" name="inseminationTime" value="مساءا" data-field="inseminationTime"> مساءا</label>
      </div>

      <label>حالة الشياع *</label>
      <div class="radio-group">
        <label><input type="radio" name="heatStatus" value="صباحا" data-field="heatStatus"> صباحا</label>
        <label><input type="radio" name="heatStatus" value="مساءا" data-field="heatStatus"> مساءا</label>
      </div>

      <label>ملاحظات</label>
      <textarea data-field="notes"></textarea>

     <div class="btn-row">
  <button type="submit" class="save-btn">حفظ التلقيح</button>

  <button type="button" id="openCowCardBtn" class="save-btn open-card">
    فتح بطاقة الحيوان
  </button>
</div>


    </form>

  </main>

  <!-- Firebase & النظام -->
  <script type="module" src="/js/firebase-config.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>
  <script src="/js/app-core.js"></script>

  <!-- منطق الحفظ بعد الفاليديشن -->
  <script type="module">
  import { db } from "/js/firebase-config.js";
  import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { updateAnimalByEvent } from "/js/animal-update.js";
  const formEl = document.getElementById("eventForm");
const bar = window.ensureInfoBar ? window.ensureInfoBar(formEl) : document.getElementById("sysbar");

function showBar(msg, type = "success") {
  if (!bar) return;
  // استخدم نفس Renderer المركزي لضمان نفس الشكل على الموبايل
  if (window.showMsg) {
    window.showMsg(bar, msg, type);
    return;
  }
  // (احتياطي نادر) لو showMsg غير متاح لأي سبب
  bar.style.display = "block";
  bar.className = "infobar mbk-infobar show " + (type === "error" ? "error" : "success");
  bar.textContent = msg;
  try { bar.scrollIntoView({ behavior: "smooth", block: "start" }); } catch (_) {}
}
  const p = new URLSearchParams(location.search);
  document.querySelector('[data-field="animalNumber"]').value = p.get("number") || "";
  document.querySelector('[data-field="eventDate"]').value = p.get("eventDate") || p.get("date") || "";

  document.addEventListener("mbk:valid", async (e) => {
   if (e.detail?.eventName !== "تلقيح") return;

    const d = e.detail.formData;

    const payload = {
      userId: localStorage.getItem("userId"),
      eventType: "insemination",
      type: "insemination",
      animalNumber: d.animalNumber,
      eventDate: d.eventDate,
      inseminationMethod: d.inseminationMethod,
      semenCode: d.semenCode,
      inseminator: d.inseminator,
      inseminationTime: d.inseminationTime,
      heatStatus: d.heatStatus,
      notes: d.notes || null,
      createdAt: serverTimestamp(),
      source: location.pathname
    };

    try {
      await addDoc(collection(db, "events"), payload);
           showBar("✅ تم حفظ التلقيح بنجاح", "success");
      setTimeout(() => location.href = `add-event.html?number=${d.animalNumber}`, 1200);
    } catch (err) {
            showBar("❌ فشل الحفظ", "error");
    }
  });
  </script>

</body>
</html>











