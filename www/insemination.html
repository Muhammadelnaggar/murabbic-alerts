<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="/js/animal-update.js"></script>
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
 <script type="module">
  import { initEventShell } from "/js/event-shell.js";
  initEventShell({ pageId: "insemination", title: "تسجيل تلقيح", logoSrc: "/images/logo.png", backHref: "add-event.html" });
</script>


  <title>تسجيل حدث التلقيح — مُرَبِّك</title>
  <style>
    /* شريط تنبيه أعلى الصفحة (داخل الهيدر) */
    .alertbar{
      display:none;padding:12px 16px;font-weight:700;text-align:center;
      border-top:1px solid #fed7aa;border-bottom:1px solid #fed7aa;background:#fff7ed;color:#9a3412
    }
    .alertbar.ok{ background:#ecfdf5;border-color:#bbf7d0;color:#065f46 }
    .alertbar.show{ display:block }

    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff; --danger:#c2410c }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Segoe UI','Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0}
    .bar{max-width:920px;margin:0 auto;padding:12px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .title{font-weight:700;color:var(--green-600)}
    main{max-width:920px;margin:16px auto;padding:16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    label{font-weight:600;font-size:14px;color:#0f172a}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:15px}
    textarea{min-height:96px;resize:vertical}
    .row{display:grid;gap:12px}
    @media(min-width:720px){.row{grid-template-columns:repeat(3,1fr)}}
    .radio-group{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:4px}
    .actions{display:flex;gap:10px;justify-content:stretch;margin-top:12px}
    button{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
    .save{background:var(--green);color:#fff}
    .ghost{background:#eef2f7;color:#0f172a}
    .infobar{display:none;margin-top:12px;padding:12px;border-radius:10px;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .infobar.show{display:block}
    .error{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .toast{display:block}

    /* تبويب وضع الإدخال */
    .modes{display:flex;gap:8px;margin:0 auto 12px;max-width:920px}
    .seg{flex:1;background:#eef2f7;border:1px solid #e2e8f0;color:#0f172a;padding:10px;border-radius:10px;font-weight:800;cursor:pointer}
    .seg.active{background:#0ea05a;color:#fff;border-color:#0ea05a}

    /* جدول نتائج الإدخال الجماعي */
    .bulk-table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:10px}
    .bulk-table th{font-size:13px;color:#475569;text-align:right;padding:6px 8px}
    .bulk-table td{background:#fff;border:1px solid #e2e8f0;padding:10px 12px;border-radius:10px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .ok .badge{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
    .warn .badge{background:#fffbeb;color:#78350f;border:1px solid #fde68a}
    .err .badge{background:#fff1f2;color:#9f1239;border:1px solid #fecdd3}
  </style>
</head>
<body>
  <script>window.dataLayer = window.dataLayer || [];</script>

  <header>
    <div class="bar">
      <div class="title">تسجيل حدث التلقيح</div>
      <a class="ghost" href="add-event.html" style="text-decoration:none;padding:10px 12px;border-radius:10px">عودة للأحداث</a>
    </div>
    <div id="alertBar" class="alertbar" role="alert" aria-live="assertive"></div>
  </header>

  <!-- تبويب الوضع -->
  <div class="modes">
    <button id="modeSingle" class="seg active">إدخال فردي</button>
    <button id="modeBulk" class="seg">إدخال جماعي</button>
  </div>

  <main>
    <!-- === فردي === -->
    <div class="card grid" id="singleCard">
      <div class="row">
        <div>
          <label>رقم الحيوان <span style="color:red">*</span></label>
          <input id="animalNumber" inputmode="numeric" placeholder="مثال: 1023" required />
        </div>
        <div>
          <label>تاريخ التلقيح <span style="color:red">*</span></label>
          <input id="eventDate" type="date" required />
        </div>
        <div>
          <label>طريقة التلقيح <span style="color:red">*</span></label>
          <select id="inseminationMethod" required>
            <option value="">اختر...</option>
            <option value="طبيعي">طبيعي</option>
            <option value="اصطناعي">اصطناعي</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>كود السائل المنوي <span style="color:red">*</span></label>
          <input id="semenCode" placeholder="مثال: BULL123" required />
        </div>
        <div>
          <label>اسم الملقّح <span style="color:red">*</span></label>
          <input id="inseminator" placeholder="اسم الملقّح" required list="inseminatorsList" />
          <datalist id="inseminatorsList"></datalist>
        </div>
        <div>
          <label>وقت التلقيح <span style="color:red">*</span></label>
          <div class="radio-group">
            <label><input type="radio" name="inseminationTime" value="صباحا" required /> صباحا</label>
            <label><input type="radio" name="inseminationTime" value="مساءا" /> مساءا</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>حالة الشياع <span style="color:red">*</span></label>
          <div class="radio-group">
            <label><input type="radio" name="heatStatus" value="صباحا" required /> صباحا</label>
            <label><input type="radio" name="heatStatus" value="مساءا" /> مساءا</label>
          </div>
        </div>
        <div>
          <label>ملاحظات</label>
          <input id="notes" placeholder="اختياري" />
        </div>
      </div>

      <div class="actions">
        <button type="button" class="save" id="saveBtn">حفظ التلقيح ✅</button>
        <button class="ghost" id="toCardBtn">فتح بطاقة الحيوان</button>
      </div>

      <div id="info" class="infobar"></div>
    </div>

    <!-- === جماعي === -->
    <div class="card grid" id="bulkCard" style="display:none">
      <div class="row">
        <div>
          <label>تاريخ التلقيح (مشترك) <span style="color:red">*</span></label>
          <input id="bulkDate" type="date" required />
        </div>
        <div>
          <label>طريقة التلقيح <span style="color:red">*</span></label>
          <select id="bulkMethod" required>
            <option value="">اختر...</option>
            <option value="طبيعي">طبيعي</option>
            <option value="اصطناعي">اصطناعي</option>
          </select>
        </div>
        <div>
          <label>نمط الإدخال <span style="color:red">*</span></label>
          <select id="bulkMode" required>
            <option value="heat">عن طريق الشياع</option>
            <option value="program">إجباري / برنامج تزامن</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>كود السائل المنوي <span style="color:red">*</span></label>
          <input id="bulkSemen" placeholder="مثال: BULL123" required />
        </div>
        <div>
          <label>اسم الملقّح <span style="color:red">*</span></label>
          <input id="bulkInseminator" placeholder="اسم الملقّح" required list="inseminatorsList" />
        </div>
        <div>
          <label>وقت التلقيح <span style="color:red">*</span></label>
          <div class="radio-group">
            <label><input type="radio" name="bulkTime" value="صباحا" required /> صباحا</label>
            <label><input type="radio" name="bulkTime" value="مساءا" /> مساءا</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div id="bulkHeatWrap">
          <label>حالة الشياع <span style="color:red">*</span></label>
          <div class="radio-group">
            <label><input type="radio" name="bulkHeat" value="صباحا" required /> صباحا</label>
            <label><input type="radio" name="bulkHeat" value="مساءا" /> مساءا</label>
          </div>
        </div>
        <div style="grid-column: span 2">
          <label>أرقام الحيوانات (سطر لكل رقم أو مفصول بفواصل) <span style="color:red">*</span></label>
          <textarea id="bulkNumbers" placeholder="مثال: 1023, 1040, 2215&#10;أو: 1023&#10;1040&#10;2215"></textarea>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="ghost" id="bulkCheckBtn">تحقق من الجميع</button>
        <button type="button" class="save" id="bulkSaveBtn" disabled>حفظ المحدد ✅</button>
      </div>

      <div id="bulkInfo" class="infobar"></div>
      <div id="bulkTableWrap"></div>
    </div>
  </main>

  <!-- ترتيب التحميل -->
  <script type="module" src="/js/firebase-config.js"></script>
  <script src="/js/app-core.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>

  <!-- تعبئة الرقم/التاريخ من بارامز -->
  <script>
    (function () {
      const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
      function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
      function normISO(s){ if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const d=new Date(s); return isNaN(d)? todayISO() : new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }

      document.addEventListener('DOMContentLoaded', () => {
        const p   = new URLSearchParams(location.search);
        const num = (p.get('number') || p.get('animalNumber') || '').trim()
                      .replace(/[^\d٠-٩۰-۹]/g,'').replace(/[٠-٩۰-۹]/g, d=>map[d]);
        const dt  = normISO(p.get('eventDate') || p.get('date') || '');

        const numEl  = document.getElementById('animalNumber');
        const dateEl = document.getElementById('eventDate');
        const bulkDate = document.getElementById('bulkDate');

        if (numEl && num)           numEl.value  = num;
        if (dateEl && !dateEl.value) dateEl.value = dt || todayISO();
        if (bulkDate && !bulkDate.value) bulkDate.value = dt || todayISO();
      });
    })();
  </script>

  <!-- منطق الصفحة -->
  <script type="module">
    import { db, auth, ensureAuth } from '/js/firebase-config.js';
    import {
      collection, addDoc, serverTimestamp,
      query, where, limit, getDocs, orderBy
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { validateEvent } from "/js/form-rules.js";

// ✅ حارس موحّد: يمنع أي حفظ لحيوان خارج القطيع + يمر على validateEvent المركزي
async function mbkCanSave(number, eventDate){
  const a = await fetchAnimalDocByNumber(number);
  if (!a) return { ok:false, msg:"رقم غير موجود" };

  // قفل خارج القطيع
  const st = String(a.data?.status || "").trim().toLowerCase();
 if (st === "inactive") {
  const sp = normSpecies(a.data);
  const label = (sp === "جاموس") ? "هذه الجاموسة" : (sp === "أبقار") ? "هذه البقرة" : "هذا الحيوان";
  return { ok:false, msg: `${label} غير موجودة بالقطيع` };
}

  // قفل مركزي (أي قواعد أخرى مستقبلًا)
  const v = validateEvent("تلقيح", {
    animalId: String(number).trim(),
    eventDate: String(eventDate).trim(),
    documentData: a.data,
    species: normSpecies(a.data)
  });
  if (!v.ok) return { ok:false, msg: (v.errors?.[0] || "غير مسموح") };

  return { ok:true };
}

    // عناصر أساسية
    const info     = document.getElementById('info');
    const numEl    = document.getElementById('animalNumber');
    const dateEl   = document.getElementById('eventDate');
    const saveBtn  = document.getElementById('saveBtn');
    const alertBar = document.getElementById('alertBar');

    // وضع الإدخال
    const singleCard = document.getElementById('singleCard');
    const bulkCard   = document.getElementById('bulkCard');
    const modeSingle = document.getElementById('modeSingle');
    const modeBulk   = document.getElementById('modeBulk');

    modeSingle.addEventListener('click', ()=>{ modeSingle.classList.add('active'); modeBulk.classList.remove('active'); singleCard.style.display='grid'; bulkCard.style.display='none'; });
    modeBulk  .addEventListener('click', ()=>{ modeBulk.classList.add('active'); modeSingle.classList.remove('active'); bulkCard.style.display='grid'; singleCard.style.display='none'; });

    // رسائل
    function showMsg(text, isErr=false){
      const msg = (isErr ? '❌ ' : '✅ ') + text;
      if (info){
        info.className = 'infobar ' + (isErr ? 'show error' : 'show');
        info.setAttribute('role','status'); info.setAttribute('aria-live','polite');
        info.innerHTML = msg;
      }
      if (alertBar){
        alertBar.className = 'alertbar show' + (isErr ? '' : ' ok');
        alertBar.innerHTML = msg;
        if (!isErr){
          clearTimeout(window.__alertHide);
          window.__alertHide = setTimeout(()=>{ alertBar.className='alertbar'; alertBar.innerHTML=''; }, 3500);
        }
      }
    }
    function showToast(text){ showMsg(text,false); info?.classList.add('toast'); }

    // أدوات مساعدة
    function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    async function getUid(){
      if (auth.currentUser) return auth.currentUser.uid;
      const u = await new Promise(res => onAuthStateChanged(auth, x => res(x)));
      return u?.uid || '';
    }
    function daysBetweenISO(a,b){ const A=new Date(a), B=new Date(b); if (isNaN(A)||isNaN(B)) return NaN; A.setHours(0,0,0,0); B.setHours(0,0,0,0); return Math.round((B-A)/86400000); }
    const DIGITS={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
    const toLatin = s => String(s||'').replace(/[٠-٩۰-۹]/g, d=>DIGITS[d]).replace(/[^\d]/g,'');

    async function fetchAnimalDocByNumber(number){
      const raw = toLatin(number);
      const asStr = raw, asNum = raw ? Number(raw) : NaN;
      const tries = [
        ['animalNumber','==',asStr], ['animalNumber','==',asNum],
        ['number','==',asStr],       ['number','==',asNum],
        ['animalNo','==',asStr],     ['animalNo','==',asNum],
      ].filter(t => !(typeof t[2]==='number' && Number.isNaN(t[2])));
      for (const [field,op,val] of tries){
        const s = await getDocs(query(collection(db,'animals'), where(field,op,val), limit(1)));
        if (!s.empty){ const d=s.docs[0]; return { id:d.id, data:d.data()||{} }; }
      }
      return null;
    }
    function normSpecies(data){
      const s = String(data.animalTypeAr || data.animalType || data.species || '').trim();
      if (s === 'cow' || /بقر/i.test(s))       return 'أبقار';
      if (s === 'buffalo' || /جاموس/i.test(s)) return 'جاموس';
      return s || 'أبقار';
    }

    // آخر ولادة/إجهاض/تلقيح + إشارة الحمل من الأحداث
    async function fetchFacts(number){
      const uid = await getUid();
      const num = String(number||'').trim();
      const s = await getDocs(query(
        collection(db,'events'),
        where('userId','==', uid),
        where('animalNumber','==', num),
        orderBy('eventDate','desc'),
        limit(80)
      ));
      let lastCalving=null, lastAbort=null, lastInsem=null, pregnant=null;
      for (const d of s.docs){
        const ev = d.data()||{};
        const type = (ev.eventType || ev.type || '').trim();
        const res  = (ev.result || ev.status || '').trim();
        const dt   = ev.eventDate;

        if (!lastCalving && (type==='ولادة' || type==='calving')) lastCalving = dt;
        if (!lastAbort   && (type==='إجهاض' || type==='abortion')) lastAbort   = dt;
        if (!lastInsem   && (type==='insemination' || type==='تلقيح' || type==='تلقيح مخصب' || ev.fertile===true)) lastInsem = dt;

        if (type==='pregnancy_check' || type==='تشخيص حمل'){
          if (pregnant===null){
            if (/حامل|موجب/i.test(res)) pregnant = true;
            if (/غير حامل|سالب/i.test(res)) pregnant = false;
          }
        }
        if ((type==='ولادة'||type==='calving'||type==='إجهاض'||type==='abortion') && pregnant===null) pregnant = false;
        if (lastCalving && lastInsem && pregnant!==null) break;
      }
      return { lastCalving, lastAbort, lastInsem, pregnant };
    }

    // قفل/فتح (فردي)
    function lockForm(disabled=true){
      document.querySelectorAll('#singleCard input,#singleCard select,#singleCard button').forEach(el=>{
        const id = el.id || '';
        if (id==='animalNumber' || id==='eventDate' || id==='toCardBtn') return;
        el.disabled = disabled;
      });
      if (saveBtn) saveBtn.disabled = disabled;
    }

    // القواعد
    const FIRST_INSEM_MIN = { 'أبقار': 60, 'جاموس': 45 };

    // تحميل مقترحات أسماء الملقّحين
    async function loadInseminators() {
      try {
        await ensureAuth();
        const uid = await getUid();
        if (!uid) return;

        const list = document.getElementById('inseminatorsList');
        if (!list) return;
        list.innerHTML = '';

        const qy = query(
          collection(db, 'inseminators'),
          where('userId', '==', uid),
          orderBy('lastUsedAt', 'desc'),
          limit(50)
        );
        const snap = await getDocs(qy);

        const seen = new Set();
        snap.forEach(doc => {
          const name = (doc.data()?.name || '').trim();
          if (name && !seen.has(name)) {
            seen.add(name);
            const opt = document.createElement('option');
            opt.value = name;
            list.appendChild(opt);
          }
        });
      } catch (e) {
        console.warn('loadInseminators failed', e);
      }
    }
    document.addEventListener('DOMContentLoaded', loadInseminators);

    /* =========================
       التحقق المبدئي — فردي
       ========================= */
    async function precheckGate(){
      lockForm(true);
      showMsg('جارِ التحقق المبدئي من الرقم والتاريخ…');

      const number = (numEl?.value||'').trim();
      const evISO  = (dateEl?.value||'').trim() || todayISO();
      if (!number){ showMsg('أدخل رقم الحيوان أولًا.', true); return; }
      if (evISO > todayISO()){ showMsg('تاريخ التلقيح لا يمكن أن يكون في المستقبل.', true); return; }

      await ensureAuth();
      const uid = await getUid();
      if (!uid){ showMsg('سجّل الدخول أولًا.', true); return; }
const gate0 = await mbkCanSave(number, evISO);
if (!gate0.ok){ showMsg(gate0.msg, true); return; }

      const a = await fetchAnimalDocByNumber(number);
      if (!a){ showMsg('رقم الحيوان غير موجود في قاعدة البيانات.', true); return; }

      const species = normSpecies(a.data);
      const facts   = await fetchFacts(number);

      // قاعدة 3: عِشار → منع + توجيه
      const reproFromDoc = (a.data.reproductiveStatus || a.data.reproStatus || '').trim();
      const isPreg = (facts.pregnant !== null) ? facts.pregnant : (reproFromDoc === 'عشار');
      if (isPreg){
        showMsg('الحيوان مُسجَّل "عِشار". يجب التأكد من الحمل وتسجيل "تشخيص حمل" أولًا قبل التلقيح.', true);
        info.insertAdjacentHTML('beforeend',
          `<div style="margin-top:10px">
             <a href="pregnancy-diagnosis.html?number=${encodeURIComponent(number)}&eventDate=${encodeURIComponent(evISO)}"
                style="display:inline-block;padding:10px 14px;border-radius:10px;background:#0ea05a;color:#fff;font-weight:700;text-decoration:none">
                تسجيل تشخيص حمل الآن
             </a>
           </div>`);
        return;
      }

      // قاعدة 1: التلقيح الأول بعد الولادة (مع سماح 5 أيام)
      if (facts.lastCalving){
        const isFirstAfterCalving = !(facts.lastInsem && facts.lastInsem >= facts.lastCalving);
        if (isFirstAfterCalving){
          const minDays = FIRST_INSEM_MIN[species] ?? 60;
          const gap     = daysBetweenISO(facts.lastCalving, evISO);
          if (gap < (minDays - 5)){
            showMsg(`منع: التلقيح الأول بعد الولادة يجب أن يكون بعد ${minDays} يوم (${species}). الحالي ${gap} يوم فقط.`, true);
            return;
          }
          if (gap < minDays){
            showToast(`تنبيه: التلقيح الأول مبكّر بـ ${minDays - gap} يوم — مسموح ضمن سماح 5 أيام.`);
          }
        }
      }

      // قاعدة 2 (معدّلة): آخر تلقيح أقل من 11 يوم → تحذير
      if (facts.lastInsem){
        const d = daysBetweenISO(facts.lastInsem, evISO);
        if (d < 11){
          showToast('تنبيه: الحيوان غير منتظم الشياع / استمرار — خروج (آخر تلقيح أقل من 11 يوم).');
        }
      }

      showMsg('جاهز للتسجيل ✅');
      lockForm(false);
    }

    document.addEventListener('DOMContentLoaded', precheckGate);
    numEl?.addEventListener('change', precheckGate);
    numEl?.addEventListener('blur',   precheckGate);
    dateEl?.addEventListener('change', precheckGate);
    dateEl?.addEventListener('blur',   precheckGate);

    /* ================
       حفظ — فردي
       ================ */
    async function onSave(){
      lockForm(true);

      const eventDate  = (dateEl?.value||'').trim();
      if (eventDate > todayISO()){ showMsg('تاريخ التلقيح لا يمكن أن يكون في المستقبل', true); lockForm(false); return; }
      if (info.classList.contains('error')) { lockForm(true); return; }

      const animalNumber = (numEl?.value||'').trim();
      const method       = (document.getElementById('inseminationMethod')?.value||'').trim();
      const semenCode    = (document.getElementById('semenCode')?.value||'').trim();
      const inseminator  = (document.getElementById('inseminator')?.value||'').trim();
      const timeOfDay    = document.querySelector('input[name="inseminationTime"]:checked')?.value || '';
      const heatState    = document.querySelector('input[name="heatStatus"]:checked')?.value || '';
      if(!animalNumber || !eventDate || !method || !semenCode || !inseminator || !timeOfDay || !heatState){
        showMsg('جميع الحقول مطلوبة ماعدا الملاحظات', true); lockForm(false); return;
      }

      await ensureAuth();
      const userId = await getUid();
      if (!userId){ showMsg('سجّل الدخول أولًا.', true); return; }

      const notes = (document.getElementById('notes')?.value || '').trim();
      const payload = {
        userId, type:'insemination', eventType:'insemination',
        eventDate, animalNumber, number: animalNumber,
        inseminationMethod: method, semenCode, inseminator,
        inseminationTime: timeOfDay, heatStatus: heatState,
        notes: notes || null, source: location.pathname, createdAt: serverTimestamp()
      };
const gate = await mbkCanSave(animalNumber, eventDate);
if (!gate.ok){ showMsg(gate.msg, true); lockForm(false); return; }

      try{
        const ref = await addDoc(collection(db, 'events'), payload);
        await window.updateAnimalByEvent(payload);

        if (!ref?.id) throw new Error('no id');
        const addDaysISO = (iso,n)=>{ const d=new Date(iso); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); };
        const tips = [`موعد فحص حمل مقترح: ${addDaysISO(eventDate,30)}`, `متابعة شياع بعد 21 يوم: ${addDaysISO(eventDate,21)}`];
        showMsg(`تم الحفظ ✅ — ${tips.join(' — ')}`, false);
        setTimeout(()=> location.href = `add-event.html?number=${encodeURIComponent(animalNumber)}&eventDate=${encodeURIComponent(eventDate)}`, 1200);
      }catch(err){
        console.error(err); showMsg('تعذّر الحفظ في فايربيز.', true); lockForm(false);
      }
    }
    document.getElementById('saveBtn')?.addEventListener('click', onSave);
    document.getElementById('toCardBtn')?.addEventListener('click', ()=>{
      
      const number = (numEl?.value||'').trim();
      if(!number){ return showMsg('من فضلك أدخل رقم الحيوان لفتح البطاقة', true); }
      location.href = `cow-card.html?number=${encodeURIComponent(number)}`;
    });

    /* =========================
       إدخال جماعي — helpers
       ========================= */
    function getBulkInputs(){
      const date = (document.getElementById('bulkDate')?.value || '').trim();
      const method = (document.getElementById('bulkMethod')?.value || '').trim();
      const mode   = (document.getElementById('bulkMode')?.value || 'heat').trim();
      const semen  = (document.getElementById('bulkSemen')?.value || '').trim();
      const tech   = (document.getElementById('bulkInseminator')?.value || '').trim();
      const time   = document.querySelector('input[name="bulkTime"]:checked')?.value || '';
      const heatEl = document.querySelector('input[name="bulkHeat"]:checked');
      const heat   = (mode==='heat') ? (heatEl?.value || '') : 'برنامج';
      const rawNums= (document.getElementById('bulkNumbers')?.value || '').trim();

      // قائمة أرقام: سطر/فواصل/مسافات
      const numbers = rawNums
        .split(/[\s,;]+/).map(toLatin).filter(Boolean);

      return { date, method, mode, semen, tech, time, heat, numbers };
    }
    function setBulkHeatRequired(){
      const mode = (document.getElementById('bulkMode')?.value || 'heat');
      const wrap = document.getElementById('bulkHeatWrap');
      wrap.style.opacity = (mode==='heat') ? '1' : '0.5';
      wrap.querySelectorAll('input[name="bulkHeat"]').forEach(r=>{
        r.required = (mode==='heat');
        r.disabled = (mode!=='heat');
      });
    }
    document.getElementById('bulkMode')?.addEventListener('change', setBulkHeatRequired);
    document.addEventListener('DOMContentLoaded', setBulkHeatRequired);

    const bulkInfo = document.getElementById('bulkInfo');
    function bulkMsg(text,isErr=false){
      bulkInfo.className = 'infobar ' + (isErr ? 'show error' : 'show');
      bulkInfo.innerHTML = (isErr?'❌ ':'✅ ')+text;
      alertBar.className = 'alertbar show' + (isErr ? '' : ' ok');
      alertBar.innerHTML = (isErr?'❌ ':'✅ ')+text;
    }

    // نفس قواعد الفردي ولكن تُرجِع حالة لكل حيوان
    async function validateOne(number, eventDate){
      const result = { number, status:'OK', messages:[], species:'أبقار', facts:{} };

      const a = await fetchAnimalDocByNumber(number);
      if (!a){ result.status='ERROR'; result.messages.push('رقم غير موجود'); return result; }

      result.species = normSpecies(a.data);
      const st = String(a.data?.status || "").trim().toLowerCase();
if (st === "inactive"){ result.status="ERROR"; result.messages.push("خارج القطيع"); return result; }

      const facts = await fetchFacts(number);
      result.facts = facts;

      const reproFromDoc = (a.data.reproductiveStatus || a.data.reproStatus || '').trim();
      const isPreg = (facts.pregnant !== null) ? facts.pregnant : (reproFromDoc === 'عشار');
      if (isPreg){ result.status='ERROR'; result.messages.push('الحيوان مُسجّل عِشار — يلزم تشخيص حمل قبل التلقيح'); return result; }

      if (facts.lastCalving){
        const isFirstAfterCalving = !(facts.lastInsem && facts.lastInsem >= facts.lastCalving);
        if (isFirstAfterCalving){
          const minDays = FIRST_INSEM_MIN[result.species] ?? 60;
          const gap     = daysBetweenISO(facts.lastCalving, eventDate);
          if (gap < (minDays - 5)){ result.status='ERROR'; result.messages.push(`مبكر جدًا: التلقيح الأول بعد الولادة ≥ ${minDays} يوم (${result.species})`); }
          else if (gap < minDays){ result.status = (result.status==='OK'?'WARN':result.status); result.messages.push(`مبكر بـ ${minDays-gap} يوم (مسموح سماح 5 أيام)`); }
        }
      }

      if (facts.lastInsem){
        const d = daysBetweenISO(facts.lastInsem, eventDate);
        if (d < 11){ result.status = (result.status==='OK'?'WARN':result.status); result.messages.push('آخر تلقيح أقل من 11 يوم'); }
      }
      if (result.messages.length===0) result.messages.push('جاهز للتسجيل');
      return result;
    }

    function renderBulkTable(rows){
      const wrap = document.getElementById('bulkTableWrap');
      if (!rows.length){ wrap.innerHTML=''; document.getElementById('bulkSaveBtn').disabled = true; return; }
      const okToSave = rows.filter(r=>r.status!=='ERROR').length;

      const html = `
        <table class="bulk-table">
          <thead>
            <tr>
              <th>رقم الحيوان</th>
              <th>الحالة</th>
              <th>تفاصيل</th>
              <th>حفظ؟</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr class="${r.status==='OK'?'ok':r.status==='WARN'?'warn':'err'}">
                <td>${r.number}</td>
                <td><span class="badge">${r.status==='OK'?'سليم':r.status==='WARN'?'تحذير':'خطأ'}</span></td>
                <td>${r.messages.join(' — ')}</td>
                <td style="text-align:center">
                  ${r.status==='ERROR'
                    ? '<input type="checkbox" disabled />'
                    : `<input type="checkbox" class="bulk-ck" data-num="${r.number}" checked />`}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
      wrap.innerHTML = html;
      document.getElementById('bulkSaveBtn').disabled = (okToSave===0);
    }

    // تحقق جماعي
    document.getElementById('bulkCheckBtn')?.addEventListener('click', async ()=>{
      try{
        await ensureAuth();
        const uid = await getUid(); if(!uid){ bulkMsg('سجّل الدخول أولًا.', true); return; }

        const { date, method, mode, semen, tech, time, heat, numbers } = getBulkInputs();
        if (!date || !method || !semen || !tech || !time){ bulkMsg('أكمل الحقول المشتركة أولًا.', true); return; }
        if (mode==='heat' && !heat){ bulkMsg('اختر حالة الشياع (للشياع فقط).', true); return; }
        if (!numbers.length){ bulkMsg('أدخل أرقام الحيوانات.', true); return; }
        if (date > todayISO()){ bulkMsg('تاريخ التلقيح لا يمكن أن يكون في المستقبل.', true); return; }

        bulkMsg(`جارِ التحقق لـ ${numbers.length} حيوان…`);
        const results = [];
        for (const n of numbers){
          // تحقق لكل رقم
          try{
            const r = await validateOne(n, date);
            results.push(r);
          }catch(e){
            results.push({ number:n, status:'ERROR', messages:['تعذّر التحقق'] });
          }
        }
        const ok  = results.filter(r=>r.status==='OK').length;
        const wan = results.filter(r=>r.status==='WARN').length;
        const err = results.filter(r=>r.status==='ERROR').length;

        bulkMsg(`تم التحقق: سليم ${ok} — تحذير ${wan} — خطأ ${err}.${wan? ' يمكنك الحفظ مع التحذير.':''}`);
        renderBulkTable(results);
        // خزّن مؤقتًا للاستخدام عند الحفظ
        window.__bulkResults = results;
      }catch(e){
        console.error(e); bulkMsg('تعذّر تنفيذ التحقق الجماعي.', true);
      }
    });

    // حفظ جماعي
    document.getElementById('bulkSaveBtn')?.addEventListener('click', async ()=>{
      try{
        await ensureAuth();
        const uid = await getUid(); if(!uid){ bulkMsg('سجّل الدخول أولًا.', true); return; }

        const { date, method, mode, semen, tech, time, heat } = getBulkInputs();
        const checked = Array.from(document.querySelectorAll('.bulk-ck:checked')).map(x=>x.getAttribute('data-num'));
        if (!checked.length){ bulkMsg('لم يتم اختيار أي حيوان للحفظ.', true); return; }

        bulkMsg(`جارِ الحفظ لـ ${checked.length} حيوان…`);

        let ok=0, fail=0;
        for (const number of checked){
          const payload = {
            userId: uid,
            type:'insemination', eventType:'insemination',
            eventDate: date, animalNumber:number, number,
            inseminationMethod: method, semenCode: semen, inseminator: tech,
            inseminationTime: time,
            heatStatus: (mode==='heat'? heat : 'برنامج'),
            notes: null, source: location.pathname, createdAt: serverTimestamp()
          };
          const gate = await mbkCanSave(number, date);
if (!gate.ok){ fail++; continue; }

          try{
            const ref = await addDoc(collection(db,'events'), payload);
            if (ref?.id) ok++; else fail++;
          }catch(e){
            console.warn('bulk save failed for', number, e);
            fail++;
          }
        }

        bulkMsg(`تم الحفظ: ناجح ${ok} / فشل ${fail}. ${ok? '✅':''} ${fail? '❌':''}`, fail>0);
        if (ok>0){
          // إعادة تمكين/تحديث الجدول: ألغِ اختيار العناصر التي حُفظت
          document.querySelectorAll('.bulk-ck:checked').forEach(ck=>{ ck.checked=false; ck.disabled=true; });
          document.getElementById('bulkSaveBtn').disabled = true;
        }
      }catch(e){
        console.error(e); bulkMsg('تعذّر الحفظ الجماعي.', true);
      }
    });

    // فتح بطاقة الحيوان من وضع فردي
    // (موجود بالفعل فوق)
  </script>
</body>
</html>



