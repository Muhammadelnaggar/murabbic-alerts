<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- ستايل ونظام الفورم المركزي -->
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <title>تسجيل التلقيح — مُرَبِّيك</title>
</head>

<body>

  <header>
    <div class="mbk-head">
      <img class="mbk-logo" src="/images/logo.png" alt="مُرَبِّيك">
      <div class="mbk-center">
        <div class="mbk-page-title">تسجيل التلقيح</div>
        <div class="mbk-app-name">مُرَبِّيك</div>
      </div>
      <a class="mbk-back" href="add-event.html">رجوع</a>
    </div>
  </header>

  <script>window.dataLayer = window.dataLayer || [];</script>

  <main class="mbk-form">

    <div id="info" class="infobar"></div>

    <!-- الفورم المركزي -->
    <form id="eventForm"
          data-validate="true"
          data-event="تلقيح"
          autocomplete="off"
          novalidate>

      <label>رقم الحيوان *</label>
      <input data-field="animalNumber" inputmode="numeric" />

      <label>تاريخ التلقيح *</label>
      <input type="date" data-field="eventDate" />

      <label>طريقة التلقيح *</label>
      <select data-field="inseminationMethod">
        <option value="">اختر</option>
        <option>طبيعي</option>
        <option>اصطناعي</option>
      </select>

      <label>كود السائل المنوي *</label>
      <input data-field="semenCode" />

      <label>اسم الملقّح *</label>
      <input data-field="inseminator" />

      <label>وقت التلقيح *</label>
      <div class="radio-group">
        <label><input type="radio" name="inseminationTime" value="صباحا" data-field="inseminationTime"> صباحا</label>
        <label><input type="radio" name="inseminationTime" value="مساءا" data-field="inseminationTime"> مساءا</label>
      </div>

      <label>حالة الشياع *</label>
      <div class="radio-group">
        <label><input type="radio" name="heatStatus" value="صباحا" data-field="heatStatus"> صباحا</label>
        <label><input type="radio" name="heatStatus" value="مساءا" data-field="heatStatus"> مساءا</label>
      </div>

      <label>ملاحظات</label>
      <textarea data-field="notes"></textarea>

      <button type="submit" class="save-btn">حفظ التلقيح</button>

      <button type="button" id="openCowCardBtn" class="save-btn"
              style="background:#f8fafc;color:#0f172a;border:1px solid #cbd5e1;margin-top:10px;">
        فتح بطاقة الحيوان
      </button>

    </form>

  </main>

  <!-- Firebase & النظام -->
  <script type="module" src="/js/firebase-config.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>
  <script src="/js/app-core.js"></script>

  <!-- منطق الحفظ بعد الفاليديشن -->
  <script type="module">
  import { db } from "/js/firebase-config.js";
  import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  /* تعبئة الرقم والتاريخ من الرابط */
  const p = new URLSearchParams(location.search);
  document.querySelector('[data-field="animalNumber"]').value = p.get("number") || "";
  document.querySelector('[data-field="eventDate"]').value = p.get("eventDate") || p.get("date") || "";

  /* انتظار الفاليديشن المركزي */
  document.addEventListener("mbk:valid", async (e) => {
    if (e.detail?.eventType !== "تلقيح") return;

    const d = e.detail.formData;

    const payload = {
      userId: localStorage.getItem("userId"),
      eventType: "insemination",
      type: "insemination",
      animalNumber: d.animalNumber,
      eventDate: d.eventDate,
      inseminationMethod: d.inseminationMethod,
      semenCode: d.semenCode,
      inseminator: d.inseminator,
      inseminationTime: d.inseminationTime,
      heatStatus: d.heatStatus,
      notes: d.notes || null,
      createdAt: serverTimestamp(),
      source: location.pathname
    };

    try {
      await addDoc(collection(db, "events"), payload);
      document.getElementById("info").innerHTML = "✅ تم حفظ التلقيح بنجاح";
      setTimeout(() => location.href = `add-event.html?number=${d.animalNumber}`, 1200);
    } catch (err) {
      document.getElementById("info").innerHTML = "❌ فشل الحفظ";
    }
  });
  </script>

</body>
</html>
