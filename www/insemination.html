<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุชุณุฌูู ุชูููุญ</title>
  <link rel="stylesheet" href="css/style.css" />

  <!-- ุชุชุจุน ุฃุณุงุณู -->
  <script>window.dataLayer = window.dataLayer || [];</script>
</head>
<body>
  <header>
    <h1>๐ ุชุณุฌูู ุญุฏุซ: ุชูููุญ</h1>
  </header>

  <main>
    <form id="inseminationForm">
      <label for="animalId">ุฑูู ุงูุญููุงู:</label>
      <input type="text" id="animalId" name="animalId" required />

      <label for="eventDate">ุชุงุฑูุฎ ุงูุชูููุญ:</label>
      <input type="date" id="eventDate" name="eventDate" required />

      <label for="bullName">ุงุณู/ููุฏ ุงูุทูููุฉ:</label>
      <input type="text" id="bullName" name="bullName" />

      <label for="heatTime">ุชูููุช ุงูุดุจู:</label>
      <select id="heatTime" name="heatTime">
        <option value="am">ุตุจุงุญ</option>
        <option value="pm">ูุณุงุก</option>
      </select>

      <button type="submit">๐พ ุญูุธ ุงูุชูููุญ</button>
    </form>

    <div id="msg" style="margin-top:1rem; color:green;"></div>
  </main>

  <!-- ===== ุณูุฑุจุชุงุช ูุฑุจูู ุญุณุจ ุงูู Check-List ===== -->
  <script src="js/app-core.js"></script>
  <script type="module" src="js/timeline.js"></script>
  <script type="module" src="js/smart-checks.js"></script>
  <script src="js/tenant-bootstrap.js"></script>
  <script src="js/api.js"></script>
  <script type="module" src="js/firebase-config.js"></script>
  <script src="js/smart-alerts.js"></script>
  <script src="js/event-core.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ุชุนุจุฆุฉ ุงูุญููู ูู ุงูุณูุงู (animalId, date)
      const QS = new URLSearchParams(location.search);
      const animalId = QS.get("animalId") || localStorage.getItem("lastAnimalId") || "";
      const dt = QS.get("date") || localStorage.getItem("lastEventDate") || new Date().toISOString().slice(0,10);
      document.getElementById("animalId").value = animalId;
      document.getElementById("eventDate").value = dt;

      // ุชุณุฌูู Page View
      if (window.t?.event) t.event("page_view", {page:"insemination"});
      
      // ูุนุงูุฌุฉ ุงูููุฑู
      document.getElementById("inseminationForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const data = {
          type: "ุชูููุญ",
          animalId: document.getElementById("animalId").value,
          eventDate: document.getElementById("eventDate").value,
          bullName: document.getElementById("bullName").value,
          heatTime: document.getElementById("heatTime").value,
          source: "insemination.html"
        };

        try {
          await saveEvent(data);  // ูู event-core.js
          document.getElementById("msg").textContent = "โ ุชู ุญูุธ ุงูุชูููุญ ุจูุฌุงุญ";

          // ุชุชุจุน
          if (window.t?.event) t.event("insemination_save", data);

          // ุชุดุบูู ุงูููุงุนุฏ ุงูุฐููุฉ
          smart.startAlertsWatcher({
            userId: localStorage.getItem("userId"),
            onAlert: (a) => smartAlerts.show(a.message, a.severity || "info")
          });

          // ุญูุธ ุงูุณูุงู
          localStorage.setItem("lastAnimalId", data.animalId);
          localStorage.setItem("lastEventDate", data.eventDate);

        } catch (err) {
          console.error("ูุดู ุญูุธ ุงูุชูููุญ:", err);
          document.getElementById("msg").textContent = "โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ";
          document.getElementById("msg").style.color = "red";
        }
      });
    });
  </script>
</body>
</html>
