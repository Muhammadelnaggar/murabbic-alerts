<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تسجيل حدث التلقيح — مُرَبِّك</title>
  <style>
    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff; --danger:#c2410c }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Segoe UI','Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0}
    .bar{max-width:920px;margin:0 auto;padding:12px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .title{font-weight:700;color:var(--green-600)}
    main{max-width:920px;margin:16px auto;padding:16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    label{font-weight:600;font-size:14px;color:#0f172a}
    input,select{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:15px}
    .row{display:grid;gap:12px}
    @media(min-width:720px){.row{grid-template-columns:repeat(3,1fr)}}
    .radio-group{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:4px}
    .actions{display:flex;gap:10px;justify-content:stretch;margin-top:12px}
    button{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
    .save{background:var(--green);color:#fff}
    .ghost{background:#eef2f7;color:#0f172a}
    .infobar{display:none;margin-top:12px;padding:12px;border-radius:10px;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .infobar.show{display:block}
    .error{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
  </style>
</head>
<body>
  <script>window.dataLayer = window.dataLayer || [];</script>

  <header>
    <div class="bar">
      <div class="title">تسجيل حدث التلقيح</div>
      <a class="ghost" href="add-event.html" style="text-decoration:none;padding:10px 12px;border-radius:10px">عودة للأحداث</a>
    </div>
  </header>

  <main>
    <div class="card grid" id="formCard">
      <div class="row">
        <div>
          <label>رقم الحيوان <span style="color:red">*</span></label>
          <input id="animalNumber" inputmode="numeric" placeholder="مثال: 1023" required />
        </div>
        <div>
          <label>تاريخ التلقيح <span style="color:red">*</span></label>
          <input id="eventDate" type="date" required />
        </div>
        <div>
          <label>طريقة التلقيح <span style="color:red">*</span></label>
          <select id="inseminationMethod" required>
            <option value="">اختر...</option>
            <option value="طبيعي">طبيعي</option>
            <option value="اصطناعي">اصطناعي</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>كود السائل المنوي <span style="color:red">*</span></label>
          <input id="semenCode" placeholder="مثال: BULL123" required />
        </div>
        <div>
          <label>اسم الملقّح <span style="color:red">*</span></label>
          <input id="inseminator" placeholder="اسم الملقّح" required list="inseminatorsList" />
          <datalist id="inseminatorsList"></datalist>
        </div>
        <div>
          <label>وقت التلقيح <span style="color:red">*</span></label>
          <div class="radio-group">
            <label><input type="radio" name="inseminationTime" value="صباحا" required /> صباحا</label>
            <label><input type="radio" name="inseminationTime" value="مساءا" /> مساءا</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>حالة الشياع <span style="color:red">*</span></label>
          <div class="radio-group">
            <label><input type="radio" name="heatStatus" value="صباحا" required /> صباحا</label>
            <label><input type="radio" name="heatStatus" value="مساءا" /> مساءا</label>
          </div>
        </div>
        <div>
          <label>ملاحظات</label>
          <input id="notes" placeholder="اختياري" />
        </div>
      </div>

      <div class="actions">
        <button type="button" class="save" id="saveBtn" onclick="window.__onSave && window.__onSave()">حفظ التلقيح ✅</button>
        <button class="ghost" id="toCardBtn">فتح بطاقة الحيوان</button>
      </div>

      <div id="info" class="infobar"></div>
    </div>
  </main>

  <!-- ترتيب التحميل -->
  <script type="module" src="/js/firebase-config.js"></script>
  <script src="/js/app-core.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>

  <script type="module">
    const $ = (id)=>document.getElementById(id);

    // تتبع + أدوات مساعدة
   function track(e,p={}) {
  try { window.t?.event?.(e,p); } catch(_) {}
  try { (window.dataLayer = window.dataLayer || []).push({ event:e, ...p }); } catch(_) {}
  try { console.debug('[track]', e, p); } catch(_) {}
}

    const addDaysISO=(iso,n)=>{ const d=new Date(iso); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); };

    // سياق
    function getQuery(){ const p=new URLSearchParams(location.search); return Object.fromEntries(p.entries()); }
    function getCtx(){
      const q = getQuery();
      const norm = v => (v==null || v==='undefined' || v==='null' || v==='NaN') ? '' : String(v).trim();
      const today = new Date().toISOString().slice(0,10);
      let date = norm(q.date || q.eventDate || localStorage.getItem('lastEventDate') || today);
      if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) date = today;
      return {
        animalNumber: norm(q.number || q.animalNumber || localStorage.getItem('currentAnimalNumber') || ''),
        eventDate: date
      };
    }

    const ctx = getCtx();
    $('animalNumber').value = ctx.animalNumber;
    $('eventDate').value = ctx.eventDate;

    track('insemination_page_open',{number:$('animalNumber').value||undefined,date:$('eventDate').value,path:location.pathname});

    // اقتراح/تتبّع تغييرات مهمة
    $('inseminationMethod')?.addEventListener('change', e=>track('insemination_method_change',{method:e.target.value}));
    document.querySelectorAll('input[name="inseminationTime"]').forEach(r=>r.addEventListener('change',()=>{
      const v=document.querySelector('input[name="inseminationTime"]:checked')?.value; track('insemination_time_change',{time:v});
    }));
    document.querySelectorAll('input[name="heatStatus"]').forEach(r=>r.addEventListener('change',()=>{
      const v=document.querySelector('input[name="heatStatus"]:checked')?.value; track('insemination_heat_change',{heat:v});
    }));

    // تحميل مقترحات أسماء الملقّحين
    (async function loadInseminators(){
      try{
        const uid = localStorage.getItem('userId') || localStorage.getItem('tenantId') || '';
        if(!uid) return;
        const { getFirestore, collection, query, where, orderBy, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const db = getFirestore();
        const qry = query(collection(db, 'inseminators'), where('userId','==', uid), orderBy('lastUsedAt','desc'), limit(25));
        const snap = await getDocs(qry);
        const set = new Set();
        const list = document.getElementById('inseminatorsList');
        list.innerHTML = '';
        snap.forEach(doc=>{ const n = doc.data()?.name; if(n && !set.has(n)){ set.add(n); const opt=document.createElement('option'); opt.value=n; list.appendChild(opt);} });
      }catch(e){ console.warn('loadInseminators skipped', e); }
    })();

    // فتح البطاقة
    $('toCardBtn').addEventListener('click', ()=>{
      const norm = v => (v==null || v==='undefined' || v==='null') ? '' : String(v).trim();
      const number = norm($('animalNumber').value) || norm(ctx.animalNumber) || '';
      if(!number){ return showMsg('من فضلك أدخل رقم الحيوان لفتح البطاقة', true); }
      location.href = `cow-card.html?number=${encodeURIComponent(number)}`;
    });

    // حفظ
    // ضمان وجود API محلي حتى لو app-core.js ما حمّلش
if (!window.api || typeof window.api.post !== 'function') {
  window.api = {
    async post(){ return { ok:true }; } // فالباك لا يمنع الحفظ في فايرستور
  };
}

    async function onSave(){
      try{
        const animalNumber = $('animalNumber').value.trim();
        const eventDate = $('eventDate').value;
        const inseminator = $('inseminator').value.trim();
        const semenCode = $('semenCode').value.trim();
        const inseminationMethod = $('inseminationMethod').value;
        const inseminationTime = document.querySelector('input[name="inseminationTime"]:checked')?.value;
        const heatStatus = document.querySelector('input[name="heatStatus"]:checked')?.value;

        track('insemination_save_attempt',{number:animalNumber,date:eventDate,method:inseminationMethod});

        if(!animalNumber || !eventDate || !inseminator || !semenCode || !inseminationMethod || !inseminationTime || !heatStatus){
          return showMsg('جميع الحقول مطلوبة ماعدا الملاحظات', true);
        }
        const today = new Date().toISOString().slice(0,10);
        if(eventDate > today){ return showMsg('تاريخ التلقيح لا يمكن أن يكون في المستقبل', true); }

        // بناء الحمولة
        const payload = {
          type: 'تلقيح',
          eventType: 'insemination',
          eventDate,
          animalNumber,
          number: animalNumber,
          inseminationMethod,
          semenCode,
          inseminator,
          inseminationTime,
          heatStatus,
          source: location.pathname
        };
        const notesVal = $('notes').value.trim();
        if (notesVal) payload.notes = notesVal;

        // تنظيف من أي undefined/null
        const cleanPayload = Object.fromEntries(Object.entries(payload).filter(([,v]) => v !== undefined && v !== null));

        // API (اختياري)
      // API (اختياري)
try {
  if (window.api?.post) {
    await window.api.post('/api/events', cleanPayload);
  }
} catch (e) {
  console.warn('API error', e);
}


        // Firestore
        try{
          const { getFirestore, collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
          const db = getFirestore();
          await addDoc(collection(db, 'events'), { ...cleanPayload, createdAt: serverTimestamp() });

          // حفظ اسم الملقّح للاقتراحات لاحقًا
          const uid = localStorage.getItem('userId') || localStorage.getItem('tenantId') || '';
          if(uid && inseminator){
            await addDoc(collection(db, 'inseminators'), {
              name: inseminator,
              userId: uid,
              lastUsedAt: serverTimestamp()
            });
          }
        }catch(e){
          console.warn('Firestore save failed', e);
          track('insemination_save_fail',{error:String(e)});
          return showMsg('تعذّر الحفظ في فايرستور — جرّب لاحقًا', true);
        }

        // تحديث محلي + اقتراحات ذكية
        localStorage.setItem('lastEventDate', eventDate);
        localStorage.setItem('currentAnimalNumber', animalNumber);
        localStorage.setItem('lastAnimalNumber', animalNumber);

        const suggestions = [
          `موعد فحص حمل مقترح: ${addDaysISO(eventDate,30)}`,
          `متابعة شياع بعد 21 يوم: ${addDaysISO(eventDate,21)}`
        ];
        track('insemination_save_success',{number:animalNumber,date:eventDate,suggestions});
        showMsg(`✅ تم حفظ حدث التلقيح بنجاح. يمكنك المتابعة أو فتح البطاقة.\nاقتراحات: ${suggestions.join('، ')}`, false);

      }catch(err){
        console.error(err);
        track('insemination_save_fail',{error:String(err)});
        showMsg('حدث خطأ غير متوقع أثناء الحفظ', true);
      }
    }

    // ربط الزر + Fallback للـ onclick
    window.__onSave = onSave;
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('saveBtn')?.addEventListener('click', onSave);
    });

    // رسائل
    function showMsg(text, isError){
      const el = $('info');
      el.className = 'infobar ' + (isError ? 'show error' : 'show');
      el.textContent = text;
    }
  </script>

  <!-- طبقة توافق: التقاط number/date من URL أو التخزين -->
  <script type="module">
    const $ = id => document.getElementById(id);
    const norm = v => (v==null || v==='undefined' || v==='null' || v==='NaN') ? '' : String(v).trim();
    const qs = new URLSearchParams(location.search);

    let number = norm(qs.get('number') || qs.get('animalNumber') || localStorage.getItem('currentAnimalNumber') || localStorage.getItem('lastAnimalNumber'));
    let eventDate = norm(qs.get('date') || qs.get('eventDate') || localStorage.getItem('lastEventDate') || new Date().toISOString().slice(0,10));
    if(!/^\d{4}-\d{2}-\d{2}$/.test(eventDate)) eventDate = new Date().toISOString().slice(0,10);

    if ($('animalNumber')) {
      const cur = ($('animalNumber').value || '').trim();
      if (cur === '' || cur === 'undefined' || cur === 'null') $('animalNumber').value = number || '';
    }
    if ($('eventDate')) {
      const curD = ($('eventDate').value || '').trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(curD)) $('eventDate').value = eventDate || new Date().toISOString().slice(0,10);
    }

    if (!qs.get('number') || !qs.get('date')) {
      console.warn('[insemination] opened without full params', location.pathname, [...qs.entries()]);
    }

    if (number)   { localStorage.setItem('currentAnimalNumber', number); localStorage.setItem('lastAnimalNumber', number); }
    if (eventDate){ localStorage.setItem('lastEventDate', eventDate); }
  </script>
  <!-- سكربت حفظ حدث التلقيح: ضعيه بعد سكربت التهيئة مباشرة، وقبل </body> -->
<script type="module">
  import { db, ensureAuth } from "./js/firebase-config.js";
  import { addDoc, collection, serverTimestamp }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // اسم مجموعة الأحداث (من localStorage لو موجود)
  const COL = localStorage.getItem("events_collection") || "events";

  // جلب الفورم (عدّلي الـid لو اسمك مختلف)
  const form =
    document.getElementById("inseminationForm") ||
    document.getElementById("eventForm");

  // أدوات صغيرة للقراءة
  const v  = sel => (document.querySelector(sel)?.value || "").trim();
  const dv = sel =>  document.querySelector(sel)?.value || "";
  const ch = name => (document.querySelector(`input[name="${name}"]:checked`)?.value || "");
  const todayLocal = () => {
    const d = new Date(); d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  };

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const animalNumber = v("#animalNumber");
    // يدعم أي id: eventDate أو inseminationDate
    const date         = dv("#eventDate") || dv("#inseminationDate") || todayLocal();
    const method       = v("#method");
    const semenCode    = v("#semenCode");
    const inseminator  = v("#inseminator");
    const timeOfDay    = ch("time");
    const heatState    = ch("heat");
    const notes        = v("#notes");
    const userId       = localStorage.getItem("userId") || null;

    if (!animalNumber || !date || !method || !semenCode || !inseminator) {
      alert("أكملي الحقول المطلوبة (*)"); return;
    }

    try {
      await ensureAuth();

      const payload = {
        type: "insemination",
        animalNumber, date, method,
        semenCode, inseminator, timeOfDay, heatState,
        notes: notes || null,
        userId,
        createdAt: serverTimestamp()
      };

      const ref = await addDoc(collection(db, COL), payload);

      // رسالة تأكيد أنيقة داخل النموذج (لو flashOK موجود)
      if (window.flashOK) {
        window.flashOK("تم تسجيل حدث التلقيح بنجاح ✅");
      }

      // توجيه لطيف بعد التأكيد
      setTimeout(() => {
        location.href = `events.html?number=${encodeURIComponent(animalNumber)}`;
      }, 900);

      console.log("saved to", COL, "id=", ref.id);
    } catch (err) {
      console.error("[insemination save]", err);
      alert("تعذر الحفظ في فايربيز. تحققي من الاتصال والصلاحيات.");
    }
  });
</script>

</body>
</html>



