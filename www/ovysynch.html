<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <!-- (Ù‡Ù†Ø±Ø¬Ø¹ Ù„Ù…Ù„Ø§Ø­Ø¸Ø© animal-update.js Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§) -->
  <script type="module">
    import { updateAnimalByEvent } from "/js/animal-update.js";
    window.updateAnimalByEvent = updateAnimalByEvent;
  </script>

  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <title>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¶ ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</title>

  <style>
    body{
      margin:0;padding:0;
      background: var(--bg, #f7faf7);
      color: var(--text, #0f172a);
      font-family:'Cairo',Tahoma,Arial,sans-serif;
      direction: rtl;
    }

    header{
      position: sticky; top: 0; z-index: 20;
      background: #fff;
      border-bottom: 1px solid var(--border, #e2e8f0);
    }
    .mbk-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px;
    }
    .mbk-logo{ height:48px; width:auto; object-fit:contain; opacity:.95; flex-shrink:0; }
    .mbk-center{ flex:1; text-align:center; line-height:1.2; }
    .mbk-page-title{ font-size:18px; font-weight:900; color: var(--ink, #0f172a); }
    .mbk-app-name{ font-size:13px; font-weight:800; color: var(--brand-600, #0b7f47); opacity:.9; }
    .mbk-back{
      width:42px; height:42px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      text-decoration:none; font-weight:900;
      color: var(--brand-600, #0b7f47);
      border:2px solid var(--brand-600, #0b7f47);
      background:#fff; flex-shrink:0;
    }

    .wrap{ max-width:520px; margin:12px auto 24px; padding:0 12px; }
    .mbk-card{
      background:#fff;
      border:1px solid var(--border, #e2e8f0);
      border-radius:16px;
      padding:14px;
      box-shadow:0 1px 0 rgba(15,23,42,.04);
    }

    .row{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:640px){ .row-2{ grid-template-columns:1fr 1fr; } }

    .hint{ font-size:12px; opacity:.65; line-height:1.4; }

    .steps{
      margin-top:12px;
      border:1px solid var(--border, #e2e8f0);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .step{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px;
      border-bottom:1px dashed var(--border, #e2e8f0);
    }
    .step:last-child{ border-bottom:none; }
    .step .name{ font-weight:900; }
    .step .date{ font-size:13px; opacity:.85; white-space:nowrap; }
    .step .chk{ display:flex; align-items:center; gap:8px; justify-content:flex-start; }
    .step input[type="checkbox"]{ width:18px; height:18px; }

    #warn{ margin-top:10px; color:#b91c1c; font-weight:800; min-height:18px; }

   #sysbar.infobar{
      display:none;
      position: sticky;
      top: 72px;
      z-index: 19;
      margin: 10px 0 10px;
    }
   #sysbar .msgrow{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
#sysbar .okbtn{
  flex-shrink:0;
  border-radius:12px;
  padding:8px 12px;
  font-weight:900;
  border:2px solid var(--brand-600, #0b7f47);
  background:#fff;
  color: var(--brand-600, #0b7f47);
  cursor:pointer;
}


    .btn-row{
      position: sticky;
      bottom: 10px;
      background: #fff;
      padding: 10px;
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 16px;
      display:flex;
      gap:10px;
      margin:14px 12px 18px;
      max-width:520px;
      margin-left:auto; margin-right:auto;
    }
    .btn-row .save-btn,
    .btn-row .open-card{
      flex:1; width:auto;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    .btn-row .save-btn{
      background: var(--brand, #0ea05a);
      color:#fff; border:0;
    }
    .btn-row .open-card{
      background:#fff !important;
      color: var(--brand-600, #0b7f47) !important;
      border:2px solid var(--brand-600, #0b7f47) !important;
    }

    /* âœ… Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¶Ø¹ */
    #modeBulkBox[hidden],
    #modeSingleBox[hidden]{ display:none !important; }
  </style>
</head>

<body>
  <header>
    <div class="mbk-head">
      <a class="mbk-back" href="add-event.html" title="Ø±Ø¬ÙˆØ¹">Ø±Ø¬ÙˆØ¹</a>

      <div class="mbk-center">
        <div class="mbk-page-title">Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªØ²Ø§Ù…Ù† ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­</div>
        <div class="mbk-app-name">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
      </div>

      <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
    </div>
  </header>

  <div class="wrap">
   <div id="sysbar" class="infobar"></div>
    <div class="mbk-card">
      <form id="ovForm" autocomplete="off" data-validate="true" data-event="Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†">
        <!-- âœ… Ø­Ù‚ÙˆÙ„ Ø±Ø¨Ø· Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ -->
        <input type="hidden" id="animalNumber" data-field="animalNumber" value="">
        <input type="hidden" id="eventDate" data-field="eventDate" value="">
        <input type="hidden" id="species" data-field="species" value="">
        <input type="hidden" id="steps" data-field="steps" value="">
        <input type="hidden" id="animalId" data-field="animalId" value="">

        <!-- âœ… Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ÙØ±Ø¯ÙŠ / Ù…Ø¬Ù…ÙˆØ¹Ø© -->
        <div class="field" style="margin-bottom:12px">
          <div style="display:flex;gap:12px;align-items:center;font-weight:900">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="radio" name="mbkMode" id="modeSingle" value="single" checked>
              â¬¤ ØªØ³Ø¬ÙŠÙ„ Ù„Ø­ÙŠÙˆØ§Ù† ÙˆØ§Ø­Ø¯
            </label>

            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="radio" name="mbkMode" id="modeGroup" value="group">
              â¬¤ ØªØ³Ø¬ÙŠÙ„ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø­ÙŠÙˆØ§Ù†Ø§Øª
            </label>
          </div>
          <div class="hint" id="modeHint" style="margin-top:6px">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹â€¦ ÙˆØ§Ù„ØµÙØ­Ø© Ø³ØªÙØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
        </div>

        <!-- âœ… ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
        <div id="modeBulkBox" hidden>
          <div class="row" style="margin-bottom:12px">
            <div class="field">
              <label for="bulkAnimals">Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ (ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø±)</label>
              <textarea id="bulkAnimals" rows="4" placeholder="Ù…Ø«Ø§Ù„:
105
106
110"></textarea>
              <div class="hint">Ù„Ùˆ ÙƒØªØ¨Øª Ù‡Ù†Ø§: Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù….</div>
            </div>

            <button id="applyBulk" type="button" class="open-card" style="width:100%;margin-top:6px">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            <div class="hint" id="bulkHint" style="margin-top:6px;opacity:.75"></div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label for="groupSelect">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</label>
              <select id="groupSelect">
                <option value="" selected>â€” Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© â€”</option>
              </select>
              <div class="hint">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ù†ÙØ³ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©).</div>
            </div>

            <div class="row row-2">
              <button id="loadGroup" type="button" class="open-card">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
              <button id="saveGroup" type="button" class="open-card">Ø­ÙØ¸ ÙƒÙ€ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
            </div>
          </div>
        </div>

        <!-- âœ… ÙˆØ¶Ø¹ Ø§Ù„ÙØ±Ø¯ÙŠ -->
        <div id="modeSingleBox">
          <div class="field">
            <label for="animalNumberUI">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
            <input id="animalNumberUI" type="text" placeholder="Ù…Ø«Ø§Ù„: 105" />
          </div>
        </div>

        <div class="row row-2" style="margin-top:12px">
          <div class="field">
            <label for="startDate">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ (Ø§Ù„ÙŠÙˆÙ… 0)</label>
            <input id="startDate" type="date" />
          </div>

          <div class="field">
            <label for="startTime">Ø³Ø§Ø¹Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</label>
            <input id="startTime" type="time" value="08:00" />
            <div class="hint">Ù…Ø«Ø§Ù„: 08:00 ØµØ¨Ø§Ø­Ù‹Ø§ â€” Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="field">
            <label for="program">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
            <select id="program" data-field="program">
              <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</option>
              <option value="ovsynch">Ovsynch</option>
              <option value="cosynch72">Cosynch-72</option>
              <option value="presynch_ovsynch">Presynch + Ovsynch</option>
            </select>
            <div class="muted hint">Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© âœ“ Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° ÙƒÙ„ Ø®Ø·ÙˆØ©.</div>
          </div>
        </div>

        <div id="stepsBox" class="steps" aria-live="polite"></div>
        <div id="warn"></div>

        <!-- Ù…Ù‡Ù… Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ -->
        <button type="submit" id="hiddenSubmit" style="display:none"></button>
      </form>
    </div>
  </div>

  <div class="btn-row">
    <button id="saveBtn" class="save-btn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</button>
    <button id="openCowCard" class="open-card" type="button">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, serverTimestamp, doc, setDoc, getDoc,
  query, where, getDocs, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

(async () => {
  const form        = document.getElementById('ovForm');
  const animalUI    = document.getElementById('animalNumberUI');
  const startDateEl = document.getElementById('startDate');
  const startTimeEl = document.getElementById('startTime');
  const bulkEl      = document.getElementById('bulkAnimals');
  const applyBulk   = document.getElementById('applyBulk');
  const programEl   = document.getElementById('program');
  const stepsBox    = document.getElementById('stepsBox');
  const saveBtn     = document.getElementById('saveBtn');
  const openCowCard = document.getElementById('openCowCard');
const infoEl      = document.getElementById('sysbar');
  const warnEl      = document.getElementById('warn');

  const modeSingle  = document.getElementById('modeSingle');
  const modeGroup   = document.getElementById('modeGroup');
  const modeBulkBox = document.getElementById('modeBulkBox');
  const modeSingleBox = document.getElementById('modeSingleBox');

  const animalHidden = document.getElementById("animalNumber");
  const eventHidden  = document.getElementById("eventDate");
  const stepsHidden  = document.getElementById("steps");

  let dbRef=null, authRef=null, stepsState=[], bulkList=[];
  let fbReady = false;

  /* ========= Helpers ========= */
  function todayISO(){
    const d=new Date();
    d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  }
  function showWarn(t){ warnEl.textContent=t||""; }
  function clearWarn(){ warnEl.textContent=""; }

  function showInfo(text, isErr=false){
    infoEl.style.display="block";
    infoEl.className="infobar "+(isErr?"error":"show");
    infoEl.innerHTML=`
      <div class="msgrow">
        <div style="white-space:pre-line">${text}</div>
        <button type="button" class="okbtn" onclick="this.closest('#sysbar').style.display='none'">Ø­Ø³Ù†Ù‹Ø§</button>
      </div>`;
    infoEl.scrollIntoView({behavior:"smooth",block:"start"});
  }

  function parseBulk(){
    const raw=(bulkEl?.value||"").trim();
    if(!raw){ bulkList=[]; return []; }
    const arr=raw.split(/\n|,|;/g).map(x=>x.trim()).filter(Boolean);
    bulkList=[...new Set(arr)];
    return bulkList;
  }

  function normSpecies(sp){
    sp = String(sp || "").trim();
    if (/cow|Ø¨Ù‚Ø±/i.test(sp)) return "Ø£Ø¨Ù‚Ø§Ø±";
    if (/buffalo|Ø¬Ø§Ù…ÙˆØ³/i.test(sp)) return "Ø¬Ø§Ù…ÙˆØ³";
    return sp || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  }
  function animalWordFromSpecies(sp){ return (sp === "Ø¬Ø§Ù…ÙˆØ³") ? "Ø¬Ø§Ù…ÙˆØ³Ø©" : "Ø¨Ù‚Ø±Ø©"; }

  function daysBetweenISO(a, b){
    const d1 = new Date(String(a||"").slice(0,10));
    const d2 = new Date(String(b||"").slice(0,10));
    if (Number.isNaN(d1.getTime()) || Number.isNaN(d2.getTime())) return NaN;
    d1.setHours(0,0,0,0); d2.setHours(0,0,0,0);
    return Math.round((d2 - d1) / 86400000);
  }

  function getMode(){
    return (modeGroup.checked ? "group" : "single");
  }
  function setMode(m){
    const isGroup = (m === "group");
    modeGroup.checked = isGroup;
    modeSingle.checked = !isGroup;
    modeBulkBox.hidden = !isGroup;
    modeSingleBox.hidden = isGroup;
    try{ localStorage.setItem("mbk_ov_mode", isGroup ? "group" : "single"); }catch{}
    clearWarn();
  }

  function syncCentral(){
    const first=(getMode()==="group" ? (parseBulk()[0]||"") : (animalUI.value||"")).trim();
    animalHidden.value=first;
    eventHidden.value=(startDateEl.value||"").trim();
    stepsHidden.value=JSON.stringify(stepsState||[]);
  }

  openCowCard.addEventListener("click", () => {
    const num = (getMode()==="group" ? (parseBulk()[0]||"") : (animalUI.value||"")).trim();
    if (!num) { showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø£ÙˆÙ„Ù‹Ø§."); return; }
    location.href = `cow-card.html?number=${encodeURIComponent(num)}`;
  });

  // âœ… Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Today ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  if (!startDateEl.value) startDateEl.value = todayISO();

  // âœ… Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ± Ø§Ù„ÙˆØ¶Ø¹ + Ø§Ù„Ø±Ù‚Ù…/Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ­Ù‚Ù‚)
  (function hydrateFromURL(){
    const qp = new URLSearchParams(location.search);

    const m = (qp.get("mbkMode") || "").trim().toLowerCase();
    const saved = (localStorage.getItem("mbk_ov_mode") || "single");
    setMode(m === "group" ? "group" : saved);

    const num = (qp.get("number") || qp.get("animalNumber") || "").trim();
    const dt  = (qp.get("date") || qp.get("eventDate") || "").trim();

    if (num) animalUI.value = num;
    if (dt)  startDateEl.value = dt || todayISO();

    syncCentral();
  })();

  modeSingle.addEventListener("change", ()=>setMode("single"));
  modeGroup.addEventListener("change", ()=>setMode("group"));

  animalUI.addEventListener("input",syncCentral);
  bulkEl?.addEventListener("input",syncCentral);
  startDateEl.addEventListener("input",syncCentral);

  /* ========= Programs ========= */
  const PROGRAMS = {
    ovsynch: [
      { day: 0,  name: "GnRH (Ø§Ù„ÙŠÙˆÙ… 0)" },
      { day: 7,  name: "PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)" },
      { day: 9,  name: "GnRH (Ø§Ù„ÙŠÙˆÙ… 9)" },
      { day: 10, name: "ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10)" },
    ],
    cosynch72: [
      { day: 0,  name: "GnRH (Ø§Ù„ÙŠÙˆÙ… 0)" },
      { day: 7,  name: "PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)" },
      { day: 10, name: "GnRH + ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Cosynch-72) (Ø§Ù„ÙŠÙˆÙ… 10)" },
    ],
    presynch_ovsynch: [
      { day: 0,  name: "PGF2Î± (Presynch 1) (Ø§Ù„ÙŠÙˆÙ… 0)" },
      { day: 14, name: "PGF2Î± (Presynch 2) (Ø§Ù„ÙŠÙˆÙ… 14)" },
      { day: 28, name: "GnRH (Ovsynch) (Ø§Ù„ÙŠÙˆÙ… 28)" },
      { day: 35, name: "PGF2Î± (Ovsynch) (Ø§Ù„ÙŠÙˆÙ… 35)" },
      { day: 37, name: "GnRH (Ovsynch) (Ø§Ù„ÙŠÙˆÙ… 37)" },
      { day: 38, name: "ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ovsynch) (Ø§Ù„ÙŠÙˆÙ… 38)" },
    ],
  };

  function updateSteps(){
    stepsBox.innerHTML='';
    const start=startDateEl.value, program=programEl.value;
    if(!start||!program) { stepsState=[]; syncCentral(); return; }

    stepsState=(PROGRAMS[program]||[]).map(s=>{
      const d=new Date(start+"T"+(startTimeEl.value||"08:00"));
      d.setDate(d.getDate()+s.day);
      return { day:s.day, name:s.name, date:d.toISOString().slice(0,16), done:false };
    });

    for (let i=0;i<stepsState.length;i++){
      const st = stepsState[i];
      const row=document.createElement("div");
      row.className="step";
      row.innerHTML=`
        <div>
          <div class="name">${st.name}</div>
          <div class="date">ğŸ“… ${new Date(st.date).toLocaleString('ar-EG')}</div>
        </div>
        <label class="chk">
          <input type="checkbox" data-i="${i}">
          ØªÙ…
        </label>`;
      stepsBox.appendChild(row);
    }
    syncCentral();
  }

  stepsBox.addEventListener("change",(e)=>{
    const i=e.target?.dataset?.i;
    if(i===undefined) return;
    stepsState[i].done=!!e.target.checked;
    syncCentral();
  });

  programEl.addEventListener("change",updateSteps);
  startDateEl.addEventListener("change",updateSteps);
  startTimeEl.addEventListener("change",updateSteps);

  /* ========= Firebase (Robust) ========= */
  async function waitUser(ms=1500){
    return await new Promise(res=>{
      const t=setTimeout(()=>res(authRef?.currentUser||null),ms);
      onAuthStateChanged(authRef,u=>{ clearTimeout(t); res(u||null); });
    });
  }

  async function initFirebase(){
    try{
      const mod = await import('/js/firebase-config.js');

      const cfg = mod.firebaseConfig || mod.config || mod.default || null;
      const app = (cfg ? initializeApp(cfg) : (mod.app || null));

      dbRef   = mod.db   || getFirestore(app, "murabbikdata");
      authRef = mod.auth || getAuth(app);

      window.mbk = window.mbk || {};
      fbReady = true;
      return true;
    }catch(e){
      fbReady = false;
      showInfo("â›” ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Firebase ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.\nØ§ÙØªØ­ Console > Network ÙˆØªØ£ÙƒØ¯ Ø£Ù† /js/firebase-config.js Ù…ÙˆØ¬ÙˆØ¯.", true);
      return false;
    }
  }

  await initFirebase();

  async function fetchAnimalDoc(uid, num){
    const qA = query(
      collection(dbRef, "animals"),
      where("userId", "==", uid),
      where("number", "==", String(num)),
      limit(1)
    );
    const sA = await getDocs(qA);
    if (sA.empty) return null;
    return { id: sA.docs[0].id, data: sA.docs[0].data() || {} };
  }

  async function getLastOvsynchForAnimal(uid, animalNumber){
    const num = String(animalNumber || "").trim();
    if (!uid || !num) return null;

    const qx = query(
      collection(dbRef, "events"),
      where("userId", "==", uid),
      where("animalNumber", "==", num),
      where("eventType", "==", "Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†"),
      where("program", "==", "ovsynch"),
      orderBy("eventDate", "desc"),
      limit(1)
    );

    const snap = await getDocs(qx);
    if (snap.empty) return null;

    const d = snap.docs[0].data() || {};
    return { eventDate: String(d.eventDate || "").slice(0,10), id: snap.docs[0].id };
  }

  // âœ… Apply Bulk (Ø¨Ø¹Ø¯ Ù…Ø§ Firebase Ø¨Ù‚Øª Ø¬Ø§Ù‡Ø²Ø©)
 
 applyBulk?.addEventListener("click", async () => {

  if (!fbReady) {
    showInfo("â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…â€¦ Ø¬Ø±Ù‘Ø¨ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©.", true);
    return;
  }

  const list = parseBulk();
  if (!list.length) {
    showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø£ÙˆÙ„Ù‹Ø§.");
    return;
  }

  const dt = (startDateEl.value || todayISO()).trim();

  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
  const r = await window.mbk.previewOvsynchList(list, dt);

  if (!r || r.ok === false) {
    showInfo("âš ï¸ ØªØ¹Ø°Ù‘Ø± ÙØ­Øµ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¢Ù†.", true);
    return;
  }

  const valid    = Array.isArray(r.valid) ? r.valid : [];
  const rejected = Array.isArray(r.rejected) ? r.rejected : [];

  // ğŸ”¥ Ø§Ù…Ø³Ø­ ØºÙŠØ± Ø§Ù„Ù…Ø¤Ù‡Ù„ÙŠÙ† ÙÙˆØ±Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  bulkList = valid;
  bulkEl.value = valid.join("\n");

  // âœï¸ Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ ÙƒÙ„ Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø¤Ù‡Ù„
  const details = rejected.map(x => {
    const num = String(x?.number ?? x?.animalNumber ?? "").trim();
    const rs  = String(x?.reason || "").trim();
    return num ? `âœ– Ø±Ù‚Ù… ${num}: ${rs}` : `âœ– ${rs}`;
  }).filter(Boolean);

  let msg =
    `ğŸ” ØªÙ… ÙØ­Øµ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©\n` +
    `âœ… Ù…Ù‚Ø¨ÙˆÙ„: ${valid.length}\n` +
    `ğŸš« Ù…Ø±ÙÙˆØ¶: ${rejected.length}`;

  if (details.length) {
    msg += `\n\nØ§Ù„Ø£Ø³Ø¨Ø§Ø¨:\n` + details.join("\n");
  }

  showInfo(msg, !valid.length);

  clearWarn();
  syncCentral();
});

/* ========= Tasks: Ovsynch Protocol ========= */
async function upsertOvsynchTasks(uid, animalNumber, startISO, program, stepsArr){
  if (!uid || !animalNumber || !startISO) return;

  const steps = Array.isArray(stepsArr) ? stepsArr : [];
  if (!steps.length) return;

  // Ù†ÙØ³ ID Ø§Ù„Ø­Ø¯Ø« Ø¹Ù†Ø¯Ùƒ
  const baseId = ["ovsynch", animalNumber, program, startISO].join("__");

  for (let i = 0; i < steps.length; i++){
    const st = steps[i] || {};
    const dueISO = String(st.date || "").slice(0,16); // "YYYY-MM-DDTHH:mm"
    const dueDate = dueISO ? dueISO.slice(0,10) : String(startISO).slice(0,10);

    // âœ… ID Ø«Ø§Ø¨Øª ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    const taskId = `${baseId}__step_${i}`;

    const taskPayload = {
      userId: uid,
      animalNumber: String(animalNumber),
      type: "ovsynch_step",
      protocolType: "ovsynch",
      protocolProgram: String(program || ""),
      protocolStartDate: String(startISO).slice(0,10),

      stepIndex: i,
      stepDay: Number(st.day ?? 0),
      stepName: String(st.name || ""),
      dueAt: dueISO || "",     // Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ø·ÙˆØ©
      dueDate: dueDate || "",  // Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙŠÙˆÙ…

      status: st.done ? "done" : "pending",
      done: !!st.done,

      // ØªÙˆØ§Ø±ÙŠØ® ÙÙ†ÙŠØ©
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    // âœ… merge true: Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ ÙŠØ­Ø¯Ø«Ù‡ Ø¨Ø¯Ù„ Ù…Ø§ ÙŠÙƒØ±Ø±
    await setDoc(doc(dbRef, "tasks", taskId), taskPayload, { merge: true });
  }
}

  /* ========= Save ========= */
  saveBtn.addEventListener("click",()=>{
    syncCentral();
    form.requestSubmit(); // âœ… Ù…Ø±ÙƒØ²ÙŠ ÙÙ‚Ø·
  });

  // âœ… Ø­ÙØ¸ ÙØ¹Ù„ÙŠ: ÙØ±Ø¯ÙŠ Ø£Ùˆ Ø¬Ù…Ø§Ø¹ÙŠ Ø¨Ø¹Ø¯ mbk:valid
 form.addEventListener("mbk:valid", async (ev)=> {
    if (!fbReady){ showInfo("â›” Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø§Ù„Ø¢Ù†.", true); return; }

    const start = (startDateEl.value || "").trim() || todayISO();
    if (!startDateEl.value) startDateEl.value = start;
   const program = (programEl.value || "").trim();
    const u = await waitUser();
    if (!u){ showInfo("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„.", true); return; }

    // âœ… Ø­Ø¯Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹
    const targets = (getMode()==="group")
      ? (parseBulk().map(x=>String(x).trim()).filter(Boolean))
      : [String(animalUI.value||"").trim()].filter(Boolean);

    if (!targets.length){ showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†."); return; }

   // âœ… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ØªØ£ØªÙŠ Ù…Ù† forms-init (Ù…Ø±ÙƒØ²ÙŠ)
const fd = ev?.detail?.formData || null;

// âœ… Ù‚ÙÙ„ Ø£Ù…Ø§Ù†: Ù…Ù…Ù†ÙˆØ¹ Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ù†ØªÙŠØ¬Ø© ØªØ­Ù‚Ù‚ ØµØ±ÙŠØ­Ø© Ù…Ù† forms-init
if (!fd || !Array.isArray(fd.animalNumbers)) {
  showInfo("â›” Ù„Ù… ÙŠÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ.\nÙ…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¶ØºØ· (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„) Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©.", true);
  return;
}

const finalList = fd.animalNumbers;
const rejected  = Array.isArray(fd.rejected) ? fd.rejected : [];



    // âœ… Ø¨Ù†Ø§Ø¡ payload Ø«Ø§Ø¨Øª Ù„Ù„Ø®Ø·ÙˆØ§Øª
    const payloadBase = {
      type: "ovsynch",
      eventType: "Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†",
      eventDate: start,
      program,
      steps: stepsState,
      userId: u.uid,
      createdAt: serverTimestamp()
    };

    let saved = 0;
    let already = 0;

    for (const animal of finalList){
      const id = ["ovsynch", animal, program, start].join("__");
      const ref = doc(dbRef, "events", id);

      const ex = await getDoc(ref);
      if (ex.exists()){
        already++;
        continue;
      }

      const payload = Object.assign({}, payloadBase, { animalNumber: animal });
      await setDoc(ref, payload);
      await upsertOvsynchTasks(u.uid, animal, start, program, stepsState);

      if (typeof window.updateAnimalByEvent === "function"){
        try{ await window.updateAnimalByEvent(payload); }catch{}
      }

      saved++;
    }

    // âœ… Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ø¶Ø­Ø©
    let msg = `âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${saved} Ø±Ù‚Ù…`;
    if (already) msg += `\nâ›” Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§: ${already} Ø±Ù‚Ù…`;
    if (rejected.length){
      const prev = rejected.slice(0,6).map(x=>x.reason).join("\n");
      msg += `\n\nğŸš« Ù…Ø³ØªØ¨Ø¹Ø¯: ${rejected.length} Ø±Ù‚Ù…\n${prev}${rejected.length>6 ? "\nâ€¦" : ""}`;
    }

    showInfo(msg, false);
    clearWarn();

    // âœ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒÙˆÙ†ØªÙƒØ³Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
    syncCentral();
  });

  // âœ… Ø£ÙˆÙ„ Ù…Ø²Ø§Ù…Ù†Ø©
  syncCentral();
})();
</script>

</body>
</html>
