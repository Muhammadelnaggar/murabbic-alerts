<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <!-- (Ù‡Ù†Ø±Ø¬Ø¹ Ù„Ù…Ù„Ø§Ø­Ø¸Ø© animal-update.js Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§) -->
 <script type="module">
  import { updateAnimalByEvent } from "/js/animal-update.js";
  window.updateAnimalByEvent = updateAnimalByEvent;
</script>


  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <title>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¶ ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</title>

  <style>
    body{
      margin:0;padding:0;
      background: var(--bg, #f7faf7);
      color: var(--text, #0f172a);
      font-family:'Cairo',Tahoma,Arial,sans-serif;
      direction: rtl;
    }

    header{
      position: sticky; top: 0; z-index: 20;
      background: #fff;
      border-bottom: 1px solid var(--border, #e2e8f0);
    }
    .mbk-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px;
    }
    .mbk-logo{ height:48px; width:auto; object-fit:contain; opacity:.95; flex-shrink:0; }
    .mbk-center{ flex:1; text-align:center; line-height:1.2; }
    .mbk-page-title{ font-size:18px; font-weight:900; color: var(--ink, #0f172a); }
    .mbk-app-name{ font-size:13px; font-weight:800; color: var(--brand-600, #0b7f47); opacity:.9; }
    .mbk-back{
      width:42px; height:42px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      text-decoration:none; font-weight:900;
      color: var(--brand-600, #0b7f47);
      border:2px solid var(--brand-600, #0b7f47);
      background:#fff; flex-shrink:0;
    }

    .wrap{ max-width:520px; margin:12px auto 24px; padding:0 12px; }
    .mbk-card{
      background:#fff;
      border:1px solid var(--border, #e2e8f0);
      border-radius:16px;
      padding:14px;
      box-shadow:0 1px 0 rgba(15,23,42,.04);
    }

    /* ØªØ®Ø·ÙŠØ· Ø§Ù„Ø­Ù‚ÙˆÙ„ */
    .row{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:640px){ .row-2{ grid-template-columns:1fr 1fr; } }

    .hint{ font-size:12px; opacity:.65; line-height:1.4; }

    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø®Ø·ÙˆØ§Øª */
    .steps{
      margin-top:12px;
      border:1px solid var(--border, #e2e8f0);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .step{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px;
      border-bottom:1px dashed var(--border, #e2e8f0);
    }
    .step:last-child{ border-bottom:none; }
    .step .name{ font-weight:900; }
    .step .date{ font-size:13px; opacity:.85; white-space:nowrap; }
    .step .chk{ display:flex; align-items:center; gap:8px; justify-content:flex-start; }
    .step input[type="checkbox"]{ width:18px; height:18px; }

    /* Ø´Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯/Ù…Ø¤ÙƒØ¯Ø© */
    .on-time{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border, #e2e8f0); }
    .ok{ background:#f0fff6; border-color:#bbf7d0; }
    .late{ background:#fff7ed; border-color:#fed7aa; }

    /* Ø±Ø³Ø§Ø¦Ù„ */
    #warn{ margin-top:10px; color:#b91c1c; font-weight:800; min-height:18px; }
   #info.infobar{
  display:none;
  position: sticky;
  top: 72px;           /* ØªØ­Øª Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¨Ø§Ø´Ø±Ø© */
  z-index: 19;
  margin: 10px 0 10px;
}
#info .msgrow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
#info .okbtn{
  flex-shrink:0;
  border-radius:12px;
  padding:8px 12px;
  font-weight:900;
  border:2px solid var(--brand-600, #0b7f47);
  background:#fff;
  color: var(--brand-600, #0b7f47);
  cursor:pointer;
}


    /* Ø£Ø²Ø±Ø§Ø± Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© */
    .btn-row{
      position: sticky;
      bottom: 10px;
      background: #fff;
      padding: 10px;
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 16px;
      display:flex;
      gap:10px;
      margin:14px 12px 18px;
      max-width:520px;
      margin-left:auto; margin-right:auto;
    }
    .btn-row .save-btn,
    .btn-row .open-card{
      flex:1; width:auto;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    .btn-row .save-btn{
      background: var(--brand, #0ea05a);
      color:#fff; border:0;
    }
    .btn-row .open-card{
      background:#fff !important;
      color: var(--brand-600, #0b7f47) !important;
      border:2px solid var(--brand-600, #0b7f47) !important;
    }
  </style>
</head>

<body>
  <header>
    <div class="mbk-head">
      <a class="mbk-back" href="add-event.html" title="Ø±Ø¬ÙˆØ¹">Ø±Ø¬ÙˆØ¹</a>

      <div class="mbk-center">
        <div class="mbk-page-title">Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªØ²Ø§Ù…Ù† ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­</div>
        <div class="mbk-app-name">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
      </div>

      <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
    </div>
  </header>
  <div class="wrap">
    <div id="info" class="infobar"></div> 
    <div class="mbk-card">
      <form id="ovForm" autocomplete="off">
<div class="row" style="margin-bottom:12px">
  <div class="field">
    <label for="bulkAnimals">Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ (ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø±)</label>
    <textarea id="bulkAnimals" rows="4" placeholder="Ù…Ø«Ø§Ù„:
105
106
110"></textarea>
    <div class="hint">Ù„Ùˆ ÙƒØªØ¨Øª Ù‡Ù†Ø§: Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù….</div>
  </div>

  <button id="applyBulk" type="button" class="open-card" style="width:100%;margin-top:6px">
    ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  </button>

  <div class="hint" id="bulkHint" style="margin-top:6px;opacity:.75"></div>
</div>

<!-- ğŸ‘‡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© -->
<div class="row" style="margin-top:10px">
  <div class="field">
    <label for="groupSelect">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</label>
    <select id="groupSelect">
      <option value="" selected>â€” Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© â€”</option>
    </select>
    <div class="hint">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ù†ÙØ³ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©).</div>
  </div>

  <div class="row row-2">
    <button id="loadGroup" type="button" class="open-card">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
    <button id="saveGroup" type="button" class="open-card">Ø­ÙØ¸ ÙƒÙ€ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
  </div>
</div>

        <div class="row row-2">
          <div class="field">
            <label for="animalId">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
            <input id="animalId" type="text" placeholder="Ù…Ø«Ø§Ù„: 105" />
          </div>

         <div class="field">
  <label for="startDate">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ (Ø§Ù„ÙŠÙˆÙ… 0)</label>
  <input id="startDate" type="date" />
</div>

<div class="field">
  <label for="startTime">Ø³Ø§Ø¹Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</label>
  <input id="startTime" type="time" value="08:00" />
  <div class="hint">Ù…Ø«Ø§Ù„: 08:00 ØµØ¨Ø§Ø­Ù‹Ø§ â€” Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
</div>
</div>

        <div class="row" style="margin-top:12px">
          <div class="field">
            <label for="program">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
            <select id="program">
              <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</option>
              <option value="ovsynch">Ovsynch</option>
              <option value="cosynch72">Cosynch-72</option>
              <option value="presynch_ovsynch">Presynch + Ovsynch</option>
            </select>
            <div class="muted hint">Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© âœ“ Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° ÙƒÙ„ Ø®Ø·ÙˆØ©.</div>
          </div>
        </div>

        <div id="stepsBox" class="steps" aria-live="polite"></div>

        <div id="warn"></div>
      </form>
    </div>
  </div>

  <div class="btn-row">
    <button id="saveBtn" class="save-btn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</button>
    <button id="openCowCard" class="open-card" type="button">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
  </div>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, doc, setDoc, updateDoc, getDoc, query, where, limit, getDocs, orderBy }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
 import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  (async () => {
    const form        = document.getElementById('ovForm');
    const animalIdEl  = document.getElementById('animalId');
    const startDateEl = document.getElementById('startDate');
    const startTimeEl = document.getElementById('startTime');
    const bulkEl      = document.getElementById('bulkAnimals');
const applyBulkBtn= document.getElementById('applyBulk');
const bulkHintEl  = document.getElementById('bulkHint');
const groupSelectEl = document.getElementById('groupSelect');
const loadGroupBtn  = document.getElementById('loadGroup');
const saveGroupBtn  = document.getElementById('saveGroup');


let bulkList = []; // Ù‚Ø§Ø¦Ù…Ø© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª
    let currentGroupId = "";
let currentGroupName = "";
let currentGroupFromCloud = false;

    const programEl   = document.getElementById('program');
    const stepsBox    = document.getElementById('stepsBox');

    const saveBtn     = document.getElementById('saveBtn');
    const openCardBtn = document.getElementById("openCowCard");

    const warnEl = document.getElementById('warn');
    const infoEl = document.getElementById('info');

    let dbRef = null, authRef = null;
    let stepsState = [];

    // === ØªØ´Ø®ÙŠØµ Ø³Ø±ÙŠØ¹ Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§ØªØ´ØºÙ‘Ù„ ===
    console.log("âœ… ovsynch script loaded v2");

    function todayLocal(){
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().slice(0,10);
    }
    function showWarn(t){ if(warnEl) warnEl.textContent = t || ""; }
    function clearWarn(){ if(warnEl) warnEl.textContent = ""; }
function parseBulkList(){
  const raw = (bulkEl?.value || "").trim();
  if(!raw){ bulkList = []; return []; }

  const arr = raw
    .split(/\n|,|;/g)
    .map(s => String(s||"").trim())
    .filter(Boolean);

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨
  const seen = new Set();
  bulkList = arr.filter(x => (seen.has(x) ? false : (seen.add(x), true)));

  if(bulkHintEl){
    bulkHintEl.textContent = bulkList.length
      ? `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${bulkList.length} Ø­ÙŠÙˆØ§Ù†: ${bulkList.slice(0,8).join("ØŒ ")}${bulkList.length>8?" ...":""}`
      : "";
  }
  return bulkList;
}

applyBulkBtn?.addEventListener("click", async ()=>{

  const list = parseBulkList();
  if(!list.length){
    showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ.");
    return;
  }
  clearWarn();

  (async ()=>{

  const okList = [];
  const bad = [];

  for(const n of list){
    const r = await checkAnimalQuick(n);
    if(r.reason === "auth_blocked_silent") return; // Ø§Ø®Ø±Ø¬ Ø¨ØµÙ…Øª
    if(r.ok) okList.push(n);
   else bad.push({ n, reason:r.reason, extra:r });
  }

if(bad.length){

  bulkEl.value = okList.join("\n");
  parseBulkList();

  const details = bad.map(b =>
    invalidAnimalMessage(b.reason, b.n, b.extra)
  ).join("\n");

  showInfo(
    `ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ${bad.length} Ø­ÙŠÙˆØ§Ù† Ù„Ø¹Ø¯Ù… Ø§Ù„Ø£Ù‡Ù„ÙŠØ© Ù„Ù„ØªØ²Ø§Ù…Ù†:\n${details}`,
    { isErr:true, requireAck:true }
  );

}else{
  showInfo(`ØªÙ… Ù‚Ø¨ÙˆÙ„ ${okList.length} Ø­ÙŠÙˆØ§Ù† Ù„Ù„ØªØ³Ø¬ÙŠÙ„.`);
}

  // Ù„Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙØ±Ø¯ÙŠ ÙØ§Ø¶ÙŠ Ø®Ù„ÙŠÙ‡ Ø£ÙˆÙ„ Ø±Ù‚Ù… ØµØ­ÙŠØ­
  if(animalIdEl && !animalIdEl.value && okList.length) animalIdEl.value = okList[0];
})();

  if(!list.length){
    showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ.");
    return;
  }
  clearWarn();
 
});
async function loadGroupsList(){
  if(!dbRef || !authRef?.currentUser || !groupSelectEl) return;
  const q = query(
    collection(dbRef, "protocolGroups"),
    where("userId", "==", authRef.currentUser.uid),
    orderBy("createdAt", "desc")
  );

  const snap = await getDocs(q);

  // Ø§Ù…Ø³Ø­ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  groupSelectEl.innerHTML = `<option value="" selected>â€” Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© â€”</option>`;

  snap.forEach(docSnap=>{
    const d = docSnap.data() || {};
    const opt = document.createElement("option");
    opt.value = docSnap.id;
    opt.textContent = d.name || docSnap.id;
    groupSelectEl.appendChild(opt);
  });
}

async function saveCurrentAsGroup(){
  const list = parseBulkList();
  if(!list.length){
    showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø­ÙØ¸ ÙƒÙ…Ø¬Ù…ÙˆØ¹Ø©.");
    return;
  }
  if(!dbRef || !authRef?.currentUser){
    showWarn("âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
    return;
  }

  const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ Ù…Ø«Ø§Ù„: Ø¯ÙØ¹Ø© 25 Ø¨Ù‚Ø±Ø© - ÙØ¨Ø±Ø§ÙŠØ±");
  if(!name) return;

  // ID Ø«Ø§Ø¨Øª Ù…Ù† Ø§Ù„Ø§Ø³Ù… + uid (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø£Ùˆ auto id
  await addDoc(collection(dbRef, "protocolGroups"), {
    userId: authRef.currentUser.uid,
    name: String(name).trim(),
    animals: list.map(x=>String(x).trim()),
    createdAt: serverTimestamp()
  });

  showInfo("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©");
  await loadGroupsList();
}

async function loadSelectedGroup(){
  const gid = (groupSelectEl?.value || "").trim();
  if(!gid){
    showWarn("âš ï¸ Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }
  if(!dbRef) return;

  const snap = await getDoc(doc(dbRef, "protocolGroups", gid));
  if(!snap.exists()){
    showWarn("âš ï¸ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
    return;
  }

  const d = snap.data() || {};
  const arr = Array.isArray(d.animals) ? d.animals : [];
  currentGroupId = gid;
currentGroupName = String(d.name || gid).trim();
currentGroupFromCloud = true;

  bulkEl.value = arr.join("\n");
  parseBulkList();            // ÙŠØ­Ø¯Ø« bulkList + hint
  if(!animalIdEl.value && bulkList.length) animalIdEl.value = bulkList[0];

  showInfo(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${d.name || gid}`);
}
loadGroupBtn?.addEventListener("click", loadSelectedGroup);
saveGroupBtn?.addEventListener("click", saveCurrentAsGroup);

  function showInfo(text, opts){
  const o = (typeof opts === "object" && opts) ? opts : { isErr: !!opts, requireAck: false };

  if(!infoEl) return;
  infoEl.style.display = "block";
  infoEl.className = "infobar " + (o.isErr ? "error" : "show");

  // âœ… Ù…Ø­ØªÙˆÙ‰ + Ø²Ø± "Ø­Ø³Ù†Ù‹Ø§"
  infoEl.innerHTML = `
    <div class="msgrow">
     <div class="msgtext" style="white-space:pre-line">${String(text||"")}</div>
      <button type="button" class="okbtn" id="infoOkBtn">Ø­Ø³Ù†Ù‹Ø§</button>
    </div>
  `;

  try{ infoEl.scrollIntoView({behavior:"smooth", block:"start"}); }catch{}

  // âœ… Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø¥Ù„Ø²Ø§Ù…ÙŠ Ø¹Ù†Ø¯ requireAck
  const btn = document.getElementById("infoOkBtn");
  if(btn){
    btn.onclick = () => {
      infoEl.style.display = "none";
      infoEl.innerHTML = "";
    };
  }
}

    async function checkAnimalQuick(num){
 if(!dbRef) return { ok:true }; // Ù„Ùˆ Ù…ÙÙŠØ´ DB (Ø£ÙˆÙÙ„Ø§ÙŠÙ†) Ù…Ø§ Ù†Ø¹Ø·Ù„Ø´

// âœ… Ù„Ùˆ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ø³Ù‡ Ù…Ø§ Ø±Ø¬Ø¹ØªØ´: Ù†Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„)
if(!authRef?.currentUser) return { ok:false, reason:"auth_blocked_silent" };

  const uid = authRef.currentUser.uid;
  const animalsRef = collection(dbRef, "animals");
  let snap = await getDocs(query(
    animalsRef,
    where("userId","==",uid),
    where("number","==",String(num)),
    limit(1)
  ));

  // 2) animalNumber ÙƒØ±Ù‚Ù…
  if(snap.empty){
    snap = await getDocs(query(
      animalsRef,
      where("userId","==",uid),
      where("animalNumber","==",Number(num)),
      limit(1)
    ));
  }

  if(snap.empty){
    return { ok:false, reason:"not_found" };
  }

  const a = snap.docs[0].data() || {};
  const animalType = String(a.type || a.animalType || a.kind || "").trim();
  const status = String(a.status || "active").toLowerCase(); // active/inactive
  const inactiveReason = String(a.inactiveReason || "").toLowerCase(); // sale/death...
  const breedingBlocked = !!a.breedingBlocked;
  const repro = String(a.reproductiveStatus || "").trim();
      if(repro === "Ø¹Ø´Ø§Ø±") return { ok:false, reason:"pregnant", animalType };
if(repro === "Ù…Ù„Ù‚Ø­") return { ok:false, reason:"inseminated", animalType };
if (repro === "Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©") {
  // âœ… Ù…Ù…ÙƒÙ† ØªÙƒÙˆÙ† Ø¨Ø¹Ø¯ ÙˆÙ„Ø§Ø¯Ø© Ø£Ùˆ Ø¨Ø¹Ø¯ Ø¥Ø¬Ù‡Ø§Ø¶ â€” Ù†Ø®ØªØ§Ø± Ø§Ù„Ø£Ø­Ø¯Ø«
  const startRef = (startDateEl?.value || todayLocal());

  const calv = String(a.lastCalvingDate || "").slice(0,10);
  const abrt = String(a.lastAbortionDate || a.lastAbortDate || "").slice(0,10);

  // Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø­Ø¯Ø« Ø¨ÙŠÙ†Ù‡Ù…Ø§ (Ù„Ùˆ Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†)
  let refType = "calving";
  let refDate = calv;

  if (abrt && (!calv || abrt > calv)) {
    refType = "abortion";
    refDate = abrt;
  }

  const dim = daysSinceISO(refDate, startRef);   // âœ… Ø£ÙŠØ§Ù… Ù…Ù†Ø° Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©/Ø¥Ø¬Ù‡Ø§Ø¶
  const minDim = postpartumMinDaysByType(a);

  // Ù„Ùˆ Ù…Ø´ Ù‚Ø§Ø¯Ø±ÙŠÙ† Ù†Ø­Ø³Ø¨ (Ù…ÙÙŠØ´ ØªØ§Ø±ÙŠØ®) Ù†Ø¹Ø±Ø¶ Ø³Ø¨Ø¨ Ø¹Ø§Ù… Ø¨Ø¯ÙˆÙ† Ø£Ø±Ù‚Ø§Ù…
  if (dim === null) {
    return { ok:false, reason:"fresh_postpartum", refType, animalType };
  }

  return { ok:false, reason:"fresh_postpartum", refType, dim, minDim, animalType };
}


      // ğŸ”’ Ù…Ù†Ø¹ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø¨Ø¹Ø¯ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© (Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹)
const startRef = (startDateEl?.value || todayLocal());  // Ù†Ø³ØªØ®Ø¯Ù… ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ÙƒÙ…Ø±Ø¬Ø¹
const dpp = daysSinceISO(a.lastCalvingDate, startRef);  // days postpartum
const minDpp = postpartumMinDaysByType(a);

if(dpp !== null && dpp >= 0 && dpp < minDpp){
 return { ok:false, reason:"fresh_postpartum", dpp, minDpp, animalType };
}

  // Ù…Ø¨Ø§Ø¹/Ù†Ø§ÙÙ‚
 if(status === "inactive"){
  if(inactiveReason === "sale")  return { ok:false, reason:"sale", animalType };
  if(inactiveReason === "death") return { ok:false, reason:"death", animalType };
  return { ok:false, reason:"inactive", animalType };
}


  // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ (Ø­Ø³Ø¨ Ù†Ø¸Ø§Ù…Ùƒ: breedingBlocked Ø£Ùˆ reproductiveStatus)
  if(breedingBlocked || repro === "Ù„Ø§ ØªÙÙ„Ù‚Ù‘Ø­ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"){
   
    return { ok:false, reason:"cull" };
  }

  return { ok:true, animal:a, animalType };
}
function daysSinceISO(isoDate, refISO){
  if(!isoDate) return null;
  const a = new Date(String(isoDate).slice(0,10) + "T00:00:00");
  const b = new Date(String(refISO || todayLocal()).slice(0,10) + "T00:00:00");
  if(isNaN(a) || isNaN(b)) return null;
  return Math.floor((b - a) / (1000*60*60*24));
}

function isBuffaloType(animalDoc){
  const tRaw = String(
    animalDoc?.type ??
    animalDoc?.animalType ??
    animalDoc?.kind ??
    animalDoc?.species ??
    animalDoc?.animalSpecies ??
    ""
  );

  const t = tRaw.toLowerCase().trim();

  // âœ… Ø¹Ø±Ø¨ÙŠ
  if (t.includes("Ø¬Ø§Ù…ÙˆØ³") || t.includes("Ø¬Ø§Ù…ÙˆØ³Ù‡") || t.includes("Ø¬Ø§Ù…ÙˆØ³Ø©")) return true;

  // âœ… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ (Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©)
  // buffalo / buffloe / bufflo / buff / water buffalo
  if (t.includes("buffalo")) return true;
  if (t.includes("buffloe")) return true;
  if (t.includes("bufflo")) return true;
  if (t.includes("water") && t.includes("buff")) return true;
  if (t.includes("buff")) return true; // ØªØ´Ù…Ù„ buf/buff

  return false;
}

function postpartumMinDaysByType(animalDoc){
  return isBuffaloType(animalDoc) ? 45 : 49; // âœ… Ø¬Ø§Ù…ÙˆØ³ 45 / Ø£Ø¨Ù‚Ø§Ø± 49
}


function invalidAnimalMessage(reason, num, extra){
 const label = isBuffaloType(extra?.animal || extra) ? "Ø¬Ø§Ù…ÙˆØ³Ø©" : "Ø¨Ù‚Ø±Ø©";


  if(reason === "not_found")
    return `â›” Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø±Ù‚Ù… ${num} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.`;

  if(reason === "sale")
    return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ù…Ø¨Ø§Ø¹Ø©).`;

  if(reason === "death")
    return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ù†Ø§ÙÙ‚Ø©).`;

  if(reason === "inactive")
    return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø·ÙŠØ¹.`;

  if(reason === "cull")
    return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ù…Ø³ØªØ¨Ø¹Ø¯Ø© (Ù„Ø§ ØªÙÙ„Ù‚Ù‘Ø­ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰).`;

  if(reason === "pregnant")
    return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ø¹ÙØ´Ø§Ø±.`;

  if(reason === "inseminated")
    return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ù…ÙÙ„Ù‚Ù‘Ø­Ø©.`;

 if(reason === "fresh_postpartum"){
  const dim = Number.isFinite(extra?.dim) ? extra.dim : null;
  const min = Number.isFinite(extra?.minDim) ? extra.minDim : null;

  const refType = String(extra?.refType || "calving");
  const refLabel = (refType === "abortion") ? "Ø¨Ø¹Ø¯ Ø¥Ø¬Ù‡Ø§Ø¶" : "Ø¨Ø¹Ø¯ ÙˆÙ„Ø§Ø¯Ø©";

  if(dim !== null && min !== null){
    return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: ${refLabel} â€” Ø§Ù„Ø£ÙŠØ§Ù… ${dim} (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ${min} Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹).`;
  }

  return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: ${refLabel} â€” Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹.`;
}

async function rejectNumberSoft(num){
  // âœ… Ù„Ø§ ØªØ¬Ù…ÙŠØ¯ â€” ÙÙ‚Ø· Ø§Ù…Ø³Ø­ Ø§Ù„Ø±Ù‚Ù… ÙˆØ£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø©
  showInfo(invalidAnimalMessage("not_found", num), true);
  if(animalIdEl){
    animalIdEl.value = "";
    try{ animalIdEl.focus(); }catch{}
  }
}

    // âœ… ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
    openCardBtn?.addEventListener("click", ()=>{
      const id = (animalIdEl.value || "").trim();
      if(!id) return;
      location.href = `cow-card.html?number=${encodeURIComponent(id)}`;
    });

    // âœ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙˆÙ†ØªÙƒØ³Øª Ù…Ù† add-event (number/date/eventDateâ€¦)
    function hydrate(){
      const qp = new URLSearchParams(location.search);

      const id =
        (qp.get('number') || qp.get('animalNumber') || qp.get('animalId') || qp.get('animalIdd') || "").trim() ||
        (localStorage.getItem('lastAnimalId') || "").trim();

      const dt =
        (qp.get('date') || qp.get('eventDate') || "").trim() ||
        (localStorage.getItem('lastEventDate') || "").trim() ||
        todayLocal();

      if (id){
        animalIdEl.value = id;
        
        try{ localStorage.setItem('lastAnimalId', id); }catch{}
      }

      startDateEl.value = dt;
      try{ localStorage.setItem('lastEventDate', dt); }catch{}
    }
animalIdEl?.addEventListener("change", async ()=>{
  const num = (animalIdEl.value||"").trim();
  if(!num) return;

  const r = await checkAnimalQuick(num);
  if(!r.ok){
    
   showInfo(invalidAnimalMessage(r.reason, num, r), true);
    animalIdEl.value = "";
    try{ animalIdEl.focus(); }catch{}
  }
});

    function addDays(baseISO, baseTime, days, extraHours = 0){
  const d = new Date(baseISO + "T" + (baseTime || "08:00"));
  d.setDate(d.getDate() + days);
  d.setHours(d.getHours() + extraHours);
  return d;
}

    function fmt(d){
      try{ return d.toLocaleDateString('ar-EG'); }catch{ return d.toISOString().slice(0,10); }
    }

    const PROGRAMS = {
      ovsynch:[
        { day: 0,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 9,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 9 ~ Ø¨Ø¹Ø¯ ~56 Ø³Ø§Ø¹Ø©)' },
        { day: 10, name:'ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 ~ Ø¨Ø¹Ø¯ ~16 Ø³Ø§Ø¹Ø©)' },
      ],
      cosynch72:[
        { day: 0,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 10, name:'GnRH + ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 â‰ˆ 72 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ PGF)' },
      ],
      presynch_ovsynch:[
        { day:-28, name:'Presynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… -28)' },
        { day:-14, name:'Presynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… -14)' },
        { day: 0,  name:'Ovsynch: GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'Ovsynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 9,  name:'Ovsynch: GnRH (Ø§Ù„ÙŠÙˆÙ… 9 ~ Ø¨Ø¹Ø¯ ~56 Ø³Ø§Ø¹Ø©)' },
        { day: 10, name:'Ovsynch: ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 ~ Ø¨Ø¹Ø¯ ~16 Ø³Ø§Ø¹Ø©)' },
      ]
    };
// ===================== Tasks helpers (Ù…Ø±ÙƒØ²ÙŠ) =====================
function safeKey(s){
  return String(s||"").trim()
    .replace(/\s+/g,'_')
    .replace(/[^\w\u0600-\u06FF\-]+/g,'');
}
function toISODateLocal(d){
  const dd = new Date(d);
  return new Date(dd.getTime() - dd.getTimezoneOffset()*60000).toISOString().slice(0,10);
}
function makeTaskId({ animalNumber, protocolStartDate, program, plannedDate, stepName }){
  // ID Ø«Ø§Ø¨Øª ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø­ØªÙ‰ Ù„Ùˆ Ø§ØªØ¹Ù…Ù„ Save Ø£ÙƒØªØ± Ù…Ù† Ù…Ø±Ø©
  return [
    "task",
    safeKey(animalNumber),
    safeKey(program),
    safeKey(protocolStartDate),
    safeKey(plannedDate),
    safeKey(stepName).slice(0,40)
  ].join("__");
}

async function ensureProtocolTasks({
  animalNumber,
  protocolStartDate,
  program,
  userId,
  scope = "animal",          // "animal" | "group"
  groupId = "",
  groupName = "",
  animalsCount = 0,
  alertEnabled = true        // âœ… group tasks = true / silent animal tasks = false
}){

  if(!dbRef) return;

  const tpl = PROGRAMS[program] || [];
  if(!tpl.length) return;

  // Ù†Ù†Ø´Ø¦/Ù†Ø­Ø¯Ù‘Ø« task Ù„ÙƒÙ„ Ø®Ø·ÙˆØ© (setDoc Ù…Ø¹ merge ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
  for (const s of tpl){
  const baseTime = (startTimeEl?.value || "08:00");

// âœ… Ø­Ø³Ø§Ø¨ ØµØ­ÙŠØ­ Ù…Ù† PGF (Ø§Ù„ÙŠÙˆÙ… 7)
let plannedDateTime;

if (program === "ovsynch" || program === "presynch_ovsynch") {
  const pgfDT = addDays(protocolStartDate, baseTime, 7, 0);

  if (s.day === 9 && String(s.name).includes("GnRH")) {
    plannedDateTime = new Date(pgfDT.getTime() + 56 * 3600 * 1000);
  } else if (String(s.name).includes("ØªÙ„Ù‚ÙŠØ­")) {
    plannedDateTime = new Date(pgfDT.getTime() + 72 * 3600 * 1000);
  } else {
    plannedDateTime = addDays(protocolStartDate, baseTime, s.day, 0);
  }

} else if (program === "cosynch72") {
  const pgfDT = addDays(protocolStartDate, baseTime, 7, 0);

  if (String(s.name).includes("ØªÙ„Ù‚ÙŠØ­") || (String(s.name).includes("GnRH") && s.day === 10)) {
    plannedDateTime = new Date(pgfDT.getTime() + 72 * 3600 * 1000);
  } else {
    plannedDateTime = addDays(protocolStartDate, baseTime, s.day, 0);
  }

} else {
  plannedDateTime = addDays(protocolStartDate, baseTime, s.day, 0);
}

const plannedDate = toISODateLocal(plannedDateTime);


    const taskId = makeTaskId({
      animalNumber,
      protocolStartDate,
      program,
      plannedDate,
      stepName: s.name
    });

    const ref = doc(dbRef, "tasks", taskId);
   const snap = await getDoc(ref);
if (!snap.exists()) {
  await setDoc(ref, {
    type: "protocol_step",
   protocolType: program,

    program: program,
    stepName: s.name,
    plannedDay: s.day,
    plannedDate: plannedDate,
    plannedDateTime: plannedDateTime.toISOString(),
    plannedTime: (startTimeEl?.value || "08:00"),
    animalNumber: String(animalNumber||"").trim(),
    protocolStartDate: String(protocolStartDate||"").trim(),
    status: "pending",
    scope: scope,
groupId: groupId || null,
groupName: groupName || null,
animalsCount: animalsCount || null,
alertEnabled: !!alertEnabled,

    userId: userId || null,
    createdAt: serverTimestamp()
  });
}

  }
}

async function markTaskDone({ animalNumber, protocolStartDate, program, plannedDate, stepName }){
  if(!dbRef) return;

  const taskId = makeTaskId({ animalNumber, protocolStartDate, program, plannedDate, stepName });
  const ref = doc(dbRef, "tasks", taskId);

  const snap = await getDoc(ref);

  // âœ… Ù„Ùˆ Ø§Ù„ØªØ§Ø³Ùƒ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯: Ù„Ø§ Ù†Ù†Ø´Ø¦Ù‡ Ù‡Ù†Ø§ (Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ Rules)
  if(!snap.exists()){
    console.warn("âš ï¸ Task not found to mark done:", taskId);
    return;
  }

   await updateDoc(ref, {
    status: "done",
    doneAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });

}



    function updateSteps(){
      stepsBox.innerHTML = '';

      const start = (startDateEl.value || "").trim();
      const program = (programEl.value || "").trim();
      if(!start || !program) return;

      const tpl = PROGRAMS[program] || [];
      const prev = stepsState;

      stepsState = tpl.map((s)=>{
      const baseTime = (startTimeEl.value || "08:00");

// âœ… Ø­Ø³Ø§Ø¨ ØµØ­ÙŠØ­: Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªÙØ­Ø³Ø¨ Ù…Ù† PGF (Ø§Ù„ÙŠÙˆÙ… 7) ÙˆÙ„ÙŠØ³ Ù…Ù† (Ø§Ù„ÙŠÙˆÙ… + 9)
let dd;

if (program === "ovsynch" || program === "presynch_ovsynch") {
  // ÙˆÙ‚Øª PGF = Ø§Ù„ÙŠÙˆÙ… 7 Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  const pgfDT = addDays(start, baseTime, 7, 0);

  if (s.day === 9 && String(s.name).includes("GnRH")) {
    // GnRH Ø§Ù„Ø«Ø§Ù†ÙŠØ© = 56 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ PGF
    dd = new Date(pgfDT.getTime() + 56 * 3600 * 1000);
  } else if (String(s.name).includes("ØªÙ„Ù‚ÙŠØ­")) {
    // TAI = 72 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ PGF (56 + 16)
    dd = new Date(pgfDT.getTime() + 72 * 3600 * 1000);
  } else {
    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø¨Ø£ÙŠØ§Ù…Ù‡Ø§ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    dd = addDays(start, baseTime, s.day, 0);
  }

} else if (program === "cosynch72") {
  const pgfDT = addDays(start, baseTime, 7, 0);

  if (String(s.name).includes("ØªÙ„Ù‚ÙŠØ­") || (String(s.name).includes("GnRH") && s.day === 10)) {
    // GnRH+TAI = 72 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ PGF
    dd = new Date(pgfDT.getTime() + 72 * 3600 * 1000);
  } else {
    dd = addDays(start, baseTime, s.day, 0);
  }

} else {
  dd = addDays(start, baseTime, s.day, 0);
}

        const local = new Date(dd.getTime() - dd.getTimezoneOffset()*60000);
const iso = local.toISOString().slice(0,16); // ØªØ§Ø±ÙŠØ® + ÙˆÙ‚Øª
const plannedDate = toISODateLocal(dd); // âœ… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ tasks

        const keep = prev.find(p => p.name===s.name && p.day===s.day);
        return {
          day: s.day,
          name: s.name,
          date: iso,
          plannedDate: plannedDate,
          done: keep ? !!keep.done : false,
          confirmedOn: keep ? keep.confirmedOn || null : null,
          onSchedule: keep ? !!keep.onSchedule : false,
          _savedOnce: keep ? !!keep._savedOnce : false,
        };
      });

      stepsState.forEach((st, idx)=>{
        const row = document.createElement('div');
        row.className = 'step';

        const chip = st.done
          ? `<span class="on-time ${st.onSchedule ? 'ok' : 'late'}">${st.onSchedule ? 'âœ“ ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯' : 'âœ“ Ù…Ø¤ÙƒØ¯Ø©'}</span>`
          : '';

        row.innerHTML = `
          <div>
            <div class="name">${st.name}</div>
            <div class="date">ğŸ“… ${new Date(st.date).toLocaleString('ar-EG')} ${chip}</div>
          </div>
          <label class="chk">
            <input data-idx="${idx}" type="checkbox" ${st.done ? 'checked' : ''}/>
            ØªÙ…
          </label>
        `;
        stepsBox.appendChild(row);
      });
    }

    async function saveStepEvent(i){
      if(!authRef?.currentUser) return;

      try{
        if(!dbRef) return;
        const st = stepsState[i];
        if(!st || st._savedOnce) return;

        const animalId = (animalIdEl.value || '').trim();
        if(!animalId) return;

        const payload = {
          type: 'ovsynch-step',
          eventType: 'Ø®Ø·ÙˆØ© Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„',
          stepName: st.name,
          program: programEl.value || null,
          protocolStartDate: (startDateEl.value||'').trim() || null,
          plannedDay: st.day,
        plannedDate: st.plannedDate,

plannedDateTime: st.date,

          confirmedOn: st.confirmedOn,
          onSchedule: !!st.onSchedule,
          animalId,
          animalNumber: animalId,
          userId: authRef?.currentUser?.uid || null,
          createdAt: serverTimestamp()
        };

        await addDoc(collection(dbRef,'events'), payload);

// âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ task Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ ÙƒÙ€ done (Ù…Ø±ÙƒØ²ÙŠ)
await markTaskDone({
  animalNumber: animalId,
  protocolStartDate: (startDateEl.value||'').trim(),
  program: (programEl.value||'').trim(),
 plannedDate: st.plannedDate,

  stepName: st.name
});
// âœ… Ù„Ùˆ ÙˆØ¶Ø¹ Ù…Ø¬Ù…ÙˆØ¹Ø©: Ø¹Ù„Ù‘Ù… Task Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Done Ø£ÙŠØ¶Ù‹Ø§
const isGroupModeNow =
  (Array.isArray(parseBulkList()) && parseBulkList().length > 1) ||
  !!(groupSelectEl?.value || "").trim();

if (isGroupModeNow) {
  let gid = "";
  if ((groupSelectEl?.value || "").trim()) {
    gid = String(groupSelectEl.value).trim();
  } else {
    // Bulk groupId Ø¨Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸
    const listNow = parseBulkList();
    gid = [
      "bulk",
      String(programEl.value||"").trim(),
      String(startDateEl.value||"").trim(),
      String(listNow.length),
      String(listNow[0]||"").trim()
    ].join("__");
  }

  await markTaskDone({
    animalNumber: `group:${String(gid || "").trim()}`,
    protocolStartDate: (startDateEl.value||'').trim(),
    program: (programEl.value||'').trim(),
    plannedDate: st.plannedDate,
    stepName: st.name
  });
}

st._savedOnce = true;

      }catch(err){
       console.error('saveStepEvent failed', err);
showInfo("âš ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø« Ù„ÙƒÙ† ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Task). Ø±Ø§Ø¬Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ tasks.", true);

      }
    }

    stepsBox.addEventListener('change', async (e)=>{
      const el = e.target.closest('input[type="checkbox"][data-idx]');
      if(!el) return;

      const i = Number(el.getAttribute('data-idx'));
      const st = stepsState[i];
      if(!st) return;

      const today = todayLocal();
      st.done = el.checked;
      st.confirmedOn = el.checked ? today : null;
    st.onSchedule = el.checked ? (today === st.plannedDate) : false;


      if(el.checked) await saveStepEvent(i);
      updateSteps();
    });

    async function setupFirebase(){
      try{
       const mod = await import('/js/firebase-config.js?v=5');
        if(mod?.db && mod?.auth) return { db:mod.db, auth:mod.auth };
        if(mod?.firebaseConfig){
          const app = initializeApp(mod.firebaseConfig);
          return { db:getFirestore(app), auth:getAuth(app) };
        }
      }catch(e){ /* ignore */ }

      try{
        const cfg = await import('./config.js?v=5');
        const app = initializeApp(cfg.firebaseConfig);
        return { db:getFirestore(app), auth:getAuth(app) };
      }catch(e2){
        showWarn('âŒ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.');
        return { db:null, auth:null };
      }
    }

    const { db, auth } = await setupFirebase();
    dbRef = db;
    authRef = auth;
   
    // âœ… Ø§Ù†ØªØ¸Ø± Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¨Ø¯ÙˆÙ† redirect)
async function waitForUser(ms=1500){
  if(!authRef) return null;
  return await new Promise((resolve)=>{
    const t = setTimeout(()=>resolve(authRef.currentUser || null), ms);
    try{
      onAuthStateChanged(authRef, (u)=>{
        clearTimeout(t);
        resolve(u || null);
      });
    }catch{
      clearTimeout(t);
      resolve(authRef.currentUser || null);
    }
  });
}
 const user = await waitForUser(2000);
if(user){
  await loadGroupsList();
}

  function getCtx(){
  const list = parseBulkList(); // Ù„Ùˆ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ ÙÙŠÙ‡ Ø£Ø±Ù‚Ø§Ù…ØŒ Ù‡Ù†Ø³ØªØ®Ø¯Ù…Ù‡
  const animalId = list.length ? list[0] : (animalIdEl.value||'').trim();

  const start = (startDateEl.value||'').trim();
  const program = (programEl.value||'').trim();

  if(!animalId || !start || !program){
    showWarn('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.');
    return null;
  }

  clearWarn();
  try{ localStorage.setItem('lastAnimalId', animalId); }catch{}
  try{ localStorage.setItem('lastEventDate', start); }catch{}

  return { animalId, animalIds: (list.length ? list : [animalId]), start, program, steps: stepsState };
}
    async function saveProtocol(){
      const ctx = getCtx();
      if(!ctx) return;
      // âœ… ØªØ£ÙƒØ¯ Ù…Ù† Ø£ÙˆÙ„ Ø±Ù‚Ù… (ÙˆØ£ÙŠØ¶Ù‹Ø§ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©)
const ids = (ctx.animalIds || []).filter(Boolean);
const okIds = [];
const badIds = [];

for(const n of ids){
  const r = await checkAnimalQuick(n);
  if(r.ok) okIds.push(n);
 else badIds.push({ n, reason:r.reason, extra:r });

}

if(badIds.length){

  bulkEl.value = okIds.join("\n");
  parseBulkList();

  const details = badIds.map(b =>
    invalidAnimalMessage(b.reason, b.n, b.extra)
  ).join("\n");

  showInfo(
    `ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ${badIds.length} Ø­ÙŠÙˆØ§Ù† Ù„Ø¹Ø¯Ù… Ø§Ù„Ø£Ù‡Ù„ÙŠØ© Ù„Ù„ØªØ²Ø§Ù…Ù†:\n${details}`,
    { isErr:true, requireAck:true }
  );
}


if(!okIds.length){
  showInfo("â›” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„.", true);
  return;
}

// âœ… Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„ØµØ§Ù„Ø­Ø© ÙÙ‚Ø·
ctx.animalIds = okIds;
ctx.animalId  = okIds[0];
// âœ… ØªØ­Ø¯ÙŠØ¯ Ù‡Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ "Ù…Ø¬Ù…ÙˆØ¹Ø©" Ø£Ù… "ÙØ±Ø¯ÙŠ"
const isGroupMode =
  (Array.isArray(ctx.animalIds) && ctx.animalIds.length > 1) ||
  !!(groupSelectEl?.value || "").trim();

let groupId = "";
let groupName = "";

// 1) Ù„Ùˆ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø³Ø­Ø§Ø¨ÙŠØ© Ù…Ø­Ù…Ù‘Ù„Ø©
if ((groupSelectEl?.value || "").trim()) {
  groupId = String(groupSelectEl.value).trim();
  groupName = String(currentGroupName || groupId).trim();
} else if (isGroupMode) {
  // 2) Bulk Group (Ù…Ø´ Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©)
   const preview = ctx.animalIds.slice(0,6).join("ØŒ ");
  groupName = `Ø£ÙˆÙØ³ÙŠÙ†Ùƒ Ø¬Ù…Ø§Ø¹ÙŠ (${ctx.animalIds.length}): ${preview}${ctx.animalIds.length>6?" ...":""}`;

  // ID Ø«Ø§Ø¨Øª Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù† Ù…Ù† (program + start + count + Ø£ÙˆÙ„ Ø±Ù‚Ù…)
  groupId = [
    "bulk",
    String(ctx.program||"").trim(),
    String(ctx.start||"").trim(),
    String(ctx.animalIds.length),
    String(ctx.animalIds[0]||"").trim()
  ].join("__");
}

     
if(!ids.length){
  showWarn("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ø­ÙŠÙˆØ§Ù†Ø§Øª.");
  return;
}


      saveBtn.disabled = true;
      const oldTxt = saveBtn.textContent;
      saveBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸';
try{
  const user = await waitForUser(2000);
  if(!user) return;

       
for (let idx = 0; idx < ctx.animalIds.length; idx++){
  const animalNo = ctx.animalIds[idx];


  const payload = {
    type: 'ovsynch',
    eventType: 'Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†',
    animalId: animalNo,
    animalNumber: animalNo,
    startDate: ctx.start,
    program: ctx.program,
    steps: ctx.steps,
    userId: user.uid,
    createdAt: serverTimestamp()
  };
if(typeof window.updateAnimalByEvent === "function"){
  await window.updateAnimalByEvent(payload);
}

  if(dbRef){
    const protocolId = [
      "ovsynch",
      String(animalNo).trim(),
      String(ctx.program).trim(),
      String(ctx.start).trim()
    ].join("__");
const evRef = doc(dbRef, "events", protocolId);
const snap = await getDoc(evRef);

if (!snap.exists()) {
  await setDoc(evRef, payload); // âœ… create ÙÙ‚Ø·
} else {
  // âœ… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ â€” Ù„Ø§ Ù†Ø¹Ù…Ù„ update Ø¹Ø´Ø§Ù† rules ØªÙ…Ù†Ø¹
  }
}
  // âœ… Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­ÙØ¸
  if (dbRef){
   // âœ… Lock: Ù„Ùˆ Group ÙŠØ¨Ù‚Ù‰ Lock ÙˆØ§Ø­Ø¯ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŒ Ù„Ùˆ ÙØ±Ø¯ÙŠ ÙŠØ¨Ù‚Ù‰ Ù„ÙƒÙ„ Ø­ÙŠÙˆØ§Ù†
const batchLockId = isGroupMode
  ? ["ovsynch_tasks_group", String(groupId).trim(), String(ctx.program).trim(), String(ctx.start).trim()].join("__")
  : ["ovsynch_tasks_animal", String(animalNo).trim(), String(ctx.program).trim(), String(ctx.start).trim()].join("__");

    const lockRef = doc(dbRef, "protocolTaskBatches", batchLockId);
    const lockSnap = await getDoc(lockRef);

   if (!lockSnap.exists()) {

  await setDoc(lockRef, {
    userId: user.uid,
    scope: isGroupMode ? "group" : "animal",
    groupId: isGroupMode ? groupId : null,
    groupName: isGroupMode ? groupName : null,
    animalsCount: isGroupMode ? ctx.animalIds.length : null,
    animalNumber: isGroupMode ? null : animalNo,
    program: ctx.program,
    startDate: ctx.start,
    createdAt: serverTimestamp()
  }, { merge: true });


  // ğŸ‘‡ Ù‡Ù†Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù„ÙŠ ÙƒÙ†Øª Ù…Ø´ ÙØ§Ù‡Ù…Ù‡
// âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· (Ø­Ø³Ø¨ Group / Animal)
if (isGroupMode) {

  // âœ… ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  await ensureProtocolTasks({
    animalNumber: `group:${String(groupId || "").trim()}`,              
    protocolStartDate: ctx.start,
    program: ctx.program,
    userId: user.uid,
    scope: "group",
    groupId: String(groupId || "").trim(),
    groupName: String(groupName || "").trim(),
    animalsCount: Number(ctx.animalIds.length),
    alertEnabled: true
  });

} else {

  // âœ… ÙØ±Ø¯ÙŠ (ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø­ÙŠÙˆØ§Ù† ÙÙ‚Ø·)
  await ensureProtocolTasks({
    animalNumber: String(animalNo || "").trim(),
    protocolStartDate: ctx.start,
    program: ctx.program,
    userId: user.uid,
    scope: "animal",
    alertEnabled: true
  });

}

  // ØªÙ‚Ø¯Ù… Ø¨Ø³ÙŠØ·
 showInfo(`âœ… ØªÙ… Ø­ÙØ¸ (${idx+1}/${ctx.animalIds.length}) Ø±Ù‚Ù… ${animalNo}`);

}

} // âœ… Ù‚ÙÙ„ if (dbRef)
} // âœ… Ù‚ÙÙ„ for


        showInfo('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
      }catch(e){
        console.error(e);
        showWarn('âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
      }finally{
        saveBtn.disabled = false;
        saveBtn.textContent = oldTxt;
      }
    }

    saveBtn.addEventListener('click', saveProtocol);
    form.addEventListener('submit', (e)=>{ e.preventDefault(); saveProtocol(); });

    // âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    hydrate();
    startDateEl.addEventListener('input', updateSteps);
    programEl.addEventListener('change', updateSteps);

    updateSteps();

  })();
</script>

</body>
</html>
