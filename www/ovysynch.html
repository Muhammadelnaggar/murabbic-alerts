<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <!-- (Ù‡Ù†Ø±Ø¬Ø¹ Ù„Ù…Ù„Ø§Ø­Ø¸Ø© animal-update.js Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§) -->
  <script type="module">
    import { updateAnimalByEvent } from "/js/animal-update.js";
    window.updateAnimalByEvent = updateAnimalByEvent;
  </script>

  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <title>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¶ ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</title>

  <style>
    body{
      margin:0;padding:0;
      background: var(--bg, #f7faf7);
      color: var(--text, #0f172a);
      font-family:'Cairo',Tahoma,Arial,sans-serif;
      direction: rtl;
    }

    header{
      position: sticky; top: 0; z-index: 20;
      background: #fff;
      border-bottom: 1px solid var(--border, #e2e8f0);
    }
    .mbk-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px;
    }
    .mbk-logo{ height:48px; width:auto; object-fit:contain; opacity:.95; flex-shrink:0; }
    .mbk-center{ flex:1; text-align:center; line-height:1.2; }
    .mbk-page-title{ font-size:18px; font-weight:900; color: var(--ink, #0f172a); }
    .mbk-app-name{ font-size:13px; font-weight:800; color: var(--brand-600, #0b7f47); opacity:.9; }
    .mbk-back{
      width:42px; height:42px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      text-decoration:none; font-weight:900;
      color: var(--brand-600, #0b7f47);
      border:2px solid var(--brand-600, #0b7f47);
      background:#fff; flex-shrink:0;
    }

    .wrap{ max-width:520px; margin:12px auto 24px; padding:0 12px; }
    .mbk-card{
      background:#fff;
      border:1px solid var(--border, #e2e8f0);
      border-radius:16px;
      padding:14px;
      box-shadow:0 1px 0 rgba(15,23,42,.04);
    }

    .row{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:640px){ .row-2{ grid-template-columns:1fr 1fr; } }

    .hint{ font-size:12px; opacity:.65; line-height:1.4; }

    .steps{
      margin-top:12px;
      border:1px solid var(--border, #e2e8f0);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .step{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px;
      border-bottom:1px dashed var(--border, #e2e8f0);
    }
    .step:last-child{ border-bottom:none; }
    .step .name{ font-weight:900; }
    .step .date{ font-size:13px; opacity:.85; white-space:nowrap; }
    .step .chk{ display:flex; align-items:center; gap:8px; justify-content:flex-start; }
    .step input[type="checkbox"]{ width:18px; height:18px; }

    .on-time{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border, #e2e8f0); }
    .ok{ background:#f0fff6; border-color:#bbf7d0; }
    .late{ background:#fff7ed; border-color:#fed7aa; }

    #warn{ margin-top:10px; color:#b91c1c; font-weight:800; min-height:18px; }

    #info.infobar{
      display:none;
      position: sticky;
      top: 72px;
      z-index: 19;
      margin: 10px 0 10px;
    }
    #info .msgrow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    #info .okbtn{
      flex-shrink:0;
      border-radius:12px;
      padding:8px 12px;
      font-weight:900;
      border:2px solid var(--brand-600, #0b7f47);
      background:#fff;
      color: var(--brand-600, #0b7f47);
      cursor:pointer;
    }

    .btn-row{
      position: sticky;
      bottom: 10px;
      background: #fff;
      padding: 10px;
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 16px;
      display:flex;
      gap:10px;
      margin:14px 12px 18px;
      max-width:520px;
      margin-left:auto; margin-right:auto;
    }
    .btn-row .save-btn,
    .btn-row .open-card{
      flex:1; width:auto;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    .btn-row .save-btn{
      background: var(--brand, #0ea05a);
      color:#fff; border:0;
    }
    .btn-row .open-card{
      background:#fff !important;
      color: var(--brand-600, #0b7f47) !important;
      border:2px solid var(--brand-600, #0b7f47) !important;
    }
  </style>
</head>

<body>
  <header>
    <div class="mbk-head">
      <a class="mbk-back" href="add-event.html" title="Ø±Ø¬ÙˆØ¹">Ø±Ø¬ÙˆØ¹</a>

      <div class="mbk-center">
        <div class="mbk-page-title">Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªØ²Ø§Ù…Ù† ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­</div>
        <div class="mbk-app-name">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
      </div>

      <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
    </div>
  </header>

  <div class="wrap">
    <div id="info" class="infobar"></div>
    <div class="mbk-card">
      <form id="ovForm" autocomplete="off">
        <!-- âœ… Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ÙØ±Ø¯ÙŠ / Ù…Ø¬Ù…ÙˆØ¹Ø© -->
<div class="field" style="margin-bottom:12px">
  <div style="display:flex;gap:12px;align-items:center;font-weight:900">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input type="radio" name="mbkMode" id="modeSingle" value="single" checked>
      â¬¤ ØªØ³Ø¬ÙŠÙ„ Ù„Ø­ÙŠÙˆØ§Ù† ÙˆØ§Ø­Ø¯
    </label>

    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input type="radio" name="mbkMode" id="modeGroup" value="group">
      â¬¤ ØªØ³Ø¬ÙŠÙ„ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø­ÙŠÙˆØ§Ù†Ø§Øª
    </label>
  </div>
  <div class="hint" id="modeHint" style="margin-top:6px">
    Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹â€¦ ÙˆØ§Ù„ØµÙØ­Ø© Ø³ØªÙØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
  </div>
</div>
        <div id="modeBulkBox">
        <div class="row" style="margin-bottom:12px">
          <div class="field">
            <label for="bulkAnimals">Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ (ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø±)</label>
            <textarea id="bulkAnimals" rows="4" placeholder="Ù…Ø«Ø§Ù„:
105
106
110"></textarea>
            <div class="hint">Ù„Ùˆ ÙƒØªØ¨Øª Ù‡Ù†Ø§: Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù….</div>
          </div>

          <button id="applyBulk" type="button" class="open-card" style="width:100%;margin-top:6px">
            ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          </button>

          <div class="hint" id="bulkHint" style="margin-top:6px;opacity:.75"></div>
        </div>

      <div class="row" style="margin-top:10px">
  <div class="field">
    <label for="groupSelect">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</label>
    <select id="groupSelect">
      <option value="" selected>â€” Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© â€”</option>
    </select>
    <div class="hint">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ù†ÙØ³ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©).</div>
  </div>

  <div class="row row-2">
    <button id="loadGroup" type="button" class="open-card">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
    <button id="saveGroup" type="button" class="open-card">Ø­ÙØ¸ ÙƒÙ€ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
  </div>
</div>
</div>          


        <div class="row row-2">
          <div id="modeSingleBox">
          <div class="field">
            <label for="animalId">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
            <input id="animalId" type="text" placeholder="Ù…Ø«Ø§Ù„: 105" />
          </div>
          </div>
          <div class="field">
            <label for="startDate">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ (Ø§Ù„ÙŠÙˆÙ… 0)</label>
            <input id="startDate" type="date" />
          </div>

          <div class="field">
            <label for="startTime">Ø³Ø§Ø¹Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</label>
            <input id="startTime" type="time" value="08:00" />
            <div class="hint">Ù…Ø«Ø§Ù„: 08:00 ØµØ¨Ø§Ø­Ù‹Ø§ â€” Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="field">
            <label for="program">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
            <select id="program">
              <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</option>
              <option value="ovsynch">Ovsynch</option>
              <option value="cosynch72">Cosynch-72</option>
              <option value="presynch_ovsynch">Presynch + Ovsynch</option>
            </select>
            <div class="muted hint">Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© âœ“ Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° ÙƒÙ„ Ø®Ø·ÙˆØ©.</div>
          </div>
        </div>

        <div id="stepsBox" class="steps" aria-live="polite"></div>
        <div id="warn"></div>
      </form>
    </div>
  </div>

  <div class="btn-row">
    <button id="saveBtn" class="save-btn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</button>
    <button id="openCowCard" class="open-card" type="button">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, doc, setDoc, getDoc,
      query, where, limit, getDocs, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    (async () => {
      const form          = document.getElementById('ovForm');
      const animalIdEl    = document.getElementById('animalId');
      const startDateEl   = document.getElementById('startDate');
      const startTimeEl   = document.getElementById('startTime');

      const bulkEl        = document.getElementById('bulkAnimals');
      const applyBulkBtn  = document.getElementById('applyBulk');
      const bulkHintEl    = document.getElementById('bulkHint');

      const groupSelectEl = document.getElementById('groupSelect');
      const loadGroupBtn  = document.getElementById('loadGroup');
      const saveGroupBtn  = document.getElementById('saveGroup');

      const programEl     = document.getElementById('program');
      const stepsBox      = document.getElementById('stepsBox');

      const saveBtn       = document.getElementById('saveBtn');
      const openCardBtn   = document.getElementById("openCowCard");

      const warnEl        = document.getElementById('warn');
      const infoEl        = document.getElementById('info');
      // ===================== UI Mode (Single / Group) =====================
const modeSingleEl = document.getElementById('modeSingle');
const modeGroupEl  = document.getElementById('modeGroup');
const modeHintEl   = document.getElementById('modeHint');

const modeBulkBox  = document.getElementById('modeBulkBox');
const modeSingleBox= document.getElementById('modeSingleBox');

function getMode(){
  return (modeGroupEl && modeGroupEl.checked) ? "group" : "single";
}

function setMode(mode){
  const m = (mode === "group") ? "group" : "single";
  try{ localStorage.setItem("mbk_ov_mode", m); }catch{}

  if (modeSingleEl) modeSingleEl.checked = (m === "single");
  if (modeGroupEl)  modeGroupEl.checked  = (m === "group");

  // show/hide
  if (modeBulkBox)   modeBulkBox.style.display   = (m === "group") ? "block" : "none";
  if (modeSingleBox) modeSingleBox.style.display = (m === "single") ? "block" : "none";

  // Hint ÙˆØ§Ø¶Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  if (modeHintEl){
    modeHintEl.textContent = (m === "single")
      ? "âœ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: ØªØ³Ø¬ÙŠÙ„ Ù„Ø­ÙŠÙˆØ§Ù† ÙˆØ§Ø­Ø¯ (Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø¨Ø§Ù„Ø£Ø³ÙÙ„)."
      : "âœ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: ØªØ³Ø¬ÙŠÙ„ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø­Ù…Ù‘Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­ÙÙˆØ¸Ø©).";
  }

  // ğŸ”¥ Ø¹Ø¨Ù‚Ø±ÙŠØ© Ø¨Ø³ÙŠØ·Ø©: Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙØ±Ø¯ÙŠ Ø«Ù… Ø§Ø®ØªØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø©â€¦ Ù„Ø§ Ù†Ø¶ÙŠÙ‘Ø¹Ù‡
  if (m === "group"){
    const singleNum = (animalIdEl?.value || "").trim();
    const bulkRaw = (bulkEl?.value || "").trim();
    if (singleNum && !bulkRaw){
      bulkEl.value = singleNum;
      parseBulkList();
    } else if (singleNum && bulkRaw){
      // Ù„Ùˆ Ø§Ù„Ø±Ù‚Ù… Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø£Ø¶ÙÙ‡ Ø£ÙˆÙ„ Ø³Ø·Ø±
      const lines = bulkRaw.split(/\n|,|;/g).map(x=>String(x||"").trim()).filter(Boolean);
      if (!lines.includes(singleNum)){
        bulkEl.value = [singleNum, ...lines].join("\n");
        parseBulkList();
      }
    }
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¶Ø¹
modeSingleEl?.addEventListener("change", ()=> setMode("single"));
modeGroupEl?.addEventListener("change",  ()=> setMode("group"));

// ÙƒÙ„ÙŠÙƒ Ø°ÙƒÙŠ: Ù„Ùˆ Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ -> ÙŠØªØ­ÙˆÙ„ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
bulkEl?.addEventListener("focus", ()=> setMode("group"));
// Ù„Ùˆ Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† -> ÙŠØªØ­ÙˆÙ„ Ù„ÙØ±Ø¯ÙŠ
animalIdEl?.addEventListener("focus", ()=> setMode("single"));

      let dbRef = null, authRef = null;
      let stepsState = [];

      let bulkList = [];
      let currentGroupId = "";
      let currentGroupName = "";
      let currentGroupFromCloud = false;

      function todayLocal(){
        const d = new Date();
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0,10);
      }
      function showWarn(t){ if(warnEl) warnEl.textContent = t || ""; }
      function clearWarn(){ if(warnEl) warnEl.textContent = ""; }

      function showInfo(text, isErr){
        if(!infoEl) return;
        infoEl.style.display = "block";
        infoEl.className = "infobar " + (isErr ? "error" : "show");
        infoEl.innerHTML = `
          <div class="msgrow">
            <div class="msgtext" style="white-space:pre-line">${String(text||"")}</div>
            <button type="button" class="okbtn" id="infoOkBtn">Ø­Ø³Ù†Ù‹Ø§</button>
          </div>
        `;
        try{ infoEl.scrollIntoView({behavior:"smooth", block:"start"}); }catch{}
        const btn = document.getElementById("infoOkBtn");
        if(btn){
          btn.onclick = () => { infoEl.style.display="none"; infoEl.innerHTML=""; };
        }
      }

      function parseBulkList(){
        const raw = (bulkEl?.value || "").trim();
        if(!raw){
          bulkList = [];
          if(bulkHintEl) bulkHintEl.textContent = "";
          return [];
        }
        const arr = raw
          .split(/\n|,|;/g)
          .map(s => String(s||"").trim())
          .filter(Boolean);

        const seen = new Set();
        bulkList = arr.filter(x => (seen.has(x) ? false : (seen.add(x), true)));

        if(bulkHintEl){
          bulkHintEl.textContent = bulkList.length
            ? `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${bulkList.length} Ø­ÙŠÙˆØ§Ù†: ${bulkList.slice(0,8).join("ØŒ ")}${bulkList.length>8?" ...":""}`
            : "";
        }
        return bulkList;
      }
function _normTypeText(v){
  return String(v || "")
    .replace(/[\u064B-\u0652\u0670]/g, "")
    .replace(/[Ø£Ø¥Ø¢]/g, "Ø§")
    .replace(/Ø©/g, "Ù‡")
    .replace(/Ù‰/g, "ÙŠ")
    .toLowerCase()
    .trim();
}

function isBuffaloType(animalDoc){
  // âœ… ØªØºØ·ÙŠØ© ÙƒÙ„ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ (ÙˆÙ…Ù†Ù‡Ø§ animaltype + animalTypeAr)
  const candidates = [
    animalDoc?.type,
    animalDoc?.animalType,
    animalDoc?.animaltype,        // âœ… Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ (Ø²ÙŠ Ø§Ù„ØµÙˆØ±Ø©)
    animalDoc?.animalTypeAr,      // âœ… Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ (Ø²ÙŠ Ø§Ù„ØµÙˆØ±Ø©)
    animalDoc?.kind,
    animalDoc?.species,
    animalDoc?.animalSpecies,
    animalDoc?.category,
    animalDoc?.animalCategory,
    animalDoc?.speciesName,
    animalDoc?.breed,
    animalDoc?.breedName,
    animalDoc?.animalBreed,
    animalDoc?.notes
  ];

  const joined = _normTypeText(candidates.filter(Boolean).join(" | "));

  // âœ… Ø¹Ø±Ø¨ÙŠ
  if (joined.includes("Ø¬Ø§Ù…ÙˆØ³")) return true;

  // âœ… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
  if (joined.includes("buffalo")) return true;
  if (joined.includes("water buffalo")) return true;

  // âœ… Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø©
  if (joined.includes("buffloe")) return true;
  if (joined.includes("bufflo")) return true;

  // âœ… Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù…Ø­ØªÙ…Ù„Ø©
  if (/\b(buf|buff|wbuff)\b/.test(joined)) return true;

  return false;
}

      function postpartumMinDaysByType(animalDoc){
        return isBuffaloType(animalDoc) ? 40 : 49;
      }
      function daysSinceISO(isoDate, refISO){
        if(!isoDate) return null;
        const a = new Date(String(isoDate).slice(0,10) + "T00:00:00");
        const b = new Date(String(refISO || todayLocal()).slice(0,10) + "T00:00:00");
        if(isNaN(a) || isNaN(b)) return null;
        return Math.floor((b - a) / (1000*60*60*24));
      }

      function invalidAnimalMessage(reason, num, extra){
        const label = isBuffaloType(extra?.animal) ? "Ø¬Ø§Ù…ÙˆØ³Ø©" : "Ø¨Ù‚Ø±Ø©";
        if(reason === "not_found") return `â›” Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø±Ù‚Ù… ${num} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.`;
        if(reason === "sale") return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ù…Ø¨Ø§Ø¹Ø©).`;
        if(reason === "death") return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ù†Ø§ÙÙ‚Ø©).`;
        if(reason === "inactive") return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø·ÙŠØ¹.`;
        if(reason === "cull") return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ù…Ø³ØªØ¨Ø¹Ø¯Ø© (Ù„Ø§ ØªÙÙ„Ù‚Ù‘Ø­ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰).`;
        if(reason === "pregnant") return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ø¹ÙØ´Ø§Ø±.`;
        if(reason === "inseminated") return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: Ù…ÙÙ„Ù‚Ù‘Ø­Ø©.`;
        if(reason === "fresh_postpartum"){
          const dim = Number.isFinite(extra?.dim) ? extra.dim : null;
          const min = Number.isFinite(extra?.minDim) ? extra.minDim : null;
          const refType = String(extra?.refType || "calving");
          const refLabel = (refType === "abortion") ? "Ø¨Ø¹Ø¯ Ø¥Ø¬Ù‡Ø§Ø¶" : "Ø¨Ø¹Ø¯ ÙˆÙ„Ø§Ø¯Ø©";
          if(dim !== null && min !== null){
            return `â›” ${label} Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ²Ø§Ù…Ù† Ù„Ø£Ù†Ù‡Ø§: ${refLabel} â€” Ø§Ù„Ø£ÙŠØ§Ù… ${dim} (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ${min} Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹).`;
          }
          return `â›” ${label} Ø±Ù‚Ù… ${num} Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ø§Ù„ØªØ²Ø§Ù…Ù† Ù„Ù‡Ø§
Ù„Ø£Ù†Ù‡Ø§ Ø¨Ø¹Ø¯ ÙˆÙ„Ø§Ø¯Ø© ${dim} ÙŠÙˆÙ…
ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ²Ø§Ù…Ù† Ù‡Ùˆ ${min} ÙŠÙˆÙ….`;

        }
        return `â›” Ø±Ù‚Ù… ${num} ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„ØªØ²Ø§Ù…Ù†.`;
      }

      // ===================== EVENTS helpers (Smart fallback ÙÙ‚Ø·) =====================
      function pickISO(d){
        const s = String(d || "").slice(0,10);
        return /^\d{4}-\d{2}-\d{2}$/.test(s) ? s : "";
      }
      function eventISO(ev){
        return pickISO(ev?.eventDate) || pickISO(ev?.date) || pickISO(ev?.startDate) || pickISO(ev?.protocolStartDate);
      }
      function normType(ev){ return String(ev?.type || "").trim().toLowerCase(); }
      function normEventType(ev){ return String(ev?.eventType || "").trim().toLowerCase(); }

      function classifyReproFromEvent(ev){
        const t = normType(ev);
        const et = normEventType(ev);

        // âœ… ÙˆÙ„Ø§Ø¯Ø©
        if (t.includes("calv") || et.includes("ÙˆÙ„Ø§Ø¯Ø©")) return { repro:"Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©", kind:"calving" };

        // âœ… Ø¥Ø¬Ù‡Ø§Ø¶
        if (t.includes("abort") || et.includes("Ø¥Ø¬Ù‡Ø§Ø¶")) return { repro:"Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©", kind:"abortion" };

        // âœ… ØªØ´Ø®ÙŠØµ Ø­Ù…Ù„
        if (t.includes("preg") || et.includes("ØªØ´Ø®ÙŠØµ Ø­Ù…Ù„")) {
          const res = String(ev?.result || ev?.diagnosisResult || "").trim();
          if (res === "Ø¹Ø´Ø§Ø±") return { repro:"Ø¹Ø´Ø§Ø±", kind:"pregnant" };
          if (res === "ÙØ§Ø±ØºØ©") return { repro:"Ù…ÙØªÙˆØ­Ù‡", kind:"open" };
          return { repro:"", kind:"pd_unknown" };
        }

        // âœ… ØªÙ„Ù‚ÙŠØ­
        if (t.includes("insemin") || et.includes("ØªÙ„Ù‚ÙŠØ­")) return { repro:"Ù…Ù„Ù‚Ø­", kind:"inseminated" };

        return { repro:"", kind:"" };
      }

      // âœ… Ù‚Ø±Ø§Ø± SMART: Ù…ØªÙ‰ Ù†Ø´Ùƒ ÙÙŠ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ÙˆÙ†Ø­ØªØ§Ø¬ eventsØŸ
      function needsEventsFallback(animalDoc){
        if(!animalDoc) return true;

        const repro = String(animalDoc.reproductiveStatus || "").trim();
        const hasDIM = Number.isFinite(Number(animalDoc.daysInMilk));
        const calv = pickISO(animalDoc.lastCalvingDate);
        const abrt = pickISO(animalDoc.lastAbortionDate || animalDoc.lastAbortDate);

        // 1) Ø§Ù„Ø­Ø§Ù„Ø© ÙØ§Ø¶ÙŠØ©/ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©
        if(!repro) return true;

        // 2) Ù…ÙƒØªÙˆØ¨ "Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©" Ù„ÙƒÙ† Ù…ÙÙŠØ´ Ù…Ø±Ø¬Ø¹ ÙˆØ§Ø¶Ø­ (Ù„Ø§ DIM ÙˆÙ„Ø§ ØªÙˆØ§Ø±ÙŠØ®)
        if(repro === "Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©" && !hasDIM && !calv && !abrt) return true;

        // 3) Ù…ÙÙŠØ´ ØªÙˆØ§Ø±ÙŠØ® ÙˆÙ„Ø§Ø¯Ø©/Ø¥Ø¬Ù‡Ø§Ø¶ ÙˆÙ„Ø§ DIM (ÙˆÙ…Ø¹ Ø°Ù„Ùƒ Ø§Ø­Ù†Ø§ Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ù…Ø±Ø¬Ø¹ Ù„Ù„Ø¨ÙˆØ³ØªØ¨Ø§Ø±ØªÙ…)
        if(!hasDIM && !calv && !abrt) return true;

        return false;
      }

      async function getActualReproFromEvents(animalNumber, uid){
        if(!dbRef || !uid) return { repro:"", lastCalvingDate:"", lastAbortionDate:"" };

        const evRef = collection(dbRef, "events");
        let snap = null;

        // 1) Ø§Ù„Ø£ÙØ¶Ù„: orderBy(eventDate desc)
        try{
          snap = await getDocs(query(
            evRef,
            where("userId","==",uid),
            where("animalNumber","==",String(animalNumber).trim()),
            orderBy("eventDate","desc"),
            limit(25)
          ));
        }catch(e1){
          // 2) fallback: orderBy(createdAt desc)
          try{
            snap = await getDocs(query(
              evRef,
              where("userId","==",uid),
              where("animalNumber","==",String(animalNumber).trim()),
              orderBy("createdAt","desc"),
              limit(25)
            ));
          }catch(e2){
            return { repro:"", lastCalvingDate:"", lastAbortionDate:"" };
          }
        }

        const list = snap?.docs?.map(d=>d.data()||{}) || [];
        if(!list.length) return { repro:"", lastCalvingDate:"", lastAbortionDate:"" };

        let lastCalv = "";
        let lastAbrt = "";
        for(const ev of list){
          const iso = eventISO(ev);
          if(!iso) continue;

          const c = classifyReproFromEvent(ev);
          if(c.kind === "calving" && (!lastCalv || iso > lastCalv)) lastCalv = iso;
          if(c.kind === "abortion" && (!lastAbrt || iso > lastAbrt)) lastAbrt = iso;
        }

        // âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© = Ø£ÙˆÙ„ Ø­Ø¯Ø« â€œØ­Ø§Ø³ÙÙ…â€ ÙÙŠ Ø§Ù„Ø£Ø­Ø¯Ø«
        for(const ev of list){
          const c = classifyReproFromEvent(ev);
          if(c.repro) return { repro:c.repro, lastCalvingDate:lastCalv, lastAbortionDate:lastAbrt };
        }

        return { repro:"", lastCalvingDate:lastCalv, lastAbortionDate:lastAbrt };
      }
      // ===================== /EVENTS helpers =====================

      async function checkAnimalQuick(num){
        if(!dbRef) return { ok:true };
        if(!authRef?.currentUser) return { ok:false, reason:"auth_blocked_silent" };

        const uid = authRef.currentUser.uid;
        const animalsRef = collection(dbRef, "animals");

        // 1) number ÙƒÙ†Øµ
        let snap = await getDocs(query(
          animalsRef,
          where("userId","==",uid),
          where("number","==",String(num)),
          limit(1)
        ));

        // 2) animalNumber ÙƒØ±Ù‚Ù…
        if(snap.empty){
          snap = await getDocs(query(
            animalsRef,
            where("userId","==",uid),
            where("animalNumber","==",Number(num)),
            limit(1)
          ));
        }

        if(snap.empty) return { ok:false, reason:"not_found" };

        const a = snap.docs[0].data() || {};

        // âœ… Ø£ÙˆÙ„ÙˆÙŠØ©: Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø·ÙŠØ¹
        const status = String(a.status || "active").toLowerCase();
        const inactiveReason = String(a.inactiveReason || "").toLowerCase();
        if(status === "inactive"){
          if(inactiveReason === "sale")  return { ok:false, reason:"sale", animal:a };
          if(inactiveReason === "death") return { ok:false, reason:"death", animal:a };
          return { ok:false, reason:"inactive", animal:a };
        }

        // âœ… Ù…Ø³ØªØ¨Ø¹Ø¯Ø© (Ù„Ø§ ØªÙÙ„Ù‚Ù‘Ø­)
        const breedingBlocked = !!a.breedingBlocked;
        const reproDoc = String(a.reproductiveStatus || "").trim();
        if(breedingBlocked || reproDoc === "Ù„Ø§ ØªÙÙ„Ù‚Ù‘Ø­ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"){
          return { ok:false, reason:"cull", animal:a };
        }

        // âœ… SMART: Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø£ÙˆÙ„Ù‹Ø§ØŒ ÙˆÙ†Ù„Ø¬Ø£ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø´Ùƒ
        let repro = reproDoc;
        let calv = pickISO(a.lastCalvingDate);
        let abrt = pickISO(a.lastAbortionDate || a.lastAbortDate);

        if(needsEventsFallback(a)){
          const actual = await getActualReproFromEvents(String(num).trim(), uid);

          // ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø£Ø¹Ø·Øª Ù‚ÙŠÙ…Ø© Ù…ÙÙŠØ¯Ø©
          if(actual?.repro) repro = actual.repro;

          // ØªÙˆØ§Ø±ÙŠØ® Ù…Ø±Ø¬Ø¹ÙŠØ© Ù„Ù„Ø¨ÙˆØ³ØªØ¨Ø§Ø±ØªÙ… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
          if(actual?.lastCalvingDate) calv = actual.lastCalvingDate;
          if(actual?.lastAbortionDate) abrt = actual.lastAbortionDate;
        }

        // âœ… Ù…Ù†Ø¹ Ø¹Ø´Ø§Ø±/Ù…Ù„Ù‚Ø­
        if(repro === "Ø¹Ø´Ø§Ø±") return { ok:false, reason:"pregnant", animal:a };
        if(repro === "Ù…Ù„Ù‚Ø­") return { ok:false, reason:"inseminated", animal:a };

        // âœ… Ø¨ÙˆØ³ØªØ¨Ø§Ø±ØªÙ…: Ù…Ù† (Ø£Ø­Ø¯Ø« ÙˆÙ„Ø§Ø¯Ø©/Ø¥Ø¬Ù‡Ø§Ø¶) Ø£Ùˆ DIM Ø¥Ù† Ù…ÙˆØ¬ÙˆØ¯
        let refType = "calving";
        let refDate = calv;

        if (abrt && (!calv || abrt > calv)) {
          refType = "abortion";
          refDate = abrt;
        }

       const refISO = todayLocal();
const dim = daysSinceISO(refDate, refISO); // âœ… Ù…ØµØ¯Ø± ÙˆØ§Ø­Ø¯: lastCalvingDate/lastAbortionDate

        const minDim = postpartumMinDaysByType(a);

       const dimN = Number(dim);
const minN = Number(minDim);

if (Number.isFinite(dimN) && Number.isFinite(minN) && dimN >= 0 && dimN < minN) {
  return { ok:false, reason:"fresh_postpartum", refType, dim: dimN, minDim: minN, animalType, animal:a };
}


        // âœ… Ù„Ùˆ Ù…ÙƒØªÙˆØ¨ Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø­ØªÙ‰ Ù…Ø¹ Ù†Ù‚Øµ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹
        if (repro === "Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©") {
          if (dim === null) return { ok:false, reason:"fresh_postpartum", refType, animal:a };
          return { ok:false, reason:"fresh_postpartum", refType, dim, minDim, animal:a };
        }

        return { ok:true, animal:a };
      }

      // âœ… ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
      openCardBtn?.addEventListener("click", ()=>{
        const id = (animalIdEl.value || "").trim();
        if(!id) return;
        location.href = `cow-card.html?number=${encodeURIComponent(id)}`;
      });
// âœ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙˆÙ†ØªÙƒØ³Øª
function hydrate(){
  const qp = new URLSearchParams(location.search);

  const id =
    (qp.get('number') || qp.get('animalNumber') || qp.get('animalId') || "").trim() ||
    (localStorage.getItem('lastAnimalId') || "").trim();

  const dt =
    (qp.get('date') || qp.get('eventDate') || "").trim() ||
    (localStorage.getItem('lastEventDate') || "").trim() ||
    todayLocal();

  // âœ… Ø§Ù„ØªØ§Ø±ÙŠØ®
  if (dt){
    startDateEl.value = dt;
    try{ localStorage.setItem('lastEventDate', dt); }catch{}
  }

  // âœ… Ø§Ù„Ø±Ù‚Ù…
  if (id){
    try{ localStorage.setItem('lastAnimalId', id); }catch{}

    const savedMode = (localStorage.getItem("mbk_ov_mode") || "single");

    if (savedMode === "group"){
      const raw = (bulkEl?.value || "").trim();
      if(!raw){
        bulkEl.value = id;
      }else{
        const lines = raw.split(/\n|,|;/g).map(x=>String(x||"").trim()).filter(Boolean);
        if(!lines.includes(id)) bulkEl.value = [id, ...lines].join("\n");
      }
      parseBulkList();
    }else{
      animalIdEl.value = id;
    }
  }
}


      // âœ… ØªØ­Ù‚Ù‘Ù‚ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙØ±Ø¯ÙŠ
      animalIdEl?.addEventListener("change", async ()=>{
        const num = (animalIdEl.value||"").trim();
        if(!num) return;

        const r = await checkAnimalQuick(num);
        if(r.reason === "auth_blocked_silent") return;

        if(!r.ok){
          showInfo(invalidAnimalMessage(r.reason, num, r), true);
          animalIdEl.value = "";
          try{ animalIdEl.focus(); }catch{}
        }
      });

      function toISODateLocal(d){
        const dd = new Date(d);
        return new Date(dd.getTime() - dd.getTimezoneOffset()*60000).toISOString().slice(0,10);
      }

      const PROGRAMS = {
        ovsynch:[
          { day: 0,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
          { day: 7,  name:'PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
          { day: 9,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 9 ~ Ø¨Ø¹Ø¯ ~56 Ø³Ø§Ø¹Ø©)' },
          { day: 10, name:'ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 ~ Ø¨Ø¹Ø¯ ~16 Ø³Ø§Ø¹Ø©)' },
        ],
        cosynch72:[
          { day: 0,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
          { day: 7,  name:'PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
          { day: 10, name:'GnRH + ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 â‰ˆ 72 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ PGF)' },
        ],
        presynch_ovsynch:[
          { day:-28, name:'Presynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… -28)' },
          { day:-14, name:'Presynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… -14)' },
          { day: 0,  name:'Ovsynch: GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
          { day: 7,  name:'Ovsynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
          { day: 9,  name:'Ovsynch: GnRH (Ø§Ù„ÙŠÙˆÙ… 9 ~ Ø¨Ø¹Ø¯ ~56 Ø³Ø§Ø¹Ø©)' },
          { day: 10, name:'Ovsynch: ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 ~ Ø¨Ø¹Ø¯ ~16 Ø³Ø§Ø¹Ø©)' },
        ]
      };

      function calcStepDateTime(program, startISO, baseTime, step){
        if (program === "ovsynch" || program === "presynch_ovsynch") {
          const pgfDT = new Date(startISO + "T" + (baseTime||"08:00"));
          pgfDT.setDate(pgfDT.getDate() + 7);

          if (step.day === 9 && String(step.name).includes("GnRH")) {
            return new Date(pgfDT.getTime() + 56 * 3600 * 1000);
          }
          if (String(step.name).includes("ØªÙ„Ù‚ÙŠØ­")) {
            return new Date(pgfDT.getTime() + 72 * 3600 * 1000);
          }
          const d = new Date(startISO + "T" + (baseTime||"08:00"));
          d.setDate(d.getDate() + step.day);
          return d;
        }

        if (program === "cosynch72") {
          const pgfDT = new Date(startISO + "T" + (baseTime||"08:00"));
          pgfDT.setDate(pgfDT.getDate() + 7);

          if (String(step.name).includes("ØªÙ„Ù‚ÙŠØ­") || (String(step.name).includes("GnRH") && step.day === 10)) {
            return new Date(pgfDT.getTime() + 72 * 3600 * 1000);
          }
          const d = new Date(startISO + "T" + (baseTime||"08:00"));
          d.setDate(d.getDate() + step.day);
          return d;
        }

        const d = new Date(startISO + "T" + (baseTime||"08:00"));
        d.setDate(d.getDate() + step.day);
        return d;
      }

      function updateSteps(){
        stepsBox.innerHTML = '';
        const start = (startDateEl.value || "").trim();
        const program = (programEl.value || "").trim();
        const baseTime = (startTimeEl.value || "08:00").trim();
        if(!start || !program) return;

        const tpl = PROGRAMS[program] || [];
        const prev = stepsState;

        stepsState = tpl.map((s)=>{
          const dd = calcStepDateTime(program, start, baseTime, s);
          const local = new Date(dd.getTime() - dd.getTimezoneOffset()*60000);
          const isoDT = local.toISOString().slice(0,16);
          const plannedDate = toISODateLocal(dd);

          const keep = prev.find(p => p.name===s.name && p.day===s.day);
          return {
            day: s.day,
            name: s.name,
            date: isoDT,
            plannedDate,
            done: keep ? !!keep.done : false,
            confirmedOn: keep ? keep.confirmedOn || null : null,
            onSchedule: keep ? !!keep.onSchedule : false,
            _savedOnce: keep ? !!keep._savedOnce : false,
          };
        });

        stepsState.forEach((st, idx)=>{
          const row = document.createElement('div');
          row.className = 'step';

          const chip = st.done
            ? `<span class="on-time ${st.onSchedule ? 'ok' : 'late'}">${st.onSchedule ? 'âœ“ ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯' : 'âœ“ Ù…Ø¤ÙƒØ¯Ø©'}</span>`
            : '';

          row.innerHTML = `
            <div>
              <div class="name">${st.name}</div>
              <div class="date">ğŸ“… ${new Date(st.date).toLocaleString('ar-EG')} ${chip}</div>
            </div>
            <label class="chk">
              <input data-idx="${idx}" type="checkbox" ${st.done ? 'checked' : ''}/>
              ØªÙ…
            </label>
          `;
          stepsBox.appendChild(row);
        });
      }

      stepsBox.addEventListener('change', (e)=>{
        const el = e.target.closest('input[type="checkbox"][data-idx]');
        if(!el) return;

        const i = Number(el.getAttribute('data-idx'));
        const st = stepsState[i];
        if(!st) return;

        const today = todayLocal();
        st.done = el.checked;
        st.confirmedOn = el.checked ? today : null;
        st.onSchedule = el.checked ? (today === st.plannedDate) : false;

        updateSteps(); // ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·
      });

      async function setupFirebase(){
        try{
          const mod = await import('/js/firebase-config.js?v=5');
          if(mod?.db && mod?.auth) return { db: mod.db, auth: mod.auth };
          if(mod?.firebaseConfig){
            const app = initializeApp(mod.firebaseConfig);
            return { db: getFirestore(app, "murabbikdata"), auth: getAuth(app) };
          }
        }catch(e){}

        try{
          const cfg = await import('./config.js?v=5');
          const app = initializeApp(cfg.firebaseConfig);
          return { db: getFirestore(app, "murabbikdata"), auth: getAuth(app) };
        }catch(e2){
          showWarn('âŒ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.');
          return { db:null, auth:null };
        }
      }

      const { db, auth } = await setupFirebase();
      dbRef = db;
      authRef = auth;

      async function waitForUser(ms=1500){
        if(!authRef) return null;
        return await new Promise((resolve)=>{
          const t = setTimeout(()=>resolve(authRef.currentUser || null), ms);
          try{
            onAuthStateChanged(authRef, (u)=>{ clearTimeout(t); resolve(u || null); });
          }catch{
            clearTimeout(t);
            resolve(authRef.currentUser || null);
          }
        });
      }

      async function loadGroupsList(){
        if(!dbRef || !authRef?.currentUser || !groupSelectEl) return;

        const q = query(
          collection(dbRef, "protocolGroups"),
          where("userId", "==", authRef.currentUser.uid),
          orderBy("createdAt", "desc")
        );

        const snap = await getDocs(q);
        groupSelectEl.innerHTML = `<option value="" selected>â€” Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© â€”</option>`;
        snap.forEach(docSnap=>{
          const d = docSnap.data() || {};
          const opt = document.createElement("option");
          opt.value = docSnap.id;
          opt.textContent = d.name || docSnap.id;
          groupSelectEl.appendChild(opt);
        });
      }

      async function saveCurrentAsGroup(){
        const list = parseBulkList();
        if(!list.length){ showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø­ÙØ¸ ÙƒÙ…Ø¬Ù…ÙˆØ¹Ø©."); return; }
        const u = await waitForUser(2000);
        if(!u){ showInfo("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯.", true); return; }

        const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ Ù…Ø«Ø§Ù„: Ø¯ÙØ¹Ø© 25 Ø¨Ù‚Ø±Ø© - ÙØ¨Ø±Ø§ÙŠØ±");
        if(!name) return;

        await addDoc(collection(dbRef, "protocolGroups"), {
          userId: u.uid,
          name: String(name).trim(),
          animals: list.map(x=>String(x).trim()),
          createdAt: serverTimestamp()
        });

        showInfo("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©");
        await loadGroupsList();
      }

      async function loadSelectedGroup(){
        const gid = (groupSelectEl?.value || "").trim();
        if(!gid){ showWarn("âš ï¸ Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹."); return; }
        const snap = await getDoc(doc(dbRef, "protocolGroups", gid));
        if(!snap.exists()){ showWarn("âš ï¸ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©."); return; }

        const d = snap.data() || {};
        const arr = Array.isArray(d.animals) ? d.animals : [];

        currentGroupId = gid;
        currentGroupName = String(d.name || gid).trim();
        currentGroupFromCloud = true;

        bulkEl.value = arr.join("\n");
        parseBulkList();
        if(!animalIdEl.value && bulkList.length) animalIdEl.value = bulkList[0];
        showInfo(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${d.name || gid}`);
      }

      loadGroupBtn?.addEventListener("click", loadSelectedGroup);
      saveGroupBtn?.addEventListener("click", saveCurrentAsGroup);

      applyBulkBtn?.addEventListener("click", async ()=>{
        const list = parseBulkList();
        if(!list.length){ showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ."); return; }
        clearWarn();

        const okList = [];
        const bad = [];

        for(const n of list){
          const r = await checkAnimalQuick(n);
          if(r.reason === "auth_blocked_silent") return;
          if(r.ok) okList.push(n);
          else bad.push({ n, reason:r.reason, extra:r });
        }

        if(bad.length){
          bulkEl.value = okList.join("\n");
          parseBulkList();
          const details = bad.map(b => invalidAnimalMessage(b.reason, b.n, b.extra)).join("\n");
          showInfo(`ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ${bad.length} Ø­ÙŠÙˆØ§Ù† Ù„Ø¹Ø¯Ù… Ø§Ù„Ø£Ù‡Ù„ÙŠØ© Ù„Ù„ØªØ²Ø§Ù…Ù†:\n${details}`, true);
        }else{
          showInfo(`âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ ${okList.length} Ø­ÙŠÙˆØ§Ù† Ù„Ù„ØªØ³Ø¬ÙŠÙ„.`);
        }

        if(animalIdEl && !animalIdEl.value && okList.length) animalIdEl.value = okList[0];
      });

      function getCtx(){
       const mode = getMode();

const list = parseBulkList();
const singleId = (animalIdEl.value||'').trim();

const animalIds = (mode === "group") ? list : (singleId ? [singleId] : []);
const animalId  = animalIds[0] || "";

        const start = (startDateEl.value||'').trim();
        const program = (programEl.value||'').trim();

        if(!animalId || !start || !program){
          showWarn('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.');
          return null;
        }

        clearWarn();
        try{ localStorage.setItem('lastAnimalId', animalId); }catch{}
        try{ localStorage.setItem('lastEventDate', start); }catch{}
        return { animalId, animalIds, start, program, steps: stepsState };
      }

      async function saveProtocol(){
        const ctx = getCtx();
        if(!ctx) return;

        const u = await waitForUser(2000);
        if(!u){ showInfo("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯. Ø£Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†.", true); return; }

        const ids = (ctx.animalIds||[]).filter(Boolean);
        if(!ids.length){ showWarn("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ø­ÙŠÙˆØ§Ù†Ø§Øª."); return; }

        const okIds = [];
        const badIds = [];
        for(const n of ids){
          const r = await checkAnimalQuick(n);
          if(r.reason === "auth_blocked_silent") return;
          if(r.ok) okIds.push(n);
          else badIds.push({ n, reason:r.reason, extra:r });
        }

        if(badIds.length){
          bulkEl.value = okIds.join("\n");
          parseBulkList();
          const details = badIds.map(b => invalidAnimalMessage(b.reason, b.n, b.extra)).join("\n");
          showInfo(`ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ${badIds.length} Ø­ÙŠÙˆØ§Ù† Ù„Ø¹Ø¯Ù… Ø§Ù„Ø£Ù‡Ù„ÙŠØ© Ù„Ù„ØªØ²Ø§Ù…Ù†:\n${details}`, true);
        }

        if(!okIds.length){ showInfo("â›” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„.", true); return; }

        saveBtn.disabled = true;
        const oldTxt = saveBtn.textContent;
        saveBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸';

        try{
          for(let i=0;i<okIds.length;i++){
            const animalNo = okIds[i];

            const payload = {
              type: 'ovsynch',
              eventType: 'Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†',
              animalId: animalNo,
              animalNumber: animalNo,
              startDate: ctx.start,
              program: ctx.program,
              steps: ctx.steps,
              userId: u.uid,
              createdAt: serverTimestamp()
            };

            if(typeof window.updateAnimalByEvent === "function"){
              await window.updateAnimalByEvent(payload);
            }

            // âœ… Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø©
            const protocolId = ["ovsynch", String(animalNo).trim(), String(ctx.program).trim(), String(ctx.start).trim()].join("__");
            const evRef = doc(dbRef, "events", protocolId);
            const snap = await getDoc(evRef);

            if(snap.exists()){
              showInfo(`â›” Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ù…Ø³Ø¬Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù„Ø­ÙŠÙˆØ§Ù† Ø±Ù‚Ù… ${animalNo} Ø¨Ù†ÙØ³ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆÙ†ÙØ³ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡.`, true);
              continue;
            }

            await setDoc(evRef, payload);
            showInfo(`âœ… ØªÙ… Ø­ÙØ¸ (${i+1}/${okIds.length}) Ø±Ù‚Ù… ${animalNo}`);
          }

          showInfo("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
        }catch(e){
          console.error(e);
          showInfo("âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", true);
        }finally{
          saveBtn.disabled = false;
          saveBtn.textContent = oldTxt;
        }
      }

      saveBtn.addEventListener('click', saveProtocol);

      // âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
      hydrate();
        setMode(localStorage.getItem("mbk_ov_mode") || "single");

      startDateEl.addEventListener('input', updateSteps);
      startTimeEl.addEventListener('input', updateSteps);
      programEl.addEventListener('change', updateSteps);
      updateSteps();

      const u = await waitForUser(2000);
      if(u) await loadGroupsList();

    })();
  </script>
</body>
</html>
