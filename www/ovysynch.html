<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <!-- (Ù‡Ù†Ø±Ø¬Ø¹ Ù„Ù…Ù„Ø§Ø­Ø¸Ø© animal-update.js Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§) -->
 <script type="module">
  import { updateAnimalByEvent } from "/js/animal-update.js";
  window.updateAnimalByEvent = updateAnimalByEvent;
</script>


  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <title>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¶ ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</title>

  <style>
    body{
      margin:0;padding:0;
      background: var(--bg, #f7faf7);
      color: var(--text, #0f172a);
      font-family:'Cairo',Tahoma,Arial,sans-serif;
      direction: rtl;
    }

    header{
      position: sticky; top: 0; z-index: 20;
      background: #fff;
      border-bottom: 1px solid var(--border, #e2e8f0);
    }
    .mbk-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px;
    }
    .mbk-logo{ height:48px; width:auto; object-fit:contain; opacity:.95; flex-shrink:0; }
    .mbk-center{ flex:1; text-align:center; line-height:1.2; }
    .mbk-page-title{ font-size:18px; font-weight:900; color: var(--ink, #0f172a); }
    .mbk-app-name{ font-size:13px; font-weight:800; color: var(--brand-600, #0b7f47); opacity:.9; }
    .mbk-back{
      width:42px; height:42px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      text-decoration:none; font-weight:900;
      color: var(--brand-600, #0b7f47);
      border:2px solid var(--brand-600, #0b7f47);
      background:#fff; flex-shrink:0;
    }

    .wrap{ max-width:520px; margin:12px auto 24px; padding:0 12px; }
    .mbk-card{
      background:#fff;
      border:1px solid var(--border, #e2e8f0);
      border-radius:16px;
      padding:14px;
      box-shadow:0 1px 0 rgba(15,23,42,.04);
    }

    /* ØªØ®Ø·ÙŠØ· Ø§Ù„Ø­Ù‚ÙˆÙ„ */
    .row{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:640px){ .row-2{ grid-template-columns:1fr 1fr; } }

    .hint{ font-size:12px; opacity:.65; line-height:1.4; }

    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø®Ø·ÙˆØ§Øª */
    .steps{
      margin-top:12px;
      border:1px solid var(--border, #e2e8f0);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .step{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px;
      border-bottom:1px dashed var(--border, #e2e8f0);
    }
    .step:last-child{ border-bottom:none; }
    .step .name{ font-weight:900; }
    .step .date{ font-size:13px; opacity:.85; white-space:nowrap; }
    .step .chk{ display:flex; align-items:center; gap:8px; justify-content:flex-start; }
    .step input[type="checkbox"]{ width:18px; height:18px; }

    /* Ø´Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯/Ù…Ø¤ÙƒØ¯Ø© */
    .on-time{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border, #e2e8f0); }
    .ok{ background:#f0fff6; border-color:#bbf7d0; }
    .late{ background:#fff7ed; border-color:#fed7aa; }

    /* Ø±Ø³Ø§Ø¦Ù„ */
    #warn{ margin-top:10px; color:#b91c1c; font-weight:800; min-height:18px; }
    #info.infobar{ display:none; margin-bottom:10px; }

    /* Ø£Ø²Ø±Ø§Ø± Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© */
    .btn-row{
      position: sticky;
      bottom: 10px;
      background: #fff;
      padding: 10px;
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 16px;
      display:flex;
      gap:10px;
      margin:14px 12px 18px;
      max-width:520px;
      margin-left:auto; margin-right:auto;
    }
    .btn-row .save-btn,
    .btn-row .open-card{
      flex:1; width:auto;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    .btn-row .save-btn{
      background: var(--brand, #0ea05a);
      color:#fff; border:0;
    }
    .btn-row .open-card{
      background:#fff !important;
      color: var(--brand-600, #0b7f47) !important;
      border:2px solid var(--brand-600, #0b7f47) !important;
    }
  </style>
</head>

<body>
  <header>
    <div class="mbk-head">
      <a class="mbk-back" href="add-event.html" title="Ø±Ø¬ÙˆØ¹">Ø±Ø¬ÙˆØ¹</a>

      <div class="mbk-center">
        <div class="mbk-page-title">Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªØ²Ø§Ù…Ù† ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­</div>
        <div class="mbk-app-name">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
      </div>

      <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
    </div>
  </header>

  <div class="wrap">
    <div id="info" class="infobar"></div>

    <div class="mbk-card">
      <form id="ovForm" autocomplete="off">
<div class="row" style="margin-bottom:12px">
  <div class="field">
    <label for="bulkAnimals">Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ (ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø±)</label>
    <textarea id="bulkAnimals" rows="4" placeholder="Ù…Ø«Ø§Ù„:
105
106
110"></textarea>
    <div class="hint">Ù„Ùˆ ÙƒØªØ¨Øª Ù‡Ù†Ø§: Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù….</div>
  </div>

  <button id="applyBulk" type="button" class="open-card" style="width:100%;margin-top:6px">
    ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  </button>

  <div class="hint" id="bulkHint" style="margin-top:6px;opacity:.75"></div>
</div>

        <div class="row row-2">
          <div class="field">
            <label for="animalId">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
            <input id="animalId" type="text" placeholder="Ù…Ø«Ø§Ù„: 105" />
          </div>

         <div class="field">
  <label for="startDate">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ (Ø§Ù„ÙŠÙˆÙ… 0)</label>
  <input id="startDate" type="date" />
</div>

<div class="field">
  <label for="startTime">Ø³Ø§Ø¹Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</label>
  <input id="startTime" type="time" value="08:00" />
  <div class="hint">Ù…Ø«Ø§Ù„: 08:00 ØµØ¨Ø§Ø­Ù‹Ø§ â€” Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
</div>
</div>

        <div class="row" style="margin-top:12px">
          <div class="field">
            <label for="program">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
            <select id="program">
              <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</option>
              <option value="ovsynch">Ovsynch</option>
              <option value="cosynch72">Cosynch-72</option>
              <option value="presynch_ovsynch">Presynch + Ovsynch</option>
            </select>
            <div class="muted hint">Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© âœ“ Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° ÙƒÙ„ Ø®Ø·ÙˆØ©.</div>
          </div>
        </div>

        <div id="stepsBox" class="steps" aria-live="polite"></div>

        <div id="warn"></div>
      </form>
    </div>
  </div>

  <div class="btn-row">
    <button id="saveBtn" class="save-btn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</button>
    <button id="openCowCard" class="open-card" type="button">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
  </div>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
 import { getFirestore, collection, addDoc, serverTimestamp, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
 import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  (async () => {
    const form        = document.getElementById('ovForm');
    const animalIdEl  = document.getElementById('animalId');
    const startDateEl = document.getElementById('startDate');
    const startTimeEl = document.getElementById('startTime');
    const bulkEl      = document.getElementById('bulkAnimals');
const applyBulkBtn= document.getElementById('applyBulk');
const bulkHintEl  = document.getElementById('bulkHint');

let bulkList = []; // Ù‚Ø§Ø¦Ù…Ø© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª

    const programEl   = document.getElementById('program');
    const stepsBox    = document.getElementById('stepsBox');

    const saveBtn     = document.getElementById('saveBtn');
    const openCardBtn = document.getElementById("openCowCard");

    const warnEl = document.getElementById('warn');
    const infoEl = document.getElementById('info');

    let dbRef = null, authRef = null;
    let stepsState = [];

    // === ØªØ´Ø®ÙŠØµ Ø³Ø±ÙŠØ¹ Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§ØªØ´ØºÙ‘Ù„ ===
    console.log("âœ… ovsynch script loaded v2");

    function todayLocal(){
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().slice(0,10);
    }
    function showWarn(t){ if(warnEl) warnEl.textContent = t || ""; }
    function clearWarn(){ if(warnEl) warnEl.textContent = ""; }
function parseBulkList(){
  const raw = (bulkEl?.value || "").trim();
  if(!raw){ bulkList = []; return []; }

  const arr = raw
    .split(/\n|,|;/g)
    .map(s => String(s||"").trim())
    .filter(Boolean);

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨
  const seen = new Set();
  bulkList = arr.filter(x => (seen.has(x) ? false : (seen.add(x), true)));

  if(bulkHintEl){
    bulkHintEl.textContent = bulkList.length
      ? `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${bulkList.length} Ø­ÙŠÙˆØ§Ù†: ${bulkList.slice(0,8).join("ØŒ ")}${bulkList.length>8?" ...":""}`
      : "";
  }
  return bulkList;
}

applyBulkBtn?.addEventListener("click", ()=>{
  const list = parseBulkList();
  if(!list.length){
    showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ.");
    return;
  }
  clearWarn();
  // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ù„Ùˆ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„ÙˆØ§Ø­Ø¯ ÙØ§Ø¶ÙŠ Ù†Ø®Ù„ÙŠ Ø£ÙˆÙ„ Ø±Ù‚Ù… ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø­Ù‚Ù„
  if(animalIdEl && !animalIdEl.value) animalIdEl.value = list[0];
  showInfo(`âœ… Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© Ø¬Ø§Ù‡Ø²Ø©: ${list.length} Ø­ÙŠÙˆØ§Ù†`);
});

    function showInfo(text, isErr=false){
      if(!infoEl) return;
      infoEl.style.display = "block";
      infoEl.className = "infobar " + (isErr ? "error" : "show");
      infoEl.textContent = text;
      try{ infoEl.scrollIntoView({behavior:"smooth", block:"start"}); }catch{}
      setTimeout(()=>{ infoEl.style.display="none"; }, 2500);
    }

    // âœ… ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
    openCardBtn?.addEventListener("click", ()=>{
      const id = (animalIdEl.value || "").trim();
      if(!id) return;
      location.href = `cow-card.html?number=${encodeURIComponent(id)}`;
    });

    // âœ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙˆÙ†ØªÙƒØ³Øª Ù…Ù† add-event (number/date/eventDateâ€¦)
    function hydrate(){
      const qp = new URLSearchParams(location.search);

      const id =
        (qp.get('number') || qp.get('animalNumber') || qp.get('animalId') || qp.get('animalIdd') || "").trim() ||
        (localStorage.getItem('lastAnimalId') || "").trim();

      const dt =
        (qp.get('date') || qp.get('eventDate') || "").trim() ||
        (localStorage.getItem('lastEventDate') || "").trim() ||
        todayLocal();

      if (id){
        animalIdEl.value = id;
        animalIdEl.readOnly = true;
        try{ localStorage.setItem('lastAnimalId', id); }catch{}
      }

      startDateEl.value = dt;
      try{ localStorage.setItem('lastEventDate', dt); }catch{}
    }

    function addDays(baseISO, baseTime, days, extraHours = 0){
  const d = new Date(baseISO + "T" + (baseTime || "08:00"));
  d.setDate(d.getDate() + days);
  d.setHours(d.getHours() + extraHours);
  return d;
}

    function fmt(d){
      try{ return d.toLocaleDateString('ar-EG'); }catch{ return d.toISOString().slice(0,10); }
    }

    const PROGRAMS = {
      ovsynch:[
        { day: 0,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 9,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 9 ~ Ø¨Ø¹Ø¯ ~56 Ø³Ø§Ø¹Ø©)' },
        { day: 10, name:'ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 ~ Ø¨Ø¹Ø¯ ~16 Ø³Ø§Ø¹Ø©)' },
      ],
      cosynch72:[
        { day: 0,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 10, name:'GnRH + ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 â‰ˆ 72 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ PGF)' },
      ],
      presynch_ovsynch:[
        { day:-28, name:'Presynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… -28)' },
        { day:-14, name:'Presynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… -14)' },
        { day: 0,  name:'Ovsynch: GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'Ovsynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 9,  name:'Ovsynch: GnRH (Ø§Ù„ÙŠÙˆÙ… 9 ~ Ø¨Ø¹Ø¯ ~56 Ø³Ø§Ø¹Ø©)' },
        { day: 10, name:'Ovsynch: ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 ~ Ø¨Ø¹Ø¯ ~16 Ø³Ø§Ø¹Ø©)' },
      ]
    };
// ===================== Tasks helpers (Ù…Ø±ÙƒØ²ÙŠ) =====================
function safeKey(s){
  return String(s||"").trim()
    .replace(/\s+/g,'_')
    .replace(/[^\w\u0600-\u06FF\-]+/g,'');
}
function toISODateLocal(d){
  const dd = new Date(d);
  return new Date(dd.getTime() - dd.getTimezoneOffset()*60000).toISOString().slice(0,10);
}
function makeTaskId({ animalNumber, protocolStartDate, program, plannedDate, stepName }){
  // ID Ø«Ø§Ø¨Øª ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø­ØªÙ‰ Ù„Ùˆ Ø§ØªØ¹Ù…Ù„ Save Ø£ÙƒØªØ± Ù…Ù† Ù…Ø±Ø©
  return [
    "task",
    safeKey(animalNumber),
    safeKey(program),
    safeKey(protocolStartDate),
    safeKey(plannedDate),
    safeKey(stepName).slice(0,40)
  ].join("__");
}

async function ensureProtocolTasks({ animalNumber, protocolStartDate, program, userId }){
  if(!dbRef) return;

  const tpl = PROGRAMS[program] || [];
  if(!tpl.length) return;

  // Ù†Ù†Ø´Ø¦/Ù†Ø­Ø¯Ù‘Ø« task Ù„ÙƒÙ„ Ø®Ø·ÙˆØ© (setDoc Ù…Ø¹ merge ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
  for (const s of tpl){
   const baseTime = (startTimeEl?.value || "08:00");

let extraHours = 0;
if (program === "ovsynch" && s.day === 9) extraHours = 56;
if (program === "ovsynch" && s.name.includes("ØªÙ„Ù‚ÙŠØ­")) extraHours = 72;


const plannedDateTime = addDays(protocolStartDate, baseTime, s.day, extraHours);
const plannedDate = toISODateLocal(plannedDateTime);


    const taskId = makeTaskId({
      animalNumber,
      protocolStartDate,
      program,
      plannedDate,
      stepName: s.name
    });

    const ref = doc(dbRef, "tasks", taskId);
    await setDoc(ref, {
      type: "protocol_step",
      protocolType: "ovsynch",
      program: program,
      stepName: s.name,
      plannedDay: s.day,
      plannedDate: plannedDate,
      plannedDateTime: plannedDateTime.toISOString(),


      animalNumber: String(animalNumber||"").trim(),
      protocolStartDate: String(protocolStartDate||"").trim(),

      status: "pending",
      userId: userId || null,
      createdAt: serverTimestamp()
    }, { merge: true });
  }
}

async function markTaskDone({ animalNumber, protocolStartDate, program, plannedDate, stepName }){
  if(!dbRef) return;
  const taskId = makeTaskId({ animalNumber, protocolStartDate, program, plannedDate, stepName });
  const ref = doc(dbRef, "tasks", taskId);
  await updateDoc(ref, {
    status: "done",
    doneAt: serverTimestamp()
  });
}

    function updateSteps(){
      stepsBox.innerHTML = '';

      const start = (startDateEl.value || "").trim();
      const program = (programEl.value || "").trim();
      if(!start || !program) return;

      const tpl = PROGRAMS[program] || [];
      const prev = stepsState;

      stepsState = tpl.map((s)=>{
        const baseTime = (startTimeEl.value || "08:00");

// Ù„Ùˆ Ø§Ù„Ø®Ø·ÙˆØ© ÙÙŠÙ‡Ø§ ØªÙˆÙ‚ÙŠØª Ø®Ø§Øµ Ù†Ø¶ÙŠÙÙ‡
let extraHours = 0;

// GnRH Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ PGF Ø¨Ù€ 56 Ø³Ø§Ø¹Ø©
if (s.name.includes('GnRH') && s.day === 9) extraHours = 56;

// Ø§Ù„ØªÙ„Ù‚ÙŠØ­ Ø¨Ø¹Ø¯ GnRH Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¨Ù€ 16 Ø³Ø§Ø¹Ø©
if (s.name.includes('ØªÙ„Ù‚ÙŠØ­')) extraHours = 72; // 56 + 16

const dd = addDays(start, baseTime, s.day, extraHours);

        const local = new Date(dd.getTime() - dd.getTimezoneOffset()*60000);
const iso = local.toISOString().slice(0,16); // ØªØ§Ø±ÙŠØ® + ÙˆÙ‚Øª

        const keep = prev.find(p => p.name===s.name && p.day===s.day);
        return {
          day: s.day,
          name: s.name,
          date: iso,
          done: keep ? !!keep.done : false,
          confirmedOn: keep ? keep.confirmedOn || null : null,
          onSchedule: keep ? !!keep.onSchedule : false,
          _savedOnce: keep ? !!keep._savedOnce : false,
        };
      });

      stepsState.forEach((st, idx)=>{
        const row = document.createElement('div');
        row.className = 'step';

        const chip = st.done
          ? `<span class="on-time ${st.onSchedule ? 'ok' : 'late'}">${st.onSchedule ? 'âœ“ ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯' : 'âœ“ Ù…Ø¤ÙƒØ¯Ø©'}</span>`
          : '';

        row.innerHTML = `
          <div>
            <div class="name">${st.name}</div>
            <div class="date">ğŸ“… ${new Date(st.date).toLocaleString('ar-EG')} ${chip}</div>
          </div>
          <label class="chk">
            <input data-idx="${idx}" type="checkbox" ${st.done ? 'checked' : ''}/>
            ØªÙ…
          </label>
        `;
        stepsBox.appendChild(row);
      });
    }

    async function saveStepEvent(i){
      try{
        if(!dbRef) return;
        const st = stepsState[i];
        if(!st || st._savedOnce) return;

        const animalId = (animalIdEl.value || '').trim();
        if(!animalId) return;

        const payload = {
          type: 'ovysynch-step',
          eventType: 'Ø®Ø·ÙˆØ© Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„',
          stepName: st.name,
          program: programEl.value || null,
          protocolStartDate: (startDateEl.value||'').trim() || null,
          plannedDay: st.day,
         plannedDate: String(st.date).slice(0,10),
plannedDateTime: st.date,

          confirmedOn: st.confirmedOn,
          onSchedule: !!st.onSchedule,
          animalId,
          animalNumber: animalId,
          userId: authRef?.currentUser?.uid || null,
          createdAt: serverTimestamp()
        };

        await addDoc(collection(dbRef,'events'), payload);

// âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ task Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ ÙƒÙ€ done (Ù…Ø±ÙƒØ²ÙŠ)
await markTaskDone({
  animalNumber: animalId,
  protocolStartDate: (startDateEl.value||'').trim(),
  program: (programEl.value||'').trim(),
  plannedDate: String(st.date).slice(0,10), // âœ… ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· Ø¹Ø´Ø§Ù† ÙŠØ·Ø§Ø¨Ù‚ task
  stepName: st.name
});

st._savedOnce = true;

      }catch(err){
        console.error('saveStepEvent failed', err);
      }
    }

    stepsBox.addEventListener('change', async (e)=>{
      const el = e.target.closest('input[type="checkbox"][data-idx]');
      if(!el) return;

      const i = Number(el.getAttribute('data-idx'));
      const st = stepsState[i];
      if(!st) return;

      const today = todayLocal();
      st.done = el.checked;
      st.confirmedOn = el.checked ? today : null;
     st.onSchedule = el.checked ? (today === String(st.date).slice(0,10)) : false;

      if(el.checked) await saveStepEvent(i);
      updateSteps();
    });

    async function setupFirebase(){
      try{
       const mod = await import('/js/firebase-config.js?v=5');
        if(mod?.db && mod?.auth) return { db:mod.db, auth:mod.auth };
        if(mod?.firebaseConfig){
          const app = initializeApp(mod.firebaseConfig);
          return { db:getFirestore(app), auth:getAuth(app) };
        }
      }catch(e){ /* ignore */ }

      try{
        const cfg = await import('./config.js?v=5');
        const app = initializeApp(cfg.firebaseConfig);
        return { db:getFirestore(app), auth:getAuth(app) };
      }catch(e2){
        showWarn('âŒ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.');
        return { db:null, auth:null };
      }
    }

    const { db, auth } = await setupFirebase();
    dbRef = db;
    authRef = auth;
    // âœ… Ø§Ù†ØªØ¸Ø± Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¨Ø¯ÙˆÙ† redirect)
async function waitForUser(ms=1500){
  if(!authRef) return null;
  return await new Promise((resolve)=>{
    const t = setTimeout(()=>resolve(authRef.currentUser || null), ms);
    try{
      onAuthStateChanged(authRef, (u)=>{
        clearTimeout(t);
        resolve(u || null);
      });
    }catch{
      clearTimeout(t);
      resolve(authRef.currentUser || null);
    }
  });
}


  function getCtx(){
  const list = parseBulkList(); // Ù„Ùˆ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ ÙÙŠÙ‡ Ø£Ø±Ù‚Ø§Ù…ØŒ Ù‡Ù†Ø³ØªØ®Ø¯Ù…Ù‡
  const animalId = list.length ? list[0] : (animalIdEl.value||'').trim();

  const start = (startDateEl.value||'').trim();
  const program = (programEl.value||'').trim();

  if(!animalId || !start || !program){
    showWarn('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.');
    return null;
  }

  clearWarn();
  try{ localStorage.setItem('lastAnimalId', animalId); }catch{}
  try{ localStorage.setItem('lastEventDate', start); }catch{}

  return { animalId, animalIds: (list.length ? list : [animalId]), start, program, steps: stepsState };
}
    async function saveProtocol(){
      const ctx = getCtx();
      if(!ctx) return;
      const ids = (ctx.animalIds || []).filter(Boolean);
if(!ids.length){
  showWarn("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ø­ÙŠÙˆØ§Ù†Ø§Øª.");
  return;
}


      saveBtn.disabled = true;
      const oldTxt = saveBtn.textContent;
      saveBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸';

      try{
        const user = await waitForUser(2000);
if(!user){
  showWarn("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ø¯Ø®ÙˆÙ„ Ù†Ø´Ø·Ø©ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ø¢Ù†.");
  return;
}

        const payload = {
          type: 'ovysynch',
          eventType: 'Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†',
          animalId: ctx.animalId,
          animalNumber: ctx.animalId,
          startDate: ctx.start,
          program: ctx.program,
          steps: ctx.steps,
          userId: authRef?.currentUser?.uid || null,
          createdAt: serverTimestamp()
        };
for (let idx = 0; idx < ids.length; idx++){
  const animalNo = ids[idx];

  const payload = {
    type: 'ovysynch',
    eventType: 'Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†',
    animalId: animalNo,
    animalNumber: animalNo,
    startDate: ctx.start,
    program: ctx.program,
    steps: ctx.steps,
    userId: authRef?.currentUser?.uid || null,
    createdAt: serverTimestamp()
  };
if(typeof window.updateAnimalByEvent === "function"){
  await window.updateAnimalByEvent(payload);
}

  if(dbRef){
    const protocolId = [
      "ovsynch",
      String(animalNo).trim(),
      String(ctx.program).trim(),
      String(ctx.start).trim()
    ].join("__");

    await setDoc(doc(dbRef, "events", protocolId), payload, { merge:true });
  }

  await ensureProtocolTasks({
    animalNumber: animalNo,
    protocolStartDate: ctx.start,
    program: ctx.program,
    userId: authRef?.currentUser?.uid || null
  });

  // ØªÙ‚Ø¯Ù… Ø¨Ø³ÙŠØ·
  showInfo(`âœ… ØªÙ… Ø­ÙØ¸ (${idx+1}/${ids.length}) Ø±Ù‚Ù… ${animalNo}`);
}


        showInfo('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
      }catch(e){
        console.error(e);
        showWarn('âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
      }finally{
        saveBtn.disabled = false;
        saveBtn.textContent = oldTxt;
      }
    }

    saveBtn.addEventListener('click', saveProtocol);
    form.addEventListener('submit', (e)=>{ e.preventDefault(); saveProtocol(); });

    // âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    hydrate();
    startDateEl.addEventListener('input', updateSteps);
    programEl.addEventListener('change', updateSteps);

    updateSteps();

  })();
</script>

</body>
</html>
