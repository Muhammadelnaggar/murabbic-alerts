<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="/js/animal-update.js"></script>

  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <title>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¶ ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</title>
 <style>
  body{
    margin:0;
    padding:0;
    background: var(--bg, #f7faf7);
    color: var(--text, #0f172a);
    font-family:'Cairo',Tahoma,Arial,sans-serif;
    direction: rtl;
  }

  header{
    position: sticky;
    top: 0;
    z-index: 20;
    background: #fff;
    border-bottom: 1px solid var(--border, #e2e8f0);
  }
  .mbk-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:10px 12px;
  }
  .mbk-logo{
    width:auto;
    height:48px;
    object-fit:contain;
    opacity:.95;
    flex-shrink:0;
  }
  .mbk-center{
    flex:1;
    text-align:center;
    line-height:1.2;
  }
  .mbk-page-title{
    font-size:18px;
    font-weight:900;
    color: var(--ink, #0f172a);
  }
  .mbk-app-name{
    font-size:13px;
    font-weight:800;
    color: var(--brand-600, #0b7f47);
    opacity:.9;
  }
  .mbk-back{
    width:42px;
    height:42px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    text-decoration:none;
    font-weight:900;
    color: var(--brand-600, #0b7f47);
    border:2px solid var(--brand-600, #0b7f47);
    background:#fff;
    flex-shrink:0;
  }

  .wrap{
    max-width:520px;
    margin:12px auto 24px;
    padding:0 12px;
  }
  .mbk-card{
    background:#fff;
    border:1px solid var(--border, #e2e8f0);
    border-radius:16px;
    padding:14px;
    box-shadow:0 1px 0 rgba(15,23,42,.04);
  }

  .btn-row{
    position: sticky;
    bottom: 10px;
    background: #fff;
    padding: 10px;
    border: 1px solid var(--border, #e2e8f0);
    border-radius: 16px;
    display:flex;
    gap:10px;
    margin-top:14px;
  }
  .btn-row .save-btn,
  .btn-row .open-card{
    flex:1;
    width:auto;
    border-radius:14px;
    padding:12px 14px;
    font-weight:900;
    font-size:16px;
    cursor:pointer;
  }
  .btn-row .save-btn{
    background: var(--brand, #0ea05a);
    color:#fff;
    border:0;
  }
  .btn-row .open-card{
    background:#fff !important;
    color: var(--brand-600, #0b7f47) !important;
    border:2px solid var(--brand-600, #0b7f47) !important;
  }
   .hint{
  font-size: 12px;
  opacity: .65;
  line-height: 1.4;
}

</style>

</head>
<body>
<header>
  <div class="mbk-head">
    <a class="mbk-back" href="add-event.html" title="Ø±Ø¬ÙˆØ¹">Ø±Ø¬ÙˆØ¹</a>

    <div class="mbk-center">
      <div class="mbk-page-title">Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªØ²Ø§Ù…Ù† ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­</div>
      <div class="mbk-app-name">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
    </div>

    <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
  </div>
</header>
<div class="wrap">
  <div id="info" class="infobar"></div>
  <div class="card mbk-card">
    <form id="ovForm">

      <div class="row row-2">
        <div>
          <label for="animalId">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
          <input id="animalId" type="text" placeholder="Ù…Ø«Ø§Ù„: 105"/>
        </div>
        <div>
          <label for="startDate">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ (Ø§Ù„ÙŠÙˆÙ… 0)</label>
          <input id="startDate" type="date"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="program">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
          <select id="program">
            <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</option>
            <option value="ovsynch">Ovsynch</option>
            <option value="cosynch72">Cosynch-72</option>
            <option value="presynch_ovsynch">Presynch + Ovsynch</option>
          </select>
          <div class="muted hint">Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© âœ“ Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° ÙƒÙ„ Ø®Ø·ÙˆØ©.</div>
        </div>
      </div>

      <div id="stepsBox" class="steps" aria-live="polite"></div>

      <div id="warn" class="warn"></div>
   </form>
</div>
</div>

<div class="btn-row">
  <button id="saveBtn" class="save-btn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</button>
  <button id="openCowCard" class="open-card" type="button">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
</div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    
    const form        = document.getElementById('ovForm');
    const animalIdEl  = document.getElementById('animalId');
    const startDateEl = document.getElementById('startDate');
    const programEl   = document.getElementById('program');
    const stepsBox    = document.getElementById('stepsBox');

    const saveBtn = document.getElementById('saveBtn');
    const openCardBtn = document.getElementById("openCowCard");

openCardBtn?.addEventListener("click", ()=>{
  const id = animalIdEl.value.trim();
  if(!id) return;
  location.href = `cow-card.html?number=${encodeURIComponent(id)}`;
});

    const resetBtn= document.getElementById('resetBtn');
    const warn    = document.getElementById('warn');

    const msgBox  = document.getElementById('inlineMsg');
    const msgText = msgBox.querySelector('.text');
   

    let dbRef=null, authRef=null; // Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ù…Ø³ØªÙ…Ø¹ checkbox

    function todayLocal(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    function showWarn(t){ warn.textContent=t; }
    function clearWarn(){ warn.textContent=''; }
    function showMsg(text){ msgText.textContent=text; msgBox.style.display='block'; }
    function hideMsg(){ msgBox.style.display='none'; msgText.textContent=''; }

    function hydrate(){
      const qp = new URLSearchParams(location.search);
      const id = qp.get('animalId') || qp.get('animalIdd') || qp.get('number') || localStorage.getItem('lastAnimalId') || '';
      const dt = qp.get('date') || todayLocal();
      animalIdEl.value = id; if(id) animalIdEl.readOnly = true;
      startDateEl.value = dt;
      

    hydrate();

    animalIdEl.addEventListener('input', ()=>{ ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${animalIdEl.value.trim()||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`; });
    startDateEl.addEventListener('input', ()=>{ try{ ctxDate.textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡: ${new Date(startDateEl.value).toLocaleDateString('ar-EG')}`;}catch{ ctxDate.textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡: ${startDateEl.value}`; } updateSteps(); });
    programEl.addEventListener('change', updateSteps);

    function addDays(base, days){ const d=new Date(base); d.setDate(d.getDate()+days); return d; }
    function fmt(d){ try{ return d.toLocaleDateString('ar-EG'); }catch{ return d.toISOString().slice(0,10); } }

    // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ (Ø£ÙŠØ§Ù… Ù†Ø³Ø¨ÙŠØ© Ù…Ù† ÙŠÙˆÙ… 0)
    const PROGRAMS = {
      ovsynch:[
        { day: 0,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 9,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 9 ~ Ø¨Ø¹Ø¯ ~56 Ø³Ø§Ø¹Ø©)' },
        { day: 10, name:'ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 ~ Ø¨Ø¹Ø¯ ~16 Ø³Ø§Ø¹Ø©)' },
      ],
      cosynch72:[
        { day: 0,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 10, name:'GnRH + ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 â‰ˆ 72 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ PGF)' },
      ],
      presynch_ovsynch:[
        { day:-28, name:'Presynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… -28)' },
        { day:-14, name:'Presynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… -14)' },
        { day: 0,  name:'Ovsynch: GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'Ovsynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 9,  name:'Ovsynch: GnRH (Ø§Ù„ÙŠÙˆÙ… 9 ~ Ø¨Ø¹Ø¯ ~56 Ø³Ø§Ø¹Ø©)' },
        { day: 10, name:'Ovsynch: ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 ~ Ø¨Ø¹Ø¯ ~16 Ø³Ø§Ø¹Ø©)' },
      ]
    };

    let stepsState = [];

    function updateSteps(){
      stepsBox.innerHTML = '';
      const start = startDateEl.value;
      const program = programEl.value;
      if(!start || !program) return;

      const tpl = PROGRAMS[program] || [];
      const prev = stepsState;
      stepsState = tpl.map((s)=>{
        const dateISO = addDays(start, s.day).toISOString().slice(0,10);
        const keep = prev.find(p=>p.name===s.name && p.day===s.day);
        return {
          day: s.day,
          name: s.name,
          date: dateISO,
          done: keep ? !!keep.done : false,
          confirmedOn: keep ? keep.confirmedOn || null : null,
          onSchedule: keep ? !!keep.onSchedule : false,
          _savedOnce: keep ? !!keep._savedOnce : false,
        };
      });

      stepsState.forEach((st, idx)=>{
        const row = document.createElement('div');
        row.className = 'step';
        const chip = st.done ? `<span class="on-time ${st.onSchedule? 'ok':'late'}">${st.onSchedule? 'âœ“ ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯':'âœ“ Ù…Ø¤ÙƒØ¯Ø©'}</span>` : '';
        row.innerHTML = `
          <div class="name">${st.name}</div>
          <div class="date">ğŸ“… ${fmt(new Date(st.date))} ${chip}</div>
          <label class="chk"><input data-idx="${idx}" type="checkbox" ${st.done? 'checked':''}/> ØªÙ…</label>
        `;
        stepsBox.appendChild(row);
      });
    }

    // Ø­ÙØ¸ Ø®Ø·ÙˆØ© Ù…Ù†ÙØµÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯
    async function saveStepEvent(i){
      try{
        if(!dbRef) return; // Ù„Ø§ ØªØ­Ø·Ù… Ø§Ù„ØµÙØ­Ø© Ø¥Ù† Ù„Ù… ØªØªÙˆÙØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const st = stepsState[i];
        if(!st || st._savedOnce) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø¬Ù„Ø³Ø©
        const animalId = (animalIdEl.value||'').trim();
        const payload = {
          type: 'ovysynch-step',
          eventType: 'Ø®Ø·ÙˆØ© Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„',
          stepName: st.name,
          program: programEl.value || null,
          protocolStartDate: (startDateEl.value||'').trim() || null,
          plannedDay: st.day,
          plannedDate: st.date,
          confirmedOn: st.confirmedOn,
          onSchedule: !!st.onSchedule,
          animalId,
          animalNumber: animalId,
          userId: authRef?.currentUser?.uid || null,
          createdAt: serverTimestamp()
        };
        await addDoc(collection(dbRef,'events'), payload);
        st._savedOnce = true;
      }catch(err){ console.error('saveStepEvent failed', err); }
    }

    stepsBox.addEventListener('change', async (e)=>{
      const el = e.target.closest('input[type="checkbox"][data-idx]');
      if(!el) return;
      const i = Number(el.getAttribute('data-idx'));
      const today = todayLocal();
      const st = stepsState[i];
      st.done = el.checked;
      st.confirmedOn = el.checked ? today : null;
      st.onSchedule = el.checked ? (today === st.date) : false;
      if (el.checked) { await saveStepEvent(i); }
      updateSteps();
    });

    // Firebase
    async function setupFirebase(){
      try{
        const mod = await import('./js/firebase-config.js?v=5');
        if(mod?.db && mod?.auth){ return { db:mod.db, auth:mod.auth }; }
        if(mod?.firebaseConfig){ const app=initializeApp(mod.firebaseConfig); return { db:getFirestore(app), auth:getAuth(app) }; }
      }catch(e){ /* ignore */ }
      try{ const cfg = await import('./config.js?v=5'); const app=initializeApp(cfg.firebaseConfig); return { db:getFirestore(app), auth:getAuth(app) }; }catch(e2){ showWarn('âŒ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.'); return { db:null, auth:null }; }
    }

    const { db, auth } = await setupFirebase();
    dbRef = db; authRef = auth;

    function getCtx(){
      const animalId = animalIdEl.value.trim();
      const start = startDateEl.value.trim();
      const program = programEl.value;
      if(!animalId || !start || !program){ showWarn('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.'); return null; }
      clearWarn(); localStorage.setItem('lastAnimalId', animalId);
      return { animalId, start, program, steps: stepsState };
    }

    async function saveProtocol(){
      const ctx = getCtx(); if(!ctx) return;
      saveBtn.disabled = true; saveBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸';
      try{
       const payload = {
  type: 'ovysynch',
  eventType: 'Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†',
  animalId: ctx.animalId,
  animalNumber: ctx.animalId,
  startDate: ctx.start,
  program: ctx.program,
  steps: ctx.steps,              // Ù…ØµÙÙˆÙØ© Ø§Ù„Ø®Ø·ÙˆØ§Øª
  userId: auth?.currentUser?.uid || null,
  createdAt: serverTimestamp()
};

// 1) Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø«
if (db) {
  await addDoc(collection(db, 'events'), payload);
}

// 2) ØªØ­Ø¯ÙŠØ« ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
await window.updateAnimalByEvent(payload);

// 3) Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
hideMsg();
showMsg('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');

      }catch(e){ console.error(e); showWarn('âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'); }
      finally{ saveBtn.disabled=false; saveBtn.textContent='ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„'; }
    }

    saveBtn.addEventListener('click', saveProtocol);
    form.addEventListener('submit', (e)=>{ e.preventDefault(); saveProtocol(); });

    resetBtn.addEventListener('click', ()=>{ form.reset(); hydrate(); stepsState=[]; stepsBox.innerHTML=''; hideMsg(); clearWarn(); });

    // Ø£ÙˆÙ„ Ø¹Ø±Ø¶
    updateSteps();
  </script>
</body>
</html>
