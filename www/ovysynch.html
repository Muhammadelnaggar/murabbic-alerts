<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <!-- (Ù‡Ù†Ø±Ø¬Ø¹ Ù„Ù…Ù„Ø§Ø­Ø¸Ø© animal-update.js Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§) -->
  <script type="module">
    import { updateAnimalByEvent } from "/js/animal-update.js";
    window.updateAnimalByEvent = updateAnimalByEvent;
  </script>

  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <title>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¶ ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</title>

  <style>
    body{
      margin:0;padding:0;
      background: var(--bg, #f7faf7);
      color: var(--text, #0f172a);
      font-family:'Cairo',Tahoma,Arial,sans-serif;
      direction: rtl;
    }

    header{
      position: sticky; top: 0; z-index: 20;
      background: #fff;
      border-bottom: 1px solid var(--border, #e2e8f0);
    }
    .mbk-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px;
    }
    .mbk-logo{ height:48px; width:auto; object-fit:contain; opacity:.95; flex-shrink:0; }
    .mbk-center{ flex:1; text-align:center; line-height:1.2; }
    .mbk-page-title{ font-size:18px; font-weight:900; color: var(--ink, #0f172a); }
    .mbk-app-name{ font-size:13px; font-weight:800; color: var(--brand-600, #0b7f47); opacity:.9; }
    .mbk-back{
      width:42px; height:42px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      text-decoration:none; font-weight:900;
      color: var(--brand-600, #0b7f47);
      border:2px solid var(--brand-600, #0b7f47);
      background:#fff; flex-shrink:0;
    }

    .wrap{ max-width:520px; margin:12px auto 24px; padding:0 12px; }
    .mbk-card{
      background:#fff;
      border:1px solid var(--border, #e2e8f0);
      border-radius:16px;
      padding:14px;
      box-shadow:0 1px 0 rgba(15,23,42,.04);
    }

    .row{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:640px){ .row-2{ grid-template-columns:1fr 1fr; } }

    .hint{ font-size:12px; opacity:.65; line-height:1.4; }

    .steps{
      margin-top:12px;
      border:1px solid var(--border, #e2e8f0);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .step{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px;
      border-bottom:1px dashed var(--border, #e2e8f0);
    }
    .step:last-child{ border-bottom:none; }
    .step .name{ font-weight:900; }
    .step .date{ font-size:13px; opacity:.85; white-space:nowrap; }
    .step .chk{ display:flex; align-items:center; gap:8px; justify-content:flex-start; }
    .step input[type="checkbox"]{ width:18px; height:18px; }

    #warn{ margin-top:10px; color:#b91c1c; font-weight:800; min-height:18px; }

   #sysbar.infobar{
      display:none;
      position: sticky;
      top: 72px;
      z-index: 19;
      margin: 10px 0 10px;
    }
   #sysbar .msgrow{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
#sysbar .okbtn{
  flex-shrink:0;
  border-radius:12px;
  padding:8px 12px;
  font-weight:900;
  border:2px solid var(--brand-600, #0b7f47);
  background:#fff;
  color: var(--brand-600, #0b7f47);
  cursor:pointer;
}


    .btn-row{
      position: sticky;
      bottom: 10px;
      background: #fff;
      padding: 10px;
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 16px;
      display:flex;
      gap:10px;
      margin:14px 12px 18px;
      max-width:520px;
      margin-left:auto; margin-right:auto;
    }
    .btn-row .save-btn,
    .btn-row .open-card{
      flex:1; width:auto;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    .btn-row .save-btn{
      background: var(--brand, #0ea05a);
      color:#fff; border:0;
    }
    .btn-row .open-card{
      background:#fff !important;
      color: var(--brand-600, #0b7f47) !important;
      border:2px solid var(--brand-600, #0b7f47) !important;
    }

    /* âœ… Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¶Ø¹ */
    #modeBulkBox[hidden],
    #modeSingleBox[hidden]{ display:none !important; }
  </style>
</head>

<body>
  <header>
    <div class="mbk-head">
      <a class="mbk-back" href="add-event.html" title="Ø±Ø¬ÙˆØ¹">Ø±Ø¬ÙˆØ¹</a>

      <div class="mbk-center">
        <div class="mbk-page-title">Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªØ²Ø§Ù…Ù† ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­</div>
        <div class="mbk-app-name">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
      </div>

      <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
    </div>
  </header>

  <div class="wrap">
   <div id="sysbar" class="infobar"></div>
    <div class="mbk-card">
      <form id="ovForm" autocomplete="off" data-validate="true" data-event="Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†">
        <!-- âœ… Ø­Ù‚ÙˆÙ„ Ø±Ø¨Ø· Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ -->
        <input type="hidden" id="animalNumber" data-field="animalNumber" value="">
        <input type="hidden" id="animalNumbers" data-field="animalNumbers" value="">
        <input type="hidden" id="eventDate" data-field="eventDate" value="">
        <input type="hidden" id="species" data-field="species" value="">
        <input type="hidden" id="steps" data-field="steps" value="">
        <input type="hidden" id="animalId" data-field="animalId" value="">

        <!-- âœ… Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ÙØ±Ø¯ÙŠ / Ù…Ø¬Ù…ÙˆØ¹Ø© -->
        <div class="field" style="margin-bottom:12px">
          <div style="display:flex;gap:12px;align-items:center;font-weight:900">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="radio" name="mbkMode" id="modeSingle" value="single" checked>
              â¬¤ ØªØ³Ø¬ÙŠÙ„ Ù„Ø­ÙŠÙˆØ§Ù† ÙˆØ§Ø­Ø¯
            </label>

            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="radio" name="mbkMode" id="modeGroup" value="group">
              â¬¤ ØªØ³Ø¬ÙŠÙ„ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø­ÙŠÙˆØ§Ù†Ø§Øª
            </label>
          </div>
          <div class="hint" id="modeHint" style="margin-top:6px">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹â€¦ ÙˆØ§Ù„ØµÙØ­Ø© Ø³ØªÙØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
        </div>

        <!-- âœ… ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
        <div id="modeBulkBox" hidden>
          <div class="row" style="margin-bottom:12px">
            <div class="field">
              <label for="bulkAnimals">Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ (ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø±)</label>
              <textarea id="bulkAnimals" rows="4" placeholder="Ù…Ø«Ø§Ù„:
105
106
110"></textarea>
              <div class="hint">Ù„Ùˆ ÙƒØªØ¨Øª Ù‡Ù†Ø§: Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù….</div>
            </div>

            <button id="applyBulk" type="button" class="open-card" style="width:100%;margin-top:6px">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            <div class="hint" id="bulkHint" style="margin-top:6px;opacity:.75"></div>
          </div>
        </div>

       

<!-- âœ… ÙˆØ¶Ø¹ Ø§Ù„ÙØ±Ø¯ÙŠ -->
        <div id="modeSingleBox">
          <div class="field">
            <label for="animalNumberUI">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
            <input id="animalNumberUI" type="text" placeholder="Ù…Ø«Ø§Ù„: 105" />
          </div>
        </div>

        <div class="row row-2" style="margin-top:12px">
          <div class="field">
            <label for="startDate">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ (Ø§Ù„ÙŠÙˆÙ… 0)</label>
            <input id="startDate" type="date" />
          </div>

          <div class="field">
            <label for="startTime">Ø³Ø§Ø¹Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</label>
            <input id="startTime" type="time" value="08:00" />
            <div class="hint">Ù…Ø«Ø§Ù„: 08:00 ØµØ¨Ø§Ø­Ù‹Ø§ â€” Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="field">
            <label for="program">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
            <select id="program" data-field="program">
              <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</option>
              <option value="ovsynch">Ovsynch</option>
              <option value="cosynch72">Cosynch-72</option>
              <option value="presynch_ovsynch">Presynch + Ovsynch</option>
            </select>
            <div class="muted hint">Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© âœ“ Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° ÙƒÙ„ Ø®Ø·ÙˆØ©.</div>
          </div>
        </div>

        <div id="stepsBox" class="steps" aria-live="polite"></div>
        <div id="warn"></div>

        <!-- Ù…Ù‡Ù… Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ -->
        <button type="submit" id="hiddenSubmit" style="display:none"></button>
      </form>
    </div>
  </div>

  <div class="btn-row">
    <button id="saveBtn" class="save-btn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</button>
    <button id="openCowCard" class="open-card" type="button">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
  </div>

<script type="module">
import { db as fbDb, auth as fbAuth } from "/js/firebase-config.js";
import {
  collection, serverTimestamp, doc, setDoc, getDoc,
  query, where, getDocs, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";


(async () => {
  const form        = document.getElementById('ovForm');
  const animalUI    = document.getElementById('animalNumberUI');
  const startDateEl = document.getElementById('startDate');
  const startTimeEl = document.getElementById('startTime');
  const bulkEl      = document.getElementById('bulkAnimals');
  const applyBulk   = document.getElementById('applyBulk');
  const programEl   = document.getElementById('program');
  const stepsBox    = document.getElementById('stepsBox');
  const saveBtn     = document.getElementById('saveBtn');
  const openCowCard = document.getElementById('openCowCard');
const bulkHintEl = document.getElementById('bulkHint');

const infoEl      = document.getElementById('sysbar');
  const warnEl      = document.getElementById('warn');

  const modeSingle  = document.getElementById('modeSingle');
  const modeGroup   = document.getElementById('modeGroup');
  const modeBulkBox = document.getElementById('modeBulkBox');
  const modeSingleBox = document.getElementById('modeSingleBox');

  const animalHidden = document.getElementById("animalNumber");
  const eventHidden  = document.getElementById("eventDate");
  const stepsHidden  = document.getElementById("steps");
  // âœ… Ø±Ø¨Ø· Ø²Ø± "ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
const applyBulkBtn = document.getElementById('applyBulk');

let stepsState = [], bulkList = [];
let fbReady = !!fbDb && !!fbAuth;


  /* ========= Helpers ========= */
  function todayISO(){
    const d=new Date();
    d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  }
  function showWarn(t){ warnEl.textContent=t||""; }
  function clearWarn(){ warnEl.textContent=""; }
  function parseBulk(){
    const raw=(bulkEl?.value||"").trim();
    if(!raw){ bulkList=[]; return []; }
    const arr=raw.split(/\n|,|;/g).map(x=>x.trim()).filter(Boolean);
    bulkList=[...new Set(arr)];
    return bulkList;
  }

  function normSpecies(sp){
    sp = String(sp || "").trim();
    if (/cow|Ø¨Ù‚Ø±/i.test(sp)) return "Ø£Ø¨Ù‚Ø§Ø±";
    if (/buffalo|Ø¬Ø§Ù…ÙˆØ³/i.test(sp)) return "Ø¬Ø§Ù…ÙˆØ³";
    return sp || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  }
  function animalWordFromSpecies(sp){ return (sp === "Ø¬Ø§Ù…ÙˆØ³") ? "Ø¬Ø§Ù…ÙˆØ³Ø©" : "Ø¨Ù‚Ø±Ø©"; }

  function daysBetweenISO(a, b){
    const d1 = new Date(String(a||"").slice(0,10));
    const d2 = new Date(String(b||"").slice(0,10));
    if (Number.isNaN(d1.getTime()) || Number.isNaN(d2.getTime())) return NaN;
    d1.setHours(0,0,0,0); d2.setHours(0,0,0,0);
    return Math.round((d2 - d1) / 86400000);
  }

  function getMode(){
    return (modeGroup.checked ? "group" : "single");
  }
  function setMode(m){
    const isGroup = (m === "group");
    modeGroup.checked = isGroup;
    modeSingle.checked = !isGroup;
    modeBulkBox.hidden = !isGroup;
    modeSingleBox.hidden = isGroup;
    try{ localStorage.setItem("mbk_ov_mode", isGroup ? "group" : "single"); }catch{}
 

    clearWarn();
  }

 
  // ===================== Step Mode (ØªÙ†ÙÙŠØ° Ø®Ø·ÙˆØ© Ù…Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡) =====================
  const qp = new URLSearchParams(location.search);
  const stepParam = (qp.get("step") || qp.get("stepIndex") || "").trim();
  const STEP_MODE = !!stepParam;
  const STEP_INDEX = STEP_MODE ? Math.max(0, parseInt(stepParam, 10) || 0) : -1;

  async function loadStepTargets(){
    if (!STEP_MODE) return;
    // âœ… ÙÙŠ Step Mode: Ù†Ø¬Ø¨Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø¥Ù„Ù‰ "Ù…Ø¬Ù…ÙˆØ¹Ø©" Ù„Ø£Ù† Ø§Ù„ØªÙ†ÙÙŠØ° ÙŠÙƒÙˆÙ† Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø£Ø±Ù‚Ø§Ù…
    setMode("group");
    modeSingle.disabled = true;
    modeGroup.disabled = true;

    // âœ… Ø§Ù‚ÙÙ„ Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ (Ù‡Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø²Ø± Ù„Ù„ØªØ£ÙƒÙŠØ¯)
    saveBtn.textContent = "ØªØ£ÙƒÙŠØ¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ©";
    openCowCard.textContent = "Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯";

    const u = await waitUser();
    if (!u) { showWarn("âš ï¸ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§."); return; }

    const due = todayISO();

    // âœ… Ø§Ø¬Ù„Ø¨ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… Ø«Ù… ÙÙ„ØªØ±Ù‡Ø§ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù€ Index
    const qAll = query(
      collection(fbDb, "tasks"),
      where("userId", "==", u.uid),
      where("dueDate", "==", due),
      where("status", "==", "pending"),
      limit(500)
    );

    const snap = await getDocs(qAll);

    const nums = [];
    let meta = null;

    snap.forEach(d=>{
      const t = d.data() || {};
      if (t.type !== "ovsynch_step") return;
      if (Number(t.stepIndex) !== STEP_INDEX) return;
      nums.push(String(t.animalNumber||"").trim());
      if (!meta) meta = t;
    });

    const uniq = [...new Set(nums)].filter(Boolean);

    if (!uniq.length){
      showWarn("âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ÙŠÙˆÙ….");
      try{ bulkEl.value = ""; }catch{}
      try{ bulkHintEl.textContent = ""; }catch{}
      return;
    }

    // âœ… Ù‡ÙŠØ¯Ø± ÙˆØ§Ø¶Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const stepName = String(meta?.stepName || "");
    showWarn(`Ø®Ø·ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ… â€” ${stepName || ("Ø§Ù„Ø®Ø·ÙˆØ© Ø±Ù‚Ù… " + STEP_INDEX)} â€” ${uniq.length} Ø­ÙŠÙˆØ§Ù†`);

    // âœ… Ø¸Ø¨Ø· Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ù…Ù† Ø£ÙˆÙ„ Ù…Ù‡Ù…Ø©) Ø«Ù… Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®Ø·ÙˆØ§Øª
    if (meta?.protocolProgram) programEl.value = String(meta.protocolProgram);
    if (meta?.protocolStartDate) startDateEl.value = String(meta.protocolStartDate).slice(0,10);

    programEl.disabled = true;
    startDateEl.disabled = true;
    startTimeEl.disabled = true;

    updateSteps();

    // âœ… Ø§Ù…Ù„Ø£ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ â€” B)
    bulkEl.value = uniq.join("\n");
    try{ bulkHintEl.textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${uniq.length} Ø±Ù‚Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù/Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ù‚Ø§Ù… Ù‚Ø¨Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯.`; }catch{}

    // âœ… Ø¹Ø·Ù‘Ù„ ÙƒÙ„ checkboxes Ù…Ø§ Ø¹Ø¯Ø§ Ø®Ø·ÙˆØ© Ø§Ù„ÙŠÙˆÙ…
    const boxes = stepsBox.querySelectorAll('input[type="checkbox"][data-i]');
    boxes.forEach(b=>{
      const i = parseInt(b.dataset.i||"-1",10);
      if (i !== STEP_INDEX){
        b.disabled = true;
        b.closest('.step')?.classList.add("disabled");
      } else {
        b.disabled = false;
      }
    });

    // âœ… Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø®Ø·ÙˆØ© Ø§Ù„ÙŠÙˆÙ…
    const targetBox = stepsBox.querySelector(`input[type="checkbox"][data-i="${STEP_INDEX}"]`);
    targetBox?.closest(".step")?.scrollIntoView({ behavior:"smooth", block:"center" });
  }

  async function confirmStepExecution(){
    if (!STEP_MODE) return;

    clearWarn();
    const u = await waitUser();
    if (!u) { showWarn("âš ï¸ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§."); return; }

    const list = parseBulk().map(x=>String(x).trim()).filter(Boolean);
    if (!list.length){ showWarn("âš ï¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©."); return; }

    // âœ… Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯Ù†Ø§ stepsState (ØªÙˆÙ„Ø¯Øª Ù…Ù† updateSteps)
    const st = stepsState[STEP_INDEX] || {};
    const program = (programEl.value || "").trim();
    const startISO = (startDateEl.value || "").trim() || todayISO();

    // âœ… Ø§Ø­ÙØ¸ Ø®Ø·ÙˆØ© Ø§Ù„ÙŠÙˆÙ… Ù„ÙƒÙ„ Ø±Ù‚Ù…: events + tasks
    let done = 0;

    for (const animal of list){
      const baseId = ["ovsynch", animal, program, startISO].join("__");
      const taskId = `${baseId}__step_${STEP_INDEX}`;
      const stepEventId = `${baseId}__step_event_${STEP_INDEX}`;

      // 1) Ø­Ø¯Ø« Ø®Ø·ÙˆØ© ÙÙŠ Root events (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±)
      await setDoc(doc(fbDb, "events", stepEventId), {
        userId: u.uid,
        ownerUid: u.uid,
        type: "ovsynch_step",
        eventType: "Ø®Ø·ÙˆØ© ØªØ²Ø§Ù…Ù†",
        eventDate: todayISO(),
        animalNumber: String(animal),
        protocolType: "ovsynch",
        protocolProgram: String(program || ""),
        protocolStartDate: String(startISO).slice(0,10),
        stepIndex: STEP_INDEX,
        stepDay: Number(st.day ?? 0),
        stepName: String(st.name || ""),
        source: location.pathname,
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp()
      }, { merge: true });

      // 2) Ø§Ù‚ÙÙ„ Ø§Ù„Ù€ task
      await setDoc(doc(fbDb, "tasks", taskId), {
        status: "done",
        done: true,
        doneAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge: true });

      done++;
    }

    showWarn(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ© Ù„Ù€ ${done} Ø­ÙŠÙˆØ§Ù†.`);
    // Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù„Ùˆ ÙŠØ­Ø¨
    try{
      setTimeout(()=>{ location.href = "/dashboard.html"; }, 700);
    }catch{}
  }


function syncCentral(){
  const mode = getMode();
  const list = (mode === "group")
    ? parseBulk().map(x => String(x).trim()).filter(Boolean)
    : [String(animalUI.value || "").trim()].filter(Boolean);

  // âœ… Ù„Ø§Ø²Ù… Ø¯Ø§ÙŠÙ…Ù‹Ø§ ÙŠØ¨Ù‚Ù‰ ÙÙŠÙ‡ animalNumber â€œÙ…Ù…Ø«Ù„â€ (Ø£ÙˆÙ„ Ø±Ù‚Ù…) Ø¹Ø´Ø§Ù† forms-init Ù…Ø§ ÙŠÙ‚ÙÙ„Ø´
  animalHidden.value = (list[0] || "");

  // âœ… Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„Ù‡Ø§
  const animalNumbersHidden = document.getElementById("animalNumbers");
  if (animalNumbersHidden) animalNumbersHidden.value = JSON.stringify(list);

  eventHidden.value = (startDateEl.value || "").trim();
  stepsHidden.value = JSON.stringify(stepsState || []);
}


  openCowCard.addEventListener("click", () => {
    if (STEP_MODE){
      location.href = "/dashboard.html";
      return;
    }
    const num = (getMode()==="group" ? (parseBulk()[0]||"") : (animalUI.value||"")).trim();
    if (!num) { showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø£ÙˆÙ„Ù‹Ø§."); return; }
    location.href = `cow-card.html?number=${encodeURIComponent(num)}`;
  });

  // âœ… Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Today ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  if (!startDateEl.value) startDateEl.value = todayISO();

  // âœ… Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ± Ø§Ù„ÙˆØ¶Ø¹ + Ø§Ù„Ø±Ù‚Ù…/Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ­Ù‚Ù‚)
  (function hydrateFromURL(){
    const qp = new URLSearchParams(location.search);

    const m = (qp.get("mbkMode") || "").trim().toLowerCase();
    const saved = (localStorage.getItem("mbk_ov_mode") || "single");
    setMode(m === "group" ? "group" : saved);

    const num = (qp.get("number") || qp.get("animalNumber") || "").trim();
    const dt  = (qp.get("date") || qp.get("eventDate") || "").trim();

    if (num) animalUI.value = num;
    if (dt)  startDateEl.value = dt || todayISO();

    syncCentral();
  })();

  modeSingle.addEventListener("change", ()=>setMode("single"));
  modeGroup.addEventListener("change", ()=>setMode("group"));

  animalUI.addEventListener("input",syncCentral);
  bulkEl?.addEventListener("input",syncCentral);
  startDateEl.addEventListener("input",syncCentral);
  programEl?.addEventListener("change", syncCentral);
startTimeEl?.addEventListener("change", syncCentral);


  /* ========= Programs ========= */
  const PROGRAMS = {
    ovsynch: [
      { day: 0,  name: "GnRH (Ø§Ù„ÙŠÙˆÙ… 0)" },
      { day: 7,  name: "PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)" },
      { day: 9,  name: "GnRH (Ø§Ù„ÙŠÙˆÙ… 9)" },
      { day: 10, name: "ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10)" },
    ],
    cosynch72: [
      { day: 0,  name: "GnRH (Ø§Ù„ÙŠÙˆÙ… 0)" },
      { day: 7,  name: "PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)" },
      { day: 10, name: "GnRH + ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Cosynch-72) (Ø§Ù„ÙŠÙˆÙ… 10)" },
    ],
    presynch_ovsynch: [
      { day: 0,  name: "PGF2Î± (Presynch 1) (Ø§Ù„ÙŠÙˆÙ… 0)" },
      { day: 14, name: "PGF2Î± (Presynch 2) (Ø§Ù„ÙŠÙˆÙ… 14)" },
      { day: 28, name: "GnRH (Ovsynch) (Ø§Ù„ÙŠÙˆÙ… 28)" },
      { day: 35, name: "PGF2Î± (Ovsynch) (Ø§Ù„ÙŠÙˆÙ… 35)" },
      { day: 37, name: "GnRH (Ovsynch) (Ø§Ù„ÙŠÙˆÙ… 37)" },
      { day: 38, name: "ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ovsynch) (Ø§Ù„ÙŠÙˆÙ… 38)" },
    ],
  };

  function updateSteps(){
    stepsBox.innerHTML='';
    const start=startDateEl.value, program=programEl.value;
    if(!start||!program) { stepsState=[]; syncCentral(); return; }

    stepsState=(PROGRAMS[program]||[]).map(s=>{
      const d=new Date(start+"T"+(startTimeEl.value||"08:00"));
      d.setDate(d.getDate()+s.day);
      return { day:s.day, name:s.name, date:d.toISOString().slice(0,16), done:false };
    });

    for (let i=0;i<stepsState.length;i++){
      const st = stepsState[i];
      const row=document.createElement("div");
      row.className="step";
      row.innerHTML=`
        <div>
          <div class="name">${st.name}</div>
          <div class="date">ğŸ“… ${new Date(st.date).toLocaleString('ar-EG')}</div>
        </div>
        <label class="chk">
          <input type="checkbox" data-i="${i}">
          ØªÙ…
        </label>`;
      stepsBox.appendChild(row);
    }
    syncCentral();
  }

  stepsBox.addEventListener("change", async (e)=>{
    const i = e.target?.dataset?.i;
    if (i === undefined) return;

    const idx = parseInt(i, 10);

    // âœ… Step Mode: Ù…Ù…Ù†ÙˆØ¹ ØºÙŠØ± Ø®Ø·ÙˆØ© Ø§Ù„ÙŠÙˆÙ…
    if (STEP_MODE){
      if (idx !== STEP_INDEX){
        e.target.checked = false;
        return;
      }
      // âœ… Ø¹Ù†Ø¯ âœ“ Ø¹Ù„Ù‰ Ø®Ø·ÙˆØ© Ø§Ù„ÙŠÙˆÙ…: Ù†ÙÙ‘Ø°Ù‡Ø§ ÙÙˆØ±Ù‹Ø§
      if (!!e.target.checked){
        await confirmStepExecution();
      } else {
        // Ù„Ø§ Ù†Ø³Ù…Ø­ Ø¨Ø¥Ù„ØºØ§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯
        e.target.checked = true;
      }
      return;
    }

    // âœ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ: Ù…Ø¬Ø±Ø¯ ØªØ¹Ù„ÙŠÙ…/Ø¥Ù„ØºØ§Ø¡ ØªØ¹Ù„ÙŠÙ… Ø¯Ø§Ø®Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
    stepsState[idx].done = !!e.target.checked;
    syncCentral();
  });

  programEl.addEventListener("change",updateSteps);
  startDateEl.addEventListener("change",updateSteps);
  startTimeEl.addEventListener("change",updateSteps);

  // âœ… Step Mode: ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  loadStepTargets();

  /* ========= Firebase (Robust) ========= */
  async function waitUser(ms=1500){
    return await new Promise(res=>{
      const t=setTimeout(()=>res(fbAuth?.currentUser||null),ms);
      onAuthStateChanged(fbAuth,u=>{ clearTimeout(t); res(u||null); });
    });
  }


  // âœ… Groups feature removed (we no longer use protocolGroups/users groups).
  // Keep a no-op refreshGroups to avoid breaking older calls.
  async function refreshGroups(){ return; }

  const u0 = await waitUser();
if (u0) await refreshGroups(u0.uid);



/* ========= Save ========= */
  saveBtn.addEventListener("click", async ()=>{
    // âœ… Step Mode: ØªÙ†ÙÙŠØ° Ø®Ø·ÙˆØ© Ø§Ù„ÙŠÙˆÙ… (Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„)
    if (STEP_MODE){
      await confirmStepExecution();
      return;
    }
    syncCentral();
    form.requestSubmit(); // âœ… Ù…Ø±ÙƒØ²ÙŠ ÙÙ‚Ø·
  });

  // âœ… Ø­ÙØ¸ ÙØ¹Ù„ÙŠ: ÙØ±Ø¯ÙŠ Ø£Ùˆ Ø¬Ù…Ø§Ø¹ÙŠ Ø¨Ø¹Ø¯ mbk:valid
 form.addEventListener("mbk:valid", async (ev)=> {
   

    const start = (startDateEl.value || "").trim() || todayISO();
    if (!startDateEl.value) startDateEl.value = start;
   const program = (programEl.value || "").trim();
   if (!fbReady || !fbDb || !fbAuth) return;

const u = await waitUser();
if (!u) return;


    // âœ… Ø­Ø¯Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹
    const targets = (getMode()==="group")
      ? (parseBulk().map(x=>String(x).trim()).filter(Boolean))
      : [String(animalUI.value||"").trim()].filter(Boolean);

    if (!targets.length){ showWarn("âš ï¸ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†."); return; }

   // âœ… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ØªØ£ØªÙŠ Ù…Ù† forms-init (Ù…Ø±ÙƒØ²ÙŠ)
const fd = ev?.detail?.formData || null;

// âœ… Ù‚ÙÙ„ Ø£Ù…Ø§Ù†: Ù…Ù…Ù†ÙˆØ¹ Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ù†ØªÙŠØ¬Ø© ØªØ­Ù‚Ù‚ ØµØ±ÙŠØ­Ø© Ù…Ù† forms-init
if (!fd || !Array.isArray(fd.animalNumbers)) {
 
  return;
}

const finalList = fd.animalNumbers;
   

const rejected  = Array.isArray(fd.rejected) ? fd.rejected : [];



    // âœ… Ø¨Ù†Ø§Ø¡ payload Ø«Ø§Ø¨Øª Ù„Ù„Ø®Ø·ÙˆØ§Øª
    const payloadBase = {
      type: "ovsynch",
      eventType: "Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†",
      eventDate: start,
      program,
      steps: stepsState,
      userId: u.uid,

      createdAt: serverTimestamp()
    };

    let saved = 0;
    let already = 0;

    for (const animal of finalList){
      const id = ["ovsynch", animal, program, start].join("__");
      const ref = doc(fbDb, "events", id);

      const ex = await getDoc(ref);
      if (ex.exists()){
        already++;
        continue;
      }

      const payload = Object.assign({}, payloadBase, { animalNumber: animal });
      await setDoc(ref, payload);
      await upsertOvsynchTasks(u.uid, animal, start, program, stepsState);

      if (typeof window.updateAnimalByEvent === "function"){
        try{ await window.updateAnimalByEvent(payload); }catch{}
      }

      saved++;
    }

    // âœ… Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ø¶Ø­Ø©
    let msg = `âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${saved} Ø±Ù‚Ù…`;
    if (already) msg += `\nâ›” Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§: ${already} Ø±Ù‚Ù…`;
    if (rejected.length){
      const prev = rejected.slice(0,6).map(x=>x.reason).join("\n");
      msg += `\n\nğŸš« Ù…Ø³ØªØ¨Ø¹Ø¯: ${rejected.length} Ø±Ù‚Ù…\n${prev}${rejected.length>6 ? "\nâ€¦" : ""}`;
    }

    if (typeof window.showMsg === "function") {
  window.showMsg(infoEl, msg.split("\n"), "ok");
} else {
  // fallback Ø¨Ø³ÙŠØ· Ù„Ùˆ Ø­ØµÙ„ Ø£ÙŠ Ø´ÙŠØ¡
  infoEl.style.display="block";
  infoEl.textContent = msg;
}

    clearWarn();

    // âœ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒÙˆÙ†ØªÙƒØ³Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
    syncCentral();
  });

  // âœ… Ø£ÙˆÙ„ Ù…Ø²Ø§Ù…Ù†Ø©
  syncCentral();
})();
</script>

</body>
</html>
