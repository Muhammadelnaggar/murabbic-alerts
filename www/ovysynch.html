<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="css/forms.css">
  <title>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¶ ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</title>
  <style>
    body{direction:rtl;background:#fffde7;font-family:'Arial',sans-serif;margin:0;padding:18px;color:#1b5e20}
    h1{margin:0 0 12px;text-align:center;color:#2e7d32;font-size:24px}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #8bc34a;border-radius:999px;background:#dcedc8;color:#1b5e20;font-size:14px}
    .context{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:6px 0 12px}
    .card{max-width:560px;margin:0 auto;background:#f1f8e9;border:1px solid #c5e1a5;border-radius:12px;padding:16px}
    label{display:block;margin-top:12px;font-weight:bold;color:#2e7d32}
    input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin-top:6px;font-size:16px;box-sizing:border-box}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:640px){.row-2{grid-template-columns:1fr 1fr}}
    .steps{margin-top:12px;border:1px solid #c5e1a5;border-radius:10px;background:#eaf5ec}
    .step{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px dashed #c5e1a5}
    .step:last-child{border-bottom:none}
    .step .name{font-weight:bold;color:#1b5e20}
    .step .date{color:#1b5e20;white-space:nowrap}
    .step .chk{display:flex;align-items:center;gap:6px}
    .muted{color:#5f6f64;font-size:13px;margin-top:6px}
    .actions{position:sticky;bottom:0;left:0;right:0;background:rgba(255,255,255,.9);border-top:1px solid #c5e1a5;padding:10px 0;margin-top:14px}
    .actions .wrap{max-width:560px;margin:0 auto;display:flex;gap:8px}
    button{appearance:none;border:0;border-radius:8px;padding:12px 14px;font-weight:bold;font-size:16px;cursor:pointer}
    .btn-primary{background:#2e7d32;color:#fff}
    .btn-ghost{background:#fff;border:1px solid #2e7d32;color:#2e7d32}
    .notice{display:none;margin-top:10px;padding:12px;border-radius:10px;background:#f0fdf4;border:1px solid #bbf7d0;color:#065f46}
    .notice .actions{display:flex;gap:8px;margin-top:10px;position:static;border:0;background:transparent;padding:0}
    .warn{color:#c62828;text-align:center;min-height:22px;margin-top:8px}
    .on-time{font-size:12px;padding:2px 8px;border-radius:999px}
    .ok{background:#dcfce7;border:1px solid #bbf7d0;color:#166534}
    .late{background:#fef3c7;border:1px solid #fde68a;color:#92400e}
  </style>
</head>
<body>
  <h1>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¶ ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</h1>
  <div class="context">
    <span id="ctxAnimal" class="pill">Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
    <span id="ctxDate" class="pill">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡: â€”</span>
  </div>

  <div class="card">
    <form id="ovForm">
      <div class="row row-2">
        <div>
          <label for="animalId">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
          <input id="animalId" type="text" placeholder="Ù…Ø«Ø§Ù„: 105"/>
        </div>
        <div>
          <label for="startDate">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ (Ø§Ù„ÙŠÙˆÙ… 0)</label>
          <input id="startDate" type="date"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="program">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
          <select id="program">
            <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</option>
            <option value="ovsynch">Ovsynch</option>
            <option value="cosynch72">Cosynch-72</option>
            <option value="presynch_ovsynch">Presynch + Ovsynch</option>
          </select>
          <div class="muted">ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡. Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© âœ”ï¸ Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° ÙƒÙ„ Ø®Ø·ÙˆØ© Ù„ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ ÙÙˆØ±Ù‹Ø§ ÙƒÙ€"Ø®Ø·ÙˆØ© Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„".</div>
        </div>
      </div>

      <div id="stepsBox" class="steps" aria-live="polite"></div>

      <div id="warn" class="warn"></div>

      <div id="inlineMsg" class="notice" role="status" aria-live="polite">
        <div class="text"></div>
        <div class="actions">
          <button type="button" id="msgYes" class="btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« Ø£Ø®Ø±Ù‰</button>
          <button type="button" id="msgNo"  class="btn-ghost">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
        </div>
      </div>
    </form>
  </div>

  <div class="actions">
    <div class="wrap">
      <button id="saveBtn" class="btn-primary" type="button">ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</button>
      <button id="resetBtn" class="btn-ghost" type="button">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const ctxAnimal   = document.getElementById('ctxAnimal');
    const ctxDate     = document.getElementById('ctxDate');
    const form        = document.getElementById('ovForm');
    const animalIdEl  = document.getElementById('animalId');
    const startDateEl = document.getElementById('startDate');
    const programEl   = document.getElementById('program');
    const stepsBox    = document.getElementById('stepsBox');

    const saveBtn = document.getElementById('saveBtn');
    const resetBtn= document.getElementById('resetBtn');
    const warn    = document.getElementById('warn');

    const msgBox  = document.getElementById('inlineMsg');
    const msgText = msgBox.querySelector('.text');
    const btnYes  = document.getElementById('msgYes');
    const btnNo   = document.getElementById('msgNo');

    let dbRef=null, authRef=null; // Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ù…Ø³ØªÙ…Ø¹ checkbox

    function todayLocal(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    function showWarn(t){ warn.textContent=t; }
    function clearWarn(){ warn.textContent=''; }
    function showMsg(text){ msgText.textContent=text; msgBox.style.display='block'; }
    function hideMsg(){ msgBox.style.display='none'; msgText.textContent=''; }

    function hydrate(){
      const qp = new URLSearchParams(location.search);
      const id = qp.get('animalId') || qp.get('animalIdd') || qp.get('number') || localStorage.getItem('lastAnimalId') || '';
      const dt = qp.get('date') || todayLocal();
      animalIdEl.value = id; if(id) animalIdEl.readOnly = true;
      startDateEl.value = dt;
      ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${id||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
      try{ ctxDate.textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡: ${new Date(dt).toLocaleDateString('ar-EG')}`; }catch{ ctxDate.textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡: ${dt}`; }
    }

    hydrate();

    animalIdEl.addEventListener('input', ()=>{ ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${animalIdEl.value.trim()||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`; });
    startDateEl.addEventListener('input', ()=>{ try{ ctxDate.textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡: ${new Date(startDateEl.value).toLocaleDateString('ar-EG')}`;}catch{ ctxDate.textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡: ${startDateEl.value}`; } updateSteps(); });
    programEl.addEventListener('change', updateSteps);

    function addDays(base, days){ const d=new Date(base); d.setDate(d.getDate()+days); return d; }
    function fmt(d){ try{ return d.toLocaleDateString('ar-EG'); }catch{ return d.toISOString().slice(0,10); } }

    // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ (Ø£ÙŠØ§Ù… Ù†Ø³Ø¨ÙŠØ© Ù…Ù† ÙŠÙˆÙ… 0)
    const PROGRAMS = {
      ovsynch:[
        { day: 0,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 9,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 9 ~ Ø¨Ø¹Ø¯ ~56 Ø³Ø§Ø¹Ø©)' },
        { day: 10, name:'ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 ~ Ø¨Ø¹Ø¯ ~16 Ø³Ø§Ø¹Ø©)' },
      ],
      cosynch72:[
        { day: 0,  name:'GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 10, name:'GnRH + ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 â‰ˆ 72 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ PGF)' },
      ],
      presynch_ovsynch:[
        { day:-28, name:'Presynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… -28)' },
        { day:-14, name:'Presynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… -14)' },
        { day: 0,  name:'Ovsynch: GnRH (Ø§Ù„ÙŠÙˆÙ… 0)' },
        { day: 7,  name:'Ovsynch: PGF2Î± (Ø§Ù„ÙŠÙˆÙ… 7)' },
        { day: 9,  name:'Ovsynch: GnRH (Ø§Ù„ÙŠÙˆÙ… 9 ~ Ø¨Ø¹Ø¯ ~56 Ø³Ø§Ø¹Ø©)' },
        { day: 10, name:'Ovsynch: ØªÙ„Ù‚ÙŠØ­ Ù…ÙÙˆÙ‚Ù‘Øª TAI (Ø§Ù„ÙŠÙˆÙ… 10 ~ Ø¨Ø¹Ø¯ ~16 Ø³Ø§Ø¹Ø©)' },
      ]
    };

    let stepsState = [];

    function updateSteps(){
      stepsBox.innerHTML = '';
      const start = startDateEl.value;
      const program = programEl.value;
      if(!start || !program) return;

      const tpl = PROGRAMS[program] || [];
      const prev = stepsState;
      stepsState = tpl.map((s)=>{
        const dateISO = addDays(start, s.day).toISOString().slice(0,10);
        const keep = prev.find(p=>p.name===s.name && p.day===s.day);
        return {
          day: s.day,
          name: s.name,
          date: dateISO,
          done: keep ? !!keep.done : false,
          confirmedOn: keep ? keep.confirmedOn || null : null,
          onSchedule: keep ? !!keep.onSchedule : false,
          _savedOnce: keep ? !!keep._savedOnce : false,
        };
      });

      stepsState.forEach((st, idx)=>{
        const row = document.createElement('div');
        row.className = 'step';
        const chip = st.done ? `<span class="on-time ${st.onSchedule? 'ok':'late'}">${st.onSchedule? 'âœ“ ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯':'âœ“ Ù…Ø¤ÙƒØ¯Ø©'}</span>` : '';
        row.innerHTML = `
          <div class="name">${st.name}</div>
          <div class="date">ğŸ“… ${fmt(new Date(st.date))} ${chip}</div>
          <label class="chk"><input data-idx="${idx}" type="checkbox" ${st.done? 'checked':''}/> ØªÙ…</label>
        `;
        stepsBox.appendChild(row);
      });
    }

    // Ø­ÙØ¸ Ø®Ø·ÙˆØ© Ù…Ù†ÙØµÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯
    async function saveStepEvent(i){
      try{
        if(!dbRef) return; // Ù„Ø§ ØªØ­Ø·Ù… Ø§Ù„ØµÙØ­Ø© Ø¥Ù† Ù„Ù… ØªØªÙˆÙØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const st = stepsState[i];
        if(!st || st._savedOnce) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø¬Ù„Ø³Ø©
        const animalId = (animalIdEl.value||'').trim();
        const payload = {
          type: 'ovysynch-step',
          eventType: 'Ø®Ø·ÙˆØ© Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„',
          stepName: st.name,
          program: programEl.value || null,
          protocolStartDate: (startDateEl.value||'').trim() || null,
          plannedDay: st.day,
          plannedDate: st.date,
          confirmedOn: st.confirmedOn,
          onSchedule: !!st.onSchedule,
          animalId,
          animalNumber: animalId,
          userId: authRef?.currentUser?.uid || null,
          createdAt: serverTimestamp()
        };
        await addDoc(collection(dbRef,'events'), payload);
        st._savedOnce = true;
      }catch(err){ console.error('saveStepEvent failed', err); }
    }

    stepsBox.addEventListener('change', async (e)=>{
      const el = e.target.closest('input[type="checkbox"][data-idx]');
      if(!el) return;
      const i = Number(el.getAttribute('data-idx'));
      const today = todayLocal();
      const st = stepsState[i];
      st.done = el.checked;
      st.confirmedOn = el.checked ? today : null;
      st.onSchedule = el.checked ? (today === st.date) : false;
      if (el.checked) { await saveStepEvent(i); }
      updateSteps();
    });

    // Firebase
    async function setupFirebase(){
      try{
        const mod = await import('./js/firebase-config.js?v=5');
        if(mod?.db && mod?.auth){ return { db:mod.db, auth:mod.auth }; }
        if(mod?.firebaseConfig){ const app=initializeApp(mod.firebaseConfig); return { db:getFirestore(app), auth:getAuth(app) }; }
      }catch(e){ /* ignore */ }
      try{ const cfg = await import('./config.js?v=5'); const app=initializeApp(cfg.firebaseConfig); return { db:getFirestore(app), auth:getAuth(app) }; }catch(e2){ showWarn('âŒ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.'); return { db:null, auth:null }; }
    }

    const { db, auth } = await setupFirebase();
    dbRef = db; authRef = auth;

    function getCtx(){
      const animalId = animalIdEl.value.trim();
      const start = startDateEl.value.trim();
      const program = programEl.value;
      if(!animalId || !start || !program){ showWarn('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.'); return null; }
      clearWarn(); localStorage.setItem('lastAnimalId', animalId);
      return { animalId, start, program, steps: stepsState };
    }

    async function saveProtocol(){
      const ctx = getCtx(); if(!ctx) return;
      saveBtn.disabled = true; saveBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸';
      try{
        if(db) await addDoc(collection(db,'events'), {
          type:'ovysynch', eventType:'Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ ØªØ²Ø§Ù…Ù†',
          animalId: ctx.animalId, animalNumber: ctx.animalId,
          startDate: ctx.start,
          program: ctx.program,
          steps: ctx.steps,
          userId: auth?.currentUser?.uid || null,
          createdAt: serverTimestamp()
        });
        hideMsg(); showMsg('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
      }catch(e){ console.error(e); showWarn('âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'); }
      finally{ saveBtn.disabled=false; saveBtn.textContent='ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„'; }
    }

    saveBtn.addEventListener('click', saveProtocol);
    form.addEventListener('submit', (e)=>{ e.preventDefault(); saveProtocol(); });

    btnYes.addEventListener('click', ()=>{
      const id = animalIdEl.value.trim();
      const dt = startDateEl.value.trim();
      hideMsg();
      location.href = `add-event.html?animalId=${encodeURIComponent(id)}&animalIdd=${encodeURIComponent(id)}&number=${encodeURIComponent(id)}&date=${encodeURIComponent(dt)}`;
    });
    btnNo.addEventListener('click', ()=>{ hideMsg(); location.href = 'dashboard.html'; });

    resetBtn.addEventListener('click', ()=>{ form.reset(); hydrate(); stepsState=[]; stepsBox.innerHTML=''; hideMsg(); clearWarn(); });

    // Ø£ÙˆÙ„ Ø¹Ø±Ø¶
    updateSteps();
  </script>
</body>
</html>
