<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª</title>
  <style>
    :root{--bg:#fff9db;--card:#ffffff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20;overflow-x:hidden}
    h1{margin:0 0 16px;text-align:center;color:#1b5e20;font-size:22px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);max-width:560px;margin:0 auto}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .btn{appearance:none;border:2px solid var(--green);background:#fff;color:#2e7d32;border-radius:14px;padding:12px 14px;font-weight:bold;cursor:pointer}
    .btn:hover{background:#f4fff1}
    .btn{flex:1 1 180px}
    .muted{font-size:12px;color:#446}
    pre{background:#f7fff4;border:1px solid var(--border);padding:10px;border-radius:10px;overflow:auto;max-height:200px;min-height:120px;word-break:break-word}
    .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid var(--border);border-radius:10px;background:#f7fff4}
    table{width:100%;border-collapse:collapse;margin-top:0;min-width:540px}
    th,td{border:1px solid var(--border);padding:8px 6px;text-align:center}
    th{background:#eafbe7;position:sticky;top:0}
    a{color:#2e7d32;text-decoration:none}

    /* Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£ØµØºØ± */
    @media(max-width:560px){
      body{padding:12px}
      .card{padding:12px;border-radius:12px}
      h1{font-size:20px}
      .row{gap:6px}
      .btn{flex:1 1 100%;width:100%;font-size:16px;padding:12px}
      table{font-size:14px}
    }
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .chip{border:1px solid var(--green);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:600}
    .chip:hover{background:#f4fff1}
    .input{flex:1 1 180px;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#fff}
  </style>
</head>
<body>
  <h1>ğŸ›°ï¸ ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª</h1>
  <div class="card">
    <div class="row">
      <button class="btn" id="btnHealth">ÙØ­Øµ /api/sensors/health</button>
      <button class="btn" id="btnIngest">Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø±Ø§Ø¡Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
      <button class="btn" id="btnList">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</button>
      <a class="btn" href="dashboard.html">â†©ï¸ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
    </div>
    <div class="row muted">Ø§Ù„Ù…ØµØ¯Ø±: Ù†ÙØ³ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ. Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ CORS.</div>

    <h3>Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª (Ù†Ù…Ø§Ø°Ø¬ Ø³Ø±ÙŠØ¹Ø©)</h3>
    <div class="chips" id="chipBox">
      $1
      <button class="chip" data-type="milkcond">ğŸ§ª ØªÙˆØµÙŠÙ„ÙŠØ© Ø§Ù„Ù„Ø¨Ù†</button>
      <button class="chip" data-type="milkcolor">ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ù„Ø¨Ù†</button>
      <button class="chip" data-type="mounting">â¤ï¸ Ù†Ø´Ø§Ø· Ø§Ù„ØªØ²Ø§ÙˆØ¬/Ø§Ù„Ø±ÙƒÙˆØ¨</button>
      <button class="chip" data-type="activity">ğŸ·ï¸ ÙŠØ§Ù‚Ø©/Ù†Ø´Ø§Ø·</button>
      <button class="chip" data-type="rumination">ğŸ„ Ø§Ø¬ØªØ±Ø§Ø±</button>
      <button class="chip" data-type="weight">âš–ï¸ Ù…ÙŠØ²Ø§Ù† Ø°ÙƒÙŠ</button>
      <button class="chip" data-type="bodytemp">ğŸŒ¡ï¸ Ø­Ø±Ø§Ø±Ø© Ø¬Ø³Ù…</button>
      <button class="chip" data-type="rumenph">ğŸ§ª pH ÙƒØ±Ø´</button>
      <button class="chip" data-type="water">ğŸš° Ø¹Ø¯Ø§Ø¯ Ù…ÙŠØ§Ù‡</button>
      <button class="chip" data-type="feeder">ğŸ½ï¸ Ù…Ø¹Ù„Ù Ø°ÙƒÙŠ</button>
    </div>

    <div class="row" style="align-items:center">
      <input id="farm" class="input" placeholder="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø²Ø±Ø¹Ø©" value="EG-ALSHARKIA-01"/>
      <input id="dev" class="input" placeholder="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/>
    </div>

    <h3>Ø§Ù„Ù†ØªÙŠØ¬Ø©</h3>
    <pre id="out">â€”</pre>
    <h3>Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h3>
    <div class="table-wrap" id="tblWrap" style="display:none">
      <table id="tbl">
      <thead><tr><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±</th><th>Ù…Ù„Ø®Øµ Ù‚ÙŠØ§Ø³Ø§Øª</th></tr></thead>
      <tbody></tbody>
    </table>
    </div>
  
<script>
const out = document.getElementById('out');
const tbl = document.getElementById('tbl');
const wrap = document.getElementById('tblWrap');
const tbody = tbl.querySelector('tbody');

function log(obj){ out.textContent = (typeof obj==='string')?obj:JSON.stringify(obj,null,2); }

async function health(){
  const r = await fetch('/api/sensors/health');
  log({status:r.status, ok:r.ok, json: await r.json().catch(()=>null)});
}

async function ingest(){
  const payload = {
    farmId:'EG-ALSHARKIA-01',
    deviceId:'act-001',
    device:{name:'Activity Tag', type:'activity'},
    metrics:[
      {name:'activity.idx', value:rnd(20,90), unit:'', ts: Date.now()},
      {name:'activity.steps', value:rnd(1000,6000), unit:'', ts: Date.now()}
    ]
  };
  const r = await fetch('/ingest', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  log({status:r.status, ok:r.ok, json: await r.json().catch(()=>null)});
}

async function list(){
  const r = await fetch('/api/devices');
  const j = await r.json();
  log({status:r.status, ok:r.ok, count:j?.devices?.length||0});
  tbody.innerHTML = '';
  (j.devices||[]).filter(d=>{const t=(d.type||'').toLowerCase(); return t!=='env' && t!=='thi';}).forEach(d=>{
    const tr = document.createElement('tr');
    const last = d.lastSeen ? new Date(d.lastSeen).toLocaleString('ar-EG') : 'â€”';
    const msum = d.metrics ? Object.entries(d.metrics).map(([k,v])=>`${k}: ${v.value}${v.unit||''}`).slice(0,4).join(' â€¢ ') : 'â€”';
    tr.innerHTML = `<td>${d.id}</td><td>${d.farmId||'â€”'}</td><td>${d.type||'â€”'}</td><td>${last}</td><td style="text-align:right">${msum}</td>`;
    tbody.appendChild(tr);
  });
  wrap.style.display = 'block';
}

document.getElementById('btnHealth').onclick = health;
document.getElementById('btnIngest').onclick = ingest;
document.getElementById('btnList').onclick = list;

health();

// ====== Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª ======
const farmEl = document.getElementById('farm');
const devEl  = document.getElementById('dev');

function rnd(min,max){ return Math.round((Math.random()*(max-min)+min)*10)/10; }

function buildDemoPayload(type){
  const farmId = (farmEl?.value||'').trim() || 'EG-ALSHARKIA-01';
  const deviceId = (devEl?.value||'').trim() || `${type}-demo-001`;
  const now = Date.now();
  const base = { farmId, deviceId, device:{ name:type.toUpperCase(), type }, metrics: [] };
  switch(type){
    case 'milk':
      base.metrics = [
        {name:'milk.yield_l',  value:rnd(8,25),  unit:'L',  ts:now},
        {name:'milk.fat_pct',  value:rnd(3.2,5), unit:'%',  ts:now},
        {name:'milk.prot_pct', value:rnd(2.8,4), unit:'%',  ts:now}
      ]; break;
    case 'milkcond':
      base.metrics = [
        {name:'milk.cond_mScm', value:rnd(3.5,7), unit:'mS/cm', ts:now}
      ]; break;
    case 'milkcolor':
      base.metrics = [
        {name:'milk.color_score', value:rnd(20,90), unit:'', ts:now}
      ]; break;
    case 'mounting':
      base.metrics = [
        {name:'repro.mounts_24h', value: Math.round(rnd(0,25)), unit:'', ts:now},
        {name:'repro.mount_idx', value: rnd(0,100), unit:'', ts:now},
        {name:'repro.heat_prob_pct', value: rnd(5,95), unit:'%', ts:now}
      ]; break;
    case 'activity':
      base.metrics = [
        {name:'activity.steps', value:rnd(1000,6000), unit:'', ts:now},
        {name:'activity.idx',   value:rnd(20,90),     unit:'', ts:now}
      ]; break;
    case 'rumination':
      base.metrics = [ {name:'rumination.min', value:rnd(350,600), unit:'min', ts:now} ]; break;
    case 'weight':
      base.metrics = [ {name:'weight.kg', value:rnd(350,700), unit:'kg', ts:now} ]; break;
    case 'bodytemp':
      base.metrics = [ {name:'body.temp_c', value:rnd(37.5,40.5), unit:'Â°C', ts:now} ]; break;
    case 'rumenph':
      base.metrics = [ {name:'rumen.ph', value:rnd(5.4,7), unit:'', ts:now} ]; break;
    case 'water':
      base.metrics = [ {name:'water.flow_lpm', value:rnd(0,20), unit:'L/min', ts:now} ]; break;
    case 'feeder':
      base.metrics = [ {name:'feed.intake_kg', value:rnd(5,25), unit:'kg', ts:now} ]; break;
  }
  return base;
}

async function ingestType(type){
  const payload = buildDemoPayload(type);
  const r = await fetch('/ingest', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const j = await r.json().catch(()=>null);
  log({status:r.status, ok:r.ok, json:j, sent:payload});
  if(r.ok) list();
}

document.getElementById('chipBox').addEventListener('click', (e)=>{
  const btn = e.target.closest('.chip');
  if(!btn) return;
  ingestType(btn.dataset.type);
});
</script>
</body>
</html>
