<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <style>
  body { font-family: 'Arial', sans-serif; background-color: #f6fbf8; direction: rtl; padding: 10px; margin: 0; }
    h1 { color: #2e7d32; text-align: center; font-size: 22px; margin-bottom: 15px; }
    .controls { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .controls input, .controls select { padding: 8px; font-size: 14px; border-radius: 6px; border: 1px solid #ccc; min-width: 150px; }
    .controls button { padding: 8px 12px; background-color:#0ea05a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
   .controls button:hover { background-color: #0b7f47; }
    .table-wrapper { overflow-x: auto; background: #fefefc; border-radius: 10px; box-shadow: 0 0 5px #ccc; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; min-width: 950px; }
    .table-wrapper { direction: rtl; }
#animalTable { direction: rtl; }
    th, td { padding: 10px; text-align: center; border: 1px solid #cddc39; font-size: 15px; }
   th { background-color: #e8f5e9; color: #0b7f47; font-weight:600; }
    tr:nth-child(even) { background-color: #f9fbe7; }
    .button { padding: 5px 10px; background-color: #43a047; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .button:hover { background-color: #388e3c; }
    .delete-button { background-color: #c62828; }
    .delete-button:hover { background-color: #b71c1c; }
    .no-data { text-align: center; color: #c62828; margin-top: 30px; font-size: 18px; }
    .back-button { display: block; text-align: center; background-color: #4caf50; color: white; font-size: 16px; padding: 10px; border-radius: 8px; text-decoration: none; }

  :root{ --sticky-col1: 140px; }

#animalTable { border-collapse: separate; border-spacing: 0; }
#animalTable th, #animalTable td { background-clip: padding-box; }

/* âœ… Ø§Ù„Ø¹Ù…ÙˆØ¯ 1: Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† */
#animalTable th:nth-child(1), #animalTable td:nth-child(1){
  position: sticky;
  right: 0;
  z-index: 4;
  width: 1%;
  min-width: 0;
  white-space: nowrap;
}
#animalTable th:nth-child(1){ background: #e8f5e9; color:#0b7f47; }
#animalTable td:nth-child(1){ background: inherit; box-shadow: -1px 0 0 #cddc39 inset; }

/* âœ… Ø§Ù„Ø¹Ù…ÙˆØ¯ 2: Ø§Ù„Ù†ÙˆØ¹ */
#animalTable th:nth-child(2), #animalTable td:nth-child(2){
  position: sticky;
  right: var(--sticky-col1);
  z-index: 3;
  width: 1%;
  min-width: 0;
  white-space: nowrap;
}
#animalTable th:nth-child(2){ background: #e8f5e9; color:#0b7f47; }
#animalTable td:nth-child(2){ background: inherit; box-shadow: -1px 0 0 #cddc39 inset; }

     /* ===== Murabbik Buttons Override ===== */
.controls button,
.button,
.back-button {
  background-color: #0ea05a !important;
}

.controls button:hover,
.button:hover,
.back-button:hover {
  background-color: #0b7f47 !important;
}
 /* =========================
   Murabbik Standard Colors
   (Override Local Page Only)
   ========================= */
:root{
  --mbk-green: #0ea05a;
  --mbk-green-dark: #0b7f47;
  --mbk-cream: #fffde9;
  --mbk-soft: #f6fbf8;
  --mbk-th: #e8f5e9;
  --mbk-border: #cddc39;
}

/* Page base */
body{ background: var(--mbk-cream) !important; direction: rtl !important; }

/* Controls */
.controls button,
.button,
.back-button{
  background-color: var(--mbk-green) !important;
}
.controls button:hover,
.button:hover,
.back-button:hover{
  background-color: var(--mbk-green-dark) !important;
}

/* Table + headers */
.table-wrapper{ background:#fff !important; direction: rtl !important; }
#animalTable{ direction: rtl !important; }

th, td{ border-color: var(--mbk-border) !important; }
th{ background: var(--mbk-th) !important; color: var(--mbk-green-dark) !important; }

/* Sticky columns headers follow same th color */
#animalTable th:nth-child(1),
#animalTable th:nth-child(2){
  background: var(--mbk-th) !important;
  color: var(--mbk-green-dark) !important;
}

/* Row zebra */
tr:nth-child(even){ background-color: var(--mbk-soft) !important; }
   /* ===== Fix Murabbik page background (override forms.css) ===== */
html, body{
  background: #f6fbf8 !important;   /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ Ù…Ø±ÙŠØ­ (Ù…Ø´ Ø£ØµÙØ±) */
}

/* Ø®Ù„ÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨ÙŠØ¶Ø§ Ø²ÙŠ Ø¨Ø§Ù‚ÙŠ ØµÙØ­Ø§Øª Ù…Ø±Ø¨ÙŠÙƒ */
.table-wrapper{
  background: #ffffff !important;
}

  </style>
</head>
<body>
  <script type="module">
  import { protectPage, lockBackButton } from "/js/nav-guard.js";
  protectPage();
  lockBackButton();
</script>
<header class="mbk-top">
  <div class="mbk-head">
    <div class="mbk-title">
      <div class="mbk-page">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</div>
      <div class="mbk-app">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
    </div>
    <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
  </div>
</header>

  <div class="controls">
    <input type="text" id="searchNumber" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†">
    <select id="typeSelector" onchange="filterType(this.value)">
      <option value="">Ø¹Ø±Ø¶ Ø§Ù„Ù†ÙˆØ¹</option>
    </select>
    <select id="filterReproductive" onchange="filterReproductiveStatus(this.value)">
      <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©</option>
      <option value="Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©">Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</option>
      <option value="Ù…Ù„Ù‚Ø­Ø©">Ù…Ù„Ù‚Ø­Ø©</option>
      <option value="Ø¹Ø´Ø§Ø±">Ø¹Ø´Ø§Ø±</option>
      <option value="Ù…ÙØªÙˆØ­Ø©">Ù…ÙØªÙˆØ­Ø©</option>
      <option value="Ø¥Ø¬Ù‡Ø§Ø¶">Ø¥Ø¬Ù‡Ø§Ø¶</option>
    </select>
    <button onclick="resetFilter()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
  </div>

  <div class="table-wrapper">
    <table id="animalTable">
      <thead>
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</th>
          <th>Ø§Ù„Ù†ÙˆØ¹</th>
          <th>Ø§Ù„Ø³Ù„Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</th>
          <th>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©</th>
          <th>Ø£ÙŠØ§Ù… Ù…Ù„Ù‚Ø­Ø©</th>
          <th>Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ</th>
          <th>Ø¹Ù…Ø± Ø§Ù„Ø­Ù…Ù„</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th>
          <th>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©</th>
          <th>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
          <th>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø«</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="animalBody"></tbody>
    </table>
  </div>

  <div id="noData" class="no-data" style="display:none;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.</div>
  <a href="dashboard.html" class="back-button">ğŸ”™ Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…</a>

  <!-- Ø³ÙƒØ±Ø¨Øª ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± (Ù„Ùˆ Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯) -->
  <script src="js/mbk-animals.js?v=1"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (window.MBK?.animal?.enhanceAnimalList) {
        MBK.animal.enhanceAnimalList();
      }
    });
  </script>

  <!-- Ø³ÙƒØ±Ø¨Øª ÙØ§ÙŠØ±Ø³ØªÙˆØ± (ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ firebase-config.js) -->
 <script type="module">
  import { db, auth } from "/js/firebase-config.js";
  import { collection, query, where, getDocs, deleteDoc, doc }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const $  = id => document.getElementById(id);
  let animalsData = [];
   function updateStickyCols(){
  const th1 = document.querySelector("#animalTable thead th:nth-child(1)");
  if (!th1) return;
  document.documentElement.style.setProperty("--sticky-col1", th1.offsetWidth + "px");
}
window.addEventListener("resize", updateStickyCols);


  // Ø§Ù†ØªØ¸Ø± Ø¬Ù„Ø³Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø­Ù‚ÙŠÙ‚ÙŠØ©Ø› Ù…ÙÙŠØ´ Ù…Ø¬Ù‡ÙˆÙ„ Ù‡Ù†Ø§
  onAuthStateChanged(auth, async (u) => {
    if (!u) {
      location.href = "login.html?next=animal-list.html";
      return;
    }
    await loadAnimals(u.uid);
  });

  async function loadAnimals(uid) {
    const snap = await getDocs(
      query(collection(db, "animals"), where("ownerUid", "==", uid))
    );
    animalsData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    updateTypeOptions();
    renderTable(animalsData);
  }

  function updateTypeOptions() {
    const typeSelector = $("typeSelector");
    typeSelector.innerHTML = '<option value="">Ø¹Ø±Ø¶ Ø§Ù„Ù†ÙˆØ¹</option>';
    // Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù…Ø­ÙÙˆØ¸ ÙÙŠ animalTypeAr
    const types = [...new Set(animalsData.map(a => a.animalTypeAr).filter(Boolean))];
    types.forEach(type => {
      const opt = document.createElement("option");
      opt.value = type;
      opt.textContent = (type === "Ø¨Ù‚Ø±Ø©") ? "ğŸ„ Ø§Ù„Ø£Ø¨Ù‚Ø§Ø±" : "ğŸƒ Ø§Ù„Ø¬Ø§Ù…ÙˆØ³";
      typeSelector.appendChild(opt);
    });
  }

  function renderTable(data) {
    const tbody  = $("animalBody");
    const noData = $("noData");
    tbody.innerHTML = "";
    if (!data || data.length === 0) { noData.style.display = "block"; return; }
    noData.style.display = "none";

    data.forEach(animal => {
      const days = ms => Math.floor(ms / 86400000);

      const daysInMilk = animal.lastCalvingDate
        ? days(Date.now() - new Date(animal.lastCalvingDate))
        : (animal.daysInMilk ?? '---');

      const pregnantDays = (animal.reproductiveStatus === 'Ø¹Ø´Ø§Ø±' && animal.lastInseminationDate)
        ? days(Date.now() - new Date(animal.lastInseminationDate))
        : '---';

      const inseminatedDays = (animal.reproductiveStatus === 'Ù…Ù„Ù‚Ø­Ø©' && animal.lastInseminationDate)
        ? days(Date.now() - new Date(animal.lastInseminationDate))
        : '---';

      const tr = document.createElement("tr");
      const typeEn = animal.animaltype;         // cow / buffalo
      const typeAr = animal.animalTypeAr || ""; // Ø¨Ù‚Ø±Ø© / Ø¬Ø§Ù…ÙˆØ³Ø©

      tr.style.backgroundColor = (typeEn === "cow") ? "#fffde7" : "#eeeeee";
      tr.innerHTML = `
        <td>${animal.animalNumber ?? ""}</td>
        <td>${typeAr}</td>
        <td>${animal.breed ?? ""}</td>
        <td>${animal.productionStatus ?? "---"}</td>
        <td>${daysInMilk}</td>
        <td>${animal.reproductiveStatus ?? ""}</td>
        <td>${inseminatedDays}</td>
        <td>${animal.dailyMilk ?? "---"}</td>
        <td>${pregnantDays}</td>
        <td>${animal.birthDate || "---"}</td>
        <td>${animal.lastCalvingDate || "---"}</td>
        <td><button class="button" onclick="viewCard('${animal.animalNumber ?? ""}')">ğŸ“„</button></td>
        <td><button class="button" onclick="goToAddEvent('${animal.animalNumber ?? ""}')">ğŸ“‹</button></td>
        <td><button class="button delete-button" onclick="deleteAnimal('${animal.id}')">ğŸ—‘ï¸</button></td>
      `;
      tbody.appendChild(tr);
    });
    updateStickyCols();
  }

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ (global)
  window.viewCard = function(animalNumber){
    if(!animalNumber) return;
    location.href = `cow-card.html?number=${encodeURIComponent(animalNumber)}`;
  };

  window.goToAddEvent = function(animalNumber){
    if(!animalNumber) return;
    const today = new Date().toISOString().slice(0,10);
    localStorage.setItem("lastAnimalId", animalNumber);
    localStorage.setItem("lastEventDate", today);
    location.href =
      `add-event.html?animalId=${encodeURIComponent(animalNumber)}&number=${encodeURIComponent(animalNumber)}&animalNumber=${encodeURIComponent(animalNumber)}&eventDate=${encodeURIComponent(today)}&date=${encodeURIComponent(today)}`;
  };

  window.deleteAnimal = async function(animalDocId){
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŸ")) return;
    await deleteDoc(doc(db, "animals", animalDocId));
    animalsData = animalsData.filter(a => a.id !== animalDocId);
    renderTable(animalsData);
  };

  // ÙÙ„Ø§ØªØ± Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  $("searchNumber").addEventListener("input", function(){
    const q = this.value.trim();
    renderTable(animalsData.filter(a => String(a.animalNumber ?? "").includes(q)));
  });

  window.filterType = function(type){
    if(!type) return renderTable(animalsData);
    renderTable(animalsData.filter(a => (a.animalTypeAr || "") === type));
  };

  window.filterReproductiveStatus = function(status){
    if(!status) return renderTable(animalsData);
    renderTable(animalsData.filter(a => (a.reproductiveStatus || "") === status));
  };

  window.resetFilter = function(){
    $("searchNumber").value = "";
    $("filterReproductive").value = "";
    $("typeSelector").value = "";
    renderTable(animalsData);
  };
</script>
<script type="module" src="/js/smart-alerts.js"></script>

</body>
</html>









