<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مربي جديد؟</title>
  <style>
    :root{--bg1:#eeffdd;--bg2:#fffedc;--green:#2e7d32;--border:#c5e1a5;--card:#ffffff}
    *{box-sizing:border-box}
    body{
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(to bottom right, var(--bg1), var(--bg2));
      display:flex;align-items:center;justify-content:center;min-height:100vh;
      margin:0;padding:16px;color:#1b5e20;
    }
    .container{
      width:100%;max-width:460px;background:var(--card);
      border:1px solid var(--border);border-radius:14px;padding:24px;
      box-shadow:0 4px 20px rgba(0,0,0,.08);
    }
    h2{margin:0 0 16px;color:var(--green);text-align:center;font-weight:bold}
    label{display:block;font-weight:bold;margin:.35rem 0 .35rem}
    input,select,button{width:100%;font-size:16px;min-height:44px}
    input,select{border:1px solid #ccc;border-radius:10px;padding:10px}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:var(--green);margin-top:-4px;margin-bottom:8px}
    button{
      background:var(--green);color:#fff;border:0;border-radius:10px;
      padding:12px;font-weight:bold;cursor:pointer;transition:.2s ease background;
    }
    button:hover{background:#256a28}
    .message{display:none;padding:12px;border-radius:10px;font-weight:bold;text-align:center;margin-bottom:10px}
    .message.success{display:block;background:#d1e7dd;color:#0f5132}
    .message.error{display:block;background:#f8d7da;color:#842029}
    .muted{font-size:13px;opacity:.85}
    .link{margin-top:6px;text-align:center}
    .link a{color:var(--green);text-decoration:none;font-weight:bold}
  </style>
</head>
<body>
  <div class="container">
    <h2>تسجيل مستخدم جديد</h2>
    <div id="msg" class="message" role="status" aria-live="polite"></div>

    <form id="registerForm" novalidate>
      <label for="name">الاسم الكامل *</label>
      <input id="name" type="text" required />

      <label for="phone">رقم الهاتف *</label>
      <input id="phone" type="tel" required placeholder="مثال (مصر): 01012345678" />
      <div id="phoneHint" class="hint">* سنطبّق نمطًا مناسبًا حسب الدولة المختارة.</div>

      <div class="row-2">
        <div>
          <label for="country">الدولة *</label>
          <select id="country" required>
            <option value="">— اختر الدولة —</option>
            <option>مصر</option>
            <option>السعودية</option>
            <option>الإمارات</option>
            <option>الكويت</option>
            <option>قطر</option>
            <option>البحرين</option>
            <option>عُمان</option>
            <option>الأردن</option>
            <option>لبنان</option>
            <option>سوريا</option>
            <option>فلسطين</option>
            <option>العراق</option>
            <option>اليمن</option>
            <option>ليبيا</option>
            <option>تونس</option>
            <option>الجزائر</option>
            <option>المغرب</option>
            <option>موريتانيا</option>
            <option>السودان</option>
            <option>الصومال</option>
            <option>جيبوتي</option>
            <option>جزر القمر</option>
          </select>
        </div>
        <div>
          <label for="region">المنطقة/المحافظة *</label>
          <select id="region" required disabled>
            <option value="">— اختر الدولة أولاً —</option>
          </select>
        </div>
      </div>

      <label for="role">التسجيل كـ *</label>
      <select id="role" required>
        <option value="">— اختر الدور —</option>
        <option>مربي</option>
        <option>طبيب بيطري</option>
        <option>مهندس إنتاج</option>
        <option>صاحب مزرعة</option>
        <option>مدير مزرعة</option>
        <option>استشاري</option>
      </select>

      <label for="password">كلمة المرور *</label>
      <input id="password" type="password" required minlength="4" />

      <label for="confirmPassword">تأكيد كلمة المرور *</label>
      <input id="confirmPassword" type="password" required minlength="4" />

      <button id="submitBtn" type="submit">تسجيل</button>
    </form>

    <div class="link muted">لديك حساب؟ <a href="login.html">ادخل إلى حسابك</a></div>
  </div>

<script type="module">
  import { db, ensureAuth } from './js/firebase-config.js';
  import { doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // عناصر DOM
  const form = document.getElementById('registerForm');
  const msg  = document.getElementById('msg');
  const btn  = document.getElementById('submitBtn');
  const countrySel = document.getElementById('country');
  const regionSel  = document.getElementById('region');
  const phoneInp   = document.getElementById('phone');

  // المناطق
  const REGIONS = {
    "مصر": ["القاهرة","الجيزة","القليوبية","الشرقية","الدقهلية","البحيرة","الغربية","المنوفية","كفر الشيخ","دمياط","الإسكندرية","المنيا","أسيوط","سوهاج","قنا","الأقصر","أسوان","بني سويف","الفيوم","البحر الأحمر","الوادي الجديد","مطروح","شمال سيناء","جنوب سيناء"],
    "السعودية": ["الرياض","مكة المكرمة","المدينة المنورة","القصيم","الشرقية","عسير","تبوك","حائل","الحدود الشمالية","جازان","نجران","الباحة","الجوف"],
    "الإمارات": ["أبوظبي","دبي","الشارقة","عجمان","أم القيوين","رأس الخيمة","الفجيرة"],
    "الكويت": ["العاصمة","الأحمدي","حولي","الفروانية","الجهراء","مبارك الكبير"],
    "قطر": ["الدوحة","الريان","الوكرة","الخور والذخيرة","الشمال","أم صلال","الظعاين","الشحانية"],
    "البحرين": ["العاصمة","المحرق","الشمالية","الجنوبية"],
    "عُمان": ["مسقط","ظفار","شمال الباطنة","جنوب الباطنة","الداخلية","شمال الشرقية","جنوب الشرقية","الظاهرة","الوسطى","مسندم"],
    "الأردن": ["عمّان","الزرقاء","إربد","البلقاء","المفرق","الكرك","معان","الطفيلة","العقبة","مأدبا","جرش","عجلون"],
    "لبنان": ["بيروت","جبل لبنان","الشمال","البقاع","النبطية","الجنوب","بعلبك-الهرمل","عكار"],
    "سوريا": ["دمشق","ريف دمشق","حلب","حمص","حماة","اللاذقية","طرطوس","إدلب","دير الزور","الرقة","الحسكة","درعا","السويداء","القنيطرة"],
    "فلسطين": ["القدس","رام الله والبيرة","الخليل","بيت لحم","نابلس","طولكرم","قلقيلية","جنين","أريحا والأغوار","سلفيت","غزة","خانيونس","رفح","الشمال","الوسطى"],
    "العراق": ["بغداد","نينوى","البصرة","أربيل","النجف","كربلاء","ذي قار","ديالى","صلاح الدين","كركوك","السليمانية","القادسية","بابل","الأنبار","واسط","المثنى","ميسان","دهوك"],
    "اليمن": ["صنعاء","عدن","تعز","الحديدة","إب","حضرموت","شبوة","مأرب","صعدة","البيضاء","ذمار","المحويت","ريمة","حجة","لحج","أبين","الضالع","المهرة"],
    "ليبيا": ["طرابلس","بنغازي","مصراتة","سبها","درنة","البيضاء","الزاوية","غريان","اجدابيا","الكفرة","الجفرة","مرزق","الواحات","طبرق"],
    "تونس": ["تونس","أريانة","بن عروس","منوبة","نابل","زغوان","بنزرت","باجة","جندوبة","الكاف","سليانة","القيروان","سوسة","المنستير","المهدية","صفاقس","القصرين","قفصة","توزر","قبلي","مدنين","تطاوين"],
    "الجزائر": ["الجزائر","وهران","قسنطينة","سطيف","البليدة","سيدي بلعباس","باتنة","عنابة","جيجل","بجاية","تلمسان","الأغواط","بسكرة","غرداية","ورقلة","تيزي وزو","تيبازة","البويرة"],
    "المغرب": ["الرباط-سلا-القنيطرة","الدار البيضاء-سطات","مراكش-آسفي","فاس-مكناس","طنجة-تطوان-الحسيمة","الشرق","بني ملال-خنيفرة","درعة-تافيلالت","سوس-ماسة","العيون-الساقية الحمراء","كلميم-واد نون","الداخلة-وادي الذهب"],
    "موريتانيا": ["نواكشوط","الحوض الشرقي","الحوض الغربي","لعصابة","كوركول","البراكنة","اترارزة","تكانت","كيدي ماغا","تيرس زمور","داخلت نواذيبو","آدرار"],
    "السودان": ["الخرطوم","الجزيرة","القضارف","سنار","كسلا","البحر الأحمر","نهر النيل","الشمالية","شمال كردفان","جنوب كردفان","شمال دارفور","جنوب دارفور","غرب دارفور","وسط دارفور","شرق دارفور","النيل الأزرق"],
    "الصومال": ["بنادر","بونتلاند","جوبالاند","جنوب غرب","هيرشبيلي","غلمدغ","أرض الصومال"],
    "جيبوتي": ["مدينة جيبوتي","علي صبيح","تاجورة","أوبوك","دهر","أرتا"],
    "جزر القمر": ["نجازيدجا (القمر الكبرى)","أنجوان","موهيلي"]
  };

  function fillRegions(country){
    regionSel.innerHTML=''; regionSel.disabled=true;
    const list = REGIONS[country];
    const def = document.createElement('option');
    def.value=''; def.textContent = list ? '— اختر المنطقة/المحافظة —' : '— غير متاح —';
    regionSel.appendChild(def);
    if (list){ list.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; regionSel.appendChild(o); }); regionSel.disabled=false; }
  }
  function setPhonePlaceholder(country){
    const map = {'مصر':'01012345678','السعودية':'05xxxxxxxx','الإمارات':'05xxxxxxxx','الكويت':'5xxxxxxxx','قطر':'3xxxxxxxx','البحرين':'3xxxxxxx','عُمان':'9xxxxxxxx','الأردن':'07xxxxxxxx','لبنان':'03xxxxxx','سوريا':'09xxxxxxxx','فلسطين':'059xxxxxxx','العراق':'07xxxxxxxx','اليمن':'7xxxxxxxx','ليبيا':'09xxxxxxxx','تونس':'2xxxxxxxx / 9xxxxxxxx','الجزائر':'05xxxxxxxx','المغرب':'06xxxxxxxx','موريتانيا':'22xxxxxxx','السودان':'09xxxxxxxx','الصومال':'+252xxxxxxxx','جيبوتي':'+253xxxxxxxx','جزر القمر':'+269xxxxxxx'};
    phoneInp.placeholder = `مثال (${country||'دولة'}): ${map[country]||'+9715xxxxxxx'}`;
  }
  countrySel.addEventListener('change', ()=>{ fillRegions(countrySel.value); setPhonePlaceholder(countrySel.value); });

  function showMessage(text,type='error'){ msg.textContent=text; msg.className=`message ${type}`; msg.style.display='block'; }
  function clearMessage(){ msg.textContent=''; msg.style.display='none'; }

  async function hashPassword(password){
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(password));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  function validatePhoneByCountry(phone,country){
    const p = phone.replace(/\s|-/g,'');
    if (country==='مصر') return /^01\d{9}$/.test(p);
    return /^\+?\d{7,15}$/.test(p);
  }

  // الحفظ (محاولة مباشرة، ولو فشلت بالصلاحيات نجرب ensureAuth ثم نعيد)
form.addEventListener('submit', async (e)=>{
  e.preventDefault(); clearMessage(); btn.disabled = true;

  const fullName = document.getElementById('name').value.trim();
  const phoneRaw = phoneInp.value.trim();
  const country  = countrySel.value.trim();
  const region   = regionSel.value.trim();
  const role     = document.getElementById('role').value.trim();
  const password = document.getElementById('password').value;
  const confirm  = document.getElementById('confirmPassword').value;

  if (!fullName || !phoneRaw || !country || !region || !role || !password || !confirm){
    showMessage('جميع الحقول مطلوبة'); btn.disabled=false; return;
  }
  if (!validatePhoneByCountry(phoneRaw, country)){
    showMessage('رقم الهاتف غير مطابق لتنسيق الدولة المختارة'); btn.disabled=false; return;
  }
  if (password.length < 4){ showMessage('كلمة المرور يجب أن تكون ٤ أحرف أو أكثر'); btn.disabled=false; return; }
  if (password !== confirm){ showMessage('كلمة المرور وتأكيدها غير متطابقة'); btn.disabled=false; return; }

  // نزّل الهاتف لصيغة موحّدة: أرقام فقط (Key للفهرس)
  const normalizePhone = s => (s||'').replace(/[^\d]/g,'');
  const phone = normalizePhone(phoneRaw);

  // لازم uid (Anonymous)
  const authUser = await ensureAuth();
  const uid = authUser?.uid;
  if (!uid){ showMessage('تعذّر إنشاء جلسة. أعد المحاولة.'); btn.disabled=false; return; }

  // 1) أنشئ فهرس الهاتف أولاً (لو موجود هيرفض تلقائيًا بالرولز)
  try{
    await setDoc(doc(db,'users_phone', phone), { uid, createdAt: serverTimestamp() });
  }catch(err){
    // لو كان موجود بالفعل → رقم مكرر
    showMessage('رقم الهاتف مسجّل بالفعل'); btn.disabled=false; return;
  }

  // 2) احفظ ملف المستخدم users/{uid}
  const payload = {
    fullName, phone: phoneRaw, country, region, role,
    passwordHash: await hashPassword(password),
    createdAt: serverTimestamp()
  };

  try{
    await setDoc(doc(db,'users', uid), payload, { merge: true });
  }catch(err){
    // تراجع آمن: امسح الفهرس لو كتابة المستخدم فشلت (اختياري)
    // await deleteDoc(doc(db,'users_phone', phone));
    showMessage('حدث خطأ أثناء التسجيل، حاول مرة أخرى'); btn.disabled=false; return;
  }

  localStorage.setItem('userId', uid);
  showMessage('✅ تم التسجيل بنجاح، سيتم توجيهك لصفحة الدخول...', 'success');
  setTimeout(()=> location.href='login.html', 1200);
});

</script>


</body>
</html>

  
  










