<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <title>مربي جديد؟</title>
  <style>
    :root{--bg1:#eeffdd;--bg2:#fffedc;--green:#2e7d32;--border:#c5e1a5;--card:#ffffff}
    *{box-sizing:border-box}
   body{
  font-family:'Cairo',sans-serif;
  background:#f7faf7;
  margin:0;
  padding:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
}
      display:flex;align-items:center;justify-content:center;min-height:100vh;
      margin:0;padding:16px;color:#1b5e20;
    }
  
    .container{
      width:100%;max-width:460px;background:var(--card);
      border:1px solid var(--border);border-radius:14px;padding:24px;
      box-shadow:0 4px 20px rgba(0,0,0,.08);
    }
    h2{margin:0 0 16px;color:var(--green);text-align:center;font-weight:bold}
    label{display:block;font-weight:bold;margin:.35rem 0 .35rem}
    input,select,button{width:100%;font-size:16px;min-height:44px}
    input,select{border:1px solid #ccc;border-radius:10px;padding:10px}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:var(--green);margin-top:-4px;margin-bottom:8px}
    button{
      background:var(--green);color:#fff;border:0;border-radius:10px;
      padding:12px;font-weight:bold;cursor:pointer;transition:.2s ease background;
    }
    button:hover{background:#256a28}
    .message{display:none;padding:12px;border-radius:10px;font-weight:bold;text-align:center;margin-bottom:10px}
    .message.success{display:block;background:#d1e7dd;color:#0f5132}
    .message.error{display:block;background:#f8d7da;color:#842029}
    .muted{font-size:13px;opacity:.85}
    .link{margin-top:6px;text-align:center}
    .link a{color:var(--green);text-decoration:none;font-weight:bold}
    .mbk-head{
  width:100%;
  background:linear-gradient(135deg,#0ea05a,#0b7f47);
  padding:18px 16px;
  border-radius:16px;
  margin-bottom:18px;
  color:#fff;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
}
.mbk-brand{
  display:flex;
  align-items:center;
  gap:12px;
}
.mbk-logo{
  width:48px;
  height:48px;
}
.mbk-title{
  font-size:22px;
  font-weight:bold;
}
.mbk-sub{
  font-size:14px;
  opacity:.9;
}
.hero-text{
  text-align:center;
  font-size:15px;
  margin-bottom:18px;
  line-height:1.6;
  font-weight:bold;
}
/* ===== مُرَبِّيك: شاشة ترحيب انتقالية بعد التسجيل ===== */
.welcome-overlay{
  position:fixed; inset:0;
  background:linear-gradient(135deg,#0ea05a,#0b7f47);
  display:none;
  align-items:center; justify-content:center;
  padding:24px;
  z-index:9999;
  color:#fff;
  text-align:center;
}
.welcome-card{
  width:100%;
  max-width:520px;
  background:rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.22);
  border-radius:18px;
  padding:22px 18px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  backdrop-filter: blur(6px);
}
.welcome-title{
  font-size:22px;
  font-weight:800;
  margin:0 0 10px;
}
.welcome-body{
  font-size:15px;
  line-height:1.8;
  font-weight:700;
  opacity:.96;
  margin:0;
  white-space:pre-line;
}
.welcome-foot{
  margin-top:14px;
  font-size:13px;
  opacity:.9;
  font-weight:700;
}
.reg-header{
  width:100%;
  max-width:460px;
  margin-bottom:18px;
}

.reg-brand{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:linear-gradient(135deg,#0ea05a,#0b7f47);
  padding:16px 18px;
  border-radius:18px;
  color:#fff;
  box-shadow:0 8px 22px rgba(0,0,0,.12);
}

.reg-title{
  font-size:20px;
  font-weight:800;
}

.reg-sub{
  font-size:16px;
  font-weight:900;
  opacity:.9;
}

.reg-brand img{
  width:48px;
  height:48px;
  object-fit:contain;
}

  </style>
</head>
<body>
  <!-- ✅ مُرَبِّيك: شاشة ترحيب انتقالية -->
<div id="welcomeOverlay" class="welcome-overlay" role="status" aria-live="polite" aria-hidden="true">
  <div class="welcome-card">
    <div id="welcomeTitle" class="welcome-title">مرحبًا بك</div>
    <p id="welcomeBody" class="welcome-body"></p>
    <div class="welcome-foot">جارٍ تجهيز لوحة مزرعتك…</div>
  </div>
</div>
<header class="reg-header">
  <div class="reg-brand">
    <div class="reg-text">
      <div class="reg-title">تسجيل</div>
      <div class="reg-sub">مُرَبِّيك</div>
    </div>
    <img src="/images/logo.png" alt="مُرَبِّيك">
  </div>
</header>

  <div class="container">
    <p class="hero-text">
أنت لا تسجل في تطبيق…  
أنت تدخل غرفة التحكم في مزرعتك.
</p>

    <div id="msg" class="message" role="status" aria-live="polite"></div>

    <form id="registerForm" novalidate>
      <label for="name">الاسم الكامل *</label>
      <input id="name" type="text" required />

      <label for="phone">رقم الهاتف *</label>
      <input id="phone" type="tel" required placeholder="مثال (مصر): 01012345678" />
      <div id="phoneHint" class="hint">* سنطبّق نمطًا مناسبًا حسب الدولة المختارة.</div>

      <div class="row-2">
        <div>
          <label for="country">الدولة *</label>
          <select id="country" required>
            <option value="">— اختر الدولة —</option>
            <option>مصر</option>
            <option>السعودية</option>
            <option>الإمارات</option>
            <option>الكويت</option>
            <option>قطر</option>
            <option>البحرين</option>
            <option>عُمان</option>
            <option>الأردن</option>
            <option>لبنان</option>
            <option>سوريا</option>
            <option>فلسطين</option>
            <option>العراق</option>
            <option>اليمن</option>
            <option>ليبيا</option>
            <option>تونس</option>
            <option>الجزائر</option>
            <option>المغرب</option>
            <option>موريتانيا</option>
            <option>السودان</option>
            <option>الصومال</option>
            <option>جيبوتي</option>
            <option>جزر القمر</option>
          </select>
        </div>
        <div>
          <label for="region">المنطقة/المحافظة *</label>
          <select id="region" required disabled>
            <option value="">— اختر الدولة أولاً —</option>
          </select>
        </div>
      </div>

      <label for="role">التسجيل كـ *</label>
      <select id="role" required>
        <option value="">— اختر الدور —</option>
        <option>مربي</option>
        <option>طبيب بيطري</option>
        <option>مهندس إنتاج</option>
        <option>صاحب مزرعة</option>
        <option>مدير مزرعة</option>
        <option>استشاري</option>
      </select>

      <label for="password">كلمة المرور *</label>
      <input id="password" type="password" required minlength="4" />

      <label for="confirmPassword">تأكيد كلمة المرور *</label>
      <input id="confirmPassword" type="password" required minlength="4" />

      <button id="submitBtn" type="submit">تسجيل</button>
    </form>

    <div class="link muted">لديك حساب؟ <a href="login.html">ادخل إلى حسابك</a></div>
  </div>

<script type="module">
  import { db, ensureAuth } from './js/firebase-config.js';
  import { doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getAuth, createUserWithEmailAndPassword }
    from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

  // عناصر DOM
  const form = document.getElementById('registerForm');
  const msg  = document.getElementById('msg');
  const btn  = document.getElementById('submitBtn');
  const countrySel = document.getElementById('country');
  const regionSel  = document.getElementById('region');
  const phoneInp   = document.getElementById('phone');

  // المناطق
  const REGIONS = {
    "مصر": ["القاهرة","الجيزة","القليوبية","الشرقية","الدقهلية","البحيرة","الغربية","المنوفية","كفر الشيخ","دمياط","الإسكندرية","المنيا","أسيوط","سوهاج","قنا","الأقصر","أسوان","بني سويف","الفيوم","البحر الأحمر","الوادي الجديد","مطروح","شمال سيناء","جنوب سيناء"],
    "السعودية": ["الرياض","مكة المكرمة","المدينة المنورة","القصيم","الشرقية","عسير","تبوك","حائل","الحدود الشمالية","جازان","نجران","الباحة","الجوف"],
    "الإمارات": ["أبوظبي","دبي","الشارقة","عجمان","أم القيوين","رأس الخيمة","الفجيرة"],
    "الكويت": ["العاصمة","الأحمدي","حولي","الفروانية","الجهراء","مبارك الكبير"],
    "قطر": ["الدوحة","الريان","الوكرة","الخور والذخيرة","الشمال","أم صلال","الظعاين","الشحانية"],
    "البحرين": ["العاصمة","المحرق","الشمالية","الجنوبية"],
    "عُمان": ["مسقط","ظفار","شمال الباطنة","جنوب الباطنة","الداخلية","شمال الشرقية","جنوب الشرقية","الظاهرة","الوسطى","مسندم"],
    "الأردن": ["عمّان","الزرقاء","إربد","البلقاء","المفرق","الكرك","معان","الطفيلة","العقبة","مأدبا","جرش","عجلون"],
    "لبنان": ["بيروت","جبل لبنان","الشمال","البقاع","النبطية","الجنوب","بعلبك-الهرمل","عكار"],
    "سوريا": ["دمشق","ريف دمشق","حلب","حمص","حماة","اللاذقية","طرطوس","إدلب","دير الزور","الرقة","الحسكة","درعا","السويداء","القنيطرة"],
    "فلسطين": ["القدس","رام الله والبيرة","الخليل","بيت لحم","نابلس","طولكرم","قلقيلية","جنين","أريحا والأغوار","سلفيت","غزة","خانيونس","رفح","الشمال","الوسطى"],
    "العراق": ["بغداد","نينوى","البصرة","أربيل","النجف","كربلاء","ذي قار","ديالى","صلاح الدين","كركوك","السليمانية","القادسية","بابل","الأنبار","واسط","المثنى","ميسان","دهوك"],
    "اليمن": ["صنعاء","عدن","تعز","الحديدة","إب","حضرموت","شبوة","مأرب","صعدة","البيضاء","ذمار","المحويت","ريمة","حجة","لحج","أبين","الضالع","المهرة"],
    "ليبيا": ["طرابلس","بنغازي","مصراتة","سبها","درنة","البيضاء","الزاوية","غريان","اجدابيا","الكفرة","الجفرة","مرزق","الواحات","طبرق"],
    "تونس": ["تونس","أريانة","بن عروس","منوبة","نابل","زغوان","بنزرت","باجة","جندوبة","الكاف","سليانة","القيروان","سوسة","المنستير","المهدية","صفاقس","القصرين","قفصة","توزر","قبلي","مدنين","تطاوين"],
    "الجزائر": ["الجزائر","وهران","قسنطينة","سطيف","البليدة","سيدي بلعباس","باتنة","عنابة","جيجل","بجاية","تلمسان","الأغواط","بسكرة","غرداية","ورقلة","تيزي وزو","تيبازة","البويرة"],
    "المغرب": ["الرباط-سلا-القنيطرة","الدار البيضاء-سطات","مراكش-آسفي","فاس-مكناس","طنجة-تطوان-الحسيمة","الشرق","بني ملال-خنيفرة","درعة-تافيلالت","سوس-ماسة","العيون-الساقية الحمراء","كلميم-واد نون","الداخلة-وادي الذهب"],
    "موريتانيا": ["نواكشوط","الحوض الشرقي","الحوض الغربي","لعصابة","كوركول","البراكنة","اترارزة","تكانت","كيدي ماغا","تيرس زمور","داخلت نواذيبو","آدرار"],
    "السودان": ["الخرطوم","الجزيرة","القضارف","سنار","كسلا","البحر الأحمر","نهر النيل","الشمالية","شمال كردفان","جنوب كردفان","شمال دارفور","جنوب دارفور","غرب دارفور","وسط دارفور","شرق دارفور","النيل الأزرق"],
    "الصومال": ["بنادر","بونتلاند","جوبالاند","جنوب غرب","هيرشبيلي","غلمدغ","أرض الصومال"],
    "جيبوتي": ["مدينة جيبوتي","علي صبيح","تاجورة","أوبوك","دهر","أرتا"],
    "جزر القمر": ["نجازيدجا (القمر الكبرى)","أنجوان","موهيلي"]
  };

  function fillRegions(country){
    regionSel.innerHTML=''; regionSel.disabled=true;
    const list = REGIONS[country];
    const def = document.createElement('option');
    def.value=''; def.textContent = list ? '— اختر المنطقة/المحافظة —' : '— غير متاح —';
    regionSel.appendChild(def);
    if (list){ list.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; regionSel.appendChild(o); }); regionSel.disabled=false; }
  }
  function setPhonePlaceholder(country){
    const map = {'مصر':'01012345678','السعودية':'05xxxxxxxx','الإمارات':'05xxxxxxxx','الكويت':'5xxxxxxxx','قطر':'3xxxxxxxx','البحرين':'3xxxxxxx','عُمان':'9xxxxxxxx','الأردن':'07xxxxxxxx','لبنان':'03xxxxxx','سوريا':'09xxxxxxxx','فلسطين':'059xxxxxxx','العراق':'07xxxxxxxx','اليمن':'7xxxxxxxx','ليبيا':'09xxxxxxxx','تونس':'2xxxxxxxx / 9xxxxxxxx','الجزائر':'05xxxxxxxx','المغرب':'06xxxxxxxx','موريتانيا':'22xxxxxxx','السودان':'09xxxxxxxx','الصومال':'+252xxxxxxxx','جيبوتي':'+253xxxxxxxx','جزر القمر':'+269xxxxxxx'};
    phoneInp.placeholder = `مثال (${country||'دولة'}): ${map[country]||'+9715xxxxxxx'}`;
  }
  countrySel.addEventListener('change', ()=>{ fillRegions(countrySel.value); setPhonePlaceholder(countrySel.value); });

  function showMessage(text,type='error'){ msg.textContent=text; msg.className=`message ${type}`; msg.style.display='block'; }
  function clearMessage(){ msg.textContent=''; msg.style.display='none'; }
  function showWelcomeOverlay(fullName, role){
  const ov = document.getElementById('welcomeOverlay');
  const title = document.getElementById('welcomeTitle');
  const body  = document.getElementById('welcomeBody');
  if (!ov || !title || !body) return;

  const roleTitle =
    role === 'طبيب بيطري' ? 'طبيب القطيع الذكي' :
    role === 'مهندس إنتاج' ? 'مهندس الإنتاج الذكي' :
    role === 'مدير مزرعة' ? 'مدير المزرعة الذكي' :
    role === 'صاحب مزرعة' ? 'قائد المزرعة' :
    role === 'استشاري' ? 'مستشار الأداء' :
    'مربي القطيع';

  title.textContent = `مرحبًا بك يا ${fullName}`;
  body.textContent =
`✅ ${roleTitle}… مُرَبِّيك الآن في صفّك.

من هذه اللحظة:
• قرارات التلقيح في وقتها
• تنبيهات الولادة قبل الموعد
• تقارير اللبن واضحة… للأبقار والجاموس

مزرعتك أصبحت تحت السيطرة.`;

  ov.style.display = 'flex';
  ov.setAttribute('aria-hidden','false');
}
  async function hashPassword(password){
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(password));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  function validatePhoneByCountry(phone,country){
    const p = phone.replace(/\s|-/g,'');
    if (country==='مصر') return /^01\d{9}$/.test(p);
    return /^\+?\d{7,15}$/.test(p);
  }

  // الحفظ (محاولة مباشرة، ولو فشلت بالصلاحيات نجرب ensureAuth ثم نعيد)
form.addEventListener('submit', async (e)=>{
  e.preventDefault(); clearMessage(); btn.disabled = true;

  const fullName = document.getElementById('name').value.trim();
  const phoneRaw = phoneInp.value.trim();
  const country  = countrySel.value.trim();
  const region   = regionSel.value.trim();
  const role     = document.getElementById('role').value.trim();
  const password = document.getElementById('password').value;
  const confirm  = document.getElementById('confirmPassword').value;

  if (!fullName || !phoneRaw || !country || !region || !role || !password || !confirm){
    showMessage('جميع الحقول مطلوبة'); btn.disabled=false; return;
  }
  if (!validatePhoneByCountry(phoneRaw, country)){
    showMessage('رقم الهاتف غير مطابق لتنسيق الدولة المختارة'); btn.disabled=false; return;
  }
  if (password.length < 4){ showMessage('كلمة المرور يجب أن تكون ٤ أحرف أو أكثر'); btn.disabled=false; return; }
  if (password !== confirm){ showMessage('كلمة المرور وتأكيدها غير متطابقة'); btn.disabled=false; return; }

  // تحويل الأرقام العربية وإبقاء الأرقام فقط لبناء بريد داخلي
  const phoneKey = (phoneRaw||'')
    .replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d))
    .replace(/\D/g,'');
  if (!phoneKey){ showMessage('رقم هاتف غير صالح'); btn.disabled=false; return; }

  const auth = getAuth();
  const pseudoEmail = `${phoneKey}@murabbik.local`; // بريد داخلي مشتق من الهاتف

  try{
    // إنشاء الحساب وتوليد uid آمن
    const cred = await createUserWithEmailAndPassword(auth, pseudoEmail, password);
    const uid  = cred.user.uid;

    // حجز المستند users/{uid}
    const userRef = doc(db,'users', uid);
    if ((await getDoc(userRef)).exists()){
      showMessage('حدث تعارض في التسجيل، حاول برقم مختلف'); btn.disabled=false; return;
    }

    await setDoc(userRef, {
      fullName, phone: phoneRaw, country, region, role,
      createdAt: serverTimestamp()
    });

    localStorage.setItem('userId', uid);
    localStorage.setItem('phone', phoneRaw);
    localStorage.setItem('country', country);
    localStorage.setItem('region', region);

   showWelcomeOverlay(fullName, role);
setTimeout(()=> location.href='login.html', 1800);

  }catch(err){
    showMessage('تعذّر التسجيل، تأكّد من البيانات وحاول مرة أخرى');
  }finally{
    btn.disabled=false;
  }
});

</script>


</body>
</html>

  
  















