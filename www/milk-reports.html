<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تقرير اللبن — مُرَبِّك</title>
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <style>
    :root{
      --green:#0ea05a; --green-600:#0b7f47; --bg:#f6faf7; --text:#0f172a;
      --muted:#64748b; --card:#fff; --border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Cairo',system-ui,Segoe UI,Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
    .bar{max-width:960px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title{font-weight:800;color:var(--green-600)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;font-weight:700;cursor:pointer}
    .chip.primary{background:var(--green);color:#fff;border-color:var(--green)}
    main{max-width:960px;margin:14px auto;padding:10px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){ .row{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:920px){ .row{grid-template-columns:repeat(3,1fr)} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi h3{margin:0;font-size:14px}
    .kpi .num{font-weight:900;font-size:22px}
    .kpi small{color:var(--muted)}
    .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:15px}
    .notice{margin:10px 0;padding:10px;border-radius:10px;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;font-weight:700;display:none}
    .ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    canvas{width:100%;height:320px;max-height:50vh}

    /* الهنت الخارجي للنقاط */
    .hint{
      position:absolute; inset:auto auto 0 0; /* سنتبدّلها برمجياً */
      z-index:20; min-width:220px; max-width:90vw;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:#ffffff; box-shadow:0 8px 24px rgba(2,6,23,.15);
      font-size:14px; line-height:1.5; color:var(--text);
    }
    .hint .row{display:flex;gap:6px}
    .hint .k{color:#64748b;min-width:96px}
    .hint .actions{margin-top:8px;display:flex;gap:6px}
    .btn{appearance:none;border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:#f8fafc;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--green);border-color:var(--green);color:#fff}
    .btn.icon{padding:6px 8px}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">📊 تقرير اللبن</div>
    <div class="actions">
      <a class="chip" href="daily-milk.html">إدخال يومي</a>
      <a class="chip" href="add-event.html">الأحداث</a>
      <button id="btnRefresh" class="chip primary">تحديث</button>
    </div>
  </div>
</header>

<main>
  <div class="card inline" style="justify-content:space-between">
    <div class="inline">
      <label for="reportDate" style="font-weight:700">تاريخ العرض:</label>
      <input id="reportDate" type="date">
    </div>
    <div id="lastUpdate" class="inline" style="color:var(--muted);font-size:13px"></div>
  </div>

  <div id="msg" class="notice"></div>

  <div class="row" id="kpis">
    <div class="card kpi">
      <h3>إجمالي اليوم</h3>
      <div class="num" id="sumDay">— كجم</div>
      <small id="sumDayBreak">أبقار: — • جاموس: —</small>
    </div>
    <div class="card kpi">
      <h3>إجمالي الشهر</h3>
      <div class="num" id="sumMonth">— كجم</div>
      <small id="sumMonthBreak">أبقار: — • جاموس: —</small>
    </div>
    <div class="card kpi">
      <h3>إجمالي السنة</h3>
      <div class="num" id="sumYear">— كجم</div>
      <small id="sumYearBreak">أبقار: — • جاموس: —</small>
    </div>
    <div class="card kpi">
      <h3>متوسط القطيع اليومي</h3>
      <div class="num" id="avgHerd">— كجم/رأس</div>
      <small id="milkersCount">عدد الحلّاب: — / إجمالي: —</small>
    </div>
    <div class="card kpi">
      <h3>متوسط تكلفة كجم اللبن (تغذية)</h3>
      <div class="num" id="feedCostPerKg">— ج.م/كجم</div>
      <small id="feedNote">يتطلب حدث تغذية لليوم</small>
    </div>
  </div>

  <div class="card" id="scatterWrap" style="position:relative">
    <h3 style="margin:0 0 8px 0">خريطة الأفراد (Scatter): <span>أيام الحليب (من آخر ولادة)</span> × <span>كجم/اليوم</span></h3>
    <canvas id="scatter"></canvas>
    <small id="skipNote" style="color:#64748b"></small>

    <!-- الهنت الخارجي -->
    <div id="pointHint" class="hint" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong>بيانات الحيوان</strong>
        <button class="btn icon" id="btnCloseHint" aria-label="إغلاق">✕</button>
      </div>
      <div class="row"><div class="k">رقم:</div><div class="v" id="hNo">—</div></div>
      <div class="row"><div class="k">كجم اليوم:</div><div class="v" id="hKg">—</div></div>
      <div class="row"><div class="k">أيام الحليب:</div><div class="v" id="hDim">—</div></div>
      <div class="row"><div class="k">حالة تناسلية:</div><div class="v" id="hRepro">—</div></div>
      <div class="row"><div class="k">الموسم:</div><div class="v" id="hSeason">—</div></div>
      <div class="row"><div class="k">المجموعة:</div><div class="v" id="hGroup">—</div></div>
      <div class="actions">
        <button class="btn primary" id="btnOpenCard">فتح البطاقة</button>
      </div>
    </div>
  </div>
</main>

<script type="module" src="/js/firebase-config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script type="module">
  import { db, auth } from '/js/firebase-config.js';
  import {
    collection, query, where, orderBy, limit, getDocs, startAt, endBefore
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

  // ---------- Helpers ----------
  const $ = id => document.getElementById(id);
  const DIGITS={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
  const TYPES = ['لبن يومي','milk','daily_milk'];
  const CALVING_TYPES = ['ولادة','calving','Calving','birth','Birth','ولاده','ولادة طبيعية'];

  function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
  const ymd = d => /^\d{4}-\d{2}-\d{2}$/.test(d) ? d : todayISO();
  function daysBetweenISO(a,b){ const A=new Date(a), B=new Date(b); A.setHours(0,0,0,0); B.setHours(0,0,0,0); return Math.round((B-A)/86400000); }
  function monthBounds(dISO){ const d=new Date(dISO); d.setDate(1); const start = new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); const n=new Date(d); n.setMonth(n.getMonth()+1); n.setDate(1); const end=new Date(n.getTime()-n.getTimezoneOffset()*60000).toISOString().slice(0,10); return {start,end}; }
  function yearBounds(dISO){ const y=dISO.slice(0,4); return {start:`${y}-01-01`, end:`${+y+1}-01-01`}; }
  const normKind = v => /buffalo|جاموس/i.test(v)? 'جاموس':'أبقار';
  function show(msg, ok=false){ const el=$('msg'); el.style.display='block'; el.className='notice ' + (ok?'ok':''); el.textContent=msg; }
  function hideMsg(){ $('msg').style.display='none'; }

  async function getUid(){
    if (auth.currentUser) return auth.currentUser.uid;
    const u = await new Promise(res=>onAuthStateChanged(auth, x=>res(x)));
    return u?.uid || '';
  }

  // ---------- Flexible queries ----------
  async function qLatestDate(uid){
    for (const withUser of [true,false]){
      for (const t of TYPES){
        const q1 = withUser && uid
          ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==',t), orderBy('eventDate','desc'), limit(1))
          : query(collection(db,'events'), where('eventType','==',t), orderBy('eventDate','desc'), limit(1));
        const s = await getDocs(q1);
        if (!s.empty) return s.docs[0].data().eventDate;
      }
    }
    return null;
  }

  async function qByDate(uid, dateISO){
    for (const withUser of [true,false]){
      let bag=[];
      for (const t of TYPES){
        const q1 = withUser && uid
          ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==',t), where('eventDate','==',dateISO), limit(500))
          : query(collection(db,'events'), where('eventType','==',t), where('eventDate','==',dateISO), limit(500));
        const s = await getDocs(q1);
        s.forEach(d=>bag.push(d.data()));
      }
      if (bag.length) return bag;
    }
    return [];
  }

  async function qByRange(uid, startISO, endISO){
    for (const withUser of [true,false]){
      let bag=[];
      for (const t of TYPES){
        const q1 = withUser && uid
          ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==',t), orderBy('eventDate'), startAt(startISO), endBefore(endISO))
          : query(collection(db,'events'), where('eventType','==',t), orderBy('eventDate'), startAt(startISO), endBefore(endISO));
        const s = await getDocs(q1);
        s.forEach(d=>bag.push(d.data()));
      }
      if (bag.length) return bag;
    }
    return [];
  }

  // --- fetch animal doc by number (fallback DIM) ---
  async function fetchAnimalDocByNumber(number){
    const raw = String(number||'').trim().replace(/[٠-٩۰-۹]/g,d=>DIGITS[d]).replace(/[^\d]/g,'');
    const asStr = raw, asNum = raw ? Number(raw) : NaN;
    const tries = [
      ['animalNumber','==',asStr], ['animalNumber','==',asNum],
      ['number','==',asStr],       ['number','==',asNum],
      ['animalNo','==',asStr],     ['animalNo','==',asNum],
    ].filter(t => !(typeof t[2]==='number' && Number.isNaN(t[2])));
    for (const [f,op,val] of tries){
      const s = await getDocs(query(collection(db,'animals'), where(f,op,val), limit(1)));
      if (!s.empty){ const d=s.docs[0]; return { id:d.id, data:d.data()||{} }; }
    }
    return null;
  }
  function toISOAny(v){
    if (!v) return null;
    if (typeof v==='string'){
      const m = v.match(/^(\d{4}-\d{2}-\d{2})/); if (m) return m[1];
      const d = new Date(v); if (!isNaN(d)) return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      return null;
    }
    if (typeof v==='number'){ const d=new Date(v); if(!isNaN(d)) return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    if (v?.seconds){ const d=new Date(v.seconds*1000); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    return null;
  }
  async function qLastCalving(uid, animalNumber){
    const num = String(animalNumber||'').trim();
    for (const withUser of [true,false]){
      for (const t of CALVING_TYPES){
        const q1 = withUser && uid
          ? query(collection(db,'events'), where('userId','==',uid), where('animalNumber','==',num), where('eventType','==',t), orderBy('eventDate','desc'), limit(1))
          : query(collection(db,'events'), where('animalNumber','==',num), where('eventType','==',t), orderBy('eventDate','desc'), limit(1));
        const s = await getDocs(q1);
        if (!s.empty) return s.docs[0].data().eventDate;
      }
    }
    const adoc = await fetchAnimalDocByNumber(num);
    const a = adoc?.data || {};
    const candidates = [a.lastCalving, a.lastCalvingDate, a.calvingDate, a.lastBirthDate, a.calvingAt, a.lastCalvingAt, a.calvingISO, a.lastCalvingISO];
    for (const c of candidates){ const iso = toISOAny(c); if (iso) return iso; }
    return null;
  }

  // ---------- KPIs ----------
  function splitByKind(rows){
    const o={all:0,cow:0,buff:0};
    for (const r of rows){
      const kg = Number(r.milkKg || r.milk || 0) || 0;
      const k  = normKind(r.kind || r.species || r.animalType || r.animalTypeAr || '');
      o.all += kg; if (k==='جاموس') o.buff += kg; else o.cow += kg;
    }
    return o;
  }

  async function qFeedForDay(uid, dateISO){
    for (const withUser of [true,false]){
      const q1 = withUser && uid
        ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==','تغذية'), where('eventDate','==',dateISO), limit(50))
        : query(collection(db,'events'), where('eventType','==','تغذية'), where('eventDate','==',dateISO), limit(50));
      const s = await getDocs(q1);
      const rows=[]; s.forEach(d=>rows.push(d.data()));
      if (rows.length) return rows;
    }
    return [];
  }

  // ---------- Scatter ----------
  let chart=null;
  let lastMeta=null; // لتخزين بيانات آخر نقطة للهنت
  const hintEl = $('pointHint');
  const scatterWrap = $('scatterWrap');

  function placeHint(x, y){
    // ضعه بالقرب من موقع المؤشر داخل الحاوية
    const rect = scatterWrap.getBoundingClientRect();
    const left = rect.left + window.scrollX + x + 10;
    const top  = rect.top  + window.scrollY + y + 10;
    hintEl.style.left = left + 'px';
    hintEl.style.top  = top  + 'px';
  }

  function fillHint(meta){
    $('hNo').textContent    = meta.number ?? '—';
    $('hKg').textContent    = (meta.kg ?? '—') + ' كجم';
    $('hDim').textContent   = meta.dim ?? '—';
    $('hRepro').textContent = meta.repro ?? '—';
    $('hSeason').textContent= meta.season ?? '—';
    $('hGroup').textContent = meta.group ?? '—';
  }

  // Tooltip خارجي مخصص
  function externalTooltipHandler(ctx){
    const {chart, tooltip} = ctx;
    if (!tooltip || tooltip.opacity === 0){
      hintEl.hidden = true;
      return;
    }
    const dp = tooltip.dataPoints?.[0];
    if (!dp){ hintEl.hidden = true; return; }
    const meta = dp.raw._meta;
    lastMeta = meta;
    fillHint(meta);
    // موضع داخل الكانفاس → حوّله لموضع داخل الحاوية
    placeHint(tooltip.caretX, tooltip.caretY);
    hintEl.hidden = false;
  }

  function drawScatter(points){
    const ctx = $('scatter').getContext('2d');
    if (chart){ chart.destroy(); chart=null; }

    const maxY = Math.max(0, ...points.map(p => Number(p.kg) || 0));
    const yMax = Math.max(10, Math.ceil((maxY + 1) / 5) * 5);

    chart = new Chart(ctx, {
      type:'scatter',
      data:{
        datasets:[{
          label:'أفراد القطيع',
          data: points.map(p=>({x:p.dim, y:p.kg, _meta:p})),
          pointRadius:5
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        scales:{
          x:{ title:{ display:true, text:'أيام الحليب (من آخر ولادة)' } },
          y:{
            beginAtZero:true, min:0, suggestedMax:yMax,
            ticks:{ stepSize:5, precision:0, callback:v=>`${v} كجم` }
          }
        },
        plugins:{
          tooltip:{
            enabled:false,             // عطل الافتراضي
            external: externalTooltipHandler
          }
        },
        // إخفاء الهنت عند النقر خارج النقاط
        onClick(evt, elements){
          if (!elements?.length){ hintEl.hidden = true; }
        }
      }
    });
  }

  $('btnCloseHint').addEventListener('click', ()=>{ hintEl.hidden = true; });
  $('btnOpenCard').addEventListener('click', ()=>{
    if (lastMeta?.number){
      location.href = `cow-card.html?number=${encodeURIComponent(lastMeta.number)}`;
    }
  });

  // ---------- Build & KPIs ----------
  function putKpis(dayRows, monthRows, yearRows, totalAnimals){
    const d = splitByKind(dayRows);
    const m = splitByKind(monthRows);
    const y = splitByKind(yearRows);
    $('sumDay').textContent   = `${(d.all||0).toLocaleString()} كجم`;
    $('sumDayBreak').textContent = `أبقار: ${d.cow||0} • جاموس: ${d.buff||0}`;
    $('sumMonth').textContent = `${(m.all||0).toLocaleString()} كجم`;
    $('sumMonthBreak').textContent = `أبقار: ${m.cow||0} • جاموس: ${m.buff||0}`;
    $('sumYear').textContent  = `${(y.all||0).toLocaleString()} كجم`;
    $('sumYearBreak').textContent = `أبقار: ${y.cow||0} • جاموس: ${y.buff||0}`;
    const milkers = dayRows.length;
    $('avgHerd').textContent = milkers ? `${(d.all/milkers).toFixed(1)} كجم/رأس` : '— كجم/رأس';
    $('milkersCount').textContent = `عدد الحلّاب: ${milkers} / إجمالي: ${totalAnimals ?? '—'}`;
  }

  async function buildScatter(uid, dateISO, rows){
    let skipped = 0;
    const pts=[];
    for (const r of rows){
      const number = String(r.animalNumber || r.number || '').trim();
      const kg = Number(r.milkKg || r.milk || 0) || 0;
      const dimISO = await qLastCalving(uid, number);
      if (!dimISO){ skipped++; continue; }
      const dim = daysBetweenISO(dimISO, dateISO);
      const repro = (r.reproStatus || r.reproductiveStatus || r.repro || '—');
      const group = (r.group || r.groupName || '—');
      const m = dateISO.slice(5,7);
      const season = (['12','01','02'].includes(m))? 'شتاء' : (['03','04','05'].includes(m)?'ربيع': (['06','07','08'].includes(m)?'صيف':'خريف'));
      pts.push({number, kg, dim, repro, season, group});
    }
    $('skipNote').textContent = skipped ? `تم إخفاء ${skipped} حيوان/حيوانات لعدم توفر تاريخ ولادة لديهم.` : '';
    drawScatter(pts);
  }

  async function calcFeedCost(uid, dateISO, dayRows){
    const milkTotal = dayRows.reduce((s,r)=>s + (Number(r.milkKg||r.milk||0)||0), 0);
    const feeds = await qFeedForDay(uid, dateISO);
    if (!milkTotal || !feeds.length){
      $('feedCostPerKg').textContent = '— ج.م/كجم';
      $('feedNote').textContent = 'لا توجد تغذية لهذا اليوم';
      return;
    }
    let totalCost = 0;
    feeds.forEach(f=>{ totalCost += Number(f.totalCost || f.cost || f.feedCost || 0) || 0; });
    if (!totalCost){
      $('feedCostPerKg').textContent = '— ج.م/كجم';
      $('feedNote').textContent = 'يُلزم توفر تكلفة التغذية (totalCost)';
      return;
    }
    const perKg = totalCost / milkTotal;
    $('feedCostPerKg').textContent = `${perKg.toFixed(2)} ج.م/كجم`;
    $('feedNote').textContent = `إجمالي تكلفة تغذية اليوم: ${totalCost.toFixed(0)} ج.م`;
  }

  // ---------- Load ----------
  async function loadAll(){
    hideMsg(); hintEl.hidden = true;
    const uid = await getUid();
    const requested = ymd($('reportDate').value || todayISO());
    let dayRows = await qByDate(uid, requested);

    if (!dayRows.length){
      const last = await qLatestDate(uid);
      if (last){
        $('reportDate').value = last;
        dayRows = await qByDate(uid, last);
        show(`لا توجد سجلات لبن لليوم ${requested}. تم عرض آخر يوم متاح: ${last}.`);
      }else{
        show('لا توجد سجلات لبن محفوظة حتى الآن.');
      }
    }

    const dateISO = $('reportDate').value || requested;
    const {start:ms, end:me} = monthBounds(dateISO);
    const {start:ys, end:ye} = yearBounds(dateISO);
    const monthRows = await qByRange(uid, ms, me);
    const yearRows  = await qByRange(uid, ys, ye);

    putKpis(dayRows, monthRows, yearRows, undefined);
    await buildScatter(uid, dateISO, dayRows);
    await calcFeedCost(uid, dateISO, dayRows);

    $('lastUpdate').textContent = `آخر تحديث: ${new Date().toLocaleTimeString()}`;
  }

  (function init(){
    const qs = new URLSearchParams(location.search);
    const dt = qs.get('date') || qs.get('eventDate') || todayISO();
    $('reportDate').value = ymd(dt);
    $('reportDate').addEventListener('change', ()=>{ loadAll(); }, {passive:true});
    $('btnRefresh').addEventListener('click', loadAll, {passive:true});
    loadAll();
  })();
</script>
</body>
</html>
