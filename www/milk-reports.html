<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تقرير اللبن — مُرَبِّك</title>
  <link rel="stylesheet" href="css/forms.css" />
  <!-- Chart.js للرسم -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --green:#0ea05a; --green-600:#0b7f47; --muted:#64748b; --card:#fff;
      --border:#e2e8f0; --bg:#f7faf7; --danger:#b91c1c; --amber:#b45309;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Cairo',system-ui,Arial}
    header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--border)}
    .bar{max-width:980px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .title{font-weight:800;color:var(--green-600)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn.brand{background:var(--green);border-color:var(--green);color:#fff}
    main{max-width:980px;margin:10px auto;padding:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){ .grid{grid-template-columns:1.1fr .9fr} }
    .kpis{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi h4{margin:0 0 6px 0;font-size:14px;color:#0f172a}
    .kpi .v{font-size:18px;font-weight:800}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .alert{margin:8px 0;padding:10px;border-radius:10px;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;font-weight:700}
    .ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="date"], select{padding:8px 10px;border:1px solid var(--border);border-radius:10px}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
    canvas{max-width:100%}
    .footer-note{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">تقرير اللبن</div>
    <div class="actions">
      <a class="btn" href="add-daily-milk.html">إدخالٍ يومي</a>
      <a class="btn" href="add-event.html">الأحداث</a>
      <button id="refreshBtn" class="btn brand">تحديث</button>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="toolbar">
      <label class="muted">تاريخ العرض:</label>
      <input type="date" id="viewDate" />
      <span id="usedDateText" class="muted"></span>
    </div>
    <div id="topMsg" class="alert" style="display:none"></div>

    <div class="grid" style="margin-top:8px">
      <!-- يسار: المؤشرات -->
      <section class="kpis">
        <div class="kpi">
          <h4>إجمالي اليوم</h4>
          <div class="v"><span id="totDay">—</span> كجم</div>
          <div class="muted">أبقار: <span id="totDayC">—</span> — جاموس: <span id="totDayB">—</span></div>
        </div>
        <div class="kpi">
          <h4>إجمالي الشهر</h4>
          <div class="v"><span id="totMonth">—</span> كجم</div>
          <div class="muted">أبقار: <span id="totMonthC">—</span> — جاموس: <span id="totMonthB">—</span></div>
        </div>
        <div class="kpi">
          <h4>إجمالي السنة</h4>
          <div class="v"><span id="totYear">—</span> كجم</div>
          <div class="muted">أبقار: <span id="totYearC">—</span> — جاموس: <span id="totYearB">—</span></div>
        </div>
        <div class="kpi">
          <h4>متوسط القطيع اليومي</h4>
          <div class="v"><span id="avgHerd">—</span> كجم/رأس</div>
          <div class="muted">عدد الحلّاب: <span id="milkingCount">—</span></div>
        </div>
        <div class="kpi">
          <h4>متوسط تكلفة كجم اللبن (تغذية)</h4>
          <div class="v"><span id="costKg">—</span> ج.م/كجم</div>
          <div class="muted">يُحسب من آخر خلطة مادة جافة</div>
        </div>
      </section>

      <!-- يمين: الرسم -->
      <section class="card" style="padding:10px">
        <div class="legend">
          <span><span class="dot" style="background:#2563eb"></span> أبقار</span>
          <span><span class="dot" style="background:#16a34a"></span> جاموس</span>
        </div>
        <canvas id="scatter" height="260"></canvas>
        <div class="footer-note">الرسم: (أيام الحليب ←) مقابل (الإنتاج اليومي ↑)</div>
      </section>
    </div>
  </div>
</main>

<!-- Firebase -->
<script type="module" src="/js/firebase-config.js"></script>

<!-- منطق الصفحة -->
<script type="module">
import { db, auth } from '/js/firebase-config.js';
import {
  collection, query, where, orderBy, limit, getDocs
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

const $ = id => document.getElementById(id);
const DIGITS={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
const toISO = s => {
  if (/^\d{4}-\d{2}-\d{2}$/.test(s||'')) return s;
  const d = new Date(s||''); if (isNaN(d)) return '';
  return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
};
const todayISO = ()=>{ const d=new Date(); d.setHours(0,0,0,0); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); };

async function getUid(){
  if (auth.currentUser) return auth.currentUser.uid;
  const u = await new Promise(res=>onAuthStateChanged(auth, x=>res(x)));
  return u?.uid || '';
}

/* ------------- جلب آخر تاريخ متاح لحدث "إنتاج اللبن اليومي" ------------- */
async function getLatestMilkDate(uid, upToISO=''){
  const types = ['إنتاج اللبن اليومي','daily_milk','milk'];
  const q1 = query(
    collection(db,'events'),
    where('userId','==', uid),
    where('eventType','in', types),
    orderBy('eventDate','desc'),
    limit(500)
  );
  const snap = await getDocs(q1);
  let firstDate = '';
  for (const d of snap.docs){
    const ev = d.data()||{};
    const dt = ev.eventDate;
    if (!firstDate) firstDate = dt;
    if (!upToISO || dt <= upToISO) return dt;
  }
  return firstDate; // قد يكون فاضي لو مفيش بيانات
}

/* --------- جلب سجلات اليوم المختار (أفراد) + ملخصات وتوزيع النوع --------- */
async function getMilkForDate(uid, dateISO){
  const types = ['إنتاج اللبن اليومي','daily_milk','milk'];
  const q1 = query(
    collection(db,'events'),
    where('userId','==', uid),
    where('eventType','in', types),
    where('eventDate','==', dateISO),
    orderBy('animalNumber','asc')
  );
  const snap = await getDocs(q1);
  const rows = [];
  for (const d of snap.docs){
    const x = d.data() || {};
    const milk = Number(x.milk || x.milkKg || x.yield || x.amount || 0);
    const sp   = (x.species || x.animalTypeAr || '').trim() || 'أبقار';
    const num  = (x.animalNumber || x.number || '').toString().replace(/[٠-٩۰-۹]/g, c=>DIGITS[c]);
    rows.push({
      animalNumber:num, milk, species: (/جاموس|buffalo/i.test(sp)? 'جاموس':'أبقار'),
      group: (x.group || x.groupName || '') || '—',
      season: (x.season || '') || '—',
      repro: (x.reproStatus || x.reproductiveStatus || x.status || '') || '—'
    });
  }
  return rows;
}

/* --------- آخر ولادة للحيوان لحساب Days in Milk --------- */
async function getLastCalvingDate(uid, animalNumber, upToISO){
  const q1 = query(
    collection(db,'events'),
    where('userId','==', uid),
    where('animalNumber','==', animalNumber),
    where('eventType','in', ['ولادة','calving']),
    orderBy('eventDate','desc'),
    limit(1)
  );
  const s = await getDocs(q1);
  if (s.empty) return '';
  const d = s.docs[0].data()||{};
  const dt = d.eventDate || '';
  return (upToISO && dt>upToISO) ? '' : dt;
}

/* --------- عدد الحلّاب من "animals" (إن وُجد) كدعم --------- */
async function getMilkingCount(uid){
  // نحاول أكثر من أسلوب للملفّات المختلفة
  const q1 = query(collection(db,'animals'), where('userId','==', uid), limit(400));
  const s = await getDocs(q1);
  let milking=0;
  s.forEach(doc=>{
    const a = doc.data()||{};
    const st = (a.productionStatus || a.statusAr || a.status || '').toString();
    if (/حلاب|حلّاب|lactating|milking/i.test(st)) milking++;
  });
  return milking || null; // لو 0 نرجّع null علشان ما يضللش
}

/* --------- آخر خلطة مادة جافة لحساب تكلفة كجم اللبن --------- */
async function getLastRation(uid, upToISO){
  // نتوقع وثائق rations: { userId, date, dmPricePerKg, dmiKgPerHead, milkPerHead }
  const q1 = query(
    collection(db,'rations'),
    where('userId','==', uid),
    orderBy('date','desc'),
    limit(50)
  );
  const s = await getDocs(q1);
  for (const d of s.docs){
    const r = d.data()||{};
    const dt = r.date; if (!dt) continue;
    if (!upToISO || dt <= upToISO){
      return {
        dmPrice: Number(r.dmPricePerKg || r.dm_cost_kg || 0),
        dmi:     Number(r.dmiKgPerHead || r.dmi || 0),
        milk:    Number(r.milkPerHead || 0)
      };
    }
  }
  return null;
}

/* --------------------------- UI / حسابات --------------------------- */
let chart;
function setMsg(text, ok=false){
  const el = $('topMsg');
  if (!text){ el.style.display='none'; el.textContent=''; return; }
  el.className = ok ? 'alert ok' : 'alert';
  el.textContent = text;
  el.style.display = 'block';
}

function daysBetween(a,b){
  const A=new Date(a), B=new Date(b); A.setHours(0,0,0,0); B.setHours(0,0,0,0);
  return Math.round((B-A)/86400000);
}

function fmt(n){ return (isNaN(n)||n==null)? '—' : Number(n).toLocaleString('ar-EG', {maximumFractionDigits:1}); }

async function refresh(){
  try{
    setMsg('…جارِ تحميل آخر بيانات متاحة');
    const uid = await getUid();
    if (!uid) { setMsg('سجّل الدخول أولًا'); return; }

    const asked = toISO($('viewDate').value) || todayISO();
    let used = await getLatestMilkDate(uid, asked);
    if (!used){
      // لا توجد سجلات إطلاقًا
      $('usedDateText').textContent = '';
      setMsg('لا توجد سجلات لبن محفوظة حتى الآن', false);
      // صفّر المؤشرات
      ['totDay','totMonth','totYear','avgHerd','totDayC','totDayB','totMonthC','totMonthB','totYearC','totYearB','milkingCount','costKg']
        .forEach(id=>$(id).textContent='—');
      if (chart){ chart.destroy(); chart=null; }
      return;
    }

    $('usedDateText').textContent = `(آخر متاح: ${used})`;

    // بيانات اليوم المختار (المتاح)
    const rows = await getMilkForDate(uid, used);
    if (!rows.length){
      setMsg(`لا توجد سجلات لليوم ${asked}. تم عرض آخر تاريخ متاح: ${used}.`, false);
    }else{
      setMsg(`تم عرض بيانات يوم ${used}`, true);
    }

    // إجمالي اليوم + حسب النوع
    const sumBy = (arr, pred)=>arr.reduce((a,x)=>a+(pred?pred(x):x),0);
    const dayC = sumBy(rows, r=> r.species==='أبقار' ? (r.milk||0) : 0);
    const dayB = sumBy(rows, r=> r.species==='جاموس' ? (r.milk||0) : 0);
    $('totDay').textContent   = fmt(dayC + dayB);
    $('totDayC').textContent  = fmt(dayC);
    $('totDayB').textContent  = fmt(dayB);

    // عدد الحلّاب = عدد الحيوانات التي لديها سجل في هذا اليوم (أقرب تعريف) أو من animals
    const uniq = new Set(rows.map(r=>r.animalNumber).filter(Boolean));
    let milkingCount = uniq.size;
    if (!milkingCount){
      const fromAnimals = await getMilkingCount(uid);
      if (fromAnimals) milkingCount = fromAnimals;
    }
    $('milkingCount').textContent = milkingCount || '—';
    $('avgHerd').textContent = (milkingCount && (dayC+dayB)) ? fmt((dayC+dayB)/milkingCount) : '—';

    // إجمالي الشهر/السنة: نجيب آخر 500 حدث ونجمّع
    const qAgg = query(
      collection(db,'events'),
      where('userId','==', uid),
      where('eventType','in',['إنتاج اللبن اليومي','daily_milk','milk']),
      orderBy('eventDate','desc'),
      limit(500)
    );
    const sAgg = await getDocs(qAgg);
    const ym = used.slice(0,7), yy = used.slice(0,4);
    let mC=0,mB=0,yC=0,yB=0;
    sAgg.forEach(d=>{
      const x=d.data()||{}; const dt=x.eventDate||''; if (!dt) return;
      const sp=(x.species||x.animalTypeAr||'').match(/جاموس|buffalo/i)?'B':'C';
      const milk=Number(x.milk||x.milkKg||x.yield||x.amount||0);
      if (dt.startsWith(ym)){ if (sp==='C') mC+=milk; else mB+=milk; }
      if (dt.startsWith(yy)){ if (sp==='C') yC+=milk; else yB+=milk; }
    });
    $('totMonth').textContent = fmt(mC+mB);
    $('totMonthC').textContent= fmt(mC);
    $('totMonthB').textContent= fmt(mB);
    $('totYear').textContent  = fmt(yC+yB);
    $('totYearC').textContent = fmt(yC);
    $('totYearB').textContent = fmt(yB);

    // تكلفة كجم اللبن (لو فيه rations)
    const ration = await getLastRation(uid, used);
    if (ration && ration.dmPrice>0 && ration.dmi>0 && ration.milk>0){
      const cost = (ration.dmPrice * ration.dmi) / ration.milk;
      $('costKg').textContent = fmt(cost);
    }else{
      $('costKg').textContent = '—';
    }

    // رسم مبعثر: لازم نضيف Days in Milk أولًا
    const points = [];
    for (const r of rows){
      if (!r.animalNumber) continue;
      const lastCalv = await getLastCalvingDate(uid, r.animalNumber, used);
      const dim = lastCalv ? daysBetween(lastCalv, used) : null;
      points.push({
        x: dim ?? 0,
        y: Number(r.milk||0),
        species: r.species,
        label: r.animalNumber,
        meta: {
          dim: dim ?? '—',
          repro: r.repro || '—',
          season: r.season || '—',
          group: r.group || '—'
        }
      });
    }

    // ارسم
    const ctx = $('scatter').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [
          {
            label: 'أبقار',
            data: points.filter(p=>p.species==='أبقار').map(p=>({x:p.x,y:p.y, _meta:p})),
            backgroundColor: '#2563eb88',
            borderColor: '#2563eb',
            pointRadius: 4
          },
          {
            label: 'جاموس',
            data: points.filter(p=>p.species==='جاموس').map(p=>({x:p.x,y:p.y, _meta:p})),
            backgroundColor: '#16a34a88',
            borderColor: '#16a34a',
            pointRadius: 4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { title: { display:true, text:'أيام الحليب (DIM)' } },
          y: { title: { display:true, text:'إنتاج يومي (كجم)' } }
        },
        plugins: {
          tooltip: {
            callbacks:{
              label(ctx){
                const m = ctx.raw._meta;
                return [
                  `حيوان: ${m.label||ctx.raw._meta.label}`,
                  `DIM: ${m.dim}`,
                  `إنتاج: ${ctx.parsed.y} كجم`,
                  `حالة تناسلية: ${m.repro}`,
                  `الموسم: ${m.season}`,
                  `المجموعة: ${m.group}`
                ];
              }
            }
          },
          legend: { position:'top' }
        }
      }
    });

  }catch(err){
    console.error(err);
    setMsg('تعذّر تحميل التقرير الآن', false);
  }
}

/* ------------- تهيئة واجهة الموبايل + الأحداث ------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  $('viewDate').value = todayISO();
  $('refreshBtn').addEventListener('click', refresh);
  $('viewDate').addEventListener('change', refresh);
  refresh(); // تحميل أولي
});
</script>
</body>
</html>
