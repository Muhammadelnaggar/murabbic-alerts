<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù† â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</title>
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <style>
    :root{
      --green:#0ea05a; --green-600:#0b7f47; --bg:#f6faf7; --text:#0f172a;
      --muted:#64748b; --card:#fff; --border:#e2e8f0; --warn:#f59e0b; --danger:#dc2626
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Cairo',system-ui,Segoe UI,Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
    .bar{max-width:960px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title{font-weight:800;color:var(--green-600);display:flex;gap:8px;align-items:center}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;font-weight:700;cursor:pointer}
    .chip.primary{background:var(--green);color:#fff;border-color:var(--green)}
    main{max-width:960px;margin:14px auto;padding:10px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){ .row{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:920px){ .row{grid-template-columns:repeat(3,1fr)} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi h3{margin:0;font-size:14px;color:#0f172a}
    .kpi .num{font-weight:900;font-size:22px}
    .kpi small{color:var(--muted)}

    .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:15px}

    .notice{margin:10px 0;padding:10px;border-radius:10px;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;font-weight:700}
    .ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}

    canvas{width:100%;height:320px;max-height:50vh}

    /* Ù…ÙˆØ¨Ø§ÙŠÙ„: Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨ÙÙ„ Ø³ÙƒØ±ÙŠÙ† ØªÙ‚Ø±ÙŠØ¨Ø§ */
    @media(max-width:420px){
      .kpi .num{font-size:20px}
      .bar .actions{width:100%;justify-content:flex-end}
    }
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="actions">
      <a class="chip" href="daily-milk.html">Ø¥Ø¯Ø®Ø§Ù„ ÙŠÙˆÙ…ÙŠ</a>
      <a class="chip" href="add-event.html">Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</a>
      <button id="btnRefresh" class="chip primary">ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </div>
</header>

<main>
  <div class="card inline" style="justify-content:space-between">
    <div class="inline">
      <label for="reportDate" style="font-weight:700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¶:</label>
      <input id="reportDate" type="date">
    </div>
    <div id="lastUpdate" class="inline" style="color:var(--muted);font-size:13px"></div>
  </div>

  <div id="msg" class="notice" style="display:none"></div>

  <div class="row" id="kpis">
    <div class="card kpi">
      <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="num" id="sumDay">â€” ÙƒØ¬Ù…</div>
      <small id="sumDayBreak">Ø£Ø¨Ù‚Ø§Ø±: â€” â€¢ Ø¬Ø§Ù…ÙˆØ³: â€”</small>
    </div>
    <div class="card kpi">
      <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±</h3>
      <div class="num" id="sumMonth">â€” ÙƒØ¬Ù…</div>
      <small id="sumMonthBreak">Ø£Ø¨Ù‚Ø§Ø±: â€” â€¢ Ø¬Ø§Ù…ÙˆØ³: â€”</small>
    </div>
    <div class="card kpi">
      <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†Ø©</h3>
      <div class="num" id="sumYear">â€” ÙƒØ¬Ù…</div>
      <small id="sumYearBreak">Ø£Ø¨Ù‚Ø§Ø±: â€” â€¢ Ø¬Ø§Ù…ÙˆØ³: â€”</small>
    </div>
    <div class="card kpi">
      <h3>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
      <div class="num" id="avgHerd">â€” ÙƒØ¬Ù…/Ø±Ø£Ø³</div>
      <small id="milkersCount">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ù‘Ø§Ø¨: â€” / Ø¥Ø¬Ù…Ø§Ù„ÙŠ: â€”</small>
    </div>
    <div class="card kpi">
      <h3>Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© ÙƒØ¬Ù… Ø§Ù„Ù„Ø¨Ù† (ØªØºØ°ÙŠØ©)</h3>
      <div class="num" id="feedCostPerKg">â€” Ø¬.Ù…/ÙƒØ¬Ù…</div>
      <small id="feedNote">ÙŠØªØ·Ù„Ø¨ Ø­Ø¯Ø« ØªØºØ°ÙŠØ© Ù„Ù„ÙŠÙˆÙ…</small>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£ÙØ±Ø§Ø¯ (Scatter): Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ Ã— ÙƒØ¬Ù…/Ø§Ù„ÙŠÙˆÙ…</h3>
    <canvas id="scatter"></canvas>
    <small style="color:var(--muted)">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø·Ø© Ù„ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</small>
  </div>
</main>

<!-- Firebase + Chart.js -->
<script type="module" src="/js/firebase-config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script type="module">
  import { db, auth } from '/js/firebase-config.js';
  import {
    collection, query, where, orderBy, limit, getDocs, startAt, endAt
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

  // ==== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ====
  const $ = id => document.getElementById(id);
  const DIGITS={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
  const toLatin = s => String(s||'').replace(/[Ù -Ù©Û°-Û¹]/g,d=>DIGITS[d]).replace(/[^\d]/g,'');
  const TYPES = ['Ù„Ø¨Ù† ÙŠÙˆÙ…ÙŠ','milk','daily_milk'];

  function todayISO(){
    const d=new Date(); d.setHours(0,0,0,0);
    return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  }
  function ymd(date){ return /^\d{4}-\d{2}-\d{2}$/.test(date) ? date : todayISO(); }
  function daysBetweenISO(a,b){
    const A=new Date(a), B=new Date(b);
    A.setHours(0,0,0,0); B.setHours(0,0,0,0);
    return Math.round((B-A)/86400000);
  }
  function monthBounds(dISO){
    const d=new Date(dISO); d.setDate(1);
    const start = new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const next = new Date(d); next.setMonth(next.getMonth()+1); next.setDate(1);
    const end = new Date(next.getTime()-next.getTimezoneOffset()*60000).toISOString().slice(0,10);
    return {start,end}; // [start, end)
  }
  function yearBounds(dISO){
    const y = dISO.slice(0,4);
    return {start: `${y}-01-01`, end: `${(+y+1)}-01-01`};
  }
  function normKind(v){
    if (/buffalo|Ø¬Ø§Ù…ÙˆØ³/i.test(v)) return 'Ø¬Ø§Ù…ÙˆØ³';
    return 'Ø£Ø¨Ù‚Ø§Ø±';
  }
  function show(msg, ok=false){
    const el = $('msg');
    el.style.display='block';
    el.className = 'notice ' + (ok ? 'ok' : '');
    el.textContent = msg;
  }
  function hideMsg(){ $('msg').style.display='none'; }

  async function getUid(){
    if (auth.currentUser) return auth.currentUser.uid;
    const u = await new Promise(res=>onAuthStateChanged(auth, x=>res(x)));
    return u?.uid || '';
  }

  // ==== Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ù…Ø±Ù†Ø© (ØªØ­ØªØ±Ù…/ØªØªØ¬Ø§Ù‡Ù„ userId) ====
  async function qLatestDate(uid){
    // Ø¬Ø±Ù‘Ø¨ ÙƒÙ„ Ø§Ù„ØªØ³Ù…ÙŠØ§Øª ÙˆØ¨Ù€ userIdØŒ Ø«Ù… Ø¨Ø¯ÙˆÙ† userId
    for (const withUser of [true,false]){
      for (const t of TYPES){
        const q1 = withUser && uid
          ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==',t), orderBy('eventDate','desc'), limit(1))
          : query(collection(db,'events'), where('eventType','==',t), orderBy('eventDate','desc'), limit(1));
        const s = await getDocs(q1);
        if (!s.empty) return s.docs[0].data().eventDate;
      }
    }
    return null;
  }

  async function qByDate(uid, dateISO){
    for (const withUser of [true,false]){
      let bag = [];
      for (const t of TYPES){
        const q1 = withUser && uid
          ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==',t), where('eventDate','==',dateISO), limit(500))
          : query(collection(db,'events'), where('eventType','==',t), where('eventDate','==',dateISO), limit(500));
        const s = await getDocs(q1);
        s.forEach(d=>bag.push(d.data()));
      }
      if (bag.length) return bag;
    }
    return [];
  }

  async function qByRange(uid, startISO, endISO){
    // [start, end) Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø­Ù‚Ù„ eventDate
    for (const withUser of [true,false]){
      let bag = [];
      for (const t of TYPES){
        const q1 = withUser && uid
          ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==',t), orderBy('eventDate'), startAt(startISO), endAt(endISO))
          : query(collection(db,'events'), where('eventType','==',t), orderBy('eventDate'), startAt(startISO), endAt(endISO));
        const s = await getDocs(q1);
        s.forEach(d=>bag.push(d.data()));
      }
      if (bag.length) return bag;
    }
    return [];
  }

  async function qLastCalving(uid, animalNumber){
    // Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù†
    const num = String(animalNumber||'').trim();
    // Ù„Ùˆ ÙÙŠÙ‡ userId ÙƒÙˆÙŠØ³ØŒ ÙˆØ¥Ù„Ø§ Ù‡Ø§Øª Ø£ÙŠ
    for (const withUser of [true,false]){
      const q1 = withUser && uid
        ? query(collection(db,'events'), where('userId','==',uid), where('animalNumber','==',num), where('eventType','==','ÙˆÙ„Ø§Ø¯Ø©'), orderBy('eventDate','desc'), limit(1))
        : query(collection(db,'events'), where('animalNumber','==',num), where('eventType','==','ÙˆÙ„Ø§Ø¯Ø©'), orderBy('eventDate','desc'), limit(1));
      const s = await getDocs(q1);
      if (!s.empty) return s.docs[0].data().eventDate;
    }
    return null;
  }

  // ==== Ø­Ø³Ø§Ø¨Ø§Øª ====
  function splitByKind(rows){
    const o={all:0,cow:0,buff:0};
    for (const r of rows){
      const kg = Number(r.milkKg || r.milk || 0) || 0;
      const k  = normKind(r.kind || r.species || r.animalType || r.animalTypeAr || '');
      o.all += kg;
      if (k==='Ø¬Ø§Ù…ÙˆØ³') o.buff += kg; else o.cow += kg;
    }
    return o;
  }

  // ØªØºØ°ÙŠØ©: Ù†Ø­Ø§ÙˆÙ„ Ø¥ÙŠØ¬Ø§Ø¯ cost/DM Ù„Ù„ÙŠÙˆÙ… â€” (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  async function qFeedForDay(uid, dateISO){
    for (const withUser of [true,false]){
      const q1 = withUser && uid
        ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==','ØªØºØ°ÙŠØ©'), where('eventDate','==',dateISO), limit(50))
        : query(collection(db,'events'), where('eventType','==','ØªØºØ°ÙŠØ©'), where('eventDate','==',dateISO), limit(50));
      const s = await getDocs(q1);
      const rows=[]; s.forEach(d=>rows.push(d.data()));
      if (rows.length) return rows;
    }
    return [];
  }

  // ==== ÙˆØ§Ø¬Ù‡Ø© ====
  let chart=null;
  function drawScatter(points){
    const ctx = $('scatter');
    if (chart){ chart.destroy(); chart=null; }
    chart = new Chart(ctx, {
      type:'scatter',
      data:{
        datasets:[{
          label:'Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù‚Ø·ÙŠØ¹',
          data: points.map(p=>({x:p.dim, y:p.kg, _meta:p})),
          pointRadius:5,
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          x:{ title:{display:true,text:'Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨'} },
          y:{ title:{display:true,text:'ÙƒØ¬Ù…/Ø§Ù„ÙŠÙˆÙ…'} }
        },
        plugins:{
          tooltip:{
            callbacks:{
              label(ctx){
                const m = ctx.raw._meta;
                return `${m.number} â€” ${ctx.parsed.y} ÙƒØ¬Ù… â€¢ ${ctx.parsed.x} ÙŠÙˆÙ…\nØ­Ø§Ù„Ø©: ${m.repro||'â€”'} â€¢ Ù…ÙˆØ³Ù…: ${m.season||'â€”'} â€¢ Ù…Ø¬Ù…ÙˆØ¹Ø©: ${m.group||'â€”'}`;
              }
            }
          }
        },
        onClick(evt, els){
          if (!els?.length) return;
          const m = els[0].element.$context.raw._meta;
          if (m?.number){
            location.href = `cow-card.html?number=${encodeURIComponent(m.number)}`;
          }
        }
      }
    });
  }

  function putKpis(dayRows, monthRows, yearRows, totalAnimals){
    const d = splitByKind(dayRows);
    const m = splitByKind(monthRows);
    const y = splitByKind(yearRows);

    $('sumDay').textContent   = `${(d.all||0).toLocaleString()} ÙƒØ¬Ù…`;
    $('sumDayBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${d.cow||0} â€¢ Ø¬Ø§Ù…ÙˆØ³: ${d.buff||0}`;

    $('sumMonth').textContent = `${(m.all||0).toLocaleString()} ÙƒØ¬Ù…`;
    $('sumMonthBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${m.cow||0} â€¢ Ø¬Ø§Ù…ÙˆØ³: ${m.buff||0}`;

    $('sumYear').textContent  = `${(y.all||0).toLocaleString()} ÙƒØ¬Ù…`;
    $('sumYearBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${y.cow||0} â€¢ Ø¬Ø§Ù…ÙˆØ³: ${y.buff||0}`;

    const milkers = dayRows.length; // Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ù‘Ø§Ø¨ = Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
    $('avgHerd').textContent = milkers ? `${(d.all/milkers).toFixed(1)} ÙƒØ¬Ù…/Ø±Ø£Ø³` : 'â€” ÙƒØ¬Ù…/Ø±Ø£Ø³';
    $('milkersCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ù‘Ø§Ø¨: ${milkers} / Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalAnimals ?? 'â€”'}`;
  }

  async function buildScatter(uid, dateISO, rows){
    // Ù„ÙƒÙ„ Ø­ÙŠÙˆØ§Ù†: kg Ø§Ù„ÙŠÙˆÙ… + DIM Ù…Ù† Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø© + Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
    const pts=[];
    for (const r of rows){
      const number = String(r.animalNumber || r.number || '').trim();
      const kg = Number(r.milkKg || r.milk || 0) || 0;
      let dim = 0;
      try{
        const lastCalv = await qLastCalving(uid, number);
        if (lastCalv) dim = daysBetweenISO(lastCalv, dateISO);
      }catch(_){}
      const repro = (r.reproStatus || r.reproductiveStatus || r.repro || 'â€”');
      const group = (r.group || r.groupName || 'â€”');
      const m = dateISO.slice(5,7);
      const season = (['12','01','02'].includes(m))? 'Ø´ØªØ§Ø¡' : (['03','04','05'].includes(m)?'Ø±Ø¨ÙŠØ¹': (['06','07','08'].includes(m)?'ØµÙŠÙ':'Ø®Ø±ÙŠÙ'));
      pts.push({number, kg, dim, repro, season, group});
    }
    drawScatter(pts);
  }

  async function calcFeedCost(uid, dateISO, dayRows){
    const milkTotal = dayRows.reduce((s,r)=>s + (Number(r.milkKg||r.milk||0)||0), 0);
    const feeds = await qFeedForDay(uid, dateISO);
    if (!milkTotal || !feeds.length){
      $('feedCostPerKg').textContent = 'â€” Ø¬.Ù…/ÙƒØ¬Ù…';
      $('feedNote').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºØ°ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…';
      return;
    }
    // Ù†Ø­Ø§ÙˆÙ„ Ø¥ÙŠØ¬Ø§Ø¯ totalDmKg/totalCost Ø£Ùˆ Ù…Ø§ Ø´Ø§Ø¨Ù‡
    let totalCost = 0;
    feeds.forEach(f=>{
      const c = Number(f.totalCost || f.cost || f.feedCost || 0) || 0;
      totalCost += c;
    });
    if (!totalCost){
      $('feedCostPerKg').textContent = 'â€” Ø¬.Ù…/ÙƒØ¬Ù…';
      $('feedNote').textContent = 'ÙŠÙÙ„Ø²Ù… ØªÙˆÙØ± ØªÙƒÙ„ÙØ© Ø§Ù„ØªØºØ°ÙŠØ© (totalCost)';
      return;
    }
    const perKg = totalCost / milkTotal;
    $('feedCostPerKg').textContent = `${perKg.toFixed(2)} Ø¬.Ù…/ÙƒØ¬Ù…`;
    $('feedNote').textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„ØªØºØ°ÙŠØ©/Ø§Ù„ÙŠÙˆÙ…: ${totalCost.toFixed(0)} Ø¬.Ù…`;
  }

  // ==== Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ====
  async function loadAll(){
    hideMsg();
    const uid = await getUid(); // Ù‚Ø¯ ÙŠÙƒÙˆÙ† ÙØ§Ø¶ÙŠ
    const requested = ymd($('reportDate').value || todayISO());

    // Ù‡Ø§Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    let dayRows = await qByDate(uid, requested);

    // Ù„Ùˆ Ù…ÙÙŠØ´ØŒ Ø­Ù…Ù‘Ù„ Ø¢Ø®Ø± ÙŠÙˆÙ… Ù…ØªØ§Ø­ Ø«Ù… Ø§Ø¹Ø±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø©
    if (!dayRows.length){
      const last = await qLatestDate(uid);
      if (last){
        $('reportDate').value = last;
        dayRows = await qByDate(uid, last);
        show(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¨Ù† Ù„Ù„ÙŠÙˆÙ… ${requested}. ØªÙ… Ø¹Ø±Ø¶ Ø¢Ø®Ø± ÙŠÙˆÙ… Ù…ØªØ§Ø­: ${last}.`);
      }else{
        show('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¨Ù† Ù…Ø­ÙÙˆØ¸Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.');
      }
    }

    const dateISO = $('reportDate').value || requested;

    // Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©
    const {start:ms, end:me} = monthBounds(dateISO);
    const {start:ys, end:ye} = yearBounds(dateISO);
    const monthRows = await qByRange(uid, ms, me);
    const yearRows  = await qByRange(uid, ys, ye);

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” Ù†Ø³ØªØ®Ø¯Ù… Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙƒØ¹Ø¯Ø¯ Ø­Ù„Ø§Ø¨
    // Ù„Ùˆ Ù…Ø­ØªØ§Ø¬ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹ ÙØ¹Ù„ÙŠØŒ Ù…Ù…ÙƒÙ† ØªØ¬ÙŠØ¨Ù‡ Ù…Ù† animals Ù„Ø§Ø­Ù‚Ù‹Ø§.
    putKpis(dayRows, monthRows, yearRows, undefined);

    // Scatter
    await buildScatter(uid, dateISO, dayRows);

    // Ø§Ù„ØªØºØ°ÙŠØ©
    await calcFeedCost(uid, dateISO, dayRows);

    $('lastUpdate').textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString()}`;
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® + Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  (function init(){
    const qs = new URLSearchParams(location.search);
    const dt = qs.get('date') || qs.get('eventDate') || todayISO();
    $('reportDate').value = ymd(dt);
    $('reportDate').addEventListener('change', loadAll);
    $('btnRefresh').addEventListener('click', loadAll, {passive:true});
    loadAll();
  })();
</script>
</body>
</html>
