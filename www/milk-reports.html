<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù† â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</title>
  <link rel="stylesheet" href="css/forms.css" />
  <script type="module" src="js/forms-init.js"></script>
  <!-- Chart.js Ù„Ù„Ø±Ø³Ù… -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Cairo','Segoe UI',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0}
    .bar{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title{font-weight:800;color:var(--green-600)}
    main{max-width:1100px;margin:16px auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .grid{display:grid;gap:12px}
    .row{display:grid;gap:12px}
    @media(min-width:900px){ .row{grid-template-columns:repeat(4,1fr)} }
    label{font-weight:700;font-size:14px}
    input,select{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:15px}
    .metric{display:flex;flex-direction:column;gap:6px;padding:12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
    .metric .k{font-size:26px;font-weight:900}
    .muted{color:#64748b}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2f7;color:#0f172a;font-weight:700}
    .infobar{display:none;margin-top:8px;padding:10px;border-radius:10px;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .infobar.show{display:block}
    .error{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    canvas{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:6px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right}
  </style>
</head>
<body>
  <script>window.dataLayer = window.dataLayer || [];</script>

  <header>
    <div class="bar">
      <div class="title">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
      <div class="actions">
        <a class="badge" href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a class="badge" href="daily-milk.html">Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø¨Ù† ÙŠÙˆÙ…ÙŠ</a>
        <a class="badge" href="add-event.html">Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</a>
      </div>
    </div>
  </header>

  <main>
    <!-- ÙÙ„Ø§ØªØ± -->
    <div class="card">
      <div class="row" style="grid-template-columns:repeat(5,1fr)">
        <div>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø³Ø§Ø³</label>
          <input id="refDate" type="date" />
        </div>
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹</label>
          <select id="speciesFilter">
            <option value="all">Ø§Ù„ÙƒÙ„</option>
            <option value="Ø£Ø¨Ù‚Ø§Ø±">Ø£Ø¨Ù‚Ø§Ø±</option>
            <option value="Ø¬Ø§Ù…ÙˆØ³">Ø¬Ø§Ù…ÙˆØ³</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <select id="unitSel">
            <option value="kg">ÙƒØ¬Ù…</option>
            <option value="l">Ù„ØªØ±</option>
          </select>
        </div>
        <div style="align-self:end">
          <button id="refreshBtn" class="badge" style="border:1px solid #cbd5e1">ØªØ­Ø¯ÙŠØ« ğŸ”„</button>
        </div>
        <div style="align-self:end">
          <span id="status" class="muted"></span>
        </div>
      </div>
      <div id="msg" class="infobar"></div>
    </div>

    <!-- Ù…Ø¤Ø´Ø±Ø§Øª -->
    <div class="card">
      <div class="row">
        <div class="metric">
          <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ… (Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹)</div>
          <div class="k" id="kDaily">â€”</div>
          <div class="muted" id="kDailyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±</div>
          <div class="k" id="kMonthly">â€”</div>
          <div class="muted" id="kMonthlyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†Ø©</div>
          <div class="k" id="kYearly">â€”</div>
          <div class="muted" id="kYearlyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
          <div class="k" id="kAvg">â€”</div>
          <div class="muted" id="kAvgNote"></div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø±Ø³Ù… -->
    <div class="card grid">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><b>Scatter</b> â€” Ø§Ù„Ø£ÙØ±Ø§Ø¯: (X) Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ â€” (Y) Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
        <div class="muted">Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø·Ø© ÙŠÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</div>
      </div>
      <canvas id="scatterChart" height="330"></canvas>
    </div>

    <!-- ØªÙƒÙ„ÙØ© ÙƒØ¬Ù… Ø§Ù„Ù„Ø¨Ù† Ù…Ù† Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø§ÙØ© -->
    <div class="card grid">
      <div class="row" style="grid-template-columns:repeat(3,1fr)">
        <div class="metric">
          <div class="muted">Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© ÙƒØ¬Ù… Ø§Ù„Ù„Ø¨Ù† (Ø´Ù‡Ø± Ø§Ù„Ø£Ø³Ø§Ø³)</div>
          <div class="k" id="kCostPerKg">â€”</div>
          <div class="muted" id="kCostNote">ØªØ­Ø³Ø¨ Ù…Ù† Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØºØ°ÙŠØ© (dmIntakeKg Ã— dmCostPerKg) Ã· Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ø¨Ù†.</div>
        </div>
        <div class="metric">
          <div class="muted">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</div>
          <div id="kCostDbg" class="muted">â€”</div>
        </div>
        <div class="metric">
          <div class="muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
          <div class="muted">ÙÙŠ Ø­Ø§Ù„ Ù†Ù‚Øµ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„ØªØºØ°ÙŠØ© Ø£Ùˆ Ø§Ù„Ù„Ø¨Ù† Ù„Ù† ØªÙØ­ØªØ³Ø¨ ØªÙ„Ùƒ Ø§Ù„Ø³Ø¬Ù„Ø§Øª.</div>
        </div>
      </div>
    </div>

    <!-- Ù„Ø§Ø¦Ø­Ø© Ù…Ø®ØªØµØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">Ø£Ø¹Ù„Ù‰ 10 Ø£ÙØ±Ø§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
      <table class="table" id="topTable">
        <thead><tr><th>Ø±Ù‚Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>DIM</th><th>Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</th><th>Ø­Ø§Ù„Ø© ØªÙ†Ø§Ø³Ù„ÙŠØ©</th><th>Ù…ÙˆØ³Ù…</th><th>Ù…Ø¬Ù…ÙˆØ¹Ø©</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- Firebase -->
  <script type="module" src="/js/firebase-config.js"></script>
  <script src="/js/app-core.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>

  <!-- Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© -->
  <script type="module">
    import { db, auth, ensureAuth } from '/js/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      collection, query, where, orderBy, limit, getDocs
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Ø¹Ù†Ø§ØµØ±
    const refDateEl = document.getElementById('refDate');
    const speciesSel = document.getElementById('speciesFilter');
    const unitSel = document.getElementById('unitSel');
    const refreshBtn = document.getElementById('refreshBtn');
    const msg = document.getElementById('msg');
    const statusEl = document.getElementById('status');

    const DIGITS={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
    const toLatin = s => String(s||'').replace(/[Ù -Ù©Û°-Û¹]/g, d=>DIGITS[d]).replace(/[^\d]/g,'');

    // Ø£Ø¯ÙˆØ§Øª ÙˆÙ‚Øª
    function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    function startOfMonthISO(d){ const x=new Date(d); x.setDate(1); return x.toISOString().slice(0,10) }
    function endOfMonthISO(d){ const x=new Date(d); x.setMonth(x.getMonth()+1); x.setDate(0); return x.toISOString().slice(0,10) }
    function startOfYearISO(d){ const x=new Date(d); x.setMonth(0,1); return x.toISOString().slice(0,10) }
    function endOfYearISO(d){ const x=new Date(d); x.setMonth(12,0); return x.toISOString().slice(0,10) }
    function daysBetweenISO(a,b){ const A=new Date(a), B=new Date(b); A.setHours(0,0,0,0); B.setHours(0,0,0,0); return Math.round((B-A)/86400000); }

    function fmt(n,dec=1){ if(n==null||isNaN(n)) return 'â€”'; return Number(n).toLocaleString('ar-EG',{maximumFractionDigits:dec,minimumFractionDigits:dec}); }
    function showMsg(t,isErr=false){ msg.className='infobar '+(isErr?'show error':'show'); msg.innerHTML=(isErr?'âŒ ':'âœ… ')+t; }

    async function uid(){ if(auth.currentUser) return auth.currentUser.uid; return new Promise(r=>onAuthStateChanged(auth,u=>r(u?.uid||''))); }

    function normSpecies(data){
      const s = String(data?.animalTypeAr || data?.animalType || data?.species || '').trim();
      if (s==='cow' || /Ø¨Ù‚Ø±/i.test(s)) return 'Ø£Ø¨Ù‚Ø§Ø±';
      if (s==='buffalo' || /Ø¬Ø§Ù…ÙˆØ³/i.test(s)) return 'Ø¬Ø§Ù…ÙˆØ³';
      return s || 'Ø£Ø¨Ù‚Ø§Ø±';
    }

    // Ø¬Ù„Ø¨ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ù…Ù† animals
    async function fetchAnimalDocByNumber(number){
      const n = toLatin(number);
      const { getDocs, query, where, limit, collection } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
      const tries = [
        ['animalNumber','==',n], ['number','==',n], ['animalNo','==',n]
      ];
      for (const [f,op,val] of tries){
        const s = await getDocs(query(collection(db,'animals'), where(f,op,val), limit(1)));
        if (!s.empty){ const d=s.docs[0]; return { id:d.id, data:d.data()||{} }; }
      }
      return null;
    }

    // Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø© Ù„Ø­Ø³Ø§Ø¨ DIM + Ø¢Ø®Ø± ØªØ´Ø®ÙŠØµ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©
    async function fetchFacts(number, refDate){
      const u = await uid();
      const qEv = query(
        collection(db,'events'),
        where('userId','==', u),
        where('animalNumber','==', String(number)),
        orderBy('eventDate','desc'),
        limit(80)
      );
      const s = await getDocs(qEv);
      let lastCalving=null, repro='ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      for (const d of s.docs){
        const ev = d.data()||{};
        const type = (ev.eventType || ev.type || '').trim();
        const res  = (ev.result || ev.status || '').trim();
        if (!lastCalving && (type==='calving' || type==='ÙˆÙ„Ø§Ø¯Ø©')) lastCalving = ev.eventDate;
        if (type==='pregnancy_check' || type==='ØªØ´Ø®ÙŠØµ Ø­Ù…Ù„'){ repro = res || repro; break; }
      }
      const dim = lastCalving ? Math.max(0, daysBetweenISO(lastCalving, refDate)) : null;
      return { dim, lastCalving, repro };
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù„Ø¨Ù† Ù…Ù† Ø­Ø¯Ø«
    function readMilk(ev){
      const v = ev.milkKg ?? ev.milk ?? ev.yieldKg ?? ev.yield ?? ev.liters;
      const n = Number(v);
      return isFinite(n) ? n : 0;
    }

    // ØªØµÙÙŠØ© Ø§Ù„Ù†ÙˆØ¹
    function speciesOK(spWanted, sp){
      if (spWanted==='all') return true;
      return sp===spWanted;
    }

    // Ø§Ù„Ø±Ø³Ù…
    let scatter;
    function drawScatter(datasets){
      const ctx = document.getElementById('scatterChart').getContext('2d');
      if (scatter){ scatter.destroy(); }
      scatter = new Chart(ctx,{
        type:'scatter',
        data:{ datasets },
        options:{
          responsive:true,
          plugins:{
            legend:{ display:true, labels:{ usePointStyle:true } },
            tooltip:{
              callbacks:{
                label: (ctx)=>{
                  const p = ctx.raw;
                  /* p.meta: { number, milk, dim, repro, season, group } */
                  const lines = [
                    `Ø±Ù‚Ù…: ${p.meta.number}`,
                    `DIM: ${p.meta.dim ?? 'â€”'}`,
                    `Ø¥Ù†ØªØ§Ø¬: ${fmt(p.meta.milk,1)}`,
                    `Ø­Ø§Ù„Ø© ØªÙ†Ø§Ø³Ù„ÙŠØ©: ${p.meta.repro || 'â€”'}`,
                    `Ù…ÙˆØ³Ù…: ${p.meta.season || 'â€”'}`,
                    `Ù…Ø¬Ù…ÙˆØ¹Ø©: ${p.meta.group || 'â€”'}`
                  ];
                  return lines;
                }
              }
            }
          },
          scales:{
            x:{ title:{ display:true, text:'Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ (DIM)' } },
            y:{ title:{ display:true, text:'Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ' } }
          },
          onClick:(_, elems)=>{
            if(!elems?.length) return;
            const d = elems[0];
            const meta = scatter.data.datasets[d.datasetIndex].data[d.index].meta;
            if(meta?.number){
              location.href = `cow-card.html?number=${encodeURIComponent(meta.number)}`;
            }
          }
        }
      });
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    async function loadReport(){
      try{
        statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦';
        await ensureAuth();
        const u = await uid(); if(!u){ showMsg('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.', true); return; }

        const refDate = refDateEl.value || todayISO();
        const monthFrom = startOfMonthISO(refDate);
        const monthTo   = endOfMonthISO(refDate);
        const yearFrom  = startOfYearISO(refDate);
        const yearTo    = endOfYearISO(refDate);
        const filterSp  = speciesSel.value;

        // ===== Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø³Ù†Ø© =====
        const evQ = query(
          collection(db,'events'),
          where('userId','==', u),
          where('eventDate','>=', yearFrom),
          where('eventDate','<=', yearTo),
          orderBy('eventDate','desc')
        );
        const snap = await getDocs(evQ);

        const daySum = { 'Ø£Ø¨Ù‚Ø§Ø±':0, 'Ø¬Ø§Ù…ÙˆØ³':0, total:0, count:0 };
        const monthSum = { 'Ø£Ø¨Ù‚Ø§Ø±':0, 'Ø¬Ø§Ù…ÙˆØ³':0, total:0 };
        const yearSum = { 'Ø£Ø¨Ù‚Ø§Ø±':0, 'Ø¬Ø§Ù…ÙˆØ³':0, total:0 };

        // Ø³Ù†Ø­ØªØ§Ø¬ Ù‡Ø°Ù‡ Ù„Ù„Ø³ÙƒØ§ØªØ± ÙˆÙ„Ù„ØªÙˆØ¨ 10
        const dayAnimals = new Map(); // number -> {milk, event}
        const seenNumbers = new Set();

        for (const d of snap.docs){
          const ev = d.data()||{};
          const type = (ev.eventType || ev.type || '').trim();
          const isMilkEv = /daily[_\s-]?milk|Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ|milk/i.test(type);
          if (!isMilkEv) continue;

          const evDate = ev.eventDate;
          const milk = readMilk(ev);
          const number = String(ev.animalNumber || ev.number || ev.animalNo || '');
          if (!milk || !number) continue;

          // Ø§Ù„Ù†ÙˆØ¹ (Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù„Ø­Ø¯Ø« Ù‡Ù†Ø¬ÙŠØ¨ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ù† animals Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©)
          let sp = String(ev.species || ev.animalTypeAr || ev.animalType || '').trim();
          if (sp==='cow' || /Ø¨Ù‚Ø±/i.test(sp)) sp='Ø£Ø¨Ù‚Ø§Ø±';
          else if (sp==='buffalo' || /Ø¬Ø§Ù…ÙˆØ³/i.test(sp)) sp='Ø¬Ø§Ù…ÙˆØ³';

          // ÙŠÙˆÙ…ÙŠ
          if (evDate===refDate){
            if(!sp){ // Ù…Ø¬Ù‡ÙˆÙ„ØŒ Ø³Ù†ÙƒÙ…Ù„Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ù†Ø¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³ÙƒØ§ØªØ±
              dayAnimals.set(number,{ milk, event:ev, species:null });
            }else if (speciesOK(filterSp, sp)){
              daySum[sp] = (daySum[sp]||0) + milk;
              daySum.total += milk;
              daySum.count += 1;
              dayAnimals.set(number,{ milk, event:ev, species:sp });
            }else{
              // Ù„Ùˆ Ø§Ù„Ù†ÙˆØ¹ Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ± ØªØ¬Ø§Ù‡Ù„Ù‡ Ù…Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ
              dayAnimals.set(number,{ milk, event:ev, species:sp }); // ÙŠØ¨Ù‚Ù‰ Ù„Ù„Ø³ÙƒØ§ØªØ± Ù„Ùˆ Ø£Ø±Ø¯Ù†Ø§
            }
          }

          // Ø´Ù‡Ø±ÙŠ
          if (evDate>=monthFrom && evDate<=monthTo){
            if (!sp){ /* Ø³Ù†ÙÙƒÙ…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§ */ }
            else if (speciesOK(filterSp, sp)){
              monthSum[sp] = (monthSum[sp]||0) + milk;
              monthSum.total += milk;
            }
          }

          // Ø³Ù†ÙˆÙŠ
          if (speciesOK(filterSp, sp)){
            yearSum[sp] = (yearSum[sp]||0) + milk;
            yearSum.total += milk;
          }

          seenNumbers.add(number);
        }

        // Ø¬Ù„Ø¨ Ø£Ù†ÙˆØ§Ø¹/ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù„Ù…Ù† Ù„Ø§ Ù†Ø¹Ø±Ù Ù†ÙˆØ¹Ù‡ Ø£Ùˆ Ù„Ù„Ù€ tooltip)
        const animalsMeta = new Map();
        for (const number of dayAnimals.keys()){
          try{
            const ad = await fetchAnimalDocByNumber(number);
            if (ad){
              const a = ad.data;
              animalsMeta.set(number, {
                species: normSpecies(a),
                group: a.group || a.groupName || a.pen || '',
                season: a.season || a.seasonName || '',
                repro: a.reproductiveStatus || a.reproStatus || ''
              });
            }else{
              animalsMeta.set(number, { species:'Ø£Ø¨Ù‚Ø§Ø±', group:'', season:'', repro:'' });
            }
          }catch{ animalsMeta.set(number, { species:'Ø£Ø¨Ù‚Ø§Ø±' }); }
        }

        // Ø£ÙƒÙ…Ù„ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ ÙˆØ£Ø¹Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±
        if (filterSp!=='all'){
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù…Ø¹ Ø¨Ø¹Ø¯ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
          daySum['Ø£Ø¨Ù‚Ø§Ø±']=0; daySum['Ø¬Ø§Ù…ÙˆØ³']=0; daySum.total=0; daySum.count=0;
          for (const [num, v] of dayAnimals.entries()){
            const sp = v.species || animalsMeta.get(num)?.species || 'Ø£Ø¨Ù‚Ø§Ø±';
            if (speciesOK(filterSp, sp) && v.event?.eventDate===refDate){
              daySum[sp] += v.milk; daySum.total += v.milk; daySum.count += 1;
            }
          }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
        document.getElementById('kDaily').textContent   = fmt(daySum.total,1);
        document.getElementById('kDailyBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${fmt(daySum['Ø£Ø¨Ù‚Ø§Ø±'],1)} â€” Ø¬Ø§Ù…ÙˆØ³: ${fmt(daySum['Ø¬Ø§Ù…ÙˆØ³'],1)}`;

        document.getElementById('kMonthly').textContent = fmt(monthSum.total,1);
        document.getElementById('kMonthlyBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${fmt(monthSum['Ø£Ø¨Ù‚Ø§Ø±'],1)} â€” Ø¬Ø§Ù…ÙˆØ³: ${fmt(monthSum['Ø¬Ø§Ù…ÙˆØ³'],1)}`;

        document.getElementById('kYearly').textContent  = fmt(yearSum.total,1);
        document.getElementById('kYearlyBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${fmt(yearSum['Ø£Ø¨Ù‚Ø§Ø±'],1)} â€” Ø¬Ø§Ù…ÙˆØ³: ${fmt(yearSum['Ø¬Ø§Ù…ÙˆØ³'],1)}`;

        const avg = daySum.count ? (daySum.total / daySum.count) : 0;
        document.getElementById('kAvg').textContent = fmt(avg,1);
        document.getElementById('kAvgNote').textContent = `Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ ${daySum.count} Ø­ÙŠÙˆØ§Ù† Ù„Ø¯ÙŠÙ‡ Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ….`;

        // ===== Scatter =====
        const dsCows = { label:'Ø£Ø¨Ù‚Ø§Ø±', data:[], pointRadius:5, showLine:false };
        const dsBuff = { label:'Ø¬Ø§Ù…ÙˆØ³', data:[], pointRadius:5, showLine:false };

        const rowsForTop = [];

        for (const [number, rec] of dayAnimals.entries()){
          const meta = animalsMeta.get(number) || {};
          const sp = meta.species || 'Ø£Ø¨Ù‚Ø§Ø±';

          if (!speciesOK(filterSp, sp)) continue;

          // DIM + Ø­Ø§Ù„Ø© ØªÙ†Ø§Ø³Ù„ÙŠØ©
          const facts = await fetchFacts(number, refDate);
          const dim = facts.dim ?? null;
          const season = meta.season || inferSeason(refDate);
          const point = {
            x: dim ?? 0,
            y: rec.milk,
            meta: {
              number, milk: rec.milk, dim,
              repro: facts.repro || meta.repro || '',
              season, group: meta.group || ''
            }
          };
          (sp==='Ø¬Ø§Ù…ÙˆØ³' ? dsBuff : dsCows).data.push(point);

          rowsForTop.push({
            number, species: sp, dim: dim ?? 'â€”',
            milk: rec.milk,
            repro: point.meta.repro || 'â€”',
            season, group: point.meta.group || 'â€”'
          });
        }

        drawScatter([dsCows, dsBuff]);

        // Top 10
        rowsForTop.sort((a,b)=>b.milk-a.milk);
        const tb = document.querySelector('#topTable tbody');
        tb.innerHTML = rowsForTop.slice(0,10).map(r=>`<tr>
          <td><a href="cow-card.html?number=${encodeURIComponent(r.number)}">${r.number}</a></td>
          <td>${r.species}</td><td>${r.dim}</td><td>${fmt(r.milk,1)}</td>
          <td>${r.repro}</td><td>${r.season}</td><td>${r.group}</td>
        </tr>`).join('');

        // ===== ØªÙƒÙ„ÙØ© ÙƒØ¬Ù… Ø§Ù„Ù„Ø¨Ù† Ù…Ù† Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø§ÙØ© (Ø´Ù‡Ø±ÙŠ) =====
        const nutritQ = query(
          collection(db,'events'),
          where('userId','==', u),
          where('eventDate','>=', monthFrom),
          where('eventDate','<=', monthTo),
          orderBy('eventDate','desc')
        );
        const nutritSnap = await getDocs(nutritQ);

        let dmCostTotal = 0, milkMonthTotal = monthSum.total;
        let mealsCount=0;

        for (const d of nutritSnap.docs){
          const ev = d.data()||{};
          const type = (ev.eventType || ev.type || '').trim();
          const isNut = /nutrition|ØªØºØ°ÙŠØ©/i.test(type);
          if (!isNut) continue;

          const intake = Number(ev.dmIntakeKg ?? ev.dmKg ?? ev.dm_intake);
          const costKg = Number(ev.dmCostPerKg ?? ev.rationCostPerKgDM ?? ev.dm_cost);

          if (isFinite(intake) && isFinite(costKg) && intake>0 && costKg>=0){
            dmCostTotal += (intake * costKg);
            mealsCount++;
          }
        }
        const costPerKg = (milkMonthTotal>0 && dmCostTotal>0) ? (dmCostTotal / milkMonthTotal) : 0;
        document.getElementById('kCostPerKg').textContent = costPerKg ? `${fmt(costPerKg,2)} / ÙƒØ¬Ù…` : 'â€”';
        document.getElementById('kCostDbg').textContent = `Ø³Ø¬Ù„Ø§Øª ØªØºØ°ÙŠØ© Ù…Ø­Ø³ÙˆØ¨Ø©: ${mealsCount} â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ø¨Ù† Ø§Ù„Ø´Ù‡Ø±: ${fmt(milkMonthTotal,0)} ÙƒØ¬Ù…`;

        statusEl.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-EG')}`;
        showMsg('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ± âœ…');
      }catch(e){
        console.error(e);
        showMsg('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.', true);
        statusEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
      }
    }

    function inferSeason(dateISO){
      const m = new Date(dateISO).getMonth()+1;
      // ØªÙ‚Ø³ÙŠÙ… Ù…Ø¨Ø³Ù‘Ø·
      if ([12,1,2].includes(m)) return 'Ø´ØªØ§Ø¡';
      if ([3,4,5].includes(m))  return 'Ø±Ø¨ÙŠØ¹';
      if ([6,7,8].includes(m))  return 'ØµÙŠÙ';
      return 'Ø®Ø±ÙŠÙ';
    }

    // Ø¥Ù‚Ù„Ø§Ø¹
    document.addEventListener('DOMContentLoaded', ()=>{
      const today = todayISO();
      refDateEl.value = today;
      loadReport();
    });
    refreshBtn.addEventListener('click', loadReport);
    refDateEl.addEventListener('change', loadReport);
    speciesSel.addEventListener('change', loadReport);
    unitSel.addEventListener('change', loadReport);
  </script>
</body>
</html>
