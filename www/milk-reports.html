<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù† â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</title>
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <style>
    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f6faf7; --text:#0f172a; --muted:#64748b; --card:#fff; --border:#e2e8f0; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Cairo',system-ui,Segoe UI,Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
    .bar{max-width:960px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title{font-weight:800;color:var(--green-600)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;font-weight:700;cursor:pointer}
    .chip.primary{background:var(--green);color:#fff;border-color:var(--green)}
    main{max-width:960px;margin:14px auto;padding:10px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){ .row{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:920px){ .row{grid-template-columns:repeat(3,1fr)} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi h3{margin:0;font-size:14px}
    .kpi .num{font-weight:900;font-size:22px}
    .kpi small{color:var(--muted)}
    .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:15px}
    .notice{margin:10px 0;padding:10px;border-radius:10px;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;font-weight:700;display:none}
    .ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    canvas{width:100%;height:320px;max-height:50vh}

    /* Ø§Ù„Ù‡ÙÙ†Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù„Ù„Ù†Ù‚Ø§Ø· */
    .hint{
      position:absolute; z-index:20; min-width:220px; max-width:90vw;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:#ffffff; box-shadow:0 8px 24px rgba(2,6,23,.15);
      font-size:14px; line-height:1.5; color:var(--text);
      pointer-events:auto; /* Ø¹Ù„Ø´Ø§Ù† ØªÙ‚Ø¯Ø± ØªØ¶ØºØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    }
    .hint .row{display:flex;gap:6px}
    .hint .k{color:#64748b;min-width:130px}
    .hint .actions{margin-top:8px;display:flex;gap:6px}
.hint .hint-line1{display:flex;gap:6px;align-items:center;flex-wrap:wrap;font-weight:800}
.hint .hint-line2{color:#64748b;margin-top:4px}

    .btn{appearance:none;border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:#f8fafc;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--green);border-color:#0ea05a;color:#fff}
    .btn.icon{padding:6px 8px}

    /* Ø´Ø§Ø±Ø© Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ± */
    .delta{display:inline-block;margin-inline-start:8px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);font-size:12px;font-weight:800}
    .delta.up{color:#065f46;background:#ecfdf5;border-color:#bbf7d0}
    .delta.down{color:#991b1b;background:#fef2f2;border-color:#fecaca}
    .delta.neutral{color:#64748b;background:#f1f5f9;border-color:#e2e8f0}
    /* Ù‡ÙÙ†Øª Ù…Ø³ØªÙ‚Ù„ Ù„Ø§ ÙŠØªØ£Ø«Ø± Ø¨ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØµÙØ­Ø© */
  .milk-hint{position:absolute;z-index:20;max-width:90vw;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:0 8px 24px rgba(2,6,23,.15);font-size:14px;line-height:1.45;color:var(--text);pointer-events:auto}
  .milk-hint .line1{display:flex;gap:6px;align-items:center;flex-wrap:wrap;font-weight:800}
  .milk-hint .line2{color:#64748b;margin-top:2px}
  .milk-hint .actions{display:flex;gap:6px;margin-top:6px;justify-content:flex-end}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="actions">
      <a class="chip" href="daily-milk.html">Ø¥Ø¯Ø®Ø§Ù„ ÙŠÙˆÙ…ÙŠ</a>
      <a class="chip" href="add-event.html">Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</a>
      <button id="btnRefresh" class="chip primary">ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </div>
</header>

<main>
  <div class="card inline" style="justify-content:space-between">
    <div class="inline">
      <label for="reportDate" style="font-weight:700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¶:</label>
      <input id="reportDate" type="date">
    </div>
    <div id="lastUpdate" class="inline" style="color:var(--muted);font-size:13px"></div>
  </div>

  <div id="msg" class="notice"></div>

  <div class="row" id="kpis">
    <div class="card kpi">
      <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="num" id="sumDay">â€” ÙƒØ¬Ù…
        <span id="sumDayDelta" class="delta neutral" title="Ø§Ù„ØªØºÙŠØ± Ø¹Ù† Ø¢Ø®Ø± ÙŠÙˆÙ… Ù…ØªØ§Ø­">â€”</span>
      </div>
      <small id="sumDayBreak">Ø£Ø¨Ù‚Ø§Ø±: â€” â€¢ Ø¬Ø§Ù…ÙˆØ³: â€”</small>
    </div>
    <div class="card kpi">
      <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±</h3>
      <div class="num" id="sumMonth">â€” ÙƒØ¬Ù…</div>
      <small id="sumMonthBreak">Ø£Ø¨Ù‚Ø§Ø±: â€” â€¢ Ø¬Ø§Ù…ÙˆØ³: â€”</small>
    </div>
    <div class="card kpi">
      <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†Ø©</h3>
      <div class="num" id="sumYear">â€” ÙƒØ¬Ù…</div>
      <small id="sumYearBreak">Ø£Ø¨Ù‚Ø§Ø±: â€” â€¢ Ø¬Ø§Ù…ÙˆØ³: â€”</small>
    </div>
    <div class="card kpi">
      <h3>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
      <div class="num" id="avgHerd">â€” ÙƒØ¬Ù…/Ø±Ø£Ø³</div>
      <small id="milkersCount">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ù‘Ø§Ø¨: â€” / Ø¥Ø¬Ù…Ø§Ù„ÙŠ: â€”</small>
    </div>
    <div class="card kpi">
      <h3>Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© ÙƒØ¬Ù… Ø§Ù„Ù„Ø¨Ù† (ØªØºØ°ÙŠØ©)</h3>
      <div class="num" id="feedCostPerKg">â€” Ø¬.Ù…/ÙƒØ¬Ù…</div>
      <small id="feedNote">ÙŠØªØ·Ù„Ø¨ Ø­Ø¯Ø« ØªØºØ°ÙŠØ© Ù„Ù„ÙŠÙˆÙ…</small>
    </div>
  </div>

  <div class="card" id="scatterWrap" style="position:relative">
    <h3 style="margin:0 0 8px 0">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£ÙØ±Ø§Ø¯ (Scatter): <span>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ (Ù…Ù† Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©)</span> Ã— <span>ÙƒØ¬Ù…/Ø§Ù„ÙŠÙˆÙ…</span></h3>
    <canvas id="scatter"></canvas>
    <small id="skipNote" style="color:#64748b"></small>

    <!-- Ø§Ù„Ù‡ÙÙ†Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ (Ù†Ø³Ø®Ø© Ù…Ø®ØªØµØ±Ø© ÙÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø·Ø©) -->
<div id="pointHint" class="milk-hint" hidden>
  <div class="line1">
    <strong id="hNo">#â€”</strong>
    <span>â€¢</span>
    <span id="hKg">â€” ÙƒØ¬Ù…/ÙŠÙˆÙ…</span>
    <span>â€¢</span>
    <span id="hDim">â€” ÙŠÙˆÙ…</span>
    <span id="hDelta" class="delta neutral" title="Ø§Ù„ØªØºÙŠØ±">â€”</span>
  </div>
  <div class="line2" id="hLine2"></div>
  <div class="actions">
    <button class="btn icon" id="btnCloseHint" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    <button class="btn primary" id="btnOpenCard">ÙØªØ­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
  </div>
</div>
</div>
      <div class="row"><div class="k">Ø±Ù‚Ù…:</div><div class="v" id="hNo">â€”</div></div>
      <div class="row"><div class="k">ÙƒØ¬Ù… Ø§Ù„ÙŠÙˆÙ…:</div><div class="v" id="hKg">â€”</div></div>
      <div class="row"><div class="k">Ø§Ù„ØªØºÙŠÙ‘Ø± Ø¹Ù† Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„:</div><div class="v" id="hDelta">â€”</div></div>
      <div class="row"><div class="k">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨:</div><div class="v" id="hDim">â€”</div></div>
      <div class="row"><div class="k">Ø­Ø§Ù„Ø© ØªÙ†Ø§Ø³Ù„ÙŠØ©:</div><div class="v" id="hRepro">â€”</div></div>
      <div class="row"><div class="k">Ø§Ù„Ù…ÙˆØ³Ù…:</div><div class="v" id="hSeason">â€”</div></div>
      <div class="row"><div class="k">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</div><div class="v" id="hGroup">â€”</div></div>
      <div class="actions">
        <button class="btn primary" id="btnOpenCard">ÙØªØ­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
      </div>
    </div>
  </div>
</main>

<script type="module" src="/js/firebase-config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script type="module">
  import { db, auth } from '/js/firebase-config.js';
  import {
    collection, query, where, orderBy, limit, getDocs,
    startAt, endBefore
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

  // ---------- Helpers ----------
  const $ = id => document.getElementById(id);
  const TYPES = ['Ù„Ø¨Ù† ÙŠÙˆÙ…ÙŠ','milk','daily_milk'];
  const CALVING_TYPES = ['ÙˆÙ„Ø§Ø¯Ø©','calving','Calving','birth','Birth','ÙˆÙ„Ø§Ø¯Ù‡','ÙˆÙ„Ø§Ø¯Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©'];
  const chunk = (arr, n=10)=>{ const out=[]; for(let i=0;i<arr.length;i+=n) out.push(arr.slice(i,i+n)); return out; };

  function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
  const ymd = d => /^\d{4}-\d{2}-\d{2}$/.test(d) ? d : todayISO();
  function daysBetweenISO(a,b){ const A=new Date(a), B=new Date(b); A.setHours(0,0,0,0); B.setHours(0,0,0,0); return Math.round((B-A)/86400000); }
  function addDaysISO(iso, n){ const d=new Date(iso); d.setDate(d.getDate()+n); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
  function monthBounds(dISO){ const d=new Date(dISO); d.setDate(1); const start = new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); const n=new Date(d); n.setMonth(n.getMonth()+1); n.setDate(1); const end=new Date(n.getTime()-n.getTimezoneOffset()*60000).toISOString().slice(0,10); return {start,end}; }
  function yearBounds(dISO){ const y=dISO.slice(0,4); return {start:`${y}-01-01`, end:`${+y+1}-01-01`}; }
  const normKind = v => /buffalo|Ø¬Ø§Ù…ÙˆØ³/i.test(v)? 'Ø¬Ø§Ù…ÙˆØ³':'Ø£Ø¨Ù‚Ø§Ø±';
  function show(msg, ok=false){ const el=$('msg'); el.style.display='block'; el.className='notice ' + (ok?'ok':''); el.textContent=msg; }
  function hideMsg(){ $('msg').style.display='none'; }

  async function getUid(){
    if (auth.currentUser) return auth.currentUser.uid;
    const u = await new Promise(res=>onAuthStateChanged(auth, x=>res(x)));
    return u?.uid || '';
  }

  // ---------- Milk queries ----------
  async function qLatestDate(uid){
    for (const withUser of [true,false]){
      for (const t of TYPES){
        const q1 = withUser && uid
          ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==',t), orderBy('eventDate','desc'), limit(1))
          : query(collection(db,'events'), where('eventType','==',t), orderBy('eventDate','desc'), limit(1));
        const s = await getDocs(q1);
        if (!s.empty) return s.docs[0].data().eventDate;
      }
    }
    return null;
  }

  async function qByDate(uid, dateISO){
    for (const withUser of [true,false]){
      let bag=[];
      for (const t of TYPES){
        const q1 = withUser && uid
          ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==',t), where('eventDate','==',dateISO), limit(500))
          : query(collection(db,'events'), where('eventType','==',t), where('eventDate','==',dateISO), limit(500));
        const s = await getDocs(q1);
        s.forEach(d=>bag.push(d.data()));
      }
      if (bag.length) return bag;
    }
    return [];
  }

  async function qByRange(uid, startISO, endISO){
    for (const withUser of [true,false]){
      let bag=[];
      for (const t of TYPES){
        const q1 = withUser && uid
          ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==',t), orderBy('eventDate'), startAt(startISO), endBefore(endISO))
          : query(collection(db,'events'), where('eventType','==',t), orderBy('eventDate'), startAt(startISO), endBefore(endISO));
        const s = await getDocs(q1);
        s.forEach(d=>bag.push(d.data()));
      }
      if (bag.length) return bag;
    }
    return [];
  }

  // ---------- Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø© (Ø¨Ø§Ù„Ø¬Ù…Ù„Ø©) ----------
  function toISOAny(v){
    if (!v) return null;
    if (typeof v==='string'){ const m = v.match(/^(\d{4}-\d{2}-\d{2})/); if (m) return m[1]; const d=new Date(v); if(!isNaN(d)) return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); return null; }
    if (typeof v==='number'){ const d=new Date(v); if(!isNaN(d)) return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    if (v?.seconds){ const d=new Date(v.seconds*1000); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    return null;
  }

  async function bulkAnimalsCalving(numbers){
    const out = new Map();
    const fields = ['animalNumber','number','animalNo'];
    for (const f of fields){
      for (const grp of chunk(numbers,10)){
        const q1 = query(collection(db,'animals'), where(f,'in', grp));
        const s = await getDocs(q1);
        s.forEach(doc=>{
          const data = doc.data()||{};
          const candidates = [data.lastCalving, data.lastCalvingDate, data.calvingDate, data.lastBirthDate, data.calvingAt, data.lastCalvingAt, data.calvingISO, data.lastCalvingISO];
          for (const c of candidates){
            const iso = toISOAny(c);
            if (iso){
              const num = String(data.animalNumber || data.number || data.animalNo || '').trim();
              if (num) {
                const prev = out.get(num);
                if (!prev || prev < iso) out.set(num, iso);
              }
              break;
            }
          }
        });
      }
    }
    return out;
  }

  async function bulkEventsCalving(uid, numbers){
    const out = new Map();
    for (const grp of chunk(numbers,10)){
      for (const t of CALVING_TYPES){
        const q1 = uid
          ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==',t), where('animalNumber','in', grp))
          : query(collection(db,'events'), where('eventType','==',t), where('animalNumber','in', grp));
        const s = await getDocs(q1);
        s.forEach(d=>{
          const ev = d.data()||{};
          const num = String(ev.animalNumber || ev.number || '').trim();
          const iso = ev.eventDate;
          if (num && iso){
            const prev = out.get(num);
            if (!prev || prev < iso) out.set(num, iso);
          }
        });
      }
    }
    return out;
  }

  async function buildDIMMap(uid, numbers){
    const nums = Array.from(new Set(numbers.filter(Boolean)));
    if (!nums.length) return new Map();
    const m1 = await bulkAnimalsCalving(nums);
    const missing = nums.filter(n => !m1.has(n));
    if (!missing.length) return m1;
    const m2 = await bulkEventsCalving(uid, missing);
    m2.forEach((v,k)=> m1.set(k,v));
    return m1;
  }

  // ---------- Ø®Ø±ÙŠØ·Ø© â€œØ§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©â€ Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„ØªØºÙŠÙŠØ± ----------
  async function buildPrevMap(uid, dateISO, numbers){
    const start = addDaysISO(dateISO, -7);
    const rows = await qByRange(uid, start, dateISO); // Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ÙŠÙˆÙ…
    const map = new Map(); // number -> {kg, date}
    for (const r of rows){
      const num = String(r.animalNumber || r.number || '').trim();
      const kg  = Number(r.milkKg || r.milk || 0) || 0;
      const dt  = r.eventDate;
      if (!num || !dt) continue;
      const cur = map.get(num);
      if (!cur || cur.date < dt) map.set(num, { kg, date: dt });
    }
    numbers.forEach(n => { if (!map.has(n)) map.set(n, null); });
    return map;
  }

  // ---------- Scatter + Ù‡ÙÙ†Øª Ø¹Ø§Ø¦Ù… (Ù…Ù„Ø®Øµ ÙÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø·Ø©) ----------
let scatterChart;

const hintEl = document.getElementById('pointHint');
let lastMeta = null;
let hintPinned = false;
let hideT;

function fillHint(meta){
  const num = meta.number ?? 'â€”';
  const kg  = meta.kg != null ? `${meta.kg} ÙƒØ¬Ù…/ÙŠÙˆÙ…` : 'â€” ÙƒØ¬Ù…/ÙŠÙˆÙ…';
  const dim = meta.dim != null ? `${meta.dim} ÙŠÙˆÙ…` : 'â€” ÙŠÙˆÙ…';
  document.getElementById('hNo').textContent  = `#${num}`;
  document.getElementById('hKg').textContent  = kg;
  document.getElementById('hDim').textContent = dim;
  const d = meta.deltaPct; const deltaEl = document.getElementById('hDelta');
  if (d==null || Number.isNaN(d)) { deltaEl.textContent='â€”'; deltaEl.className='delta neutral'; }
  else { const trend=d>0?'up':(d<0?'down':'neutral'); deltaEl.textContent=`${d>0?'+':''}${d.toFixed(1)}%`; deltaEl.className=`delta ${trend}`; }
  const parts=[]; if(meta.group&&meta.group!=='â€”')parts.push(meta.group); if(meta.repro&&meta.repro!=='â€”')parts.push(meta.repro); if(meta.season&&meta.season!=='â€”')parts.push(meta.season);
  const l2=document.getElementById('hLine2'); if(parts.length){ l2.textContent=parts.join(' â€¢ '); l2.style.display='block'; } else { l2.textContent=''; l2.style.display='none'; }
}

function placeHintAtPoint(chart, x, y){
  const prevVis = hintEl.style.visibility; hintEl.style.visibility='hidden'; hintEl.hidden=false;
  const rect = chart.canvas.getBoundingClientRect();
  const W = hintEl.offsetWidth; const H = hintEl.offsetHeight;
  let left = rect.left + window.scrollX + x - W/2;
  let top  = rect.top  + window.scrollY + y - H - 12;
  const minLeft = rect.left + window.scrollX + 4; const maxLeft = rect.right + window.scrollX - W - 4; left = Math.min(Math.max(left,minLeft),maxLeft);
  const minTop  = rect.top  + window.scrollY + 4; if(top < minTop){ top = rect.top + window.scrollY + y + 12; }
  hintEl.style.left = left + 'px'; hintEl.style.top  = top + 'px'; hintEl.style.visibility=prevVis;
}

hintEl.addEventListener('mouseenter', ()=>{ hintPinned=true; clearTimeout(hideT); });
hintEl.addEventListener('mouseleave', ()=>{ hintPinned=false; clearTimeout(hideT); hideT=setTimeout(()=>{ if(!hintPinned) hintEl.hidden=true; }, 200); });

function externalTooltipHandler(ctx){
  const { chart, tooltip } = ctx;
  if (!tooltip || tooltip.opacity === 0){ clearTimeout(hideT); hideT=setTimeout(()=>{ if(!hintPinned) hintEl.hidden=true; }, 200); return; }
  const dp = tooltip.dataPoints?.[0]; if (!dp) return;
  const meta = dp.raw?._meta || {}; lastMeta = meta; fillHint(meta);
  const { x, y } = dp.element; placeHintAtPoint(chart, x, y); hintEl.hidden=false;
}

function drawScatter(points){
  const canvas = document.getElementById('scatter'); if (!canvas) return;
  if (scatterChart){ try{ scatterChart.destroy(); }catch{} scatterChart = null; }
  const maxY = Math.max(0, ...points.map(p=>Number(p.kg)||0)); const yMax = Math.max(10, Math.ceil((maxY+1)/5)*5);
  const maxX = Math.max(0, ...points.map(p=>Number(p.dim)||0)); const xMax = Math.max(30, Math.ceil((maxX+1)/30)*30);

  scatterChart = new Chart(canvas, { type:'scatter', data:{ datasets:[{ label:'Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù‚Ø·ÙŠØ¹', data: points.map(p=>({x:p.dim,y:p.kg,_meta:p})), pointRadius:5, pointHoverRadius:10, pointHitRadius:28 }] },
    options:{ responsive:true, maintainAspectRatio:false, parsing:false,
      interaction:{ mode:'nearest', intersect:false, axis:'xy' },
      plugins:{ legend:{display:false}, tooltip:{ enabled:false, external: externalTooltipHandler, position:'nearest' } },
      scales:{ x:{ title:{display:true,text:'Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ (Ù…Ù† Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©)'}, beginAtZero:true, min:0, suggestedMax:xMax, ticks:{ stepSize:30, precision:0 } },
              y:{ beginAtZero:true, min:0, suggestedMax:yMax, ticks:{ stepSize:5, precision:0, callback:v=>`${v} ÙƒØ¬Ù…` } } },
      onHover:(evt,els)=>{ const el=evt?.native?.target; if(el) el.style.cursor = els?.length ? 'pointer' : 'default'; },
      onClick:(evt, els, chartInstance)=>{ const pts=chartInstance.getElementsAtEventForMode(evt,'nearest',{intersect:false},true); if(!pts?.length) return; const p=pts[0]; const raw=chartInstance.data.datasets[p.datasetIndex].data[p.index]; const meta=raw?._meta||{}; lastMeta=meta; fillHint(meta); placeHintAtPoint(chartInstance,p.element.x,p.element.y); hintEl.hidden=false; hintPinned=true; },
      events:['mousemove','pointermove','mouseout','mouseleave','click','touchstart','touchmove','touchend']
    }
  });

  const handlePointer=(evt,pin=false)=>{ const pts=scatterChart.getElementsAtEventForMode(evt,'nearest',{intersect:false},true); if(!pts?.length){ if(!hintPinned) hintEl.hidden=true; return;} const p=pts[0]; const raw=scatterChart.data.datasets[p.datasetIndex].data[p.index]; const meta=raw?._meta||{}; lastMeta=meta; fillHint(meta); placeHintAtPoint(scatterChart,p.element.x,p.element.y); hintEl.hidden=false; if(pin) hintPinned=true; };
  canvas.addEventListener('touchstart', e=>handlePointer(e,false), {passive:true});
  canvas.addEventListener('touchmove',  e=>handlePointer(e,false), {passive:true});
  canvas.addEventListener('click',      e=>handlePointer(e,true));
  canvas.addEventListener('mouseleave', ()=>{ if(!hintPinned) hintEl.hidden=true; }, {passive:true});
  canvas.addEventListener('touchend',   ()=>{ if(!hintPinned) hintEl.hidden=true; }, {passive:true});
}

// ---------- KPIs ----------
  function splitByKind(rows){
    const o={all:0,cow:0,buff:0};
    for (const r of rows){
      const kg = Number(r.milkKg || r.milk || 0) || 0;
      const k  = normKind(r.kind || r.species || r.animalType || r.animalTypeAr || '');
      o.all += kg; if (k==='Ø¬Ø§Ù…ÙˆØ³') o.buff += kg; else o.cow += kg;
    }
    return o;
  }

  function setDayDeltaBadge(todayTotal, prevTotal, prevDate){
    const el = $('sumDayDelta');
    if (!prevTotal || prevTotal<=0){ el.textContent='â€”'; el.className='delta neutral'; el.title='Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙŠÙˆÙ… Ø³Ø§Ø¨Ù‚ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©'; return; }
    const pct = ((todayTotal - prevTotal) / prevTotal) * 100;
    const txt = (pct>0?'+':'') + pct.toFixed(1) + '%';
    el.textContent = txt;
    el.title = `Ù…Ù‚Ø§Ø±Ù†Ø©Ù‹ Ø¨ÙŠÙˆÙ… ${prevDate}`;
    el.className = 'delta ' + (pct>0 ? 'up' : (pct<0 ? 'down' : 'neutral'));
  }

  function putKpis(dayRows, monthRows, yearRows, totalAnimals, prevTotal, prevDate){
    const d = splitByKind(dayRows), m = splitByKind(monthRows), y = splitByKind(yearRows);
    $('sumDay').firstChild.nodeValue = `${(d.all||0).toLocaleString()} ÙƒØ¬Ù…`; // Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø±Ø©
    setDayDeltaBadge(d.all||0, prevTotal||0, prevDate||'â€”');

    $('sumDayBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${d.cow||0} â€¢ Ø¬Ø§Ù…ÙˆØ³: ${d.buff||0}`;
    $('sumMonth').textContent    = `${(m.all||0).toLocaleString()} ÙƒØ¬Ù…`;
    $('sumMonthBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${m.cow||0} â€¢ Ø¬Ø§Ù…ÙˆØ³: ${m.buff||0}`;
    $('sumYear').textContent     = `${(y.all||0).toLocaleString()} ÙƒØ¬Ù…`;
    $('sumYearBreak').textContent  = `Ø£Ø¨Ù‚Ø§Ø±: ${y.cow||0} â€¢ Ø¬Ø§Ù…ÙˆØ³: ${y.buff||0}`;

    const milkers = dayRows.length;
    $('avgHerd').textContent = milkers ? `${(d.all/milkers).toFixed(1)} ÙƒØ¬Ù…/Ø±Ø£Ø³` : 'â€” ÙƒØ¬Ù…/Ø±Ø£Ø³';
    $('milkersCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ù‘Ø§Ø¨: ${milkers} / Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalAnimals ?? 'â€”'}`;
  }

  // ---------- Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… ----------
  async function buildScatter(uid, dateISO, rows, prevMap, dimMap){
    let skipped = 0;
    const pts=[];
    for (const r of rows){
      const number = String(r.animalNumber || r.number || '').trim();
      const kg = Number(r.milkKg || r.milk || 0) || 0;

      const dimISO = dimMap.get(number);
      if (!dimISO){ skipped++; continue; }
      const dim = daysBetweenISO(dimISO, dateISO);

      const prev = prevMap.get(number);
      const prevKg = prev?.kg ?? null;
      const deltaPct = (prevKg && prevKg>0) ? ((kg - prevKg) / prevKg) * 100 : null;

      const repro = (r.reproStatus || r.reproductiveStatus || r.repro || 'â€”');
      const group = (r.group || r.groupName || 'â€”');
      const m = dateISO.slice(5,7);
      const season = (['12','01','02'].includes(m))? 'Ø´ØªØ§Ø¡' : (['03','04','05'].includes(m)?'Ø±Ø¨ÙŠØ¹': (['06','07','08'].includes(m)?'ØµÙŠÙ':'Ø®Ø±ÙŠÙ'));

      pts.push({number, kg, dim, repro, season, group, deltaPct});
    }
    $('skipNote').textContent = skipped ? `ØªÙ… Ø¥Ø®ÙØ§Ø¡ ${skipped} Ø­ÙŠÙˆØ§Ù†/Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù„Ø¹Ø¯Ù… ØªÙˆÙØ± ØªØ§Ø±ÙŠØ® ÙˆÙ„Ø§Ø¯Ø© Ù„Ø¯ÙŠÙ‡Ù….` : '';
    drawScatter(pts);
  }

  // ---------- ØªØºØ°ÙŠØ© ----------
  async function qFeedForDay(uid, dateISO){
    for (const withUser of [true,false]){
      const q1 = withUser && uid
        ? query(collection(db,'events'), where('userId','==',uid), where('eventType','==','ØªØºØ°ÙŠØ©'), where('eventDate','==',dateISO), limit(50))
        : query(collection(db,'events'), where('eventType','==','ØªØºØ°ÙŠØ©'), where('eventDate','==',dateISO), limit(50));
      const s = await getDocs(q1); const rows=[]; s.forEach(d=>rows.push(d.data()));
      if (rows.length) return rows;
    }
    return [];
  }
  async function calcFeedCost(uid, dateISO, dayRows){
    const milkTotal = dayRows.reduce((s,r)=>s + (Number(r.milkKg||r.milk||0)||0), 0);
    const feeds = await qFeedForDay(uid, dateISO);
    if (!milkTotal || !feeds.length){ $('feedCostPerKg').textContent='â€” Ø¬.Ù…/ÙƒØ¬Ù…'; $('feedNote').textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºØ°ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…'; return; }
    let totalCost = 0; feeds.forEach(f=> totalCost += Number(f.totalCost || f.cost || f.feedCost || 0) || 0);
    if (!totalCost){ $('feedCostPerKg').textContent='â€” Ø¬.Ù…/ÙƒØ¬Ù…'; $('feedNote').textContent='ÙŠÙÙ„Ø²Ù… ØªÙˆÙØ± ØªÙƒÙ„ÙØ© Ø§Ù„ØªØºØ°ÙŠØ© (totalCost)'; return; }
    $('feedCostPerKg').textContent = `${(totalCost/milkTotal).toFixed(2)} Ø¬.Ù…/ÙƒØ¬Ù…`;
    $('feedNote').textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© ØªØºØ°ÙŠØ© Ø§Ù„ÙŠÙˆÙ…: ${totalCost.toFixed(0)} Ø¬.Ù…`;
  }

  // ---------- ØªØ­Ù…ÙŠÙ„ ----------
  async function loadAll(){
    hintEl.hidden = true; hideMsg();
    const uid = await getUid();
    const requested = ymd($('reportDate').value || todayISO());
    let dayRows = await qByDate(uid, requested);

    if (!dayRows.length){
      const last = await qLatestDate(uid);
      if (last){
        $('reportDate').value = last;
        dayRows = await qByDate(uid, last);
        show(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¨Ù† Ù„Ù„ÙŠÙˆÙ… ${requested}. ØªÙ… Ø¹Ø±Ø¶ Ø¢Ø®Ø± ÙŠÙˆÙ… Ù…ØªØ§Ø­: ${last}.`);
      }else{
        show('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¨Ù† Ù…Ø­ÙÙˆØ¸Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.');
      }
    }

    const dateISO = $('reportDate').value || requested;

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ø­ØªÙ‰ 7 Ø£ÙŠØ§Ù… Ù„Ù„Ø®Ù„Ù)
    let prevDate = addDaysISO(dateISO, -1);
    let prevRows = await qByDate(uid, prevDate);
    for (let i=2; i<=7 && !prevRows.length; i++){
      prevDate = addDaysISO(dateISO, -i);
      prevRows = await qByDate(uid, prevDate);
    }
    const prevTotal = prevRows.reduce((s,r)=> s + (Number(r.milkKg||r.milk||0)||0), 0);

    // Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©
    const {start:ms, end:me} = monthBounds(dateISO);
    const {start:ys, end:ye} = yearBounds(dateISO);
    const monthRows = await qByRange(uid, ms, me);
    const yearRows  = await qByRange(uid, ys, ye);

    // Ø®Ø±Ø§Ø¦Ø· DIM ÙˆØ§Ù„Ù‚ÙŠÙÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    const numbers = dayRows.map(r => String(r.animalNumber || r.number || '').trim()).filter(Boolean);
    const [dimMap, prevMap] = await Promise.all([
      buildDIMMap(uid, numbers),
      buildPrevMap(uid, dateISO, numbers)
    ]);

    putKpis(dayRows, monthRows, yearRows, undefined, prevTotal, prevDate);
    await buildScatter(uid, dateISO, dayRows, prevMap, dimMap);
    await calcFeedCost(uid, dateISO, dayRows);

    $('lastUpdate').textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString()}`;
  }

  (function init(){
    const qs = new URLSearchParams(location.search);
    const dt = qs.get('date') || qs.get('eventDate') || todayISO();
    $('reportDate').value = ymd(dt);
    $('reportDate').addEventListener('change', loadAll, {passive:true});
    $('btnRefresh').addEventListener('click', loadAll, {passive:true});

    // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‡ÙÙ†Øª ÙˆÙØªØ­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    $('btnCloseHint')?.addEventListener('click', ()=>{
      hintPinned = false;
      hintEl.hidden = true;
    });

    $('btnOpenCard')?.addEventListener('click', ()=> {
      if (lastMeta?.number) location.href = `cow-card.html?number=${encodeURIComponent(lastMeta.number)}`;
    });

    loadAll();
  })();
</script>
</body>
</html>
