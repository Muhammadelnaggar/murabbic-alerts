<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تقرير اللبن — مُرَبِّك</title>
  <link rel="stylesheet" href="css/forms.css" />
  <script type="module" src="js/forms-init.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Cairo','Segoe UI',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0}
    .bar{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title{font-weight:800;color:var(--green-600);font-size:clamp(16px,2.5vw,22px)}
    main{max-width:1100px;margin:16px auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:grid;gap:12px}
    .row.cols-5{grid-template-columns:repeat(5,1fr)}
    @media(max-width:900px){ .row.cols-5{grid-template-columns:1fr 1fr} }
    @media(max-width:520px){ .row.cols-5{grid-template-columns:1fr} }
    label{font-weight:700;font-size:14px}
    input,select,button{font-size:16px}
    input,select{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
    .metric{display:flex;flex-direction:column;gap:6px;padding:12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
    .metric .k{font-size:clamp(18px,4.6vw,26px);font-weight:900}
    .muted{color:#64748b}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2f7;color:#0f172a;font-weight:700;border:1px solid #cbd5e1}
    .infobar{display:none;margin-top:8px;padding:10px;border-radius:10px;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .infobar.show{display:block}
    .error{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .chart-wrap{height:360px}
    @media(max-width:600px){ .chart-wrap{height:260px} }
    canvas{background:#fff;border:1px solid #e2e8f0;border-radius:12px}
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;white-space:nowrap}
  </style>
</head>
<body>
  <script>window.dataLayer = window.dataLayer || [];</script>
  <header>
    <div class="bar">
      <div class="title">📊 تقرير اللبن</div>
      <div class="actions">
        <a class="badge" href="daily-milk.html">إدخال لبن يومي</a>
        <a class="badge" href="add-event.html">الأحداث</a>
      </div>
    </div>
  </header>

  <main>
    <!-- فلاتر -->
    <div class="card">
      <div class="row cols-5">
        <div>
          <label>تاريخ العرض</label>
          <input id="refDate" type="date" />
        </div>
        <div>
          <label>نوع القطيع</label>
          <select id="speciesFilter">
            <option value="all">الكل</option>
            <option value="أبقار">أبقار</option>
            <option value="جاموس">جاموس</option>
          </select>
        </div>
        <div>
          <label>الوحدة</label>
          <select id="unitSel">
            <option value="kg">كجم</option>
            <option value="l">لتر</option>
          </select>
        </div>
        <div style="align-self:end">
          <button id="refreshBtn" class="badge">تحديث 🔄</button>
        </div>
        <div style="align-self:end">
          <span id="status" class="muted"></span>
        </div>
      </div>
      <div id="msg" class="infobar"></div>
    </div>

    <!-- مؤشرات -->
    <div class="card">
      <div class="row">
        <div class="metric">
          <div class="muted">إجمالي اليوم</div>
          <div class="k" id="kDaily">—</div>
          <div class="muted" id="kDailyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">إجمالي الشهر</div>
          <div class="k" id="kMonthly">—</div>
          <div class="muted" id="kMonthlyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">إجمالي السنة</div>
          <div class="k" id="kYearly">—</div>
          <div class="muted" id="kYearlyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">متوسط القطيع اليومي</div>
          <div class="k" id="kAvg">—</div>
          <div class="muted" id="kAvgNote"></div>
        </div>
      </div>
    </div>

    <!-- الرسم -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><b>Scatter</b> — (X) أيام الحليب — (Y) الإنتاج اليومي</div>
        <div class="muted">اضغط على النقطة لفتح بطاقة الحيوان</div>
      </div>
      <div class="chart-wrap"><canvas id="scatterChart"></canvas></div>
    </div>

    <!-- تكلفة كجم اللبن من المادة الجافة -->
    <div class="card">
      <div class="row">
        <div class="metric">
          <div class="muted">متوسط تكلفة كجم اللبن (شهر التقرير)</div>
          <div class="k" id="kCostPerKg">—</div>
          <div class="muted" id="kCostNote">تحسب من (dmIntakeKg × dmCostPerKg) ÷ إجمالي اللبن.</div>
        </div>
        <div class="metric">
          <div class="muted">ملخص التغذية</div>
          <div class="muted" id="kCostDbg">—</div>
        </div>
      </div>
    </div>

    <!-- أعلى 10 -->
    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">أعلى 10 أفراد حسب الإنتاج اليومي</div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>رقم</th><th>النوع</th><th>DIM</th><th>إنتاج اليوم</th><th>حالة تناسلية</th><th>موسم</th><th>مجموعة</th></tr></thead>
          <tbody id="topBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Firebase -->
  <script type="module" src="/js/firebase-config.js"></script>
  <script src="/js/app-core.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>

  <!-- منطق الصفحة -->
  <script type="module">
    import { db, auth, ensureAuth } from '/js/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // عناصر
    const refDateEl = document.getElementById('refDate');
    const speciesSel = document.getElementById('speciesFilter');
    const unitSel = document.getElementById('unitSel');
    const refreshBtn = document.getElementById('refreshBtn');
    const msg = document.getElementById('msg');
    const statusEl = document.getElementById('status');
    const topBody = document.getElementById('topBody');

    // أدوات
    function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    function startOfMonthISO(d){ const x=new Date(d); x.setDate(1); return x.toISOString().slice(0,10) }
    function endOfMonthISO(d){ const x=new Date(d); x.setMonth(x.getMonth()+1); x.setDate(0); return x.toISOString().slice(0,10) }
    function startOfYearISO(d){ const x=new Date(d); x.setMonth(0,1); return x.toISOString().slice(0,10) }
    function endOfYearISO(d){ const x=new Date(d); x.setMonth(12,0); return x.toISOString().slice(0,10) }
    function daysBetweenISO(a,b){ const A=new Date(a), B=new Date(b); A.setHours(0,0,0,0); B.setHours(0,0,0,0); return Math.round((B-A)/86400000); }
    function fmt(n,dec=1){ if(n==null||isNaN(n)) return '—'; return Number(n).toLocaleString('ar-EG',{maximumFractionDigits:dec,minimumFractionDigits:dec}); }
    function showMsg(t,isErr=false){ msg.className='infobar '+(isErr?'show error':'show'); msg.innerHTML=(isErr?'❌ ':'✅ ')+t; }

    async function uid(){ if(auth.currentUser) return auth.currentUser.uid; return new Promise(r=>onAuthStateChanged(auth,u=>r(u?.uid||''))); }

    function normSpecies(data){
      const s = String(data?.animalTypeAr || data?.animalType || data?.species || '').trim();
      if (s==='cow' || /بقر/i.test(s)) return 'أبقار';
      if (s==='buffalo' || /جاموس/i.test(s)) return 'جاموس';
      return s || 'أبقار';
    }

    // آخر يوم لبن متاح (بصرف النظر عن refDate)
    async function findLatestMilkDate(u){
      const evQ = query(collection(db,'events'), where('userId','==',u), orderBy('eventDate','desc'), limit(400));
      const snap = await getDocs(evQ);
      for (const d of snap.docs){
        const ev = d.data()||{};
        const type = (ev.eventType || ev.type || '').trim();
        if (/daily[_\s-]?milk|إنتاج اللبن اليومي|milk/i.test(type)) return ev.eventDate;
      }
      return null;
    }

    async function hasMilkForDate(u, dateISO){
      const q1 = query(collection(db,'events'), where('userId','==',u), where('eventDate','==',dateISO), limit(200));
      const s = await getDocs(q1);
      for (const d of s.docs){
        const ev = d.data()||{}; const type = (ev.eventType||ev.type||'').trim();
        if (/daily[_\s-]?milk|إنتاج اللبن اليومي|milk/i.test(type)) return true;
      }
      return false;
    }

    // جلب وثيقة الحيوان (للتفاصيل)
    async function fetchAnimalDocByNumber(number){
      const tries = [['animalNumber','==',number],['number','==',number],['animalNo','==',number]];
      for (const [f,op,val] of tries){
        const s = await getDocs(query(collection(db,'animals'), where(f,op,val), limit(1)));
        if (!s.empty){ const d=s.docs[0]; return { id:d.id, data:d.data()||{} }; }
      }
      return null;
    }

    // حقول اللبن
    function readMilk(ev){
      const v = ev.milkKg ?? ev.milk ?? ev.yieldKg ?? ev.yield ?? ev.liters;
      const n = Number(v);
      return isFinite(n) ? n : 0;
    }

    function speciesOK(filter, sp){ if (filter==='all') return true; return sp===filter; }

    // Scatter
    let scatter;
    function drawScatter(datasets){
      const ctx = document.getElementById('scatterChart').getContext('2d');
      if (scatter) scatter.destroy();
      scatter = new Chart(ctx,{
        type:'scatter',
        data:{ datasets },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ display:true, labels:{ usePointStyle:true } },
            tooltip:{ callbacks:{ label:(ctx)=> {
              const p=ctx.raw.meta;
              return [`رقم: ${p.number}`, `DIM: ${p.dim ?? '—'}`, `إنتاج: ${fmt(p.milk,1)}`, `حالة: ${p.repro||'—'}`, `موسم: ${p.season||'—'}`, `مجموعة: ${p.group||'—'}`];
            }}}
          },
          scales:{ x:{ title:{display:true,text:'أيام الحليب (DIM)'}}, y:{ title:{display:true,text:'الإنتاج اليومي'} } },
          onClick:(_,els)=>{ if(!els?.length) return; const m=scatter.data.datasets[els[0].datasetIndex].data[els[0].index].meta; if(m?.number){ location.href=`cow-card.html?number=${encodeURIComponent(m.number)}`; } }
        }
      });
    }

    // تقدير عدد الحلّاب من animals
    async function countLactating(u, filterSp){
      const s = await getDocs(query(collection(db,'animals'), where('userId','==',u), limit(1000)));
      let n=0, total=0;
      s.forEach(doc=>{
        const a=doc.data()||{}; total++;
        const sp = normSpecies(a);
        if (!speciesOK(filterSp, sp)) return;
        const rs = String(a.reproductiveStatus||a.reproStatus||a.milkStatus||a.status||'').trim();
        if (/حلاب|حليب|lact|milk/i.test(rs)) n++;
      });
      return { lactating:n, herd: total };
    }

    async function loadReport(){
      try{
        msg.className='infobar'; msg.innerHTML=''; topBody.innerHTML='';
        statusEl.textContent='جاري التحميل…';
        await ensureAuth();
        const u = await uid(); if(!u){ showMsg('سجّل الدخول أولًا.', true); return; }

        // اختر تاريخ التقرير: المستخدَم أو آخر متاح
        let refDate = refDateEl.value || todayISO();
        if (!(await hasMilkForDate(u, refDate))){
          const last = await findLatestMilkDate(u);
          if (last){ refDate = last; refDateEl.value = last; }
        }

        const monthFrom = startOfMonthISO(refDate);
        const monthTo   = endOfMonthISO(refDate);
        const yearFrom  = startOfYearISO(refDate);
        const yearTo    = endOfYearISO(refDate);
        const filterSp  = speciesSel.value;

        // اجلب كل أحداث السنة ثم فلتر محليًا (بسيط وسريع للحيازات الصغيرة)
        const evQ = query(collection(db,'events'), where('userId','==',u), orderBy('eventDate','desc'), limit(2000));
        const snap = await getDocs(evQ);

        const daySum = { 'أبقار':0, 'جاموس':0, total:0, count:0 };
        const monthSum = { 'أبقار':0, 'جاموس':0, total:0 };
        const yearSum = { 'أبقار':0, 'جاموس':0, total:0 };
        const dayAnimals = new Map();

        for (const d of snap.docs){
          const ev=d.data()||{};
          const type = (ev.eventType||ev.type||'').trim();
          if (!/daily[_\s-]?milk|إنتاج اللبن اليومي|milk/i.test(type)) continue;

          const evDate = ev.eventDate;
          const milk = readMilk(ev);
          const number = String(ev.animalNumber || ev.number || ev.animalNo || '');
          if (!milk || !number) continue;

          let sp = String(ev.species || ev.animalTypeAr || ev.animalType || '').trim();
          if (sp==='cow' || /بقر/i.test(sp)) sp='أبقار';
          else if (sp==='buffalo' || /جاموس/i.test(sp)) sp='جاموس';

          // يوم التقرير
          if (evDate===refDate){
            dayAnimals.set(number,{ milk, species:sp });
            if (!sp) continue;
            if (speciesOK(filterSp, sp)){ daySum[sp]=(daySum[sp]||0)+milk; daySum.total+=milk; daySum.count++; }
          }

          // شهري/سنوي
          if (speciesOK(filterSp, sp)){
            if (evDate>=monthFrom && evDate<=monthTo){ monthSum[sp]=(monthSum[sp]||0)+milk; monthSum.total+=milk; }
            if (evDate>=yearFrom  && evDate<=yearTo ){ yearSum[sp]=(yearSum[sp]||0)+milk; yearSum.total+=milk; }
          }
        }

        // لو مفيش أي بيانات لهذا اليوم — أعرض تنبيه وعدّاد الحلّاب
        if (dayAnimals.size===0){
          const { lactating, herd } = await countLactating(u, filterSp);
          showMsg(`لا توجد سجلات لبن لليوم ${refDate}. آخر متاح تم اختياره تلقائيًا. عدد الحلّاب التقريبي: ${lactating} من إجمالي القطيع ${herd}.`, true);
        } else {
          showMsg(`تم التحميل ليوم ${refDate} ✅`);
        }

        // استكمال بيانات الحيوانات للرسم
        const animalsMeta = new Map();
        for (const num of dayAnimals.keys()){
          const ad = await fetchAnimalDocByNumber(num);
          animalsMeta.set(num, ad ? {
            species: normSpecies(ad.data),
            group: ad.data.group || ad.data.groupName || ad.data.pen || '',
            season: ad.data.season || ad.data.seasonName || '',
            repro: ad.data.reproductiveStatus || ad.data.reproStatus || ''
          } : { species:'أبقار', group:'', season:'', repro:'' });
        }

        // تحديث المؤشرات
        document.getElementById('kDaily').textContent   = fmt(daySum.total,1);
        document.getElementById('kDailyBreak').textContent = `أبقار: ${fmt(daySum['أبقار'],1)} — جاموس: ${fmt(daySum['جاموس'],1)}`;
        document.getElementById('kMonthly').textContent = fmt(monthSum.total,1);
        document.getElementById('kMonthlyBreak').textContent = `أبقار: ${fmt(monthSum['أبقار'],1)} — جاموس: ${fmt(monthSum['جاموس'],1)}`;
        document.getElementById('kYearly').textContent  = fmt(yearSum.total,1);
        document.getElementById('kYearlyBreak').textContent = `أبقار: ${fmt(yearSum['أبقار'],1)} — جاموس: ${fmt(yearSum['جاموس'],1)}`;

        const avg = daySum.count ? (daySum.total/daySum.count) : 0;
        document.getElementById('kAvg').textContent = fmt(avg,1);
        document.getElementById('kAvgNote').textContent = `على ${daySum.count} سجل لبن يومي.`;

        // Scatter + Top10
        const dsCows={label:'أبقار',data:[],pointRadius:5,showLine:false};
        const dsBuff={label:'جاموس',data:[],pointRadius:5,showLine:false};
        const rows=[];

        for (const [number, v] of dayAnimals.entries()){
          const meta = animalsMeta.get(number)||{};
          const sp = meta.species || 'أبقار';
          if (!speciesOK(speciesSel.value, sp)) continue;

          // حساب DIM من آخر ولادة (سريع عبر events المرتبة)
          let dim=null, repro=meta.repro||'';
          const evQ2 = query(collection(db,'events'), where('userId','==',u), where('animalNumber','==',number), orderBy('eventDate','desc'), limit(40));
          const s2 = await getDocs(evQ2);
          for (const d of s2.docs){
            const ev=d.data()||{}; const t=(ev.eventType||ev.type||'').trim();
            if (!dim && (t==='ولادة'||t==='calving')) dim = Math.max(0, daysBetweenISO(ev.eventDate, refDate));
            if ((t==='pregnancy_check'||t==='تشخيص حمل') && !repro) repro = ev.result || ev.status || '';
            if (dim!=null && repro) break;
          }

          const point={ x: dim??0, y: v.milk, meta:{ number, milk:v.milk, dim, repro, season:meta.season||inferSeason(refDate), group:meta.group||'' } };
          (sp==='جاموس'?dsBuff:dsCows).data.push(point);
          rows.push({ number, species:sp, dim:dim??'—', milk:v.milk, repro:point.meta.repro||'—', season:point.meta.season, group:point.meta.group||'—' });
        }

        drawScatter([dsCows, dsBuff]);
        rows.sort((a,b)=>b.milk-a.milk);
        topBody.innerHTML = rows.slice(0,10).map(r=>`<tr>
          <td><a href="cow-card.html?number=${encodeURIComponent(r.number)}">${r.number}</a></td>
          <td>${r.species}</td><td>${r.dim}</td><td>${fmt(r.milk,1)}</td>
          <td>${r.repro}</td><td>${r.season}</td><td>${r.group}</td>
        </tr>`).join('');

        // تغذية (شهريًا)
        const nutritQ = query(collection(db,'events'), where('userId','==',u), where('eventDate','>=',startOfMonthISO(refDate)), where('eventDate','<=',endOfMonthISO(refDate)), orderBy('eventDate','desc'));
        const nutritSnap = await getDocs(nutritQ);
        let dmCostTotal=0, mealsCount=0;
        for (const d of nutritSnap.docs){
          const ev=d.data()||{}; const t=(ev.eventType||ev.type||'').trim();
          if (!/nutrition|تغذية/i.test(t)) continue;
          const intake=Number(ev.dmIntakeKg ?? ev.dmKg ?? ev.dm_intake);
          const costKg=Number(ev.dmCostPerKg ?? ev.rationCostPerKgDM ?? ev.dm_cost);
          if (isFinite(intake)&&isFinite(costKg)&&intake>0&&costKg>=0){ dmCostTotal+=intake*costKg; mealsCount++; }
        }
        const costPerKg=(monthSum.total>0 && dmCostTotal>0)? (dmCostTotal/monthSum.total) : 0;
        document.getElementById('kCostPerKg').textContent = costPerKg? `${fmt(costPerKg,2)} / كجم` : '—';
        document.getElementById('kCostDbg').textContent = `سجلات تغذية محسوبة: ${mealsCount} — إجمالي لبن الشهر: ${fmt(monthSum.total,0)} كجم`;

        statusEl.textContent = `آخر تحديث: ${new Date().toLocaleTimeString('ar-EG')}`;
      }catch(e){
        console.error(e);
        showMsg('تعذّر تحميل التقرير.', true);
        statusEl.textContent='خطأ في التحميل';
      }
    }

    function inferSeason(dateISO){
      const m = new Date(dateISO).getMonth()+1;
      if ([12,1,2].includes(m)) return 'شتاء';
      if ([3,4,5].includes(m))  return 'ربيع';
      if ([6,7,8].includes(m))  return 'صيف';
      return 'خريف';
    }

    // إقلاع وتحديث
    document.addEventListener('DOMContentLoaded', ()=>{
      refDateEl.value = todayISO();
      loadReport();
    });
    refreshBtn.addEventListener('click', loadReport);
    refDateEl.addEventListener('change', loadReport);
    speciesSel.addEventListener('change', loadReport);
  </script>
</body>
</html>
