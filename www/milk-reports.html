<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù† â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</title>
  <link rel="stylesheet" href="css/forms.css" />
  <script type="module" src="js/forms-init.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Cairo','Segoe UI',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0}
    .bar{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title{font-weight:800;color:var(--green-600);font-size:clamp(16px,2.5vw,22px)}
    main{max-width:1100px;margin:16px auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:grid;gap:12px}
    .row.cols-5{grid-template-columns:repeat(5,1fr)}
    @media(max-width:900px){ .row.cols-5{grid-template-columns:1fr 1fr} }
    @media(max-width:520px){ .row.cols-5{grid-template-columns:1fr} }
    label{font-weight:700;font-size:14px}
    input,select,button{font-size:16px}
    input,select{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
    .metric{display:flex;flex-direction:column;gap:6px;padding:12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
    .metric .k{font-size:clamp(18px,4.6vw,26px);font-weight:900}
    .muted{color:#64748b}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2f7;color:#0f172a;font-weight:700;border:1px solid #cbd5e1}
    .infobar{display:none;margin-top:8px;padding:10px;border-radius:10px;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .infobar.show{display:block}
    .error{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .chart-wrap{height:360px}
    @media(max-width:600px){ .chart-wrap{height:260px} }
    canvas{background:#fff;border:1px solid #e2e8f0;border-radius:12px}
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;white-space:nowrap}
  </style>
</head>
<body>
  <script>window.dataLayer = window.dataLayer || [];</script>
  <header>
    <div class="bar">
      <div class="title">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
      <div class="actions">
        <a class="badge" href="daily-milk.html">Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø¨Ù† ÙŠÙˆÙ…ÙŠ</a>
        <a class="badge" href="add-event.html">Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</a>
      </div>
    </div>
  </header>

  <main>
    <!-- ÙÙ„Ø§ØªØ± -->
    <div class="card">
      <div class="row cols-5">
        <div>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¶</label>
          <input id="refDate" type="date" />
        </div>
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹</label>
          <select id="speciesFilter">
            <option value="all">Ø§Ù„ÙƒÙ„</option>
            <option value="Ø£Ø¨Ù‚Ø§Ø±">Ø£Ø¨Ù‚Ø§Ø±</option>
            <option value="Ø¬Ø§Ù…ÙˆØ³">Ø¬Ø§Ù…ÙˆØ³</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <select id="unitSel">
            <option value="kg">ÙƒØ¬Ù…</option>
            <option value="l">Ù„ØªØ±</option>
          </select>
        </div>
        <div style="align-self:end">
          <button id="refreshBtn" class="badge">ØªØ­Ø¯ÙŠØ« ğŸ”„</button>
        </div>
        <div style="align-self:end">
          <span id="status" class="muted"></span>
        </div>
      </div>
      <div id="msg" class="infobar"></div>
    </div>

    <!-- Ù…Ø¤Ø´Ø±Ø§Øª -->
    <div class="card">
      <div class="row">
        <div class="metric">
          <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="k" id="kDaily">â€”</div>
          <div class="muted" id="kDailyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±</div>
          <div class="k" id="kMonthly">â€”</div>
          <div class="muted" id="kMonthlyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†Ø©</div>
          <div class="k" id="kYearly">â€”</div>
          <div class="muted" id="kYearlyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
          <div class="k" id="kAvg">â€”</div>
          <div class="muted" id="kAvgNote"></div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø±Ø³Ù… -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><b>Scatter</b> â€” (X) Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ â€” (Y) Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
        <div class="muted">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø·Ø© Ù„ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</div>
      </div>
      <div class="chart-wrap"><canvas id="scatterChart"></canvas></div>
    </div>

    <!-- ØªÙƒÙ„ÙØ© ÙƒØ¬Ù… Ø§Ù„Ù„Ø¨Ù† Ù…Ù† Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø§ÙØ© -->
    <div class="card">
      <div class="row">
        <div class="metric">
          <div class="muted">Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© ÙƒØ¬Ù… Ø§Ù„Ù„Ø¨Ù† (Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±)</div>
          <div class="k" id="kCostPerKg">â€”</div>
          <div class="muted" id="kCostNote">ØªØ­Ø³Ø¨ Ù…Ù† (dmIntakeKg Ã— dmCostPerKg) Ã· Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ø¨Ù†.</div>
        </div>
        <div class="metric">
          <div class="muted">Ù…Ù„Ø®Øµ Ø§Ù„ØªØºØ°ÙŠØ©</div>
          <div class="muted" id="kCostDbg">â€”</div>
        </div>
      </div>
    </div>

    <!-- Ø£Ø¹Ù„Ù‰ 10 -->
    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">Ø£Ø¹Ù„Ù‰ 10 Ø£ÙØ±Ø§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Ø±Ù‚Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>DIM</th><th>Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</th><th>Ø­Ø§Ù„Ø© ØªÙ†Ø§Ø³Ù„ÙŠØ©</th><th>Ù…ÙˆØ³Ù…</th><th>Ù…Ø¬Ù…ÙˆØ¹Ø©</th></tr></thead>
          <tbody id="topBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Firebase -->
  <script type="module" src="/js/firebase-config.js"></script>
  <script src="/js/app-core.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>

  <!-- Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© -->
  <script type="module">
    import { db, auth, ensureAuth } from '/js/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Ø¹Ù†Ø§ØµØ±
    const refDateEl = document.getElementById('refDate');
    const speciesSel = document.getElementById('speciesFilter');
    const unitSel = document.getElementById('unitSel');
    const refreshBtn = document.getElementById('refreshBtn');
    const msg = document.getElementById('msg');
    const statusEl = document.getElementById('status');
    const topBody = document.getElementById('topBody');

    // Ø£Ø¯ÙˆØ§Øª
    function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    function startOfMonthISO(d){ const x=new Date(d); x.setDate(1); return x.toISOString().slice(0,10) }
    function endOfMonthISO(d){ const x=new Date(d); x.setMonth(x.getMonth()+1); x.setDate(0); return x.toISOString().slice(0,10) }
    function startOfYearISO(d){ const x=new Date(d); x.setMonth(0,1); return x.toISOString().slice(0,10) }
    function endOfYearISO(d){ const x=new Date(d); x.setMonth(12,0); return x.toISOString().slice(0,10) }
    function daysBetweenISO(a,b){ const A=new Date(a), B=new Date(b); A.setHours(0,0,0,0); B.setHours(0,0,0,0); return Math.round((B-A)/86400000); }
    function fmt(n,dec=1){ if(n==null||isNaN(n)) return 'â€”'; return Number(n).toLocaleString('ar-EG',{maximumFractionDigits:dec,minimumFractionDigits:dec}); }
    function showMsg(t,isErr=false){ msg.className='infobar '+(isErr?'show error':'show'); msg.innerHTML=(isErr?'âŒ ':'âœ… ')+t; }

    async function uid(){ if(auth.currentUser) return auth.currentUser.uid; return new Promise(r=>onAuthStateChanged(auth,u=>r(u?.uid||''))); }

    function normSpecies(data){
      const s = String(data?.animalTypeAr || data?.animalType || data?.species || '').trim();
      if (s==='cow' || /Ø¨Ù‚Ø±/i.test(s)) return 'Ø£Ø¨Ù‚Ø§Ø±';
      if (s==='buffalo' || /Ø¬Ø§Ù…ÙˆØ³/i.test(s)) return 'Ø¬Ø§Ù…ÙˆØ³';
      return s || 'Ø£Ø¨Ù‚Ø§Ø±';
    }

    // Ø¢Ø®Ø± ÙŠÙˆÙ… Ù„Ø¨Ù† Ù…ØªØ§Ø­ (Ø¨ØµØ±Ù Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† refDate)
    async function findLatestMilkDate(u){
      const evQ = query(collection(db,'events'), where('userId','==',u), orderBy('eventDate','desc'), limit(400));
      const snap = await getDocs(evQ);
      for (const d of snap.docs){
        const ev = d.data()||{};
        const type = (ev.eventType || ev.type || '').trim();
        if (/daily[_\s-]?milk|Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ|milk/i.test(type)) return ev.eventDate;
      }
      return null;
    }

    async function hasMilkForDate(u, dateISO){
      const q1 = query(collection(db,'events'), where('userId','==',u), where('eventDate','==',dateISO), limit(200));
      const s = await getDocs(q1);
      for (const d of s.docs){
        const ev = d.data()||{}; const type = (ev.eventType||ev.type||'').trim();
        if (/daily[_\s-]?milk|Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ|milk/i.test(type)) return true;
      }
      return false;
    }

    // Ø¬Ù„Ø¨ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† (Ù„Ù„ØªÙØ§ØµÙŠÙ„)
    async function fetchAnimalDocByNumber(number){
      const tries = [['animalNumber','==',number],['number','==',number],['animalNo','==',number]];
      for (const [f,op,val] of tries){
        const s = await getDocs(query(collection(db,'animals'), where(f,op,val), limit(1)));
        if (!s.empty){ const d=s.docs[0]; return { id:d.id, data:d.data()||{} }; }
      }
      return null;
    }

    // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù„Ø¨Ù†
    function readMilk(ev){
      const v = ev.milkKg ?? ev.milk ?? ev.yieldKg ?? ev.yield ?? ev.liters;
      const n = Number(v);
      return isFinite(n) ? n : 0;
    }

    function speciesOK(filter, sp){ if (filter==='all') return true; return sp===filter; }

    // Scatter
    let scatter;
    function drawScatter(datasets){
      const ctx = document.getElementById('scatterChart').getContext('2d');
      if (scatter) scatter.destroy();
      scatter = new Chart(ctx,{
        type:'scatter',
        data:{ datasets },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ display:true, labels:{ usePointStyle:true } },
            tooltip:{ callbacks:{ label:(ctx)=> {
              const p=ctx.raw.meta;
              return [`Ø±Ù‚Ù…: ${p.number}`, `DIM: ${p.dim ?? 'â€”'}`, `Ø¥Ù†ØªØ§Ø¬: ${fmt(p.milk,1)}`, `Ø­Ø§Ù„Ø©: ${p.repro||'â€”'}`, `Ù…ÙˆØ³Ù…: ${p.season||'â€”'}`, `Ù…Ø¬Ù…ÙˆØ¹Ø©: ${p.group||'â€”'}`];
            }}}
          },
          scales:{ x:{ title:{display:true,text:'Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ (DIM)'}}, y:{ title:{display:true,text:'Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ'} } },
          onClick:(_,els)=>{ if(!els?.length) return; const m=scatter.data.datasets[els[0].datasetIndex].data[els[0].index].meta; if(m?.number){ location.href=`cow-card.html?number=${encodeURIComponent(m.number)}`; } }
        }
      });
    }

    // ØªÙ‚Ø¯ÙŠØ± Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ù‘Ø§Ø¨ Ù…Ù† animals
    async function countLactating(u, filterSp){
      const s = await getDocs(query(collection(db,'animals'), where('userId','==',u), limit(1000)));
      let n=0, total=0;
      s.forEach(doc=>{
        const a=doc.data()||{}; total++;
        const sp = normSpecies(a);
        if (!speciesOK(filterSp, sp)) return;
        const rs = String(a.reproductiveStatus||a.reproStatus||a.milkStatus||a.status||'').trim();
        if (/Ø­Ù„Ø§Ø¨|Ø­Ù„ÙŠØ¨|lact|milk/i.test(rs)) n++;
      });
      return { lactating:n, herd: total };
    }

    async function loadReport(){
      try{
        msg.className='infobar'; msg.innerHTML=''; topBody.innerHTML='';
        statusEl.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦';
        await ensureAuth();
        const u = await uid(); if(!u){ showMsg('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.', true); return; }

        // Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: Ø§Ù„Ù…Ø³ØªØ®Ø¯ÙÙ… Ø£Ùˆ Ø¢Ø®Ø± Ù…ØªØ§Ø­
        let refDate = refDateEl.value || todayISO();
        if (!(await hasMilkForDate(u, refDate))){
          const last = await findLatestMilkDate(u);
          if (last){ refDate = last; refDateEl.value = last; }
        }

        const monthFrom = startOfMonthISO(refDate);
        const monthTo   = endOfMonthISO(refDate);
        const yearFrom  = startOfYearISO(refDate);
        const yearTo    = endOfYearISO(refDate);
        const filterSp  = speciesSel.value;

        // Ø§Ø¬Ù„Ø¨ ÙƒÙ„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ù†Ø© Ø«Ù… ÙÙ„ØªØ± Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ø¨Ø³ÙŠØ· ÙˆØ³Ø±ÙŠØ¹ Ù„Ù„Ø­ÙŠØ§Ø²Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©)
        const evQ = query(collection(db,'events'), where('userId','==',u), orderBy('eventDate','desc'), limit(2000));
        const snap = await getDocs(evQ);

        const daySum = { 'Ø£Ø¨Ù‚Ø§Ø±':0, 'Ø¬Ø§Ù…ÙˆØ³':0, total:0, count:0 };
        const monthSum = { 'Ø£Ø¨Ù‚Ø§Ø±':0, 'Ø¬Ø§Ù…ÙˆØ³':0, total:0 };
        const yearSum = { 'Ø£Ø¨Ù‚Ø§Ø±':0, 'Ø¬Ø§Ù…ÙˆØ³':0, total:0 };
        const dayAnimals = new Map();

        for (const d of snap.docs){
          const ev=d.data()||{};
          const type = (ev.eventType||ev.type||'').trim();
          if (!/daily[_\s-]?milk|Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ|milk/i.test(type)) continue;

          const evDate = ev.eventDate;
          const milk = readMilk(ev);
          const number = String(ev.animalNumber || ev.number || ev.animalNo || '');
          if (!milk || !number) continue;

          let sp = String(ev.species || ev.animalTypeAr || ev.animalType || '').trim();
          if (sp==='cow' || /Ø¨Ù‚Ø±/i.test(sp)) sp='Ø£Ø¨Ù‚Ø§Ø±';
          else if (sp==='buffalo' || /Ø¬Ø§Ù…ÙˆØ³/i.test(sp)) sp='Ø¬Ø§Ù…ÙˆØ³';

          // ÙŠÙˆÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ±
          if (evDate===refDate){
            dayAnimals.set(number,{ milk, species:sp });
            if (!sp) continue;
            if (speciesOK(filterSp, sp)){ daySum[sp]=(daySum[sp]||0)+milk; daySum.total+=milk; daySum.count++; }
          }

          // Ø´Ù‡Ø±ÙŠ/Ø³Ù†ÙˆÙŠ
          if (speciesOK(filterSp, sp)){
            if (evDate>=monthFrom && evDate<=monthTo){ monthSum[sp]=(monthSum[sp]||0)+milk; monthSum.total+=milk; }
            if (evDate>=yearFrom  && evDate<=yearTo ){ yearSum[sp]=(yearSum[sp]||0)+milk; yearSum.total+=milk; }
          }
        }

        // Ù„Ùˆ Ù…ÙÙŠØ´ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… â€” Ø£Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø­Ù„Ù‘Ø§Ø¨
        if (dayAnimals.size===0){
          const { lactating, herd } = await countLactating(u, filterSp);
          showMsg(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¨Ù† Ù„Ù„ÙŠÙˆÙ… ${refDate}. Ø¢Ø®Ø± Ù…ØªØ§Ø­ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ù‘Ø§Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${lactating} Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹ ${herd}.`, true);
        } else {
          showMsg(`ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ÙŠÙˆÙ… ${refDate} âœ…`);
        }

        // Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù„Ù„Ø±Ø³Ù…
        const animalsMeta = new Map();
        for (const num of dayAnimals.keys()){
          const ad = await fetchAnimalDocByNumber(num);
          animalsMeta.set(num, ad ? {
            species: normSpecies(ad.data),
            group: ad.data.group || ad.data.groupName || ad.data.pen || '',
            season: ad.data.season || ad.data.seasonName || '',
            repro: ad.data.reproductiveStatus || ad.data.reproStatus || ''
          } : { species:'Ø£Ø¨Ù‚Ø§Ø±', group:'', season:'', repro:'' });
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
        document.getElementById('kDaily').textContent   = fmt(daySum.total,1);
        document.getElementById('kDailyBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${fmt(daySum['Ø£Ø¨Ù‚Ø§Ø±'],1)} â€” Ø¬Ø§Ù…ÙˆØ³: ${fmt(daySum['Ø¬Ø§Ù…ÙˆØ³'],1)}`;
        document.getElementById('kMonthly').textContent = fmt(monthSum.total,1);
        document.getElementById('kMonthlyBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${fmt(monthSum['Ø£Ø¨Ù‚Ø§Ø±'],1)} â€” Ø¬Ø§Ù…ÙˆØ³: ${fmt(monthSum['Ø¬Ø§Ù…ÙˆØ³'],1)}`;
        document.getElementById('kYearly').textContent  = fmt(yearSum.total,1);
        document.getElementById('kYearlyBreak').textContent = `Ø£Ø¨Ù‚Ø§Ø±: ${fmt(yearSum['Ø£Ø¨Ù‚Ø§Ø±'],1)} â€” Ø¬Ø§Ù…ÙˆØ³: ${fmt(yearSum['Ø¬Ø§Ù…ÙˆØ³'],1)}`;

        const avg = daySum.count ? (daySum.total/daySum.count) : 0;
        document.getElementById('kAvg').textContent = fmt(avg,1);
        document.getElementById('kAvgNote').textContent = `Ø¹Ù„Ù‰ ${daySum.count} Ø³Ø¬Ù„ Ù„Ø¨Ù† ÙŠÙˆÙ…ÙŠ.`;

        // Scatter + Top10
        const dsCows={label:'Ø£Ø¨Ù‚Ø§Ø±',data:[],pointRadius:5,showLine:false};
        const dsBuff={label:'Ø¬Ø§Ù…ÙˆØ³',data:[],pointRadius:5,showLine:false};
        const rows=[];

        for (const [number, v] of dayAnimals.entries()){
          const meta = animalsMeta.get(number)||{};
          const sp = meta.species || 'Ø£Ø¨Ù‚Ø§Ø±';
          if (!speciesOK(speciesSel.value, sp)) continue;

          // Ø­Ø³Ø§Ø¨ DIM Ù…Ù† Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø© (Ø³Ø±ÙŠØ¹ Ø¹Ø¨Ø± events Ø§Ù„Ù…Ø±ØªØ¨Ø©)
          let dim=null, repro=meta.repro||'';
          const evQ2 = query(collection(db,'events'), where('userId','==',u), where('animalNumber','==',number), orderBy('eventDate','desc'), limit(40));
          const s2 = await getDocs(evQ2);
          for (const d of s2.docs){
            const ev=d.data()||{}; const t=(ev.eventType||ev.type||'').trim();
            if (!dim && (t==='ÙˆÙ„Ø§Ø¯Ø©'||t==='calving')) dim = Math.max(0, daysBetweenISO(ev.eventDate, refDate));
            if ((t==='pregnancy_check'||t==='ØªØ´Ø®ÙŠØµ Ø­Ù…Ù„') && !repro) repro = ev.result || ev.status || '';
            if (dim!=null && repro) break;
          }

          const point={ x: dim??0, y: v.milk, meta:{ number, milk:v.milk, dim, repro, season:meta.season||inferSeason(refDate), group:meta.group||'' } };
          (sp==='Ø¬Ø§Ù…ÙˆØ³'?dsBuff:dsCows).data.push(point);
          rows.push({ number, species:sp, dim:dim??'â€”', milk:v.milk, repro:point.meta.repro||'â€”', season:point.meta.season, group:point.meta.group||'â€”' });
        }

        drawScatter([dsCows, dsBuff]);
        rows.sort((a,b)=>b.milk-a.milk);
        topBody.innerHTML = rows.slice(0,10).map(r=>`<tr>
          <td><a href="cow-card.html?number=${encodeURIComponent(r.number)}">${r.number}</a></td>
          <td>${r.species}</td><td>${r.dim}</td><td>${fmt(r.milk,1)}</td>
          <td>${r.repro}</td><td>${r.season}</td><td>${r.group}</td>
        </tr>`).join('');

        // ØªØºØ°ÙŠØ© (Ø´Ù‡Ø±ÙŠÙ‹Ø§)
        const nutritQ = query(collection(db,'events'), where('userId','==',u), where('eventDate','>=',startOfMonthISO(refDate)), where('eventDate','<=',endOfMonthISO(refDate)), orderBy('eventDate','desc'));
        const nutritSnap = await getDocs(nutritQ);
        let dmCostTotal=0, mealsCount=0;
        for (const d of nutritSnap.docs){
          const ev=d.data()||{}; const t=(ev.eventType||ev.type||'').trim();
          if (!/nutrition|ØªØºØ°ÙŠØ©/i.test(t)) continue;
          const intake=Number(ev.dmIntakeKg ?? ev.dmKg ?? ev.dm_intake);
          const costKg=Number(ev.dmCostPerKg ?? ev.rationCostPerKgDM ?? ev.dm_cost);
          if (isFinite(intake)&&isFinite(costKg)&&intake>0&&costKg>=0){ dmCostTotal+=intake*costKg; mealsCount++; }
        }
        const costPerKg=(monthSum.total>0 && dmCostTotal>0)? (dmCostTotal/monthSum.total) : 0;
        document.getElementById('kCostPerKg').textContent = costPerKg? `${fmt(costPerKg,2)} / ÙƒØ¬Ù…` : 'â€”';
        document.getElementById('kCostDbg').textContent = `Ø³Ø¬Ù„Ø§Øª ØªØºØ°ÙŠØ© Ù…Ø­Ø³ÙˆØ¨Ø©: ${mealsCount} â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ø¨Ù† Ø§Ù„Ø´Ù‡Ø±: ${fmt(monthSum.total,0)} ÙƒØ¬Ù…`;

        statusEl.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-EG')}`;
      }catch(e){
        console.error(e);
        showMsg('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.', true);
        statusEl.textContent='Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
      }
    }

    function inferSeason(dateISO){
      const m = new Date(dateISO).getMonth()+1;
      if ([12,1,2].includes(m)) return 'Ø´ØªØ§Ø¡';
      if ([3,4,5].includes(m))  return 'Ø±Ø¨ÙŠØ¹';
      if ([6,7,8].includes(m))  return 'ØµÙŠÙ';
      return 'Ø®Ø±ÙŠÙ';
    }

    // Ø¥Ù‚Ù„Ø§Ø¹ ÙˆØªØ­Ø¯ÙŠØ«
    document.addEventListener('DOMContentLoaded', ()=>{
      refDateEl.value = todayISO();
      loadReport();
    });
    refreshBtn.addEventListener('click', loadReport);
    refDateEl.addEventListener('change', loadReport);
    speciesSel.addEventListener('change', loadReport);
  </script>
</body>
</html>
