<!DOCTYPE html>
<html lang="ar" dir="rtl" data-page="heat">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠØ§Ø¹ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</title>

  <link rel="stylesheet" href="css/forms.css" />

  <!-- Tracking (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) -->
  <script>window.dataLayer = window.dataLayer || [];</script>
  <script src="/js/app-core.js"></script>

  <!-- Validation / Forms init (Central Gate + Validation) -->
  <script type="module" src="js/forms-init.js"></script>

  <style>
    header{
      position: sticky;
      top: 0;
      z-index: 20;
      background: #fff;
      border-bottom: 1px solid var(--border, #e2e8f0);
    }
    .mbk-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      max-width:980px;
      margin:0 auto;
    }
    .mbk-logo{
      height:48px;
      width:auto;
      object-fit:contain;
      opacity:.6;
      flex-shrink:0;
    }
    .mbk-center{ flex:1; text-align:center; line-height:1.15; }
    .mbk-page-title{ font-size:18px; font-weight:900; color: var(--ink, #0f172a); }
    .mbk-app-name{ font-size:13px; font-weight:800; color: var(--brand-600, #0b7f47); opacity:.9; }

    .mbk-back{
      width:42px;
      height:42px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      font-weight:900;
      color: var(--brand-600, #0b7f47);
      border:2px solid var(--brand-600, #0b7f47);
      background:#fff;
      flex-shrink:0;
    }

    /* Infobar ØªØ­Øª Ø§Ù„Ù‡ÙŠØ¯Ø± */
    #sysbar.infobar{
      display:block;
      position: sticky;
      top: 72px;
      z-index: 19;
      margin: 10px 12px;
      max-width:520px;
      margin-left:auto;
      margin-right:auto;
    }

    .wrap{ max-width:520px; margin:12px auto 24px; padding:0 12px; }
    .mbk-card{
      background:#fff;
      border:1px solid var(--border, #e2e8f0);
      border-radius:16px;
      padding:14px;
      box-shadow:0 1px 0 rgba(15,23,42,.04);
    }

    .btn-row{
      position: sticky;
      bottom: 10px;
      background: #fff;
      padding: 10px;
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 16px;
      display:flex;
      gap:10px;
      margin:14px 12px 18px;
      max-width:520px;
      margin-left:auto;
      margin-right:auto;
      z-index: 5;
    }
    .btn-row .save-btn,
    .btn-row .open-card{
      flex:1;
      width:auto;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      border:0;
    }
    .btn-row .save-btn{
      background: var(--brand, #0ea05a);
      color:#fff;
    }
    .btn-row .open-card{
      background:#fff !important;
      color: var(--brand-600, #0b7f47) !important;
      border:2px solid var(--brand-600, #0b7f47) !important;
    }
  </style>
</head>

<body data-page="heat">

  <header>
    <div class="mbk-head">
      <a class="mbk-back" href="add-event.html" title="Ø±Ø¬ÙˆØ¹">Ø±Ø¬ÙˆØ¹</a>

      <div class="mbk-center">
        <div class="mbk-page-title">ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠØ§Ø¹</div>
        <div class="mbk-app-name">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
      </div>

      <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
    </div>
  </header>

  <!-- infobar -->
  <div id="sysbar" class="infobar"></div>

  <div class="wrap">

    <!-- âœ… Ù„Ø§Ø²Ù… Form Ø¹Ù„Ø´Ø§Ù† forms-init ÙŠØ´ØªØºÙ„ -->
   <form id="heatForm" class="mbk-card" data-validate="true" data-event-type="Ø´ÙŠØ§Ø¹" data-event="Ø´ÙŠØ§Ø¹" novalidate>

      <!-- Hidden: Ø¹Ù„Ø´Ø§Ù† forms-init ÙŠØ­Ù‚Ù† animalId -->
      <input id="animalId" data-field="animalId" type="hidden" />

      <label>Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
      <input id="animalNumber" data-field="animalNumber" readonly />

      <div class="hint" style="margin-top:10px;color:var(--muted,#64748b);font-weight:800">
        Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ (ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø±) â€” Ù†ÙØ³ Ø´Ø±ÙˆØ· ÙˆØªØ­Ù‚Ù‚ Ø§Ù„ÙØ±Ø¯ÙŠ.
      </div>
      <textarea id="bulkNumbers" data-field="bulkNumbers" rows="4"
        placeholder="Ù…Ø«Ø§Ù„:
31
45
209"
        style="width:100%;padding:12px;border-radius:14px;border:1px solid var(--border,#e2e8f0);background:#fff;font-weight:900;line-height:1.6;resize:vertical"></textarea>

      <button id="btnPreviewBulk" type="button" class="btn"
        style="margin-top:10px;width:100%;border-radius:14px;padding:12px 14px;font-weight:900;border:2px solid #0b7f47;background:#fff;color:#0b7f47;cursor:pointer">
        ğŸ” ÙØ­Øµ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      </button>



      <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´ÙŠØ§Ø¹</label>
      <input id="eventDate" data-field="eventDate" type="date" />
     <label>ÙˆÙ‚Øª Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø´ÙŠØ§Ø¹</label>
<div class="radio-row" style="display:flex;gap:14px;align-items:center;margin:6px 0 10px;">
  <label style="display:flex;gap:8px;align-items:center;font-weight:800;">
    <input type="radio" name="heatTime" data-field="heatTime" value="Øµ" />
    Øµ
  </label>

  <label style="display:flex;gap:8px;align-items:center;font-weight:800;">
    <input type="radio" name="heatTime" data-field="heatTime" value="Ù…" />
    Ù…
  </label>
</div>

      <label>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
      <input id="reproStatus" data-field="reproductiveStatusSnapshot" readonly />

      <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ (DIM)</label>
      <input id="dim" data-field="dimAtEvent" readonly />
      <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ù…Ù†Ø° Ø¢Ø®Ø± Ø´ÙŠØ§Ø¹ / ØªÙ„Ù‚ÙŠØ­</label>
<input id="daysSinceLastHeatOrAI" readonly />
      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="notes" data-field="notes" rows="3" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea>

      <!-- Ø²Ø± Ø¯Ø§Ø®Ù„ÙŠ Ù…Ø®ÙÙŠ ÙÙ‚Ø· Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù„Ùˆ Ø§Ø­ØªØ¬Ù†Ø§Ù‡ -->
      <button type="submit" id="saveBtn" style="display:none"></button>
    </form>
  </div>

  <div class="btn-row">
    <!-- âœ… Ø²Ø± Ø§Ù„Ø­ÙØ¸ = submit (Ø¨Ø¯ÙˆÙ† onclick) -->
    <button id="saveBtnUI" class="save-btn" type="submit" form="heatForm">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´ÙŠØ§Ø¹</button>
    <button id="openCowCard" class="open-card" type="button">ğŸ§¾ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
  </div>

  <script type="module">
    import { db, auth } from "/js/firebase-config.js";
    import { updateAnimalByEvent } from "/js/animal-update.js";
    import {
  collection, addDoc, serverTimestamp,
  getDocs, query, where, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


    const $ = (id) => document.getElementById(id);
    const form = $("heatForm");
    const bar  = $("sysbar");

    function msg(t, ok=false){
      bar.className = "infobar " + (ok ? "success" : "error");
      bar.style.display = "block";
      bar.textContent = t;
      try{ bar.scrollIntoView({behavior:"smooth", block:"start"}); }catch(_){}
    }
    // âœ… ÙØ­Øµ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¬Ù…Ø§Ø¹ÙŠ) â€” ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Gate Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ + Ù‚Ø§Ø¹Ø¯Ø© 72 Ø³Ø§Ø¹Ø©
    const btnPreviewBulk = $("btnPreviewBulk");
    btnPreviewBulk?.addEventListener("click", async () => {
      try{
        const bulkRaw = String($("bulkNumbers")?.value || "").trim();
        const dt = String($("eventDate")?.value || "").slice(0,10);
        if (!bulkRaw){
          msg("Ø§ÙƒØªØ¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ø£ÙˆÙ„Ù‹Ø§.", false);
          return;
        }
        if (!dt){
          msg("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´ÙŠØ§Ø¹ Ø£ÙˆÙ„Ù‹Ø§.", false);
          return;
        }

        const nums = bulkRaw.split(/\s+/).map(s=>s.trim()).filter(Boolean);
        if (!nums.length){
          msg("Ø§ÙƒØªØ¨ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ.", false);
          return;
        }

        if (!window.mbk?.previewHeatList){
          msg("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø¯Ø§Ø© ÙØ­Øµ Ø§Ù„Ø´ÙŠØ§Ø¹ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ (previewHeatList). Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø©.", false);
          return;
        }

        const r = await window.mbk.previewHeatList(nums, dt);
        form.__mbkBulkHeat = r || null;

        if (window.showMsg && window.ensureInfoBar){
          const b = window.ensureInfoBar(form);
          window.showMsg(b, (r?.message || "ØªÙ… Ø§Ù„ÙØ­Øµ."), (r?.valid?.length ? "success" : "error"));
        } else {
          msg(r?.message || "ØªÙ… Ø§Ù„ÙØ­Øµ.", !!(r?.valid?.length));
        }
      }catch(_){
        msg("ØªØ¹Ø°Ù‘Ø± ÙØ­Øµ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¢Ù†.", false);
      }
    });



    // âœ… Prefill Ù…Ù† URL / localStorage
    const p  = new URLSearchParams(location.search);
    const num = (p.get("number") || p.get("animalNumber") || localStorage.getItem("lastAnimalNumber") || "").toString().trim();
    const dt  = (p.get("date")   || p.get("eventDate")    || localStorage.getItem("lastEventDate")   || new Date().toISOString().slice(0,10)).toString().slice(0,10);

    $("animalNumber").value = num;
    $("eventDate").value = dt;

    function toDate(s){
      const d = new Date(String(s || "").slice(0,10));
      return isNaN(d.getTime()) ? null : d;
    }
async function calcDaysSinceLastHeatOrAI(){
  const doc = form.__mbkDoc;
  if (!doc) return;

  const uid = auth?.currentUser?.uid || localStorage.getItem("userId");
  if (!uid) return;

  const animalNumber = $("animalNumber").value.trim();
  const eventDate = $("eventDate").value;

  if (!animalNumber || !eventDate) return;

  try{
    const eventsRef = collection(db, "events");

    const snap = await getDocs(query(
      eventsRef,
      where("userId", "==", uid),
      where("animalNumber", "==", animalNumber),
      where("type", "in", ["Ø´ÙŠØ§Ø¹","ØªÙ„Ù‚ÙŠØ­"]),
      orderBy("eventDate", "desc"),
      limit(1)
    ));

    if (snap.empty){
      $("daysSinceLastHeatOrAI").value = "";
      return;
    }

    const last = snap.docs[0].data();
    const lastDate = new Date(last.eventDate);
    const currentDate = new Date(eventDate);

    const diff = Math.floor((currentDate - lastDate) / 86400000);

    $("daysSinceLastHeatOrAI").value = diff >= 0 ? diff : "";

  }catch(e){
    console.error(e);
  }
}

    function calcDIMFromDoc(){
      const doc = form.__mbkDoc || null;
      if (!doc) { $("dim").value = ""; return; }

      const calv = toDate(doc.lastCalvingDate);
      const evd  = toDate($("eventDate").value || dt);
      if (!calv || !evd) { $("dim").value = ""; return; }

      const days = Math.floor((evd - calv) / 86400000);
      $("dim").value = String(Math.max(0, days));
    }

    function fillFromDocIfReady(){
      if (form?.dataset?.animalOk !== "1") return;
      const doc = form.__mbkDoc || null;
      if (!doc) return;

      $("reproStatus").value = String(doc.reproductiveStatus || "").trim();
      calcDIMFromDoc();
    }

    // Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ù€GateØŒ forms-init Ø³ÙŠÙ…Ù„Ø£ form.__mbkDoc Ùˆ dataset.animalOk
   const docWatcher = setInterval(async () => {
  fillFromDocIfReady();
  await calcDaysSinceLastHeatOrAI();

      if (form?.dataset?.animalOk === "1" && form.__mbkDoc) {
        clearInterval(docWatcher);
      }
    }, 120);

   $("eventDate").addEventListener("change", async () => {
  calcDIMFromDoc();
  await calcDaysSinceLastHeatOrAI();
});

    // âœ… Ø²Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
    $("openCowCard").addEventListener("click", ()=> {
      const n = String($("animalNumber").value || "").trim();
      if (!n) { msg("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†.", false); return; }
      location.href = `cow-card.html?number=${encodeURIComponent(n)}`;
    });

    // âœ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ: Ù…Ù…Ù†ÙˆØ¹ submit Ù…Ø­Ù„ÙŠ â€” Ù†Ù†ØªØ¸Ø± mbk:valid
    document.addEventListener("mbk:valid", async (e) => {
      const d = e?.detail || {};
      if (!d || d.eventName !== "Ø´ÙŠØ§Ø¹") return;
      if (d.form !== form) return;

      try{
        const uid = auth?.currentUser?.uid || localStorage.getItem("userId") || "";
        if (!uid) { msg("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„.", false); return; }

        
        const fd = d.formData || {};
        const eventDate = String(fd.eventDate || "").slice(0,10);
        const heatTime  = String(fd.heatTime || "").trim(); // Øµ / Ù…
        const bulkRaw   = String(fd.bulkNumbers || "").trim();
        const singleNum = String(fd.animalNumber || "").trim();

        // âœ… Ø§Ø®ØªÙØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø¬Ù…Ø§Ø¹ÙŠ Ø£Ùˆ ÙØ±Ø¯ÙŠ)
        let numbers = [];
        if (bulkRaw) {
          numbers = bulkRaw.split(/\s+/).map(s=>s.trim()).filter(Boolean);
        } else if (singleNum) {
          numbers = [singleNum];
        }

        if (!numbers.length){
          msg("Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø£Ø±Ù‚Ø§Ù….", false);
          return;
        }

        // âœ… ÙØ­Øµ Ù…Ø±ÙƒØ²ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ (Ù†ÙØ³ Ø´Ø±ÙˆØ· Ø§Ù„ÙØ±Ø¯ÙŠ + Ù‚Ø§Ø¹Ø¯Ø© 72 Ø³Ø§Ø¹Ø©)
        let checked = form.__mbkBulkHeat;
        if (!checked || !checked.ok || String(checked?.eventDate || "") !== eventDate) {
          if (!window.mbk?.previewHeatList){
            msg("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø¯Ø§Ø© ÙØ­Øµ Ø§Ù„Ø´ÙŠØ§Ø¹ (previewHeatList). Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø©.", false);
            return;
          }
          checked = await window.mbk.previewHeatList(numbers, eventDate);
          form.__mbkBulkHeat = checked;
        }

        const valid = Array.isArray(checked?.valid) ? checked.valid : [];
        const rejected = Array.isArray(checked?.rejected) ? checked.rejected : [];

        if (!valid.length){
          // âœ… Ù„Ø§ Ø´ÙŠØ¡ Ù…Ø¤Ù‡Ù„ Ù„Ù„Ø­ÙØ¸
          if (window.showMsg && window.ensureInfoBar){
            const b = window.ensureInfoBar(form);
            window.showMsg(b, checked?.message || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù…Ø¤Ù‡Ù„Ø© Ù„Ù„Ø­ÙØ¸.", "error");
          } else {
            msg(checked?.message || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù…Ø¤Ù‡Ù„Ø© Ù„Ù„Ø­ÙØ¸.", false);
          }
          return;
        }

        // âœ… Ø§Ø­ÙØ¸ Ø­Ø¯Ø« Ø´ÙŠØ§Ø¹ Ù„ÙƒÙ„ Ø±Ù‚Ù… Ù…Ø¤Ù‡Ù„
        let saved = 0;
        for (const animalNumber of valid) {
          const payload = {
            animalNumber,
            animalId: String(fd.animalId || animalNumber),
            type: "Ø´ÙŠØ§Ø¹",
            eventType: "Ø´ÙŠØ§Ø¹",
            eventDate,
            heatTime: heatTime || null,          // âœ… Ø­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
            notes: String(fd.notes || "").trim(),
            reproductiveStatusSnapshot: String(fd.reproductiveStatusSnapshot || "").trim(),
            dimAtEvent: (fd.dimAtEvent === "" ? null : (Number(fd.dimAtEvent) || null)),
            daysSinceLastHeatOrAI: Number(document.getElementById("daysSinceLastHeatOrAI")?.value) || null,
            userId: uid,
            source: "/heat.html",
            createdAt: serverTimestamp()
          };

          await addDoc(collection(db, "events"), payload);
          try{ await updateAnimalByEvent(payload); }catch(_){}
          saved++;
        }


        // âœ… Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        if (bulkRaw) {
          const rejectedCount = rejected.length;
          msg(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´ÙŠØ§Ø¹ Ù„Ø¹Ø¯Ø¯ ${saved} Ø­ÙŠÙˆØ§Ù†. (Ù…Ø±ÙÙˆØ¶: ${rejectedCount})`, true);
          // Ù„Ø§ Ù†Ø¹Ù…Ù„ Redirect ÙÙŠ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
          try{ localStorage.setItem("lastEventDate", String(eventDate)); }catch(_){}
        } else {
          const lastNum = valid[0] || singleNum;
          msg("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´ÙŠØ§Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…", true);
          try{
            localStorage.setItem("lastAnimalNumber", String(lastNum));
            localStorage.setItem("lastEventDate", String(eventDate));
          }catch(_){}
          setTimeout(() => {
            location.href = `cow-card.html?number=${encodeURIComponent(lastNum)}`;
          }, 900);
        }


      }catch(err){
        console.error(err);
        msg("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸.", false);
      }
    });

    // Tracking
    const t = window.t || { event:(n,d)=>window.dataLayer.push({event:n, ...d}) };
    t.event("page_view", { page: "heat", title: "ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠØ§Ø¹" });
  </script>

</body>
</html>
