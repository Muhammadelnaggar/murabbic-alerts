<!DOCTYPE html>
<html lang="ar" dir="rtl" data-page="heat">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠØ§Ø¹ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</title>

  <link rel="stylesheet" href="css/forms.css" />

  <!-- Tracking (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) -->
  <script>window.dataLayer = window.dataLayer || [];</script>
  <script src="/js/app-core.js"></script>

  <!-- Validation / Forms init -->
  <script type="module" src="js/forms-init.js"></script>

  <style>
    /* âœ… Header (Murabbik standard) */
    header{
      position: sticky;
      top: 0;
      z-index: 20;
      background: #fff;
      border-bottom: 1px solid var(--border, #e2e8f0);
    }
    .mbk-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      max-width:980px;
      margin:0 auto;
    }
    .mbk-logo{
      height:48px;
      width:auto;
      object-fit:contain;
      opacity:.6; /* âœ… Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ø´ÙØ§ÙÙŠØ© 60% ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§ */
      flex-shrink:0;
    }
    .mbk-center{ flex:1; text-align:center; line-height:1.15; }
    .mbk-page-title{ font-size:18px; font-weight:900; color: var(--ink, #0f172a); }
    .mbk-app-name{ font-size:13px; font-weight:800; color: var(--brand-600, #0b7f47); opacity:.9; }

    .mbk-back{
      width:42px;
      height:42px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      font-weight:900;
      color: var(--brand-600, #0b7f47);
      border:2px solid var(--brand-600, #0b7f47);
      background:#fff;
      flex-shrink:0;
    }

    /* âœ… Infobar ØªØ­Øª Ø§Ù„Ù‡ÙŠØ¯Ø± */
    #sysbar.infobar{
      display:block;
      position: sticky;
      top: 72px;
      z-index: 19;
      margin: 10px 12px;
      max-width:520px;
      margin-left:auto;
      margin-right:auto;
    }

    /* âœ… Layout */
    .wrap{ max-width:520px; margin:12px auto 24px; padding:0 12px; }
    .mbk-card{
      background:#fff;
      border:1px solid var(--border, #e2e8f0);
      border-radius:16px;
      padding:14px;
      box-shadow:0 1px 0 rgba(15,23,42,.04);
    }

    /* âœ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© (Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶) */
    .btn-row{
      position: sticky;
      bottom: 10px;
      background: #fff;
      padding: 10px;
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 16px;
      display:flex;
      gap:10px;
      margin:14px 12px 18px;
      max-width:520px;
      margin-left:auto;
      margin-right:auto;
      z-index: 5;
    }
    .btn-row .save-btn,
    .btn-row .open-card{
      flex:1;
      width:auto;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      border:0;
    }
    .btn-row .save-btn{
      background: var(--brand, #0ea05a);
      color:#fff;
    }
    .btn-row .open-card{
      background:#fff !important;
      color: var(--brand-600, #0b7f47) !important;
      border:2px solid var(--brand-600, #0b7f47) !important;
    }
  </style>
</head>

<body data-page="heat">

  <!-- âœ… Ù‡ÙŠØ¯Ø± Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ -->
  <header>
    <div class="mbk-head">
      <a class="mbk-back" href="add-event.html" title="Ø±Ø¬ÙˆØ¹">Ø±Ø¬ÙˆØ¹</a>

      <div class="mbk-center">
        <div class="mbk-page-title">ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠØ§Ø¹</div>
        <div class="mbk-app-name">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
      </div>

      <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
    </div>
  </header>

  <!-- âœ… infobar ØªØ­Øª Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <div id="sysbar" class="infobar"></div>

  <div class="wrap">
    <section class="mbk-card">
      <label>Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
      <input id="animalNumber" readonly />

      <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´ÙŠØ§Ø¹</label>
      <input id="eventDate" type="date" />

      <label>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
      <input id="reproStatus" readonly />

      <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ (DIM)</label>
      <input id="dim" readonly />

      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="notes" rows="3" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea>

      <!-- âœ… Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø§ØªØ´Ø§Ù„ Ù…Ù† Ù‡Ù†Ø§ (Ù‡Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø²Ø± Ø§Ù„Ø³ÙÙ„ÙŠ) -->
      <button id="saveBtn" data-validate="true" style="display:none"></button>
    </section>
  </div>

  <!-- âœ… Ø²Ø±ÙŠÙ† Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶ Ø£Ø³ÙÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
  <div class="btn-row">
    <button id="saveBtnUI" class="save-btn" type="button">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´ÙŠØ§Ø¹</button>
    <button id="openCowCard" class="open-card" type="button">ğŸ§¾ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
  </div>

  <script type="module">
    import { db, auth, ensureAuth } from "/js/firebase-config.js";
    import { updateAnimalByEvent } from "/js/animal-update.js";
    import {
      collection, addDoc, serverTimestamp,
      getDocs, query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);

    const info = $("sysbar");
    const btn  = $("saveBtn");      // Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„ÙŠ (Ù…Ø®ÙÙŠ)
    const btnUI = $("saveBtnUI");   // Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø¸Ø§Ù‡Ø±)
    const openCowCard = $("openCowCard");

    function msg(t, ok=false){
      info.className = "infobar " + (ok ? "ok" : "err");
      info.textContent = t;
    }

    const p = new URLSearchParams(location.search);
    const num = (p.get("number") || p.get("animalNumber") || localStorage.getItem("lastAnimalNumber") || "").toString().trim();
    const dt  = (p.get("date")   || p.get("eventDate")    || localStorage.getItem("lastEventDate")   || new Date().toISOString().slice(0,10)).toString().slice(0,10);

    $("animalNumber").value = num;
    $("eventDate").value = dt;

    let _animal = null;

    function toDate(s){
      const d = new Date(String(s || "").slice(0,10));
      return isNaN(d.getTime()) ? null : d;
    }

    function calcDIM(){
      if (!_animal) { $("dim").value = ""; return; }
      const calv = toDate(_animal.lastCalvingDate);
      const evd  = toDate($("eventDate").value || dt);
      if (!calv || !evd) { $("dim").value = ""; return; }
      const days = Math.floor((evd - calv) / (1000*60*60*24));
      $("dim").value = String(Math.max(0, days));
    }

    async function loadAnimalAndFill(){
      if (!num) { msg("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†.", false); return; }

      try{
        await ensureAuth();
        const uid = auth.currentUser?.uid;
        if (!uid) { msg("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.", false); return; }

        const animalsRef = collection(db, "animals");

        // Ù…Ø­Ø§ÙˆÙ„Ø© 1: number ÙƒÙ†Øµ
        let snap = await getDocs(query(
          animalsRef,
          where("userId", "==", uid),
          where("number", "==", String(num)),
          limit(1)
        ));

        // Ù…Ø­Ø§ÙˆÙ„Ø© 2: animalNumber ÙƒØ±Ù‚Ù…
        if (snap.empty) {
          snap = await getDocs(query(
            animalsRef,
            where("userId", "==", uid),
            where("animalNumber", "==", Number(num)),
            limit(1)
          ));
        }

        if (snap.empty) {
          msg("âš ï¸ Ø§Ù„Ø­ÙŠÙˆØ§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", false);
          return;
        }

        _animal = snap.docs[0].data() || {};
        $("reproStatus").value = (_animal.reproductiveStatus || "").toString().trim();
        calcDIM();
        msg("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†.", true);

      }catch(e){
        console.error(e);
        msg("âš ï¸ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†.", false);
      }
    }

    await loadAnimalAndFill();
    $("eventDate").addEventListener("change", calcDIM);

    // âœ… Ø²Ø± "Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†"
    openCowCard.addEventListener("click", ()=>{
      if (!num) { msg("âš ï¸ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø£ÙˆÙ„Ù‹Ø§.", false); return; }
      location.href = `cow-card.html?number=${encodeURIComponent(num)}`;
    });

    // âœ… Ø§Ù„Ø­ÙØ¸ (Ù†ÙØ³ ÙƒÙˆØ¯Ùƒ)
    btn.onclick = async () => {
      try {
        await ensureAuth();
        const uid = auth.currentUser?.uid;
        if (!uid) throw new Error("NO_AUTH");

        const eventDate = ($("eventDate").value || dt).slice(0,10);

        const payload = {
          animalNumber: String(num),
          animalId: String(num),
          type: "Ø´ÙŠØ§Ø¹",
          eventType: "Ø´ÙŠØ§Ø¹",
          eventDate,
          notes: ($("notes").value || "").trim(),
          reproductiveStatusSnapshot: ($("reproStatus").value || "").trim(),
          dimAtEvent: Number($("dim").value) || null,
          userId: uid,
          source: "/heat.html",
          createdAt: serverTimestamp()
        };

        await addDoc(collection(db, "events"), payload);

        // ØªØ­Ø¯ÙŠØ« ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
        await updateAnimalByEvent(payload);

        msg("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´ÙŠØ§Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…", true);

        localStorage.setItem("lastAnimalNumber", String(num));
        localStorage.setItem("lastEventDate", eventDate);

        setTimeout(() => {
          location.href = `cow-card.html?number=${encodeURIComponent(num)}`;
        }, 900);

      } catch (e) {
        console.error(e);
        msg("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸.", false);
      }
    };

    // âœ… Ø§Ù„Ø²Ø± Ø§Ù„Ø³ÙÙ„ÙŠ ÙŠØ³ØªØ¯Ø¹ÙŠ Ù†ÙØ³ Ø­ÙØ¸Ùƒ
    btnUI.addEventListener("click", ()=> btn.onclick());

    // ØªØªØ¨Ø¹ (Ø¨Ø¯ÙˆÙ† ØªØ¹Ø±ÙŠÙ dataLayer Ù‡Ù†Ø§)
    const t = window.t || { event:(n,d)=>window.dataLayer.push({event:n, ...d}) };
    t.event("page_view", { page: "heat", title: "ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠØ§Ø¹" });
  </script>
</body>
</html>
