<!DOCTYPE html>
<html lang="ar" dir="rtl" data-page="sale">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تسجيل بيع — مُرَبِّيك</title>
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <meta name="theme-color" content="#2e7d32" />
  <link rel="stylesheet" href="css/forms.css" />
  <script type="module" src="js/forms-init.js"></script>

  <style>
    /* بدون تغيير تصميم مُرَبِّيك — فقط ترتيب بسيط */
    .wrap{max-width:520px;margin:0 auto;padding:12px}
    .mbk-form{max-width:520px;margin:0 auto}
    .field-hint{font-size:12px;color:#556;margin-top:6px}
    .row-gap{height:6px}
    select,input,textarea{width:100%}
    .inline-readonly{
      padding:10px 12px;
      border:1px solid rgba(46,125,50,0.25);
      border-radius:12px;
      background:#fff;
      color:#143b24;
      font-size:14px;
    }
  </style>
</head>

<body>
  <!-- ✅ هيدر مُرَبِّيك القياسي -->
  <header>
    <div class="mbk-head">
      <img class="mbk-logo" src="/images/logo.png" alt="مُرَبِّيك">
      <div class="mbk-center">
        <div class="mbk-page-title">تسجيل بيع</div>
        <div class="mbk-app-name">مُرَبِّيك</div>
      </div>
      <a class="mbk-back" href="add-event.html">رجوع</a>
    </div>
  </header>

  <main class="mbk-form">
   <form id="saleForm" data-event="بيع" novalidate>
    <div id="info" class="infobar"></div>

    <label>رقم الحيوان</label>
    <input id="animalNumber" data-field="animalNumber" readonly />

    <label>تاريخ البيع</label>
    <input id="eventDate" data-field="eventDate" type="date" required />
   <label>الموسم</label>
<input id="season" data-field="season" type="number" inputmode="numeric" placeholder="مثال: 3" />
<div class="field-hint">يتم تحميل رقم الموسم تلقائيًا من بيانات الحيوان.</div>

    <label>سعر البيع (اختياري)</label>
    <input id="price" data-field="price" type="number" inputmode="decimal" placeholder="مثال: 85000" />

    <label>سبب البيع</label>
    <!-- ✅ قائمة منسدلة -->
    <select id="saleReasonPreset" aria-label="سبب البيع">
      <option value="ذبح اضطراري">ذبح اضطراري</option>
      <option value="استبعاد">استبعاد</option>
      <option value="حادثة">حادثة</option>
      <option value="أخرى">أخرى</option>
    </select>

    <div class="row-gap"></div>

   <input id="saleReason" data-field="saleReason" placeholder="سيتم ملؤه تلقائيًا حسب اختيارك" readonly style="display:none" />
    <input id="saleReasonCustom" placeholder="اكتب سبب البيع" style="display:none" />

    <div id="cullHint" class="field-hint" style="display:none;"></div>

    <label>ملاحظات</label>
    <textarea id="notes" data-field="notes" rows="3" placeholder="اختياري"></textarea>

    <!-- ✅ زر يطلب التحقق المركزي فقط -->
    <div style="display:flex; gap:10px; margin-top:12px;">
 <button id="saveBtn" type="submit" data-validate="true">
  حفظ البيع ✅
</button>
  <button id="cardBtn" type="button" style="flex:1; background:#fff; color:#1b5e20; border:2px solid #1b5e20; border-radius:14px; font-weight:800;">
    بطاقة الحيوان
  </button>
</div>
      </form>
  </main>

  <script type="module">
    import { db, auth, ensureAuth } from "/js/firebase-config.js";
    import { updateAnimalByEvent } from "/js/animal-update.js";
   import {
  collection, addDoc, serverTimestamp,
  getDocs, query, where, orderBy, limit,
  doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);
    const info = $("info");

    function msg(t, ok=false){
      info.className = "infobar " + (ok ? "ok" : "err");
      info.textContent = t;
    }

    const p = new URLSearchParams(location.search);
    const num = p.get("number") || p.get("animalNumber") || localStorage.getItem("lastAnimalNumber") || "";
    const dt  = p.get("date") || p.get("eventDate") || localStorage.getItem("lastEventDate") || new Date().toISOString().slice(0,10);

    $("animalNumber").value = String(num || "");
    $("eventDate").value = dt;
    const cardBtn = $("cardBtn");
if (cardBtn) {
  cardBtn.onclick = () => {
    const n = String(num || "").trim();
    if (n) location.href = `cow-card.html?number=${encodeURIComponent(n)}`;
  };
}

    let lastCullAutoReason = ""; // آخر سبب استبعاد (لو موجود)

    async function prefillLastCullReason(){
      try{
        await ensureAuth();
        const uid = auth.currentUser?.uid;
        if (!uid) return;

        const n = String(num || "").trim();
        if (!n) return;

        // ✅ تصحيح مهم: بياناتك تستخدم animalNumber/animalId وليس number
        const evRef = collection(db, "events");
      const qy = query(
  collection(db, "events"),
  where("userId", "==", uid),
  where("animalNumber", "==", n),
  where("type", "==", "استبعاد"),
  orderBy("eventDate", "desc"),
  limit(1)
);

        const snap = await getDocs(qy);
        if (snap.empty) return;

        const lastCull = snap.docs[0].data() || {};
        const autoReason =
          (String(lastCull.reason || "").trim()) ||
          `${String(lastCull.cullMain||"").trim()} — ${String(lastCull.cullDetail||"").trim()}`.trim();

        lastCullAutoReason = String(autoReason || "").trim();

      }catch(e){
        console.warn("[sale] prefillLastCullReason failed", e);
      }
    }
async function prefillSeason(){
  try{
    await ensureAuth();
    const uid = auth.currentUser?.uid;
    if(!uid) return;

      const n = String(num || "").trim();
    const nNum = Number(n);
    if(!n || !Number.isFinite(nNum)) return;

    const seasonInput = document.getElementById("season");
    if(!seasonInput) return;

    const aq = query(
      collection(db, "animals"),
      where("ownerUid", "==", uid),
      where("animalNumber", "==", nNum),
      limit(1)
    );

    const snap = await getDocs(aq);
    if(snap.empty) return;

    const a = snap.docs[0].data() || {};
    const s = Number(a.lactationNumber);
    if(Number.isFinite(s) && s > 0){
      seasonInput.value = String(s);
    }

  }catch(e){
    console.warn("[sale] prefillSeason failed", e);
  }
}
function addOptionIfMissing(val){
  val = String(val || "").trim();
  if(!val) return;
  const sel = $("saleReasonPreset");
  const exists = Array.from(sel.options).some(o => String(o.value).trim() === val);
  if(exists) return;
  const opt = document.createElement("option");
  opt.value = val;
  opt.textContent = val;
  const other = Array.from(sel.options).find(o => o.value === "أخرى");
  sel.insertBefore(opt, other || null);
}

function applyPresetToSaleReason(){
  const preset = String($("saleReasonPreset").value || "").trim();
  const saleReason = $("saleReason");         // مخفي دائمًا (إلا استبعاد)
  const hint = $("cullHint");
  const custom = $("saleReasonCustom");       // يظهر فقط عند "أخرى"

  // reset
  if (hint){ hint.style.display = "none"; hint.textContent = ""; }
  if (custom){ custom.style.display = "none"; }

  if (preset === "استبعاد"){
    // ✅ يظهر saleReason فقط هنا (لإظهار السبب المسحوب)
    const val = (lastCullAutoReason || "استبعاد").trim();
    saleReason.value = val;
    saleReason.readOnly = true;
    saleReason.style.display = "";

    if (hint){
      hint.style.display = "block";
      hint.textContent = lastCullAutoReason
        ? "تم سحب سبب الاستبعاد تلقائيًا من آخر استبعاد مسجل."
        : "لا يوجد استبعاد سابق — تم ضبط السبب على: استبعاد.";
    }
    return;
  }

  if (preset === "أخرى"){
    // ✅ نخفي saleReason ونظهر حقل كتابة
    saleReason.value = "";
    saleReason.style.display = "none";
    saleReason.readOnly = true;

    custom.style.display = "";
    custom.value = "";
    custom.focus();
    return;
  }

  // ✅ باقي الاختيارات: saleReason مخفي ويتسجل بالقيمة المختارة
  saleReason.value = preset;
  saleReason.readOnly = true;
  saleReason.style.display = "none";
}
    // ابدأ بالسحب ثم طبّق القيمة الافتراضية
    await prefillLastCullReason();
    applyPresetToSaleReason();
    await prefillSeason();
    $("saleReasonPreset").addEventListener("change", applyPresetToSaleReason);
    $("saleReasonCustom")?.addEventListener("blur", () => {
  const typed = String($("saleReasonCustom").value || "").trim();
  if(!typed) return;

  // أضف السبب للدروب داون واختره
  addOptionIfMissing(typed);
  $("saleReasonPreset").value = typed;

  // خزّن القيمة الرسمية في saleReason (المخفي)
  const saleReason = $("saleReason");
  saleReason.value = typed;
  saleReason.style.display = "none";
});
    // ✅ حفظ فقط بعد نجاح التحقق المركزي
    window.addEventListener("mbk:valid", async (ev) => {
      try{
        await ensureAuth();
        const uid = auth.currentUser?.uid;
        if (!uid) throw new Error("NO_AUTH");

        const formData = (ev && ev.detail && ev.detail.formData) ? ev.detail.formData : {};

        const payload = {
          animalNumber: String(formData.animalNumber || num || ""),
          season: Number(formData.season) || null,
          animalId: String(formData.animalNumber || num || ""),
          type: "بيع",
          eventType: "بيع",
          eventDate: String(formData.eventDate || dt || ""),
          price: Number(formData.price) || null,
          saleReason: String(formData.saleReason || "").trim(),
          notes: String(formData.notes || "").trim(),
          userId: uid,
          source: "/sale.html",
          createdAt: serverTimestamp()
        };

        await addDoc(collection(db, "events"), payload);
        await updateAnimalByEvent(payload);

        msg("تم تسجيل البيع بنجاح ✅", true);
        localStorage.setItem("lastAnimalNumber", String(payload.animalNumber));
        localStorage.setItem("lastEventDate", String(payload.eventDate));

        setTimeout(()=>location.href=`cow-card.html?number=${encodeURIComponent(payload.animalNumber)}`, 900);

      }catch(e){
        console.error(e);
        msg("❌ فشل في الحفظ.", false);
      }
    }, { passive: true });

  </script>
</body>
</html>
