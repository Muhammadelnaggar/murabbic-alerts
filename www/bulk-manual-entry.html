<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ Ø¬Ù…Ø§Ø¹ÙŠ â€” Ù…Ø±Ø¨ÙŠÙƒ (Ø§Ø®ØªØ¨Ø§Ø±)</title>
  <style>
    :root{--bg:#fff9db;--card:#fff;--border:#c5e1a5;--green:#2e7d32;--text:#143b24;--muted:#f6fff2}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.45;color:var(--text);padding:18px}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0 0 12px;color:#14532d;text-align:center}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .card h2{margin:0 0 10px;font-size:18px;color:#17623b}
    textarea{width:100%;min-height:140px;background:#fcfff8;border:1px solid var(--border);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:#2e7d32;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
    .btn.out{background:#e8f5e9;color:#1b5e20;border:1px solid var(--border)}
    .help{font-size:13px;color:#315b3f;background:#f6fff2;border:1px solid var(--border);border-radius:10px;padding:8px;margin:8px 0}
    .ok{color:#1b5e20;font-weight:700}
    .err{color:#7f1d1d;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:800px){.grid{grid-template-columns:1fr}}
    .small{font-size:12px;color:#3a5}
    .mono{font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø°ÙƒÙŠ</h1>

    <!-- Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† -->
    <section class="card">
      <h2>Ù¡) Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† (Users)</h2>
      <div class="help">
        ÙƒÙ„ Ø³Ø·Ø± = <span class="mono">userId, name, email</span> â€” Ù…Ø«Ø§Ù„: <span class="mono">demo_u1, Demo User 1, demo1@example.com</span>
      </div>
      <div class="row">
        <button id="tplUsers" class="btn out">ØªÙˆÙ„ÙŠØ¯ 3 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†</button>
        <button id="saveUsers" class="btn">Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <span id="usersMsg"></span>
      </div>
      <textarea id="usersBox" placeholder="demo_u1, Demo User 1, demo1@example.com
demo_u2, Demo User 2, demo2@example.com"></textarea>
    </section>

    <!-- Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª -->
    <section class="card">
      <h2>Ù¢) Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª (Animals)</h2>
      <div class="help">
        ÙƒÙ„ Ø³Ø·Ø± = <span class="mono">userId, number, animaltype, breed, group, birthDate, lastCalvingDate, lactationNumber</span><br>
        Ù€ <b>animaltype</b>: <span class="mono">cow</span> Ø£Ùˆ <span class="mono">buffalo</span> (ØªÙ‚Ø¨Ù„ "Ø¨Ù‚Ø±Ø©/Ø¬Ø§Ù…ÙˆØ³Ø©" Ø£ÙŠØ¶Ù‹Ø§).<br>
        Ù€ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© <span class="mono">YYYY-MM-DD</span>. Ø£ÙŠ Ø¹Ù…ÙˆØ¯ ØªØªØ±ÙƒÙ‡ ÙØ§Ø¶ÙŠ ÙŠØªÙ… ØªØ¹ÙˆÙŠØ¶Ù‡ Ø¨Ù‚ÙŠÙ… Ù…Ø¹Ù‚ÙˆÙ„Ø©.
      </div>
      <div class="row">
        <button id="tplAnimals" class="btn out">ØªÙˆÙ„ÙŠØ¯ 30 Ø¨Ù‚Ø±Ø© + 20 Ø¬Ø§Ù…ÙˆØ³Ø© Ù…ÙˆØ²Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button id="saveAnimals" class="btn">Ø­ÙØ¸ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</button>
        <span id="animalsMsg"></span>
      </div>
      <textarea id="animalsBox" placeholder="demo_u1, 101, cow, Ù‡ÙˆÙ„Ø´ØªØ§ÙŠÙ†, Ø£-Ø§Ù„Ø­Ù„Ø§Ø¨Ø§Øª, 2021-05-20, 2025-04-01, 3
demo_u1, 102, buffalo, Ø¨Ù„Ø¯ÙŠ, Ø¨-Ø§Ù„Ø¹Ø´Ø§Ø±, 2020-11-10, 2025-03-15, 2"></textarea>
    </section>

    <!-- Ø§Ù„Ø£Ø­Ø¯Ø§Ø« -->
    <section class="card">
      <h2>Ù£) Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Events)</h2>
      <div class="help">
        ÙƒÙ„ Ø³Ø·Ø± = <span class="mono">userId, animalNumber, type, eventDate, [extra...]</span><br>
        Ø§Ù„Ù†ÙˆØ¹ (<b>type</b>) ÙˆØ§Ø­Ø¯ Ù…Ù†: <span class="mono">milk | calving | insemination | heat | pregnancy | disease</span><br>
        Ø£Ù…Ø«Ù„Ø©:<br>
        â€¢ Ù„Ø¨Ù† ÙŠÙˆÙ…ÙŠ (Ø¥Ø¬Ù…Ø§Ù„ÙŠ): <span class="mono">demo_u1, 101, milk, 2025-08-30, milkKg=18.5</span><br>
        â€¢ Ù„Ø¨Ù† ÙŠÙˆÙ…ÙŠ (Øµ/Ù…): <span class="mono">demo_u1, 101, milk, 2025-08-30, am=8.3, pm=10.2</span> (Ø³ÙŠÙØ­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)<br>
        â€¢ ØªÙ„Ù‚ÙŠØ­: <span class="mono">demo_u1, 101, insemination, 2025-06-10, semen=Bull-X</span><br>
        â€¢ Ø´ÙŠØ§Ø¹: <span class="mono">demo_u1, 101, heat, 2025-05-20</span><br>
        â€¢ Ø­Ù…Ù„: <span class="mono">demo_u1, 101, pregnancy, 2025-07-20, result=positive</span><br>
        â€¢ ÙˆÙ„Ø§Ø¯Ø©: <span class="mono">demo_u1, 101, calving, 2025-04-01, note=ÙˆÙ„Ø§Ø¯Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©</span><br>
        â€¢ Ù…Ø±Ø¶: <span class="mono">demo_u1, 101, disease, 2025-08-05, diagnosis=Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¶Ø±Ø¹ Ø®ÙÙŠÙ, note=Ø±Ø¨Ø¹ Ø®Ù„ÙÙŠ ÙŠÙ…ÙŠÙ†</span>
      </div>
      <div class="row">
        <button id="tplEvents" class="btn out">ØªÙˆÙ„ÙŠØ¯ Ø£Ø­Ø¯Ø§Ø« Ù†Ù…ÙˆØ°Ø¬ÙŠØ© (Ù„Ø¨Ù†/ØªÙ„Ù‚ÙŠØ­/Ø´ÙŠØ§Ø¹/ÙˆÙ„Ø§Ø¯Ø©)</button>
        <button id="saveEvents" class="btn">Ø­ÙØ¸ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</button>
        <span id="eventsMsg"></span>
      </div>
      <textarea id="eventsBox" placeholder="demo_u1, 101, milk, 2025-08-30, milkKg=18.5
demo_u1, 101, insemination, 2025-06-10, semen=Bull-X"></textarea>
    </section>

    <section class="card">
      <h2>Check-list Ø³Ø±ÙŠØ¹Ø©</h2>
      <div class="grid">
        <div class="help">
          1) Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† â†’ 2) Ø§Ø­ÙØ¸ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª â†’ 3) Ø§Ø­ÙØ¸ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«.<br>
          Ø«Ù… Ø§ÙØªØ­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: <span class="mono">/cow-card.html?number=101</span> Ø£Ùˆ Ù…Ù† Ø®Ø§Ù†Ø© Ø§Ù„Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.
        </div>
        <div class="help">
          Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªÙ…Ø³Ø­ ÙƒÙ„ Ø¯Ø§ØªØ§ Ø§Ù„Ø¯ÙŠÙ…Ùˆ: Ø§ÙØªØ­ Ø§Ù„Ù€ Console ÙˆÙ†ÙÙ‘Ø° <span class="mono">window.cleanupDemo()</span> (Ù…ÙˆØ¬ÙˆØ¯Ø© ØªØ­Øª).
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    // ===== Firebase =====
    const appMod = await import('/js/firebase-config.js');
    const {
      getFirestore, collection, doc, setDoc, addDoc, getDocs, getDoc, writeBatch,
      query, where, limit, serverTimestamp
    } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
    const app = appMod.app || appMod.default || appMod;
    const db  = appMod.db  || getFirestore(app.app || app);

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const today = new Date();
    const ymd = (d)=> d ? new Date(d).toISOString().slice(0,10) : '';
    const toDate = (s)=> {
      if(!s) return null;
      // ÙŠÙ‚Ø¨Ù„ YYYY-MM-DD ÙÙ‚Ø· Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚
      return new Date(s);
    };
    const normKind = (k)=>{const s=String(k??'').trim().toLowerCase();
      if(/^(cow|Ø¨Ù‚Ø±|Ø¨Ù‚Ø±Ø©)$/.test(s)) return 'cow';
      if(/^(buffalo|Ø¬Ø§Ù…ÙˆØ³|Ø¬Ø§Ù…ÙˆØ³Ù‡|Ø¬Ø§Ù…ÙˆØ³Ø©)$/.test(s)) return 'buffalo';
      return 'cow';
    };

    // Parse line "key=value" extras to object
    function parseExtras(tokens){
      const extra = {};
      tokens.forEach(t=>{
        const [k,...rest] = t.split('=');
        if(!k || !rest.length) return;
        const val = rest.join('=').trim();
        extra[k.trim()] = (/^-?\d+(\.\d+)?$/.test(val) ? Number(val) : val);
      });
      return extra;
    }

    // ===== UI Elements =====
    const usersBox   = $('usersBox');
    const animalsBox = $('animalsBox');
    const eventsBox  = $('eventsBox');
    const usersMsg   = $('usersMsg');
    const animalsMsg = $('animalsMsg');
    const eventsMsg  = $('eventsMsg');

    // ===== Templates (prefill) =====
    $('tplUsers').onclick = ()=>{
      usersBox.value = [
        'demo_u1, Demo User 1, demo1@mbk.local',
        'demo_u2, Demo User 2, demo2@mbk.local',
        'demo_u3, Demo User 3, demo3@mbk.local'
      ].join('\\n');
    };

    $('tplAnimals').onclick = ()=>{
      // 30 Ø¨Ù‚Ø±Ø© + 20 Ø¬Ø§Ù…ÙˆØ³Ø© Ù…ÙˆØ²Ø¹Ø© Ø¹Ù„Ù‰ 3 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      const lines = [];
      let num = 101;
      const users = ['demo_u1','demo_u2','demo_u3'];
      const breedsCow = ['Ù‡ÙˆÙ„Ø´ØªØ§ÙŠÙ†','ÙØ±ÙŠØ²ÙŠØ§Ù†'];
      const breedsBuf = ['Ø¨Ù„Ø¯ÙŠ','Ù…ÙØ­Ø³Ù‘Ù†'];
      const groups = ['Ø£-Ø§Ù„Ø­Ù„Ø§Ø¨Ø§Øª','Ø¨-Ø§Ù„Ø¹Ø´Ø§Ø±','Ø¬-Ù‚Ø±ÙŠØ¨Ø© Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©'];

      // 30 Ø¨Ù‚Ø±Ø©
      for (let i=0;i<30;i++){
        const u = users[i%users.length];
        const b = breedsCow[i%breedsCow.length];
        const g = groups[i%groups.length];
        const birth = '2021-01-15';
        const calv  = '2025-04-01';
        lines.push(`${u}, ${num}, cow, ${b}, ${g}, ${birth}, ${calv}, ${2 + (i%3)}`);
        num++;
      }
      // 20 Ø¬Ø§Ù…ÙˆØ³Ø©
      for (let i=0;i<20;i++){
        const u = users[i%users.length];
        const b = breedsBuf[i%breedsBuf.length];
        const g = groups[i%groups.length];
        const birth = '2020-10-10';
        const calv  = '2025-03-15';
        lines.push(`${u}, ${num}, buffalo, ${b}, ${g}, ${birth}, ${calv}, ${1 + (i%3)}`);
        num++;
      }
      animalsBox.value = lines.join('\\n');
    };

    $('tplEvents').onclick = ()=>{
      // Ù†Ù…ÙˆØ°Ø¬: Ù„Ø¨Ù† Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† + ØªÙ„Ù‚ÙŠØ­ + Ø´ÙŠØ§Ø¹ + Ø§Ø­ØªÙ…Ø§Ù„ Ø­Ù…Ù„
      const lines = [];
      // Ø®Ø° Ø£ÙˆÙ„ 10 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† animalsBox Ø¥Ù† ÙˆÙØ¬Ø¯ØªØŒ ÙˆØ¥Ù„Ø§ Ø§ÙØªØ±Ø§Ø¶ÙŠ 101..110
      const nums = [];
      const hasAnimals = animalsBox.value.trim().length>0;
      if (hasAnimals){
        for (const line of animalsBox.value.split(/\\n+/)){
          const parts = line.split(',').map(s=>s.trim());
          if (parts.length>=2 && parts[1]) nums.push({u:parts[0], n:parts[1]});
          if (nums.length>=10) break;
        }
      } else {
        const users = ['demo_u1','demo_u2','demo_u3'];
        for (let n=101;n<=110;n++) nums.push({u:users[n%3], n:String(n)});
      }

      // Ø£Ø³Ø¨ÙˆØ¹Ø§Ù† Ù„Ø¨Ù† ÙŠÙˆÙ…ÙŠ (am/pm)
      const start = new Date('2025-08-15');
      for (const {u,n} of nums){
        for (let d=0; d<14; d++){
          const dd = new Date(start); dd.setDate(dd.getDate()+d);
          const iso = dd.toISOString().slice(0,10);
          const am = (8 + Math.random()*4).toFixed(1);
          const pm = (9 + Math.random()*4).toFixed(1);
          lines.push(`${u}, ${n}, milk, ${iso}, am=${am}, pm=${pm}`);
        }
        // ØªÙ„Ù‚ÙŠØ­ + Ø´ÙŠØ§Ø¹ Ø³Ø§Ø¨Ù‚
        lines.push(`${u}, ${n}, heat, 2025-06-20`);
        lines.push(`${u}, ${n}, insemination, 2025-06-25, semen=Bull-X`);
        // Ø§Ø­ØªÙ…Ø§Ù„ Ø­Ù…Ù„
        if (Math.random()<0.6) lines.push(`${u}, ${n}, pregnancy, 2025-08-05, result=positive`);
        // Ø­Ø¯Ø« ØµØ­ÙŠ Ù…Ø­ØªÙ…Ù„
        if (Math.random()<0.25) lines.push(`${u}, ${n}, disease, 2025-08-22, diagnosis=Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¶Ø±Ø¹ Ø®ÙÙŠÙ, note=Ø±Ø¨Ø¹ Ø®Ù„ÙÙŠ ÙŠÙ…ÙŠÙ†`);
      }
      eventsBox.value = lines.join('\\n');
    };

    // ===== Save USERS =====
    $('saveUsers').onclick = async ()=>{
      usersMsg.textContent='';
      const lines = usersBox.value.split(/\\n+/).map(s=>s.trim()).filter(Boolean);
      if (!lines.length){ usersMsg.innerHTML = '<span class="err">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø·Ø±.</span>'; return; }
      const batch = writeBatch(db);
      const col = collection(db,'users');
      let ok=0;
      for (const ln of lines){
        const [userId,name,email] = ln.split(',').map(s=>s.trim());
        if (!userId){ continue; }
        batch.set(doc(col, userId), {
          name: name || userId, email: email || `${userId}@mbk.local`,
          demo: true, createdAt: serverTimestamp()
        }, {merge:true});
        ok++;
      }
      await batch.commit();
      usersMsg.innerHTML = `<span class="ok">ØªÙ… Ø­ÙØ¸ ${ok} Ù…Ø³ØªØ®Ø¯Ù…(ÙŠÙ†).</span>`;
    };

    // ===== Save ANIMALS =====
    $('saveAnimals').onclick = async ()=>{
      animalsMsg.textContent='';
      const lines = animalsBox.value.split(/\\n+/).map(s=>s.trim()).filter(Boolean);
      if (!lines.length){ animalsMsg.innerHTML = '<span class="err">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø·Ø±.</span>'; return; }
      const col = collection(db,'animals');
      let ok=0;
      const batchSize = 400; // Ù†ÙƒØªØ¨ ÙØ±Ø¯ÙŠ Ù„ØªÙØ§Ø¯ÙŠ ØªØ¬Ø§ÙˆØ² Ø­Ø¬Ù… Ø§Ù„Ø¯ÙˆÙƒÙŠÙˆÙ…Ù†Øª
      for (const ln of lines){
        const [userId, number, kind, breed, group, birthDate, lastCalvingDate, lactNo] =
          ln.split(',').map(s=>s.trim());
        if(!userId || !number) continue;
        const animaltype = normKind(kind||'cow');
        const ref = doc(col); // id ØªÙ„Ù‚Ø§Ø¦ÙŠ
        const docData = {
          userId,
          number: String(number),
          animalNumber: Number(number),
          userId_number: `${userId}#${String(number)}`,
          animaltype,
          breed: breed || 'Ù‡ÙˆÙ„Ø´ØªØ§ÙŠÙ†',
          group: group || 'Ø£-Ø§Ù„Ø­Ù„Ø§Ø¨Ø§Øª',
          birthDate: birthDate || '2021-01-01',
          lastCalvingDate: lastCalvingDate || '2025-04-01',
          lactationNumber: Number(lactNo||2),
          milkTraitsScore: 60,
          reproductiveStatus: 'Ù…ÙØªÙˆØ­Ø©',
          healthStatus: 'Ø³Ù„ÙŠÙ…',
          demo: true, createdAt: serverTimestamp()
        };
        await setDoc(ref, docData);
        ok++;
      }
      animalsMsg.innerHTML = `<span class="ok">ØªÙ… Ø­ÙØ¸ ${ok} Ø­ÙŠÙˆØ§Ù†.</span>`;
    };

    // Ø§Ø¨Ø­Ø« animalId Ù„ÙƒÙ„ Ø±Ù‚Ù… + Ù…Ø³ØªØ®Ø¯Ù…
    async function resolveAnimalId(userId, number){
      const A = collection(db,'animals');
      const qs = [
        query(A, where('userId','==', userId), where('number','==', String(number)), limit(1)),
        query(A, where('userId','==', userId), where('animalNumber','==', Number(number)), limit(1))
      ];
      for (const qy of qs){
        const snap = await getDocs(qy);
        if(!snap.empty) return snap.docs[0].id;
      }
      // Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙˆÙ† userId
      const snap2 = await getDocs(query(A, where('number','==', String(number)), limit(1)));
      if(!snap2.empty) return snap2.docs[0].id;
      return null;
    }

    // ===== Save EVENTS =====
    $('saveEvents').onclick = async ()=>{
      eventsMsg.textContent='';
      const lines = eventsBox.value.split(/\\n+/).map(s=>s.trim()).filter(Boolean);
      if (!lines.length){ eventsMsg.innerHTML = '<span class="err">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø·Ø±.</span>'; return; }

      const E = collection(db,'events');
      let ok=0, fail=0;

      // Ù†ÙƒØªØ¨ Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª Ù„ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø­Ù„Ø§Øª
      for (const ln of lines){
        const parts = ln.split(',').map(s=>s.trim());
        if (parts.length < 4){ fail++; continue; }
        const [userId, animalNumber, type, date, ...rest] = parts;
        const eventDate = (date && /^\d{4}-\d{2}-\d{2}$/.test(date)) ? date : ymd(new Date(date));
        const kind = String(type||'').toLowerCase();
        const extra = parseExtras(rest);

        try{
          const animalId = await resolveAnimalId(userId, animalNumber);
          const base = {
            userId: userId || null,
            animalId: animalId || null,
            animalNumber: String(animalNumber),
            animalNumberNum: Number(animalNumber),
            type: kind,                         // Ù‚ÙŠÙ… Ù‚ÙŠØ§Ø³ÙŠØ© ØªØ´ØªØºÙ„ Ù…Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
            eventDate,
            demo: true,
            createdAt: serverTimestamp()
          };

          // Ù„Ø¨Ù†: milkKg Ù…Ù† extra Ø£Ùˆ am+pm
          if (kind==='milk'){
            const milkKg = (extra.milkKg!=null) ? Number(extra.milkKg)
                          : ((Number(extra.am||0)+Number(extra.pm||0))||null);
            await addDoc(E, { ...base, milkKg, ...extra });
          } else {
            await addDoc(E, { ...base, ...extra });
          }
          ok++;
        } catch(e){
          console.error(e); fail++;
        }
      }

      const msg = `<span class="ok">ØªÙ… Ø­ÙØ¸ ${ok} Ø­Ø¯Ø«.</span>` + (fail? ` <span class="err">(${fail} ÙØ´Ù„)</span>`:'');
      eventsMsg.innerHTML = msg;
    };

    // ===== Cleanup demo data (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) =====
    async function cleanupDemo(){
      const { getDocs, query, where, collection, writeBatch, doc } =
        await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');

      // Ø§Ø­Ø°Ù events Ø­ÙŠØ« demo==true
      const eventsQ = query(collection(db,'events'), where('demo','==', true));
      const eventsSnap = await getDocs(eventsQ);
      const batch1 = writeBatch(db);
      eventsSnap.forEach(d=> batch1.delete(doc(db,'events',d.id)));
      await batch1.commit();

      // Ø§Ø­Ø°Ù animals Ø­ÙŠØ« demo==true
      const animalsQ = query(collection(db,'animals'), where('demo','==', true));
      const animalsSnap = await getDocs(animalsQ);
      const batch2 = writeBatch(db);
      animalsSnap.forEach(d=> batch2.delete(doc(db,'animals',d.id)));
      await batch2.commit();

      // Ø§Ø­Ø°Ù users Ø­ÙŠØ« demo==true
      const usersQ = query(collection(db,'users'), where('demo','==', true));
      const usersSnap = await getDocs(usersQ);
      const batch3 = writeBatch(db);
      usersSnap.forEach(d=> batch3.delete(doc(db,'users',d.id)));
      await batch3.commit();

      alert('ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ…Ùˆ');
    }
    window.cleanupDemo = cleanupDemo;
  </script>
</body>
</html>
