<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>قائمة أحداث الحيوان — مُرَبِّك</title>

  <style>
    :root{
      --brand:#0ea05a;--brand-600:#0b7f47;
      --bg:#f7faf7;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--border:#e2e8f0;--thead:#f8fafc;
      --pill-bg:#ecfdf5;--pill-br:#bbf7d0;--pill-ink:#065f46;
      --warn-bg:#fff7ed;--warn-br:#fed7aa;--warn-ink:#7c2d12;
      --w1:120px; /* التاريخ — يُضبط آليًا */
      --w2:160px; /* الحدث — يُضبط آليًا */
    }
    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{margin:0;font-family:'Cairo',system-ui,Segoe UI,Roboto,Tahoma,Arial;background:var(--bg);color:var(--ink)}
    a{color:inherit}

    .wrap{padding:12px}
    .head{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .title{font-weight:900;color:var(--brand-600);font-size:16px}
    .meta{font-size:12px;color:var(--muted)}
    .actions{margin-inline-start:auto;display:flex;gap:8px}
    .btn{display:inline-block;background:var(--brand);color:#fff;padding:10px 12px;border-radius:12px;font-weight:800;text-decoration:none;border:1px solid transparent}
    .btn.ghost{background:var(--card);color:var(--brand-600);border-color:var(--border)}

    .filters{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
    .filters label{font-size:12px;color:var(--muted)}
    .filters input,.filters select{padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--card);font-family:inherit}
    .filters .num{display:flex;align-items:center;gap:6px}
    .filters input[readonly]{background:#f9fafb;color:#475569}

    .table-wrap{border:1px solid var(--border);border-radius:12px;background:var(--card);overflow:hidden}
    .scroll{max-height:72vh;overflow:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}

    table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px;table-layout:auto}
    thead th{position:sticky;top:0;background:var(--thead);border-bottom:1px solid var(--border);padding:10px;text-align:right;z-index:5;white-space:nowrap}
    tbody td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top;background:#fff}
    tbody tr:hover td{background:#f9fff8}

    /* عمودان ثابتان (يمين لكون RTL) */
    .sticky-1,.sticky-2{position:sticky;z-index:6;background:#fff}
    .sticky-1{inset-inline-end:0;min-width:var(--w1);max-width:calc(var(--w1) + 2px);white-space:nowrap}
    .sticky-2{inset-inline-end:var(--w1);min-width:var(--w2);max-width:calc(var(--w2) + 2px);white-space:nowrap}
    thead .sticky-1, thead .sticky-2{background:var(--thead);z-index:7}

    /* تفاصيل تمرير أفقي مريح على الموبايل */
    .flex-col{min-width:520px}
    @media (max-width:480px){
      .title{font-size:15px}
      table{font-size:13px}
      .flex-col{min-width:360px}
      .btn{padding:9px 12px}
      .filters input,.filters select{padding:8px}
    }

    .pill{display:inline-block;background:var(--pill-bg);border:1px solid var(--pill-br);color:var(--pill-ink);
      border-radius:999px;padding:2px 8px;font-size:12px;font-weight:800;white-space:nowrap}
    .empty{padding:14px;text-align:center;color:var(--muted)}
    .err{background:var(--warn-bg);border:1px solid var(--warn-br);color:var(--warn-ink);padding:10px;border-radius:10px;margin-bottom:8px;font-weight:700;display:none}
    .err.show{display:block}

    /* هيكل تحميل بسيط */
    .skeleton td{background:linear-gradient(100deg,#f2f6f4 40%,#eaf3ee 50%,#f2f6f4 60%);background-size:200% 100%;animation:s 1.2s infinite linear}
    @keyframes s{to{background-position:-200% 0}}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="err" class="err"></div>

    <header class="head" aria-label="رأس الصفحة">
      <div class="title">أحداث هذا الموسم</div>
      <div id="meta" class="meta">—</div>
      <nav class="actions" aria-label="تنقّل">
        <a id="openCard" class="btn" href="#">بطاقة الحيوان</a>
        <a class="btn ghost" href="dashboard.html">رجوع للوحة التحكم</a>
      </nav>
    </header>

    <section class="filters" aria-label="مرشّحات">
      <div class="num">
        <label for="animalNumField">رقم الحيوان:</label>
        <input id="animalNumField" inputmode="numeric" placeholder="—" readonly />
      </div>
      <label for="catFilter">فلترة:</label>
      <select id="catFilter">
        <option value="">الكل</option>
        <option value="انتاج">انتاج</option>
        <option value="تناسليات">تناسليات</option>
        <option value="صحة">صحة</option>
        <option value="تقييم بالكاميرا">تقييم بالكاميرا</option>
        <option value="تغذية">تغذية</option>
      </select>
    </section>

    <section class="table-wrap" aria-label="جدول الأحداث">
      <div class="scroll">
        <table dir="rtl" id="eventsTable">
          <thead>
            <tr>
              <th class="sticky-1">التاريخ</th>
              <th class="sticky-2">الحدث</th>
              <th class="flex-col">تفاصيل / قيَم الحدث</th>
            </tr>
          </thead>
          <tbody id="rows" class="skeleton">
            <tr><td colspan="3" class="empty">جارٍ التحميل…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script type="module">
    import { db, auth } from '/js/firebase-config.js';
    import {
      collection, getDocs, query, where, orderBy, limit
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // ---------- DOM ----------
    const $ = (sel,root=document)=>root.querySelector(sel);
    const rows   = $('#rows');
    const metaEl = $('#meta');
    const table  = $('#eventsTable');
    const fldNum = $('#animalNumField');
    const selCat = $('#catFilter');
    const errBox = $('#err');
    const openCard = $('#openCard');

    // ---------- Identity ----------
    let UID = null, TID = null;
    const qp = new URLSearchParams(location.search);
    const getQNum = () => qp.get('number') || qp.get('animalNumber') || qp.get('animalId') || '';
    const getQCat = () => qp.get('cat') || '';

    // ---------- Helpers ----------
    const showErr = (msg) => { errBox.textContent = msg; errBox.classList.add('show'); };
    const hideErr = () => { errBox.classList.remove('show'); errBox.textContent=''; };

    // Arabic event label
    const arabicType = (ev) => {
      if (ev.type) return ev.type;
      const map = {
        calving:'ولادة', dry_off:'تجفيف', insemination:'تلقيح',
        pregnancy_diagnosis:'تشخيص حمل', daily_milk:'لبن يومي',
        mastitis:'التهاب ضرع', lameness:'عرج', vaccination:'تطعيم',
        close_up:'كلوز أب', nutrition:'تغذية',
        milking_traits_eval:'سمات اللبن (كاميرا)', bcs_eval:'تقييم حالة الجسم', feces_eval:'تقييم الروث'
      };
      return map[ev.eventType] || 'حدث';
    };

    // Category mapping (للترشيح الاختياري)
    const CATEGORY_MAP = {
      'انتاج' : ['daily_milk','dry_off'],
      'تناسليات': ['insemination','calving','pregnancy_diagnosis','close_up'],
      'صحة'  : ['mastitis','lameness','vaccination','treatment','health'],
      'تقييم بالكاميرا': ['camera_eval','vision_eval','camera_assessment','milking_traits_eval','bcs_eval','feces_eval'],
      'تغذية' : ['nutrition','feeding']
    };
    const categoryOf = (ev)=>{
      const explicit = ev.category || ev.eventCategory || ev.cat;
      if (explicit) return explicit;
      const t = (ev.eventType||'').toString();
      for (const [cat, types] of Object.entries(CATEGORY_MAP)){
        if (types.includes(t)) return cat;
      }
      return 'أخرى';
    };
    const filterByCat = (arr, cat)=> !cat ? arr : arr.filter(e=>categoryOf(e)===cat);

    const fmtDate = (ev) => {
      if (ev.eventDate) return ev.eventDate; // YYYY-MM-DD
      const ts = ev.createdAt?.toDate?.();
      return ts ? ts.toISOString().slice(0,10) : '';
    };

    // مُساعد لالتقاط قيمة أول مفتاح موجود من بدائل متعددة
    const pick = (obj, keys, suffix='')=>{
      for (const k of keys){ if (obj?.[k] !== undefined && obj?.[k] !== '') return `${obj[k]}${suffix}`; }
      return null;
    };
    const joinParts = (arr)=> arr.filter(Boolean).join(' • ');

    // === تفاصيل الحدث بحسب النوع (بدلاً من notes) ===
    function detailsFor(ev){
      const t = ev.eventType || '';
      // —— تلقيح
      if (t === 'insemination'){
        const time = pick(ev, ['timeOfDay','aiTime','shift','period']); // صباح/مساء
        const bull = pick(ev, ['bullName','semenBull','stallion','semenCode']);
        const dose = pick(ev, ['doseNo','strawNo'],' قشّة');
        const tech = pick(ev, ['technician','aiTech','operator'],' (فني)');
        const heat = pick(ev, ['heatScore','heat'],' حرارة');
        const dim  = pick(ev, ['dim','daysInMilk'],' DIM');
        return joinParts([time && `وقت: ${time}`, bull && `الطلوقة: ${bull}`, dose, tech, heat, dim]);
      }
      // —— تشخيص حمل
      if (t === 'pregnancy_diagnosis'){
        const method = pick(ev, ['method','pdMethod']); // سونار/يدوي
        const res = pick(ev, ['result','pregResult']);  // حامل/غير حامل
        const age = pick(ev, ['fetusAgeDays','fetusAge','gestationAgeDays'],' يوم');
        const twin = ev.twin ? 'توائم' : null;
        return joinParts([method && `طريقة: ${method}`, res && `النتيجة: ${res}`, age && `عمر الجنين: ${age}`, twin]);
      }
      // —— ولادة
      if (t === 'calving'){
        const sex = pick(ev, ['calfSex','sex']); // ذكر/أنثى
        const type = pick(ev, ['birthType','calvingType']); // مفرد/توائم
        const diff = pick(ev, ['dystocia','difficulty']);
        const rp = ev.retainedPlacenta ? 'احتباس مشيمة' : null;
        const calfId = pick(ev, ['calfNumber','calfId']);
        return joinParts([type && `الولادة: ${type}`, sex && `الجنس: ${sex}`, calfId && `رقم العجل: ${calfId}`, diff && `عسرة: ${diff}`, rp]);
      }
      // —— لبن يومي
      if (t === 'daily_milk'){
        const kg   = pick(ev, ['milkKg','milk','yield'],' كجم');
        const shift= pick(ev, ['shift','timeOfDay']); // صباح/مساء
        const fat  = pick(ev, ['fat','fatPct','fatPercent'],'% دهن');
        const pr   = pick(ev, ['protein','proteinPct','proteinPercent'],'% بروتين');
        const lac  = pick(ev, ['lactose','lactosePct'],'% لاكتوز');
        const snf  = pick(ev, ['snf','snfPct'],'% SNF');
        const scc  = pick(ev, ['scc','somaticCellCount']); // خلية/مل
        const ec   = pick(ev, ['ec','conductivity'],' mS/cm');
        const temp = pick(ev, ['milkTemp'],'°C');
        return joinParts([kg && `لبن: ${kg}`, shift && `وردية: ${shift}`, fat, pr, lac, snf, scc && `SCC: ${scc}`, ec && `EC: ${ec}`, temp && `حرارة: ${temp}`]);
      }
      // —— سمات اللبن بالكاميرا
      if (t === 'milking_traits_eval'){
        const speed = pick(ev, ['milkingSpeed','speed'],' كجم/دقيقة');
        const letdown = pick(ev, ['letdownTime'],' ثانية');
        const udderD  = pick(ev, ['udderDepth']);
        const attach  = pick(ev, ['udderAttachment','foreUdderAttachment']);
        const teatL   = pick(ev, ['teatLength'],' مم');
        const teatD   = pick(ev, ['teatDiameter'],' مم');
        const teatP   = pick(ev, ['teatPlacement']);
        const mast    = pick(ev, ['mastitisRisk','mastitisScore']);
        return joinParts([
          speed && `سرعة الحلب: ${speed}`, letdown && `نزول اللبن: ${letdown}`,
          udderD && `عمق الضرع: ${udderD}`, attach && `اتصال: ${attach}`,
          teatL && `طول الحلمة: ${teatL}`, teatD && `قطر: ${teatD}`, teatP && `تموضع: ${teatP}`,
          mast && `مخاطر الضرع: ${mast}`
        ]);
      }
      // —— تقييم حالة الجسم
      if (t === 'bcs_eval'){
        const score = pick(ev, ['score','bcs']);
        const rump  = pick(ev, ['rumpAngle']);
        const ribs  = pick(ev, ['shortRibs']);
        const spine = pick(ev, ['backbones']);
        return joinParts([score && `BCS: ${score}`, rump && `زاوية العجز: ${rump}`, ribs && `الأضلاع القصيرة: ${ribs}`, spine && `الفقرات: ${spine}`]);
      }
      // —— تقييم الروث
      if (t === 'feces_eval' || t === 'feces' || t === 'feaces'){
        const score = pick(ev, ['score','fecesScore']);
        const cons  = pick(ev, ['consistency']);
        const fiber = pick(ev, ['longFibers']);
        return joinParts([score && `درجة الروث: ${score}`, cons && `القوام: ${cons}`, fiber && `ألياف طويلة: ${fiber}`]);
      }
      // —— ضرع/عرج/تطعيم/علاج
      if (t === 'mastitis'){
        const q = pick(ev, ['quarter','teatQuarter']); // RF/RH/LF/LH
        const cmt = pick(ev, ['cmt','cmtScore']);
        const sev = pick(ev, ['severity']);
        return joinParts([q && `ربع: ${q}`, cmt && `CMT: ${cmt}`, sev && `شدة: ${sev}`]);
      }
      if (t === 'lameness'){
        const sc = pick(ev, ['score','lamenessScore']);
        const leg= pick(ev, ['leg','affectedLeg']);
        const cause = pick(ev, ['cause']);
        return joinParts([sc && `درجة العرج: ${sc}`, leg && `الرجل: ${leg}`, cause && `سبب: ${cause}`]);
      }
      if (t === 'vaccination'){
        const v = pick(ev, ['vaccine','vaccineName']);
        const dose = pick(ev, ['dose'],' جرعة');
        const route= pick(ev, ['route']);
        return joinParts([v && `لقاح: ${v}`, dose, route && `مسار: ${route}`]);
      }
      // —— تغذية
      if (t === 'nutrition' || t === 'feeding'){
        const mode  = pick(ev, ['mode','rationType']); // TMR/Split…
        const dm    = pick(ev, ['dm','dmPct'],'% DM');
        const cp    = pick(ev, ['cp','cpPct'],'% بروتين');
        const ndf   = pick(ev, ['ndf','ndfPct'],'% NDF');
        const st    = pick(ev, ['starch','starchPct'],'% نشا');
        const cost  = pick(ev, ['feedCost','costPerHead'],' ج/رأس/يوم');
        const fcr   = pick(ev, ['fc','fcr','feedToMilk']);
        return joinParts([mode && `نمط: ${mode}`, dm, cp, ndf, st, cost && `تكلفة: ${cost}`, fcr && `F:C: ${fcr}`]);
      }

      // افتراضي: استعرض أشهر الحقول لو وُجدت
      const dim = pick(ev, ['dim'],' DIM');
      const kg  = pick(ev, ['milkKg'],' كجم');
      const temp= pick(ev, ['temp'],'°C');
      const generic = joinParts([kg && `لبن: ${kg}`, dim && `DIM: ${dim}`, temp && `حرارة: ${temp}`]);
      return generic || (ev.notes || ev.aiHints || '');
    }

    // شروط المالك + حقل الحيوان
    function scopeWheres(animalField, num){
      const wh = [];
      if (TID) wh.push(where('tenantId','==', TID));
      if (UID) wh.push(where('userId','==',   UID));
      wh.push(where(animalField,'==', num));
      return wh;
    }

    // انتظار حالة الدخول
    function waitAuth(){ return new Promise(res=>{ const off = onAuthStateChanged(auth,(u)=>{ off(); res(u||null); }); }); }

    // ولادات لتحديد حدود الموسم
    async function getCalvings(num, dir='desc', lim=8){
      const evs = collection(db,'events');
      const q1 = query(evs, ...scopeWheres('animalNumber',num), where('eventType','==','calving'), orderBy('eventDate',dir), limit(lim));
      const q2 = query(evs, ...scopeWheres('animalId',num),     where('eventType','==','calving'), orderBy('eventDate',dir), limit(lim));
      const [s1,s2] = await Promise.all([getDocs(q1), getDocs(q2)]);
      const arr = [...s1.docs, ...s2.docs].map(d=>({id:d.id, ...d.data()}));
      const seen = new Set(); return arr.filter(e=> (seen.has(e.id)?false:(seen.add(e.id),true)));
    }

    // بروفايل الحيوان
    async function getAnimalProfile(num){
      try{
        const animals = collection(db,'animals');
        const owner = [
          ...(UID ? [where('userId','==',UID)] : []),
          ...(TID ? [where('tenantId','==',TID)] : [])
        ];
        const qs = [
          query(animals, ...owner, where('number','==',num), limit(1)),
          query(animals, ...owner, where('animalNumber','==',num), limit(1)),
          query(animals, ...owner, where('animalId','==',num), limit(1)),
        ];
        const res = await Promise.all(qs.map(getDocs));
        const hit = res.find(s=>!s.empty);
        return hit ? hit.docs[0].data() : null;
      }catch{ return null; }
    }

    // حدود الموسم
    async function getSeasonBounds(num, todayISO, profile){
      let start = profile?.lastCalvingDate || profile?.lastCalving || profile?.lastCalvingISO || null;
      if (!start){
        const calvDesc = await getCalvings(num,'desc',8);
        const last = calvDesc.find(c=>c.eventDate && c.eventDate<=todayISO);
        start = last?.eventDate || null;
      }
      let end = null;
      if (start){
        const calvAsc = await getCalvings(num,'asc',8);
        end = calvAsc.find(c=>c.eventDate && c.eventDate>start)?.eventDate || null;
      }
      return {start, end};
    }

    // جلب الأحداث
    async function getEventsForRange(num, startISO, endISO){
      const evs = collection(db,'events');
      const mk = (animalField)=>{
        const base = scopeWheres(animalField,num);
        if (startISO && endISO){
          return query(evs, ...base, where('eventDate','>=',startISO), where('eventDate','<',endISO), orderBy('eventDate','desc'));
        }else if (startISO){
          return query(evs, ...base, where('eventDate','>=',startISO), orderBy('eventDate','desc'));
        }else{
          return query(evs, ...base, orderBy('eventDate','desc'));
        }
      };
      const [s1,s2] = await Promise.all([getDocs(mk('animalNumber')), getDocs(mk('animalId'))]);
      const all = [...s1.docs, ...s2.docs].map(d=>({id:d.id, ...d.data()}));
      const seen = new Set();
      const merged = all.filter(e=> (seen.has(e.id)?false:(seen.add(e.id),true)));
      merged.sort((a,b)=> (b.eventDate||'').localeCompare(a.eventDate||''));
      return merged;
    }

    // قياس عرض أول عمودين وفق المحتوى
    function sizeStickyColumns(){
      const th1 = $('thead th.sticky-1', table);
      const th2 = $('thead th.sticky-2', table);
      if (!th1 || !th2) return;
      const col1 = table.querySelectorAll('tbody td.col-1, thead th.sticky-1');
      const col2 = table.querySelectorAll('tbody td.col-2, thead th.sticky-2');
      const pad = 16;
      const w1 = Math.ceil([...col1].reduce((mx,c)=>Math.max(mx, c.scrollWidth), th1.scrollWidth)) + pad;
      const w2 = Math.ceil([...col2].reduce((mx,c)=>Math.max(mx, c.scrollWidth), th2.scrollWidth)) + pad;
      table.style.setProperty('--w1', w1 + 'px');
      table.style.setProperty('--w2', w2 + 'px');
    }

    // رسم الصفوف
    function renderRows(events, bounds){
      rows.classList.remove('skeleton');
      rows.innerHTML = '';

      if (!events.length){
        rows.innerHTML = '<tr><td colspan="3" class="empty">لا توجد أحداث ضمن هذا الموسم.</td></tr>';
      }else{
        const frag = document.createDocumentFragment();
        for(const ev of events){
          const tr  = document.createElement('tr');

          const td1 = document.createElement('td');
          td1.className = 'sticky-1 col-1';
          td1.textContent = fmtDate(ev);

          const td2 = document.createElement('td');
          td2.className = 'sticky-2 col-2';
          td2.innerHTML = `<span class="pill" title="${ev.eventType||''}">${arabicType(ev)}</span>`;

          const td3 = document.createElement('td');
          td3.className = 'flex-col';
          td3.textContent = detailsFor(ev);   // ← التفاصيل من الحقول نفسها

          tr.append(td1, td2, td3);
          frag.appendChild(tr);
        }
        rows.appendChild(frag);
      }

      if (!bounds.start){
        metaEl.textContent = 'كل الأحداث (لا توجد ولادة مسجَّلة كبداية موسم)';
      }else if (bounds.end){
        metaEl.textContent = `من الولادة ${bounds.start} حتى قبل الولادة ${bounds.end}`;
      }else{
        metaEl.textContent = `من الولادة ${bounds.start} حتى اليوم`;
      }

      requestAnimationFrame(sizeStickyColumns);
    }

    // تدفق التشغيل
    (async function main(){
      hideErr();

      const user = auth.currentUser || await waitAuth();
      if (!user){
        rows.classList.remove('skeleton');
        rows.innerHTML = '<tr><td colspan="3" class="empty">يلزم تسجيل الدخول لعرض الأحداث.</td></tr>';
        metaEl.textContent = '—';
        return;
      }
      UID = user.uid;
      TID = localStorage.getItem('tenantId') || null;

      const num = getQNum();
      fldNum.value = num || '';
      if (!num){
        rows.classList.remove('skeleton');
        rows.innerHTML = '<tr><td colspan="3" class="empty">لم يتم تمرير رقم الحيوان.</td></tr>';
        return;
      }

      if (openCard) openCard.href = `cow-card.html?number=${encodeURIComponent(num)}`;
      selCat.value = getQCat();

      const today = new Date().toISOString().slice(0,10);
      const profile = await getAnimalProfile(num);
      const bounds  = await getSeasonBounds(num, today, profile);

      const allEvents = await getEventsForRange(num, bounds.start || null, bounds.end || null);
      renderRows(filterByCat(allEvents, selCat.value || ''), bounds);

      selCat.addEventListener('change', ()=>{
        const cat = selCat.value || '';
        const url = new URL(location.href);
        if (cat) url.searchParams.set('cat',cat); else url.searchParams.delete('cat');
        history.replaceState({},'',url.toString());
        renderRows(filterByCat(allEvents, cat), bounds);
      });

      addEventListener('resize', ()=> requestAnimationFrame(sizeStickyColumns), {passive:true});
      addEventListener('orientationchange', ()=> setTimeout(sizeStickyColumns, 200), {passive:true});
    })().catch(err=>{
      console.error(err);
      showErr('تعذّر تحميل الأحداث. تأكّد من الصلاحيات وقواعد Firestore (murabbikdata).');
      rows.classList.remove('skeleton');
    });
  </script>
</body>
</html>
