<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ù‚Ø§Ø¦Ù…Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­ÙŠÙˆØ§Ù† â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</title>
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <meta name="theme-color" content="#2e7d32" />

  <!-- Ù†ÙØ³ Ø§Ø¹ØªÙ…Ø§Ø¯ animal-list -->
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <style>
    :root{ --green:#2e7d32; --green-600:#1b5e20; --bg:#fff9db; --card:#fff; --border:#c5e1a5; --ink:#143b24; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Cairo',Arial;line-height:1.45;color:var(--ink);padding:12px}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0 0 10px;font-size:20px;color:var(--green-600);text-align:center}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0 12px}
    .controls input,.controls select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font:14px system-ui}
    .controls button{padding:10px 14px;border-radius:10px;border:1px solid var(--green-600);background:var(--green);color:#fff;font-weight:700;cursor:pointer}
    .controls .ghost{background:#fff;color:var(--green-600)}
    .table{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:top}
    thead th{position:sticky;top:0;background:#f6fff2;color:#2e7d32;font-weight:800;z-index:1}
    tbody tr:last-child td{border-bottom:none}
    .muted{color:#556}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #bbf7d0;border-radius:999px;background:#ecfdf5;color:#065f46;font-size:12px}
    .center{display:flex;align-items:center;gap:8px;justify-content:center}
    .empty{padding:18px;text-align:center;color:#6b7280}
  </style>
  <!-- Ø­Ù…Ù‘ÙÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙƒÙ…Ù„Ù Ø¹Ø§Ø¯ÙŠ (ØºÙŠØ± ESM) Ù„ÙŠØ¶Ø¹ firebaseConfig Ø¹Ù„Ù‰ window -->
  <script src="/js/firebase-config.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Ù‚Ø§Ø¦Ù…Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­ÙŠÙˆØ§Ù†</h1>

    <div class="controls">
      <input id="f-num" type="text" inputmode="numeric" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† (Ù…Ø«Ø§Ù„ 108)" aria-label="Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†">
      <select id="f-type" aria-label="Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø«">
        <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
        <option>ØªÙ„Ù‚ÙŠØ­</option>
        <option>Ù„Ø¨Ù† ÙŠÙˆÙ…ÙŠ</option>
        <option>ÙˆÙ„Ø§Ø¯Ø©</option>
        <option>ØªØ´Ø®ÙŠØµ Ø­Ù…Ù„</option>
        <option>ØªØ­ØµÙŠÙ†</option>
        <option>ØªÙ‚Ù„ÙŠÙ… Ø§Ù„Ø­ÙˆØ§ÙØ±</option>
        <option>Ø¹Ø±Ø¬</option>
        <option>Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø¶Ø±Ø¹</option>
      </select>
      <button id="btn-apply">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©</button>
      <button id="btn-clear" class="ghost">ØªØµÙÙŠØ±</button>
    </div>

    <div class="table">
      <table id="evTable" dir="rtl">
        <thead>
          <tr>
            <th style="width:120px">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¯Ø«</th>
            <th style="width:90px">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</th>
            <th style="width:130px">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø«</th>
            <th>ØªÙØ§ØµÙŠÙ„</th>
          </tr>
        </thead>
        <tbody id="evBody">
          <tr><td colspan="4" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯â€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // ğŸ”§ Ø­Ù…Ù‘ÙÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ² Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØµØ¯ÙŠØ± (default Ø£Ùˆ firebaseConfig)
    // ğŸ”§ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ² Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (ØªØ¬Ù†Ù‘Ø¨ Ù…Ø´Ø§ÙƒÙ„ ESM/default)
    const firebaseConfig = window.firebaseConfig || window.FIREBASE_CONFIG;
    if(!firebaseConfig){
      console.error('firebase-config.js Ù„Ø§ ÙŠØ¹Ø±Ù‘Ù window.firebaseConfig');
      const evBody = document.getElementById('evBody');
      if (evBody) evBody.innerHTML = '<tr><td colspan="4" class="empty">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† /js/firebase-config.js ÙŠÙØ³Ù†Ø¯ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¥Ù„Ù‰ <code>window.firebaseConfig</code></td></tr>';
      throw new Error('Missing firebaseConfig on window');
    }

    // Ø«ÙˆØ§Ø¨Øª DOM
    const fNum  = document.getElementById('f-num');
    const fType = document.getElementById('f-type');
    const btnApply = document.getElementById('btn-apply');
    const btnClear = document.getElementById('btn-clear');
    const evBody = document.getElementById('evBody');

    // ØªÙ‡ÙŠØ¦Ø© ÙÙŠØ±Ø¨ÙŠØ² + Firestore Ø¨Ø§Ø³Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app, 'murabbikdata');

    // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
    const pick = (obj, keys, def='') => { for (const k of keys) { if (obj && obj[k] != null && obj[k] !== '') return obj[k]; } return def; };
    const getParam = (...keys) => { const u=new URL(location.href); for (const k of keys){ const v=u.searchParams.get(k); if(v!=null && v!=='') return v; } return ''; };

    function currentUserId(){
      const viaUrl = getParam('userId','uid');
      const ls = viaUrl || localStorage.getItem('userId') || localStorage.getItem('uid') || '';
      if(ls) return ls;
      const u = auth.currentUser; return u?.uid || '';
    }

    function detailsFor(ev){
      const t = pick(ev, ['type','eventType','event_name','name','Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø«'], '').trim();
      if(t === 'ØªÙ„Ù‚ÙŠØ­'){
        const at  = pick(ev, ['time','eventTime','ÙˆÙ‚Øª','Ø³Ø§Ø¹Ø©','at'], '').toString();
        const bull= pick(ev, ['bull','bullName','Ø·Ù„ÙˆÙ‚Ø©','Ø§Ø³Ù… Ø§Ù„Ø·Ù„ÙˆÙ‚Ø©'], '');
        const straw=pick(ev, ['straw','strawCode','Ø§Ù„Ù‚Ø´Ø©','ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø´Ø©'], '');
        const timePart = at ? `Ø§Ù„ÙˆÙ‚Øª: ${at}` : '';
        const bullPart = bull? `Ø§Ù„Ø·Ù„ÙˆÙ‚Ø©: ${bull}`: '';
        const stPart   = straw?`Ø§Ù„Ù‚Ø´Ø©: ${straw}`: '';
        return [timePart,bullPart,stPart].filter(Boolean).join(' â€” ');
      }
      if(t === 'Ù„Ø¨Ù† ÙŠÙˆÙ…ÙŠ'){
        const kg   = pick(ev, ['milkKg','kg','milk','Ù„Ø¨Ù†_ÙƒØ¬Ù…','ÙƒÙ…ÙŠØ© Ø§Ù„Ù„Ø¨Ù† ÙƒØ¬Ù…'], '');
        const shift= pick(ev, ['shift','milkingShift','Ø§Ù„ÙˆØ±Ø¯ÙŠØ©','ÙˆØ±Ø¯ÙŠØ©'], '');
        const p1 = kg!=='' ? `ÙƒØ¬Ù…: ${kg}` : '';
        const p2 = shift? `Ø§Ù„ÙˆØ±Ø¯ÙŠØ©: ${shift}`: '';
        return [p1,p2].filter(Boolean).join(' â€” ');
      }
      const note = pick(ev, ['note','Ù…Ù„Ø§Ø­Ø¸Ø©'], '');
      const result = pick(ev, ['result','Ø§Ù„Ù†ØªÙŠØ¬Ø©'], '');
      return [note, result].filter(Boolean).join(' â€” ');
    }

    function renderRows(events){
      evBody.innerHTML = '';
      if(!events.length){
        evBody.innerHTML = '<tr><td colspan="4" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©â€¦</td></tr>';
        return;
      }
      const frag = document.createDocumentFragment();
      for(const ev of events){
        const tr = document.createElement('tr');
        const cDate  = document.createElement('td'); cDate.textContent  = pick(ev, ['eventDate','date','dt'], '');
        const cNum   = document.createElement('td'); cNum.textContent   = pick(ev, ['animalNumber','number','animalId','id'], '');
        const cType  = document.createElement('td'); cType.innerHTML    = `<span class="pill">${pick(ev, ['type','eventType','event_name','name'], '')}</span>`;
        const cDet   = document.createElement('td'); cDet.textContent   = detailsFor(ev);
        tr.append(cDate,cNum,cType,cDet);
        frag.appendChild(tr);
      }
      evBody.appendChild(frag);
    }

    async function loadAndFilter(){
      const uid = currentUserId();
      if(!uid){ renderRows([]); return; }

      // Ø§Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« 200 Ø­Ø¯Ø« Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (userId)
      const q = query(
        collection(db,'events'),
        where('userId','==',uid),
        orderBy('eventDate','desc'),
        limit(200)
      );
      const snap = await getDocs(q);
      const rows = [];
      snap.forEach(doc => rows.push({ id:doc.id, ...doc.data() }));

      const num  = (document.getElementById('f-num').value || '').trim();
      const type = (document.getElementById('f-type').value || '').trim();

      const filtered = rows.filter(r => {
        const okNum  = !num  || (String(pick(r,['animalNumber','number','animalId'],'')).trim() === num);
        const tval   = String(pick(r,['type','eventType','event_name','name'],'')).trim();
        const okType = !type || (tval === type);
        return okNum && okType;
      });

      renderRows(filtered);
    }

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    btnApply.addEventListener('click', loadAndFilter);
    btnClear.addEventListener('click', () => { fNum.value=''; fType.value=''; loadAndFilter(); });

    // Ø¥Ù‚Ù„Ø§Ø¹ Ø§Ù„ØµÙØ­Ø©: ÙˆØ±Ø§Ø«Ø© Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† + Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù€Auth Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
    window.addEventListener('DOMContentLoaded', () => {
      const n = getParam('number','animalNumber','num','n') || localStorage.getItem('currentAnimalNumber') || '';
      if(n){ fNum.value = n; } else { fNum.placeholder = 'Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† (Ù…Ø«Ø§Ù„ 108)'; }

      if (auth.currentUser || localStorage.getItem('userId') || getParam('userId','uid')) {
        loadAndFilter();
      } else {
        onAuthStateChanged(auth, () => loadAndFilter());
      }
    });
  </script>
</body>
</html>
