<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>قائمة أحداث الحيوان — مُرَبِّك</title>
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <meta name="theme-color" content="#2e7d32" />

  <!-- نفس اعتماد animal-list -->
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <style>
    :root{ --green:#2e7d32; --green-600:#1b5e20; --bg:#f7faf7; --card:#fff; --border:#c5e1a5; --ink:#143b24; }
    *{box-sizing:border-box}
   body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Cairo',Arial;line-height:1.45;color:var(--ink);padding:0}
    .wrap{max-width:520px;margin:0 auto;padding:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0 12px}
    .controls input,.controls select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font:14px system-ui}
   .controls button{padding:12px 14px;border-radius:12px;border:1px solid var(--green-600);background:var(--green);color:#fff;font-weight:800;cursor:pointer}
   .controls .ghost{background:#fff;color:var(--green-600);border:1px solid var(--green-600)}
 .table{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  max-height: calc(100vh - 260px);
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:top}
    thead th{position:sticky;top:0;background:#f6fff2;color:#2e7d32;font-weight:800;z-index:1}
    tbody tr:last-child td{border-bottom:none}
    .muted{color:#556}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #bbf7d0;border-radius:999px;background:#ecfdf5;color:#065f46;font-size:12px}
    .center{display:flex;align-items:center;gap:8px;justify-content:center}
    .empty{padding:18px;text-align:center;color:#6b7280}
    /* ===== Bottom Fixed Bar ===== */
.mbk-bottom-bar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  backdrop-filter: blur(6px);
  background:rgba(247,250,247,0.65); /* لون مربيك بشفافية */
  border-top:1px solid rgba(46,125,50,0.15);
  padding:10px 14px;
  display:flex;
  gap:10px;
  justify-content:center;
  z-index:1000;
}

.mbk-bottom-btn{
  flex:1;
  text-align:center;
  padding:12px;
  border-radius:14px;
  font-weight:800;
  text-decoration:none;
  font-size:14px;
}

.mbk-bottom-btn.primary{
  background:rgba(46,125,50,0.85);
  color:#fff;
}

.mbk-bottom-btn.secondary{
  background:rgba(255,255,255,0.7);
  color:#2e7d32;
  border:2px solid rgba(46,125,50,0.6);
}

/* عشان المحتوى مايتغطاش */
body{
  padding-bottom:65px;
}
  

/* ✅ عمودان Sticky (في RTL من اليمين) */
.sticky-col{
  position: sticky;
  z-index: 5;
}

thead .sticky-col{
  background:#f6fff2;
  z-index: 6;
}

tbody .sticky-col{
  background:#fff;
}

/* فاصل بسيط بعد العمود الثابت الثاني */
thead .sticky-type,
tbody .sticky-type{
  box-shadow: -1px 0 0 rgba(0,0,0,0.08);
}

/* تفاصيل الحدث: سطرين مقروءين */
td:last-child{
  text-align:right;
  white-space:normal;
  line-height:1.4;
}
    /* ✅ Sticky header للصف العلوي كله */
thead th{
  position: sticky;
  top: 0;
  z-index: 10;
  background: #f6fff2;
}

/* ✅ متغيرات عرض العمودين (هتتملّي من JS) */
:root{
  --w-date: 0px;
  --w-type: 0px;
}

/* ✅ عمود التاريخ: sticky يمين */
.sticky-date{
  position: sticky;
  right: 0;
  z-index: 9;
  background: #fff;
  white-space: nowrap;
  width: 1%;
}

/* ✅ عمود النوع: sticky بعد التاريخ مباشرة */
.sticky-type{
  position: sticky;
  right: var(--w-date);
  z-index: 9;
  background: #fff;
  white-space: nowrap;
  width: 1%;
}

/* ✅ نفس الخلفية في الهيدر للعمودين */
thead .sticky-date,
thead .sticky-type{
  background: #f6fff2;
  z-index: 11;
}
/* ✅ سكرول طبيعي للجدول */
.table{ overflow:auto; }
  </style>
  <!-- حمِّل إعدادات Firebase كملف عادي (غير ESM) ليضع firebaseConfig على window -->
  </head>
<body>
    <header>
    <div class="mbk-head">
      <img class="mbk-logo" src="/images/logo.png" alt="مُرَبِّيك">
      <div class="mbk-center">
        <div class="mbk-page-title">قائمة أحداث الحيوان</div>
        <div class="mbk-app-name">مُرَبِّيك</div>
      </div>
      <a class="mbk-back" href="add-event.html">رجوع</a>
    </div>
  </header>
  <div class="wrap">
   

    <div class="controls">
      <input id="f-num" type="text" inputmode="numeric" placeholder="رقم الحيوان (مثال 108)" aria-label="رقم الحيوان">
      <select id="f-type" aria-label="نوع الحدث">
        <option value="">كل الأنواع</option>
        <option>تلقيح</option>
        <option>لبن يومي</option>
        <option>ولادة</option>
        <option>تشخيص حمل</option>
        <option>تحصين</option>
        <option>تقليم الحوافر</option>
        <option>عرج</option>
        <option>التهاب الضرع</option>
        <option>شياع</option>
<option>تزامن</option>
<option>تجفيف</option>
<option>إجهاض</option>
<option>ولادة (عجل)</option>
<option>نفوق</option>
<option>استبعاد</option>
<option>فحص حالة الجسم</option>
<option>تقييم الروث</option>
<option>تغذية</option>
<option>مرض</option>
      </select>
     
     
    </div>

    <div class="table">
      <table id="evTable" dir="rtl">
        <thead>
          <tr>
         <th class="sticky-col sticky-date">تاريخ الحدث</th>
<th class="sticky-col sticky-type">نوع الحدث</th>
<th>تفاصيل الحدث</th>
          </tr>
        </thead>
        <tbody id="evBody">
         <tr><td colspan="3" class="empty">لا توجد بيانات بعد…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase (ESM) -->
  <script type="module">
    // ✅ استخدم ملفك الرسمي مباشرة: /js/firebase-config.js يهيّئ التطبيق ويصدر db, auth
    import { db, auth } from '/js/firebase-config.js';
    import { collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // ثوابت DOM
    const fNum  = document.getElementById('f-num');
    const fType = document.getElementById('f-type');
    const evBody = document.getElementById('evBody');
    if(!evBody){
  console.error('[event-list] evBody not found (#evBody). Check tbody id.');
}

    // أدوات مساعدة
    const pick = (obj, keys, def='') => { for (const k of keys) { if (obj && obj[k] != null && obj[k] !== '') return obj[k]; } return def; };
    const getParam = (...keys) => { const u=new URL(location.href); for (const k of keys){ const v=u.searchParams.get(k); if(v!=null && v!=='') return v; } return ''; };

    function currentUserId(){
      const viaUrl = getParam('userId','uid');
      const ls = viaUrl || localStorage.getItem('userId') || localStorage.getItem('uid') || '';
      if(ls) return ls;
      const u = auth.currentUser; return u?.uid || '';
    }

 function normalizeTypeKey(ev){
  // نفضل eventTypeNorm ثم eventType ثم type
  const raw =
    String(pick(ev, ['eventTypeNorm','eventType','type','event_name','name','نوع الحدث'], '')).trim();

  // key موحد: lowercase + تحويل مسافات/شرطات لنفس الشكل
  const k = raw
    .toLowerCase()
    .replace(/\s+/g,'_')
    .replace(/-/g,'_');

  // خريطة التطبيع (ضيفنا daily_milk + feces_eval حسب بياناتك)
  const map = {
    // milk
    'لبن_يومي': 'daily_milk',
    'daily_milk': 'daily_milk',
    'daily-milk': 'daily_milk',
    'dailymilk': 'daily_milk',

    // insemination
    'تلقيح': 'insemination',
    'insemination': 'insemination',

    // vaccination
    'تحصين': 'vaccination',
    'vaccination': 'vaccination',

    // pregnancy diagnosis
    'تشخيص_حمل': 'pregnancy_diagnosis',
    'pregnancy_diagnosis': 'pregnancy_diagnosis',

    // calving
    'ولادة': 'calving',
    'calving': 'calving',

    // heat
    'شياع': 'heat',
    'heat': 'heat',

    // dry-off
    'تجفيف': 'dry_off',
    'dryoff': 'dry_off',
    'dry_off': 'dry_off',

    // abortion
    'إجهاض': 'abortion',
    'abortion': 'abortion',

    // feces / bcs
    'feces_eval': 'feces_eval',
    'تقييم_الروث_بالكاميرا': 'feces_eval',
    'تقييم_الروث': 'feces_eval',

    'bcs_eval': 'bcs_eval',
    'تقييم_حالة_الجسم': 'bcs_eval',
    'فحص_حالة_الجسم': 'bcs_eval',
    'بيع': 'sale',
'sale': 'sale',
  };

  return map[k] || k; // لو مش موجود، نرجّع key بعد التطبيع
}

function typeLabel(ev){
  // نطلع لابل عربي ثابت للعرض
  const key = normalizeTypeKey(ev);
  const labels = {
    daily_milk: 'لبن يومي',
    insemination: 'تلقيح',
    vaccination: 'تحصين',
    pregnancy_diagnosis: 'تشخيص حمل',
    calving: 'ولادة',
    heat: 'شياع',
    dry_off: 'تجفيف',
    abortion: 'إجهاض',
    feces_eval: 'تقييم الروث',
    bcs_eval: 'فحص حالة الجسم',
    sale: 'بيع',
  };
  // لو عندك eventType عربي أصلاً خده، وإلا استخدم اللابل
 return labels[key] || 'حدث';
}

function detailsFor(ev){
  const key = normalizeTypeKey(ev);

  // ================== تلقيح ==================
  if(key === 'insemination'){
    const at = pick(ev, ['inseminationTime','time','eventTime','at','وقت','ساعة'], '');
    const method = pick(ev, ['inseminationMethod','method','طريقة'], '');
    const semen = pick(ev, ['semenCode','strawCode','straw','القشة','كود القشة'], '');
    const who = pick(ev, ['inseminator','by','الملقح'], '');
    const heat = pick(ev, ['heatStatus','heatTime','الشياع'], '');

    return [
      at ? `الوقت: ${at}` : '',
      method ? `الطريقة: ${method}` : '',
      semen ? `السائل/القشة: ${semen}` : '',
      who ? `الملقّح: ${who}` : '',
      heat ? `الشياع: ${heat}` : ''
    ].filter(Boolean).join(' — ');
  }

  // ================== لبن يومي ==================
  if(key === 'daily_milk'){
    const total = pick(ev, ['milkKg','dailyMilk','kg','milk','milkTotalKg'], '');
    const sessions = Array.isArray(ev.milkSessions) ? ev.milkSessions : [];
    const sText = sessions.length
      ? `الحلبات: ${sessions.map(s=>s?.kg ?? s?.milkKg ?? s?.value).filter(v=>v!=null).join('+')}`
      : '';
    return [
      total!=='' ? `إجمالي: ${total} كجم` : '',
      sessions.length ? `عدد الحلبات: ${sessions.length}` : '',
      sText
    ].filter(Boolean).join(' — ');
  }

  // ================== تحصين ==================
  if(key === 'vaccination'){
    const v = pick(ev, ['vaccine','vaccineName','vaccineKey'], '');
    const dose = pick(ev, ['doseType','dose','جرعة'], '');
    return [
      v ? `اللقاح: ${v}` : '',
      dose ? `الجرعة: ${dose}` : ''
    ].filter(Boolean).join(' — ');
  }

  // ================== تشخيص حمل ==================
  if(key === 'pregnancy_diagnosis'){
    const method = pick(ev, ['method','طريقة'], '');
    const result = pick(ev, ['result','النتيجة'], '');
    const vet = pick(ev, ['vet','doctor','الطبيب'], '');
    return [
      method ? `الطريقة: ${method}` : '',
      result ? `النتيجة: ${result}` : '',
      vet ? `الطبيب: ${vet}` : ''
    ].filter(Boolean).join(' — ');
  }

  // ================== ولادة ==================
  if(key === 'calving'){
    const kind = pick(ev, ['calvingKind'], '');
    const cnt = pick(ev, ['calfCount'], '');
    const calfId = pick(ev, ['calfId'], '');
    return [
      kind ? `الولادة: ${kind}` : '',
      cnt ? `عدد العجول: ${cnt}` : '',
      calfId ? `رقم العجل: ${calfId}` : ''
    ].filter(Boolean).join(' — ');
  }

  // ================== إجهاض ==================
  if(key === 'abortion'){
    const cause = pick(ev, ['probableCause','cause','reason','سبب','السبب'], '');
    const age = pick(ev, ['abortionAgeMonths','ageMonths'], '');
    const lastAI = pick(ev, ['lastInseminationDate'], '');
    return [
      cause ? `السبب المحتمل: ${cause}` : '',
      age!=='' ? `عمر الحمل: ${age} شهر` : '',
      lastAI ? `آخر تلقيح: ${lastAI}` : ''
    ].filter(Boolean).join(' — ');
  }

  // ================== تجفيف ==================
  if(key === 'dry_off'){
    const reason = pick(ev, ['reason','سبب','السبب'], '');
    const ab = pick(ev, ['usedDryingAntibiotics','dryingAntibiotics'], '');
    const preg = pick(ev, ['pregnancyStatus','reproStatus'], '');
    const dt = pick(ev, ['dryOffDate','eventDate'], '');
    return [
      dt ? `تاريخ: ${dt}` : '',
      preg ? `الحالة: ${preg}` : '',
      reason ? `السبب: ${reason}` : '',
      ab ? `مضاد تجفيف: ${ab}` : ''
    ].filter(Boolean).join(' — ');
  }

  // ================== تقييم الروث ==================
  if(key === 'feces_eval'){
    const score = pick(ev, ['fecesScore','value'], '');
    const desc  = pick(ev, ['description','note','notes','ملاحظة'], '');
    return [
      score!=='' ? `الدرجة: ${score}` : '',
      desc ? `الوصف: ${desc}` : ''
    ].filter(Boolean).join(' — ');
  }

  // ================== مرض / Health ==================
  if(key === 'health'){
    const name = pick(ev, ['diseaseName','disease','name'], '');
    const code = pick(ev, ['diseaseCode'], '');
    return [
      name ? `المرض: ${name}` : '',
      code ? `الكود: ${code}` : ''
    ].filter(Boolean).join(' — ');
  }

  // ================== تزامن / Ovsynch ==================
  if(key === 'ovsynch' || key === 'ovysynch'){
    const prog = pick(ev, ['program','type'], '');
    const start = pick(ev, ['startDate','eventDate'], '');
    const steps = Array.isArray(ev.steps) ? ev.steps : [];
    const next = steps.find(s => !s?.done);
    const nextTxt = next ? `التالي: ${next.name} (${next.date || ''})` : '';
    return [
      prog ? `البرنامج: ${prog}` : '',
      start ? `البداية: ${start}` : '',
      nextTxt
    ].filter(Boolean).join(' — ');
  }

  // ================== استبعاد ==================
  if(key === 'cull'){
    const r = pick(ev, ['reason','cullMain','cullDetail'], '');
    return r ? `السبب: ${r}` : 'استبعاد';
  }

  // ================== بيع ==================
 if(key === 'sale'){
  const price = pick(ev, ['price'], '');
  const why = pick(ev, ['saleReason','reason','notes','note'], '');
  return [
    price!=='' ? `السعر: ${price}` : '',
    why ? `السبب: ${why}` : ''
  ].filter(Boolean).join(' — ') || '—';
}

  // ================== تحضير للولادة (Close-up) ==================
  if(key === 'closeup'){
    const ration = pick(ev, ['ration'], '');
    const an = pick(ev, ['anionicSalts'], '');
    return [
      ration ? `عليقة: ${ration}` : '',
      an ? `أملاح أنيونية: ${an}` : ''
    ].filter(Boolean).join(' — ');
  }

  // ================== تقييم صفات اللبن (Milking traits) ==================
  if(key === 'milking_traits_eval' || key === 'milking_traits'){
    const score = pick(ev, ['kpi.overallScore','overallScore'], '');
    return score!=='' ? `الدرجة الكلية: ${score}` : 'تقييم صفات اللبن';
  }

  // fallback عام
  const note = pick(ev, ['note','notes','ملاحظة','description'], '');
  const result = pick(ev, ['result','النتيجة'], '');
  return [note, result].filter(Boolean).join(' — ') || '—';
}  
  function updateStickyWidths(){
  const thDate = document.querySelector('thead th.sticky-date');
  const thType = document.querySelector('thead th.sticky-type');
  if(!thDate || !thType) return;

  const wDate = Math.ceil(thDate.getBoundingClientRect().width);
  const wType = Math.ceil(thType.getBoundingClientRect().width);

  document.documentElement.style.setProperty('--w-date', wDate + 'px');
  document.documentElement.style.setProperty('--w-type', wType + 'px');
}  
    function renderRows(events){
  if(!evBody){
  console.error('[event-list] evBody is missing (#evBody).');
  return;
}
      evBody.innerHTML = '';
      if(!events.length){
       evBody.innerHTML = '<tr><td colspan="3" class="empty">لا توجد نتائج مطابقة…</td></tr>';
        return;
      }
      const frag = document.createDocumentFragment();
      for(const ev of events){
       const tr = document.createElement('tr');

const cDate  = document.createElement('td');
cDate.textContent = pick(ev, ['eventDate','date','dt'], '');
cDate.className = 'sticky-col sticky-date';

const cType  = document.createElement('td');
cType.innerHTML = `<span class="pill">${typeLabel(ev)}</span>`;
cType.className = 'sticky-col sticky-type';

const cDet   = document.createElement('td');
cDet.textContent = detailsFor(ev);

tr.append(cDate, cType, cDet);
frag.appendChild(tr);
      }
      evBody.appendChild(frag);
      updateStickyWidths();
    }

    async function loadAndFilter(){
      const uid = currentUserId();
      const fixedNumber =
  getParam('number','animalNumber','num','n') ||
  localStorage.getItem('currentAnimalNumber') ||
  '';

if(!fixedNumber){
  renderRows([]);
  return;
}
      if(!uid){ renderRows([]); return; }
      const q = query(
        collection(db,'events'),
        where('userId','==',uid),
        orderBy('eventDate','desc'),
        limit(200)
      );
      const snap = await getDocs(q);
      const rows = [];
      snap.forEach(doc => rows.push({ id:doc.id, ...doc.data() }));

     const num = fixedNumber;
      const type = (fType.value || '').trim();

      const filtered = rows.filter(r => {
        const okNum  = !num  || (String(pick(r,['animalNumber','number','animalId'],'')).trim() === num);
        const tvalLabel = typeLabel(r);
const okType = !type || (tvalLabel === type);
        return okNum && okType;
      });

      renderRows(filtered);
    }
    // ✅ فلترة تلقائية بمجرد اختيار النوع من القائمة
fType.addEventListener('change', loadAndFilter);
    // تحديث تلقائي عند مسح رقم الحيوان
fNum.addEventListener('input', () => {
  if (!fNum.value.trim()) loadAndFilter();
});
    // إقلاع الصفحة
    window.addEventListener('DOMContentLoaded', () => {
      const fixedNumber =
  getParam('number','animalNumber','num','n') ||
  localStorage.getItem('currentAnimalNumber') ||
  '';

const cowBtn = document.getElementById('btn-cow-card');

if(cowBtn && fixedNumber){
  cowBtn.href = `cow-card.html?number=${fixedNumber}`;
}
      const n = getParam('number','animalNumber','num','n') || localStorage.getItem('currentAnimalNumber') || '';
      if(n){ fNum.value = n; } else { fNum.placeholder = 'رقم الحيوان (مثال 108)'; }

      if (auth.currentUser || localStorage.getItem('userId') || getParam('userId','uid')) {
        loadAndFilter();
      } else {
        // انتظر استعادة الجلسة بهدوء
        const off = auth.onAuthStateChanged ? auth.onAuthStateChanged(() => { off(); loadAndFilter(); }) : null;
        // fallback بسيط بعد ثانيتين
        setTimeout(loadAndFilter, 2000);
      }
      window.addEventListener('resize', updateStickyWidths);
setTimeout(updateStickyWidths, 0);
    });
  </script>
  <!-- ===== Bottom Fixed Bar ===== -->
<div class="mbk-bottom-bar">
  <a id="btn-cow-card" class="mbk-bottom-btn secondary">
    بطاقة الحيوان
  </a>

  <a href="dashboard.html" class="mbk-bottom-btn primary">
    لوحة التحكم
  </a>
</div>
</body>
</html>
