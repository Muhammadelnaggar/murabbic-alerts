<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>قائمة أحداث الحيوان — مُرَبِّك</title>

  <style>
    :root{
      --brand:#0ea05a;--brand-600:#0b7f47;
      --bg:#f7faf7;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--border:#e2e8f0;--thead:#f8fafc;
      --pill-bg:#ecfdf5;--pill-br:#bbf7d0;--pill-ink:#065f46;
      --warn-bg:#fff7ed;--warn-br:#fed7aa;--warn-ink:#7c2d12;
      --w1:120px; /* التاريخ — يُضبط برمجياً على حسب المحتوى */
      --w2:160px; /* اسم الحدث — يُضبط برمجياً على حسب المحتوى */
    }
    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{margin:0;font-family:'Cairo',system-ui,Segoe UI,Roboto,Tahoma,Arial;background:var(--bg);color:var(--ink)}
    a{color:inherit}

    .wrap{padding:12px}
    .head{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .title{font-weight:900;color:var(--brand-600);font-size:16px}
    .meta{font-size:12px;color:var(--muted)}
    .actions{margin-inline-start:auto;display:flex;gap:8px}
    .btn{display:inline-block;background:var(--brand);color:#fff;padding:10px 12px;border-radius:12px;font-weight:800;text-decoration:none;border:1px solid transparent}
    .btn.ghost{background:var(--card);color:var(--brand-600);border-color:var(--border)}

    .filters{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
    .filters label{font-size:12px;color:var(--muted)}
    .filters input,.filters select{
      padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--card);font-family:inherit
    }
    .filters .num{display:flex;align-items:center;gap:6px}
    .filters input[readonly]{background:#f9fafb;color:#475569}

    .table-wrap{border:1px solid var(--border);border-radius:12px;background:var(--card);overflow:hidden}
    .scroll{max-height:72vh;overflow:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}

    table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px;table-layout:auto}
    thead th{position:sticky;top:0;background:var(--thead);border-bottom:1px solid var(--border);padding:10px;text-align:right;z-index:5;white-space:nowrap}
    tbody td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top;background:#fff}
    tbody tr:hover td{background:#f9fff8}

    /* عمودان ثابتان (يمين لكون RTL) */
    .sticky-1,.sticky-2{position:sticky;z-index:6;background:#fff}
    .sticky-1{inset-inline-end:0;min-width:var(--w1);max-width:calc(var(--w1) + 2px);white-space:nowrap}
    .sticky-2{inset-inline-end:var(--w1);min-width:var(--w2);max-width:calc(var(--w2) + 2px);white-space:nowrap}
    thead .sticky-1, thead .sticky-2{background:var(--thead);z-index:7}

    /* باقي الأعمدة تمرير أفقي مريح على الموبايل */
    .flex-col{min-width:520px}
    @media (max-width:480px){
      .title{font-size:15px}
      table{font-size:13px}
      .flex-col{min-width:360px}
      .btn{padding:9px 12px}
      .filters input,.filters select{padding:8px}
    }

    .pill{display:inline-block;background:var(--pill-bg);border:1px solid var(--pill-br);color:var(--pill-ink);
      border-radius:999px;padding:2px 8px;font-size:12px;font-weight:800;white-space:nowrap}
    .empty{padding:14px;text-align:center;color:var(--muted)}
    .err{background:var(--warn-bg);border:1px solid var(--warn-br);color:var(--warn-ink);padding:10px;border-radius:10px;margin-bottom:8px;font-weight:700;display:none}
    .err.show{display:block}

    /* هيكل تحميل بسيط */
    .skeleton td{background:linear-gradient(100deg,#f2f6f4 40%,#eaf3ee 50%,#f2f6f4 60%);background-size:200% 100%;animation:s 1.2s infinite linear}
    @keyframes s{to{background-position:-200% 0}}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="err" class="err"></div>

    <header class="head" aria-label="رأس الصفحة">
      <div class="title">أحداث هذا الموسم</div>
      <div id="meta" class="meta">—</div>
      <nav class="actions" aria-label="تنقّل">
        <a id="openCard" class="btn" href="#">بطاقة الحيوان</a>
        <a class="btn ghost" href="dashboard.html">رجوع للوحة التحكم</a>
      </nav>
    </header>

    <section class="filters" aria-label="مرشّحات">
      <div class="num">
        <label for="animalNumField">رقم الحيوان:</label>
        <input id="animalNumField" inputmode="numeric" placeholder="—" readonly />
      </div>
      <label for="catFilter">فلترة:</label>
      <select id="catFilter">
        <option value="">الكل</option>
        <option value="انتاج">انتاج</option>
        <option value="تناسليات">تناسليات</option>
        <option value="صحة">صحة</option>
        <option value="تقييم بالكاميرا">تقييم بالكاميرا</option>
        <option value="تغذية">تغذية</option>
      </select>
    </section>

    <section class="table-wrap" aria-label="جدول الأحداث">
      <div class="scroll">
        <table dir="rtl" id="eventsTable">
          <thead>
            <tr>
              <th class="sticky-1">التاريخ</th>
              <th class="sticky-2">الحدث</th>
              <th class="flex-col">تفاصيل / ملاحظات</th>
            </tr>
          </thead>
          <tbody id="rows" class="skeleton">
            <tr><td colspan="3" class="empty">جارٍ التحميل…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script type="module">
    /* ===== الاعتماد على إعدادات المشروع الحالية =====
       يجب أن يصدّر /js/firebase-config.js الكائنين db, auth
       مع getFirestore(app, 'murabbikdata') كما هو متفق عليه.
    */
    import { db, auth } from '/js/firebase-config.js';
    import {
      collection, getDocs, query, where, orderBy, limit
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // ---------- عناصر ----------
    const $ = (sel,root=document)=>root.querySelector(sel);
    const rows   = $('#rows');
    const metaEl = $('#meta');
    const table  = $('#eventsTable');
    const fldNum = $('#animalNumField');
    const selCat = $('#catFilter');
    const errBox = $('#err');
    const openCard = $('#openCard');

    // ---------- هوية المستأجر/المستخدم ----------
    let UID = null, TID = null;
    const qp = new URLSearchParams(location.search);
    const getQNum = () => qp.get('number') || qp.get('animalNumber') || qp.get('animalId') || '';
    const getQCat = () => qp.get('cat') || '';

    // ---------- مساعدات ----------
    const showErr = (msg) => { errBox.textContent = msg; errBox.classList.add('show'); };
    const hideErr = () => { errBox.classList.remove('show'); errBox.textContent=''; };

    // أسماء عربية للأحداث (لو eventType إنجليزي)
    const arabicType = (ev) => {
      if (ev.type) return ev.type; // الاسم محفوظ بالعربية من صفحات الحدث
      const map = {
        calving:'ولادة', dry_off:'تجفيف', insemination:'تلقيح',
        pregnancy_diagnosis:'تشخيص حمل', daily_milk:'لبن يومي',
        mastitis:'التهاب ضرع', lameness:'عرج', vaccination:'تطعيم',
        close_up:'كلوز أب', nutrition:'تغذية',
        milking_traits_eval:'سمات اللبن (كاميرا)', bcs_eval:'تقييم حالة الجسم', feces_eval:'تقييم الروث'
      };
      return map[ev.eventType] || 'حدث';
    };

    // تصنيف
    const CATEGORY_MAP = {
      'انتاج' : ['daily_milk','dry_off'],
      'تناسليات': ['insemination','calving','pregnancy_diagnosis','close_up'],
      'صحة'  : ['mastitis','lameness','vaccination','treatment','health'],
      'تقييم بالكاميرا': ['camera_eval','vision_eval','camera_assessment','milking_traits_eval','bcs_eval','feces_eval'],
      'تغذية' : ['nutrition','feeding']
    };
    const categoryOf = (ev)=>{
      const explicit = ev.category || ev.eventCategory || ev.cat;
      if (explicit) return explicit;
      const t = (ev.eventType||'').toString();
      for (const [cat, types] of Object.entries(CATEGORY_MAP)){
        if (types.includes(t)) return cat;
      }
      return 'أخرى';
    };
    const filterByCat = (arr, cat)=> !cat ? arr : arr.filter(e=>categoryOf(e)===cat);

    const fmtDate = (ev) => {
      if (ev.eventDate) return ev.eventDate; // YYYY-MM-DD
      const ts = ev.createdAt?.toDate?.();
      return ts ? ts.toISOString().slice(0,10) : '';
    };

    // شروط المالك + حقل الحيوان
    function scopeWheres(animalField, num){
      const wh = [];
      if (TID) wh.push(where('tenantId','==', TID));
      if (UID) wh.push(where('userId','==',   UID));
      wh.push(where(animalField,'==', num));
      return wh;
    }

    // انتظار حالة الدخول (عرض فقط)
    function waitAuth(){
      return new Promise(res=>{
        const off = onAuthStateChanged(auth,(u)=>{ off(); res(u||null); });
      });
    }

    // ولادات الحيوان (لاستخراج حدود الموسم)
    async function getCalvings(num, dir='desc', lim=8){
      const evs = collection(db,'events');
      const q1 = query(evs, ...scopeWheres('animalNumber',num), where('eventType','==','calving'), orderBy('eventDate',dir), limit(lim));
      const q2 = query(evs, ...scopeWheres('animalId',num),     where('eventType','==','calving'), orderBy('eventDate',dir), limit(lim));
      const [s1,s2] = await Promise.all([getDocs(q1), getDocs(q2)]);
      const arr = [...s1.docs, ...s2.docs].map(d=>({id:d.id, ...d.data()}));
      const seen = new Set(); // إزالة التكرار
      return arr.filter(e=> (seen.has(e.id)?false:(seen.add(e.id),true)));
    }

    // بروفايل الحيوان (قد يحتوي lastCalvingDate)
    async function getAnimalProfile(num){
      try{
        const animals = collection(db,'animals');
        const owner = [
          ...(UID ? [where('userId','==',UID)] : []),
          ...(TID ? [where('tenantId','==',TID)] : [])
        ];
        const qs = [
          query(animals, ...owner, where('number','==',num), limit(1)),
          query(animals, ...owner, where('animalNumber','==',num), limit(1)),
          query(animals, ...owner, where('animalId','==',num), limit(1)),
        ];
        const res = await Promise.all(qs.map(getDocs));
        const hit = res.find(s=>!s.empty);
        return hit ? hit.docs[0].data() : null;
      }catch{ return null; }
    }

    // حدود الموسم (من آخر ولادة وحتى التالية)
    async function getSeasonBounds(num, todayISO, profile){
      let start = profile?.lastCalvingDate || profile?.lastCalving || profile?.lastCalvingISO || null;
      if (!start){
        const calvDesc = await getCalvings(num,'desc',8);
        const last = calvDesc.find(c=>c.eventDate && c.eventDate<=todayISO);
        start = last?.eventDate || null;
      }
      let end = null;
      if (start){
        const calvAsc = await getCalvings(num,'asc',8);
        end = calvAsc.find(c=>c.eventDate && c.eventDate>start)?.eventDate || null;
      }
      return {start, end};
    }

    // جلب أحداث المدى
    async function getEventsForRange(num, startISO, endISO){
      const evs = collection(db,'events');
      const mk = (animalField)=>{
        const base = scopeWheres(animalField,num);
        if (startISO && endISO){
          return query(evs, ...base, where('eventDate','>=',startISO), where('eventDate','<',endISO), orderBy('eventDate','desc'));
        }else if (startISO){
          return query(evs, ...base, where('eventDate','>=',startISO), orderBy('eventDate','desc'));
        }else{
          return query(evs, ...base, orderBy('eventDate','desc'));
        }
      };
      const [s1,s2] = await Promise.all([getDocs(mk('animalNumber')), getDocs(mk('animalId'))]);
      const all = [...s1.docs, ...s2.docs].map(d=>({id:d.id, ...d.data()}));
      const seen = new Set();
      const merged = all.filter(e=> (seen.has(e.id)?false:(seen.add(e.id),true)));
      merged.sort((a,b)=> (b.eventDate||'').localeCompare(a.eventDate||''));
      return merged;
    }

    // قياس عرض أول عمودين وفق المحتوى
    function sizeStickyColumns(){
      const th1 = $('thead th.sticky-1', table);
      const th2 = $('thead th.sticky-2', table);
      if (!th1 || !th2) return;

      const col1 = table.querySelectorAll('tbody td.col-1, thead th.sticky-1');
      const col2 = table.querySelectorAll('tbody td.col-2, thead th.sticky-2');

      const pad = 16; // هامش أمان
      const w1 = Math.ceil([...col1].reduce((mx,c)=>Math.max(mx, c.scrollWidth), th1.scrollWidth)) + pad;
      const w2 = Math.ceil([...col2].reduce((mx,c)=>Math.max(mx, c.scrollWidth), th2.scrollWidth)) + pad;

      table.style.setProperty('--w1', w1 + 'px');
      table.style.setProperty('--w2', w2 + 'px');
    }

    // رسم الصفوف
    function renderRows(events, bounds){
      rows.classList.remove('skeleton');
      rows.innerHTML = '';

      if (!events.length){
        rows.innerHTML = '<tr><td colspan="3" class="empty">لا توجد أحداث ضمن هذا الموسم.</td></tr>';
      }else{
        const frag = document.createDocumentFragment();
        for(const ev of events){
          const tr  = document.createElement('tr');

          const td1 = document.createElement('td');
          td1.className = 'sticky-1 col-1';
          td1.textContent = fmtDate(ev);

          const td2 = document.createElement('td');
          td2.className = 'sticky-2 col-2';
          td2.innerHTML = `<span class="pill" title="${ev.eventType||''}">${arabicType(ev)}</span>`;

          const td3 = document.createElement('td');
          td3.className = 'flex-col';
          const parts = [];
          if (ev.notes) parts.push(ev.notes);
          if (ev.aiHints) parts.push(ev.aiHints);

          // قيم مفيدة شائعة للعرض المختصر
          const kv = [];
          if (ev.milkKg != null) kv.push(`لبن: ${ev.milkKg} كجم`);
          if (ev.dim    != null) kv.push(`DIM: ${ev.dim}`);
          if (ev.temp   != null) kv.push(`حرارة: ${ev.temp}°`);
          if (ev.score  != null) kv.push(`درجة: ${ev.score}`);
          if (kv.length) parts.push('— ' + kv.join(' • '));

          td3.textContent = parts.join('  ');

          tr.append(td1, td2, td3);
          frag.appendChild(tr);
        }
        rows.appendChild(frag);
      }

      if (!bounds.start){
        metaEl.textContent = 'كل الأحداث (لا توجد ولادة مسجَّلة كبداية موسم)';
      }else if (bounds.end){
        metaEl.textContent = `من الولادة ${bounds.start} حتى قبل الولادة ${bounds.end}`;
      }else{
        metaEl.textContent = `من الولادة ${bounds.start} حتى اليوم`;
      }

      requestAnimationFrame(sizeStickyColumns);
    }

    // تدفق التشغيل
    (async function main(){
      hideErr();

      const user = auth.currentUser || await waitAuth();
      if (!user){
        rows.classList.remove('skeleton');
        rows.innerHTML = '<tr><td colspan="3" class="empty">يلزم تسجيل الدخول لعرض الأحداث.</td></tr>';
        metaEl.textContent = '—';
        return;
      }
      UID = user.uid;
      TID = localStorage.getItem('tenantId') || null;

      const num = getQNum();
      fldNum.value = num || '';
      if (!num){
        rows.classList.remove('skeleton');
        rows.innerHTML = '<tr><td colspan="3" class="empty">لم يتم تمرير رقم الحيوان.</td></tr>';
        return;
      }

      if (openCard) openCard.href = `cow-card.html?number=${encodeURIComponent(num)}`;
      selCat.value = getQCat();

      const today = new Date().toISOString().slice(0,10);
      const profile = await getAnimalProfile(num);
      const bounds  = await getSeasonBounds(num, today, profile);

      const allEvents = await getEventsForRange(num, bounds.start || null, bounds.end || null);
      renderRows(filterByCat(allEvents, selCat.value || ''), bounds);

      selCat.addEventListener('change', ()=>{
        const cat = selCat.value || '';
        const url = new URL(location.href);
        if (cat) url.searchParams.set('cat',cat); else url.searchParams.delete('cat');
        history.replaceState({},'',url.toString());
        renderRows(filterByCat(allEvents, cat), bounds);
      });

      // ثبات العرض على الموبايل
      addEventListener('resize', ()=> requestAnimationFrame(sizeStickyColumns), {passive:true});
      addEventListener('orientationchange', ()=> setTimeout(sizeStickyColumns, 200), {passive:true});
    })().catch(err=>{
      console.error(err);
      showErr('تعذّر تحميل الأحداث. تأكّد من الصلاحيات وقواعد Firestore (murabbikdata).');
      rows.classList.remove('skeleton');
    });
  </script>
</body>
</html>
