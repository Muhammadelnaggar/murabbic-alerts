<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>قائمة أحداث الحيوان — مُرَبِّك</title>
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <meta name="theme-color" content="#2e7d32" />

  <!-- نفس اعتماد animal-list -->
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <style>
    :root{ --green:#2e7d32; --green-600:#1b5e20; --bg:#fff9db; --card:#fff; --border:#c5e1a5; --ink:#143b24; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Cairo',Arial;line-height:1.45;color:var(--ink);padding:12px}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0 0 10px;font-size:20px;color:var(--green-600);text-align:center}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0 12px}
    .controls input,.controls select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font:14px system-ui}
    .controls button{padding:10px 14px;border-radius:10px;border:1px solid var(--green-600);background:var(--green);color:#fff;font-weight:700;cursor:pointer}
    .controls .ghost{background:#fff;color:var(--green-600)}
    .table{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:top}
    thead th{position:sticky;top:0;background:#f6fff2;color:#2e7d32;font-weight:800;z-index:1}
    tbody tr:last-child td{border-bottom:none}
    .muted{color:#556}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #bbf7d0;border-radius:999px;background:#ecfdf5;color:#065f46;font-size:12px}
    .center{display:flex;align-items:center;gap:8px;justify-content:center}
    .empty{padding:18px;text-align:center;color:#6b7280}
  </style>
  <!-- حمِّل إعدادات Firebase كملف عادي (غير ESM) ليضع firebaseConfig على window -->
  <script src="/js/firebase-config.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>قائمة أحداث الحيوان</h1>

    <div class="controls">
      <input id="f-num" type="text" inputmode="numeric" placeholder="رقم الحيوان (مثال 108)" aria-label="رقم الحيوان">
      <select id="f-type" aria-label="نوع الحدث">
        <option value="">كل الأنواع</option>
        <option>تلقيح</option>
        <option>لبن يومي</option>
        <option>ولادة</option>
        <option>تشخيص حمل</option>
        <option>تحصين</option>
        <option>تقليم الحوافر</option>
        <option>عرج</option>
        <option>التهاب الضرع</option>
      </select>
      <button id="btn-apply">تطبيق الفلترة</button>
      <button id="btn-clear" class="ghost">تصفير</button>
    </div>

    <div class="table">
      <table id="evTable" dir="rtl">
        <thead>
          <tr>
            <th style="width:120px">تاريخ الحدث</th>
            <th style="width:90px">رقم الحيوان</th>
            <th style="width:130px">نوع الحدث</th>
            <th>تفاصيل</th>
          </tr>
        </thead>
        <tbody id="evBody">
          <tr><td colspan="4" class="empty">لا توجد بيانات بعد…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // 🔧 حمِّل إعدادات فايربيز مهما كان أسلوب التصدير (default أو firebaseConfig)
    // 🔧 تحميل إعدادات فايربيز من المتغيرات العامة (تجنّب مشاكل ESM/default)
    const firebaseConfig = window.firebaseConfig || window.FIREBASE_CONFIG;
    if(!firebaseConfig){
      console.error('firebase-config.js لا يعرّف window.firebaseConfig');
      const evBody = document.getElementById('evBody');
      if (evBody) evBody.innerHTML = '<tr><td colspan="4" class="empty">تعذّر تحميل إعدادات Firebase — تأكد من أن /js/firebase-config.js يُسند الكائن إلى <code>window.firebaseConfig</code></td></tr>';
      throw new Error('Missing firebaseConfig on window');
    }

    // ثوابت DOM
    const fNum  = document.getElementById('f-num');
    const fType = document.getElementById('f-type');
    const btnApply = document.getElementById('btn-apply');
    const btnClear = document.getElementById('btn-clear');
    const evBody = document.getElementById('evBody');

    // تهيئة فيربيز + Firestore باسم قاعدة البيانات الصحيحة
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app, 'murabbikdata');

    // أدوات مساعدة
    const pick = (obj, keys, def='') => { for (const k of keys) { if (obj && obj[k] != null && obj[k] !== '') return obj[k]; } return def; };
    const getParam = (...keys) => { const u=new URL(location.href); for (const k of keys){ const v=u.searchParams.get(k); if(v!=null && v!=='') return v; } return ''; };

    function currentUserId(){
      const viaUrl = getParam('userId','uid');
      const ls = viaUrl || localStorage.getItem('userId') || localStorage.getItem('uid') || '';
      if(ls) return ls;
      const u = auth.currentUser; return u?.uid || '';
    }

    function detailsFor(ev){
      const t = pick(ev, ['type','eventType','event_name','name','نوع الحدث'], '').trim();
      if(t === 'تلقيح'){
        const at  = pick(ev, ['time','eventTime','وقت','ساعة','at'], '').toString();
        const bull= pick(ev, ['bull','bullName','طلوقة','اسم الطلوقة'], '');
        const straw=pick(ev, ['straw','strawCode','القشة','كود القشة'], '');
        const timePart = at ? `الوقت: ${at}` : '';
        const bullPart = bull? `الطلوقة: ${bull}`: '';
        const stPart   = straw?`القشة: ${straw}`: '';
        return [timePart,bullPart,stPart].filter(Boolean).join(' — ');
      }
      if(t === 'لبن يومي'){
        const kg   = pick(ev, ['milkKg','kg','milk','لبن_كجم','كمية اللبن كجم'], '');
        const shift= pick(ev, ['shift','milkingShift','الوردية','وردية'], '');
        const p1 = kg!=='' ? `كجم: ${kg}` : '';
        const p2 = shift? `الوردية: ${shift}`: '';
        return [p1,p2].filter(Boolean).join(' — ');
      }
      const note = pick(ev, ['note','ملاحظة'], '');
      const result = pick(ev, ['result','النتيجة'], '');
      return [note, result].filter(Boolean).join(' — ');
    }

    function renderRows(events){
      evBody.innerHTML = '';
      if(!events.length){
        evBody.innerHTML = '<tr><td colspan="4" class="empty">لا توجد نتائج مطابقة…</td></tr>';
        return;
      }
      const frag = document.createDocumentFragment();
      for(const ev of events){
        const tr = document.createElement('tr');
        const cDate  = document.createElement('td'); cDate.textContent  = pick(ev, ['eventDate','date','dt'], '');
        const cNum   = document.createElement('td'); cNum.textContent   = pick(ev, ['animalNumber','number','animalId','id'], '');
        const cType  = document.createElement('td'); cType.innerHTML    = `<span class="pill">${pick(ev, ['type','eventType','event_name','name'], '')}</span>`;
        const cDet   = document.createElement('td'); cDet.textContent   = detailsFor(ev);
        tr.append(cDate,cNum,cType,cDet);
        frag.appendChild(tr);
      }
      evBody.appendChild(frag);
    }

    async function loadAndFilter(){
      const uid = currentUserId();
      if(!uid){ renderRows([]); return; }

      // اجلب أحدث 200 حدث للمستخدم (userId)
      const q = query(
        collection(db,'events'),
        where('userId','==',uid),
        orderBy('eventDate','desc'),
        limit(200)
      );
      const snap = await getDocs(q);
      const rows = [];
      snap.forEach(doc => rows.push({ id:doc.id, ...doc.data() }));

      const num  = (document.getElementById('f-num').value || '').trim();
      const type = (document.getElementById('f-type').value || '').trim();

      const filtered = rows.filter(r => {
        const okNum  = !num  || (String(pick(r,['animalNumber','number','animalId'],'')).trim() === num);
        const tval   = String(pick(r,['type','eventType','event_name','name'],'')).trim();
        const okType = !type || (tval === type);
        return okNum && okType;
      });

      renderRows(filtered);
    }

    // ربط الأزرار
    btnApply.addEventListener('click', loadAndFilter);
    btnClear.addEventListener('click', () => { fNum.value=''; fType.value=''; loadAndFilter(); });

    // إقلاع الصفحة: وراثة رقم الحيوان + انتظار الـAuth عند الحاجة
    window.addEventListener('DOMContentLoaded', () => {
      const n = getParam('number','animalNumber','num','n') || localStorage.getItem('currentAnimalNumber') || '';
      if(n){ fNum.value = n; } else { fNum.placeholder = 'رقم الحيوان (مثال 108)'; }

      if (auth.currentUser || localStorage.getItem('userId') || getParam('userId','uid')) {
        loadAndFilter();
      } else {
        onAuthStateChanged(auth, () => loadAndFilter());
      }
    });
  </script>
</body>
</html>
