<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تسجيل حيوان جديد</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f0f8ff;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #2e7d32;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    select, input, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #2e7d32;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background-color: #1b5e20;
    }
    .dual-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>تسجيل حيوان جديد</h2>
    <form id="animalForm">
      <label>رقم الحيوان*</label>
      <input type="text" id="animalId" required>

      <label>نوع الحيوان*</label>
      <select id="animalType" required onchange="updateBreedOptions()">
        <option value="">اختر</option>
        <option value="بقرة">بقرة</option>
        <option value="جاموسة">جاموسة</option>
      </select>

      <label>السلالة*</label>
      <select id="breed" required></select>

      <label>تاريخ الميلاد (اختياري)</label>
      <input type="date" id="birthDate">

      <label>تاريخ آخر ولادة*</label>
      <input type="date" id="lastCalvingDate" required>

      <label>الحالة التناسلية*</label>
      <select id="reproductiveStatus" required onchange="toggleInseminationDate()">
        <option value="">اختر</option>
        <option value="حديثة الولادة">حديثة الولادة</option>
        <option value="ملقحة">ملقحة</option>
        <option value="مفتوحة">مفتوحة</option>
        <option value="عشار">عشار</option>
        <option value="اجهاض">اجهاض</option>
      </select>

      <div id="inseminationDateField" class="hidden">
        <label>تاريخ آخر تلقيح</label>
        <input type="date" id="inseminationDate">
      </div>

      <label>الحالة الإنتاجية*</label>
      <select id="productionStatus" required onchange="toggleMilkField()">
        <option value="">اختر</option>
        <option value="حلاب">حلاب</option>
        <option value="جاف">جاف</option>
      </select>

      <div id="milkField" class="hidden">
        <label>إنتاج الحليب اليومي (لتر)</label>
        <input type="number" id="milkProduction" min="0" step="0.1">
      </div>

      <div class="dual-buttons">
        <button type="button" onclick="submitAnimal(true)">تسجيل حيوان آخر</button>
        <button type="button" onclick="submitAnimal(false)">التالي (تسجيل حدث)</button>
      </div>
    </form>
  </div>

  <script>
    function updateBreedOptions() {
      const type = document.getElementById("animalType").value;
      const breed = document.getElementById("breed");
      breed.innerHTML = "";
      if (type === "بقرة") {
        ["خليط", "هولشتاين", "جيرسي", "سيمنتال", "مونبليار", "أخرى"].forEach(opt => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          breed.appendChild(option);
        });
      } else if (type === "جاموسة") {
        ["مصري", "ايطالي مصري", "هندي مصري"].forEach(opt => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          breed.appendChild(option);
        });
      }
    }

    function toggleInseminationDate() {
      const value = document.getElementById("reproductiveStatus").value;
      document.getElementById("inseminationDateField").classList.toggle("hidden", value !== "ملقحة");
    }

    function toggleMilkField() {
      const value = document.getElementById("productionStatus").value;
      document.getElementById("milkField").classList.toggle("hidden", value !== "حلاب");
    }

    async function submitAnimal(addAnother) {
      const data = {
        tag: document.getElementById("animalId").value,
        type: document.getElementById("animalType").value,
        breed: document.getElementById("breed").value,
        reproductive_status: document.getElementById("reproductiveStatus").value,
        insemination_date: document.getElementById("inseminationDate").value || null,
        production_status: document.getElementById("productionStatus").value,
        milk_production: document.getElementById("milkProduction").value || null,
        birth_date: document.getElementById("birthDate").value || null,
        last_calving_date: document.getElementById("lastCalvingDate").value,
        user_id: 1
      };

      try {
        const res = await fetch("https://murabbic-alerts.onrender.com/api/animals", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert("✅ تم تسجيل الحيوان بنجاح");
          if (addAnother) {
            document.getElementById("animalForm").reset();
            updateBreedOptions();
            toggleInseminationDate();
            toggleMilkField();
          } else {
            window.location.href = "add-event.html";
          }
        } else {
          alert("❌ حدث خطأ أثناء التسجيل");
        }
      } catch (err) {
        alert("❌ فشل في الاتصال بالخادم");
        console.error(err);
      }
    }
  </script>
</body>
</html>
