<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¶Ø§ÙØ© Ø­ÙŠÙˆØ§Ù†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{font-family:'Cairo',sans-serif;background:linear-gradient(to bottom right,#eeffdd,#fffedc);padding:20px;margin:0}
    h1{txt-align:center;text-align:center;color:#2e7d32;font-size:26px;margin-bottom:15px;font-weight:bold}
    form{max-width:600px;margin:auto;background:#fff;padding:25px;border-radius:15px;box-shadow:0 0 12px rgba(0,0,0,.1)}
    label{display:block;margin-top:15px;font-weight:bold;color:#2e7d32}
    input,select,button{width:100%;padding:12px;margin-top:6px;font-size:16px;border:1px solid #cddc39;border-radius:8px;box-sizing:border-box}
    input:focus,select:focus{outline:none;border-color:#8bc34a;box-shadow:0 0 5px #cddc39}
    button{background:#43a047;color:#fff;margin-top:25px;font-weight:bold;border:none;transition:background-color .3s ease;cursor:pointer}
    button:hover{background:#2e7d32}
    #msg{margin-bottom:15px;padding:10px;border-radius:6px;font-weight:bold;text-align:center;display:none}
    #msg.success{background:#d1e7dd;color:#0f5132;display:block}
    #msg.error{background:#f8d7da;color:#842029;display:block}
    .toast{display:none;position:relative;padding:12px 14px 12px 48px;border-radius:14px;background:#ecfdf5;border:1px solid #10b98133;color:#065f46;font-weight:700;box-shadow:0 8px 24px rgba(16,185,129,.15);margin-bottom:10px}
    .toast.show{display:block;animation:toast-pop .25s ease-out}
    .toast .icon{position:absolute;inset-inline-start:12px;top:50%;transform:translateY(-50%);width:22px;height:22px}
    .toast .bar{position:absolute;left:8px;right:8px;bottom:6px;height:3px;background:#d1fae5;border-radius:999px;overflow:hidden}
    .toast .bar span{display:block;height:100%;width:100%;background:#10b981;animation:toast-shrink 1.6s linear forwards}
    @keyframes toast-pop{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}
    @keyframes toast-shrink{from{width:100%}to{width:0%}}
    #msg.toast.show { display: block; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap" rel="stylesheet">
</head>
<body>
  <h1>â• Ø¥Ø¶Ø§ÙØ© Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</h1>
  <form id="animalForm">
    <div id="msg"></div>

    <label for="animalNumber">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†:</label>
    <input type="text" id="animalNumber" required />

    <label for="animalType">Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†:</label>
    <select id="animalType" required>
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
      <option value="Ø¨Ù‚Ø±Ø©">Ø¨Ù‚Ø±Ø©</option>
      <option value="Ø¬Ø§Ù…ÙˆØ³Ø©">Ø¬Ø§Ù…ÙˆØ³Ø©</option>
    </select>

    <label for="breed">Ø§Ù„Ø³Ù„Ø§Ù„Ø©:</label>
    <select id="breed" required>
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù„Ø§Ù„Ø©</option>
    </select>

    <label for="productionStatus">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©:</label>
    <select id="productionStatus" required>
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
      <option value="Ø­Ù„Ø§Ø¨">Ø­Ù„Ø§Ø¨</option>
      <option value="Ø¬Ø§Ù">Ø¬Ø§Ù</option>
    </select>

    <div id="milkField" style="display:none;">
      <label for="dailyMilk">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ù„ØªØ±):</label>
      <input type="number" id="dailyMilk" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ…ÙŠØ© Ø§Ù„Ù„Ø¨Ù†" />
    </div>

    <label for="reproductiveStatus">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©:</label>
    <select id="reproductiveStatus" required>
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
      <option value="Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©">Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</option>
      <option value="Ù…Ù„Ù‚Ø­Ø©">Ù…Ù„Ù‚Ø­Ø©</option>
      <option value="Ø¹Ø´Ø§Ø±">Ø¹Ø´Ø§Ø±</option>
      <option value="Ù…ÙØªÙˆØ­Ø©">Ù…ÙØªÙˆØ­Ø©</option>
      <option value="Ø¥Ø¬Ù‡Ø§Ø¶">Ø¥Ø¬Ù‡Ø§Ø¶</option>
    </select>

    <!-- Ø¬Ø¯ÙŠØ¯ -->
    <label for="servicesCount">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙ„Ù‚ÙŠØ­ (Ø§Ù„Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ):</label>
    <input type="number" id="servicesCount" min="0" placeholder="0" />

    <!-- Ø¬Ø¯ÙŠØ¯ -->
    <label for="lactationNumber">Ø±Ù‚Ù… Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
    <input type="number" id="lactationNumber" min="0" placeholder="Ù…Ø«Ø§Ù„: 3" />

    <label for="birthDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
    <input type="date" id="birthDate" />

    <label for="lastCalvingDate">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©:</label>
    <input type="date" id="lastCalvingDate" required />

    <!-- DIM -->
    <label for="daysInMilk">Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ (DIM):</label>
    <input type="number" id="daysInMilk" readonly disabled placeholder="ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§" />

    <!-- Ø¬Ø¯ÙŠØ¯: Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù…Ù„ -->
    <div id="pregnancyBox" style="display:none;">
      <label for="pregnancyDays">Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù…Ù„:</label>
      <input type="number" id="pregnancyDays" readonly disabled placeholder="ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§" />
    </div>

    <div id="inseminationField" style="display:none;">
      <label for="lastInseminationDate">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­:</label>
      <input type="date" id="lastInseminationDate" />
    </div>

    <button type="submit">ğŸ“¥ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
    <a href="#" id="cancelLink">â¬…ï¸ Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©</a>
  </form>

  <script>
    (function(){
      const animalTypeEl = document.getElementById('animalType');
      const breedEl = document.getElementById('breed');
      const productionEl = document.getElementById('productionStatus');
      const milkField = document.getElementById('milkField');
      const dailyMilk = document.getElementById('dailyMilk');
      const reproductiveEl = document.getElementById('reproductiveStatus');
      const inseminationField = document.getElementById('inseminationField');
      const lastInseminationDate = document.getElementById('lastInseminationDate');
      const lastCalvingDate = document.getElementById('lastCalvingDate');
      const daysInMilk = document.getElementById('daysInMilk');
      const lactationNumber = document.getElementById('lactationNumber');
      const pregnancyBox = document.getElementById('pregnancyBox');
      const pregnancyDays = document.getElementById('pregnancyDays');

      const cowBreeds = ["Ø®Ù„ÙŠØ·","Ù‡ÙˆÙ„Ø´ØªØ§ÙŠÙ†","Ø¬ÙŠØ±Ø³ÙŠ","Ù…ÙˆÙ†Ø¨Ù„ÙŠØ§Ø±","Ø³ÙŠÙ…ÙŠÙ†ØªØ§Ù„","Ø£Ø®Ø±Ù‰"];
      const buffaloBreeds = ["Ù…ØµØ±ÙŠ","Ù‡Ø¬ÙŠÙ† Ø¥ÙŠØ·Ø§Ù„ÙŠ","Ù‡Ø¬ÙŠÙ† Ù‡Ù†Ø¯ÙŠ"];

      function updateBreedOptionsLocal(){
        const type = animalTypeEl.value;
        const breeds = (type === "Ø¨Ù‚Ø±Ø©") ? cowBreeds : (type === "Ø¬Ø§Ù…ÙˆØ³Ø©") ? buffaloBreeds : [];
        breedEl.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù„Ø§Ù„Ø©</option>' + breeds.map(b=>`<option value="${b}">${b}</option>`).join('');
      }

      function toggleMilkFieldLocal(){
        const show = (productionEl.value === "Ø­Ù„Ø§Ø¨");
        milkField.style.display = show ? "block" : "none";
        dailyMilk.required = show; if(!show) dailyMilk.value = "";
        toggleMilkVsPregnancy();
      }

      // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­
      function toggleInseminationFieldLocal(){
        const val = reproductiveEl.value;
        const showByRep = (val === "Ù…Ù„Ù‚Ø­Ø©" || val === "Ø¹Ø´Ø§Ø±" || val === "Ù…ÙØªÙˆØ­Ø©");
        const showByProd = (productionEl.value === "Ø¬Ø§Ù"); // Ø¬Ø§Ù ÙŠØ­ØªØ§Ø¬Ù‡ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ù…Ù„
        const show = showByRep || showByProd;
        inseminationField.style.display = show ? "block" : "none";
        lastInseminationDate.required = (val === "Ù…Ù„Ù‚Ø­Ø©" || val === "Ø¹Ø´Ø§Ø±" || productionEl.value === "Ø¬Ø§Ù");
        if(!show){ lastInseminationDate.value = ""; }
      }

      // ØªØ¹Ø·ÙŠÙ„/ØªÙ…ÙƒÙŠÙ† ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø© Ø­Ø³Ø¨ Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨
      function toggleCalvingForLactation(){
        const ln = Number(lactationNumber.value || 0);
        if (ln === 0){
          lastCalvingDate.value = "";
          lastCalvingDate.disabled = true;
          lastCalvingDate.required = false;
          daysInMilk.value = "";
          daysInMilk.disabled = true;
        }else{
          lastCalvingDate.disabled = false;
          lastCalvingDate.required = true;
          if (productionEl.value !== "Ø¬Ø§Ù") daysInMilk.disabled = false;
        }
      }

      // Ø­Ø³Ø§Ø¨ DIM
      function computeDIM(){
        if (productionEl.value === "Ø¬Ø§Ù") { daysInMilk.value=""; return; }
        const calv = lastCalvingDate.value;
        if (!calv){ daysInMilk.value = ""; return; }
        const d0 = new Date(calv), d1 = new Date();
        d0.setHours(0,0,0,0); d1.setHours(0,0,0,0);
        const diff = Math.max(0, Math.round((d1-d0)/86400000));
        daysInMilk.value = String(diff);
      }

      // Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù…Ù„ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­
      function computePregnancy(){
        if (productionEl.value !== "Ø¬Ø§Ù"){ pregnancyDays.value=""; return; }
        const ins = lastInseminationDate.value;
        if (!ins){ pregnancyDays.value=""; return; }
        const d0 = new Date(ins), d1 = new Date();
        d0.setHours(0,0,0,0); d1.setHours(0,0,0,0);
        const diff = Math.max(0, Math.round((d1-d0)/86400000));
        pregnancyDays.value = String(diff);
      }

      // ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† DIM ÙˆØ£ÙŠØ§Ù… Ø§Ù„Ø­Ù…Ù„
      function toggleMilkVsPregnancy(){
        const isDry = (productionEl.value === "Ø¬Ø§Ù");
        if (isDry){
          daysInMilk.value = "";
          daysInMilk.disabled = true;
          pregnancyBox.style.display = "block";
          pregnancyDays.disabled = false;
          computePregnancy();
        }else{
          pregnancyBox.style.display = "none";
          pregnancyDays.value = "";
          pregnancyDays.disabled = true;
          // Ù„Ø§ Ù†ÙÙ…ÙƒÙ‘ÙÙ† DIM Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ > 0
          if (Number(lactationNumber.value||0) > 0){
            daysInMilk.disabled = false;
            computeDIM();
          }
        }
      }

      // Ø£Ø­Ø¯Ø§Ø«
      ['change','input'].forEach(e=>animalTypeEl.addEventListener(e,updateBreedOptionsLocal));
      ['change','input'].forEach(e=>productionEl.addEventListener(e,()=>{toggleMilkFieldLocal();toggleInseminationFieldLocal();}));
      ['change','input'].forEach(e=>reproductiveEl.addEventListener(e,toggleInseminationFieldLocal));
      ['change','input'].forEach(e=>lastCalvingDate.addEventListener(e,computeDIM));
      ['change','input'].forEach(e=>lastInseminationDate.addEventListener(e,computePregnancy));
      ['change','input'].forEach(e=>lactationNumber.addEventListener(e,()=>{toggleCalvingForLactation();computeDIM();}));

      document.addEventListener('DOMContentLoaded', ()=>{
        updateBreedOptionsLocal();
        toggleCalvingForLactation();
        toggleMilkFieldLocal();
        toggleInseminationFieldLocal();
        toggleMilkVsPregnancy();
        computeDIM();
        computePregnancy();
      });

      window.__mbkUI = { updateBreedOptions: updateBreedOptionsLocal, toggleMilkField: toggleMilkFieldLocal, toggleInseminationField: toggleInseminationFieldLocal, computeDIM, computePregnancy, toggleCalvingForLactation };
    })();
  </script>

  <script> if (localStorage.getItem('SMART_ON') === null) localStorage.setItem('SMART_ON','1'); </script>
  <script>
    (function () {
      window.dataLayer = window.dataLayer || [];
      window.__sentEvents = window.__sentEvents || new Set();
      window.t = window.t || { event: function (name, props){ try{
        props = props || {};
        if (name === 'page_view'){
          var key = 'pv:' + (props.page || location.pathname);
          if (window.__sentEvents.has(key)) return;
          window.__sentEvents.add(key);
        }
        dataLayer.push({event:name, ts:Date.now(), ...props});
      }catch{}}};
      t.event('page_view', { page: location.pathname });
    })();
  </script>

  <script>
    window.flashOK = function(text, ms = 1600){
      const box = document.getElementById('msg');
      if (!box) return;
      box.className = 'toast show';
      box.style.display = 'block';
      box.innerHTML = `
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="10" stroke="#10b981" stroke-width="2"></circle>
          <path d="M7 12l3 3 7-7" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
        <div>${text}</div>
        <div class="bar"><span></span></div>
      `;
      setTimeout(()=>{ box.className = 'toast'; box.style.display = 'none'; box.innerHTML = ''; }, ms + 80);
    };
  </script>

  <script type="module">
    import { db, ensureAuth } from "./js/firebase-config.js";
    import { collection, addDoc, serverTimestamp, query, where, limit, getDocs }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const form   = document.getElementById("animalForm");
    const msgDiv = document.getElementById("msg");
    const DASHBOARD_URL = "dashboard.html";
    const $ = (id)=>document.getElementById(id);
    const todayLocal = ()=>{ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };

    function setMsg(text, ok=false){
      msgDiv.textContent = text;
      msgDiv.className   = ok ? "success" : "error";
      msgDiv.style.display = "block";
    }

    let __hasAnimals = null;
    window.addEventListener("DOMContentLoaded", async () => {
      history.pushState({page:"add-animal"}, "", location.href);
      const uid = localStorage.getItem("userId");
      if (uid){
        try {
          const s0 = await getDocs(query(collection(db,"animals"), where("userId","==",uid), limit(1)));
          __hasAnimals = !s0.empty;
        } catch {}
      }
      window.addEventListener("popstate", () => {
        if (__hasAnimals === false){
          alert("Ø£Ù†Øª Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ â€” ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø­ÙŠÙˆØ§Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø¬ÙˆØ¹.");
          history.pushState({page:"add-animal"}, "", location.href);
        } else {
          location.href = DASHBOARD_URL;
        }
      });
      const cancel = document.getElementById("cancelLink");
      cancel?.addEventListener("click",(e)=>{
        e.preventDefault();
        if (__hasAnimals === false){
          alert("Ø£Ù†Øª Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ â€” ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø­ÙŠÙˆØ§Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø¬ÙˆØ¹.");
          return;
        }
        location.href = DASHBOARD_URL;
      });
    });

    function normAnimaltype(ar){
      const s = String(ar||'').trim();
      if (s === 'Ø¨Ù‚Ø±Ø©' || s.toLowerCase() === 'cow') return 'cow';
      if (s === 'Ø¬Ø§Ù…ÙˆØ³Ø©' || s.toLowerCase() === 'buffalo') return 'buffalo';
      return 'cow';
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      msgDiv.style.display="none";

      const numberStr            = $("animalNumber").value.trim();
      const numberNum            = Number(numberStr);
      const animalTypeAr         = $("animalType").value;
      const animaltype           = normAnimaltype(animalTypeAr);
      const breed                = $("breed").value;
      const productionStatus     = $("productionStatus").value;
      const dailyMilkVal         = $("dailyMilk").value.trim();
      const reproductiveStatus   = $("reproductiveStatus").value;
      const servicesCount        = Number($("servicesCount").value || 0);
      const lactationNumber      = Number($("lactationNumber").value || 0);
      const birthDate            = $("birthDate").value || null;
      const lastCalvingDate      = $("lastCalvingDate").value;
      const lastInseminationInp  = $("lastInseminationDate").value || null;
      const daysInMilkVal        = Number($("daysInMilk").value || 0);
      const daysPregnantVal      = Number($("pregnancyDays").value || 0);

      const userId = localStorage.getItem("userId");
      if (!userId){ setMsg("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù‘ÙÙ„. Ø§Ø¯Ø®Ù„ Ø£ÙˆÙ„Ø§Ù‹.", false); return; }

      // Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      if (!numberStr || !animalTypeAr){ setMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.", false); return; }
      if (lactationNumber > 0 && !lastCalvingDate){ setMsg("Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©.", false); return; }
      if (productionStatus === "Ø¬Ø§Ù" && !lastInseminationInp){ setMsg("Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­ Ù„Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù…Ù„.", false); return; }

      try{
        await ensureAuth();

        const docData = {
          userId,
          number: numberStr,
          animalNumber: numberNum,
          userId_number: `${userId}#${numberStr}`,
          animaltype,
          animalTypeAr,
          breed,
          productionStatus,
          dailyMilk: productionStatus === "Ø­Ù„Ø§Ø¨" ? Number(dailyMilkVal || 0) : null,
          reproductiveStatus,
          servicesCount,
          lactationNumber,
          birthDate,
          lastCalvingDate: lactationNumber > 0 ? lastCalvingDate : null,
          lastInseminationDate:
            (reproductiveStatus === "Ù…Ù„Ù‚Ø­Ø©" || reproductiveStatus === "Ø¹Ø´Ø§Ø±" || productionStatus === "Ø¬Ø§Ù" || reproductiveStatus === "Ù…ÙØªÙˆØ­Ø©")
              ? (lastInseminationInp || null) : null,
          daysInMilk: productionStatus === "Ø¬Ø§Ù" ? null : (daysInMilkVal || null),
          daysPregnant: productionStatus === "Ø¬Ø§Ù" ? (daysPregnantVal || null) : null,
          createdAt: serverTimestamp(),
          demo: true
        };

        const ref = await addDoc(collection(db, "animals"), docData);

        try{ window.t?.event?.("animal_created", {
          userId, number:numberStr, animaltype, breed, productionStatus, lactationNumber, servicesCount
        }); }catch{}

        localStorage.setItem("currentAnimalId", ref.id);
        localStorage.setItem("currentAnimalNumber", numberStr);

        window.flashOK("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­ âœ…");

        setTimeout(() => {
          const dateStr = todayLocal();
          location.href = `add-event.html?animalId=${encodeURIComponent(ref.id)}&number=${encodeURIComponent(numberStr)}&date=${encodeURIComponent(dateStr)}`;
        }, 1200);

      }catch(err){
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†:", err);
        setMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.", false);
      }
    });
  </script>

  <script type="module" src="/js/timeline.js"></script>
  <script type="module" src="/js/smart-checks.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>
  <script src="/js/api.js" defer></script>
</body>
</html>
