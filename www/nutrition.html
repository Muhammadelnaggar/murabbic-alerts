
<!-- nutrition.html (Ù†Ø³Ø®Ø© Ø«Ø§Ø¨ØªØ©: ØªØµÙ…ÙŠÙ… + Ø­Ø³Ø§Ø¨Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠØŒ ÙˆØªØªØ¨Ø¹ Ù…Ù†Ø¶Ø¨Ø·ØŒ ÙˆØ­ÙØ¸ Ø®Ø§Ø±Ø¬ÙŠ) -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script type="module" src="/js/animal-update.js"></script>

  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <title>ØªØ³Ø¬ÙŠÙ„ ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„ØªØºØ°ÙŠØ©</title>

  <!-- ØªØªØ¨Ù‘Ø¹ ÙˆØ§Ø­Ø¯ Ø¢Ù…Ù† ÙÙŠ <head> (ÙŠÙ…Ù†Ø¹ ØªÙƒØ±Ø§Ø± page_view) -->
  <script>
    (function(){
      window.dataLayer = window.dataLayer || [];
      const fired = new Set();
      function push(name, props){ try{ dataLayer.push({ event:name, ts:Date.now(), ...(props||{}) }); }catch(e){} }
      window.t = window.t || {};
      window.t.event = function(name, props){
        if(name==='page_view'){
          const key = (props && props.page) || location.pathname;
          if(fired.has(key)) return;
          fired.add(key);
          setTimeout(()=>fired.delete(key), 2000);
        }
        push(name, props);
      };
      t.event('page_view', { page: location.pathname });
    })();
  </script>

  <style>
    *{box-sizing:border-box}
   body{
  direction:rtl;
  margin:0;
  font-family:system-ui,"Cairo","Segoe UI",Tahoma,Arial,sans-serif;
}
    h1{margin:0 0 8px;text-align:center;color:var(--green);font-size:22px}
    .wrap{max-width:1080px;margin:0 auto}
    .info{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:8px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#dcedc8;color:#1b5e20;font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row>.grow{flex:1}
    select,input,button{font-size:14px}
    input,select{padding:10px;border:1px solid #ccc;border-radius:10px}
    input,select,button{min-height:44px}
    button{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:bold;cursor:pointer}
    .btn{background:#fff;border:1px solid var(--green);color:var(--green)}
    .btn-primary{background:var(--green);color:#fff}
    .warning{color:#c62828;text-align:center;min-height:22px;margin-top:6px}
    .table-wrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:collapse;margin-top:10px;min-width:1020px}
    th,td{border:1px solid #e0ebd3;padding:8px;text-align:center}
    th{background:#eafbe7;color:#1b5e20}
    tbody tr:nth-child(odd){background:#fcfff5}
    .total{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
    .total .pill{background:#fff}
    @media (max-width: 640px){
      .row.stack > *{flex:1 1 100%}
      table, thead, tbody, th, td, tr{display:block;min-width:unset}
      thead{display:none}
      tbody tr{margin:0 0 12px 0;border:1px solid #e0ebd3;border-radius:12px;background:#fff}
      tbody tr > td{display:flex;justify-content:space-between;align-items:center;border:0;border-bottom:1px solid #eef3e4;padding:10px 12px}
      tbody tr > td:last-child{border-bottom:0}
      td::before{content:attr(data-label);font-weight:bold;color:#2e7d32;flex:0 0 48%}
      td > input, td > select{width:48%}
    }
  
/* ===== Murabbik Nutrition Mobile polish (Simple/Effective/Creative) ===== */
.info{display:grid;gap:8px;margin:10px auto;max-width:860px;padding:0 12px}
.info .pill{display:flex;flex-direction:column;align-items:flex-start;justify-content:center;gap:2px;padding:10px 12px;border-radius:14px;line-height:1.1}
.info .pill b{font-size:15px}
.info .pill .k{font-size:12px;opacity:.75}
#ctxList{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (min-width:720px){#ctxList{grid-template-columns:repeat(4,minmax(0,1fr))}}
/* Hide template + search buttons (keep DOM for safety) */
#tpl, #applyTpl, #addBySearch{display:none !important}
/* Make controls row wrap nicely on mobile */
.row.controls{flex-wrap:wrap;gap:6px}
.row.controls .grow{min-width:160px}
 .controls-box{
  background:#fff;
  border:1px solid rgba(0,0,0,.06);
  border-radius:16px;
  padding:8px;   /* ÙƒØ§Ù† 12 */
}
.controls-box .controls{margin:0}   
/* Hide per-item DM-kg and cost columns (we compute totals in analysis cards) */
th[data-col="dm"], th[data-col="dmkg"], td[data-col="dm"], td[data-col="dmkg"],
th[data-col="cost"], td[data-col="cost"]{display:none !important}
/* Analysis cards bottom */
#analysisSection{max-width:860px;margin:14px auto 22px;padding:0 12px}
.mbk-card{
  background:#fff;
  border:1px solid rgba(0,0,0,.06);
  border-radius:16px;
  padding:10px;      /* ÙƒØ§Ù† 14 */
  margin:8px 0;      /* ÙƒØ§Ù† 14 */
}
.mbk-card h3{margin:0 0 10px;font-size:15px}
.kpi-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.kpi{background:#f8fafc;border:1px solid rgba(0,0,0,.05);border-radius:14px;padding:10px}
.kpi .k{font-size:12px;opacity:.75}
.kpi .v{font-weight:800;font-size:15px;margin-top:2px}
.kpi-row{display:flex;gap:8px;flex-wrap:wrap}
.btn-ghost{background:transparent;border:1px solid rgba(0,0,0,.12)}
#advancedKPIs{margin-top:10px}


    /* ===== Animal / Group compact strip (2 rows, mobile-first) ===== */
    .animal-strip{padding:8px 10px;margin:6px 8px 10px;background:#fff;border:1px solid #eef2f7;border-radius:12px}
    .animal-strip.top-strip{margin-top:10px}
    .strip-row{display:flex;gap:8px}
    .strip-row + .strip-row{margin-top:8px}
    .strip-item{flex:1;min-width:0;text-align:center}
   .strip-item .lbl{
  display:block;
  font-size:13px;       /* Ø£ÙƒØ¨Ø± */
  line-height:1.2;
  color:#374151;        /* Ø£ØºÙ…Ù‚ Ø´ÙˆÙŠØ© */
  font-weight:800;      /* Ø¹Ø±ÙŠØ¶ */
  letter-spacing:0.3px;
}
   .strip-item .val{
  display:block;
  margin-top:4px;
  font-size:18px;        /* Ø£ÙƒØ¨Ø± */
  line-height:1.3;
  font-weight:900;       /* Ø£Ø¹Ø±Ø¶ */
  color:#0b7f47;
  letter-spacing:0.3px;
}
    @media (max-width:420px){
      .strip-item .val{font-size:13px}
    }
 .controls-box select{
  height:38px;
  padding:4px 10px;
}   
  .mini-actions{
  display:flex;
  gap:6px;
  align-items:center;
}

.mini-btn{
  background:#fff;
  color:var(--green);
  border:1px solid var(--green);
  border-radius:8px;
  padding:6px 10px;
  font-size:13px;
  font-weight:600;
}  
/* ===== Nutrition UX tweaks (Murabbik) ===== */
#feedInputBox{
  background: rgba(14,160,90,.10);
  border: 1px solid rgba(14,160,90,.25);
  border-radius: 16px;
  padding: 10px;
  margin-top: 10px;
}

.mini-actions{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:flex-start;
  margin-top:10px;
}

.mini-btn{
  background:#fff;
  color:var(--green);
  border:1px solid var(--green);
  border-radius:10px;
  padding:8px 12px;
  font-size:13px;
  font-weight:800;
  min-height:40px;
}

.feed-summary{
  margin-top:10px;
  background:#f3fbf5;
  border:1px dashed rgba(14,160,90,.35);
  border-radius:14px;
  padding:10px 12px;
  font-size:13px;
}

.feed-item{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:8px 0;
  border-bottom:1px solid #e0ebd3;
}
.feed-item:last-child{border-bottom:none}
.feed-item .a{font-weight:800;color:#0b7f47}
.feed-item .b{opacity:.9}    
</style>
</head>
<body>
<div class="mbk-form">
 <header class="mbk-head">
  <a href="/dashboard.html" class="mbk-back">â†</a>
  <div class="mbk-center">
    <div class="mbk-page-title">ØªØ³Ø¬ÙŠÙ„ ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„ØªØºØ°ÙŠØ©</div>
    <div class="mbk-app-name">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
  </div>
  <img src="/logo.png" class="mbk-logo" alt="Murabbik">
</header>

  <div class="animal-strip top-strip">
  <div class="strip-row">
    <div class="strip-item"><span class="lbl">Ø§Ù„Ø­ÙŠÙˆØ§Ù† / Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span><span class="val" id="animalInfo">â€”</span></div>
    <div class="strip-item"><span class="lbl">Ø§Ù„ØªØ§Ø±ÙŠØ®</span><span class="val" id="dateInfo">â€”</span></div>
  </div>
</div>
  <div class="animal-strip" id="ctxList">
  <div class="strip-row">
    <div class="strip-item"><span class="lbl">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ (DIM)</span><span class="val" id="ctxDIM_txt">â€”</span></div>
    <div class="strip-item"><span class="lbl">Ø§Ù„Ù†ÙˆØ¹</span><span class="val" id="ctxSpecies_txt">â€”</span></div>
    <div class="strip-item"><span class="lbl">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù„Ø¨Ù†/Ø±Ø£Ø³</span><span class="val" id="ctxAvgMilk_txt">â€”</span></div>
    <div class="strip-item"><span class="lbl">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù…Ù„ (DCC)</span><span class="val" id="ctxDCC_txt">â€”</span></div>
  </div>

  <div class="strip-row">
    <div class="strip-item"><span class="lbl">Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ÙˆÙ„Ø§Ø¯Ø©</span><span class="val" id="dtcVal">â€”</span></div>
    <div class="strip-item"><span class="lbl">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„</span><span class="val" id="ctxPreg_txt">â€”</span></div>
    <div class="strip-item"><span class="lbl">Ø¬Ø§Ù Ù…Ø¨ÙƒÙ‘Ø±</span><span class="val" id="ctxEarlyDry_txt">â€”</span></div>
    <div class="strip-item"><span class="lbl">ØªØ­Ø¶ÙŠØ± ÙˆÙ„Ø§Ø¯Ø©</span><span class="val" id="ctxCloseUp_txt">â€”</span></div>
  </div>

  <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ù…Ø®ÙÙŠØ©) Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ nutrition.js -->

    <input id="ctxDIM" type="number" inputmode="numeric" step="1" min="0" style="display:none">
    <select id="ctxSpecies" style="display:none"><option value="">â€”</option><option value="Ø¨Ù‚Ø±">Ø¨Ù‚Ø±</option><option value="Ø¬Ø§Ù…ÙˆØ³">Ø¬Ø§Ù…ÙˆØ³</option></select>
    <input id="ctxAvgMilk" type="number" inputmode="decimal" step="0.1" style="display:none">
    <input id="ctxDCC" type="number" inputmode="numeric" step="1" min="0" style="display:none">
    <input id="ctxEarlyDry" type="checkbox" style="display:none">
    <input id="ctxCloseUp" type="checkbox" style="display:none">
    <select id="ctxPreg" style="display:none"><option value="">â€”</option><option value="Ø¹Ø´Ø§Ø±">Ø¹Ø´Ø§Ø±</option><option value="ÙØ§Ø±ØºØ©">ÙØ§Ø±ØºØ©</option></select>
  </div>

  <div class="warning" id="warn"></div>
<div class="mbk-card">
  <div class="controls-box">
    <div class="row stack controls">

      <!-- 1) Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
      <div class="grow">
        <select id="mode" style="width:100%">
          <option value="" selected disabled>Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</option>
          <option value="tmr_asfed">Ø®Ù„Ø·Ø© ÙƒØ§Ù…Ù„Ø© TMR â€” as-fed/Ø±Ø£Ø³</option>
          <option value="tmr_percent">Ø®Ù„Ø·Ø© ÙƒØ§Ù…Ù„Ø© TMR â€” Ù†Ø³Ø¨ as-fed Ù„Ù„Ø·Ù†</option>
          <option value="split">Ù…Ø±ÙƒØ²Ø§Øª ÙˆØ®Ø´Ù† â€” Ù…Ù†ÙØµÙ„</option>
        </select>
      </div>

      <!-- 2) Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ù‡ (Ù‚Ø¨Ù„ Ø§Ø®ØªØ± Ø®Ø§Ù…Ø©) -->
      <div class="grow">
        <select id="feedTypeFilter" style="width:100%">
          <option value="" selected disabled>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ù‡</option>
          <option value="conc">Ù…Ø±ÙƒØ²Ø§Øª</option>
          <option value="rough">Ø®Ø´Ù†</option>
          <option value="add">Ø¥Ø¶Ø§ÙØ§Øª</option>
          <option value="all">ÙƒÙ„ Ø§Ù„Ø®Ø§Ù…Ø§Øª</option>
        </select>
      </div>

      <!-- 3) Ø§Ø®ØªØ± Ø®Ø§Ù…Ø© -->
      <div class="grow">
        <select id="preset" style="width:100%">
          <option value="" selected disabled>Ø§Ø®ØªØ± Ø®Ø§Ù…Ø©</option>
        </select>
      </div>

     <div class="mini-actions">
</div>

    </div>
  </div>
  
  <div id="feedSummaryBox" class="feed-summary" style="display:none"></div>

    <div id="splitBox" class="row stack" style="margin-top:8px;display:none">
      <div class="grow">
        <label class="muted">ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ² as-fed ÙƒØ¬Ù…/Ø±Ø£Ø³/ÙŠÙˆÙ…</label>
        <input id="concKgInput" type="number" inputmode="decimal" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 6.0" style="width:160px">
      </div>
      <div class="grow">
        <label class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <div class="pill">ØµÙÙˆÙ Ø§Ù„ÙØ¦Ø© = Ø®Ø´Ù† ØªÙÙƒØªØ¨ Ø¨Ø§Ù„ÙƒØ¬Ù…/Ø±Ø£Ø³. ØµÙÙˆÙ Ø§Ù„ÙØ¦Ø© = Ù…Ø±ÙƒØ² ØªÙÙƒØªØ¨ Ù†Ø³Ø¨ as-fed Ù„Ù„Ø·Ù†.</div>
      </div>
    </div>

   <div class="table-wrap" id="feedInputBox" style="display:none">
      <table id="tbl">
      <div class="mini-actions" id="miniActions" style="display:none">
  <button id="addPreset" class="mini-btn" type="button">Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ù…Ø©</button>
  <button id="clearAll" class="mini-btn" type="button">Ù…Ø³Ø­ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø©</button>
</div>  
        <thead>
          <tr>
            <th data-col="name">Ø§Ù„Ø®Ø§Ù…Ø©</th>
            <th data-col="cat">Ø§Ù„ÙØ¦Ø©</th>
            <th data-col="dm">% DM</th>
            <th data-col="pTon">Ø³Ø¹Ø± Ø§Ù„Ø·Ù† (as-fed)</th>
            <th data-col="pTonDM">Ø³Ø¹Ø±/Ø·Ù† DM</th>
            <th data-col="pct">Ù†Ø³Ø¨Ø© as-fed %</th>
            <th data-col="kg">ÙƒØ¬Ù… as-fed/Ø±Ø£Ø³</th>
            <th data-col="kgDM">ÙƒØ¬Ù… DM/Ø±Ø£Ø³</th>
            <th data-col="cost">ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³/ÙŠÙˆÙ…</th>
            <th data-col="rm">Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="total" id="totalsBase">
      <span class="pill" id="pillSumPct" style="display:none">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‘ÙØ³Ø¨: <b id="sumPct">0%</b></span>
      <span class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒØ¬Ù… DM/Ø±Ø£Ø³: <b id="totDM">0</b></span>
      <span class="pill">ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³/ÙŠÙˆÙ…: <b id="totCost">0</b></span>
      <span class="pill" id="pillMix">Ø³Ø¹Ø± Ø·Ù† TMR (DM): <b id="mixPriceDM">â€”</b></span>
    </div>

    <div class="total" id="totalsSplit" style="display:none">
      <span class="pill">Ø®Ø´Ù† â€” ÙƒØ¬Ù… DM/Ø±Ø£Ø³: <b id="roughDM">â€”</b></span>
      <span class="pill">Ø®Ø´Ù† â€” ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³: <b id="roughCost">â€”</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‘ÙØ³Ø¨: <b id="sumPctConc">â€”%</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” %DM Ù„Ù„Ø®Ù„Ø·Ø©: <b id="concDMpct">â€”%</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” Ø³Ø¹Ø± Ø·Ù† (DM): <b id="concPriceDM">â€”</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” as-fed/Ø±Ø£Ø³: <b id="concKgShow">â€”</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” ÙƒØ¬Ù… DM/Ø±Ø£Ø³: <b id="concKgDM">â€”</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³: <b id="concCost">â€”</b></span>
      <span class="pill">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ â€” ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³: <b id="totalCostAll">â€”</b></span>
    </div>
  </div>

  <div class="card">
    <div class="row stack">
      <form id="nutritionForm" data-event="nutrition" data-redirect="/dashboard.html" style="width:100%">
        <button id="saveEvent" class="btn-primary" style="width:100%">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø© ÙƒØ­Ø¯Ø« ØªØºØ°ÙŠØ©</button>
      </form>
      <!-- ===== Analysis (Bottom) ===== -->
<div id="analysisSection">
  <div class="mbk-card" id="nutritionAnalysisCard">
    <h3>ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù„ÙŠÙ‚Ø©</h3>
    <div id="nutritionKPIs" class="kpi-grid"></div>
    <button id="toggleAdvancedBtn" class="btn btn-ghost" type="button" style="margin-top:10px">Ø¹Ø±Ø¶ Ù…ØªÙ‚Ø¯Ù…</button>
    <div id="advancedKPIs" style="display:none" class="kpi-grid"></div>
  </div>

  <div class="mbk-card" id="economicAnalysisCard">
    <h3>ğŸ’° Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ</h3>
    <div id="economicKPIs" class="kpi-grid"></div>
  </div>
</div>
</div>
    </div>
    <div id="inlineMsg" class="notice" role="status" aria-live="polite" style="display:none;margin-top:10px">
      <div class="text" style="font-weight:bold"></div>
      <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button type="button" class="btn btn-primary" id="msgYes" style="flex:1">ØªØ³Ø¬ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« Ø£Ø®Ø±Ù‰</button>
        <button type="button" class="btn" id="msgNo" style="flex:1">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù€UI ÙÙ‚Ø· (Ù„Ø§ Ø­ÙØ¸ ÙˆÙ„Ø§ ØªØªØ¨Ù‘Ø¹ Ù‡Ù†Ø§) ===== -->
<script type="module">
  const warn = document.getElementById('warn');
  const modeSel = document.getElementById('mode');
  const ctxDIM = document.getElementById('ctxDIM');
  const ctxSpecies = document.getElementById('ctxSpecies');
  const ctxAvgMilk = document.getElementById('ctxAvgMilk');
  const ctxDCC = document.getElementById('ctxDCC');
  const dtcVal = document.getElementById('dtcVal');
  const ctxEarlyDry = document.getElementById('ctxEarlyDry');
  const ctxCloseUp = document.getElementById('ctxCloseUp');
  const ctxPreg = document.getElementById('ctxPreg');
  const presetSel = document.getElementById('preset');
  const feedInputBox = document.getElementById('feedInputBox');
const feedSummaryBox = document.getElementById('feedSummaryBox');
const miniActions = document.getElementById('miniActions');

function showFeedUI(){
  if(feedInputBox) feedInputBox.style.display = 'block';
  if(feedSummaryBox) feedSummaryBox.style.display = 'block';
  if(miniActions) miniActions.style.display = 'flex';
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

function updateFeedSummary(){
  if(!feedSummaryBox) return;
  const mode = modeSel.value;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const items = [];

  for(const tr of rows){
    const name = tr.querySelector('.name')?.value?.trim();
    if(!name) continue;

    const kg = parseFloat(tr.querySelector('.kg')?.value)||0;
    const pct= parseFloat(tr.querySelector('.pct')?.value)||0;
    const kgDMtxt = tr.querySelector('.kgDM')?.textContent || 'â€”';

    let left = '';
    if(mode==='tmr_percent' || (mode==='split' && (tr.querySelector('.cat')?.value||'')!=='rough')){
      left = (pct? (nf(pct)+'%') : 'â€”') + ' as-fed';
    } else {
      left = (kg? (nf(kg)+' ÙƒØ¬Ù…') : 'â€”') + ' as-fed';
    }

    items.push({name, left, kgDMtxt});
  }

  if(items.length===0){
    feedSummaryBox.innerHTML = '<div style="opacity:.75">Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø®Ø§Ù…Ø§Øª Ø¨Ø¹Ø¯.</div>';
    return;
  }

  feedSummaryBox.innerHTML = items.map(it=>(
    '<div class="feed-item"><span class="a">'+escapeHtml(it.name)+'</span><span class="b">'+escapeHtml(it.left)+' | DM '+escapeHtml(it.kgDMtxt)+'</span></div>'
  )).join('');
}
  const clearBtn = document.getElementById('clearAll');
  const tplSel = document.getElementById('tpl');
  const tbody = document.querySelector('#tbl tbody');
  const splitBox = document.getElementById('splitBox');
  const concKgInput = document.getElementById('concKgInput');

  function todayLocal(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
  const qp = new URLSearchParams(location.search);
 const animalId =
  qp.get('animalNumber') ||
  qp.get('number') ||
  qp.get('animalId') ||
  '';
  const groupName = qp.get('group') || '';
  const eventDate= qp.get('date') || todayLocal();

  document.getElementById('animalInfo').textContent = (groupName || animalId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
  try{ document.getElementById('dateInfo').textContent = new Date(eventDate).toLocaleDateString('ar-EG'); }catch{ document.getElementById('dateInfo').textContent = eventDate; }

  // ØªØ¹Ø¨Ø¦Ø© Ø³ÙŠØ§Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
  ctxDIM.value      = qp.get('dim') || '';
  ctxSpecies.value  = qp.get('species') || '';
  ctxAvgMilk.value  = qp.get('avgMilk') || '';
  ctxDCC.value      = qp.get('dcc') || '';
  ctxPreg.value     = qp.get('preg') || qp.get('pregnancy') || '';
  // ===== ØªØ­Ù…ÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† animals =====
async function loadSpeciesFromAnimals(){
  try{
    if(!animalId) return;

    const { db, auth } = await import('/js/firebase-config.js');
    const { collection, query, where, getDocs } =
      await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');

    const uid = auth?.currentUser?.uid;

    // Ø¬Ø±Ù‘Ø¨ animalNumber Ø±Ù‚Ù…
    let snap = await getDocs(query(
      collection(db,'animals'),
      where('animalNumber','==', Number(animalId))
    ));

    // Ù„Ùˆ ÙØ§Ø¶ÙŠ Ø¬Ø±Ù‘Ø¨ ÙƒÙ†Øµ
    if(snap.empty){
      snap = await getDocs(query(
        collection(db,'animals'),
        where('animalNumber','==', animalId)
      ));
    }

    if(snap.empty) return;

    let data = snap.docs[0].data();

    let typeAr =
      data.animalTypeAr ||
      (data.animaltype==='buffalo' ? 'Ø¬Ø§Ù…ÙˆØ³Ø©' :
       data.animaltype==='cow' ? 'Ø¨Ù‚Ø±Ø©' : '');

    if(!typeAr) return;

    // Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ·
    document.getElementById('ctxSpecies_txt').textContent = typeAr;

    // Ù„Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ø¨Ù‚Ø± Ø£Ùˆ Ø¬Ø§Ù…ÙˆØ³ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª)
    ctxSpecies.value =
      typeAr.includes('Ø¬Ø§Ù…ÙˆØ³') ? 'Ø¬Ø§Ù…ÙˆØ³' : 'Ø¨Ù‚Ø±';

  }catch(e){
    console.warn(e);
  }
}
  if ((qp.get('earlyDry')||'') === '1') ctxEarlyDry.checked = true;
  if ((qp.get('closeUp') ||'') === '1') ctxCloseUp.checked  = true;

  // ===== Ù…ÙƒØªØ¨Ø© Ø®Ø§Ù…Ø§Øª Ù…ØµØ± Ù…Ù† Firestore (Ù„Ø§ Ø¹Ù„Ø§Ù‚Ø© Ø¨Ø¨Ù‚Ø±/Ø¬Ø§Ù…ÙˆØ³) =====
 const { db, auth } = await import('/js/firebase-config.js');
  const fs = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
 const { collection, query, where, getDocs, doc, getDoc } = fs;

  let FEEDS = [];                 // [{id,name,dm}]
  const FEEDS_BY_ID = new Map();  // id -> feed

  function rebuildFeedUI(){
    // 1) rebuild preset select
    presetSel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± â€”</option>';
    FEEDS.forEach(f=>{
      const o = document.createElement('option');
      o.value = f.id;           // âœ… docId Ø¨Ø¯Ù„ index
      o.textContent = f.name;
      presetSel.appendChild(o);
    });

    // 2) rebuild datalist feedlist
    const old = document.getElementById('feedlist');
    if(old) old.remove();
    const dl = document.createElement('datalist');
    dl.id = 'feedlist';
    FEEDS.forEach(f=>{
      const o = document.createElement('option');
      o.value = f.name;
      dl.appendChild(o);
    });
    document.body.appendChild(dl);
  }

  async function loadFeedLibrary(){
    FEEDS = [];
    FEEDS_BY_ID.clear();

    // âœ… ÙƒÙ„ Ø§Ù„Ø®Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø© ÙÙ‚Ø·
    const snap = await getDocs(query(
      collection(db, 'feed_items'),
      where('enabled', '==', true)
    ));

    const list = [];
    snap.forEach(docSnap=>{
      const d = docSnap.data() || {};
      const name = String(d.nameAr || '').trim();
      if(!name) return;
     
     list.push({
  id: docSnap.id,
  name,
  dm: Number(d.dmPct ?? null),
  cp: Number(d.cpPct ?? null),
  nel: Number(d.nelMcalPerKgDM ?? null),
  ndf: Number(d.ndfPct ?? null),
  mp: Number(d.mpGPerKgDM ?? null),   // ğŸ”¥ Ø¬Ø¯ÙŠØ¯
});
    });
// ===== Ø¯Ù…Ø¬ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Overrides) ÙÙˆÙ‚ Ù‚ÙŠÙ… NRC =====
const { auth } = await import('/js/firebase-config.js');
const uid = auth?.currentUser?.uid;

if (uid) {
  for (const f of list) {
    const oid = `${uid}__${f.id}`; // docId Ø«Ø§Ø¨Øª: userId__feedId
    try {
      const od = await getDoc(doc(db, 'feed_overrides', oid));
      if (!od.exists()) continue;

      const o = od.data() || {};

      // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø®ÙÙ‰ Ø®Ø§Ù…Ø©
      if (o.enabled === false) { f._hiddenByUser = true; continue; }

      // Override Ù„Ø£ÙŠ Ù‚ÙŠÙ…Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
      if (o.dmPct != null) f.dm = Number(o.dmPct);
      if (o.cpPct != null) f.cp = Number(o.cpPct);
      if (o.nelMcalPerKgDM != null) f.nel = Number(o.nelMcalPerKgDM);
      if (o.ndfPct != null) f.ndf = Number(o.ndfPct);
      if (o.mpGPerKgDM != null) f.mp = Number(o.mpGPerKgDM);
    } catch (e) {
      console.warn('override read failed for', f.id, e);
    }
  }
}
   // Ø´ÙŠÙ„ Ø§Ù„Ø®Ø§Ù…Ø§Øª Ø§Ù„Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø®ÙÙŠÙ‡Ø§
const list2 = list.filter(x => !x._hiddenByUser);

// ØªØ±ØªÙŠØ¨ Ø¹Ø±Ø¨ÙŠ
list2.sort((a,b)=> a.name.localeCompare(b.name, 'ar'));

FEEDS = list2;;
    FEEDS.forEach(f=> FEEDS_BY_ID.set(f.id, f));
    rebuildFeedUI();
  }
  const TEMPLATES = [
    { key: 'tmr_asfed_high_cow', name: 'TMR as-fed â€” Ø­Ù„Ø§Ø¨Ø© Ù…Ø±ØªÙØ¹Ø© (Ø¨Ù‚Ø±)', mode: 'tmr_asfed', items: [
      { name:'Ø³ÙŠÙ„Ø§Ø¬ Ø°Ø±Ø©', cat:'rough', dm:33, kg:22 },
      { name:'Ø¯Ø±ÙŠØ³ Ø¨Ø±Ø³ÙŠÙ…', cat:'rough', dm:90, kg:1.5 },
      { name:'Ø°Ø±Ø© ØµÙØ±Ø§Ø¡ Ù…Ø¬Ø±ÙˆØ´Ø©', cat:'conc', dm:88, kg:6 },
      { name:'ÙƒØ³Ø¨ ÙÙˆÙ„ ØµÙˆÙŠØ§ 48%', cat:'conc', dm:89, kg:2.5 },
      { name:'Ù…ÙˆÙ„Ø§Ø³', cat:'conc', dm:75, kg:0.5 },
      { name:'Ù…Ø®Ù„ÙˆØ· Ù…Ø¹Ø§Ø¯Ù†/ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª', cat:'conc', dm:95, kg:0.15 },
      { name:'Ø­Ø¬Ø± Ø¬ÙŠØ±ÙŠ (ÙƒØ§Ù„Ø³ÙŠÙˆÙ…)', cat:'conc', dm:100, kg:0.10 },
      { name:'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…', cat:'conc', dm:100, kg:0.05 },
      { name:'Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª ØµÙˆØ¯ÙŠÙˆÙ…', cat:'conc', dm:100, kg:0.10 },
      { name:'Ø¯Ù‡ÙˆÙ† Ù…Ø­Ù…ÙŠØ©', cat:'conc', dm:99, kg:0.30 },
    ]},
    { key: 'tmr_percent_mid_cow', name: 'TMR Ù†Ø³Ø¨ as-fed â€” Ø­Ù„Ø§Ø¨Ø© Ù…ØªÙˆØ³Ø·Ø© (Ø¨Ù‚Ø±)', mode: 'tmr_percent', items: [
      { name:'Ø³ÙŠÙ„Ø§Ø¬ Ø°Ø±Ø©', cat:'rough', dm:33, pct:40 },
      { name:'Ø¯Ø±ÙŠØ³ Ø¨Ø±Ø³ÙŠÙ…', cat:'rough', dm:90, pct:5 },
      { name:'Ø°Ø±Ø© ØµÙØ±Ø§Ø¡ Ù…Ø¬Ø±ÙˆØ´Ø©', cat:'conc', dm:88, pct:23 },
      { name:'Ø±Ø¯Ø© Ù‚Ù…Ø­ (Ù†Ø®Ø§Ù„Ø©)', cat:'conc', dm:89, pct:10 },
      { name:'ÙƒØ³Ø¨ ÙÙˆÙ„ ØµÙˆÙŠØ§ 48%', cat:'conc', dm:89, pct:12 },
      { name:'Ù…ÙˆÙ„Ø§Ø³', cat:'conc', dm:75, pct:3 },
      { name:'Ù…Ø®Ù„ÙˆØ· Ù…Ø¹Ø§Ø¯Ù†/ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª', cat:'conc', dm:95, pct:2 },
      { name:'Ø­Ø¬Ø± Ø¬ÙŠØ±ÙŠ (ÙƒØ§Ù„Ø³ÙŠÙˆÙ…)', cat:'conc', dm:100, pct:2 },
      { name:'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…', cat:'conc', dm:100, pct:1 },
      { name:'Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª ØµÙˆØ¯ÙŠÙˆÙ…', cat:'conc', dm:100, pct:2 },
    ]},
    { key: 'split_conc6', name: 'Ù…Ù†ÙØµÙ„ â€” Ù…Ø±ÙƒØ² 6 ÙƒØ¬Ù… + Ø®Ø´Ù† as-fed', mode: 'split', concKg: 6, items: [
      { name:'Ø³ÙŠÙ„Ø§Ø¬ Ø°Ø±Ø©', cat:'rough', dm:33, kg:20 },
      { name:'Ø¯Ø±ÙŠØ³ Ø¨Ø±Ø³ÙŠÙ…', cat:'rough', dm:90, kg:1 },
      { name:'Ø°Ø±Ø© ØµÙØ±Ø§Ø¡ Ù…Ø¬Ø±ÙˆØ´Ø©', cat:'conc', dm:88, pct:45 },
      { name:'Ø±Ø¯Ø© Ù‚Ù…Ø­ (Ù†Ø®Ø§Ù„Ø©)', cat:'conc', dm:89, pct:15 },
      { name:'ÙƒØ³Ø¨ ÙÙˆÙ„ ØµÙˆÙŠØ§ 48%', cat:'conc', dm:89, pct:20 },
      { name:'Ø¬Ù„ÙˆØªÙŠÙ† ÙÙŠØ¯ (CGF)', cat:'conc', dm:90, pct:5 },
      { name:'Ù…ÙˆÙ„Ø§Ø³', cat:'conc', dm:75, pct:5 },
      { name:'Ù…Ø®Ù„ÙˆØ· Ù…Ø¹Ø§Ø¯Ù†/ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª', cat:'conc', dm:95, pct:2 },
      { name:'Ø­Ø¬Ø± Ø¬ÙŠØ±ÙŠ (ÙƒØ§Ù„Ø³ÙŠÙˆÙ…)', cat:'conc', dm:100, pct:2 },
      { name:'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…', cat:'conc', dm:100, pct:2 },
      { name:'Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª ØµÙˆØ¯ÙŠÙˆÙ…', cat:'conc', dm:100, pct:4 },
    ]},
  ];
 if (tplSel) {
  TEMPLATES.forEach(t=>{
    const o=document.createElement('option');
    o.value=t.key; 
    o.textContent=t.name; 
    tplSel.appendChild(o);
  });
}

  const ROUGH_HINTS = ['Ø³ÙŠÙ„Ø§Ø¬','Ø¨Ø±Ø³ÙŠÙ…','Ø¯Ø±ÙŠØ³','Ù‚Ø´','ØªØ¨Ù†','pulp','hay','silage','straw','fresh','green'];
  function guessCat(name){ const s=(name||'').toLowerCase(); return ROUGH_HINTS.some(k=> s.includes(k) ) ? 'rough':'conc'; }

  function td(label, inner, col){ const td=document.createElement('td'); if(col) td.dataset.col = col; td.setAttribute('data-label', label); td.innerHTML=inner; return td; }
  function addRow(feed={}){
    const tr = document.createElement('tr');
    const catVal = feed?.cat || guessCat(feed?.name);
    tr.appendChild(td('Ø§Ù„Ø®Ø§Ù…Ø©', `<input class="name" value="${feed?.name||''}" list="feedlist" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø©" style="width:200px">`, 'name'));
    tr.appendChild(td('Ø§Ù„ÙØ¦Ø©', `<select class="cat">
  <option value="rough" ${catVal==='rough'?'selected':''}>Ø®Ø´Ù†</option>
  <option value="conc" ${catVal==='conc'?'selected':''}>Ù…Ø±ÙƒØ²</option>
  <option value="add" ${catVal==='add'?'selected':''}>Ø¥Ø¶Ø§ÙØ§Øª</option>
</select>`, 'cat'));
    tr.appendChild(td('% DM', `<input class="dm" type="number" inputmode="decimal" step="0.1" value="${feed?.dm ?? ''}" placeholder="%" style="width:100px">`, 'dm'));
    tr.appendChild(td('Ø³Ø¹Ø± Ø§Ù„Ø·Ù† (as-fed)', `<input class="pTon" type="number" inputmode="decimal" step="0.01" value="${feed?.price||''}" placeholder="Ø¬Ù†ÙŠÙ‡/Ø·Ù†" style="width:140px">`, 'pTon'));
    tr.appendChild(td('Ø³Ø¹Ø±/Ø·Ù† DM', `<span class="pTonDM">â€”</span>`, 'pTonDM'));
    tr.appendChild(td('Ù†Ø³Ø¨Ø© as-fed %', `<input class="pct" type="number" inputmode="decimal" step="0.01" value="${feed?.pct||''}" placeholder="%" style="width:100px">`, 'pct'));
    tr.appendChild(td('ÙƒØ¬Ù… as-fed/Ø±Ø£Ø³', `<input class="kg" type="number" inputmode="decimal" step="0.01" value="${feed?.kg||''}" placeholder="ÙƒØ¬Ù…" style="width:120px">`, 'kg'));
    tr.appendChild(td('ÙƒØ¬Ù… DM/Ø±Ø£Ø³', `<span class="kgDM">â€”</span>`, 'kgDM'));
    tr.appendChild(td('ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³/ÙŠÙˆÙ…', `<span class="cost">â€”</span>`, 'cost'));
tr.appendChild(td('Ø¥Ø²Ø§Ù„Ø©', `<button class="rm mini-btn" title="Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§Ù…Ø© Ù…Ù† Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø© ÙÙ‚Ø·" aria-label="Ø¥Ø²Ø§Ù„Ø© Ø®Ø§Ù…Ø© Ù…Ù† Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø©" type="button">Ø¥Ø²Ø§Ù„Ø©</button>`, 'rm'));
    tbody.appendChild(tr);
    hookRow(tr);
  }

  function nf(x){ return new Intl.NumberFormat('ar-EG',{maximumFractionDigits:2}).format(x||0); }

  function setRowState(tr){
    const mode = modeSel.value;
    const cat  = (tr.querySelector('.cat')?.value)||'conc';
    const kgEl  = tr.querySelector('.kg');
    const pctEl = tr.querySelector('.pct');
    if (mode!== 'split'){
      kgEl.disabled = (mode==='tmr_percent');
      pctEl.disabled= (mode==='tmr_asfed');
    } else {
      if (cat==='rough'){ kgEl.disabled=false; pctEl.disabled=true; }
      else { kgEl.disabled=true; pctEl.disabled=false; }
    }
    kgEl.style.opacity  = kgEl.disabled? .5 : 1;
    pctEl.style.opacity = pctEl.disabled? .5 : 1;
  }

  function isRowEmpty(tr){
    if (!tr) return true;
    const name = tr.querySelector('.name')?.value?.trim();
    const kg   = tr.querySelector('.kg')?.value;
    const pct  = tr.querySelector('.pct')?.value;
    return (!name && !kg && !pct);
  }
  function focusEditable(tr){
    const mode = modeSel.value;
    const cat  = (tr.querySelector('.cat')?.value)||'conc';
    const kgEl = tr.querySelector('.kg');
    const pctEl= tr.querySelector('.pct');
    setRowState(tr);
    setTimeout(()=>{
      if (mode==='tmr_asfed'){ kgEl?.focus(); kgEl?.select?.(); }
      else if (mode==='tmr_percent'){ pctEl?.focus(); pctEl?.select?.(); }
      else { if (cat==='rough'){ kgEl?.focus(); kgEl?.select?.(); } else { pctEl?.focus(); pctEl?.select?.(); } }
    }, 0);
  }
 function ensureEditableForMode(){
  const tr = tbody.querySelector('tr');
  if(!tr) return;   // ğŸ”¥ Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§

  if (modeSel.value==='split'){
    const catEl = tr.querySelector('.cat');
    if (catEl && catEl.value!=='rough' && isRowEmpty(tr)){
      catEl.value='rough';
    }
  }

  focusEditable(tr);
}

  function recalc(){
    const mode = modeSel.value;
    let totalDM=0, totalCost=0, mix=0, sumPct=0, mixAsFed=0, dmFrac=0;
    let roughDM=0, roughCost=0;
    let concMixAsFed=0, concDmFrac=0, concSumPct=0;
    const concKg = parseFloat(concKgInput.value)||0;

    tbody.querySelectorAll('tr').forEach(tr=>{
      const dm = parseFloat(tr.querySelector('.dm').value)||0;
      const p  = parseFloat(tr.querySelector('.pTon').value)||0;
      const kg = parseFloat(tr.querySelector('.kg').value)||0;
      const pc = parseFloat(tr.querySelector('.pct').value)||0;
      const cat= (tr.querySelector('.cat')?.value)||'conc';
      const pDM= dm>0? (p/(dm/100)) : 0;
      tr.querySelector('.pTonDM').textContent = pDM? nf(pDM):'â€”';

      if (mode==='tmr_asfed'){
        const kgDM = kg*(dm/100);
        const cost = (kgDM/1000)*pDM;
        tr.querySelector('.kgDM').textContent = kgDM? nf(kgDM):'â€”';
        tr.querySelector('.cost').textContent = cost? nf(cost):'â€”';
        totalDM+=kgDM; totalCost+=cost;
      } else if (mode==='tmr_percent'){
        tr.querySelector('.kgDM').textContent = 'â€”';
        tr.querySelector('.cost').textContent = 'â€”';
        if (pc>0){ mixAsFed+=(pc/100)*p; dmFrac+=(pc/100)*(dm/100); sumPct+=pc; }
      } else {
        if (cat==='rough'){
          const kgDM = kg*(dm/100);
          const cost = (kgDM/1000)*pDM;
          tr.querySelector('.kgDM').textContent = kgDM? nf(kgDM):'â€”';
          tr.querySelector('.cost').textContent = cost? nf(cost):'â€”';
          roughDM+=kgDM; roughCost+=cost;
        } else {
          tr.querySelector('.kgDM').textContent = 'â€”';
          tr.querySelector('.cost').textContent = 'â€”';
          if (pc>0){ concMixAsFed+=(pc/100)*p; concDmFrac+=(pc/100)*(dm/100); concSumPct+=pc; }
        }
      }
    });

    const pillMix = document.getElementById('pillMix');
    const pillSumPct = document.getElementById('pillSumPct');

    if (mode==='tmr_asfed'){
      if (totalDM>0){
        let mixDM=0; document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
          const dm=parseFloat(tr.querySelector('.dm').value)||0;
          const p=parseFloat(tr.querySelector('.pTon').value)||0;
          const kg=parseFloat(tr.querySelector('.kg').value)||0;
          const pDM= dm>0? (p/(dm/100)) : 0;
          const share=(kg*(dm/100))/totalDM; mixDM += share*pDM;
        });
        mix = mixDM;
      }
      pillMix.style.display=''; pillSumPct.style.display='none';
      document.getElementById('totDM').textContent = nf(totalDM);
      document.getElementById('totCost').textContent = nf(totalCost);
    } else if (mode==='tmr_percent'){
      mix = dmFrac>0? (mixAsFed/dmFrac) : 0;
      document.getElementById('sumPct').textContent = nf(sumPct)+'%';
      pillMix.style.display=''; pillSumPct.style.display='inline-flex';
      document.getElementById('totDM').textContent = 'â€”';
      document.getElementById('totCost').textContent = 'â€”';
    } else {
      const concPriceDM = concDmFrac>0? (concMixAsFed/concDmFrac) : 0;
      const concKgDM    = concKg * concDmFrac;
      const concCost    = (concKgDM/1000) * concPriceDM;
      const totalDMAll  = roughDM + concKgDM;
      const totalCostAll= roughCost + concCost;

      document.getElementById('roughDM').textContent = nf(roughDM);
      document.getElementById('roughCost').textContent = nf(roughCost);
      document.getElementById('sumPctConc').textContent = nf(concSumPct)+'%';
      document.getElementById('concDMpct').textContent = nf(concDmFrac*100)+'%';
      document.getElementById('concPriceDM').textContent = concPriceDM? nf(concPriceDM):'â€”';
      document.getElementById('concKgShow').textContent  = concKg? nf(concKg):'â€”';
      document.getElementById('concKgDM').textContent    = concKgDM? nf(concKgDM):'â€”';
      document.getElementById('concCost').textContent    = concCost? nf(concCost):'â€”';
      document.getElementById('totalCostAll').textContent= (totalCostAll||totalCostAll===0)? nf(totalCostAll):'â€”';

      document.getElementById('totDM').textContent = totalDMAll? nf(totalDMAll):'â€”';
      document.getElementById('totCost').textContent = totalCostAll? nf(totalCostAll):'â€”';

      pillMix.style.display='none'; pillSumPct.style.display='none';
    }

    document.getElementById('mixPriceDM').textContent = mix? nf(mix):'â€”';

    let w = '';
    if (mode==='tmr_percent' && (sumPct<99 || sumPct>101)) w = `âš ï¸ Ù…Ø¬Ù…ÙˆØ¹ Ù†Ø³Ø¨ as-fed = ${nf(sumPct)}% (Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ 100%)`;
    if (mode==='split' && (concSumPct && (concSumPct<99 || concSumPct>101))) w = `âš ï¸ Ù†Ø³Ø¨ Ø§Ù„Ù…Ø±ÙƒØ² = ${nf(concSumPct)}% (Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ 100%)`;
    const dmMissing = Array.from(tbody.querySelectorAll('tr')).some(tr=>{
      const dm = parseFloat(tr.querySelector('.dm').value);
      const hasVal = (parseFloat(tr.querySelector('.kg').value)||0) > 0 || (parseFloat(tr.querySelector('.pct').value)||0) > 0;
      return !dm && hasVal;
    });
    if (!w && dmMissing) w = 'âš ï¸ Ø£Ø¯Ø®Ù„ %DM Ù„ÙƒÙ„ Ø®Ø§Ù…Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨Ø¯Ù‚Ø©.';
    warn.textContent = w;
 updateFeedSummary();   
  }
  function hookRow(tr){
    const nameEl = tr.querySelector('.name');
    const dmEl   = tr.querySelector('.dm');
    const pEl    = tr.querySelector('.pTon');
    const kgEl   = tr.querySelector('.kg');
    const pctEl  = tr.querySelector('.pct');
    const catEl  = tr.querySelector('.cat');
    tr.querySelector('.rm').onclick = ()=>{ tr.remove(); recalc(); };

    nameEl.addEventListener('change', ()=>{
      const f = FEEDS.find(x=>x.name===nameEl.value.trim());
      if (f && !dmEl.value) dmEl.value = f.dm;
      setRowState(tr); recalc(); ensureEditableForMode();
    });
    [dmEl,pEl,kgEl,pctEl,catEl].forEach(el=> el.addEventListener('input', ()=>{ setRowState(tr); recalc(); }));
    setRowState(tr);
  }

  function addEmptyRow(){
    const mode = modeSel.value;
    const cat  = (mode==='split') ? 'rough' : 'conc';
    addRow({ cat });
  }

  // init
  ensureEditableForMode();
  recalc();
  // âœ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø®Ø§Ù…Ø§Øª Ù…Ù† Firestore
  loadSpeciesFromAnimals();
 loadFeedLibrary()
  .then(()=>{ 
    try{ filterFeeds(); }catch(e){} 
  })
  .catch(err=>{
    console.error(err);
    warn.textContent = 'âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø®Ø§Ù…Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.';
  });
  document.getElementById('applyTpl')?.addEventListener('click', ()=>{
    const key = document.getElementById('tpl')?.value || '';
    const tpl = TEMPLATES.find(t=> t.key===key); if(!tpl) return;
    modeSel.value = tpl.mode;
    if (tpl.mode==='split' && typeof tpl.concKg === 'number') concKgInput.value = tpl.concKg;
    document.querySelector('#tbl tbody').innerHTML='';
    (tpl.items||[]).forEach(it=>{
      const def = FEEDS.find(x=> x.name === it.name);
      const dm  = (it.dm ?? def?.dm ?? '');
      addRow({ name:it.name, dm, cat:it.cat || (def?guessCat(def.name):'conc'), kg:it.kg, pct:it.pct });
    });
    updateModeUI(); recalc();
  });

document.getElementById('addPreset')?.addEventListener('click', ()=>{
  // Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø®Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
  addEmptyRow();
  showFeedUI();
  recalc();
});
  document.getElementById('clearAll')?.addEventListener('click', ()=>{
   if(confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙØŸ')){
  tbody.innerHTML='';
  recalc();
  document.getElementById('feedInputBox').style.display='none';
  document.getElementById('feedSummaryBox').style.display='none';
  document.getElementById('miniActions').style.display='none';
}
  
  });

  function updateModeUI(){
    const mode = modeSel.value;
    splitBox.style.display = (mode==='split')? '' : 'none';
    const showCols = new Set(
      mode==='tmr_asfed'  ? ['name','cat','dm','pTon','pTonDM','kg','kgDM','cost','rm'] :
      mode==='tmr_percent'? ['name','cat','dm','pTon','pTonDM','pct','rm'] :
                            ['name','cat','dm','pTon','pTonDM','pct','kg','kgDM','cost','rm']
    );
    document.querySelectorAll('th').forEach(th=>{ const c=th.dataset.col; if(!c)return; th.style.display = showCols.has(c)? '':'none'; });
    document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
      tr.querySelectorAll('td').forEach(td=>{ const c=td.dataset.col; if(!c)return; td.style.display = showCols.has(c)? '':'none'; });
      setRowState(tr);
    });
    document.getElementById('totalsBase').style.display  = (mode!=='split')? '' : 'none';
    document.getElementById('totalsSplit').style.display = (mode==='split')? '' : 'none';
    recalc();
  }

  modeSel.addEventListener('change', updateModeUI);
  modeSel.addEventListener('change', ensureEditableForMode);
  concKgInput.addEventListener('input', recalc);

  function getGestLen(){ return (ctxSpecies?.value==='Ø¬Ø§Ù…ÙˆØ³' ? 310 : 280); }
  function applyDCCRules(){
    const dcc = parseInt(ctxDCC?.value);
    const GL = getGestLen();
    if (!isNaN(dcc)){
      const dtc = GL - dcc;
      if (dtcVal) dtcVal.textContent = isFinite(dtc)? String(dtc) : 'â€”';
      ctxEarlyDry.checked = (dcc >= (GL - 60));
      ctxCloseUp.checked  = (dcc >= (GL - 21));
    } else {
      if (dtcVal) dtcVal.textContent = 'â€”';
    }
  }
  ctxDCC?.addEventListener('input', applyDCCRules);
  ctxSpecies?.addEventListener('change', applyDCCRules);
  applyDCCRules();

  updateModeUI();
 const feedTypeFilter = document.getElementById('feedTypeFilter');

function classifyFeed3(f){
  const n = (f.name || '').toLowerCase();

  // Ø¥Ø¶Ø§ÙØ§Øª
  if(n.includes('ÙÙŠØªØ§Ù…ÙŠÙ†') || n.includes('Ù…Ø§ØºÙ†Ø³ÙŠÙˆÙ…') || n.includes('Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª') || n.includes('Ù…Ù„Ø­') || n.includes('ÙŠÙˆØ±ÙŠØ§') || n.includes('Ø¯Ù‡ÙˆÙ†')) return 'add';

  // Ø®Ø´Ù†
  if(n.includes('Ø³ÙŠÙ„Ø§Ø¬') || n.includes('Ø¨Ø±Ø³ÙŠÙ…') || n.includes('Ø¯Ø±ÙŠØ³') || n.includes('Ù‚Ø´') || n.includes('ØªØ¨Ù†')) return 'rough';

  // Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù…Ø±ÙƒØ²Ø§Øª (Ø­Ø¨ÙˆØ¨/Ø¨Ø±ÙˆØªÙŠÙ†/Ù…Ø®Ù„ÙØ§Øªâ€¦)
  return 'conc';
}

function filterFeeds(){
  const type = feedTypeFilter.value || 'all';

  const filtered = FEEDS.filter(f=>{
    if(type === 'all') return true;
    return classifyFeed3(f) === type;
  });

  presetSel.innerHTML = '<option value="" selected disabled>Ø§Ø®ØªØ± Ø®Ø§Ù…Ø©</option>';
  filtered.forEach(f=>{
    const o = document.createElement('option');
    o.value = f.id;
    o.textContent = f.name;
    presetSel.appendChild(o);
  });
}

feedTypeFilter.addEventListener('change', filterFeeds); 
// âœ… Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø®Ø§Ù…Ø©: Ø§ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙˆØ±Ù‹Ø§
presetSel.addEventListener('change', ()=>{
  // 1) Ù„Ø§Ø²Ù… ÙŠØ®ØªØ§Ø± Ù†ÙˆØ¹ Ø®Ø§Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹
  const selectedType = (feedTypeFilter.value || '').trim();
  if(!selectedType || selectedType === 'all'){
    alert("Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ù‡ Ø£ÙˆÙ„Ø§Ù‹ (Ù…Ø±ÙƒØ²Ø§Øª/Ø®Ø´Ù†/Ø¥Ø¶Ø§ÙØ§Øª)");
    presetSel.value = '';
    return;
  }

  // 2) Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø©
  const id = (presetSel.value || '').trim();
  if(!id) return;

  const f = FEEDS_BY_ID.get(id);
  if(!f) return;

  // 3) Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø¨Ø§Ù„Ø®Ø§Ù…Ø© + ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  addRow({
    name: f.name,          // âœ… Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø©
    dm: (f.dm ?? ''),
    cat: selectedType      // âœ… Ù†ÙˆØ¹Ù‡Ø§ Ù…Ù† Ø§Ù„ÙÙ„ØªØ±
  });

  showFeedUI();
  recalc();

  // ÙŠØ±Ø¬Ù‘Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø¶ÙŠØ© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø®Ø§Ù…Ø© Ø£Ø®Ø±Ù‰
  presetSel.value = '';
});
</script>

<!-- Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ + Ø§Ù„Ø°ÙƒØ§Ø¡ (Ù„Ø§ ØªÙ„Ù…Ø³ ØªØ±ØªÙŠØ¨Ù‡Ø§) -->
<script src="/js/app-core.js" defer></script>
<script type="module" src="/js/timeline.js"></script>
<script type="module" src="/js/smart-checks.js"></script>
<!-- Ø§Ù„ÙƒÙˆØ± + ØªØªØ¨Ù‘Ø¹ + Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸ (Ù„Ø§ ØªØºÙŠÙ‘Ø± ÙˆØ§Ø¬Ù‡ØªÙƒ) -->
<script type="module" src="/js/event-core.js"></script>
<script type="module" src="/js/track-core.js"></script>
<script type="module" src="/js/track-nutrition.js"></script>
<script type="module" src="/js/nutrition.js"></script>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const fmt = (v, suf="")=>{
    if(v==null) return "â€”";
    const s=String(v).trim();
    if(!s || s==="â€”") return "â€”";
    return s + suf;
  };
  const num = (id)=>{
    const el=$(id);
    if(!el) return null;
    const t=String(el.textContent||"").replace(/[^\d.\-]/g,"");
    const n=parseFloat(t);
    return isFinite(n)?n:null;
  };

  function showIfHasData(){
    const tot = num("totDM") || 0;
    const sec = $("analysisSection");
    if(!sec) return;
    sec.style.display = tot>0 ? "block" : "none";
  }

  function render(){
    // ===== ØºØ°Ø§Ø¦ÙŠ =====
    const n = $("nutritionKPIs");
    if(n){
      const items = [
        ["DMI / Ø¥Ø¬Ù…Ø§Ù„ÙŠ DM", fmt($("totDM")?.textContent, " ÙƒØ¬Ù…/Ø±Ø£Ø³/ÙŠÙˆÙ…")],
        ["Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‘ÙØ³Ø¨", fmt($("sumPct")?.textContent, "")],
        ["Ø®Ø´Ù† DM", fmt($("roughDM")?.textContent, " ÙƒØ¬Ù…")],
        ["Ù…Ø±ÙƒØ² DM", fmt($("concKgDM")?.textContent, " ÙƒØ¬Ù…")],
        ["%DM Ù„Ù„Ù…Ø±ÙƒØ²", fmt($("concDMpct")?.textContent, "")],
        ["F:C", fmt($("fcRatio")?.textContent, "")],
      ];
      n.innerHTML = items.map(([k,v])=>(
        '<div class="kpi"><div class="k">'+k+'</div><div class="v">'+v+'</div></div>'
      )).join("");
    }

    // ===== Ø§Ù‚ØªØµØ§Ø¯ÙŠ =====
    const e = $("economicKPIs");
    if(e){
      const items = [
        ["Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„ÙŠÙ‚Ø©", fmt($("totCost")?.textContent, "")],
        ["Ø®Ø´Ù† â€” ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³", fmt($("roughCost")?.textContent, "")],
        ["Ù…Ø±ÙƒØ² â€” ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³", fmt($("concCost")?.textContent, "")],
        ["Ø³Ø¹Ø± Ø·Ù† TMR (DM)", fmt($("mixPriceDM")?.textContent, "")],
        ["Ø³Ø¹Ø± Ø·Ù† Ù…Ø±ÙƒØ² (DM)", fmt($("concPriceDM")?.textContent, "")],
        ["Ø¥Ø¬Ù…Ø§Ù„ÙŠ as-fed", fmt($("totalAsFed")?.textContent, " ÙƒØ¬Ù…")],
      ];
      e.innerHTML = items.map(([k,v])=>(
        '<div class="kpi"><div class="k">'+k+'</div><div class="v">'+v+'</div></div>'
      )).join("");
    }

    showIfHasData();
  }

  // Toggle advanced
  document.addEventListener("click",(ev)=>{
    const btn = ev.target && ev.target.id==="toggleAdvancedBtn" ? ev.target : null;
    if(!btn) return;
    const adv = $("advancedKPIs");
    if(!adv) return;
    adv.style.display = (adv.style.display==="none"||!adv.style.display) ? "grid" : "none";
    if(adv.innerHTML.trim()) return;
    // fill once
    const items = [
      ["NEL", fmt($("nelTotal")?.textContent, "")],
      ["MP", fmt($("mpTotal")?.textContent, "")],
      ["CP%", fmt($("cpPct")?.textContent, "")],
      ["NDF%", fmt($("ndfPct")?.textContent, "")],
      ["Fat%", fmt($("fatPct")?.textContent, "")],
      ["Starch%", fmt($("starchPct")?.textContent, "")],
    ];
    adv.innerHTML = items.map(([k,v])=>(
      '<div class="kpi"><div class="k">'+k+'</div><div class="v">'+v+'</div></div>'
    )).join("");
  });

  // Re-render periodically (live)
  setInterval(render, 600);
  render();
})();
</script>

</body>
</html>
