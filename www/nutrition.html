<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªØ³Ø¬ÙŠÙ„ ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„ØªØºØ°ÙŠØ©</title>
  <style>
    :root{--bg:#fff9db;--card:#f1f8e9;--border:#c5e1a5;--green:#2e7d32;--muted:#5f6f64}
    *{box-sizing:border-box}
    body{direction:rtl;background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;color:#1b5e20;padding:12px}
    h1{margin:0 0 8px;text-align:center;color:var(--green);font-size:22px}
    .wrap{max-width:1080px;margin:0 auto}
    .info{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:8px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#dcedc8;color:#1b5e20;font-size:13px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row>.grow{flex:1}
    select,input,button{font-size:14px}
    input,select{padding:10px;border:1px solid #ccc;border-radius:10px}
    input,select,button{min-height:44px}
    button{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:bold;cursor:pointer}
    .btn{background:#fff;border:1px solid var(--green);color:var(--green)}
    .btn-primary{background:var(--green);color:#fff}

    .warning{color:#c62828;text-align:center;min-height:22px;margin-top:6px}

    .table-wrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:collapse;margin-top:10px;min-width:1020px}
    th,td{border:1px solid #e0ebd3;padding:8px;text-align:center}
    th{background:#eafbe7;color:#1b5e20}
    tbody tr:nth-child(odd){background:#fcfff5}

    .total{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
    .total .pill{background:#fff}

    /* Mobile cards */
    @media (max-width: 640px){
      .row.stack > *{flex:1 1 100%}
      table, thead, tbody, th, td, tr{display:block;min-width:unset}
      thead{display:none}
      tbody tr{margin:0 0 12px 0;border:1px solid #e0ebd3;border-radius:12px;background:#fff}
      tbody tr > td{display:flex;justify-content:space-between;align-items:center;border:0;border-bottom:1px solid #eef3e4;padding:10px 12px}
      tbody tr > td:last-child{border-bottom:0}
      td::before{content:attr(data-label);font-weight:bold;color:#2e7d32;flex:0 0 48%}
      td > input, td > select{width:48%}
    }
  </style>
</head>
<body>
<!-- ØªØªØ¨Ø¹ Ù…Ø¨ÙƒØ± ÙˆÙÙ‚ â€œØ§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø°ÙƒÙŠâ€ -->
<script>window.dataLayer=window.dataLayer||[];window.dataLayer.push({event:'page_view',page:'nutrition'});window.t=window.t||{event:(p)=>window.dataLayer.push(p)};</script>

<div class="wrap">
  <h1>ğŸ“„ ØªØ³Ø¬ÙŠÙ„ ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„ØªØºØ°ÙŠØ©</h1>

  <div class="info">
    <span class="pill">ğŸ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†/Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: <b id="animalInfo">â€”</b></span>
    <span class="pill">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: <b id="dateInfo">â€”</b></span>
  </div>
  <div class="info">
    <span class="pill">ğŸ•’ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨: <input id="ctxDIM" type="number" inputmode="numeric" step="1" min="0" style="width:90px"></span>
    <span class="pill">ğŸƒ Ø§Ù„Ù†ÙˆØ¹:
      <select id="ctxSpecies"><option value="">â€”</option><option value="Ø¨Ù‚Ø±">Ø¨Ù‚Ø±</option><option value="Ø¬Ø§Ù…ÙˆØ³">Ø¬Ø§Ù…ÙˆØ³</option></select>
    </span>
    <span class="pill">ğŸ¥› Ù…ØªÙˆØ³Ø· Ø¥Ù†ØªØ§Ø¬/Ø±Ø£Ø³: <input id="ctxAvgMilk" type="number" inputmode="decimal" step="0.1" style="width:90px"></span>
    <span class="pill">ğŸ§­ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù…Ù„ (DCC): <input id="ctxDCC" type="number" inputmode="numeric" step="1" min="0" style="width:90px"></span>
    <span class="pill">ğŸ¼ Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ÙˆÙ„Ø§Ø¯Ø© (ÙŠÙˆÙ…): <b id="dtcVal">â€”</b></span>
    <span class="pill"><label><input id="ctxEarlyDry" type="checkbox"> Ø¬Ø§Ù Ù…Ø¨ÙƒÙ‘Ø±</label></span>
    <span class="pill"><label><input id="ctxCloseUp" type="checkbox"> ØªØ­Ø¶ÙŠØ± ÙˆÙ„Ø§Ø¯Ø©</label></span>
    <span class="pill">ğŸ¤° Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„:
      <select id="ctxPreg"><option value="">â€”</option><option value="Ø¹Ø´Ø§Ø±">Ø¹Ø´Ø§Ø±</option><option value="ÙØ§Ø±ØºØ©">ÙØ§Ø±ØºØ©</option></select>
    </span>
  </div>
  <div class="warning" id="warn"></div>

  <div class="card">
    <div class="row stack">
      <div class="grow">
        <label class="muted">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</label>
        <select id="mode" style="width:100%">
          <option value="tmr_asfed" selected>Ø®Ù„Ø·Ø© ÙƒØ§Ù…Ù„Ø© TMR â€” asâ€‘fed/Ø±Ø£Ø³</option>
          <option value="tmr_percent">Ø®Ù„Ø·Ø© ÙƒØ§Ù…Ù„Ø© TMR â€” Ù†Ø³Ø¨ asâ€‘fed Ù„Ù„Ø·Ù†</option>
          <option value="split">Ù…Ø±ÙƒØ²Ø§Øª ÙˆØ®Ø´Ù† â€” Ù…Ù†ÙØµÙ„</option>
        </select>
      </div>
      <div class="grow">
        <label class="muted">Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ù…Ø© Ø¬Ø§Ù‡Ø²Ø©</label>
        <select id="preset" style="width:100%">
          <option value="">â€” Ø§Ø®ØªØ± â€”</option>
        </select>
      </div>
      <div class="grow">
        <label class="muted">Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</label>
        <input id="feedSearch" list="feedlist" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø®Ø§Ù…Ø©" style="width:100%">
      </div>
      <div class="grow">
        <label class="muted">Ù†Ù…ÙˆØ°Ø¬ ØªØ±ÙƒÙŠØ¨Ø©</label>
        <select id="tpl" style="width:100%">
          <option value="">â€” Ø§Ø®ØªØ± Ù†Ù…ÙˆØ°Ø¬ â€”</option>
        </select>
      </div>
      <button id="applyTpl" class="btn">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
      <button id="addPreset" class="btn">Ø¥Ø¶Ø§ÙØ©</button>
      <button id="addBySearch" class="btn">Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù„Ø¨Ø­Ø«</button>
      <button id="clearAll" class="btn">Ù…Ø³Ø­</button>
    </div>

    <div id="splitBox" class="row stack" style="margin-top:8px;display:none">
      <div class="grow">
        <label class="muted">ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ² asâ€‘fed ÙƒØ¬Ù…/Ø±Ø£Ø³/ÙŠÙˆÙ…</label>
        <input id="concKgInput" type="number" inputmode="decimal" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 6.0" style="width:160px">
      </div>
      <div class="grow">
        <label class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <div class="pill">ØµÙÙˆÙ Ø§Ù„ÙØ¦Ø© = Ø®Ø´Ù† ØªÙÙƒØªØ¨ Ø¨Ø§Ù„ÙƒØ¬Ù…/Ø±Ø£Ø³. ØµÙÙˆÙ Ø§Ù„ÙØ¦Ø© = Ù…Ø±ÙƒØ² ØªÙÙƒØªØ¨ Ù†Ø³Ø¨ asâ€‘fed Ù„Ù„Ø·Ù†.</div>
      </div>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th data-col="name">Ø§Ù„Ø®Ø§Ù…Ø©</th>
            <th data-col="cat">Ø§Ù„ÙØ¦Ø©</th>
            <th data-col="dm">% DM</th>
            <th data-col="pTon">Ø³Ø¹Ø± Ø§Ù„Ø·Ù† (asâ€‘fed)</th>
            <th data-col="pTonDM">Ø³Ø¹Ø±/Ø·Ù† DM</th>
            <th data-col="pct">Ù†Ø³Ø¨Ø© asâ€‘fed %</th>
            <th data-col="kg">ÙƒØ¬Ù… asâ€‘fed/Ø±Ø£Ø³</th>
            <th data-col="kgDM">ÙƒØ¬Ù… DM/Ø±Ø£Ø³</th>
            <th data-col="cost">ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³/ÙŠÙˆÙ…</th>
            <th data-col="rm">Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="total" id="totalsBase">
      <span class="pill" id="pillSumPct" style="display:none">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‘ÙØ³Ø¨: <b id="sumPct">0%</b></span>
      <span class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒØ¬Ù… DM/Ø±Ø£Ø³: <b id="totDM">0</b></span>
      <span class="pill">ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³/ÙŠÙˆÙ…: <b id="totCost">0</b></span>
      <span class="pill" id="pillMix">Ø³Ø¹Ø± Ø·Ù† TMR (DM): <b id="mixPriceDM">â€”</b></span>
    </div>

    <div class="total" id="totalsSplit" style="display:none">
      <span class="pill">Ø®Ø´Ù† â€” ÙƒØ¬Ù… DM/Ø±Ø£Ø³: <b id="roughDM">â€”</b></span>
      <span class="pill">Ø®Ø´Ù† â€” ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³: <b id="roughCost">â€”</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‘ÙØ³Ø¨: <b id="sumPctConc">â€”%</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” %DM Ù„Ù„Ø®Ù„Ø·Ø©: <b id="concDMpct">â€”%</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” Ø³Ø¹Ø± Ø·Ù† (DM): <b id="concPriceDM">â€”</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” asâ€‘fed/Ø±Ø£Ø³: <b id="concKgShow">â€”</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” ÙƒØ¬Ù… DM/Ø±Ø£Ø³: <b id="concKgDM">â€”</b></span>
      <span class="pill">Ù…Ø±ÙƒØ² â€” ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³: <b id="concCost">â€”</b></span>
      <span class="pill">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ â€” ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³: <b id="totalCostAll">â€”</b></span>
    </div>
  </div>

  <div class="card">
    <div class="row stack">
      <div class="grow">
        <button id="saveEvent" class="btn-primary" style="width:100%">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø© ÙƒØ­Ø¯Ø« ØªØºØ°ÙŠØ©</button>
      </div>
    </div>
    <div id="inlineMsg" class="notice" role="status" aria-live="polite" style="display:none;margin-top:10px">
      <div class="text" style="font-weight:bold"></div>
      <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button type="button" class="btn btn-primary" id="msgYes" style="flex:1">ØªØ³Ø¬ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« Ø£Ø®Ø±Ù‰</button>
        <button type="button" class="btn" id="msgNo" style="flex:1">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      </div>
    </div>
  </div>

</div>

<script type="module">
  // ØªØ­Ù…ÙŠÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ÙŠØ¶Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„ØµÙØ­Ø© Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase (Ù„Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ù„ØªØµÙ…ÙŠÙ…)
  let db=null, auth=null,
      addDoc, collection, serverTimestamp, getDocs, getDoc, doc, query, where, orderBy, limit,
      onAuthStateChanged;
  try{
    ({ db, auth } = await import('./js/firebase-config.js'));
    ({ addDoc, collection, serverTimestamp, getDocs, getDoc, doc, query, where, orderBy, limit } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'));
    ({ onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js'));
  }catch(e){ console.warn('Firebase modules not loaded; running offline mode', e); }


  const warn = document.getElementById('warn');
  const modeSel = document.getElementById('mode');
  const modeInfo= document.getElementById('modeInfo'); // Ù‚Ø¯ Ù„Ø§ ÙŠÙˆØ¬Ø¯
  // Ø¹Ù†Ø§ØµØ± Ø³ÙŠØ§Ù‚ Ø§Ù„Ù‚Ø·ÙŠØ¹
  const ctxDIM = document.getElementById('ctxDIM');
  const ctxSpecies = document.getElementById('ctxSpecies');
  const ctxAvgMilk = document.getElementById('ctxAvgMilk');
  const ctxDCC = document.getElementById('ctxDCC');
  const dtcVal = document.getElementById('dtcVal');
  const ctxEarlyDry = document.getElementById('ctxEarlyDry');
  const ctxCloseUp = document.getElementById('ctxCloseUp');
  const ctxPreg = document.getElementById('ctxPreg');

  const presetSel = document.getElementById('preset');
  const addPresetBtn = document.getElementById('addPreset');
  const clearBtn = document.getElementById('clearAll');
  const feedSearch = document.getElementById('feedSearch');
  const addBySearchBtn = document.getElementById('addBySearch');
  const tplSel = document.getElementById('tpl');
  const applyTplBtn = document.getElementById('applyTpl');
  const tbody = document.querySelector('#tbl tbody');
  const splitBox = document.getElementById('splitBox');
  const concKgInput = document.getElementById('concKgInput');
  const inlineMsg = document.getElementById('inlineMsg');
  const msgText = inlineMsg.querySelector('.text');
  const btnYes = inlineMsg.querySelector('#msgYes');
  const btnNo  = inlineMsg.querySelector('#msgNo');

  function showNotice(message){
    msgText.textContent = message;
    inlineMsg.style.display = 'block';
    return new Promise(resolve=>{
      const onYes = ()=>{ cleanup(); resolve(true); };
      const onNo  = ()=>{ cleanup(); resolve(false);};
      btnYes.addEventListener('click', onYes, { once:true });
      btnNo .addEventListener('click', onNo , { once:true });
      function cleanup(){ inlineMsg.style.display='none'; }
    });
  }

  function todayLocal(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }

  const qp = new URLSearchParams(location.search);
  const animalId = qp.get('animalId') || qp.get('number') || qp.get('animalNumber') || localStorage.getItem('lastAnimalId') || '';
  const groupName = qp.get('group') || '';
  const eventDate= qp.get('date') || todayLocal();
  // ØªØ¹Ø¨Ø¦Ø© Ø³ÙŠØ§Ù‚ Ø§Ù„Ù‚Ø·ÙŠØ¹ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù† ÙˆÙØ¬Ø¯
  ctxDIM.value      = qp.get('dim') || '';
  ctxSpecies.value  = qp.get('species') || '';
  ctxAvgMilk.value  = qp.get('avgMilk') || '';
  ctxDCC.value      = qp.get('dcc') || '';
  ctxPreg.value     = qp.get('preg') || qp.get('pregnancy') || '';
  if ((qp.get('earlyDry')||'') === '1') ctxEarlyDry.checked = true;
  if ((qp.get('closeUp') ||'') === '1') ctxCloseUp.checked  = true;

  document.getElementById('animalInfo').textContent = (groupName || animalId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
  try{ document.getElementById('dateInfo').textContent = new Date(eventDate).toLocaleDateString('ar-EG'); }catch{ document.getElementById('dateInfo').textContent = eventDate; }

  // ===== Ù„Ø³ØªØ© Ø§Ù„Ø®Ø§Ù…Ø§Øª (Ø¹Ø§Ù…ÙŠØ© Ù…Ø±Ø¨ÙŠÙƒ) =====
  const FEEDS = [
    { name:'Ø°Ø±Ø© ØµÙØ±Ø§Ø¡ Ù…Ø¬Ø±ÙˆØ´Ø©', dm:88 }, { name:'Ø´Ø¹ÙŠØ±', dm:88 },
    { name:'Ù‚Ù…Ø­ Ù…Ø·Ø­ÙˆÙ†', dm:88 }, { name:'Ø±Ø¯Ø© Ù‚Ù…Ø­ (Ù†Ø®Ø§Ù„Ø©)', dm:89 },
    { name:'Ø±Ø¯Ø© Ø£Ø±Ø²', dm:90 }, { name:'Ø°Ø±Ø© Ø±ÙÙŠØ¹Ø© (Ø³ÙˆØ±Ø¬Ù…)', dm:88 },
    { name:'Ø´ÙˆÙØ§Ù†', dm:90 }, { name:'ÙÙˆÙ„ Ø¨Ù„Ø¯ÙŠ (ÙØ§Ø¨Ø§)', dm:88 },
    { name:'Ø¨Ø§Ø²Ù„Ø§Ø¡ Ø¹Ù„ÙÙŠØ©', dm:88 },

    { name:'DDGS (Ø°Ø±Ø©)', dm:90 }, { name:'Ø¬Ù„ÙˆØªÙŠÙ† ÙÙŠØ¯ (CGF)', dm:90 },
    { name:'Ø¬Ù„ÙˆØªÙŠÙ† Ù…ÙŠÙ„ (CGM)', dm:90 }, { name:'Ù‚Ø´ÙˆØ± ÙÙˆÙ„ ØµÙˆÙŠØ§ (Soy Hulls)', dm:90 },
    { name:'Ù„Ø¨ Ø¨Ù†Ø¬Ø± Ù…Ø¬ÙÙ', dm:90 }, { name:'Ù„Ø¨ Ø¨Ù†Ø¬Ø± Ù…Ø¨Ù„Ù„', dm:25 },
    { name:'Ù„Ø¨ Ø­Ù…Ø¶ÙŠØ§Øª Ù…Ø¬ÙÙ', dm:90 }, { name:'Ù…ÙˆÙ„Ø§Ø³', dm:75 },

    { name:'ÙƒØ³Ø¨ ÙÙˆÙ„ ØµÙˆÙŠØ§ 44%', dm:89 }, { name:'ÙƒØ³Ø¨ ÙÙˆÙ„ ØµÙˆÙŠØ§ 48%', dm:89 },
    { name:'ÙƒØ³Ø¨ Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø´Ù…Ø³', dm:89 }, { name:'ÙƒØ³Ø¨ ÙƒØ§Ù†ÙˆÙ„Ø§', dm:90 },
    { name:'ÙƒØ³Ø¨ Ù‚Ø·Ù†', dm:92 }, { name:'ÙƒØ³Ø¨ Ù†Ø®ÙŠÙ„', dm:90 },
    { name:'ÙƒØ³Ø¨ ÙÙˆÙ„ Ø³ÙˆØ¯Ø§Ù†ÙŠ', dm:90 }, { name:'ÙƒØ³Ø¨ Ø³Ù…Ø³Ù…', dm:90 },
    { name:'ÙƒØ³Ø¨ ÙƒØªØ§Ù†', dm:90 },

    { name:'Ø¨Ø°Ø±Ø© Ù‚Ø·Ù† ÙƒØ§Ù…Ù„Ø©', dm:92 }, { name:'Ù‚Ø´ÙˆØ± Ø¨Ø°Ø±Ø© Ù‚Ø·Ù† (Hulls)', dm:90 },

    { name:'Ø³ÙŠÙ„Ø§Ø¬ Ø°Ø±Ø©', dm:33 }, { name:'Ø³ÙŠÙ„Ø§Ø¬ Ø³ÙˆØ±Ø¬Ù…', dm:30 },
    { name:'Ø¨Ø±Ø³ÙŠÙ… Ø£Ø®Ø¶Ø±', dm:18 }, { name:'Ø¯Ø±ÙŠØ³ Ø¨Ø±Ø³ÙŠÙ…', dm:90 },
    { name:'Ø¯Ø±ÙŠØ³ Ø­Ø´ÙŠØ´Ø©/Ù†Ø¬ÙŠÙ„', dm:90 }, { name:'ØªØ¨Ù† Ù‚Ù…Ø­', dm:90 },
    { name:'Ù‚Ø´ Ø£Ø±Ø²', dm:90 },

    { name:'Ø¯Ù‡ÙˆÙ† Ù…Ø­Ù…ÙŠØ©', dm:99 }, { name:'Ø²ÙŠØª Ù†Ø¨Ø§ØªÙŠ Ø¹Ù„ÙÙŠ', dm:99 },
    { name:'ÙŠÙˆØ±ÙŠØ§ Ø¹Ù„ÙÙŠØ©', dm:100 }, { name:'Ø­Ø¬Ø± Ø¬ÙŠØ±ÙŠ (ÙƒØ§Ù„Ø³ÙŠÙˆÙ…)', dm:100 },
    { name:'ÙÙˆØ³ÙØ§Øª Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ… (DCP)', dm:100 }, { name:'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…', dm:100 },
    { name:'Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª ØµÙˆØ¯ÙŠÙˆÙ…', dm:100 }, { name:'Ø£ÙƒØ³ÙŠØ¯ Ù…Ø§ØºÙ†Ø³ÙŠÙˆÙ…', dm:100 },
    { name:'Ø¨Ù†ØªÙˆÙ†ÙŠØª', dm:100 }, { name:'Ø®Ù…ÙŠØ±Ø© Ø­ÙŠØ©/Ù…Ø³ØªÙ†Ø¨Øª Ø®Ù…Ø§Ø¦Ø±ÙŠ', dm:95 },
    { name:'Ù…Ø®Ù„ÙˆØ· Ù…Ø¹Ø§Ø¯Ù†/ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª', dm:95 },
  ];

  // ==== Ù‚ÙˆØ§Ù„Ø¨ Ø¹Ù„Ø§Ø¦Ù‚ Ø¬Ø§Ù‡Ø²Ø© (Templates) ====
  const TEMPLATES = [
    {
      key: 'tmr_asfed_high_cow',
      name: 'TMR as-fed â€” Ø­Ù„Ø§Ø¨Ø© Ù…Ø±ØªÙØ¹Ø© (Ø¨Ù‚Ø±)',
      mode: 'tmr_asfed',
      items: [
        { name:'Ø³ÙŠÙ„Ø§Ø¬ Ø°Ø±Ø©', cat:'rough', dm:33, kg:22 },
        { name:'Ø¯Ø±ÙŠØ³ Ø¨Ø±Ø³ÙŠÙ…', cat:'rough', dm:90, kg:1.5 },
        { name:'Ø°Ø±Ø© ØµÙØ±Ø§Ø¡ Ù…Ø¬Ø±ÙˆØ´Ø©', cat:'conc', dm:88, kg:6 },
        { name:'ÙƒØ³Ø¨ ÙÙˆÙ„ ØµÙˆÙŠØ§ 48%', cat:'conc', dm:89, kg:2.5 },
        { name:'Ù…ÙˆÙ„Ø§Ø³', cat:'conc', dm:75, kg:0.5 },
        { name:'Ù…Ø®Ù„ÙˆØ· Ù…Ø¹Ø§Ø¯Ù†/ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª', cat:'conc', dm:95, kg:0.15 },
        { name:'Ø­Ø¬Ø± Ø¬ÙŠØ±ÙŠ (ÙƒØ§Ù„Ø³ÙŠÙˆÙ…)', cat:'conc', dm:100, kg:0.10 },
        { name:'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…', cat:'conc', dm:100, kg:0.05 },
        { name:'Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª ØµÙˆØ¯ÙŠÙˆÙ…', cat:'conc', dm:100, kg:0.10 },
        { name:'Ø¯Ù‡ÙˆÙ† Ù…Ø­Ù…ÙŠØ©', cat:'conc', dm:99, kg:0.30 },
      ]
    },
    {
      key: 'tmr_percent_mid_cow',
      name: 'TMR Ù†Ø³Ø¨ as-fed â€” Ø­Ù„Ø§Ø¨Ø© Ù…ØªÙˆØ³Ø·Ø© (Ø¨Ù‚Ø±)',
      mode: 'tmr_percent',
      items: [
        { name:'Ø³ÙŠÙ„Ø§Ø¬ Ø°Ø±Ø©', cat:'rough', dm:33, pct:40 },
        { name:'Ø¯Ø±ÙŠØ³ Ø¨Ø±Ø³ÙŠÙ…', cat:'rough', dm:90, pct:5 },
        { name:'Ø°Ø±Ø© ØµÙØ±Ø§Ø¡ Ù…Ø¬Ø±ÙˆØ´Ø©', cat:'conc', dm:88, pct:23 },
        { name:'Ø±Ø¯Ø© Ù‚Ù…Ø­ (Ù†Ø®Ø§Ù„Ø©)', cat:'conc', dm:89, pct:10 },
        { name:'ÙƒØ³Ø¨ ÙÙˆÙ„ ØµÙˆÙŠØ§ 48%', cat:'conc', dm:89, pct:12 },
        { name:'Ù…ÙˆÙ„Ø§Ø³', cat:'conc', dm:75, pct:3 },
        { name:'Ù…Ø®Ù„ÙˆØ· Ù…Ø¹Ø§Ø¯Ù†/ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª', cat:'conc', dm:95, pct:2 },
        { name:'Ø­Ø¬Ø± Ø¬ÙŠØ±ÙŠ (ÙƒØ§Ù„Ø³ÙŠÙˆÙ…)', cat:'conc', dm:100, pct:2 },
        { name:'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…', cat:'conc', dm:100, pct:1 },
        { name:'Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª ØµÙˆØ¯ÙŠÙˆÙ…', cat:'conc', dm:100, pct:2 },
      ]
    },
    {
      key: 'split_conc6',
      name: 'Ù…Ù†ÙØµÙ„ â€” Ù…Ø±ÙƒØ² 6 ÙƒØ¬Ù… + Ø®Ø´Ù† as-fed',
      mode: 'split', concKg: 6,
      items: [
        // Ø®Ø´Ù† Ø¨Ø§Ù„ÙƒØ¬Ù…/Ø±Ø£Ø³
        { name:'Ø³ÙŠÙ„Ø§Ø¬ Ø°Ø±Ø©', cat:'rough', dm:33, kg:20 },
        { name:'Ø¯Ø±ÙŠØ³ Ø¨Ø±Ø³ÙŠÙ…', cat:'rough', dm:90, kg:1 },
        // Ù…Ø±ÙƒØ² Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© as-fed (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ â‰ˆ 100%)
        { name:'Ø°Ø±Ø© ØµÙØ±Ø§Ø¡ Ù…Ø¬Ø±ÙˆØ´Ø©', cat:'conc', dm:88, pct:45 },
        { name:'Ø±Ø¯Ø© Ù‚Ù…Ø­ (Ù†Ø®Ø§Ù„Ø©)', cat:'conc', dm:89, pct:15 },
        { name:'ÙƒØ³Ø¨ ÙÙˆÙ„ ØµÙˆÙŠØ§ 48%', cat:'conc', dm:89, pct:20 },
        { name:'Ø¬Ù„ÙˆØªÙŠÙ† ÙÙŠØ¯ (CGF)', cat:'conc', dm:90, pct:5 },
        { name:'Ù…ÙˆÙ„Ø§Ø³', cat:'conc', dm:75, pct:5 },
        { name:'Ù…Ø®Ù„ÙˆØ· Ù…Ø¹Ø§Ø¯Ù†/ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª', cat:'conc', dm:95, pct:2 },
        { name:'Ø­Ø¬Ø± Ø¬ÙŠØ±ÙŠ (ÙƒØ§Ù„Ø³ÙŠÙˆÙ…)', cat:'conc', dm:100, pct:2 },
        { name:'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…', cat:'conc', dm:100, pct:2 },
        { name:'Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª ØµÙˆØ¯ÙŠÙˆÙ…', cat:'conc', dm:100, pct:4 },
      ]
    },
    {
      key: 'tmr_asfed_closeup',
      name: 'TMR as-fed â€” ØªØ­Ø¶ÙŠØ± ÙˆÙ„Ø§Ø¯Ø© (Close-up)',
      mode: 'tmr_asfed',
      items: [
        { name:'Ø³ÙŠÙ„Ø§Ø¬ Ø°Ø±Ø©', cat:'rough', dm:33, kg:12 },
        { name:'ØªØ¨Ù† Ù‚Ù…Ø­', cat:'rough', dm:90, kg:2 },
        { name:'Ø±Ø¯Ø© Ù‚Ù…Ø­ (Ù†Ø®Ø§Ù„Ø©)', cat:'conc', dm:89, kg:1.5 },
        { name:'Ø°Ø±Ø© ØµÙØ±Ø§Ø¡ Ù…Ø¬Ø±ÙˆØ´Ø©', cat:'conc', dm:88, kg:2 },
        { name:'ÙƒØ³Ø¨ ÙƒØ§Ù†ÙˆÙ„Ø§', cat:'conc', dm:90, kg:1.2 },
        { name:'Ù…Ø®Ù„ÙˆØ· Ù…Ø¹Ø§Ø¯Ù†/ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª', cat:'conc', dm:95, kg:0.15 },
        { name:'Ù…Ù„Ø­ Ø·Ø¹Ø§Ù…', cat:'conc', dm:100, kg:0.05 },
        { name:'Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª ØµÙˆØ¯ÙŠÙˆÙ…', cat:'conc', dm:100, kg:0.10 },
      ]
    }
  ];

  // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ preset
  FEEDS.forEach((f,i)=>{
    const o=document.createElement('option'); o.value=String(i); o.textContent=f.name; presetSel.appendChild(o);
  });
  // Ø§Ù…Ù„Ø£ Ù‚Ø§Ø¦Ù…Ø© Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¹Ù„Ø§Ø¦Ù‚
  TEMPLATES.forEach(t=>{ const o=document.createElement('option'); o.value=t.key; o.textContent=t.name; tplSel.appendChild(o); });

  // datalist Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø³Ù…
  const dl = document.createElement('datalist'); dl.id = 'feedlist';
  FEEDS.forEach(f => { const o = document.createElement('option'); o.value = f.name; dl.appendChild(o); });
  document.body.appendChild(dl);

  const ROUGH_HINTS = ['Ø³ÙŠÙ„Ø§Ø¬','Ø¨Ø±Ø³ÙŠÙ…','Ø¯Ø±ÙŠØ³','Ù‚Ø´','ØªØ¨Ù†','pulp','hay','silage','straw','fresh','green'];
  function guessCat(name){ const s=(name||'').toLowerCase(); return ROUGH_HINTS.some(k=> s.includes(k) ) ? 'rough':'conc'; }

  function td(label, inner, col){ const td=document.createElement('td'); if(col) td.dataset.col = col; td.setAttribute('data-label', label); td.innerHTML=inner; return td; }

  function addRow(feed){
    const tr = document.createElement('tr');
    const catVal = feed?.cat || guessCat(feed?.name);
    tr.appendChild(td('Ø§Ù„Ø®Ø§Ù…Ø©', `<input class="name" value="${feed?.name||''}" list="feedlist" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø©" style="width:200px">`, 'name'));
    tr.appendChild(td('Ø§Ù„ÙØ¦Ø©', `<select class="cat"><option value="rough" ${catVal==='rough'?'selected':''}>Ø®Ø´Ù†</option><option value="conc" ${catVal==='conc'?'selected':''}>Ù…Ø±ÙƒØ²</option></select>`, 'cat'));
    tr.appendChild(td('% DM', `<input class="dm" type="number" inputmode="decimal" step="0.1" value="${feed?.dm ?? ''}" placeholder="%" style="width:100px">`, 'dm'));
    tr.appendChild(td('Ø³Ø¹Ø± Ø§Ù„Ø·Ù† (asâ€‘fed)', `<input class="pTon" type="number" inputmode="decimal" step="0.01" value="${feed?.price||''}" placeholder="Ø¬Ù†ÙŠÙ‡/Ø·Ù†" style="width:140px">`, 'pTon'));
    tr.appendChild(td('Ø³Ø¹Ø±/Ø·Ù† DM', `<span class="pTonDM">â€”</span>`, 'pTonDM'));
    tr.appendChild(td('Ù†Ø³Ø¨Ø© asâ€‘fed %', `<input class="pct" type="number" inputmode="decimal" step="0.01" value="${feed?.pct||''}" placeholder="%" style="width:100px">`, 'pct'));
    tr.appendChild(td('ÙƒØ¬Ù… asâ€‘fed/Ø±Ø£Ø³', `<input class="kg" type="number" inputmode="decimal" step="0.01" value="${feed?.kg||''}" placeholder="ÙƒØ¬Ù…" style="width:120px">`, 'kg'));
    tr.appendChild(td('ÙƒØ¬Ù… DM/Ø±Ø£Ø³', `<span class="kgDM">â€”</span>`, 'kgDM'));
    tr.appendChild(td('ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³/ÙŠÙˆÙ…', `<span class="cost">â€”</span>`, 'cost'));
    tr.appendChild(td('Ø­Ø°Ù', `<button class="rm btn" aria-label="Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø±">Ã—</button>`, 'rm'));
    tbody.appendChild(tr);
    hookRow(tr, feed);
  }

  function nf(x){ return new Intl.NumberFormat('ar-EG',{maximumFractionDigits:2}).format(x||0); }

  function setRowState(tr){
    const mode = modeSel.value;
    const cat  = (tr.querySelector('.cat')?.value)||'conc';
    const kgEl  = tr.querySelector('.kg');
    const pctEl = tr.querySelector('.pct');
    if (mode!== 'split'){
      kgEl.disabled = (mode==='tmr_percent');
      pctEl.disabled= (mode==='tmr_asfed');
    } else {
      if (cat==='rough'){ kgEl.disabled=false; pctEl.disabled=true; }
      else { kgEl.disabled=true; pctEl.disabled=false; }
    }
    kgEl.style.opacity  = kgEl.disabled? .5 : 1;
    pctEl.style.opacity = pctEl.disabled? .5 : 1;
  }
  // === Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ù„Ø¶Ø¨Ø· Ø§Ù„Ø³Ø·Ø± Ø§Ù„ÙØ§Ø±Øº Ø¨Ø­Ø³Ø¨ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„ØªØ±ÙƒÙŠØ² ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ===
  function isRowEmpty(tr){
    if (!tr) return true;
    const name = tr.querySelector('.name')?.value?.trim();
    const kg   = tr.querySelector('.kg')?.value;
    const pct  = tr.querySelector('.pct')?.value;
    return (!name && !kg && !pct);
  }
  function focusEditable(tr){
    const mode = modeSel.value;
    const cat  = (tr.querySelector('.cat')?.value)||'conc';
    const kgEl = tr.querySelector('.kg');
    const pctEl= tr.querySelector('.pct');
    setRowState(tr);
    setTimeout(()=>{
      if (mode==='tmr_asfed'){ kgEl?.focus(); kgEl?.select?.(); }
      else if (mode==='tmr_percent'){ pctEl?.focus(); pctEl?.select?.(); }
      else { // split
        if (cat==='rough'){ kgEl?.focus(); kgEl?.select?.(); }
        else { pctEl?.focus(); pctEl?.select?.(); }
      }
    }, 0);
  }
  function ensureEditableForMode(){
    let tr = tbody.querySelector('tr');
    if (!tr){ addEmptyRow(); tr = tbody.querySelector('tr'); }
    if (modeSel.value==='split' && tr){
      // Ø§Ø¬Ø¹Ù„ Ø£ÙˆÙ„ Ø³Ø·Ø± Ø®Ø´Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒØ¬Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø·Ø± ÙØ§Ø±ØºÙ‹Ø§
      const catEl = tr.querySelector('.cat');
      if (catEl && catEl.value!=='rough' && isRowEmpty(tr)) catEl.value='rough';
    }
    focusEditable(tr);
  }

  function recalc(){
    const mode = modeSel.value; // 'tmr_asfed' | 'tmr_percent' | 'split'
    let totalDM=0, totalCost=0, mix=0, sumPct=0, mixAsFed=0, dmFrac=0;
    let roughDM=0, roughCost=0; // split
    let concMixAsFed=0, concDmFrac=0, concSumPct=0; // split
    const concKg = parseFloat(concKgInput.value)||0; // split

    tbody.querySelectorAll('tr').forEach(tr=>{
      const dm = parseFloat(tr.querySelector('.dm').value)||0;
      const p  = parseFloat(tr.querySelector('.pTon').value)||0;
      const kg = parseFloat(tr.querySelector('.kg').value)||0;
      const pc = parseFloat(tr.querySelector('.pct').value)||0;
      const cat= (tr.querySelector('.cat')?.value)||'conc';
      const pDM= dm>0? (p/(dm/100)) : 0;
      tr.querySelector('.pTonDM').textContent = pDM? nf(pDM):'â€”';

      if (mode==='tmr_asfed'){
        const kgDM = kg*(dm/100);
        const cost = (kgDM/1000)*pDM;
        tr.querySelector('.kgDM').textContent = kgDM? nf(kgDM):'â€”';
        tr.querySelector('.cost').textContent = cost? nf(cost):'â€”';
        totalDM+=kgDM; totalCost+=cost;
      } else if (mode==='tmr_percent'){
        tr.querySelector('.kgDM').textContent = 'â€”';
        tr.querySelector('.cost').textContent = 'â€”';
        if (pc>0){ mixAsFed+=(pc/100)*p; dmFrac+=(pc/100)*(dm/100); sumPct+=pc; }
      } else { // split
        if (cat==='rough'){
          const kgDM = kg*(dm/100);
          const cost = (kgDM/1000)*pDM;
          tr.querySelector('.kgDM').textContent = kgDM? nf(kgDM):'â€”';
          tr.querySelector('.cost').textContent = cost? nf(cost):'â€”';
          roughDM+=kgDM; roughCost+=cost;
        } else {
          tr.querySelector('.kgDM').textContent = 'â€”';
          tr.querySelector('.cost').textContent = 'â€”';
          if (pc>0){ concMixAsFed+=(pc/100)*p; concDmFrac+=(pc/100)*(dm/100); concSumPct+=pc; }
        }
      }
    });

    const pillMix = document.getElementById('pillMix');
    const pillSumPct = document.getElementById('pillSumPct');

    if (mode==='tmr_asfed'){
      if (totalDM>0){
        let mixDM=0; document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
          const dm=parseFloat(tr.querySelector('.dm').value)||0;
          const p=parseFloat(tr.querySelector('.pTon').value)||0;
          const kg=parseFloat(tr.querySelector('.kg').value)||0;
          const pDM= dm>0? (p/(dm/100)) : 0;
          const share=(kg*(dm/100))/totalDM; mixDM += share*pDM;
        });
        mix = mixDM;
      }
      pillMix.style.display=''; pillSumPct.style.display='none';
      document.getElementById('totDM').textContent = nf(totalDM);
      document.getElementById('totCost').textContent = nf(totalCost);
    } else if (mode==='tmr_percent'){
      mix = dmFrac>0? (mixAsFed/dmFrac) : 0;
      document.getElementById('sumPct').textContent = nf(sumPct)+'%';
      pillMix.style.display=''; pillSumPct.style.display='inline-flex';
      document.getElementById('totDM').textContent = 'â€”';
      document.getElementById('totCost').textContent = 'â€”';
    } else { // split
      const concPriceDM = concDmFrac>0? (concMixAsFed/concDmFrac) : 0;
      const concKgDM    = concKg * concDmFrac;
      const concCost    = (concKgDM/1000) * concPriceDM;
      const totalDMAll  = roughDM + concKgDM;
      const totalCostAll= roughCost + concCost;

      document.getElementById('roughDM').textContent = nf(roughDM);
      document.getElementById('roughCost').textContent = nf(roughCost);
      document.getElementById('sumPctConc').textContent = nf(concSumPct)+'%';
      document.getElementById('concDMpct').textContent = nf(concDmFrac*100)+'%';
      document.getElementById('concPriceDM').textContent = concPriceDM? nf(concPriceDM):'â€”';
      document.getElementById('concKgShow').textContent  = concKg? nf(concKg):'â€”';
      document.getElementById('concKgDM').textContent    = concKgDM? nf(concKgDM):'â€”';
      document.getElementById('concCost').textContent    = concCost? nf(concCost):'â€”';
      document.getElementById('totalCostAll').textContent= (totalCostAll||totalCostAll===0)? nf(totalCostAll):'â€”';

      document.getElementById('totDM').textContent = totalDMAll? nf(totalDMAll):'â€”';
      document.getElementById('totCost').textContent = totalCostAll? nf(totalCostAll):'â€”';

      pillMix.style.display='none'; pillSumPct.style.display='none';
    }

    document.getElementById('mixPriceDM').textContent = mix? nf(mix):'â€”';

    // ØªØ­Ø°ÙŠØ±Ø§Øª Ø°ÙƒÙŠØ© Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    let w = '';
    if (mode==='tmr_percent' && (sumPct<99 || sumPct>101)) w = `âš ï¸ Ù…Ø¬Ù…ÙˆØ¹ Ù†Ø³Ø¨ asâ€‘fed = ${nf(sumPct)}% (Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ 100%)`;
    if (mode==='split' && (concSumPct && (concSumPct<99 || concSumPct>101))) w = `âš ï¸ Ù†Ø³Ø¨ Ø§Ù„Ù…Ø±ÙƒØ² = ${nf(concSumPct)}% (Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ 100%)`;
    // ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù„Ù‰ DM Ù…ÙÙ‚ÙˆØ¯ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø£Ø±Ù‚Ø§Ù…
    const dmMissing = Array.from(tbody.querySelectorAll('tr')).some(tr=>{
      const dm = parseFloat(tr.querySelector('.dm').value);
      const hasVal = (parseFloat(tr.querySelector('.kg').value)||0) > 0 || (parseFloat(tr.querySelector('.pct').value)||0) > 0;
      return !dm && hasVal;
    });
    if (!w && dmMissing) w = 'âš ï¸ Ø£Ø¯Ø®Ù„ %DM Ù„ÙƒÙ„ Ø®Ø§Ù…Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨Ø¯Ù‚Ø©.';
    warn.textContent = w;
  }

  function hookRow(tr){
    const nameEl = tr.querySelector('.name');
    const dmEl   = tr.querySelector('.dm');
    const pEl    = tr.querySelector('.pTon');
    const kgEl   = tr.querySelector('.kg');
    const pctEl  = tr.querySelector('.pct');
    const catEl  = tr.querySelector('.cat');
    tr.querySelector('.rm').onclick = ()=>{ tr.remove(); recalc(); };

    nameEl.addEventListener('change', ()=>{
      const f = FEEDS.find(x=>x.name===nameEl.value.trim());
      if (f && !dmEl.value) dmEl.value = f.dm;
      setRowState(tr); recalc();
      ensureEditableForMode();
    });
    [dmEl,pEl,kgEl,pctEl,catEl].forEach(el=> el.addEventListener('input', ()=>{ setRowState(tr); recalc(); }));

    setRowState(tr);
  }

  function addEmptyRow(){
    const mode = modeSel.value;
    const cat  = (mode==='split') ? 'rough' : 'conc';
    addRow({ cat });
  }

  // init rows
  addEmptyRow();
  ensureEditableForMode();

  addPresetBtn.onclick = ()=>{
    const idx = parseInt(presetSel.value); if (isNaN(idx)) return;
    const f = FEEDS[idx]; addRow({ name:f.name, dm:f.dm, price:'', kg:'', pct:'', cat: guessCat(f.name) }); recalc();
  };

  function applyTemplate(key){
    const tpl = TEMPLATES.find(t=> t.key === key); if(!tpl) return;
    // Ø§Ø¶Ø¨Ø· Ø§Ù„ÙˆØ¶Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ù„Ø¨
    modeSel.value = tpl.mode; updateModeUI();

    // === ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ±Ø¯Ù‹Ø§ ===
    (async function autoFillContextSingleAnimal(){
      try{
        if (!animalId || groupName) return; // Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ Ø³ÙŠØ¨Ù‡Ø§ ÙŠØ¯ÙˆÙŠ

        // 1) Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† animals
        try{
          const direct = await getDoc(doc(db, 'animals', String(animalId)));
          if (direct.exists() && !ctxSpecies.value){
            const a = direct.data();
            const sp = a?.species || a?.type || a?.kind;
            if (sp) ctxSpecies.value = (String(sp).includes('Ø¬Ø§Ù…ÙˆØ³') ? 'Ø¬Ø§Ù…ÙˆØ³' : 'Ø¨Ù‚Ø±');
          }
        }catch(_){/* ØªØ¬Ø§Ù‡Ù„ */}
        if (!ctxSpecies.value){
          try{
            const qs = query(collection(db,'animals'), where('number','==', String(animalId)), limit(1));
            const snap = await getDocs(qs);
            snap.forEach(d=>{ const a=d.data(); const sp=a?.species||a?.type; if(sp&&!ctxSpecies.value) ctxSpecies.value=(String(sp).includes('Ø¬Ø§Ù…ÙˆØ³')?'Ø¬Ø§Ù…ÙˆØ³':'Ø¨Ù‚Ø±'); });
          }catch(_){/* ØªØ¬Ø§Ù‡Ù„ */}
        }

        // 2) Ø§Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬ DIM/Ø§Ù„Ø­Ù…Ù„/Ø§Ù„Ø¥Ù†ØªØ§Ø¬
        async function getEvents(orderField){
          const qv = query(collection(db,'events'), where('animalId','==', String(animalId)), orderBy(orderField,'desc'), limit(50));
          const s = await getDocs(qv); return s.docs.map(x=> x.data());
        }
        let events = [];
        try{ events = await getEvents('createdAt'); }catch(_){ try{ events = await getEvents('eventDate'); }catch(__){} }

        const toDate = (v)=>{
          if (!v) return null; if (v instanceof Date) return v; if (typeof v==='string') return new Date(v+'T00:00:00');
          if (v?.toDate) return v.toDate(); return null; };
        const diffDays = (d1,d2)=>{ if(!d1||!d2) return null; const ms = d1.getTime()-d2.getTime(); return Math.floor(ms/86400000); };

        // Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø© â‡’ DIM
        const today = toDate(eventDate) || new Date();
        const calv = events.find(e => (e?.type==='ÙˆÙ„Ø§Ø¯Ø©') || (e?.eventType && String(e.eventType).includes('ÙˆÙ„Ø§Ø¯Ø©')));
        const calvDate = toDate(calv?.eventDate) || toDate(calv?.createdAt);
        const DIM = diffDays(today, calvDate);
        if (!ctxDIM.value && DIM!=null && DIM>=0) ctxDIM.value = DIM;

        // Ø¢Ø®Ø± ØªØ´Ø®ÙŠØµ Ø­Ù…Ù„ â‡’ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„
        const pregEvt = events.find(e => (e?.pregnancyStatus) || (e?.eventType && String(e.eventType).includes('ØªØ´Ø®ÙŠØµ')));
        const preg = pregEvt?.pregnancyStatus || pregEvt?.preg || pregEvt?.result;
        if (!ctxPreg.value && preg){ ctxPreg.value = (String(preg).includes('Ø¹Ø´Ø§Ø±') ? 'Ø¹Ø´Ø§Ø±' : (String(preg).includes('ÙØ§Ø±Øº')?'ÙØ§Ø±ØºØ©':'')); }

        // ØªÙ‚Ø¯ÙŠØ± DCC Ù…Ù† Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¹Ø´Ø§Ø±
        if ((ctxPreg.value==='Ø¹Ø´Ø§Ø±' || !ctxPreg.value)){
          const aiEvt = events.find(e => (e?.type && String(e.type).includes('ØªÙ„Ù‚ÙŠØ­')) || (e?.eventType && String(e.eventType).includes('ØªÙ„Ù‚ÙŠØ­')));
          const aiDate = toDate(aiEvt?.eventDate) || toDate(aiEvt?.createdAt);
          const DCC = diffDays(today, aiDate);
          if (!ctxDCC.value && DCC!=null && DCC>=0) ctxDCC.value = DCC;
        }

        // Ù…ØªÙˆØ³Ø· Ø§Ù„Ù„Ø¨Ù† Ù…Ù† Ø¢Ø®Ø± 7 ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ
        const milkVals = [];
        events.forEach(e=>{
          if (e?.eventType && String(e.eventType).includes('Ø§Ù„Ù„Ø¨Ù†')){
            const v = e?.milkKg ?? e?.milk ?? e?.amount ?? null;
            if (typeof v==='number') milkVals.push(v);
          }
        });
        if (!ctxAvgMilk.value && milkVals.length){
          const n = Math.min(7, milkVals.length);
          const avg = milkVals.slice(0,n).reduce((a,b)=>a+b,0)/n;
          ctxAvgMilk.value = Number(avg.toFixed(1));
        }

      }catch(err){ console.warn('autoFillContextSingleAnimal:', err); }
    })();

    // Ø§Ø¶Ø¨Ø· ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ² ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù†ÙØµÙ„ Ø¥Ù† ÙˆÙØ¬Ø¯Øª
    if (tpl.mode==='split' && typeof tpl.concKg === 'number') concKgInput.value = tpl.concKg;
    // Ø§Ù…Ø³Ø­ ÙˆØ£Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©
    tbody.innerHTML='';
    (tpl.items||[]).forEach(it=>{
      const def = FEEDS.find(x=> x.name === it.name);
      addRow({
        name: it.name,
        dm  : (it.dm ?? def?.dm ?? ''),
        cat : it.cat || guessCat(it.name),
        kg  : (typeof it.kg  !== 'undefined')  ? it.kg  : '',
        pct : (typeof it.pct !== 'undefined')  ? it.pct : '',
      });
    });
    recalc();
  }

  if (applyTplBtn){ applyTplBtn.addEventListener('click', ()=>{ const k = tplSel?.value || ''; if(k) applyTemplate(k); }); }

  if (addBySearchBtn){
    const addByName = ()=>{
      const q = (feedSearch?.value || '').trim();
      if(!q) return;
      const f = FEEDS.find(x=> x.name === q)
            || FEEDS.find(x=> x.name.includes(q))
            || FEEDS.find(x=> x.name.toLowerCase().includes(q.toLowerCase()));
      if (f){ addRow({ name:f.name, dm:f.dm, price:'', kg:'', pct:'', cat: guessCat(f.name) }); recalc(); feedSearch.value=''; }
    };
    addBySearchBtn.addEventListener('click', addByName);
    feedSearch?.addEventListener('keydown', e=>{ if(e.key==='Enter') addByName(); });
  }

  clearBtn.onclick = ()=>{ if(confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙØŸ')){ tbody.innerHTML=''; addEmptyRow(); recalc(); } };

  function updateModeUI(){
    const mode = modeSel.value; if (modeInfo) modeInfo.textContent = mode;
    splitBox.style.display = (mode==='split')? '' : 'none';
    // Show/hide columns
    const showCols = new Set(
      mode==='tmr_asfed'  ? ['name','cat','dm','pTon','pTonDM','kg','kgDM','cost','rm'] :
      mode==='tmr_percent'? ['name','cat','dm','pTon','pTonDM','pct','rm'] :
                            ['name','cat','dm','pTon','pTonDM','pct','kg','kgDM','cost','rm']
    );
    document.querySelectorAll('th').forEach(th=>{ const c=th.dataset.col; if(!c)return; th.style.display = showCols.has(c)? '':'none'; });
    document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
      tr.querySelectorAll('td').forEach(td=>{ const c=td.dataset.col; if(!c)return; td.style.display = showCols.has(c)? '':'none'; });
      setRowState(tr);
    });
    recalc();
  }

  modeSel.addEventListener('change', updateModeUI);
  modeSel.addEventListener('change', ensureEditableForMode);
  concKgInput.addEventListener('input', recalc);
  updateModeUI();

  // ==== Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø« =====
  document.getElementById('saveEvent').addEventListener('click', async ()=>{
    if (!animalId || !eventDate){ warn.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®.'; return; }
    const mode = modeSel.value;
    const rows = Array.from(document.querySelectorAll('#tbl tbody tr')).map(tr=>({
      name: tr.querySelector('.name').value.trim(),
      cat : (tr.querySelector('.cat')?.value)||'conc',
      dm  : parseFloat(tr.querySelector('.dm').value)||0,
      price: parseFloat(tr.querySelector('.pTon').value)||0,
      kg  : parseFloat(tr.querySelector('.kg').value)||0,
      pct : parseFloat(tr.querySelector('.pct').value)||0,
    })).filter(r=> r.name);

    // Ø£Ø¹ÙØ¯Ù‘ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©
    const kpis = {
      mode,
      mixPriceDM: document.getElementById('mixPriceDM').textContent,
      totDM:      document.getElementById('totDM').textContent,
      totCost:    document.getElementById('totCost').textContent,
      split: {
        roughDM : document.getElementById('roughDM').textContent,
        roughCost:document.getElementById('roughCost').textContent,
        concDMpct:document.getElementById('concDMpct').textContent,
        concPriceDM:document.getElementById('concPriceDM').textContent,
        concKgAf: concKgInput.value || '',
        concKgDM: document.getElementById('concKgDM').textContent,
        concCost: document.getElementById('concCost').textContent,
        totalCostAll: document.getElementById('totalCostAll').textContent,
      }
    };

    try{
      const uid = localStorage.getItem('userId') || (auth?.currentUser?.uid || null);
      await addDoc(collection(db, 'events'), {
        userId: uid,
        animalId: animalId,
        animalNumber: animalId,
        eventDate: eventDate,
        type: 'ØªØºØ°ÙŠØ©',
        eventType: 'ØªØºØ°ÙŠØ©',
        nutrition: { mode, rows, concKgAf: concKgInput.value||null },
        kpis,
        context: {
          group: groupName || null,
          species: ctxSpecies?.value || null,
          daysInMilk: ctxDIM?.value ? parseInt(ctxDIM.value) : null,
          avgMilkKg: ctxAvgMilk?.value ? parseFloat(ctxAvgMilk.value) : null,
          earlyDry: !!(ctxEarlyDry?.checked),
          closeUp: !!(ctxCloseUp?.checked),
          pregnancyStatus: ctxPreg?.value || null,
          pregnancyDays: ctxDCC?.value ? parseInt(ctxDCC.value) : null,
          daysToCalving: (ctxDCC?.value ? (getGestLen() - parseInt(ctxDCC.value)) : null)
        },
        createdAt: serverTimestamp()
      });
      window.t.event({event:'nutrition_save', page:'nutrition', mode, rows:rows.length});
      const again = await showNotice(`âœ… ØªÙ… Ø­ÙØ¸ ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ù„Ù„Ø­ÙŠÙˆØ§Ù† ${animalId}`);
      if (!again) location.href = 'dashboard.html';
    }catch(e){
      console.error(e);
      warn.textContent = 'âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.';
    }
  });

  function boot(){
    const hasLS = !!localStorage.getItem('userId');
    if (auth && typeof onAuthStateChanged === 'function') {
      onAuthStateChanged(auth, (user) => {
        if (user || hasLS) { refresh(); }
        else { location.href = 'login.html'; }
      });
    } else {
      if (hasLS) { refresh(); } else { location.href = 'login.html'; }
    }
  }
  function refresh(){ recalc(); }
  boot();

  // === Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬ÙØ§Ù/Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ DCC ===
  function getGestLen(){ return (ctxSpecies?.value==='Ø¬Ø§Ù…ÙˆØ³' ? 310 : 280); }
  function applyDCCRules(){
    const dcc = parseInt(ctxDCC?.value);
    const GL = getGestLen();
    if (!isNaN(dcc)){
      const dtc = GL - dcc;
      if (dtcVal) dtcVal.textContent = isFinite(dtc)? String(dtc) : 'â€”';
      ctxEarlyDry.checked = (dcc >= (GL - 60));
      ctxCloseUp.checked  = (dcc >= (GL - 21));
    } else {
      if (dtcVal) dtcVal.textContent = 'â€”';
    }
  }
  ctxDCC?.addEventListener('input', applyDCCRules);
  ctxSpecies?.addEventListener('change', applyDCCRules);
  applyDCCRules();

  // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø¹Ø¨Ø± ?tpl=...
  const tplKey = qp.get('tpl'); if (tplKey) { tplSel.value = tplKey; applyTemplate(tplKey); }
</script>

<!-- ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ø¹Ø§Ù… (Ù„Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ù„ØªØµÙ…ÙŠÙ…) ÙˆÙÙ‚ Ù…Ø¨Ø§Ø¯Ø¦ â€œÙ…Ø±Ø¨ÙŠÙƒâ€ -->
<script src="/js/app-core.js"></script>
<script type="module" src="/js/smart-checks.js"></script>
<script src="/js/tenant-bootstrap.js"></script>
<script src="/js/api.js"></script>
</body>
</html>
