<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="css/forms.css">
  <title>تقييم الروث بالكاميرا — مُرَبِّك</title>
  <style>
    :root{
      --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff; --danger:#c2410c;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Segoe UI','Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid #e2e8f0;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .title{font-weight:800;color:var(--green);margin:0}
    .badge{background:#e6f8ef;color:var(--green-600);padding:4px 8px;border-radius:999px;font-size:12px}
    .container{max-width:800px;margin:16px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}

    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:12px}
    .controls .select,.controls .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px}
    .controls .btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:700;min-height:44px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .btn-primary{background:var(--green);color:#fff}
    .btn-light{background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .preview-wrap{position:relative;border-radius:16px;overflow:hidden;background:#000}
    video#preview{width:100%;height:auto;display:block;background:#000}
    canvas#overlay{position:absolute;inset:0;pointer-events:none}

    .results{padding:12px;border-top:1px solid #e2e8f0;display:grid;gap:12px}
    .score{display:grid;gap:10px;padding:8px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
    .score-badge{display:inline-block;padding:6px 10px;border:1px solid transparent;border-radius:999px;font-weight:800;width:max-content}
    .score-bar{height:10px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;overflow:hidden}
    .score-bar .fill{height:100%}
    .score-note{color:var(--muted);font-weight:700}

    /* خانة عرض الصورة المُرفوعة (المطلوب 2) */
    .upload-preview{
      display:flex; gap:12px; align-items:center; padding:8px; background:#fff; border:1px solid #e2e8f0; border-radius:12px;
    }
    .upload-preview img{width:96px;height:96px;object-fit:cover;border-radius:12px;border:1px solid #e5e7eb}

    editor-card,.editor-card{pointer-events:none !important;opacity:0 !important;visibility:hidden !important;position:static !important;z-index:-1 !important}
    header,.container,#cameraCard{position:relative;z-index:1}
    .save-bar{display:flex;gap:8px;align-items:center;padding:12px;border-top:1px solid #e2e8f0;flex-wrap:wrap}
    .save-bar .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px}
    /* تكبير أزرار شريط الحفظ ليتناسق مع باقي الصفحات */
.save-bar .btn{
  padding:16px 18px;
  min-height:54px;
  font-size:17px;
  border-radius:14px;
}
/* على الموبايل نخليهم صف فوق بعض وبعرض كامل */
@media (max-width:520px){
  .save-bar{ flex-direction:column; align-items:stretch }
  .save-bar .btn{ width:100% }
}

  </style>
</head>
<body>
  <header>
    <h1 class="title">تقييم الروث بالكاميرا</h1>
    <span class="badge">مُرَبِّك</span>
    <span class="badge" id="demoBadge" style="display:none;background:#fff3cd;color:#92400e;border:1px solid #facc15">وضع العرض</span>
    <div style="margin-inline-start:auto;color:var(--muted);font-weight:700">رقم الحيوان: <span class="animal-number">—</span></div>
  </header>

  <div class="container">
    <section class="card" id="cameraCard">
      <div class="controls">
        <select id="cameraSelect" class="select" title="اختيار الكاميرا"></select>
        <button id="demoBtn" class="btn btn-light" title="تشغيل وضع العرض">وضع العرض</button>
        <button id="toggleFlash" class="btn btn-light" title="تشغيل الفلاش" aria-pressed="false">الفلاش</button>
        <button id="restartBtn" class="btn btn-light">إعادة التهيئة</button>
        <div style="margin-inline-start:auto"></div>
        <button id="captureBtn" class="btn btn-primary">التقاط</button>
        <button id="retakeBtn" class="btn btn-danger" disabled>إعادة الالتقاط</button>
        <button id="uploadBtn" class="btn btn-light">رفع صورة بديلة</button>
        <input id="uploadInput" type="file" accept="image/*" style="display:none" />
      </div>

      <div class="preview-wrap">
        <video id="preview" playsinline autoplay muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="results" id="resultsBox">
        <h3 style="margin:8px 0;color:var(--green-600)">النتيجة</h3>

        <!-- خانة عرض الصورة المرفوعة/المُلتقطة (المطلوب 2) -->
        <div class="upload-preview" id="uploadPreviewBox" style="display:none">
          <img id="uploadPreviewImg" alt="المعاينة" />
          <div style="display:grid;gap:6px">
            <div style="font-weight:700;color:#0f172a">معاينة الصورة</div>
            <div style="color:var(--muted);font-size:14px">تُستخدم هذه الصورة لحساب الدرجة فقط — لا يتم حفظها.</div>
          </div>
        </div>

        <div id="scoreWidget" class="score">
          <div class="score-badge" id="scoreBadge">—</div>
          <div class="score-bar"><div class="fill" id="scoreFill" style="width:0%"></div></div>
          <div class="score-note" id="scoreNote">التقط/ارفع صورة لعرض درجة الروث (1=إسهال … 5=إمساك، المثالي ~ 3.5).</div>
        </div>
      </div>

      <div class="save-bar">
        <input type="hidden" id="animalId" />
        <label style="display:flex;gap:8px;align-items:center">تاريخ التقييم
          <input type="date" id="eventDate" class="input" />
        </label>

        <div style="margin-inline-start:auto;display:flex;gap:8px">
           <div id="saveMsg" style="display:none;width:100%;padding:10px;border-radius:12px;font-weight:700;text-align:center"></div>
          <!-- زر الرجوع إلى add-event (المطلوب 5) -->
          <button id="backBtn" class="btn btn-light" type="button">رجوع لصفحة الحدث</button>
          <button id="saveBtn" class="btn btn-primary" type="button">حفظ التقييم</button>
        </div>
      </div>
    </section>
  </div>

  <!-- حط دول بدري قبل أي كود بيستعمل t.event -->
<script>window.dataLayer = window.dataLayer || [];</script>
<script src="/js/app-core.js"></script>
<script type="module" src="/js/vision-core.js"></script>
<!-- سكربتات المشروع -->
  <script src="js/mbk-animals.js?v=2"></script>

  <!-- المنطق الرئيسي + تقنية التقييم عالية الدقة + ربط السياق -->
  <script type="module">
    // ====== أدوات عامة وسياق (المطلوب 6) ======
    const qs = new URLSearchParams(location.search);
    const $ = (s,p=document)=>p.querySelector(s);
    const isDemo = qs.get('demo')==='1' || qs.get('mode')==='demo';

    function todayCairo(){
      const now=new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'}));
      const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function getAnimalFromContext(){
      const id=qs.get('animalId')||localStorage.getItem('currentAnimalId')||'';
      const number=qs.get('number')||localStorage.getItem('currentAnimalNumber')||'';
      const date=qs.get('date')||sessionStorage.getItem('currentEventDate')||localStorage.getItem('currentEventDate')||todayCairo();
      if(id) localStorage.setItem('currentAnimalId',id);
      if(number) localStorage.setItem('currentAnimalNumber',number);
      if(date){ localStorage.setItem('currentEventDate',date); sessionStorage.setItem('currentEventDate',date); }
      return {id,number,date};
    }

    // عناصر الصفحة
    const preview=$('#preview'), overlay=$('#overlay'), cameraSelect=$('#cameraSelect');
    const toggleFlash=$('#toggleFlash'), restartBtn=$('#restartBtn');
    const captureBtn=$('#captureBtn'), retakeBtn=$('#retakeBtn');
    const uploadBtn=$('#uploadBtn'), uploadInput=$('#uploadInput');
    const scoreBadge=$('#scoreBadge'), scoreFill=$('#scoreFill'), scoreNote=$('#scoreNote');
    const saveBtn=$('#saveBtn'), animalIdInput=$('#animalId'), eventDateInput=$('#eventDate');
    const backBtn=$('#backBtn'), numberSpan=document.querySelector('.animal-number');
    const uploadPreviewBox=$('#uploadPreviewBox'), uploadPreviewImg=$('#uploadPreviewImg');

    const state={ stream:null, track:null, capabilities:null, torchOn:false, lastCapture:null, lastScore:null };
    window.fecesScore = null; // لتصدير الدرجة للجزء الخاص بفايرستور

    function fitOverlay(){
      const r=preview.getBoundingClientRect();
      overlay.width=r.width*devicePixelRatio; overlay.height=r.height*devicePixelRatio;
      overlay.style.width=r.width+'px'; overlay.style.height=r.height+'px';
    }
    function drawGuide(){
      const g=overlay.getContext('2d'); if(!g) return;
      const w=overlay.width,h=overlay.height; g.clearRect(0,0,w,h);
      g.strokeStyle='rgba(255,255,255,.35)'; g.lineWidth=1*devicePixelRatio;
      for(let i=1;i<3;i++){ g.beginPath(); g.moveTo((w/3)*i,0); g.lineTo((w/3)*i,h); g.stroke();
        g.beginPath(); g.moveTo(0,(h/3)*i); g.lineTo(w,(h/3)*i); g.stroke(); }
      g.strokeStyle='rgba(14,160,90,.9)'; g.lineWidth=4*devicePixelRatio;
      const rx=w*.18, ry=h*.18, rw=w*.64, rh=h*.64;
      if(g.roundRect){ g.beginPath(); g.roundRect(rx,ry,rw,rh,20*devicePixelRatio); g.stroke(); } else { g.strokeRect(rx,ry,rw,rh); }
    }

    async function listCameras(){
      const devs=await navigator.mediaDevices.enumerateDevices();
      const cams=devs.filter(d=>d.kind==='videoinput');
      cameraSelect.innerHTML='';
      cams.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.deviceId; o.textContent=c.label||`كاميرا ${i+1}`; cameraSelect.appendChild(o); });
      return cams;
    }
    async function startCamera(deviceId){
      if(state.stream){ state.stream.getTracks().forEach(t=>t.stop()); }
      const cs=deviceId?{video:{deviceId:{exact:deviceId}}}:{video:{facingMode:{ideal:'environment'}}};
      const stream=await navigator.mediaDevices.getUserMedia(cs);
      state.stream=stream; preview.srcObject=stream;
      const [track]=stream.getVideoTracks(); state.track=track; state.capabilities=track.getCapabilities?.()||null;
      await preview.play(); fitOverlay(); drawGuide(); populateTorchSupport();
    }
    function populateTorchSupport(){ const cap=state.capabilities; toggleFlash.disabled=!(cap&&'torch' in cap); }
    async function toggleTorch(){ try{
      if(!state.track) return; state.torchOn=!state.torchOn;
      await state.track.applyConstraints({advanced:[{torch:state.torchOn}]});
      toggleFlash.setAttribute('aria-pressed',String(state.torchOn));
      toggleFlash.textContent=state.torchOn?'الفلاش: يعمل':'الفلاش';
    }catch(e){ console.warn('Torch not supported',e); } }

    function dataURLFromVideo(){
      const c=document.createElement('canvas');
      const w=preview.videoWidth,h=preview.videoHeight;
      c.width=w; c.height=h; c.getContext('2d').drawImage(preview,0,0,w,h);
      return c.toDataURL('image/jpeg',0.92);
    }

    // ====== (المطلوب 1) مسار الصور المرجعية مضبوط إلى www/images بدقة ======
    // الأسماء: 1.jpg, 2.jpg, 3.jpg, 3_5.jpg, 4.jpg, 5.jpg
    const REF_BASES = ['/www/images/','/images/']; // الأولوية لـ /www/images/
    const REF_EXTS = ['jpg','jpeg','png','webp','JPG','JPEG','PNG','WEBP'];
    const REF_NAMES = [
      {score:1,   names:['1']},
      {score:2,   names:['2']},
      {score:3,   names:['3']},
      {score:3.5, names:['3_5','3.5']},
      {score:4,   names:['4']},
      {score:5,   names:['5']}
    ];
    const REF_LIST = REF_NAMES.flatMap(({score,names}) =>
      names.map(name => ({
        score,
        urls: REF_BASES.flatMap(base => REF_EXTS.map(ext => `${base}${name}.${ext}`))
      }))
    );

    // ====== تقنية التقييم عالية الدقة (المطلوب 3) ======
    // مزج خصائص متعددة: ROI مركزي + تعتيم خفيف + تسوية تباين + متجه رمادي مُطبَّع + لونية HSV (المتوسط/الانحراف)
    // + نسيج LBP-lite + HOG-lite، ثم مقارنة مع المراجع بأوزان مدروسة.
    function cropROI(img,w=224,h=224){
      const cw=img.width, ch=img.height;
      const rw = Math.floor(cw*0.6), rh = Math.floor(ch*0.6);
      const rx = Math.floor((cw - rw)/2), ry = Math.floor((ch - rh)/2);
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      const g=c.getContext('2d');
      g.imageSmoothingEnabled = true;
      g.drawImage(img, rx, ry, rw, rh, 0, 0, w, h);
      return c;
    }
    function gaussianBlur(c){
      // بلور بسيط 3x3
      const g=c.getContext('2d'), {width:w,height:h}=c; const img=g.getImageData(0,0,w,h);
      const d=img.data; const o=new Uint8ClampedArray(d.length);
      const k=[1,2,1,2,4,2,1,2,1]; const s=16;
      for(let y=1;y<h-1;y++){
        for(let x=1;x<w-1;x++){
          let r=0,gc=0,b=0,ki=0;
          for(let j=-1;j<=1;j++){
            for(let i=-1;i<=1;i++){
              const p=((y+j)*w+(x+i))*4, kv=k[ki++]; r+=d[p]*kv; gc+=d[p+1]*kv; b+=d[p+2]*kv;
            }
          }
          const p=(y*w+x)*4; o[p]=r/s; o[p+1]=gc/s; o[p+2]=b/s; o[p+3]=255;
        }
      }
      g.putImageData(new ImageData(o,w,h),0,0);
      return c;
    }
    function toGrayVec(c,sz=64){
      const t=document.createElement('canvas'); t.width=sz; t.height=sz;
      const g=t.getContext('2d'); g.drawImage(c,0,0,sz,sz);
      const D=g.getImageData(0,0,sz,sz).data;
      const v=new Float32Array(sz*sz); let k=0, mean=0;
      for(let i=0;i<D.length;i+=4){ const gr=0.2126*D[i]+0.7152*D[i+1]+0.0722*D[i+2]; v[k++]=gr; mean+=gr; }
      mean/=v.length; let norm=0; for(let i=0;i<v.length;i++){ v[i]-=mean; norm+=v[i]*v[i]; }
      norm=Math.sqrt(norm)||1; for(let i=0;i<v.length;i++) v[i]/=norm; return v;
    }
    function hsvMoments(c){
      const g=c.getContext('2d'); const {width:w,height:h}=c; const D=g.getImageData(0,0,w,h).data;
      let Hm=0,Sm=0,Vm=0, n=w*h;
      for(let i=0;i<D.length;i+=4){
        const r=D[i]/255, gg=D[i+1]/255, b=D[i+2]/255;
        const max=Math.max(r,gg,b), min=Math.min(r,gg,b); const delta=max-min;
        let h=0;
        if(delta!==0){
          if(max===r){ h=60*(((gg-b)/delta)%6); }
          else if(max===gg){ h=60*(((b-r)/delta)+2); }
          else { h=60*(((r-gg)/delta)+4); }
        }
        const s = max===0?0:delta/max;
        const v = max;
        Hm+=h; Sm+=s; Vm+=v;
      }
      Hm/=n; Sm/=n; Vm/=n;
      // انحراف معياري تقريبي
      let Hs=0,Ss=0,Vs=0;
      for(let i=0;i<D.length;i+=4){
        const r=D[i]/255, gg=D[i+1]/255, b=D[i+2]/255;
        const max=Math.max(r,gg,b), min=Math.min(r,gg,b); const delta=max-min;
        let h=0;
        if(delta!==0){
          if(max===r){ h=60*(((gg-b)/delta)%6); }
          else if(max===gg){ h=60*(((b-r)/delta)+2); }
          else { h=60*(((r-gg)/delta)+4); }
        }
        const s = max===0?0:delta/max;
        const v = max;
        Hs+=(h-Hm)*(h-Hm); Ss+=(s-Sm)*(s-Sm); Vs+=(v-Vm)*(v-Vm);
      }
      Hs=Math.sqrt(Hs/n); Ss=Math.sqrt(Ss/n); Vs=Math.sqrt(Vs/n);
      return new Float32Array([Hm/360,Sm,Vm,Hs/360,Ss,Vs]);
    }
    function lbpHist(c,sz=64){
      const t=document.createElement('canvas'); t.width=sz; t.height=sz;
      const g=t.getContext('2d'); g.drawImage(c,0,0,sz,sz);
      const D=g.getImageData(0,0,sz,sz).data; const hist=new Float32Array(256);
      const G=(x,y)=>{ const p=(y*sz+x)*4; return 0.2126*D[p]+0.7152*D[p+1]+0.0722*D[p+2]; };
      for(let y=1;y<sz-1;y++){
        for(let x=1;x<sz-1;x++){
          const c0=G(x,y);
          let code=0, i=0;
          [[-1,-1],[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0]].forEach(([dx,dy])=>{
            code |= (G(x+dx,y+dy)>=c0) ? (1<<i) : 0; i++;
          });
          hist[code]++;
        }
      }
      // تطبيع
      let s=0; for(let i=0;i<hist.length;i++) s+=hist[i]; s=s||1;
      for(let i=0;i<hist.length;i++) hist[i]/=s;
      return hist;
    }
    function hogLite(c,grid=8){ // تدرجات مبسطة
      const g=c.getContext('2d'); const {width:w,height:h}=c; const D=g.getImageData(0,0,w,h).data;
      const cx=w/grid, cy=h/grid; const bins=9; const hist=new Float32Array(grid*grid*bins);
      const at=(x,y)=>{ const p=(y*w+x)*4; const r=D[p], gg=D[p+1], b=D[p+2]; return 0.2126*r+0.7152*gg+0.0722*b; };
      for(let y=1;y<h-1;y++){
        for(let x=1;x<w-1;x++){
          const gx=at(x+1,y)-at(x-1,y), gy=at(x,y+1)-at(x,y-1);
          const mag=Math.hypot(gx,gy), ang=((Math.atan2(gy,gx)*180/Math.PI)+180)%180;
          const bx=Math.min(grid-1, Math.floor(x/cx));
          const by=Math.min(grid-1, Math.floor(y/cy));
          const bi=Math.floor(ang/(180/bins));
          hist[(by*grid+bx)*bins+bi]+=mag;
        }
      }
      // تطبيع
      let s=0; for(let i=0;i<hist.length;i++) s+=hist[i]; s=s||1;
      for(let i=0;i<hist.length;i++) hist[i]/=s;
      return hist;
    }

    function concatFeatures(...arrs){
      const total = arrs.reduce((a,v)=>a+v.length,0);
      const out = new Float32Array(total);
      let off=0; for(const v of arrs){ out.set(v,off); off+=v.length; }
      // تطبيع نهائي L2
      let n=0; for(let i=0;i<out.length;i++) n+=out[i]*out[i];
      n=Math.sqrt(n)||1; for(let i=0;i<out.length;i++) out[i]/=n;
      return out;
    }

    function imgToFeatureVec(img){
      // ROI مركزي + Gaussian + مجموعات الخصائص
      let c = cropROI(img, 192, 192);
      c = gaussianBlur(c);
      const gray = toGrayVec(c, 64);
      const color = hsvMoments(c);
      const lbp = lbpHist(c, 64);
      const hog = hogLite(c, 8);
      return concatFeatures(gray, color, lbp, hog);
    }

    async function loadRefVector(item){
      const candidates = item.urls || []; let i = 0;
      return new Promise(res=>{
        function tryNext(){
          if(i >= candidates.length){ console.warn('Ref not found', item); return res(null); }
          const url = candidates[i++];
          const img = new Image();
          try { const abs = new URL(url, location.href); if(abs.origin !== location.origin) img.crossOrigin = 'anonymous'; } catch {}
          img.onload = ()=> res({ score:item.score, vec: imgToFeatureVec(img) });
          img.onerror = tryNext;
          img.src = url;
        }
        tryNext();
      });
    }
    let __REFS_COUNT__=0; window.__REFS_COUNT__=0;
    const refVectorsPromise = Promise.all(REF_LIST.map(loadRefVector)).then(arr=>{
      const refs = arr.filter(Boolean);
      __REFS_COUNT__ = refs.length; window.__REFS_COUNT__ = __REFS_COUNT__;
      if(!refs.length && scoreNote){
        scoreNote.textContent = 'تنبيه: لم يتم تحميل الصور المرجعية — تأكد من وجود الملفات في www/images/ بالأسماء الصحيحة.';
      }
      return refs;
    });

    function cosine(a,b){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s; }
    function vectorForDataURL(dataUrl){ return new Promise(res=>{ const img=new Image(); img.onload=()=>res(imgToFeatureVec(img)); img.src=dataUrl; }); }

    async function scoreFeces(dataUrl){
      const refs=await refVectorsPromise; if(!refs.length) return 3.5;
      const vec=await vectorForDataURL(dataUrl);
      // تشابه مرجّح (متجه كامل بالفعل مُوحّد) → كوساين
      let best=null;
      for(const r of refs){ const sim=cosine(vec,r.vec); if(!best || sim>best.sim) best={score:r.score, sim}; }
      return best?best.score:3.5;
    }

    function renderFecesScore(s){
      if(window.__REFS_COUNT__===0){
        scoreBadge.textContent='غير محسوب — مراجع مفقودة';
        scoreFill.style.width='0%'; scoreFill.style.background='#facc15';
        scoreNote.textContent='لم يتم تحميل الصور المرجعية. تأكد من وجودها في www/images/';
        state.lastScore=null; window.fecesScore=null; return;
      }
      let label='';
      if(s<=1.5) label='إسهال';
      else if(s<=2.5) label='لين';
      else if(s<3.5) label='قريب للمثالي';
      else if(s===3.5) label='مثالي';
      else if(s<=4.5) label='صلب';
      else label='إمساك';
      scoreBadge.textContent=`${label} — ${s} / 5`;
      const pct=Math.min(100, Math.max(0, (s/5)*100));
      scoreFill.style.width=pct+'%';
      scoreFill.style.background = s===3.5 ? '#86efac' : '#7dd3fc';
      scoreNote.textContent='';
      state.lastScore = s; window.fecesScore = s;
    }

    // UI bindings
    window.addEventListener('resize', ()=>{ fitOverlay(); drawGuide(); });
    toggleFlash.addEventListener('click', async ()=>{ await (async()=>{ /* كفاية تعليق */ })(); await (async()=>{})(); toggleTorch(); });
    restartBtn.addEventListener('click', async ()=>{ await startCamera(cameraSelect.value); });
    cameraSelect.addEventListener('change', async ()=>{ await startCamera(cameraSelect.value); });

    function showUploadPreview(url){
      if(!uploadPreviewBox || !uploadPreviewImg) return;
      uploadPreviewImg.src = url;
      uploadPreviewBox.style.display = 'flex';
    }

    captureBtn.addEventListener('click', async ()=>{
      const url=dataURLFromVideo(); state.lastCapture=url; showUploadPreview(url);
      const s=await scoreFeces(url); renderFecesScore(s); retakeBtn.disabled=false;
    });
    retakeBtn.addEventListener('click', ()=>{
      state.lastCapture=null; renderFecesScore(3.5); retakeBtn.disabled=true;
      if(uploadPreviewBox) uploadPreviewBox.style.display='none';
    });
    if(uploadBtn) uploadBtn.addEventListener('click', ()=> uploadInput && uploadInput.click());
    if(uploadInput) uploadInput.addEventListener('change', async (e)=>{
      const f=e.target.files && e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=async ()=>{ const url=r.result; state.lastCapture=url; showUploadPreview(url);
        const s=await scoreFeces(url); renderFecesScore(s); retakeBtn.disabled=false; };
      r.readAsDataURL(f); uploadInput.value='';
    });

    // زر الرجوع إلى add-event مع تمرير السياق (المطلوب 5)
    backBtn.addEventListener('click', ()=>{
      const ctx=getAnimalFromContext();
      const params = new URLSearchParams();
      if(ctx.id) params.set('animalId', ctx.id);
      if(ctx.number) params.set('number', ctx.number);
      if(ctx.date) params.set('date', ctx.date);
      location.href = `add-event.html?${params.toString()}`;
    });

    // تهيئة الصفحة + ربط السياق (المطلوب 6 + 7)
    async function runDemo(){ const badge=$('#demoBadge'); if(badge) badge.style.display='inline-block';
      const demoRef='/www/images/3_5.jpg'; try{
        const img=new Image(); img.onload=async ()=>{ const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
          c.getContext('2d').drawImage(img,0,0); const url=c.toDataURL('image/jpeg',0.9); state.lastCapture=url; renderFecesScore(await scoreFeces(url)); showUploadPreview(url); };
        img.src=demoRef;
      }catch{ renderFecesScore(3.5); }
    }

    (async function init(){
      try{
        const ctx=getAnimalFromContext();
        if(animalIdInput) animalIdInput.value = ctx.id || '';
        if(eventDateInput) eventDateInput.value = ctx.date || todayCairo();
        if(numberSpan) numberSpan.textContent = ctx.number || (ctx.id ? `#${(ctx.id+'').slice(-5)}` : '—');

        if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){ alert('المتصفح لا يدعم تشغيل الكاميرا عبر الويب.'); }
        if(location.protocol!=='https:' && location.hostname!=='localhost'){ console.warn('يُنصح باستخدام https لتشغيل الكاميرا.'); }

        await startCamera(); await listCameras();
        if(!cameraSelect.value && cameraSelect.options.length){ cameraSelect.value=cameraSelect.options[0].value; }
        if(isDemo) runDemo();
        renderFecesScore(3.5); // قيمة أولية
      }catch(e){ console.warn(e); }
    })();
  </script>

  <!-- إزالة أي عنصر محرِّر -->
  <script>
    function nukeEditorCard(){ document.querySelectorAll('editor-card,.editor-card').forEach(n=>{ try{ n.remove(); }catch{} }); }
    new MutationObserver(nukeEditorCard).observe(document.documentElement,{childList:true,subtree:true});
    document.addEventListener('DOMContentLoaded', nukeEditorCard);
  </script>

  <!-- (المطلوب 4) ربط فايربيز: حفظ التقييم (الدرجة فقط) في Firestore — بدون حفظ الصور -->
<script type="module">
  import { db, auth, requireAuth } from "/js/firebase-config.js";
  import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  function todayCairo(){
    const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Africa/Cairo" }));
    const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,"0"), d = String(now.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }

  // وصف برمجي ثابت للسكور
  function fecesDesc(score){
    if (score <= 1.5) return "إسهال";
    if (score <= 2.5) return "لين";
    if (score <  3.5) return "قريب للمثالي";
    if (score === 3.5) return "مثالي";
    if (score <= 4.5) return "صلب";
    return "إمساك";
  }

  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("saveBtn");
    const eventDateInput = document.getElementById("eventDate");
    const animalIdHidden = document.getElementById("animalId");
    const msgBox = document.getElementById("saveMsg");

    if (eventDateInput && !eventDateInput.value) {
      eventDateInput.value = localStorage.getItem("currentEventDate") || todayCairo();
    }

    function showMsg(text, success=true) {
      if(!msgBox) return;
      msgBox.textContent = text;
      msgBox.style.display = "block";
      msgBox.style.background = success ? "#dcfce7" : "#fee2e2";
      msgBox.style.color = success ? "#166534" : "#991b1b";
      msgBox.style.border = success ? "1px solid #86efac" : "1px solid #fca5a5";
      setTimeout(()=>{ msgBox.style.display="none"; }, 4000);
    }

    btn?.addEventListener("click", async (e) => {
      e.preventDefault();
      if (btn.disabled) return;

      const score = Number(window.fecesScore ?? 0);
      if (!score) { showMsg("⚠️ التقط/ارفع صورة أولًا لاحتساب الدرجة.", false); return; }

      const oldText = btn.textContent;
      btn.disabled = true; btn.textContent = "جارٍ الحفظ…";

      const animalId     = (animalIdHidden?.value?.trim()) || localStorage.getItem("currentAnimalId") || "";
      const animalNumber = localStorage.getItem("currentAnimalNumber") || "";
      const eventDate    = (eventDateInput?.value) || localStorage.getItem("currentEventDate") || todayCairo();

     const userId  = auth.currentUser?.uid || null;
 const tenantId = localStorage.getItem("tenantId") || null;
      // لازم دخول عشان نمر الرولز ونكتب userId
try { 
  await requireAuth(); 
} catch {
  // نمرر السياق لصفحة الدخول ونرجع تلقائيًا
  const params = new URLSearchParams();
  const num = localStorage.getItem("currentAnimalNumber") || "";
  const dt  = eventDateInput?.value || localStorage.getItem("currentEventDate") || todayCairo();
  if (num) params.set("number", num);
  if (dt)  params.set("date", dt);
  location.href = "/login.html?next=" + encodeURIComponent(location.pathname + "?" + params.toString());
  return;
}

      try {
        await addDoc(collection(db, "events"), {
          type: "تقييم الروث بالكاميرا",
          eventType: "feces_eval",
          eventDate,
          eventDateUtc: new Date(eventDate + "T00:00:00Z").toISOString(),
          animalId,
          animalNumber,
          fecesScore: score,            // الرقم
          description: fecesDesc(score),// الوصف البرمجي
          value: score,                 // نفس الرقم لتوحيد التقارير
          userId,                       // مهم لتمرير الرولز
          uid: userId,                  // (اختياري) للتوافق مع أي كود قديم
          tenantId,
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC",
          source: location.href,
          createdAt: serverTimestamp()
        });
       showMsg("✅ تم حفظ تقييم الروث بنجاح", true);
       setTimeout(()=>{
       const params = new URLSearchParams();
       if (animalId)     params.set("animalId", animalId);
       if (animalNumber) params.set("number",   animalNumber);
       if (eventDate)    params.set("date",     eventDate);
       location.href = "add-event.html?" + params.toString();
       }, 900);
      } catch (err) {
        console.error("Firestore save error:", err);
        showMsg("❌ حدث خطأ أثناء الحفظ", false);
      } finally {
        btn.disabled = false; btn.textContent = oldText;
      }
    });
  });
</script>
