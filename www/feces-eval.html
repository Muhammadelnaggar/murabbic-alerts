<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تقييم الروث بالكاميرا — مُرَبِّك</title>
  <style>
    :root{
      --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff; --danger:#c2410c;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Segoe UI','Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid #e2e8f0;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .title{font-weight:800;color:var(--green);margin:0}
    .badge{background:#e6f8ef;color:var(--green-600);padding:4px 8px;border-radius:999px;font-size:12px}
    .container{max-width:800px;margin:16px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}

    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:12px}
    .controls .select,.controls .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px}
    .controls .btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:700;min-height:44px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .btn-primary{background:var(--green);color:#fff}
    .btn-light{background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .preview-wrap{position:relative;border-radius:16px;overflow:hidden;background:#000}
    video#preview{width:100%;height:auto;display:block;background:#000}
    canvas#overlay{position:absolute;inset:0;pointer-events:none}

    .results{padding:12px;border-top:1px solid #e2e8f0;display:grid;gap:10px}
    .score{display:grid;gap:10px;padding:8px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
    .score-badge{display:inline-block;padding:6px 10px;border:1px solid transparent;border-radius:999px;font-weight:800;width:max-content}
    .score-bar{height:10px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;overflow:hidden}
    .score-bar .fill{height:100%}
    .score-note{color:var(--muted);font-weight:700}

    editor-card,.editor-card{pointer-events:none !important;opacity:0 !important;visibility:hidden !important;position:static !important;z-index:-1 !important}
    header,.container,#cameraCard{position:relative;z-index:1}

    .save-bar{display:flex;gap:8px;align-items:center;padding:12px;border-top:1px solid #e2e8f0}
    .save-bar .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px}

    .save-bar{display:grid;grid-template-columns:1fr;gap:10px;align-items:stretch}
    .save-bar .btn{width:100%}
    @media (min-width: 640px){ .save-bar{grid-template-columns:1fr} }

    html, body { overflow-x: hidden; }
    .container { max-width: 880px; margin: 16px auto; padding: 0 16px; }
  </style>
</head>
<body>
  <header>
    <h1 class="title">تقييم الروث بالكاميرا</h1>
    <span class="badge">مُرَبِّك</span>
    <span class="badge" id="demoBadge" style="display:none;background:#fff3cd;color:#92400e;border:1px solid #facc15">وضع العرض</span>
    <div style="margin-inline-start:auto;color:var(--muted);font-weight:700">رقم الحيوان: <span class="animal-number">—</span></div>
  </header>

  <div class="container">
    <section class="card" id="cameraCard">
      <div class="controls">
        <select id="cameraSelect" class="select" title="اختيار الكاميرا"></select>
        <button id="demoBtn" class="btn btn-light" title="تشغيل وضع العرض">وضع العرض</button>
        <button id="toggleFlash" class="btn btn-light" title="تشغيل الفلاش" aria-pressed="false">الفلاش</button>
        <button id="restartBtn" class="btn btn-light">إعادة التهيئة</button>
        <div style="margin-inline-start:auto"></div>
        <button id="captureBtn" class="btn btn-primary">التقاط</button>
        <button id="retakeBtn" class="btn btn-danger" disabled>إعادة الالتقاط</button>
        <button id="uploadBtn" class="btn btn-light">رفع صورة بديلة</button>
        <input id="uploadInput" type="file" accept="image/*" style="display:none" />
      </div>

      <div class="preview-wrap">
        <video id="preview" playsinline autoplay muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="results" id="resultsBox">
        <h3 style="margin:8px 0;color:var(--green-600)">النتيجة</h3>
        <div id="scoreWidget" class="score">
          <div class="score-badge" id="scoreBadge">—</div>
          <div class="score-bar"><div class="fill" id="scoreFill" style="width:0%"></div></div>
          <div class="score-note" id="scoreNote">التقط/ارفع صورة لعرض درجة الروث (1=إسهال … 5=إمساك، المثالي ~ 3.5).</div>
        </div>
      </div>

      <div class="save-bar">
        <input type="hidden" id="animalId" />
        <label style="display:flex;gap:8px;align-items:center">تاريخ التقييم
          <input type="date" id="eventDate" class="input" />
        </label>
        <div style="margin-inline-start:auto"></div>
        <button id="backBtn" class="btn btn-light">رجوع لصفحة الأحداث</button>
        <button id="saveBtn" class="btn btn-primary">حفظ التقييم</button>
      </div>
    </section>
  </div>

  <script src="js/mbk-animals.js?v=2"></script>

  <script type="module">
    const qs = new URLSearchParams(location.search);
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>[...p.querySelectorAll(s)];
    const isDemo = qs.get('demo')==='1' || qs.get('mode')==='demo';

    function todayCairo(){
      const now=new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'}));
      const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function getAnimalFromContext(){
      const id=qs.get('animalId')||localStorage.getItem('currentAnimalId')||'';
      const number=qs.get('number')||localStorage.getItem('currentAnimalNumber')||'';
      const date=qs.get('date')||sessionStorage.getItem('currentEventDate')||localStorage.getItem('currentEventDate')||todayCairo();
      if(id) localStorage.setItem('currentAnimalId',id);
      if(number) localStorage.setItem('currentAnimalNumber',number);
      if(date){ localStorage.setItem('currentEventDate',date); sessionStorage.setItem('currentEventDate',date); }
      return {id,number,date};
    }

    const preview=$('#preview'), overlay=$('#overlay'), cameraSelect=$('#cameraSelect');
    const toggleFlash=$('#toggleFlash'), restartBtn=$('#restartBtn');
    const captureBtn=$('#captureBtn'), retakeBtn=$('#retakeBtn');
    const uploadBtn=$('#uploadBtn'), uploadInput=$('#uploadInput');
    const scoreBadge=$('#scoreBadge'), scoreFill=$('#scoreFill'), scoreNote=$('#scoreNote');
    const saveBtn=$('#saveBtn'), animalIdInput=$('#animalId'), eventDateInput=$('#eventDate');
    const backBtn=$('#backBtn');
    const numberSpan=$('.animal-number');

    const state={ stream:null, track:null, capabilities:null, torchOn:false, lastCapture:null, lastScore:null };
    window.state = state; // في حال احتجته سكربت آخر

    function fitOverlay(){ const r=preview.getBoundingClientRect(); overlay.width=r.width*devicePixelRatio; overlay.height=r.height*devicePixelRatio; overlay.style.width=r.width+'px'; overlay.style.height=r.height+'px'; }
    function drawGuide(){ const g=overlay.getContext('2d'); if(!g) return; const w=overlay.width,h=overlay.height; g.clearRect(0,0,w,h);
      g.strokeStyle='rgba(255,255,255,.35)'; g.lineWidth=1*devicePixelRatio;
      for(let i=1;i<3;i++){ g.beginPath(); g.moveTo((w/3)*i,0); g.lineTo((w/3)*i,h); g.stroke(); g.beginPath(); g.moveTo(0,(h/3)*i); g.lineTo(w,(h/3)*i); g.stroke(); }
      g.strokeStyle='rgba(14,160,90,.9)'; g.lineWidth=4*devicePixelRatio; const rx=w*.18, ry=h*.18, rw=w*.64, rh=h*.64;
      if(g.roundRect){ g.beginPath(); g.roundRect(rx,ry,rw,rh,20*devicePixelRatio); g.stroke(); } else { g.strokeRect(rx,ry,rw,rh); }
    }

    async function listCameras(){ const devs=await navigator.mediaDevices.enumerateDevices(); const cams=devs.filter(d=>d.kind==='videoinput'); cameraSelect.innerHTML=''; cams.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.deviceId; o.textContent=c.label||`كاميرا ${i+1}`; cameraSelect.appendChild(o); }); return cams; }
    async function startCamera(deviceId){
      if(state.stream){ state.stream.getTracks().forEach(t=>t.stop()); }
      const cs=deviceId?{video:{deviceId:{exact:deviceId}}}:{video:{facingMode:{ideal:'environment'}}};
      const stream=await navigator.mediaDevices.getUserMedia(cs);
      state.stream=stream; preview.srcObject=stream;
      const [track]=stream.getVideoTracks(); state.track=track; state.capabilities=track.getCapabilities?.()||null;
      await preview.play(); fitOverlay(); drawGuide(); populateTorchSupport();
    }
    function populateTorchSupport(){ const cap=state.capabilities; toggleFlash.disabled=!(cap&&'torch' in cap); }
    async function toggleTorch(){ try{ if(!state.track) return; state.torchOn=!state.torchOn; await state.track.applyConstraints({advanced:[{torch:state.torchOn}]}); toggleFlash.setAttribute('aria-pressed',String(state.torchOn)); toggleFlash.textContent=state.torchOn?'الفلاش: يعمل':'الفلاش'; }catch(e){ console.warn('Torch not supported',e); } }

    function dataURLFromVideo(){ const c=document.createElement('canvas'); const w=preview.videoWidth,h=preview.videoHeight; c.width=w; c.height=h; c.getContext('2d').drawImage(preview,0,0,w,h); return c.toDataURL('image/jpeg',0.92); }

    /* ==== مراجع الصور: داخل www/images/ ==== */
    const REF_BASES = ['www/images/']; // كما طلبت بالضبط
    const REF_EXTS  = ['jpg','jpeg','png','webp','JPG','JPEG','PNG','WEBP'];
    const REF_NAMES = [
      {score:1,   names:['1']},
      {score:2,   names:['2']},
      {score:3,   names:['3']},
      {score:3.5, names:['3_5','3.5']},
      {score:4,   names:['4']},
      {score:5,   names:['5']}
    ];
    const REF_LIST = REF_NAMES.flatMap(({score,names}) =>
      names.map(name => ({ score, urls: REF_BASES.flatMap(base => REF_EXTS.map(ext => `${base}${name}.${ext}`)) }))
    );

    function imgToVec(img){ const w=64,h=64; const c=document.createElement('canvas'); c.width=w; c.height=h; const g=c.getContext('2d'); g.drawImage(img,0,0,w,h); const d=g.getImageData(0,0,w,h).data; const v=new Float32Array(w*h); let k=0; for(let i=0;i<d.length;i+=4){ v[k++]=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; } let mean=0; for(let i=0;i<v.length;i++) mean+=v[i]; mean/=v.length; let norm=0; for(let i=0;i<v.length;i++){ v[i]-=mean; norm+=v[i]*v[i]; } norm=Math.sqrt(norm)||1; for(let i=0;i<v.length;i++) v[i]/=norm; return v; }
    function loadRefVector(item){
      const candidates=item.urls||[]; let i=0;
      return new Promise(res=>{
        function next(){ if(i>=candidates.length){ console.warn('Ref not found for', item.score, item.urls); return res(null); }
          const url=candidates[i]; const img=new Image();
          try{ const abs=new URL(url, location.href); if(abs.origin!==location.origin) img.crossOrigin='anonymous'; }catch{}
          img.onload=()=>res({score:item.score, vec:imgToVec(img)}); img.onerror=()=>{ i++; next(); }; img.src=url;
        } next();
      });
    }
    let __REFS_COUNT__=0; window.__REFS_COUNT__=0;
    const refVectorsPromise = Promise.all(REF_LIST.map(loadRefVector)).then(arr=>{
      const refs=arr.filter(Boolean); __REFS_COUNT__=refs.length; window.__REFS_COUNT__=__REFS_COUNT__;
      if(!refs.length && scoreNote){ scoreNote.textContent='تنبيه: لم يتم تحميل الصور المرجعية — تأكد من وجود الملفات في www/images/ (خصوصًا 3_5).'; }
      return refs;
    });

    function cosine(a,b){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s; }
    function vectorForDataURL(dataUrl){ return new Promise(res=>{ const img=new Image(); img.onload=()=>res(imgToVec(img)); img.src=dataUrl; }); }
    async function scoreFeces(dataUrl){ const refs=await refVectorsPromise; if(!refs.length) return 3.5; const vec=await vectorForDataURL(dataUrl); let best=null; for(const r of refs){ const sim=cosine(vec,r.vec); if(!best||sim>best.sim) best={score:r.score,sim}; } return best?best.score:3.5; }

    function renderFecesScore(s){
      if(window.__REFS_COUNT__===0){
        scoreBadge.textContent='غير محسوب — مراجع مفقودة';
        scoreFill.style.width='0%'; scoreFill.style.background='#facc15';
        scoreNote.textContent='لم يتم تحميل الصور المرجعية. تأكد من وجودها في www/images/';
        state.lastScore=null; return;
      }
      let label=''; if(s<=1.5) label='إسهال'; else if(s<=2.5) label='لين'; else if(s<3.5) label='قريب للمثالي'; else if(s===3.5) label='مثالي'; else if(s<=4.5) label='صلب'; else label='إمساك';
      scoreBadge.textContent=`${label} — ${s} / 5`;
      const pct=Math.min(100, Math.max(0,(s/5)*100)); scoreFill.style.width=pct+'%';
      scoreFill.style.background = s===3.5 ? '#86efac' : '#7dd3fc'; scoreNote.textContent='';
      state.lastScore=s;
    }

    /* ربط الواجهات */
    window.addEventListener('resize', ()=>{ fitOverlay(); drawGuide(); });
    toggleFlash.addEventListener('click', toggleTorch);
    restartBtn.addEventListener('click', async ()=>{ await startCamera(cameraSelect.value); });
    cameraSelect.addEventListener('change', async ()=>{ await startCamera(cameraSelect.value); });

    captureBtn.addEventListener('click', async ()=>{ const url=dataURLFromVideo(); state.lastCapture=url; const s=await scoreFeces(url); renderFecesScore(s); retakeBtn.disabled=false; });
    retakeBtn.addEventListener('click', ()=>{ state.lastCapture=null; renderFecesScore(3.5); retakeBtn.disabled=true; });

    /* تفعيل زر "رفع صورة بديلة" */
    if(uploadBtn && uploadInput){
      uploadBtn.addEventListener('click', ()=> uploadInput.click());
      uploadInput.addEventListener('change', async (e)=>{
        const f=e.target.files && e.target.files[0]; if(!f) return;
        const r=new FileReader();
        r.onload=async ()=>{ const url=r.result; state.lastCapture=url; const s=await scoreFeces(url); renderFecesScore(s); retakeBtn.disabled=false; };
        r.readAsDataURL(f); e.target.value='';
      });
    }

    /* زر الرجوع إلى add-event.html */
    backBtn?.addEventListener('click', ()=>{
      const ctx=getAnimalFromContext();
      const u=new URL('add-event.html', location.origin);
      if(ctx.date) u.searchParams.set('date', ctx.date);
      const id=localStorage.getItem('currentAnimalId') || animalIdInput?.value || '';
      if(id) u.searchParams.set('animalId', id);
      location.href=u.toString();
    });

    /* حفظ على فايرستور */
    if(saveBtn) saveBtn.addEventListener('click', async ()=>{
      try{
        if(state.lastScore==null){ alert('التقط أو ارفع صورة أولاً لاحتساب الدرجة.'); return; }
        saveBtn.disabled=true; const txt=saveBtn.textContent; saveBtn.textContent='جارٍ الحفظ…';

        const ctx=getAnimalFromContext();
        if(animalIdInput) animalIdInput.value = animalIdInput.value || ctx.id || '';
        if(eventDateInput) eventDateInput.value = eventDateInput.value || ctx.date || todayCairo();

        const animalId=(animalIdInput && animalIdInput.value.trim()) || ctx.id || 'unknown';
        const date=(eventDateInput && eventDateInput.value) || ctx.date || todayCairo();

        if(isDemo){
          localStorage.setItem('murabbik_feces_demo_last', JSON.stringify({
            type:'تقييم الروث بالكاميرا (عرض)', animalId, date,
            fecesScore: state.lastScore, captured: state.lastCapture, createdAt: Date.now()
          }));
          alert('تم الحفظ محليًا (وضع العرض).');
          return;
        }

        const { db, storage, serverTimestamp, addDoc, collection, ref, uploadString, getDownloadURL } =
          await import('/js/firebase-config.js');

        let imageUrl=null;
        if(state.lastCapture){
          try{
            const path=`feces-evaluations/${animalId}/${date}/feces.jpg`;
            const r=ref(storage, path);
            await uploadString(r, state.lastCapture, 'data_url');
            imageUrl=await getDownloadURL(r);
          }catch(e){ console.warn('Upload failed, saving without image', e); }
        }

        await addDoc(collection(db,'events'), {
          type:'تقييم الروث بالكاميرا',
          eventType:'feces_eval',
          eventDate:date,
          animalId,
          fecesScore:Number(state.lastScore),
          image: imageUrl || null,
          source: location.pathname,
          createdAt: serverTimestamp()
        });

        alert(imageUrl ? 'تم الحفظ ورفع الصورة.' : 'تم الحفظ (بدون صورة).');
      }catch(err){
        console.error('Firestore save error:', err);
        alert('تعذّر الحفظ السحابي؛ تم الحفظ محليًا.');
        try{
          const ctx=getAnimalFromContext();
          localStorage.setItem('murabbik_feces_last', JSON.stringify({
            animalId: ctx.id || 'unknown',
            date: ctx.date || todayCairo(),
            score: state.lastScore,
            captured: state.lastCapture,
            at: Date.now()
          }));
        }catch{}
      }finally{
        saveBtn.disabled=false; saveBtn.textContent='حفظ التقييم';
      }
    });

    /* init */
    (async function init(){
      try{
        const ctx=getAnimalFromContext();
        if(animalIdInput) animalIdInput.value = ctx.id || '';
        if(eventDateInput) eventDateInput.value = ctx.date || todayCairo();
        if(numberSpan) numberSpan.textContent = ctx.number || (ctx.id ? `#${ctx.id.slice(-5)}` : '—');

        if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){ alert('المتصفح لا يدعم تشغيل الكاميرا عبر الويب.'); return; }
        if(location.protocol!=='https:' && location.hostname!=='localhost'){ console.warn('يُنصح باستخدام https لتشغيل الكاميرا.'); }
        await startCamera(); await listCameras(); if(!cameraSelect.value && cameraSelect.options.length){ cameraSelect.value=cameraSelect.options[0].value; }
        if(isDemo){
          const demoRef='www/images/3_5.jpg';
          const img=new Image(); img.onload=async ()=>{ const c=document.createElement('canvas'); c.width=img.width; c.height=img.height; c.getContext('2d').drawImage(img,0,0); const url=c.toDataURL('image/jpeg',0.9); state.lastCapture=url; renderFecesScore(await scoreFeces(url)); }; img.src=demoRef;
        }
      }catch(e){ console.warn(e); }
    })();
  </script>

  <script>
    function nukeEditorCard(){ document.querySelectorAll('editor-card,.editor-card').forEach(n=>{ try{ n.remove(); }catch{} }); }
    new MutationObserver(nukeEditorCard).observe(document.documentElement,{childList:true,subtree:true});
    document.addEventListener('DOMContentLoaded', nukeEditorCard);
  </script>
</body>
</html>
