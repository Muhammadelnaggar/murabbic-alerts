<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تقييم حالة الجسم (BCS) بالكاميرا — مُرَبِّك</title>
  <style>
    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff; --danger:#c2410c; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Segoe UI','Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid #e2e8f0;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .title{font-weight:800;color:var(--green);margin:0}
    .badge{background:#e6f8ef;color:var(--green-600);padding:4px 8px;border-radius:999px;font-size:12px}
    .container{max-width:880px;margin:16px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}

    .angles{display:flex;gap:8px;padding:12px;border-bottom:1px solid #e2e8f0}
    .angle-tab{padding:10px 12px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:700;min-height:44px}
    .angle-tab.active{background:var(--green);color:#fff;border-color:var(--green)}

    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px}
    .controls .select,.controls .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px}
    .controls .btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:700;min-height:44px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .btn-primary{background:var(--green);color:#fff}
    .btn-light{background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .preview-wrap{position:relative;border-radius:16px;overflow:hidden;background:#000;aspect-ratio:4/3;max-height:56vh}
    video#preview{width:100%;height:100%;display:block;background:#000;object-fit:cover}
    canvas#overlay{position:absolute;inset:0;pointer-events:none}

    .thumbs{display:flex;gap:8px;padding:8px;border-top:1px solid #e2e8f0;flex-wrap:nowrap;overflow-x:auto;scroll-snap-type:x mandatory}
    .thumb{width:56px;height:56px;border-radius:12px;overflow:hidden;border:2px solid #e2e8f0;background:#f8fafc;position:relative;flex:0 0 auto;scroll-snap-align:start}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .label{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.5);color:#fff;font-size:11px;text-align:center}

    .results{padding:12px;border-top:1px solid #e2e8f0;display:grid;gap:10px}
    .score{display:grid;gap:8px;padding:8px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
    .score-badge{display:inline-block;padding:6px 10px;border:1px solid transparent;border-radius:999px;font-weight:800;width:max-content}
    .score-bar{height:10px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;overflow:hidden}
    .score-bar .fill{height:100%}
    .score-note{color:var(--muted);font-weight:700}

    .save-bar{display:flex;gap:8px;align-items:center;padding:12px;border-top:1px solid #e2e8f0}
    .save-bar .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px}

    #saveBtn{
      padding:16px 20px;
      font-size:18px;
      border-radius:14px;
      width:100%;
      max-width:100%;
    }

    /* شريط نوع الحيوان + القائمة جنب بعض */
    .kind-card{padding:8px}
    .kind-grid{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center}
    @media(max-width:560px){.kind-grid{grid-template-columns:1fr 1fr}}

    /* شبكة تحكم مضغوطة */
    .controls.controls-grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .controls-grid .left{display:flex;gap:8px;align-items:center}
    .controls-grid .right{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    @media(min-width:860px){.controls-grid .right{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .btn-lg{padding:14px 18px;font-size:18px}
    @media(max-width:560px){
      .controls.controls-grid{grid-template-columns:1fr}
      .controls-grid .right{justify-content:stretch}
      .controls .btn, .controls .select{width:100%}
      #captureBtn{order:-1}
    }
    #cameraCard .controls{position:sticky;top:56px;z-index:5;background:var(--card);border-bottom:1px solid #e2e8f0}
  </style>
</head>
<body>
  <header>
    <h1 class="title">BCS تقييم حالة الجسم بالكاميرا</h1>
    <span class="badge">مُرَبِّك</span>
    <span class="badge" id="demoBadge" style="display:none;background:#fff3cd;color:#92400e;border:1px solid #facc15">وضع العرض</span>
    <div style="margin-inline-start:auto;color:var(--muted);font-weight:700">رقم الحيوان: <span class="animal-number">—</span></div>
  </header>

  <div class="container">

    <!-- نوع الحيوان -->
    <section class="card kind-card">
      <div class="kind-grid">
        <div role="radiogroup" aria-label="نوع الحيوان" style="display:flex;gap:12px;align-items:center">
          <label style="display:flex;gap:6px;align-items:center"><input type="radio" name="animalKind" id="kindCow" value="cow"> أبقار</label>
          <label style="display:flex;gap:6px;align-items:center"><input type="radio" name="animalKind" id="kindBuffalo" value="buffalo"> جاموس</label>
        </div>
        <select id="animalType" class="select" title="التصنيف"></select>
      </div>
    </section>

    <section class="card" id="cameraCard">
      <div class="angles">
        <button class="angle-tab active" data-angle="rear">لقطة خلفية</button>
        <button class="angle-tab" data-angle="side">لقطة جانبية</button>
      </div>

      <div class="controls controls-grid">
        <div class="left">
          <button id="captureBtn" class="btn btn-primary btn-lg">التقاط</button>
          <button id="retakeBtn" class="btn btn-danger" disabled>إعادة الالتقاط</button>
        </div>
        <div class="right">
          <select id="cameraSelect" class="select" title="اختيار الكاميرا"></select>
          <button id="toggleFlash" class="btn btn-light" title="تشغيل الفلاش" aria-pressed="false">الفلاش</button>
          <button id="restartBtn" class="btn btn-light">إعادة التهيئة</button>
          <button id="uploadBtn" class="btn btn-light">رفع صورة بديلة</button>
          <input id="uploadInput" type="file" accept="image/*" style="display:none" />
          <button id="nextAngleBtn" class="btn btn-light">التالي ▸</button>
          <button id="demoBtn" class="btn btn-light" title="تشغيل وضع العرض">وضع العرض</button>
        </div>
      </div>

      <div class="preview-wrap">
        <video id="preview" playsinline autoplay muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="thumbs" id="thumbs"></div>

      <div class="results">
        <h3 style="margin:8px 0;color:var(--green-600)">النتيجة</h3>
        <div id="scoreWidget" class="score">
          <div class="score-badge" id="scoreBadge">—</div>
          <div class="score-bar"><div class="fill" id="scoreFill" style="width:0%"></div></div>
          <div class="score-note" id="scoreNote">المدى يعتمد على النوع.</div>
        </div>
      </div>

      <div class="save-bar">
        <input type="hidden" id="animalId" />
        <label style="display:flex;gap:8px;align-items:center">تاريخ التقييم
          <input type="date" id="eventDate" class="input" />
        </label>
        <div style="margin-inline-start:auto"></div>
        <button id="saveBtn" class="btn btn-primary">حفظ التقييم</button>
      </div>
    </section>
  </div>
  <!-- باقي السكربتات كما هي بدون تغيير -->
   <!-- تشغيل الكاميرا فقط (بدون أي تغيير في التصميم) -->
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const preview = document.getElementById('preview');
    const overlay = document.getElementById('overlay');
    const cameraSelect = document.getElementById('cameraSelect');
    const toggleFlash = document.getElementById('toggleFlash');
    const restartBtn  = document.getElementById('restartBtn');

    const state = { stream:null, track:null, caps:null, torchOn:false };

    function fitOverlay(){
      if(!preview || !overlay) return;
      const r = preview.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      overlay.width  = Math.max(1, Math.floor(r.width  * dpr));
      overlay.height = Math.max(1, Math.floor(r.height * dpr));
      overlay.style.width  = r.width + 'px';
      overlay.style.height = r.height + 'px';
    }
    function drawGuide(){
      const g = overlay.getContext('2d'); if(!g) return;
      const w=overlay.width, h=overlay.height; g.clearRect(0,0,w,h);
      const dpr = window.devicePixelRatio || 1;
      g.strokeStyle='rgba(255,255,255,.35)'; g.lineWidth=1*dpr;
      for(let i=1;i<3;i++){ g.beginPath(); g.moveTo((w/3)*i,0); g.lineTo((w/3)*i,h); g.stroke();
                            g.beginPath(); g.moveTo(0,(h/3)*i); g.lineTo(w,(h/3)*i); g.stroke(); }
      g.strokeStyle='rgba(14,160,90,.9)'; g.lineWidth=4*dpr;
      const rx=w*.2, ry=h*.45, rw=w*.6, rh=h*.35;
      if(g.roundRect){ g.beginPath(); g.roundRect(rx,ry,rw,rh,20*dpr); g.stroke(); } else { g.strokeRect(rx,ry,rw,rh); }
    }

    async function listCameras(){
      try{
        const devs = await navigator.mediaDevices.enumerateDevices();
        const cams = devs.filter(d=>d.kind==='videoinput');
        if (cameraSelect) {
          cameraSelect.innerHTML='';
          cams.forEach((c,i)=>{
            const o=document.createElement('option');
            o.value=c.deviceId;
            o.textContent=c.label||`كاميرا ${i+1}`;
            cameraSelect.appendChild(o);
          });
        }
        return cams;
      }catch(e){ console.warn('enumerateDevices failed', e); return []; }
    }

    async function startCamera(deviceId){
      try{
        if(state.stream){ try{ state.stream.getTracks().forEach(t=>t.stop()); }catch{} }
        const constraints = deviceId
          ? { video:{ deviceId:{ exact: deviceId } } }
          : { video:{ facingMode:{ ideal:'environment' } } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        state.stream = stream;
        const [track] = stream.getVideoTracks();
        state.track = track;
        state.caps  = (track.getCapabilities && track.getCapabilities()) || null;

        if(preview){ preview.srcObject = stream; await (preview.play?.()); }
        fitOverlay(); drawGuide();

        if(toggleFlash) toggleFlash.disabled = !(state.caps && 'torch' in state.caps);
      }catch(err){
        console.error('Camera init error:', err);
        alert('تعذّر فتح الكاميرا. تأكد من الإذن وبروتوكول HTTPS.');
      }
    }

    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      alert('المتصفح لا يدعم تشغيل الكاميرا عبر الويب.');
      return;
    }
    if(location.protocol!=='https:' && location.hostname!=='localhost'){
      console.warn('يفضّل استخدام HTTPS لتشغيل الكاميرا.');
    }

    await startCamera();
    await listCameras();

    window.addEventListener('resize', ()=>{ fitOverlay(); drawGuide(); });
    cameraSelect?.addEventListener('change', ()=> startCamera(cameraSelect.value));
    restartBtn?.addEventListener('click', ()=> startCamera(cameraSelect.value));
    toggleFlash?.addEventListener('click', async ()=>{
      try{
        if(!state.track) return;
        state.torchOn = !state.torchOn;
        await state.track.applyConstraints({ advanced:[{ torch: state.torchOn }] });
        toggleFlash.setAttribute('aria-pressed', String(state.torchOn));
      }catch(e){ console.warn('Torch not supported', e); }
    });
  });
</script>

</body>
</html>
