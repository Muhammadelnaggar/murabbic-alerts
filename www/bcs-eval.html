<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ØªÙ‚ÙŠÙŠÙ… Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ù… (BCS) Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</title>
  <style>
    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff; --danger:#c2410c; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Segoe UI','Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid #e2e8f0;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .title{font-weight:800;color:var(--green);margin:0}
    .badge{background:#e6f8ef;color:var(--green-600);padding:4px 8px;border-radius:999px;font-size:12px}
    .container{max-width:880px;margin:16px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}

    .angles{display:flex;gap:8px;padding:12px;border-bottom:1px solid #e2e8f0}
    .angle-tab{padding:10px 12px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:700;min-height:44px}
    .angle-tab.active{background:var(--green);color:#fff;border-color:var(--green)}

    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px}
    .controls .select,.controls .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px}
    .controls .btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:700;min-height:44px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .btn-primary{background:var(--green);color:#fff}
    .btn-light{background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .preview-wrap{position:relative;border-radius:16px;overflow:hidden;background:#000;aspect-ratio:4/3;max-height:56vh}
    video#preview{width:100%;height:100%;display:block;background:#000;object-fit:cover}
    canvas#overlay{position:absolute;inset:0;pointer-events:none}

    .thumbs{display:flex;gap:8px;padding:8px;border-top:1px solid #e2e8f0;flex-wrap:nowrap;overflow-x:auto;scroll-snap-type:x mandatory}
    .thumb{width:56px;height:56px;border-radius:12px;overflow:hidden;border:2px solid #e2e8f0;background:#f8fafc;position:relative;flex:0 0 auto;scroll-snap-align:start}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .label{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.5);color:#fff;font-size:11px;text-align:center}

    .results{padding:12px;border-top:1px solid #e2e8f0;display:grid;gap:10px}
    .score{display:grid;gap:8px;padding:8px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
    .score-badge{display:inline-block;padding:6px 10px;border:1px solid transparent;border-radius:999px;font-weight:800;width:max-content}
    .score-bar{height:10px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;overflow:hidden}
    .score-bar .fill{height:100%}
    .score-note{color:var(--muted);font-weight:700}

    .save-bar{display:flex;gap:8px;align-items:center;padding:12px;border-top:1px solid #e2e8f0}
    .save-bar .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px}

    /* Ø´Ø±ÙŠØ· Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù† + Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶ */
    .kind-card{padding:8px}
    .kind-grid{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center}
    @media(max-width:560px){.kind-grid{grid-template-columns:1fr 1fr}}

    /* Ø´Ø¨ÙƒØ© ØªØ­ÙƒÙ… Ù…Ø¶ØºÙˆØ·Ø© */
    .controls.controls-grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .controls-grid .left{display:flex;gap:8px;align-items:center}
    .controls-grid .right{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    @media(min-width:860px){.controls-grid .right{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .btn-lg{padding:14px 18px;font-size:18px}
    @media(max-width:560px){
      .controls.controls-grid{grid-template-columns:1fr}
      .controls-grid .right{justify-content:stretch}
      .controls .btn, .controls .select{width:100%}
      #captureBtn{order:-1}
    }
    #cameraCard .controls{position:sticky;top:56px;z-index:5;background:var(--card);border-bottom:1px solid #e2e8f0}
  </style>
</head>
<body>
  <header>
    <h1 class="title">BCS ØªÙ‚ÙŠÙŠÙ… Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h1>
    <span class="badge">Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</span>
    <span class="badge" id="demoBadge" style="display:none;background:#fff3cd;color:#92400e;border:1px solid #facc15">ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶</span>
    <div style="margin-inline-start:auto;color:var(--muted);font-weight:700">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†: <span class="animal-number">â€”</span></div>
  </header>

  <div class="container">

    <!-- Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù† -->
    <section class="card kind-card">
      <div class="kind-grid">
        <div role="radiogroup" aria-label="Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†" style="display:flex;gap:12px;align-items:center">
          <label style="display:flex;gap:6px;align-items:center"><input type="radio" name="animalKind" id="kindCow" value="cow"> Ø£Ø¨Ù‚Ø§Ø±</label>
          <label style="display:flex;gap:6px;align-items:center"><input type="radio" name="animalKind" id="kindBuffalo" value="buffalo"> Ø¬Ø§Ù…ÙˆØ³</label>
        </div>
        <select id="animalType" class="select" title="Ø§Ù„ØªØµÙ†ÙŠÙ"></select>
      </div>
    </section>

    <section class="card" id="cameraCard">
      <div class="angles">
        <button class="angle-tab active" data-angle="rear">Ù„Ù‚Ø·Ø© Ø®Ù„ÙÙŠØ©</button>
        <button class="angle-tab" data-angle="side">Ù„Ù‚Ø·Ø© Ø¬Ø§Ù†Ø¨ÙŠØ©</button>
      </div>

      <div class="controls controls-grid">
        <div class="left">
          <button id="captureBtn" class="btn btn-primary btn-lg">Ø§Ù„ØªÙ‚Ø§Ø·</button>
          <button id="retakeBtn" class="btn btn-danger" disabled>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·</button>
        </div>
        <div class="right">
          <select id="cameraSelect" class="select" title="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"></select>
          <button id="toggleFlash" class="btn btn-light" title="ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´" aria-pressed="false">Ø§Ù„ÙÙ„Ø§Ø´</button>
          <button id="restartBtn" class="btn btn-light">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</button>
          <button id="uploadBtn" class="btn btn-light">Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¨Ø¯ÙŠÙ„Ø©</button>
          <input id="uploadInput" type="file" accept="image/*" style="display:none" />
          <button id="nextAngleBtn" class="btn btn-light">Ø§Ù„ØªØ§Ù„ÙŠ â–¸</button>
          <button id="demoBtn" class="btn btn-light" title="ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶">ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶</button>
        </div>
      </div>

      <div class="preview-wrap">
        <video id="preview" playsinline autoplay muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="thumbs" id="thumbs"></div>

      <div class="results">
        <h3 style="margin:8px 0;color:var(--green-600)">Ø§Ù„Ù†ØªÙŠØ¬Ø©</h3>
        <div id="scoreWidget" class="score">
          <div class="score-badge" id="scoreBadge">â€”</div>
          <div class="score-bar"><div class="fill" id="scoreFill" style="width:0%"></div></div>
          <div class="score-note" id="scoreNote">Ø§Ù„Ù…Ø¯Ù‰ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹.</div>
        </div>
      </div>

      <div class="save-bar">
        <input type="hidden" id="animalId" />
        <label style="display:flex;gap:8px;align-items:center">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
          <input type="date" id="eventDate" class="input" />
        </label>
        <div style="margin-inline-start:auto"></div>
        <button id="saveBtn" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      </div>
    </section>
  </div>
<script src="js/mbk-animals.js?v=2"></script>

<script type="module">
  const qs = new URLSearchParams(location.search);
  const $ = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>[...p.querySelectorAll(s)];
  const isDemo = qs.get('demo')==='1' || qs.get('mode')==='demo';

  function todayCairo(){ const now=new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'})); const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
window.getAnimalFromContext = function(){
  const qs = new URLSearchParams(location.search);
  const id = qs.get('animalId') || localStorage.getItem('currentAnimalId') || '';
  const number = qs.get('number') || localStorage.getItem('currentAnimalNumber') || '';
  const date = qs.get('date') || sessionStorage.getItem('currentEventDate') || localStorage.getItem('currentEventDate') || todayCairo();

  if (id) localStorage.setItem('currentAnimalId', id);
  if (number) localStorage.setItem('currentAnimalNumber', number);
  if (date) { 
    localStorage.setItem('currentEventDate', date);
    sessionStorage.setItem('currentEventDate', date);
  }

  return { id, number, date };
};

  const preview=$('#preview'), overlay=$('#overlay'), cameraSelect=$('#cameraSelect');
  const toggleFlash=$('#toggleFlash'), restartBtn=$('#restartBtn');
  const captureBtn=$('#captureBtn'), retakeBtn=$('#retakeBtn');
  const uploadBtn=$('#uploadBtn'), uploadInput=$('#uploadInput');
  const saveBtn=$('#saveBtn'), animalIdInput=$('#animalId'), eventDateInput=$('#eventDate');
  const numberSpan=document.querySelector('.animal-number');
  const scoreBadge=$('#scoreBadge'), scoreFill=$('#scoreFill'), scoreNote=$('#scoreNote');
  const thumbs=$('#thumbs');

  // === Kind/Type UI ===
  const kindCow = document.getElementById('kindCow');
  const kindBuffalo = document.getElementById('kindBuffalo');
  const animalTypeSel = document.getElementById('animalType');
  const TYPE_OPTIONS = { cow: ['Ø­Ù„Ø§Ø¨','Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„ØºØ±Ø¶','Ø³Ù„Ø§Ù„Ø§Øª ØµØºÙŠØ±Ø©'], buffalo: ['Ù…ØµØ±ÙŠ','Ù‡Ø¬ÙŠÙ†'] };
  function populateType(kind, selected){ const opts=TYPE_OPTIONS[kind]||[]; if(!animalTypeSel) return; animalTypeSel.innerHTML=''; opts.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; animalTypeSel.appendChild(o); }); if(selected && opts.includes(selected)) animalTypeSel.value=selected; }
  function saveKindToLS(kind, type){ try{ localStorage.setItem('animalKind', kind); localStorage.setItem('animalType', type);}catch{} }
  function readKind(){ const k=localStorage.getItem('animalKind')||'cow'; const t=localStorage.getItem('animalType')|| (TYPE_OPTIONS[k]?TYPE_OPTIONS[k][0]:''); return {k,t}; }

  function updateKindUI(){
    const k = kindBuffalo.checked ? 'buffalo' : 'cow';
    // Ø§Ø®ÙÙ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ø¬Ø§Ù…ÙˆØ³
    const sideBtn = document.querySelector('[data-angle="side"]');
    if(sideBtn){
      sideBtn.style.display = (k==='buffalo') ? 'none' : '';
      if(k==='buffalo' && state.currentAngle!=='rear') setAngle('rear');
    }
    // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
    scoreNote.textContent = k==='buffalo'
      ? 'Ø§Ù„Ù…Ø¯Ù‰ 1â€“5Ø› Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ = 3. Ù„Ù‚Ø·Ø© Ø®Ù„ÙÙŠØ© ÙˆØ§Ø­Ø¯Ø© (Tail fold + Pin bone).'
      : 'Ø§Ù„Ù…Ø¯Ù‰ 2â€“5Ø› Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ = 3. Ø²Ø§ÙˆÙŠØªØ§Ù† (Ø®Ù„ÙÙŠØ© + Ø¬Ø§Ù†Ø¨ÙŠØ©). Ù†Ø²Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© 60%.';
  }

  function initKindBar(){
    if(!kindCow||!kindBuffalo||!animalTypeSel) return;
    const {k,t}=readKind();
    (k==='buffalo'?kindBuffalo:kindCow).checked = true;
    populateType(k,t);
    saveKindToLS(k, animalTypeSel.value);
    updateKindUI();
    [kindCow, kindBuffalo].forEach(r=> r.addEventListener('change', ()=>{
      const kind = kindBuffalo.checked?'buffalo':'cow';
      populateType(kind, null);
      saveKindToLS(kind, animalTypeSel.value);
      updateKindUI();
      renderOverall();
    }));
    animalTypeSel.addEventListener('change', ()=>{
      saveKindToLS(kindBuffalo.checked?'buffalo':'cow', animalTypeSel.value);
      // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ù„Ø£Ù† Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¬Ø§Ù…ÙˆØ³ ØªØ®ØªÙ„Ù
      refsCache.rear=null; refsCache.side=null;
      renderOverall();
    });
  }

  const state={ currentAngle:'rear', stream:null, track:null, capabilities:null, torchOn:false, captures:{rear:null, side:null}, scores:{rear:null, side:null} };
  window.state = state;

  const anglesOrder=['rear','side'];// Ù‡Ù†Ø§ØŸ
  const angleLabels={ rear:'Ø®Ù„ÙÙŠØ©', side:'Ø¬Ø§Ù†Ø¨ÙŠØ©' };

  function fitOverlay(){ const r=preview.getBoundingClientRect(); overlay.width=Math.max(1,Math.floor(r.width*devicePixelRatio)); overlay.height=Math.max(1,Math.floor(r.height*devicePixelRatio)); overlay.style.width=r.width+'px'; overlay.style.height=r.height+'px'; }
  function drawGuide(){ const g=overlay.getContext('2d'); if(!g) return; const w=overlay.width,h=overlay.height; g.clearRect(0,0,w,h);
    // grid
    g.strokeStyle='rgba(255,255,255,.35)'; g.lineWidth=1*devicePixelRatio; for(let i=1;i<3;i++){ g.beginPath(); g.moveTo((w/3)*i,0); g.lineTo((w/3)*i,h); g.stroke(); g.beginPath(); g.moveTo(0,(h/3)*i); g.lineTo(w,(h/3)*i); g.stroke(); }
    // focus box
    g.strokeStyle='rgba(14,160,90,.9)'; g.lineWidth=4*devicePixelRatio;
    let rx,ry,rw,rh;
    if(state.currentAngle==='rear'){ rx=w*.2; ry=h*.45; rw=w*.6; rh=h*.35; g.beginPath(); g.moveTo(w/2, ry); g.lineTo(w/2, ry+rh); g.stroke(); }
    else { rx=w*.15; ry=h*.35; rw=w*.7; rh=h*.4; g.beginPath(); g.moveTo(w*.35, ry); g.lineTo(w*.35, ry+rh); g.stroke(); g.beginPath(); g.moveTo(w*.65, ry); g.lineTo(w*.65, ry+rh); g.stroke(); }
    if(g.roundRect){ g.beginPath(); g.roundRect(rx,ry,rw,rh,20*devicePixelRatio); g.stroke(); } else { g.strokeRect(rx,ry,rw,rh); }
  }

  async function listCameras(){ const devs=await navigator.mediaDevices.enumerateDevices(); const cams=devs.filter(d=>d.kind==='videoinput'); cameraSelect.innerHTML=''; cams.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.deviceId; o.textContent=c.label||`ÙƒØ§Ù…ÙŠØ±Ø§ ${i+1}`; cameraSelect.appendChild(o); }); return cams; }
  async function startCamera(deviceId){ if(state.stream){ state.stream.getTracks().forEach(t=>t.stop()); } const cs=deviceId?{video:{deviceId:{exact:deviceId}}}:{video:{facingMode:{ideal:'environment'}}}; const stream=await navigator.mediaDevices.getUserMedia(cs); state.stream=stream; preview.srcObject=stream; const [track]=stream.getVideoTracks(); state.track=track; state.capabilities=track.getCapabilities?.()||null; await preview.play(); fitOverlay(); drawGuide(); populateTorchSupport(); }
  function populateTorchSupport(){ const cap=state.capabilities; toggleFlash.disabled=!(cap&&'torch' in cap); }
  async function toggleTorch(){ try{ if(!state.track) return; state.torchOn=!state.torchOn; await state.track.applyConstraints({advanced:[{torch:state.torchOn}]}); toggleFlash.setAttribute('aria-pressed',String(state.torchOn)); toggleFlash.textContent=state.torchOn?'Ø§Ù„ÙÙ„Ø§Ø´: ÙŠØ¹Ù…Ù„':'Ø§Ù„ÙÙ„Ø§Ø´'; }catch(e){ console.warn('Torch not supported',e); } }

  function dataURLFromVideo(){ const c=document.createElement('canvas'); const w=preview.videoWidth||preview.clientWidth, h=preview.videoHeight||preview.clientHeight; if(!w||!h) return null; c.width=w; c.height=h; c.getContext('2d').drawImage(preview,0,0,w,h); return c.toDataURL('image/jpeg',0.92); }

  // ===== Hidden reference images =====
  const REF_EXTS = ['jpg','png','webp'];
const BASES = ['images/'];  


  // Ø£Ø¨Ù‚Ø§Ø± (2â€“5) â€” Ø²Ø§ÙˆÙŠØªØ§Ù†
  const MAP_COW = {
    side: [
      {score:2,    bases:['bsc2_side']},
      {score:2.75, bases:['bsc2_75_side']},
      {score:3,    bases:['bsc3_side']},
      {score:3.25, bases:['bsc3_25_side']},
      {score:4,    bases:['bsc4_side']},
      {score:5,    bases:['bsc5_side']},
    ],
    rear: [
      {score:2,    bases:['bsc2_rear']},
      {score:2.75, bases:['bsc2_75_rear']},
      {score:3,    bases:['bsc3_rear']},
      {score:3.25, bases:['bsc3_25_rear']},
      {score:4,    bases:['bsc4_rear']},
      {score:5,    bases:['bsc5_rear']},
    ]
  };

  // Ø¬Ø§Ù…ÙˆØ³ (1â€“5) â€” Ù„Ù‚Ø·Ø© Ø®Ù„ÙÙŠØ© ÙÙ‚Ø·
  const MAP_BUF_EGY = [
    {score:1, bases:['bcs_egybuf_1']},
    {score:2, bases:['bcs_egybuf_2']},
    {score:3, bases:['bcs_egybuf_3']},
    {score:4, bases:['bcs_egybuf_4']},
    {score:5, bases:['bcs_egybuf_5']},
  ];
  const MAP_BUF_HYP = [
    {score:1, bases:['bcs_hypbuf_1']},
    {score:2, bases:['bcs_hypbuf_2']},
    {score:3, bases:['bcs_hypbuf_3']},
    {score:4, bases:['bcs_hypbuf_4']},
    {score:5, bases:['bcs_hypbuf_5']},
  ];

  function buildUrls(baseName){ return BASES.flatMap(root=> REF_EXTS.map(ext=> `${root}${baseName}.${ext}`)); }

  function buildRefList(angle){
    const kind = (document.getElementById('kindBuffalo')?.checked) ? 'buffalo' : (localStorage.getItem('animalKind')||'cow');
    if(kind==='buffalo'){
      if(angle!=='rear') return []; // Ø§Ù„Ø¬Ø§Ù…ÙˆØ³ Ø®Ù„ÙÙŠØ© ÙÙ‚Ø·
      const type = (document.getElementById('animalType')?.value)||localStorage.getItem('animalType')||'Ù…ØµØ±ÙŠ';
      const list = (type==='Ù‡Ø¬ÙŠÙ†') ? MAP_BUF_HYP : MAP_BUF_EGY;
      return list.flatMap(({score,bases})=> bases.map(b=>({ score, urls: buildUrls(b) })));
    }
    // Ø£Ø¨Ù‚Ø§Ø±
    const src = MAP_COW[angle]||[];
    return src.flatMap(({score,bases})=> bases.map(b=>({ score, urls: buildUrls(b) })));
  }

  function imgToVec(img){ const w=64,h=64; const c=document.createElement('canvas'); c.width=w; c.height=h; const g=c.getContext('2d'); g.drawImage(img,0,0,w,h); const d=g.getImageData(0,0,w,h).data; const v=new Float32Array(w*h); let k=0; for(let i=0;i<d.length;i+=4){ v[k++]=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; } let mean=0; for(let i=0;i<v.length;i++) mean+=v[i]; mean/=v.length; let norm=0; for(let i=0;i<v.length;i++){ v[i]-=mean; norm+=v[i]*v[i]; } norm=Math.sqrt(norm)||1; for(let i=0;i<v.length;i++) v[i]/=norm; return v; }
function loadRefVector(urls, score) {
  let i = 0;
  return new Promise(res => {
    function tryNext() {
      if (i >= urls.length) return res(null);

      const url = urls[i];
      // Ø¬Ø±Ø¨ Ø§Ù„Ø£ÙˆÙ„ Ù‡Ù„ Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯
      fetch(url, { method: "HEAD" })
        .then(r => {
          if (!r.ok) {
            i++;
            tryNext();
            return;
          }
          const img = new Image();
          img.onload = () => res({ score, vec: imgToVec(img) });
          img.onerror = () => { i++; tryNext(); };
          img.src = url;
        })
        .catch(() => { i++; tryNext(); });
    }
    tryNext();
  });
}

  async function buildRefsFor(angle){ const list=buildRefList(angle); const arr=await Promise.all(list.map(item=>loadRefVector(item.urls,item.score))); return arr.filter(Boolean); }

  const refsCache = {rear:null, side:null};
  async function ensureRefs(angle){ if(refsCache[angle]) return refsCache[angle]; const refs=await buildRefsFor(angle); refsCache[angle]=refs; if(!refs.length) { scoreNote.textContent = `ØªÙ†Ø¨ÙŠÙ‡: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ù„Ø²Ø§ÙˆÙŠØ© ${angleLabels[angle]} â€” ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ images/`; } return refs; }

  function cosine(a,b){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s; }
  function vectorForDataURL(dataUrl){ return new Promise(res=>{ const img=new Image(); img.onload=()=>res(imgToVec(img)); img.src=dataUrl; }); }
  async function scoreBCSFor(angle, dataUrl){ const refs=await ensureRefs(angle); if(!refs.length) return null; const vec=await vectorForDataURL(dataUrl); let best=null; for(const r of refs){ const sim=cosine(vec,r.vec); if(!best || sim>best.sim) best={score:r.score, sim}; } return best?best.score:null; }

  function labelForScore(s){
    if(s==null) return 'â€”';
    if(s<1.6) return 'Ù†Ø­ÙŠÙØ© Ø¬Ø¯Ù‹Ø§';
    if(s<2.5) return 'Ù†Ø­ÙŠÙØ©';
    if(Math.abs(s-3)<0.06) return 'Ù…Ø«Ø§Ù„ÙŠØ©';
    if(s<3.7) return 'ØªÙ…ÙŠÙ„ Ù„Ù„Ø³Ù…Ù†Ø©';
    if(s<4.6) return 'Ø³Ù…ÙŠÙ†Ø©';
    return 'Ø³Ù…ÙŠÙ†Ø© Ø¬Ø¯Ù‹Ø§';
  }

  function renderThumbs(){ thumbs.innerHTML=''; for(const a of anglesOrder){ const wrap=document.createElement('div'); wrap.className='thumb'; const img=document.createElement('img'); if(state.captures[a]) img.src=state.captures[a]; wrap.appendChild(img); const lb=document.createElement('div'); lb.className='label'; lb.textContent=angleLabels[a]; wrap.appendChild(lb); wrap.addEventListener('click', ()=> setAngle(a)); thumbs.appendChild(wrap); } }

  function renderOverall(){
    const kind = localStorage.getItem('animalKind') || (kindBuffalo?.checked?'buffalo':'cow');
    if(kind==='buffalo'){
      const s = (typeof state.scores.rear==='number') ? state.scores.rear : null;
      if(s==null){ scoreBadge.textContent='â€”'; scoreFill.style.width='0%'; return; }
      const pct=Math.min(100, Math.max(0,(s/5)*100));
      scoreBadge.textContent=`${labelForScore(s)} â€” ${s.toFixed(2)} / 5`;
      scoreFill.style.width=pct+'%';
      scoreFill.style.background = Math.abs(s-3)<0.06 ? '#86efac' : '#7dd3fc';
      return;
    }
    // Ø£Ø¨Ù‚Ø§Ø±: 60% Ø®Ù„ÙÙŠØ© + 40% Ø¬Ø§Ù†Ø¨ÙŠØ©
    const haveRear=typeof state.scores.rear==='number';
    const haveSide=typeof state.scores.side==='number';
    if(!haveRear && !haveSide){ scoreBadge.textContent='â€”'; scoreFill.style.width='0%'; return; }
    const wRear=0.6, wSide=0.4;
    const overall = ((haveRear?state.scores.rear:3)*wRear + (haveSide?state.scores.side:3)*wSide) / ((haveRear?wRear:0)+(haveSide?wSide:0)||1);
    const pct=Math.min(100, Math.max(0,(overall/5)*100));
    scoreBadge.textContent=`${labelForScore(overall)} â€” ${overall.toFixed(2)} / 5`;
    scoreFill.style.width=pct+'%';
    scoreFill.style.background = Math.abs(overall-3)<0.06 ? '#86efac' : '#7dd3fc';
  }

  function setAngle(angle){ state.currentAngle=angle; $$('.angle-tab').forEach(el=> el.classList.toggle('active', el.dataset.angle===angle)); drawGuide(); updateButtons(); }
  function updateButtons(){ const has=!!state.captures[state.currentAngle]; retakeBtn.disabled=!has; }

  // === UI bindings ===
  window.addEventListener('resize', ()=>{ fitOverlay(); drawGuide(); });
  $$('.angle-tab').forEach(btn=> btn.addEventListener('click', ()=> setAngle(btn.dataset.angle)));
  toggleFlash.addEventListener('click', toggleTorch);
  restartBtn.addEventListener('click', async ()=>{ await startCamera(cameraSelect.value); });
  cameraSelect.addEventListener('change', async ()=>{ await startCamera(cameraSelect.value); });

  captureBtn.addEventListener('click', async ()=>{ const url=dataURLFromVideo(); if(!url) return; state.captures[state.currentAngle]=url; state.scores[state.currentAngle]=await scoreBCSFor(state.currentAngle,url); renderThumbs(); renderOverall(); updateButtons(); });
  retakeBtn.addEventListener('click', ()=>{ state.captures[state.currentAngle]=null; state.scores[state.currentAngle]=null; renderThumbs(); renderOverall(); updateButtons(); });
  if(uploadBtn) uploadBtn.addEventListener('click', ()=> uploadInput && uploadInput.click());
  if(uploadInput) uploadInput.addEventListener('change', async (e)=>{ const f=e.target.files && e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=async ()=>{ const url=r.result; state.captures[state.currentAngle]=url; state.scores[state.currentAngle]=await scoreBCSFor(state.currentAngle,url); renderThumbs(); renderOverall(); updateButtons(); }; r.readAsDataURL(f); uploadInput.value=''; });
  const nextAngleBtn = document.getElementById('nextAngleBtn');
  nextAngleBtn.addEventListener('click', ()=>{ const i=anglesOrder.indexOf(state.currentAngle); setAngle(anglesOrder[(i+1)%anglesOrder.length]); });

  // Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
  

  async function runDemo(){
    const badge=$('#demoBadge'); if(badge) badge.style.display='inline-block';
    const kind = kindBuffalo?.checked ? 'buffalo' : 'cow';
    if(kind==='buffalo'){
      const base = (animalTypeSel.value==='Ù‡Ø¬ÙŠÙ†')?'bcs_hypbuf_3':'bcs_egybuf_3';
      const urls = BASES.flatMap(root=> REF_EXTS.map(ext=> `${root}${base}.${ext}`));
      let chosen=null;
      for(const u of urls){
        try{
          await new Promise((ok,fail)=>{ const im=new Image(); im.onload=()=>ok(im); im.onerror=fail; im.src=u; })
          .then(im=>{ const c=document.createElement('canvas'); c.width=im.width; c.height=im.height; c.getContext('2d').drawImage(im,0,0); chosen=c.toDataURL('image/jpeg',0.9); });
          break;
        }catch(e){}
      }
      if(chosen){ state.captures.rear=chosen; state.scores.rear=await scoreBCSFor('rear',chosen); renderThumbs(); renderOverall(); }
    }else{
      const demoBase = {rear:'bsc3_rear', side:'bsc3_side'};
      for(const a of anglesOrder){
        const urls = BASES.flatMap(root=> REF_EXTS.map(ext=> `${root}${demoBase[a]}.${ext}`));
        let chosen=null;
        for(const u of urls){
          try{
            await new Promise((ok,fail)=>{ const im=new Image(); im.onload=()=>ok(im); im.onerror=fail; im.src=u; })
            .then(im=>{ const c=document.createElement('canvas'); c.width=im.width; c.height=im.height; c.getContext('2d').drawImage(im,0,0); chosen=c.toDataURL('image/jpeg',0.9); });
            break;
          }catch(e){}
        }
        if(chosen){ state.captures[a]=chosen; state.scores[a]=await scoreBCSFor(a,chosen); renderThumbs(); renderOverall(); }
      }
    }
  }

  function renderInitial(){ renderThumbs(); setAngle('rear'); renderOverall(); }

  (async function init(){ try{
    const ctx=getAnimalFromContext();
    if(animalIdInput) animalIdInput.value = ctx.id || '';
    if(eventDateInput) eventDateInput.value = ctx.date || todayCairo();
    if(numberSpan) numberSpan.textContent = ctx.number || (ctx.id ? `#${ctx.id.slice(-5)}` : 'â€”');

    initKindBar();

    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ø¨Ø± Ø§Ù„ÙˆÙŠØ¨.'); }
    if(location.protocol!=='https:' && location.hostname!=='localhost'){ console.warn('ÙŠÙÙ†ØµØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… https Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.'); }
    await startCamera(); await listCameras(); if(!cameraSelect.value && cameraSelect.options.length){ cameraSelect.value=cameraSelect.options[0].value; }

    renderInitial();

    document.getElementById('demoBtn')?.addEventListener('click', runDemo);
    if(isDemo) runDemo();
  }catch(e){ console.warn(e); }
  })();
</script>

<script>
  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¹Ù†ØµØ± Ù…Ø­Ø±Ù‘Ø± Ù„Ùˆ Ø¸Ù‡Ø± ÙØ¬Ø£Ø©
  function nukeEditorCard(){ document.querySelectorAll('editor-card,.editor-card').forEach(n=>{ try{ n.remove(); }catch{} }); }
  new MutationObserver(nukeEditorCard).observe(document.documentElement,{childList:true,subtree:true});
  document.addEventListener('DOMContentLoaded', nukeEditorCard);
</script>
<!-- Ø³ÙƒØ±Ø¨Øª Ù…Ø´ØªØ±Ùƒ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« -->
<script src="/js/tenant-bootstrap.js"></script>
<script src="/js/event-core.js"></script>
  
<script>
document.addEventListener("DOMContentLoaded", () => {
  const saveBtn = document.getElementById("saveBtn");
  if (!saveBtn) return;   // Ù„Ùˆ Ø§Ù„Ø²Ø± Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø§ ÙŠØ¹Ù…Ù„Ø´ Ø­Ø§Ø¬Ø©

  saveBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    const payload = {
      animalId: localStorage.getItem("currentAnimalId") || "",
      animalNumber: localStorage.getItem("currentAnimalId") || "",
      eventDate: localStorage.getItem("lastEventDate") || new Date().toISOString().slice(0,10),
      eventType: "ØªÙ‚ÙŠÙŠÙ… Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ù… (BCS)",
      score: Number(window.bcsScore) || 0,
      value: Number(window.bcsScore) || 0,
      source: "bcs-eval.html"
    };

    try {
      console.log("ğŸ“¦ payload to send:", payload);

      const res = await fetch("/api/events", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-User-Id": localStorage.getItem("userId") || "",
        },
        body: JSON.stringify(payload),
      });

      if (!res.ok) throw new Error("API error");
      alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­");
    } catch (err) {
      console.error("API error:", err);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
    }
  });
});
</script>

</body>
</html>
