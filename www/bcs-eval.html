<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تقييم حالة الجسم (BCS) بالكاميرا — مُرَبِّك</title>
  <style>
    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff; --danger:#c2410c; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Segoe UI','Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid #e2e8f0;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .title{font-weight:800;color:var(--green);margin:0}
    .badge{background:#e6f8ef;color:var(--green-600);padding:4px 8px;border-radius:999px;font-size:12px}
    .container{max-width:880px;margin:16px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}

    .angles{display:flex;gap:8px;padding:12px;border-bottom:1px solid #e2e8f0}
    .angle-tab{padding:10px 12px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:700;min-height:44px}
    .angle-tab.active{background:var(--green);color:#fff;border-color:var(--green)}

    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px}
    .controls .select,.controls .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px}
    .controls .btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:700;min-height:44px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .btn-primary{background:var(--green);color:#fff}
    .btn-light{background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .preview-wrap{position:relative;border-radius:16px;overflow:hidden;background:#000;aspect-ratio:4/3;max-height:56vh}
    video#preview{width:100%;height:100%;display:block;background:#000;object-fit:cover}
    canvas#overlay{position:absolute;inset:0;pointer-events:none}

    .thumbs{display:flex;gap:8px;padding:8px;border-top:1px solid #e2e8f0;flex-wrap:nowrap;overflow-x:auto;scroll-snap-type:x mandatory}
    .thumb{width:56px;height:56px;border-radius:12px;overflow:hidden;border:2px solid #e2e8f0;background:#f8fafc;position:relative;flex:0 0 auto;scroll-snap-align:start}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .label{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.5);color:#fff;font-size:11px;text-align:center}

    .results{padding:12px;border-top:1px solid #e2e8f0;display:grid;gap:10px}
    .score{display:grid;gap:8px;padding:8px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
    .score-badge{display:inline-block;padding:6px 10px;border:1px solid transparent;border-radius:999px;font-weight:800;width:max-content}
    .score-bar{height:10px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;overflow:hidden}
    .score-bar .fill{height:100%}
    .score-note{color:var(--muted);font-weight:700}

    .save-bar{display:flex;gap:8px;align-items:center;padding:12px;border-top:1px solid #e2e8f0
}
    .save-bar .input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:16px}

    #saveBtn{
      padding:16px 20px;
      font-size:18px;
      border-radius:14px;
      width:100%;
      max-width:100%;
    }

    .kind-card{padding:8px}
    .kind-grid{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center}
    @media(max-width:560px){.kind-grid{grid-template-columns:1fr 1fr}}

    .controls.controls-grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .controls-grid .left{display:flex;gap:8px;align-items:center}
    .controls-grid .right{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    @media(min-width:860px){.controls-grid .right{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .btn-lg{padding:14px 18px;font-size:18px}
    @media(max-width:560px){
      .controls.controls-grid{grid-template-columns:1fr}
      .controls-grid .right{justify-content:stretch}
      .controls .btn, .controls .select{width:100%}
      #captureBtn{order:-1}
    }
    #cameraCard .controls{position:sticky;top:56px;z-index:5;background:var(--card);border-bottom:1px solid #e2e8f0}
    /* الموبايل: الأزرار فوق بعض وبعرض الكارت كله */
.save-bar{
  display:flex;
  flex-direction: column;   /* نخلي العناصر تحت بعض */
  align-items: stretch;
  gap: 8px;
}
.save-bar button{
  width: 100% !important;   /* كل زر ياخد عرض الكارت */
  max-width: 100%;
}

/* لو عندك زر رجوع */
#backBtn{ width:100% !important; }

/* الحقل (التاريخ) ياخد سطر لوحده من غير ما يسبب سكروول */
.save-bar label{
  width: 100%;
  min-width: 0;
}

/* الشاشات الأوسع: نرجّع الصف أفقي لو حابب (اختياري) */
@media (min-width: 640px){
  .save-bar{
    flex-direction: row;
    align-items: center;
  }
  .save-bar label{ flex: 1 1 260px; }
  .save-bar button, #backBtn{
    width: auto !important; /* الأزرار ترجع بحجمها الطبيعي */
  }
}

  </style>
</head>
<body>
  <header>
    <h1 class="title">BCS تقييم حالة الجسم بالكاميرا</h1>
    <span class="badge">مُرَبِّك</span>
    <span class="badge" id="demoBadge" style="display:none;background:#fff3cd;color:#92400e;border:1px solid #facc15">وضع العرض</span>
    <div style="margin-inline-start:auto;color:var(--muted);font-weight:700">رقم الحيوان: <span class="animal-number">—</span></div>
  </header>

  <div class="container">
    <section class="card kind-card">
      <div class="kind-grid">
        <div role="radiogroup" aria-label="نوع الحيوان" style="display:flex;gap:12px;align-items:center">
          <label style="display:flex;gap:6px;align-items:center"><input type="radio" name="animalKind" id="kindCow" value="cow"> أبقار</label>
          <label style="display:flex;gap:6px;align-items:center"><input type="radio" name="animalKind" id="kindBuffalo" value="buffalo"> جاموس</label>
        </div>
        <select id="animalType" class="select" title="التصنيف"></select>
      </div>
    </section>

    <section class="card" id="cameraCard">
      <div class="angles">
        <button class="angle-tab active" data-angle="rear">لقطة خلفية</button>
        <button class="angle-tab" data-angle="side">لقطة جانبية</button>
      </div>

      <div class="controls controls-grid">
        <div class="left">
          <button id="captureBtn" class="btn btn-primary btn-lg">التقاط</button>
          <button id="retakeBtn" class="btn btn-danger" disabled>إعادة الالتقاط</button>
        </div>
        <div class="right">
          <select id="cameraSelect" class="select" title="اختيار الكاميرا"></select>
          <button id="toggleFlash" class="btn btn-light" title="تشغيل الفلاش" aria-pressed="false">الفلاش</button>
          <button id="restartBtn" class="btn btn-light">إعادة التهيئة</button>
         <!-- الزر -->
          <button id="uploadBtn" type="button" class="btn btn-light">رفع صورة بديلة</button>

          <input id="uploadInput" type="file" accept="image/*" capture="environment" style="display:none" />

          <button id="nextAngleBtn" class="btn btn-light">التالي ▸</button>
          <button id="demoBtn" class="btn btn-light" title="تشغيل وضع العرض">وضع العرض</button>
        </div>
      </div>

      <div class="preview-wrap">
        <video id="preview" playsinline autoplay muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="thumbs" id="thumbs"></div>

      <div class="results">
        <h3 style="margin:8px 0;color:var(--green-600)">النتيجة</h3>
        <div id="scoreWidget" class="score">
          <div class="score-badge" id="scoreBadge">—</div>
          <div class="score-bar"><div class="fill" id="scoreFill" style="width:0%"></div></div>
          <div class="score-note" id="scoreNote">المدى يعتمد على النوع.</div>
        </div>
      </div>

      <div class="save-bar">
        <input type="hidden" id="animalId" />
        <label style="display:flex;gap:8px;align-items:center">تاريخ التقييم
          <input type="date" id="eventDate" class="input" />
        </label>
          <input id="commentInput" class="input" placeholder="تعليق (اختياري)" />
        <div style="margin-inline-start:auto"></div>
        <button id="backEventsBtn" class="btn" style="padding:12px 14px;border:1px solid #cbd5e1;border-radius:12px;background:#f1f5f9;color:#0f172a">
  رجوع للأحداث
</button>
        <button id="saveBtn" class="btn btn-primary">حفظ التقييم</button>
      </div>
    </section>
  </div>
  <script>window.dataLayer = window.dataLayer || [];</script>
<script src="/js/app-core.js"></script>

  <script src="js/mbk-animals.js?v=2"></script>

  <script type="module">
    const qs = new URLSearchParams(location.search);
    const $ = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>[...p.querySelectorAll(s)];
    const isDemo = qs.get('demo')==='1' || qs.get('mode')==='demo';

    function todayCairo(){ const now=new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'})); const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
    window.getAnimalFromContext = function(){
      const qs = new URLSearchParams(location.search);
      const id = qs.get('animalId') || localStorage.getItem('currentAnimalId') || '';
      const number = qs.get('number') || localStorage.getItem('currentAnimalNumber') || '';
      const date = qs.get('date') || sessionStorage.getItem('currentEventDate') || localStorage.getItem('currentEventDate') || todayCairo();
      if (id) localStorage.setItem('currentAnimalId', id);
      if (number) localStorage.setItem('currentAnimalNumber', number);
      if (date) { localStorage.setItem('currentEventDate', date); sessionStorage.setItem('currentEventDate', date); }
      return { id, number, date };
    };

    const preview=$('#preview'), overlay=$('#overlay'), cameraSelect=$('#cameraSelect');
    const toggleFlash=$('#toggleFlash'), restartBtn=$('#restartBtn');
    const captureBtn=$('#captureBtn'), retakeBtn=$('#retakeBtn');
    const uploadBtn=$('#uploadBtn'), uploadInput=$('#uploadInput');
    const saveBtn=$('#saveBtn'), animalIdInput=$('#animalId'), eventDateInput=$('#eventDate');
    const numberSpan=document.querySelector('.animal-number');
    const scoreBadge=$('#scoreBadge'), scoreFill=$('#scoreFill'), scoreNote=$('#scoreNote');
    const thumbs=$('#thumbs');

    const kindCow = document.getElementById('kindCow');
    const kindBuffalo = document.getElementById('kindBuffalo');
    const animalTypeSel = document.getElementById('animalType');
    const TYPE_OPTIONS = { cow: ['حلاب','ثنائي الغرض','سلالات صغيرة'], buffalo: ['مصري','هجين'] };
    function populateType(kind, selected){ const opts=TYPE_OPTIONS[kind]||[]; if(!animalTypeSel) return; animalTypeSel.innerHTML=''; opts.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; animalTypeSel.appendChild(o); }); if(selected && opts.includes(selected)) animalTypeSel.value=selected; }
    function saveKindToLS(kind, type){ try{ localStorage.setItem('animalKind', kind); localStorage.setItem('animalType', type);}catch{} }
    function readKind(){ const k=localStorage.getItem('animalKind')||'cow'; const t=localStorage.getItem('animalType')|| (TYPE_OPTIONS[k]?TYPE_OPTIONS[k][0]:''); return {k,t}; }

    function updateKindUI(){
      const k = kindBuffalo.checked ? 'buffalo' : 'cow';
      const sideBtn = document.querySelector('[data-angle="side"]');
      if(sideBtn){
        sideBtn.style.display = (k==='buffalo') ? 'none' : '';
        if(k==='buffalo' && state.currentAngle!=='rear') setAngle('rear');
      }
      scoreNote.textContent = k==='buffalo'
        ? 'المدى 1–5؛ المثالي = 3. لقطة خلفية واحدة (Tail fold + Pin bone).'
        : 'المدى 2–5؛ المثالي = 3. زاويتان (خلفية + جانبية). نزن الخلفية 60٪.';
    }

    function initKindBar(){
      if(!kindCow||!kindBuffalo||!animalTypeSel) return;
      const {k,t}=readKind();
      (k==='buffalo'?kindBuffalo:kindCow).checked = true;
      populateType(k,t);
      saveKindToLS(k, animalTypeSel.value);
      updateKindUI();
      [kindCow, kindBuffalo].forEach(r=> r.addEventListener('change', ()=>{
        const kind = kindBuffalo.checked?'buffalo':'cow';
        populateType(kind, null);
        saveKindToLS(kind, animalTypeSel.value);
        updateKindUI();
        renderOverall();
      }));
      animalTypeSel.addEventListener('change', ()=>{
        saveKindToLS(kindBuffalo.checked?'buffalo':'cow', animalTypeSel.value);
        refsCache.rear=null; refsCache.side=null;
        renderOverall();
      });
    }

    const state={ currentAngle:'rear', stream:null, track:null, capabilities:null, torchOn:false, captures:{rear:null, side:null}, scores:{rear:null, side:null} };
    window.state = state;
   window.bcsScore = null;

    const anglesOrder=['rear','side'];
    const angleLabels={ rear:'خلفية', side:'جانبية' };

    function fitOverlay(){ const r=preview.getBoundingClientRect(); overlay.width=Math.max(1,Math.floor(r.width*devicePixelRatio)); overlay.height=Math.max(1,Math.floor(r.height*devicePixelRatio)); overlay.style.width=r.width+'px'; overlay.style.height=r.height+'px'; }
    function drawGuide(){ const g=overlay.getContext('2d'); if(!g) return; const w=overlay.width,h=overlay.height; g.clearRect(0,0,w,h);
      g.strokeStyle='rgba(255,255,255,.35)'; g.lineWidth=1*devicePixelRatio; for(let i=1;i<3;i++){ g.beginPath(); g.moveTo((w/3)*i,0); g.lineTo((w/3)*i,h); g.stroke(); g.beginPath(); g.moveTo(0,(h/3)*i); g.lineTo(w,(h/3)*i); g.stroke(); }
      g.strokeStyle='rgba(14,160,90,.9)'; g.lineWidth=4*devicePixelRatio;
      let rx,ry,rw,rh;
      if(state.currentAngle==='rear'){ rx=w*.2; ry=h*.45; rw=w*.6; rh=h*.35; g.beginPath(); g.moveTo(w/2, ry); g.lineTo(w/2, ry+rh); g.stroke(); }
      else { rx=w*.15; ry=h*.35; rw=w*.7; rh=h*.4; g.beginPath(); g.moveTo(w*.35, ry); g.lineTo(w*.35, ry+rh); g.stroke(); g.beginPath(); g.moveTo(w*.65, ry); g.lineTo(w*.65, ry+rh); g.stroke(); }
      if(g.roundRect){ g.beginPath(); g.roundRect(rx,ry,rw,rh,20*devicePixelRatio); g.stroke(); } else { g.strokeRect(rx,ry,rw,rh); }
    }

    async function listCameras(){ const devs=await navigator.mediaDevices.enumerateDevices(); const cams=devs.filter(d=>d.kind==='videoinput'); cameraSelect.innerHTML=''; cams.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.deviceId; o.textContent=c.label||`كاميرا ${i+1}`; cameraSelect.appendChild(o); }); return cams; }
    async function startCamera(deviceId){ if(state.stream){ state.stream.getTracks().forEach(t=>t.stop()); } const cs=deviceId?{video:{deviceId:{exact:deviceId}}}:{video:{facingMode:{ideal:'environment'}}}; const stream=await navigator.mediaDevices.getUserMedia(cs); state.stream=stream; preview.srcObject=stream; const [track]=stream.getVideoTracks(); state.track=track; state.capabilities=track.getCapabilities?.()||null; await preview.play(); fitOverlay(); drawGuide(); populateTorchSupport(); }
    function populateTorchSupport(){ const cap=state.capabilities; toggleFlash.disabled=!(cap&&'torch' in cap); }
    async function toggleTorch(){ try{ if(!state.track) return; state.torchOn=!state.torchOn; await state.track.applyConstraints({advanced:[{torch:state.torchOn}]}); toggleFlash.setAttribute('aria-pressed',String(state.torchOn)); toggleFlash.textContent=state.torchOn?'الفلاش: يعمل':'الفلاش'; }catch(e){ console.warn('Torch not supported',e); } }

    function dataURLFromVideo(){ const c=document.createElement('canvas'); const w=preview.videoWidth||preview.clientWidth, h=preview.videoHeight||preview.clientHeight; if(!w||!h) return null; c.width=w; c.height=h; c.getContext('2d').drawImage(preview,0,0,w,h); return c.toDataURL('image/jpeg',0.92); }

    const REF_EXTS = ['jpg','png','webp'];
    const BASES = ['images/'];

    const MAP_COW = {
      side: [
        {score:2,    bases:['bsc2_side']},
        {score:2.75, bases:['bsc2_75_side']},
        {score:3,    bases:['bsc3_side']},
        {score:3.25, bases:['bsc3_25_side']},
        {score:4,    bases:['bsc4_side']},
        {score:5,    bases:['bsc5_side']},
      ],
      rear: [
        {score:2,    bases:['bsc2_rear']},
        {score:2.75, bases:['bsc2_75_rear']},
        {score:3,    bases:['bsc3_rear']},
        {score:3.25, bases:['bsc3_25_rear']},
        {score:4,    bases:['bsc4_rear']},
        {score:5,    bases:['bsc5_rear']},
      ]
    };

    const MAP_BUF_EGY = [
      {score:1, bases:['bcs_egybuf_1']},
      {score:2, bases:['bcs_egybuf_2']},
      {score:3, bases:['bcs_egybuf_3']},
      {score:4, bases:['bcs_egybuf_4']},
      {score:5, bases:['bcs_egybuf_5']},
    ];
    const MAP_BUF_HYP = [
      {score:1, bases:['bcs_hypbuf_1']},
      {score:2, bases:['bcs_hypbuf_2']},
      {score:3, bases:['bcs_hypbuf_3']},
      {score:4, bases:['bcs_hypbuf_4']},
      {score:5, bases:['bcs_hypbuf_5']},
    ];

    function buildUrls(baseName){ return BASES.flatMap(root=> REF_EXTS.map(ext=> `${root}${baseName}.${ext}`)); }

    function buildRefList(angle){
      const kind = (document.getElementById('kindBuffalo')?.checked) ? 'buffalo' : (localStorage.getItem('animalKind')||'cow');
      if(kind==='buffalo'){
        if(angle!=='rear') return [];
        const type = (document.getElementById('animalType')?.value)||localStorage.getItem('animalType')||'مصري';
        const list = (type==='هجين') ? MAP_BUF_HYP : MAP_BUF_EGY;
        return list.flatMap(({score,bases})=> bases.map(b=>({ score, urls: buildUrls(b) })));
      }
      const src = MAP_COW[angle]||[];
      return src.flatMap(({score,bases})=> bases.map(b=>({ score, urls: buildUrls(b) })));
    }

    function imgToVec(img){ const w=64,h=64; const c=document.createElement('canvas'); c.width=w; c.height=h; const g=c.getContext('2d'); g.drawImage(img,0,0,w,h); const d=g.getImageData(0,0,w,h).data; const v=new Float32Array(w*h); let k=0; for(let i=0;i<d.length;i+=4){ v[k++]=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; } let mean=0; for(let i=0;i<v.length;i++) mean+=v[i]; mean/=v.length; let norm=0; for(let i=0;i<v.length;i++){ v[i]-=mean; norm+=v[i]*v[i]; } norm=Math.sqrt(norm)||1; for(let i=0;i<v.length;i++) v[i]/=norm; return v; }

    /* التصحيح: بدون HEAD */
  function loadRefVector(urls, score) {
  let i = 0;
  return new Promise(res => {
    function tryNext() {
      if (i >= urls.length) return res(null);
      const url = urls[i++];
      const img = new Image();
      img.onload = () => res({ score, vec: imgToVec(img) });
      img.onerror = () => tryNext();
      img.src = url;
    }
    tryNext();
  });
}


    async function buildRefsFor(angle){ const list=buildRefList(angle); const arr=await Promise.all(list.map(item=>loadRefVector(item.urls,item.score))); return arr.filter(Boolean); }

    const refsCache = {rear:null, side:null};
    /* التصحيح: لا نعتمد على [] كقيمة كاش صالحة */
    async function ensureRefs(angle){
      if (Array.isArray(refsCache[angle]) && refsCache[angle].length) return refsCache[angle];
      const refs=await buildRefsFor(angle);
      refsCache[angle]=refs;
      if(!refs.length) { scoreNote.textContent = `تنبيه: لم يتم تحميل المراجع لزاوية ${angleLabels[angle]} — تأكد من وجود الملفات في images/`; }
      return refs;
    }

    function cosine(a,b){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s; }
    function vectorForDataURL(dataUrl){ return new Promise(res=>{ const img=new Image(); img.onload=()=>res(imgToVec(img)); img.src=dataUrl; }); }
    async function scoreBCSFor(angle, dataUrl){ const refs=await ensureRefs(angle); if(!refs.length) return null; const vec=await vectorForDataURL(dataUrl); let best=null; for(const r of refs){ const sim=cosine(vec,r.vec); if(!best || sim>best.sim) best={score:r.score, sim}; } return best?best.score:null; }

    function labelForScore(s){
      if(s==null) return '—';
      if(s<1.6) return 'نحيفة جدًا';
      if(s<2.5) return 'نحيفة';
      if(Math.abs(s-3)<0.06) return 'مثالية';
      if(s<3.7) return 'تميل للسمنة';
      if(s<4.6) return 'سمينة';
      return 'سمينة جدًا';
    }

    function renderThumbs(){ thumbs.innerHTML=''; for(const a of anglesOrder){ const wrap=document.createElement('div'); wrap.className='thumb'; const img=document.createElement('img'); if(state.captures[a]) img.src=state.captures[a]; wrap.appendChild(img); const lb=document.createElement('div'); lb.className='label'; lb.textContent=angleLabels[a]; wrap.appendChild(lb); wrap.addEventListener('click', ()=> setAngle(a)); thumbs.appendChild(wrap); } }
function renderOverall(){
  const kind = localStorage.getItem('animalKind') || (kindBuffalo?.checked ? 'buffalo' : 'cow');

  // —— الجاموس: لقطة خلفية واحدة 1–5 ——
  if (kind === 'buffalo') {
    const s = (typeof state.scores.rear === 'number') ? state.scores.rear : null;
    if (s == null) {
      window.bcsScore = null;
      scoreBadge.textContent = '—';
      scoreFill.style.width = '0%';
      return;
    }
    const pct = Math.min(100, Math.max(0, (s / 5) * 100));
    scoreBadge.textContent = `${labelForScore(s)} — ${s.toFixed(2)} / 5`;
    scoreFill.style.width = pct + '%';
    scoreFill.style.background = Math.abs(s - 3) < 0.06 ? '#86efac' : '#7dd3fc';
    window.bcsScore = Number(s.toFixed(2));
    return;
  }

  // —— الأبقار: وزن الخلفية 60% والجانبية 40% (المدى 2–5) ——
  const haveRear = typeof state.scores.rear === 'number';
  const haveSide = typeof state.scores.side === 'number';

  if (!haveRear && !haveSide) {
    window.bcsScore = null;
    scoreBadge.textContent = '—';
    scoreFill.style.width = '0%';
    return;
  }

  const wRear = 0.6, wSide = 0.4;
  const overall = (
    (haveRear ? state.scores.rear : 3) * wRear +
    (haveSide ? state.scores.side : 3) * wSide
  ) / ((haveRear ? wRear : 0) + (haveSide ? wSide : 0) || 1);

  const pct = Math.min(100, Math.max(0, (overall / 5) * 100));
  scoreBadge.textContent = `${labelForScore(overall)} — ${overall.toFixed(2)} / 5`;
  scoreFill.style.width = pct + '%';
  scoreFill.style.background = Math.abs(overall - 3) < 0.06 ? '#86efac' : '#7dd3fc';
  window.bcsScore = Number(overall.toFixed(2));
}


    function setAngle(angle){ state.currentAngle=angle; $$('.angle-tab').forEach(el=> el.classList.toggle('active', el.dataset.angle===angle)); drawGuide(); updateButtons(); }
    function updateButtons(){ const has=!!state.captures[state.currentAngle]; retakeBtn.disabled=!has; }
    Object.assign(window, {
  scoreBCSFor,
  renderThumbs,
  renderOverall,
  updateButtons
});
    window.addEventListener('resize', ()=>{ fitOverlay(); drawGuide(); });
    $$('.angle-tab').forEach(btn=> btn.addEventListener('click', ()=> setAngle(btn.dataset.angle)));
    toggleFlash.addEventListener('click', toggleTorch);
    restartBtn.addEventListener('click', async ()=>{ await startCamera(cameraSelect.value); });
    cameraSelect.addEventListener('change', async ()=>{ await startCamera(cameraSelect.value); });

    captureBtn.addEventListener('click', async ()=>{ const url=dataURLFromVideo(); if(!url) return; state.captures[state.currentAngle]=url; state.scores[state.currentAngle]=await scoreBCSFor(state.currentAngle,url); renderThumbs(); renderOverall(); updateButtons(); });
    retakeBtn.addEventListener('click', ()=>{ state.captures[state.currentAngle]=null; state.scores[state.currentAngle]=null; renderThumbs(); renderOverall(); updateButtons(); });
   
    const nextAngleBtn = document.getElementById('nextAngleBtn');
    nextAngleBtn.addEventListener('click', ()=>{ const i=anglesOrder.indexOf(state.currentAngle); setAngle(anglesOrder[(i+1)%anglesOrder.length]); });

    function renderInitial(){ renderThumbs(); setAngle('rear'); renderOverall(); }

    (async function init(){ try{
      const ctx=getAnimalFromContext();
      if(animalIdInput) animalIdInput.value = ctx.id || '';
      if(eventDateInput) eventDateInput.value = ctx.date || todayCairo();
      if(numberSpan) numberSpan.textContent = ctx.number || (ctx.id ? `#${ctx.id.slice(-5)}` : '—');

      initKindBar();

     if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
  const warn = document.createElement('div');
  Object.assign(warn.style, {
    background:'#fff3cd', color:'#92400e', border:'1px solid #facc15',
    padding:'12px', borderRadius:'8px', margin:'8px 12px', fontWeight:'bold', textAlign:'center'
  });
  warn.textContent = '⚠️ متصفحك لا يدعم تشغيل الكاميرا عبر الويب. يمكنك رفع صورة بديلة.';
  document.querySelector('#cameraCard')?.prepend(warn);
}

      if(location.protocol!=='https:' && location.hostname!=='localhost'){ console.warn('يُنصح باستخدام https لتشغيل الكاميرا.'); }
      await startCamera(); await listCameras(); if(!cameraSelect.value && cameraSelect.options.length){ cameraSelect.value=cameraSelect.options[0].value; }

      renderInitial();

      document.getElementById('demoBtn')?.addEventListener('click', async ()=>{
        const kind = kindBuffalo?.checked ? 'buffalo' : 'cow';
        const REF_EXTS = ['jpg','png','webp']; const BASES = ['images/'];
        if(kind==='buffalo'){
          const base = (animalTypeSel.value==='هجين')?'bcs_hypbuf_3':'bcs_egybuf_3';
          for (const ext of REF_EXTS) {
            const u = `${BASES[0]}${base}.${ext}`;
            try {
              const im = await new Promise((ok,fail)=>{ const i=new Image(); i.onload=()=>ok(i); i.onerror=fail; i.src=u; });
              const c=document.createElement('canvas'); c.width=im.width; c.height=im.height; c.getContext('2d').drawImage(im,0,0);
              const chosen=c.toDataURL('image/jpeg',0.9);
              state.captures.rear=chosen; state.scores.rear=await scoreBCSFor('rear',chosen);
              renderThumbs(); renderOverall(); break;
            } catch {}
          }
        } else {
          const demoBase = {rear:'bsc3_rear', side:'bsc3_side'};
          for(const a of anglesOrder){
            for (const ext of REF_EXTS) {
              const u = `${BASES[0]}${demoBase[a]}.${ext}`;
              try {
                const im = await new Promise((ok,fail)=>{ const i=new Image(); i.onload=()=>ok(i); i.onerror=fail; i.src=u; });
                const c=document.createElement('canvas'); c.width=im.width; c.height=im.height; c.getContext('2d').drawImage(im,0,0);
                const chosen=c.toDataURL('image/jpeg',0.9);
                state.captures[a]=chosen; state.scores[a]=await scoreBCSFor(a,chosen);
                renderThumbs(); renderOverall(); break;
              } catch {}
            }
          }
        }
      });

      if(isDemo) document.getElementById('demoBtn')?.click();
    }catch(e){ console.warn(e); }
    })();
  </script>

  <script>
    function nukeEditorCard(){ document.querySelectorAll('editor-card,.editor-card').forEach(n=>{ try{ n.remove(); }catch{} }); }
    new MutationObserver(nukeEditorCard).observe(document.documentElement,{childList:true,subtree:true});
    document.addEventListener('DOMContentLoaded', nukeEditorCard);
  </script>
  <script type="module" src="/js/tenant-bootstrap.js"></script>
  <script type="module" src="/js/event-core.js"></script>
  <script type="module" src="/js/vision-core.js"></script>

  <!-- حفظ التقييم في فايرستور فقط -->
 <!-- حفظ التقييم في فايرستور (نهائي) -->
<!-- حفظ التقييم في فايرستور (سكور + تعليق) -->
<!-- حفظ التقييم في فايرستور (score + وصف برمجي) -->
<!-- حفظ التقييم في فايرستور + رسالة تأكيد داخلية (بدون أي alert/confirm) -->
<script type="module">
  import { db, auth, ensureAuth } from "/js/firebase-config.js";
  import { collection, addDoc, serverTimestamp }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const $  = (s,p=document)=>p.querySelector(s);
  const formBar   = $(".save-bar");
  const saveBtn   = $("#saveBtn");
  const backBtn   = $("#backEventsBtn");
  const dateInput = $("#eventDate");
  const uploadBtn = $("#uploadBtn");
  const uploadInp = $("#uploadInput");

  // صندوق رسالة داخلي يُعاد استخدامه
  const msgBox = document.createElement("div");
  Object.assign(msgBox.style, {
    marginTop:"10px", padding:"12px", borderRadius:"8px",
    textAlign:"center", fontWeight:"bold", display:"none"
  });
  formBar.appendChild(msgBox);
  function showMsg(kind, text){
    msgBox.style.display = "block";
    msgBox.style.background = (kind==="ok") ? "#c8e6c9" : "#ffcdd2";
    msgBox.style.color      = (kind==="ok") ? "#1b5e20" : "#b71c1c";
    msgBox.textContent = text;
    msgBox.scrollIntoView({behavior:"smooth", block:"center"});
  }

  // تأكيد الدخول
  try { await ensureAuth("/login.html"); } catch(e) { throw e; }

  // تاريخ افتراضي (قاهرة)
  function todayCairo(){
    const now = new Date(new Date().toLocaleString("en-US",{timeZone:"Africa/Cairo"}));
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,"0"), d=String(now.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }
  if (!dateInput.value) {
    dateInput.value = localStorage.getItem("currentEventDate") || todayCairo();
  }

  // وصف برمجي لنتيجة BCS
  function labelForScore(s){
    if(s==null) return "—";
    if(s<1.6) return "نحيفة جدًا";
    if(s<2.5) return "نحيفة";
    if(Math.abs(s-3)<0.06) return "مثالية";
    if(s<3.7) return "تميل للسمنة";
    if(s<4.6) return "سمينة";
    return "سمينة جدًا";
  }
  function buildBCSNote(bcs){
    const kindLS = localStorage.getItem("animalKind");
    const kind   = (document.getElementById("kindBuffalo")?.checked) ? "buffalo" : (kindLS || "cow");
    const type   = document.getElementById("animalType")?.value || localStorage.getItem("animalType") || "";
    const label  = labelForScore(bcs);
    const range  = (kind==="buffalo") ? "1–5" : "2–5";
    const kindTx = (kind==="buffalo") ? "جاموس" : "أبقار";
    const typeTx = type ? `، التصنيف: ${type}` : "";
    return `BCS ${bcs.toFixed(2)} (${label}) — النوع: ${kindTx}${typeTx} — النطاق ${range}؛ المثالي ≈ 3.`;
  }

  // حفظ التقييم في events عبر firebase-config.js — رسائل داخلية فقط
  saveBtn.addEventListener("click", async (e)=>{
    e.preventDefault();
    msgBox.style.display="none";

    const bcs = (typeof window.bcsScore === "number") ? Number(window.bcsScore) : NaN;
    if (!Number.isFinite(bcs)){
      showMsg("err","⚠️ احسب التقييم أولًا (التقط صورة ليظهر السكور).");
      return;
    }

    const ctx = (window.getAnimalFromContext ? window.getAnimalFromContext() : {
      id:localStorage.getItem("currentAnimalId")||"",
      number:localStorage.getItem("currentAnimalNumber")||"",
      date:localStorage.getItem("currentEventDate")||todayCairo()
    });

    const eventDate = dateInput.value || ctx.date || todayCairo();
    const animalId  = ctx.id || "";
    const animalNo  = ctx.number || "";
    const uid       = auth.currentUser?.uid || null;

    const payload = {
      type: "تقييم حالة الجسم",
      eventType: "bcs_eval",
      eventDate,
      animalId,
      animalNumber: animalNo,
      score: Number(bcs.toFixed(2)),
      value: Number(bcs.toFixed(2)),
      notes: buildBCSNote(bcs),
      comment: buildBCSNote(bcs),
      userId: uid,
      source: location.pathname,
      createdAt: serverTimestamp()
    };

    try {
      saveBtn.disabled = true;
      await addDoc(collection(db,"events"), payload);

      // حفظ السياق
      try {
        localStorage.setItem("currentEventDate", eventDate);
        if (animalId)  localStorage.setItem("currentAnimalId", animalId);
        if (animalNo)  localStorage.setItem("currentAnimalNumber", animalNo);
      } catch {}

      // ✅ تأكيد داخل الصفحة + تحويل تلقائي
      showMsg("ok","✅ تم حفظ تقييم حالة الجسم بنجاح");
      setTimeout(()=>{
        const number = animalNo || animalId || "";
        location.href = `add-event.html?number=${encodeURIComponent(number)}&date=${encodeURIComponent(eventDate)}`;
      }, 1500);

    } catch(err){
      console.error("Firestore save error:", err);
      showMsg("err","❌ حدث خطأ أثناء الحفظ. تحقق من الاتصال وصلاحيات الحساب.");
    } finally {
      saveBtn.disabled = false;
    }
  });

  // رفع صورة بديلة — ربط مرّة واحدة فقط (لمنع تكرار التحميل)
  if (uploadBtn && uploadInp){
    uploadBtn.onclick = (ev)=>{ ev.preventDefault(); uploadInp.click(); };
    uploadInp.onchange = async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = async ()=>{
        const url = r.result;
        if (window.state && window.state.currentAngle && window.scoreBCSFor){
          state.captures[state.currentAngle] = url;
          state.scores[state.currentAngle]   = await scoreBCSFor(state.currentAngle, url);
          window.renderThumbs?.(); window.renderOverall?.(); window.updateButtons?.();
        }
      };
      r.readAsDataURL(f);
      e.target.value = ""; // يسمح برفع نفس الملف مرة ثانية
    };
  }

  // زر الرجوع للأحداث
  backBtn?.addEventListener("click",(e)=>{
    e.preventDefault();
    const num = localStorage.getItem("currentAnimalNumber") || localStorage.getItem("currentAnimalId") || "";
    const dt  = dateInput.value || localStorage.getItem("currentEventDate") || todayCairo();
    location.href = `add-event.html?number=${encodeURIComponent(num)}&date=${encodeURIComponent(dt)}`;
  });
</script>


</body>
</html>
