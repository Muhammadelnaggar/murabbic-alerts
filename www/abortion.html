<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تسجيل إجهاض — مُرَبِّك</title>
  <link rel="stylesheet" href="css/forms.css" />
  <script type="module" src="/js/forms-init.js"></script>
  <style>
    :root{--green:#0ea05a;--green-600:#0b7f47;--bg:#f7faf7;--text:#0f172a;--muted:#64748b;--card:#ffffff}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text)}
    header{background:#fff;border-bottom:1px solid #e2e8f0;padding:12px 16px;font-weight:800;color:var(--green-600)}
    main{padding:16px}
    label{display:block;font-weight:700;margin-top:10px}
    input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px}
    button{width:100%;margin-top:18px;padding:14px;font-weight:800;font-size:16px;border:0;border-radius:12px;cursor:pointer}
    .primary{background:var(--green);color:#fff}
    .info{margin-top:16px;padding:12px;border-radius:10px;text-align:center;font-weight:700;display:none}
    .info.show{display:block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .info.error{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412}
  </style>
</head>
<body>
  <header>تسجيل إجهاض <span style="font-size:13px;color:#999">— مُرَبِّك</span></header>
  <main>
    <label>رقم الحيوان</label>
    <input id="animalNumber" inputmode="numeric" placeholder="مثال: 1023" />
    <label>تاريخ الإجهاض</label>
    <input id="eventDate" type="date" />
    <label>ملاحظات</label>
    <input id="notes" placeholder="اختياري" />
    <button class="primary" id="saveBtn">حفظ الإجهاض ✅</button>
    <div id="info" class="info"></div>
  </main>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import config from "/js/firebase-config.js";

    // ✅ تهيئة Firebase
    const app = getApps().length ? getApps()[0] : initializeApp(config);
    const db = getFirestore(app, "murabbikdata");

    const $ = id => document.getElementById(id);
    const info = $('info');

    // تمرير الرقم والتاريخ
    const p = new URLSearchParams(location.search);
    const num = p.get('number') || localStorage.getItem('currentAnimalNumber') || '';
    const dt = p.get('date') || localStorage.getItem('currentEventDate') || new Date().toISOString().slice(0,10);
    $('animalNumber').value = num;
    $('eventDate').value = dt;

    function msg(t,err=false){
      info.textContent=t; info.className='info show'+(err?' error':'');
    }

    function monthsBetween(d1,d2){
      if(!d1||!d2) return 0;
      const a=new Date(d1), b=new Date(d2);
      return Math.max(0,Math.round(((b-a)/30/24/3600/1000)*10)/10);
    }

    // 🔹 آخر تلقيح للحيوان
    async function lastInsemination(an){
      const evs = query(collection(db,'events'),
        where('animalNumber','==',String(an)),
        orderBy('eventDate','desc'), limit(20));
      const s = await getDocs(evs);
      if(s.empty) return null;
      const labels=['تلقيح','تلقيح مُخصِّب','insemination'];
      for(const d of s.docs){
        const t=(d.data().eventType||'').trim();
        if(labels.includes(t)){
          const ed=d.data().eventDate;
          return typeof ed==='string'?ed:ed.toDate().toISOString().slice(0,10);
        }
      }
      return null;
    }

    // 🔹 حالة الحيوان
    async function reproStatus(an){
      const qy=query(collection(db,'animals'),where('animalNumber','==',String(an)),limit(1));
      const s=await getDocs(qy);
      if(s.empty) return '';
      return (s.docs[0].data().reproductiveStatus||'').trim();
    }

    // 🔹 حفظ الإجهاض
    $('saveBtn').addEventListener('click', async ()=>{
      const animal=$('animalNumber').value.trim();
      const date=$('eventDate').value;
      if(!animal||!date){ msg('الرجاء إدخال الرقم والتاريخ',true); return; }

      msg('⏳ جار التحقق...');
      const status=await reproStatus(animal);
      if(!['عشار','pregnant','Pregnant'].includes(status)){
        msg('❌ لا يمكن تسجيل إجهاض إلا إذا كانت الحالة عِشار',true);
        return;
      }

      const lastInsem=await lastInsemination(animal);
      if(!lastInsem){ msg('⚠️ لا يوجد تلقيح سابق لتحديد عمر الحمل',true); return; }

      const age=monthsBetween(lastInsem,date);
      const cause = age>=6 ? 'بروسيلا' : 'BVD محتمل';

      try{
        await addDoc(collection(db,'events'),{
          animalNumber:animal,
          eventType:'إجهاض',
          eventDate:date,
          abortionAgeMonths:age,
          probableCause:cause,
          notes:$('notes').value||'',
          createdAt:serverTimestamp()
        });

        // تحديث الحالة
        const q=query(collection(db,'animals'),where('animalNumber','==',String(animal)),limit(1));
        const s=await getDocs(q);
        if(!s.empty){ await updateDoc(s.docs[0].ref,{reproductiveStatus:'فاضية'}); }

        msg(`✅ تم الحفظ بنجاح. عمر الحمل ${age} شهر، السبب: ${cause}`);
      }catch(e){
        console.error(e);
        msg('❌ فشل الحفظ أو الاتصال بفايرستور',true);
      }
    });
  </script>
</body>
</html>
