<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ù‡Ø§Ø¶ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</title>
  <link rel="stylesheet" href="css/forms.css" />
  <script type="module" src="/js/forms-init.js"></script>
  <style>
    :root{--green:#0ea05a;--green-600:#0b7f47;--bg:#f7faf7;--text:#0f172a;--muted:#64748b;--card:#ffffff}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text)}
    header{background:#fff;border-bottom:1px solid #e2e8f0;padding:12px 16px;font-weight:800;color:var(--green-600)}
    main{padding:16px}
    label{display:block;font-weight:700;margin-top:10px}
    input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px}
    button{width:100%;margin-top:18px;padding:14px;font-weight:800;font-size:16px;border:0;border-radius:12px;cursor:pointer}
    .primary{background:var(--green);color:#fff}
    .info{margin-top:16px;padding:12px;border-radius:10px;text-align:center;font-weight:700;display:none}
    .info.show{display:block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .info.error{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412}
  </style>
</head>
<body>
  <header>ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ù‡Ø§Ø¶ <span style="font-size:13px;color:#999">â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</span></header>
  <main>
    <label>Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
    <input id="animalNumber" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 1023" />
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶</label>
    <input id="eventDate" type="date" />
    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
    <input id="notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
    <button class="primary" id="saveBtn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶ âœ…</button>
    <div id="info" class="info"></div>
  </main>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import config from "/js/firebase-config.js";

    // âœ… ØªÙ‡ÙŠØ¦Ø© Firebase
    const app = getApps().length ? getApps()[0] : initializeApp(config);
    const db = getFirestore(app, "murabbikdata");

    const $ = id => document.getElementById(id);
    const info = $('info');

    // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
    const p = new URLSearchParams(location.search);
    const num = p.get('number') || localStorage.getItem('currentAnimalNumber') || '';
    const dt = p.get('date') || localStorage.getItem('currentEventDate') || new Date().toISOString().slice(0,10);
    $('animalNumber').value = num;
    $('eventDate').value = dt;

    function msg(t,err=false){
      info.textContent=t; info.className='info show'+(err?' error':'');
    }

    function monthsBetween(d1,d2){
      if(!d1||!d2) return 0;
      const a=new Date(d1), b=new Date(d2);
      return Math.max(0,Math.round(((b-a)/30/24/3600/1000)*10)/10);
    }

    // ğŸ”¹ Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­ Ù„Ù„Ø­ÙŠÙˆØ§Ù†
    async function lastInsemination(an){
      const evs = query(collection(db,'events'),
        where('animalNumber','==',String(an)),
        orderBy('eventDate','desc'), limit(20));
      const s = await getDocs(evs);
      if(s.empty) return null;
      const labels=['ØªÙ„Ù‚ÙŠØ­','ØªÙ„Ù‚ÙŠØ­ Ù…ÙØ®ØµÙ‘ÙØ¨','insemination'];
      for(const d of s.docs){
        const t=(d.data().eventType||'').trim();
        if(labels.includes(t)){
          const ed=d.data().eventDate;
          return typeof ed==='string'?ed:ed.toDate().toISOString().slice(0,10);
        }
      }
      return null;
    }

    // ğŸ”¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
    async function reproStatus(an){
      const qy=query(collection(db,'animals'),where('animalNumber','==',String(an)),limit(1));
      const s=await getDocs(qy);
      if(s.empty) return '';
      return (s.docs[0].data().reproductiveStatus||'').trim();
    }

    // ğŸ”¹ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶
    $('saveBtn').addEventListener('click', async ()=>{
      const animal=$('animalNumber').value.trim();
      const date=$('eventDate').value;
      if(!animal||!date){ msg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®',true); return; }

      msg('â³ Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù‚Ù‚...');
      const status=await reproStatus(animal);
      if(!['Ø¹Ø´Ø§Ø±','pregnant','Pregnant'].includes(status)){
        msg('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ù‡Ø§Ø¶ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø¹ÙØ´Ø§Ø±',true);
        return;
      }

      const lastInsem=await lastInsemination(animal);
      if(!lastInsem){ msg('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ„Ù‚ÙŠØ­ Ø³Ø§Ø¨Ù‚ Ù„ØªØ­Ø¯ÙŠØ¯ Ø¹Ù…Ø± Ø§Ù„Ø­Ù…Ù„',true); return; }

      const age=monthsBetween(lastInsem,date);
      const cause = age>=6 ? 'Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§' : 'BVD Ù…Ø­ØªÙ…Ù„';

      try{
        await addDoc(collection(db,'events'),{
          animalNumber:animal,
          eventType:'Ø¥Ø¬Ù‡Ø§Ø¶',
          eventDate:date,
          abortionAgeMonths:age,
          probableCause:cause,
          notes:$('notes').value||'',
          createdAt:serverTimestamp()
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        const q=query(collection(db,'animals'),where('animalNumber','==',String(animal)),limit(1));
        const s=await getDocs(q);
        if(!s.empty){ await updateDoc(s.docs[0].ref,{reproductiveStatus:'ÙØ§Ø¶ÙŠØ©'}); }

        msg(`âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­. Ø¹Ù…Ø± Ø§Ù„Ø­Ù…Ù„ ${age} Ø´Ù‡Ø±ØŒ Ø§Ù„Ø³Ø¨Ø¨: ${cause}`);
      }catch(e){
        console.error(e);
        msg('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ÙØ§ÙŠØ±Ø³ØªÙˆØ±',true);
      }
    });
  </script>
</body>
</html>
