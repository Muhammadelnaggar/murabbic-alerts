<!DOCTYPE html>
<html lang="ar" dir="rtl" data-page="abortion">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- ğŸ”¥ Ø³ÙƒØ±Ø¨Øª ØªØ­Ø¯ÙŠØ« ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©) -->
  <script type="module">
    import { updateAnimalByEvent } from "/js/animal-update.js";
    window.updateAnimalByEvent = updateAnimalByEvent;
  </script>

  <title>ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ù‡Ø§Ø¶ â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</title>
  <link rel="stylesheet" href="css/forms.css" />
  <script type="module" src="js/forms-init.js"></script>

  <style>
    :root{
      --green:#0ea05a;--green-600:#0b7f47;--bg:#f7faf7;
      --text:#0f172a;--card:#ffffff;
      --ok-bg:#ecfdf5;--ok-text:#065f46;
      --err-bg:#fff7ed;--err-text:#9a3412
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Cairo',system-ui;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e2e8f0;padding:12px 16px;text-align:center;font-weight:800;color:var(--green-600)}
    main{padding:16px;max-width:600px;margin:auto}
    label{display:block;margin-top:12px;font-weight:700}
    input,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    button{width:100%;margin-top:20px;padding:14px;background:var(--green);color:#fff;border:0;border-radius:10px;font-weight:800;font-size:16px;cursor:pointer}
    .infobar{margin-top:10px;padding:10px;border-radius:8px;font-size:14px;font-weight:700;text-align:center}
    .ok{background:var(--ok-bg);color:var(--ok-text);border:1px solid #bbf7d0}
    .err{background:var(--err-bg);color:var(--err-text);border:1px solid #fed7aa}
  </style>
</head>

<body data-page="abortion">
<header>ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ù‡Ø§Ø¶</header>

<main>
  <div id="info" class="infobar"></div>

  <label>Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
  <input id="animalNumber" readonly />

  <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶</label>
  <input id="eventDate" type="date" />

  <label>Ø¹Ù…Ø± Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶ (Ø¨Ø§Ù„Ø´Ù‡ÙˆØ±)</label>
  <input id="abortionAge" readonly />

  <label>Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„</label>
  <input id="probableCause" readonly />

  <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
  <textarea id="notes" rows="3" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea>

  <button id="saveBtn" data-validate="true">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶ âœ…</button>
</main>

<script type="module">

  import { db, auth } from "/js/firebase-config.js";
  import {
    collection, addDoc, getDocs,
    query, where, orderBy, limit,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const $ = id => document.getElementById(id);
  const info = $("info");
  const btn  = $("saveBtn");
  btn.disabled = true;

  // Ø¯Ø±ÛŒØ§ÙØª Ø§Ù„Ù…Ø¹Ø·ÙŠØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
  const p   = new URLSearchParams(location.search);
  const num = p.get("number") || localStorage.getItem("lastAnimalNumber") || "";
  const dt  = p.get("date")   || new Date().toISOString().slice(0,10);

  $("animalNumber").value = num;
  $("eventDate").value    = dt;

  function msg(t, ok=false){
    info.className = "infobar " + (ok ? "ok" : "err");
    info.textContent = t;
  }

  // ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ø­Ø§Ù„Ø© = Ø¹ÙØ´Ø§Ø±
  async function checkAnimal(){
    try {
      let snap = await getDocs(query(
        collection(db,"animals"),
        where("number","==",num),
        limit(1)
      ));

      if (snap.empty){
        msg("âš ï¸ Ø§Ù„Ø­ÙŠÙˆØ§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", false);
        btn.disabled = true;
        return false;
      }

      const a = snap.docs[0].data();
      const status = (a.reproductiveStatus || "").trim();

      if (status !== "Ø¹ÙØ´Ø§Ø±"){
        msg("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ù‡Ø§Ø¶ Ù„Ø­ÙŠÙˆØ§Ù† ØºÙŠØ± Ø¹ÙØ´Ø§Ø±.", false);
        btn.disabled = true;
        return false;
      }

      msg("âœ… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø¹ÙØ´Ø§Ø± â€” ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶.", true);
      btn.disabled = false;

      // Ø­Ø³Ø§Ø¨ Ø¹Ù…Ø± Ø§Ù„Ø­Ù…Ù„ Ù…Ù† Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­
      const insQ = query(
        collection(db,"events"),
        where("animalNumber","==",num),
        where("type","==","insemination"),
        orderBy("eventDate","desc"),
        limit(1)
      );
      const insSnap = await getDocs(insQ);

      let lastInsem = insSnap.empty
        ? a.lastInseminationDate
        : insSnap.docs[0].data().eventDate;

      if (!lastInsem){
        $("abortionAge").value = "";
        $("probableCause").value = "";
        return true;
      }

      const d1 = new Date(lastInsem);
      const d2 = new Date(dt);
      const months = ((d2 - d1)/(1000*60*60*24*30.44)).toFixed(1);

      $("abortionAge").value = months;
      $("probableCause").value =
        months >= 6 ? "Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§ (â‰¥Ù¦ Ø´Ù‡ÙˆØ±)" :
                      "Ø§Ø­ØªÙ…Ø§Ù„ BVD (<Ù¦ Ø´Ù‡ÙˆØ±)";

      return true;

    } catch(e){
      console.error(e);
      msg("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚.", false);
      btn.disabled = true;
      return false;
    }
  }

  await checkAnimal();

  // ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø«
  btn.onclick = async () => {
    try{

      const payload = {
        animalNumber: num,
        animalId: num,
        eventType: "Ø¥Ø¬Ù‡Ø§Ø¶",
        type: "abortion",
        eventDate: dt,
        abortionAgeMonths: parseFloat($("abortionAge").value) || null,
        probableCause: $("probableCause").value || "",
        notes: $("notes").value || "",
        userId: auth.currentUser?.uid || null,
        createdAt: serverTimestamp()
      };

      // Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø«
      await addDoc(collection(db,"events"), payload);

      // ğŸŸ¢ ØªØ­Ø¯ÙŠØ« ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† (Ø¹ÙØ´Ø§Ø± â†’ ØºÙŠØ± Ø¹ÙØ´Ø§Ø± + lastAbortionDate)
      await window.updateAnimalByEvent(payload);

      msg("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶ Ø¨Ù†Ø¬Ø§Ø­", true);
      localStorage.setItem("lastAnimalNumber", num);
      localStorage.setItem("lastEventDate", dt);

      setTimeout(()=>location.href=`cow-card.html?number=${num}`,1200);

    }catch(e){
      console.error(e);
      msg("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸.", false);
    }
  };

  // ØªØªØ¨Ø¹
  window.dataLayer = window.dataLayer || [];
  const t = window.t || {event:(n,d)=>window.dataLayer.push({event:n,...d})};
  t.event("page_view",{page:"abortion"});
</script>

</body>
</html>
