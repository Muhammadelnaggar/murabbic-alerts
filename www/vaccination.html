<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script type="module">
  import { updateAnimalByEvent } from "/js/animal-update.js";
  window.updateAnimalByEvent = updateAnimalByEvent;
</script>

  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</title>
  <style>
  .mbk-head-vax{
    max-width: 780px;
    margin: 12px auto 16px;
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    padding: 10px 14px;
  }

  .mbk-back-pill{
    width: 56px;
    height: 56px;
    border-radius: 999px;
    background: #fff;
    border: 2px solid #0ea05a;
    color: #0b7f47;
    font-weight: 800;
    cursor: pointer;
  }

  .mbk-center{
    text-align: center;
    line-height: 1.1;
  }

  .mbk-page-title{
    color:#000;
    font-weight: 900;
    font-size: 23px;
  }

  .mbk-brand{
    color:#0ea05a;
    font-weight: 900;
    font-size: 18px;
    margin-top: 4px;
  }

  .mbk-logo-vax{
    width: 70px;
    height: 70px;
    object-fit: contain;
  }
/* ===== Header Style ===== */

.mbk-head-vax{
  max-width: 780px;
  margin: 12px auto 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
}

.mbk-right,
.mbk-left{
  width: 80px;
  display: flex;
  justify-content: center;
}

.mbk-center{
  text-align: center;
  flex: 1;
  line-height: 1.1;
}

.mbk-page-title{
  color:#000;
  font-weight: 900;
  font-size: 24px;
}

.mbk-brand{
  color:#0ea05a;
  font-weight: 900;
  font-size: 18px;
  margin-top: 4px;
}

.mbk-logo-vax{
  width: 70px;
  height: 70px;
  object-fit: contain;
}

.mbk-back-pill{
  width: 56px;
  height: 56px;
  border-radius: 999px;
  background: #fff;
  border: 2px solid #0ea05a;
  color: #0b7f47;
  font-weight: 900;
  cursor: pointer;
}
    
</style>
</head>
<body>
 <header class="mbk-head-vax">
  
  <div class="mbk-right">
    <button type="button" id="backToEventsBtn" class="mbk-back-pill">
      Ø±Ø¬ÙˆØ¹
    </button>
  </div>

  <div class="mbk-center">
    <div class="mbk-page-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</div>
    <div class="mbk-brand">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
  </div>

  <div class="mbk-left">
    <img src="/images/logo.png" class="mbk-logo-vax" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
  </div>

</header>


  <div class="context">
    <span id="ctxAnimal" class="pill">Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
    <span id="ctxDate" class="pill">Ø§Ù„ØªØ§Ø±ÙŠØ®: â€”</span>
  </div>

  <div class="card">
    <form id="vaccinationForm">
      <div class="row row-2">
        <div>
          <label for="animalId">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
          <input id="animalId" type="text" placeholder="Ù…Ø«Ø§Ù„: 105"/>
        </div>
        <div>
          <label for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="date" type="date"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="vaccine">Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ†</label>
          <select id="vaccine">
            <option value="" selected disabled>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ†</option>
            <option value="Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ© (FMD)">Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ© (FMD)</option>
            <option value="Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ÙŠ (LSD)">Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ÙŠ (LSD)</option>
            <option value="Ø§Ù„ØªØ³Ù…Ù… Ø§Ù„Ù…Ø¹ÙˆÙŠ (Clostridial)">Ø§Ù„ØªØ³Ù…Ù… Ø§Ù„Ù…Ø¹ÙˆÙŠ (Clostridial)</option>
            <option value="Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§ (Brucella)">Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§ (Brucella)</option>
            <option value="IBR">IBR</option>
            <option value="BVD">BVD</option>
            <option value="Ø§Ù„Ø¬Ù…Ø±Ø© Ø§Ù„Ø®Ø¨ÙŠØ«Ø© (Anthrax)">Ø§Ù„Ø¬Ù…Ø±Ø© Ø§Ù„Ø®Ø¨ÙŠØ«Ø© (Anthrax)</option>
            <option value="Ø§Ù„Ø¨Ø§Ø³ØªØ±ÙŠÙ„Ø§/Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ (HS/Pasteurella)">Ø§Ù„Ø¨Ø§Ø³ØªØ±ÙŠÙ„Ø§/Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ (HS/Pasteurella)</option>
          </select>
        </div>
      </div>

      <label>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¹Ø©</label>
      <div class="radio-group">
        <label><input type="radio" name="doseType" value="primary"/> Ø£ÙˆÙ„ÙŠØ©</label>
        <label><input type="radio" name="doseType" value="booster"/> Ù…Ù†Ø´Ø·Ø©</label>
      </div>

      <div id="warn" class="warn"></div>

      <div id="inlineMsg" class="notice" role="status" aria-live="polite">
        <div class="text"></div>
        <div class="actions">
          <button type="button" id="msgYes" class="btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« Ø£Ø®Ø±Ù‰</button>
          <button type="button" id="msgNo"  class="btn-ghost">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
        </div>
      </div>
    </form>
  </div>

  <div class="actions">
    <div class="wrap">
      <button id="saveBtn" class="btn-primary" type="button">ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Ø¹Ù†Ø§ØµØ±
    const ctxAnimal = document.getElementById('ctxAnimal');
    const ctxDate   = document.getElementById('ctxDate');
    const form      = document.getElementById('vaccinationForm');
    const animalIdEl= document.getElementById('animalId');
    const dateEl    = document.getElementById('date');
    const vaccineEl = document.getElementById('vaccine');
    const saveBtn   = document.getElementById('saveBtn');
    const warn      = document.getElementById('warn');
    const msgBox    = document.getElementById('inlineMsg');
    const msgText   = msgBox.querySelector('.text');
    const btnYes    = document.getElementById('msgYes');
    const btnNo     = document.getElementById('msgNo');

    function todayLocal(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    function showWarn(t){ warn.textContent=t; }
    function clearWarn(){ warn.textContent=''; }
    function showMsg(text){ msgText.textContent=text; msgBox.style.display='block'; }
    function hideMsg(){ msgBox.style.display='none'; msgText.textContent=''; }

    function hydrate(){
      const qp = new URLSearchParams(location.search);
      const id = qp.get('animalId') || qp.get('animalIdd') || qp.get('number') || localStorage.getItem('lastAnimalId') || '';
      const dt = qp.get('date') || todayLocal();
      animalIdEl.value = id; if(id) animalIdEl.readOnly = true;
      dateEl.value = dt;
      ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${id||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
      try{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(dt).toLocaleDateString('ar-EG')}`; }catch{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dt}`; }
    }

    hydrate();

    animalIdEl.addEventListener('input', ()=>{ ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${animalIdEl.value.trim()||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`; });
    dateEl.addEventListener('input', ()=>{ try{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(dateEl.value).toLocaleDateString('ar-EG')}`;}catch{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateEl.value}`; } });

    async function setupFirebase(){
      try{
        const mod = await import('./js/firebase-config.js?v=4');
        if(mod?.db && mod?.auth){ return { db:mod.db, auth:mod.auth }; }
        if(mod?.firebaseConfig){ const app=initializeApp(mod.firebaseConfig); return { db:getFirestore(app), auth:getAuth(app) }; }
      }catch(e){ console.warn('fb cfg import failed', e); }
      try{ const cfg = await import('./config.js?v=4'); const app=initializeApp(cfg.firebaseConfig); return { db:getFirestore(app), auth:getAuth(app) }; }catch(e2){ showWarn('âŒ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.'); return { db:null, auth:null }; }
    }

    function getDoseType(){
      const el = document.querySelector('input[name="doseType"]:checked');
      return el ? el.value : null;
    }

    function getCtx(){
      const animalId=animalIdEl.value.trim();
      const dt=dateEl.value.trim();
      const vaccine=vaccineEl.value;
      const doseType=getDoseType();
      if(!animalId||!dt||!vaccine||!doseType){ showWarn('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ† ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¹Ø©.'); return null;}
      clearWarn(); localStorage.setItem('lastAnimalId', animalId);
      return { animalId, dt, vaccine, doseType };
    }

    const { db, auth } = await setupFirebase();

    async function saveVaccination(){
      const ctx = getCtx(); if(!ctx) return;
      const payload = {
        type:'vaccination', eventType:'ØªØ­ØµÙŠÙ†',
        animalId: ctx.animalId, animalNumber: ctx.animalId,
        date: ctx.dt,
        vaccine: ctx.vaccine,
        doseType: ctx.doseType, // primary | booster
        userId: auth?.currentUser?.uid || null,
        createdAt: serverTimestamp()
      };

      saveBtn.disabled = true; saveBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸';
      try{
        if(db) await addDoc(collection(db,'events'), payload);
        await window.updateAnimalByEvent(payload);

        hideMsg(); showMsg('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
      }catch(e){ console.error(e); showWarn('âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'); }
      finally{ saveBtn.disabled=false; saveBtn.textContent='ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†'; }
    }

    saveBtn.addEventListener('click', saveVaccination);
    form.addEventListener('submit', (e)=>{ e.preventDefault(); saveVaccination(); });

    btnYes.addEventListener('click', ()=>{
      const qp = new URLSearchParams(location.search);
      const id = animalIdEl.value.trim() || qp.get('animalId') || qp.get('animalIdd') || qp.get('number') || '';
      const dt = dateEl.value.trim() || qp.get('date') || todayLocal();
      hideMsg();
      location.href = `add-event.html?animalId=${encodeURIComponent(id)}&animalIdd=${encodeURIComponent(id)}&number=${encodeURIComponent(id)}&date=${encodeURIComponent(dt)}`;
    });
    btnNo.addEventListener('click', ()=>{ hideMsg(); location.href = 'dashboard.html'; });
  </script>
</body>
</html>





