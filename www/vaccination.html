
<script type="module">
  import { db, auth } from "./js/firebase-config.js";
  import { addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const form = document.getElementById("vaccinationForm");

  onAuthStateChanged(auth, (user) => {
    if (!user) { window.location.href = "login.html"; return; }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const singleId = document.getElementById("animalId").value.trim();
      const groupIdsRaw = document.getElementById("animalIds").value;

      // كوّن قائمة الأرقام
      let ids = [];
      const isSingle = !!singleId;
      if (isSingle) {
        ids = [singleId];
      } else {
        ids = groupIdsRaw
          .split(/[\n,]+/)
          .map(s => s.trim())
          .filter(Boolean);
      }

      if (ids.length === 0) {
        alert("يرجى إدخال رقم حيوان واحد على الأقل");
        return;
      }

      // اقرأ الحقول كما هي
      const date = document.getElementById("date").value;
      const vaccineType = document.getElementById("vaccineType").value;
      const doseTypeEl = document.querySelector('input[name="doseType"]:checked');
      const doseType = doseTypeEl ? doseTypeEl.value : "";
      const veterinarianName = document.getElementById("vetName").value;

      const common = {
        userId: user.uid,
        date,
        vaccineType,
        doseType,
        veterinarianName,
        type: "تحصين",
        isSmartAlert: true,
        alertRule: "vaccination-next-dose-reminder",
        createdAt: serverTimestamp()
      };

      let successCount = 0;
      for (const id of ids) {
        const payload = { ...common, animalId: id, animalNumber: id };
        try {
          await addDoc(collection(db, "events"), payload);
          successCount++;
        } catch (err) {
          console.error(`❌ خطأ عند تسجيل الحيوان ${id}:`, err);
        }
      }

      // ابحار بعد الحفظ — حسب فردي/جماعي
      if (isSingle) {
        const goEvents = confirm(`✅ تم تسجيل التحصين للحيوان ${singleId}.\n\nهل تريد تسجيل أحداث أخرى لهذا الحيوان؟`);
        if (goEvents) {
          window.location.href = `add-event.html?number=${encodeURIComponent(singleId)}`;
        } else {
          window.location.href = "dashboard.html";
        }
      } else {
        const again = confirm(`✅ تم تسجيل التحصين لـ ${successCount} من ${ids.length} حيوان.\n\nهل تريد تسجيل تحصين آخر؟`);
        if (again) {
          form.reset();
          // ثبّت التاريخ على اليوم بعد التفريغ (اختياري)
          document.getElementById("date").value = new Date().toISOString().slice(0,10);
        } else {
          window.location.href = "dashboard.html";
        }
      }
    });
  });
</script>
