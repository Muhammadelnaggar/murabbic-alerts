<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</title>
  <style>
    body{direction:rtl;background:#fffde7;font-family:'Arial',sans-serif;margin:0;padding:18px;color:#1b5e20}
    h1{margin:0 0 12px;text-align:center;color:#2e7d32;font-size:24px}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #8bc34a;border-radius:999px;background:#dcedc8;color:#1b5e20;font-size:14px}
    .context{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:6px 0 12px}
    .card{max-width:520px;margin:0 auto;background:#f1f8e9;border:1px solid #c5e1a5;border-radius:12px;padding:16px}
    label{display:block;margin-top:12px;font-weight:bold;color:#2e7d32}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin-top:6px;font-size:16px;box-sizing:border-box}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:640px){.row-2{grid-template-columns:1fr 1fr}}
    .actions{position:sticky;bottom:0;left:0;right:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.1) blur(2px);border-top:1px solid #c5e1a5;padding:10px 0;margin-top:14px}
    .actions .wrap{max-width:520px;margin:0 auto;display:flex;gap:8px}
    button{appearance:none;border:0;border-radius:8px;padding:12px 14px;font-weight:bold;font-size:16px;cursor:pointer}
    .btn-primary{background:#2e7d32;color:#fff}
    .btn-ghost{background:#fff;border:1px solid #2e7d32;color:#2e7d32}
    .notice{display:none;margin-top:10px;padding:12px;border-radius:10px;background:#f0fdf4;border:1px solid #bbf7d0;color:#065f46}
    .notice .actions{display:flex;gap:8px;margin-top:10px;position:static;border:0;background:transparent;padding:0}
    .warn{color:#c62828;text-align:center;min-height:22px;margin-top:8px}
  </style>
</head>
<body>
  <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</h1>
  <div class="context">
    <span id="ctxAnimal" class="pill">Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
    <span id="ctxDate" class="pill">Ø§Ù„ØªØ§Ø±ÙŠØ®: â€”</span>
  </div>

  <div class="card">
    <form id="vaccinationForm">
      <div class="row">
        <div>
          <label for="animalId">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
          <input id="animalId" type="text" placeholder="Ù…Ø«Ø§Ù„: 105"/>
        </div>
        <div>
          <label for="date">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ†</label>
          <input id="date" type="date"/>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label for="vaccine">Ù†ÙˆØ¹ Ø§Ù„Ù„Ù‚Ø§Ø­</label>
          <input id="vaccine" list="vaccines" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ©"/>
          <datalist id="vaccines">
            <option value="Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ© (FMD)"></option>
            <option value="Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ÙŠ (LSD)"></option>
            <option value="Ø§Ù„ØªØ³Ù…Ù… Ø§Ù„Ù…Ø¹ÙˆÙŠ (Enterotoxemia)"></option>
            <option value="Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§ (Brucella)"></option>
          </datalist>
        </div>
        <div>
          <label for="dose">Ø§Ù„Ø¬Ø±Ø¹Ø©</label>
          <input id="dose" type="text" placeholder="Ù…Ø«Ø§Ù„: 2 Ù…Ù„"/>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label for="route">Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø·Ø§Ø¡</label>
          <select id="route">
            <option value="IM">Ø¹Ø¶Ù„ÙŠ (IM)</option>
            <option value="SC">ØªØ­Øª Ø§Ù„Ø¬Ù„Ø¯ (SC)</option>
            <option value="Oral">ÙÙ…ÙˆÙŠ</option>
            <option value="Spray">Ø±Ø´</option>
            <option value="Other">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>
        <div>
          <label for="nextDue">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¬Ø±Ø¹Ø©/Ø§Ù„ØªØ­ØµÙŠÙ† Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
          <input id="nextDue" type="date"/>
        </div>
      </div>

      <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="notes" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª..."></textarea>

      <div id="warn" class="warn"></div>

      <div id="inlineMsg" class="notice" role="status" aria-live="polite">
        <div class="text"></div>
        <div class="actions">
          <button type="button" id="msgYes" class="btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« Ø£Ø®Ø±Ù‰</button>
          <button type="button" id="msgNo"  class="btn-ghost">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
        </div>
      </div>
    </form>
  </div>

  <div class="actions">
    <div class="wrap">
      <button id="saveBtn" class="btn-primary" type="button">ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</button>
      <button id="resetBtn" class="btn-ghost" type="button">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Ø¹Ù†Ø§ØµØ±
    const ctxAnimal = document.getElementById('ctxAnimal');
    const ctxDate   = document.getElementById('ctxDate');
    const form      = document.getElementById('vaccinationForm');
    const animalIdEl= document.getElementById('animalId');
    const dateEl    = document.getElementById('date');
    const vaccineEl = document.getElementById('vaccine');
    const doseEl    = document.getElementById('dose');
    const routeEl   = document.getElementById('route');
    const nextDueEl = document.getElementById('nextDue');
    const notesEl   = document.getElementById('notes');

    const saveBtn   = document.getElementById('saveBtn');
    const resetBtn  = document.getElementById('resetBtn');
    const warn      = document.getElementById('warn');

    const msgBox    = document.getElementById('inlineMsg');
    const msgText   = msgBox.querySelector('.text');
    const btnYes    = document.getElementById('msgYes');
    const btnNo     = document.getElementById('msgNo');

    function todayLocal(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    function showWarn(t){ warn.textContent=t; }
    function clearWarn(){ warn.textContent=''; }
    function showMsg(text){ msgText.textContent=text; msgBox.style.display='block'; }
    function hideMsg(){ msgBox.style.display='none'; msgText.textContent=''; }

    function hydrate(){
      const qp = new URLSearchParams(location.search);
      const id = qp.get('animalId') || qp.get('animalIdd') || qp.get('number') || localStorage.getItem('lastAnimalId') || '';
      const dt = qp.get('date') || todayLocal();
      animalIdEl.value = id; if(id) animalIdEl.readOnly = true;
      dateEl.value = dt;
      ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${id||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
      try{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(dt).toLocaleDateString('ar-EG')}`; }catch{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dt}`; }
    }

    hydrate();

    animalIdEl.addEventListener('input', ()=>{ ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${animalIdEl.value.trim()||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`; });
    dateEl.addEventListener('input', ()=>{ try{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(dateEl.value).toLocaleDateString('ar-EG')}`;}catch{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateEl.value}`; } });

    async function setupFirebase(){
      try{
        const mod = await import('./js/firebase-config.js?v=3');
        if(mod?.db && mod?.auth){ return { db:mod.db, auth:mod.auth }; }
        if(mod?.firebaseConfig){ const app=initializeApp(mod.firebaseConfig); return { db:getFirestore(app), auth:getAuth(app) }; }
      }catch(e){ console.warn('fb cfg import failed', e); }
      try{ const cfg = await import('./config.js?v=3'); const app=initializeApp(cfg.firebaseConfig); return { db:getFirestore(app), auth:getAuth(app) }; }catch(e2){ showWarn('âŒ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.'); return { db:null, auth:null }; }
    }

    function getCtx(){ const animalId=animalIdEl.value.trim(); const dt=dateEl.value.trim(); if(!animalId||!dt){ showWarn('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ†.'); return null;} clearWarn(); localStorage.setItem('lastAnimalId', animalId); return { animalId, dt }; }

    const { db, auth } = await setupFirebase();

    async function saveVaccination(){
      const ctx = getCtx(); if(!ctx) return;
      const payload = {
        type:'vaccination', eventType:'ØªØ­ØµÙŠÙ†',
        animalId: ctx.animalId, animalNumber: ctx.animalId,
        date: ctx.dt,
        vaccine: vaccineEl.value.trim() || null,
        dose: doseEl.value.trim() || null,
        route: routeEl.value || null,
        nextDue: nextDueEl.value || null,
        notes: notesEl.value.trim() || null,
        userId: auth?.currentUser?.uid || null,
        createdAt: serverTimestamp()
      };

      saveBtn.disabled = true; saveBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸';
      try{
        if(db) await addDoc(collection(db,'events'), payload);
        hideMsg();
        showMsg('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
      }catch(e){ console.error(e); showWarn('âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'); }
      finally{ saveBtn.disabled=false; saveBtn.textContent='ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†'; }
    }

    saveBtn.addEventListener('click', saveVaccination);
    form.addEventListener('submit', (e)=>{ e.preventDefault(); saveVaccination(); });

    btnYes.addEventListener('click', ()=>{
      const ctx = getCtx(); if(!ctx) return;
      hideMsg();
      location.href = `add-event.html?animalId=${encodeURIComponent(ctx.animalId)}&animalIdd=${encodeURIComponent(ctx.animalId)}&number=${encodeURIComponent(ctx.animalId)}&date=${encodeURIComponent(ctx.dt)}`;
    });
    btnNo.addEventListener('click', ()=>{ hideMsg(); location.href = 'dashboard.html'; });

    resetBtn.addEventListener('click', ()=>{
      form.reset(); hydrate(); hideMsg(); clearWarn();
    });
  </script>
</body>
</html>
