<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script type="module">
  import { updateAnimalByEvent } from "/js/animal-update.js";
  window.updateAnimalByEvent = updateAnimalByEvent;
</script>

  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</title>
  <style>
 /* ===== Header Style (ONE VERSION) ===== */

.mbk-head-vax{
  max-width: 780px;
  margin: 10px auto 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
}
.mbk-right,
.mbk-left{
  width: 64px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.mbk-center{
  text-align: center;
  flex: 1;
  line-height: 1.05;
}

.mbk-page-title{
  color:#000;
  font-weight: 900;
  font-size: 20px;
}

.mbk-brand{
  color:#0ea05a;
  font-weight: 900;
  font-size: 15px;
  margin-top: 3px;
}

.mbk-logo-vax{
  width: 56px;
  height: 56px;
  object-fit: contain;
}

.mbk-back-pill{
  width: 44px;
  height: 44px;
  border-radius: 999px;
  background: #fff;
  border: 2px solid #0ea05a;
  color: #0b7f47;
  font-weight: 900;
  font-size: 13px;
  cursor: pointer;
}
/* ===== Bottom Bar (Murabbik) ===== */
.mbk-bottombar{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,.96);
  border-top: 1px solid #e2e8f0;
  padding: 10px 12px;
  z-index: 20;
}

.mbk-bottombar-wrap{
  max-width: 520px;
  margin: 0 auto;
  display: flex;
  gap: 10px;
}

.mbk-btn{
  flex: 1;
  appearance: none;
  border-radius: 12px;
  padding: 12px 14px;
  font-weight: 900;
  font-size: 16px;
  cursor: pointer;
}

.mbk-btn-primary{
  border: 0;
  background: #0ea05a;
  color: #fff;
}

.mbk-btn-ghost{
  background: #fff;
  border: 2px solid #0ea05a;
  color: #0b7f47;
}
/* ===== Center everything between header & bottom bar ===== */
.mbk-main{
  max-width: 520px;
  margin: 0 auto;
  padding: 0 12px 92px; /* âœ… Ù…Ø³Ø§Ø­Ø© ØªØ­Øª Ø¹Ø´Ø§Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ Ù…Ø§ ÙŠØºØ·ÙŠØ´ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
  box-sizing: border-box;
}
/* ===== Dose Type Container ===== */
.radio-group{
  display: flex;
  gap: 16px;
  align-items: center;
  justify-content: center;
  margin-top: 8px;
}

.radio-group label{
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  cursor: pointer;
}
/* ===== Dose White Container ===== */
.dose-container{
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 14px;
  padding: 14px 12px;
  margin-top: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,.04);
}

/* Radio buttons inside */
.radio-group{
  display: flex;
  gap: 18px;
  align-items: center;
  justify-content: center; /* ØªÙˆØ³ÙŠØ· ÙƒØ§Ù…Ù„ */
}

.radio-group label{
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 700;
  cursor: pointer;
}

.radio-group input[type="radio"]{
  accent-color: #0ea05a; /* Ù„ÙˆÙ† Ù…Ø±Ø¨ÙŠÙƒ */
}
/* ===== Bulk (Mobile First) ===== */
.bulk-box{
  background:#fff;
  border:1px solid #e2e8f0;
  border-radius:14px;
  padding:12px;
  margin-top:8px;
}

.bulk-tools{
  display:grid;
  grid-template-columns: 1fr auto auto;
  gap:8px;
  align-items:center;
  margin-top:8px;
}

#bulkSearch{
  width:100%;
  padding:10px 12px;
  border:1px solid #cbd5e1;
  border-radius:12px;
  font-size:16px;
  box-sizing:border-box;
}

.bulk-list{
  margin-top:10px;
  max-height: 220px;
  overflow:auto;
  border:1px solid #e2e8f0;
  border-radius:12px;
  padding:6px;
}

.bulk-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 10px;
  border-radius:10px;
  border:1px solid transparent;
  cursor:pointer;
  user-select:none;
}

.bulk-item:hover{ border-color:#cfe7d8; background:#f7faf7; }
.bulk-item input{ width:18px; height:18px; accent-color:#0ea05a; }

.bulk-num{ font-weight:900; color:#0f172a; }
.bulk-hint{ margin-top:8px; font-size:12px; color:#64748b; text-align:center; }   
 /* ===== Entry Mode Container ===== */
.mode-container{
  background:#fff;
  border:1px solid #e2e8f0;
  border-radius:14px;
  padding:12px 10px;
  margin-top:6px;
  box-shadow: 0 2px 6px rgba(0,0,0,.04);
}

.mode-switch{
  display:flex;
  justify-content:center;   /* ØªÙˆØ³ÙŠØ· Ø£ÙÙ‚ÙŠ */
  align-items:center;
  gap:24px;
}

.mode-switch label{
  display:flex;
  align-items:center;
  gap:6px;
  font-weight:800;
  cursor:pointer;
}

.mode-switch input[type="radio"]{
  accent-color:#0ea05a; /* Ù„ÙˆÙ† Ù…Ø±Ø¨ÙŠÙƒ */
}
 /* ===== Entry Mode Pills ===== */

.mode-container{
  background:#fff;
  border:1px solid #e2e8f0;
  border-radius:14px;
  padding:10px;
  margin-top:6px;
  box-shadow: 0 2px 6px rgba(0,0,0,.04);
}

.mode-pills{
  display:flex;
  justify-content:center;
  gap:12px;
}

.mode-pills .pill{
  padding:8px 22px;
  border-radius:999px;
  border:2px solid #0ea05a;
  font-weight:900;
  cursor:pointer;
  color:#0b7f47;
  transition:all .2s ease;
  user-select:none;
}

/* Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© */
#modeSingle:checked + label,
#modeBulk:checked + label{
  background:#0ea05a;
  color:#fff;
}
</style>
</head>
<body>
 <header class="mbk-head-vax">
  
  <div class="mbk-right">
    <button type="button" id="backToEventsBtn" class="mbk-back-pill">
      Ø±Ø¬ÙˆØ¹
    </button>
  </div>

  <div class="mbk-center">
    <div class="mbk-page-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</div>
    <div class="mbk-brand">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
  </div>

  <div class="mbk-left">
    <img src="/images/logo.png" class="mbk-logo-vax" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
  </div>

</header>
  <main class="mbk-main">
  <div class="context">
    <span id="ctxAnimal" class="pill">Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
    <span id="ctxDate" class="pill">Ø§Ù„ØªØ§Ø±ÙŠØ®: â€”</span>
  </div>

  <div class="card">
    <form id="vaccinationForm">
      <div class="row row-2">
        <div>
          <label for="animalId">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
        <div class="mode-container">
  <div class="mode-pills">
    <input type="radio" id="modeSingle" name="entryMode" value="single" checked hidden>
    <label for="modeSingle" class="pill">ÙØ±Ø¯ÙŠ</label>

    <input type="radio" id="modeBulk" name="entryMode" value="bulk" hidden>
    <label for="modeBulk" class="pill">Ø¬Ù…Ø§Ø¹ÙŠ</label>
  </div>
</div>



<div id="bulkBox" class="bulk-box" style="display:none;">
  <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª (Ø¬Ù…Ø§Ø¹ÙŠ)</label>

  <div class="bulk-tools">
    <input id="bulkSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø±Ù‚Ù…..." inputmode="numeric">
    <button type="button" id="bulkSelectAll" class="btn-ghost">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
    <button type="button" id="bulkClearAll" class="btn-ghost">Ù…Ø³Ø­</button>
  </div>

  <div id="bulkList" class="bulk-list" role="listbox" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª"></div>

  <div class="bulk-hint">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø±Ù‚Ù… (Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„).</div>
</div>


          <input id="animalId" type="text" placeholder="Ù…Ø«Ø§Ù„: 105"/>
        </div>
        <div>
          <label for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="date" type="date"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="vaccine">Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ†</label>
          <select id="vaccine">
            <option value="" selected disabled>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ†</option>
            <option value="Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ© (FMD)">Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ© (FMD)</option>
            <option value="Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ÙŠ (LSD)">Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ÙŠ (LSD)</option>
            <option value="Ø§Ù„ØªØ³Ù…Ù… Ø§Ù„Ù…Ø¹ÙˆÙŠ (Clostridial)">Ø§Ù„ØªØ³Ù…Ù… Ø§Ù„Ù…Ø¹ÙˆÙŠ (Clostridial)</option>
            <option value="Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§ (Brucella)">Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§ (Brucella)</option>
            <option value="IBR">IBR</option>
            <option value="BVD">BVD</option>
            <option value="Ø§Ù„Ø¬Ù…Ø±Ø© Ø§Ù„Ø®Ø¨ÙŠØ«Ø© (Anthrax)">Ø§Ù„Ø¬Ù…Ø±Ø© Ø§Ù„Ø®Ø¨ÙŠØ«Ø© (Anthrax)</option>
            <option value="Ø§Ù„Ø¨Ø§Ø³ØªØ±ÙŠÙ„Ø§/Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ (HS/Pasteurella)">Ø§Ù„Ø¨Ø§Ø³ØªØ±ÙŠÙ„Ø§/Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ (HS/Pasteurella)</option>
          </select>
        </div>
      </div>

     <label>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¹Ø©</label>

<div class="dose-container">
  <div class="radio-group">
    <label><input type="radio" name="doseType" value="primary"/> Ø£ÙˆÙ„ÙŠØ©</label>
    <label><input type="radio" name="doseType" value="booster"/> Ù…Ù†Ø´Ø·Ø©</label>
  </div>
</div>
     <div id="warn" class="warn"></div>
    </form>
  </div>
   </main> 
<div class="mbk-bottombar">
  <div class="mbk-bottombar-wrap">
   <button id="saveBtn" class="mbk-btn mbk-btn-primary" type="submit" form="vaccinationForm">ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</button>
    <button id="dashBtn" class="mbk-btn mbk-btn-ghost" type="button">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  </div>
</div>


  <script type="module">
    import { db, auth } from "/js/firebase-config.js";
import { collection, addDoc, serverTimestamp, getDocs, query, where, orderBy }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";


    // Ø¹Ù†Ø§ØµØ±
    const ctxAnimal = document.getElementById('ctxAnimal');
    const ctxDate   = document.getElementById('ctxDate');
    const form      = document.getElementById('vaccinationForm');
    const animalIdEl= document.getElementById('animalId');
    const dateEl    = document.getElementById('date');
    const vaccineEl = document.getElementById('vaccine');
    const saveBtn   = document.getElementById('saveBtn');
    const dashBtn = document.getElementById('dashBtn');
dashBtn?.addEventListener('click', () => location.href = 'dashboard.html');
    const warn      = document.getElementById('warn');
    function ensureInfoBar(){
  // Ù†Ø¶Ù…Ù† Infobar Ù‚ÙŠØ§Ø³ÙŠ Ø¯Ø§Ø®Ù„ mbk-main (ØªØ­Øª Ø§Ù„Ù‡ÙŠØ¯Ø±)
  let bar =
    document.getElementById('infobar') ||
    document.querySelector('.infobar') ||
    document.querySelector('[data-infobar]');

  if(!bar){
    bar = document.createElement('div');
    bar.id = 'infobar';
    bar.className = 'infobar';
    bar.style.display = 'none';

    const main = document.querySelector('.mbk-main');
    if(main){
      // Ø£ÙˆÙ„ Ø¹Ù†ØµØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€main (ØªØ­Øª Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙˆØ±Ù‹Ø§)
      main.insertBefore(bar, main.firstChild);
    }else{
      // fallback
      document.body.insertBefore(bar, document.body.firstChild);
    }
  }
  return bar;
}

function setInfoBar(type, text){
  const bar = ensureInfoBar();
  bar.style.display = 'block';
  bar.textContent = text;

  bar.classList.remove('ok','err','warn','success','error');
  if(type === 'success') bar.classList.add('ok');
  else if(type === 'error') bar.classList.add('err');
  else bar.classList.add('warn');
}

    // Bulk UI
const bulkBox = document.getElementById('bulkBox');
const bulkList = document.getElementById('bulkList');
const bulkSearch = document.getElementById('bulkSearch');
const bulkSelectAll = document.getElementById('bulkSelectAll');
const bulkClearAll = document.getElementById('bulkClearAll');

const bulkSelected = new Set();   // Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
let bulkAllNumbers = [];          // ÙƒÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ù…ÙÙ„ØªØ±Ø©)

    


    function todayLocal(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    function showWarn(t){ warn.textContent=t; }
    function clearWarn(){ warn.textContent=''; }
    function setInfoBar(type, text){
  // forms-init Ø¨ÙŠØ¹Ù…Ù„ infobar Ù‚ÙŠØ§Ø³ÙŠ â€” Ù†Ø®Ø¨Ø· Ø¹Ù„ÙŠÙ‡
  const bar =
    document.getElementById('infobar') ||
    document.querySelector('.infobar') ||
    document.querySelector('[data-infobar]');

  if(!bar){
    // Ù„Ùˆ Ù„Ø£ÙŠ Ø³Ø¨Ø¨ infobar Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ù€ warn Ø¨Ø¯Ù„ Ù…Ø§ Ù†Ø¹Ù…Ù„ UI Ø¬Ø¯ÙŠØ¯
    showWarn(text);
    return;
  }

  bar.style.display = 'block';
  bar.textContent = text;

  // Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¯ÙŠ hint Ù„Ù„Ø³ØªØ§ÙŠÙ„ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
  bar.classList.remove('ok','err','warn','success','error');
  if(type === 'success') bar.classList.add('ok');
  else if(type === 'error') bar.classList.add('err');
  else bar.classList.add('warn');
}

    function hydrate(){
      const qp = new URLSearchParams(location.search);
      const id = qp.get('animalId') || qp.get('animalIdd') || qp.get('number') || localStorage.getItem('lastAnimalId') || '';
      const dt = qp.get('date') || todayLocal();
      animalIdEl.value = id; if(id) animalIdEl.readOnly = true;
      dateEl.value = dt;
      ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${id||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
      try{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(dt).toLocaleDateString('ar-EG')}`; }catch{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dt}`; }
    }

    hydrate();

    animalIdEl.addEventListener('input', ()=>{ ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${animalIdEl.value.trim()||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`; });
    dateEl.addEventListener('input', ()=>{ try{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(dateEl.value).toLocaleDateString('ar-EG')}`;}catch{ ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateEl.value}`; } });

    function getDoseType(){
      const el = document.querySelector('input[name="doseType"]:checked');
      return el ? el.value : null;
    }

    function getCtx(){
      const animalId=animalIdEl.value.trim();
      const dt=dateEl.value.trim();
      const vaccine=vaccineEl.value;
      const doseType=getDoseType();
      if(!animalId||!dt||!vaccine||!doseType){ showWarn('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ† ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¹Ø©.'); return null;}
      clearWarn(); localStorage.setItem('lastAnimalId', animalId);
      return { animalId, dt, vaccine, doseType };
    }
    function getMode(){
  return document.querySelector('input[name="entryMode"]:checked')?.value || 'single';
}

function renderBulkList(filterText=''){
  if(!bulkList) return;
  const f = String(filterText||'').trim();
  const list = f ? bulkAllNumbers.filter(n => n.includes(f)) : bulkAllNumbers;

  bulkList.innerHTML = '';
  for(const num of list){
    const row = document.createElement('div');
    row.className = 'bulk-item';
    row.setAttribute('role','option');

    const left = document.createElement('div');
    left.className = 'bulk-num';
    left.textContent = num;

    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.checked = bulkSelected.has(num);

    row.addEventListener('click', (e)=>{
      // Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø¨Ù„ ÙƒÙ„ÙŠÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ù€checkbox Ù…Ù† ØªÙ‚Ù„ÙŠØ¨ Ù…Ø±ØªÙŠÙ†
      if(e.target === chk) return;
      chk.checked = !chk.checked;
      chk.dispatchEvent(new Event('change'));
    });

    chk.addEventListener('change', ()=>{
      if(chk.checked) bulkSelected.add(num);
      else bulkSelected.delete(num);
    });

    row.appendChild(left);
    row.appendChild(chk);
    bulkList.appendChild(row);
  }
}

async function loadMyAnimalsToBulk(){
  if(!db){ showWarn('âŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.'); return; }

  const uid = auth?.currentUser?.uid;
  if(!uid){ showWarn('âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.'); return; }

  try{
    // Ø§Ù„Ø£ÙØ¶Ù„: where userId + orderBy animalNumber (Ù„Ùˆ Ù…ØªØ§Ø­)
    let snap;
    try{
      const q = query(
        collection(db,'animals'),
        where('userId','==',uid),
        orderBy('animalNumber','asc')
      );
      snap = await getDocs(q);
    }catch{
      // fallback: where userId ÙÙ‚Ø· (Ù„Ùˆ Ø§Ù„Ù€index/ordering Ù…Ø´ Ù…ØªØ§Ø­)
      const q = query(collection(db,'animals'), where('userId','==',uid));
      snap = await getDocs(q);
    }

    const nums = [];
    snap.forEach(d=>{
      const a = d.data() || {};
      if((a.status || 'active') === 'active' && a.number){
        nums.push(String(a.number));
      }
    });

    nums.sort((x,y)=>(Number(x)||0)-(Number(y)||0));
    bulkAllNumbers = nums;
    renderBulkList(bulkSearch?.value || '');
  }catch(e){
    console.error(e);
    showWarn('âŒ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ.');
  }
}
 let bulkLoaded = false;

onAuthStateChanged(auth, (user) => {
  if (user && !bulkLoaded) {
    bulkLoaded = true;
    loadMyAnimalsToBulk();
  }
});
   
  document.querySelectorAll('input[name="entryMode"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    const isBulk = (getMode()==='bulk');
    bulkBox.style.display = isBulk ? 'block' : 'none';
    animalIdEl.disabled = isBulk;
    if (isBulk) {
      // Ù„Ùˆ Auth Ø¬Ù‡Ù‘Ø² Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©ØŒ Ø£Ùˆ Ù„Ùˆ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø§ Ø­ØµÙ„Ø´ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡
      if (auth?.currentUser?.uid && !bulkLoaded) {
        bulkLoaded = true;
        loadMyAnimalsToBulk();
      }
      // Ù„Ùˆ Ø§ØªØ­Ù…Ù‘Ù„ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ù‹Ø§
      renderBulkList(bulkSearch?.value || '');
    }
  });
});


bulkSearch?.addEventListener('input', ()=> renderBulkList(bulkSearch.value));

bulkSelectAll?.addEventListener('click', ()=>{
  for(const n of bulkAllNumbers) bulkSelected.add(n);
  renderBulkList(bulkSearch?.value || '');
});

bulkClearAll?.addEventListener('click', ()=>{
  bulkSelected.clear();
  renderBulkList(bulkSearch?.value || '');
});

 async function saveVaccination(){
  // 1) ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¶Ø¹ (ÙØ±Ø¯ÙŠ/Ø¬Ù…Ø§Ø¹ÙŠ)
  const mode = document.querySelector('input[name="entryMode"]:checked')?.value || 'single';

  // 2) Ø­Ù‚ÙˆÙ„ Ù…Ø´ØªØ±ÙƒØ© Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
  const dt = dateEl.value.trim();
  const vaccine = vaccineEl.value;
  const doseType = getDoseType();

  if(!dt || !vaccine || !doseType){
   setInfoBar('warn','âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ† ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¹Ø©.');
    return;
  }

  // 3) Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‡Ø¯Ø§Ù targets = Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªÙŠ Ø³Ù†Ø³Ø¬Ù„ Ù„Ù‡Ø§
  let targets = [];

  if(mode === 'single'){
    const one = animalIdEl.value.trim();
    if(!one){ setInfoBar('warn','âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†.');
 return; }
    targets = [one];
  }else{
    // bulkSelected Set ÙÙŠÙ‡Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€checkboxes
    targets = Array.from(bulkSelected);
    if(targets.length === 0){ setInfoBar('warn','âš ï¸ Ø§Ø®ØªØ± Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
 return; }
  }

  // 4) Ø­ÙØ¸ (Loop) Ø¹Ù„Ù‰ ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ targets
  saveBtn.disabled = true;
  saveBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸';

  try{
    for(const animalNumber of targets){
      const payload = {
        type:'vaccination',
        eventType:'ØªØ­ØµÙŠÙ†',
        animalId: animalNumber,
        animalNumber: animalNumber,
        date: dt,
        vaccine: vaccine,
        doseType: doseType,
        userId: auth?.currentUser?.uid || null,
        createdAt: serverTimestamp()
      };

      if(db) await addDoc(collection(db,'events'), payload);
      await window.updateAnimalByEvent(payload);
    }

  clearWarn();
form.dispatchEvent(new CustomEvent('mbk:valid', {
  detail: { message: 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­' }
}));

  }catch(e){
    console.error(e);
    setInfoBar('error','âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
  }finally{
    saveBtn.disabled = false;
    saveBtn.textContent = 'ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†';
  }
}
    const backBtn = document.getElementById('backToEventsBtn');
backBtn?.addEventListener('click', () => {
  const qp = new URLSearchParams(location.search);
  const id = animalIdEl.value.trim() || qp.get('number') || localStorage.getItem('lastAnimalId') || '';
  const dt = dateEl.value.trim() || qp.get('date') || todayLocal();
  location.href = `add-event.html?number=${encodeURIComponent(id)}&date=${encodeURIComponent(dt)}`;
});
form.addEventListener('mbk:valid', async (e) => {
  // forms-init Ù‡Ùˆ Ø§Ù„Ù„ÙŠ Ø¶Ù…Ù† Ø§Ù„Ù€infobarØŒ ÙˆØ¥Ø­Ù†Ø§ Ù‡Ù†Ø§ Ù†Ù†ÙØ° Ø§Ù„Ø­ÙØ¸ ÙÙ‚Ø·
  await saveVaccination();
});

  </script>
</body>
</html>



















