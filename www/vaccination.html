<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تسجيل التحصين</title>
  <style>
    body{direction:rtl;background:#fffde7;font-family:'Arial',sans-serif;margin:0;padding:18px;color:#1b5e20}
    h1{margin:0 0 12px;text-align:center;color:#2e7d32;font-size:24px}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #8bc34a;border-radius:999px;background:#dcedc8;color:#1b5e20;font-size:14px}
    .context{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:6px 0 12px}
    .card{max-width:520px;margin:0 auto;background:#f1f8e9;border:1px solid #c5e1a5;border-radius:12px;padding:16px}
    label{display:block;margin-top:12px;font-weight:bold;color:#2e7d32}
    input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin-top:6px;font-size:16px;box-sizing:border-box}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:640px){.row-2{grid-template-columns:1fr 1fr}}
    .radio-group{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .radio-group label{display:flex;align-items:center;gap:8px;background:#dcedc8;border:1px solid #8bc34a;border-radius:8px;padding:8px 12px;cursor:pointer}
    .actions{position:sticky;bottom:0;left:0;right:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.1) blur(2px);border-top:1px solid #c5e1a5;padding:10px 0;margin-top:14px}
    .actions .wrap{max-width:520px;margin:0 auto;display:flex;gap:8px}
    button{appearance:none;border:0;border-radius:8px;padding:12px 14px;font-weight:bold;font-size:16px;cursor:pointer}
    .btn-primary{background:#2e7d32;color:#fff}
    .btn-ghost{background:#fff;border:1px solid #2e7d32;color:#2e7d32}
    .notice{display:none;margin-top:10px;padding:12px;border-radius:10px;background:#f0fdf4;border:1px solid #bbf7d0;color:#065f46}
    .notice .actions{display:flex;gap:8px;margin-top:10px;position:static;border:0;background:transparent;padding:0}
    .warn{color:#c62828;text-align:center;min-height:22px;margin-top:8px}
  </style>
</head>
<body>
  <h1>تسجيل التحصين</h1>
  <div class="context">
    <span id="ctxAnimal" class="pill">الحيوان: غير محدد</span>
    <span id="ctxDate" class="pill">التاريخ: —</span>
  </div>

  <div class="card">
    <form id="vaccinationForm">
      <div class="row row-2">
        <div>
          <label for="animalId">رقم الحيوان</label>
          <input id="animalId" type="text" placeholder="مثال: 105"/>
        </div>
        <div>
          <label for="date">التاريخ</label>
          <input id="date" type="date"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="vaccine">نوع التحصين</label>
          <select id="vaccine">
            <option value="" selected disabled>اختر نوع التحصين</option>
            <option value="الحمى القلاعية (FMD)">الحمى القلاعية (FMD)</option>
            <option value="الجلد العقدي (LSD)">الجلد العقدي (LSD)</option>
            <option value="التسمم المعوي (Clostridial)">التسمم المعوي (Clostridial)</option>
            <option value="البروسيلا (Brucella)">البروسيلا (Brucella)</option>
            <option value="IBR">IBR</option>
            <option value="BVD">BVD</option>
            <option value="الجمرة الخبيثة (Anthrax)">الجمرة الخبيثة (Anthrax)</option>
            <option value="الباستريلا/التهاب رئوي (HS/Pasteurella)">الباستريلا/التهاب رئوي (HS/Pasteurella)</option>
          </select>
        </div>
      </div>

      <label>نوع الجرعة</label>
      <div class="radio-group">
        <label><input type="radio" name="doseType" value="primary"/> أولية</label>
        <label><input type="radio" name="doseType" value="booster"/> منشطة</label>
      </div>

      <div id="warn" class="warn"></div>

      <div id="inlineMsg" class="notice" role="status" aria-live="polite">
        <div class="text"></div>
        <div class="actions">
          <button type="button" id="msgYes" class="btn-primary">تسجيل أحداث أخرى</button>
          <button type="button" id="msgNo"  class="btn-ghost">لوحة التحكم</button>
        </div>
      </div>
    </form>
  </div>

  <div class="actions">
    <div class="wrap">
      <button id="saveBtn" class="btn-primary" type="button">💾 تسجيل التحصين</button>
      <button id="resetBtn" class="btn-ghost" type="button">مسح الحقول</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // عناصر
    const ctxAnimal = document.getElementById('ctxAnimal');
    const ctxDate   = document.getElementById('ctxDate');
    const form      = document.getElementById('vaccinationForm');
    const animalIdEl= document.getElementById('animalId');
    const dateEl    = document.getElementById('date');
    const vaccineEl = document.getElementById('vaccine');

    const saveBtn   = document.getElementById('saveBtn');
    const resetBtn  = document.getElementById('resetBtn');
    const warn      = document.getElementById('warn');

    const msgBox    = document.getElementById('inlineMsg');
    const msgText   = msgBox.querySelector('.text');
    const btnYes    = document.getElementById('msgYes');
    const btnNo     = document.getElementById('msgNo');

    function todayLocal(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    function showWarn(t){ warn.textContent=t; }
    function clearWarn(){ warn.textContent=''; }
    function showMsg(text){ msgText.textContent=text; msgBox.style.display='block'; }
    function hideMsg(){ msgBox.style.display='none'; msgText.textContent=''; }

    function hydrate(){
      const qp = new URLSearchParams(location.search);
      const id = qp.get('animalId') || qp.get('animalIdd') || qp.get('number') || localStorage.getItem('lastAnimalId') || '';
      const dt = qp.get('date') || todayLocal();
      animalIdEl.value = id; if(id) animalIdEl.readOnly = true;
      dateEl.value = dt;
      ctxAnimal.textContent = `الحيوان: ${id||'غير محدد'}`;
      try{ ctxDate.textContent = `التاريخ: ${new Date(dt).toLocaleDateString('ar-EG')}`; }catch{ ctxDate.textContent = `التاريخ: ${dt}`; }
    }

    hydrate();

    animalIdEl.addEventListener('input', ()=>{ ctxAnimal.textContent = `الحيوان: ${animalIdEl.value.trim()||'غير محدد'}`; });
    dateEl.addEventListener('input', ()=>{ try{ ctxDate.textContent = `التاريخ: ${new Date(dateEl.value).toLocaleDateString('ar-EG')}`;}catch{ ctxDate.textContent = `التاريخ: ${dateEl.value}`; } });

    async function setupFirebase(){
      try{
        const mod = await import('./js/firebase-config.js?v=4');
        if(mod?.db && mod?.auth){ return { db:mod.db, auth:mod.auth }; }
        if(mod?.firebaseConfig){ const app=initializeApp(mod.firebaseConfig); return { db:getFirestore(app), auth:getAuth(app) }; }
      }catch(e){ console.warn('fb cfg import failed', e); }
      try{ const cfg = await import('./config.js?v=4'); const app=initializeApp(cfg.firebaseConfig); return { db:getFirestore(app), auth:getAuth(app) }; }catch(e2){ showWarn('❌ تعذّر تحميل إعدادات Firebase.'); return { db:null, auth:null }; }
    }

    function getDoseType(){
      const el = document.querySelector('input[name="doseType"]:checked');
      return el ? el.value : null;
    }

    function getCtx(){
      const animalId=animalIdEl.value.trim();
      const dt=dateEl.value.trim();
      const vaccine=vaccineEl.value;
      const doseType=getDoseType();
      if(!animalId||!dt||!vaccine||!doseType){ showWarn('⚠️ أدخل رقم الحيوان، التاريخ، نوع التحصين ونوع الجرعة.'); return null;}
      clearWarn(); localStorage.setItem('lastAnimalId', animalId);
      return { animalId, dt, vaccine, doseType };
    }

    const { db, auth } = await setupFirebase();

    async function saveVaccination(){
      const ctx = getCtx(); if(!ctx) return;
      const payload = {
        type:'vaccination', eventType:'تحصين',
        animalId: ctx.animalId, animalNumber: ctx.animalId,
        date: ctx.dt,
        vaccine: ctx.vaccine,
        doseType: ctx.doseType, // primary | booster
        userId: auth?.currentUser?.uid || null,
        createdAt: serverTimestamp()
      };

      saveBtn.disabled = true; saveBtn.textContent = '... جاري الحفظ';
      try{
        if(db) await addDoc(collection(db,'events'), payload);
        hideMsg(); showMsg('✅ تم تسجيل التحصين بنجاح');
      }catch(e){ console.error(e); showWarn('❌ تعذّر الحفظ. حاول مرة أخرى.'); }
      finally{ saveBtn.disabled=false; saveBtn.textContent='💾 تسجيل التحصين'; }
    }

    saveBtn.addEventListener('click', saveVaccination);
    form.addEventListener('submit', (e)=>{ e.preventDefault(); saveVaccination(); });

    btnYes.addEventListener('click', ()=>{
      const qp = new URLSearchParams(location.search);
      const id = animalIdEl.value.trim() || qp.get('animalId') || qp.get('animalIdd') || qp.get('number') || '';
      const dt = dateEl.value.trim() || qp.get('date') || todayLocal();
      hideMsg();
      location.href = `add-event.html?animalId=${encodeURIComponent(id)}&animalIdd=${encodeURIComponent(id)}&number=${encodeURIComponent(id)}&date=${encodeURIComponent(dt)}`;
    });
    btnNo.addEventListener('click', ()=>{ hideMsg(); location.href = 'dashboard.html'; });

    resetBtn.addEventListener('click', ()=>{ form.reset(); hydrate(); hideMsg(); clearWarn(); });
  </script>
</body>
</html>
