<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script type="module">
    import { updateAnimalByEvent } from "/js/animal-update.js";
    window.updateAnimalByEvent = updateAnimalByEvent;
  </script>

  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</title>
  <style>
  /* ===== Header Style (ONE VERSION) ===== */
  .mbk-head-vax{
    max-width: 780px;
    margin: 10px auto 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
  }
  .mbk-right,
  .mbk-left{
    width: 64px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .mbk-center{
    text-align: center;
    flex: 1;
    line-height: 1.05;
  }
  .mbk-page-title{
    color:#000;
    font-weight: 900;
    font-size: 20px;
  }
  .mbk-brand{
    color:#0ea05a;
    font-weight: 900;
    font-size: 15px;
    margin-top: 3px;
  }
  .mbk-logo-vax{
    width: 56px;
    height: 56px;
    object-fit: contain;
  }
  .mbk-back-pill{
    width: 44px;
    height: 44px;
    border-radius: 999px;
    background: #fff;
    border: 2px solid #0ea05a;
    color: #0b7f47;
    font-weight: 900;
    font-size: 13px;
    cursor: pointer;
  }

  /* ===== Bottom Bar (Murabbik) ===== */
  .mbk-bottombar{
    position: fixed;
    left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,.96);
    border-top: 1px solid #e2e8f0;
    padding: 10px 12px;
    z-index: 20;
  }
  .mbk-bottombar-wrap{
    max-width: 520px;
    margin: 0 auto;
    display: flex;
    gap: 10px;
  }
  .mbk-btn{
    flex: 1;
    appearance: none;
    border-radius: 12px;
    padding: 12px 14px;
    font-weight: 900;
    font-size: 16px;
    cursor: pointer;
  }
  .mbk-btn-primary{
    border: 0;
    background: #0ea05a;
    color: #fff;
  }
  .mbk-btn-ghost{
    background: #fff;
    border: 2px solid #0ea05a;
    color: #0b7f47;
  }

  /* ===== Center everything between header & bottom bar ===== */
  .mbk-main{
    max-width: 520px;
    margin: 0 auto;
    padding: 0 12px 92px; /* Ù…Ø³Ø§Ø­Ø© ØªØ­Øª Ø¹Ø´Ø§Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ Ù…Ø§ ÙŠØºØ·ÙŠØ´ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    box-sizing: border-box;
  }

  /* ===== Dose White Container ===== */
  .dose-container{
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 14px;
    padding: 14px 12px;
    margin-top: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,.04);
  }
  .radio-group{
    display: flex;
    gap: 18px;
    align-items: center;
    justify-content: center;
  }
  .radio-group label{
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 700;
    cursor: pointer;
  }
  .radio-group input[type="radio"]{
    accent-color: #0ea05a;
  }

  /* ===== Bulk (Mobile First) ===== */
  .bulk-box{
    background:#fff;
    border:1px solid #e2e8f0;
    border-radius:14px;
    padding:12px;
    margin-top:8px;
  }
  .bulk-tools{
    display:grid;
    grid-template-columns: 1fr auto auto;
    gap:8px;
    align-items:center;
    margin-top:8px;
  }
  #bulkSearch{
    width:100%;
    padding:10px 12px;
    border:1px solid #cbd5e1;
    border-radius:12px;
    font-size:16px;
    box-sizing:border-box;
  }
  .bulk-list{
    margin-top:10px;
    max-height: 220px;
    overflow:auto;
    border:1px solid #e2e8f0;
    border-radius:12px;
    padding:6px;
  }
  .bulk-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 10px;
    border-radius:10px;
    border:1px solid transparent;
    cursor:pointer;
    user-select:none;
  }
  .bulk-item:hover{ border-color:#cfe7d8; background:#f7faf7; }
  .bulk-item input{ width:18px; height:18px; accent-color:#0ea05a; }
  .bulk-num{ font-weight:900; color:#0f172a; }
  .bulk-hint{ margin-top:8px; font-size:12px; color:#64748b; text-align:center; }

  /* ===== Entry Mode Pills ===== */
  .mode-container{
    background:#fff;
    border:1px solid #e2e8f0;
    border-radius:14px;
    padding:10px;
    margin-top:6px;
    box-shadow: 0 2px 6px rgba(0,0,0,.04);
  }
  .mode-pills{
    display:flex;
    justify-content:center;
    gap:12px;
  }
  .mode-pills .pill{
    padding:8px 22px;
    border-radius:999px;
    border:2px solid #0ea05a;
    font-weight:900;
    cursor:pointer;
    color:#0b7f47;
    transition:all .2s ease;
    user-select:none;
  }
  #modeSingle:checked + label,
  #modeBulk:checked + label{
    background:#0ea05a;
    color:#fff;
  }
  </style>
</head>

<body>
  <header class="mbk-head-vax">
    <div class="mbk-right">
      <button type="button" id="backToEventsBtn" class="mbk-back-pill">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div class="mbk-center">
      <div class="mbk-page-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</div>
      <div class="mbk-brand">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
    </div>

    <div class="mbk-left">
      <img src="/images/logo.png" class="mbk-logo-vax" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
    </div>
  </header>

  <main class="mbk-main">
    <div class="context">
      <span id="ctxAnimal" class="pill">Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
      <span id="ctxDate" class="pill">Ø§Ù„ØªØ§Ø±ÙŠØ®: â€”</span>
    </div>

    <div class="card">
      <form id="vaccinationForm" data-event="ØªØ­ØµÙŠÙ†" novalidate>
        <div class="row row-2">
          <div>
            <label for="animalNumber">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>

            <div class="mode-container">
              <div class="mode-pills">
                <input type="radio" id="modeSingle" name="entryMode" value="single" checked hidden>
                <label for="modeSingle" class="pill">ÙØ±Ø¯ÙŠ</label>

                <input type="radio" id="modeBulk" name="entryMode" value="bulk" hidden>
                <label for="modeBulk" class="pill">Ø¬Ù…Ø§Ø¹ÙŠ</label>
              </div>
            </div>

            <div id="bulkBox" class="bulk-box" style="display:none;">
              <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª (Ø¬Ù…Ø§Ø¹ÙŠ)</label>

              <div class="bulk-tools">
                <input id="bulkSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø±Ù‚Ù…..." inputmode="numeric">
                <button type="button" id="bulkSelectAll" class="btn-ghost">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                <button type="button" id="bulkClearAll" class="btn-ghost">Ù…Ø³Ø­</button>
              </div>

              <div id="bulkList" class="bulk-list" role="listbox" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª"></div>

              <div class="bulk-hint">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø±Ù‚Ù… (Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„).</div>
            </div>

            <input id="animalNumber" data-field="animalNumber" type="text" placeholder="Ù…Ø«Ø§Ù„: 105"/>
          </div>

          <div>
            <label for="eventDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input id="eventDate" data-field="eventDate" type="date"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="vaccine">Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ†</label>
            <select id="vaccine" data-field="vaccine">
              <option value="" selected disabled>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ†</option>
              <option value="Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ© (FMD)">Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ© (FMD)</option>
              <option value="Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ÙŠ (LSD)">Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ÙŠ (LSD)</option>
              <option value="Ø§Ù„ØªØ³Ù…Ù… Ø§Ù„Ù…Ø¹ÙˆÙŠ (Clostridial)">Ø§Ù„ØªØ³Ù…Ù… Ø§Ù„Ù…Ø¹ÙˆÙŠ (Clostridial)</option>
              <option value="Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§ (Brucella)">Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§ (Brucella)</option>
              <option value="IBR">IBR</option>
              <option value="BVD">BVD</option>
              <option value="Ø§Ù„Ø¬Ù…Ø±Ø© Ø§Ù„Ø®Ø¨ÙŠØ«Ø© (Anthrax)">Ø§Ù„Ø¬Ù…Ø±Ø© Ø§Ù„Ø®Ø¨ÙŠØ«Ø© (Anthrax)</option>
              <option value="Ø§Ù„Ø¨Ø§Ø³ØªØ±ÙŠÙ„Ø§/Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ (HS/Pasteurella)">Ø§Ù„Ø¨Ø§Ø³ØªØ±ÙŠÙ„Ø§/Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ (HS/Pasteurella)</option>
            </select>
          </div>
        </div>

        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¹Ø©</label>
        <div class="dose-container">
          <div class="radio-group">
            <label><input type="radio" name="doseType" data-field="doseType" value="primary"/> Ø£ÙˆÙ„ÙŠØ©</label>
            <label><input type="radio" name="doseType" data-field="doseType" value="booster"/> Ù…Ù†Ø´Ø·Ø©</label>
          </div>
        </div>

        <div id="warn" class="warn"></div>
      </form>
    </div>
  </main>

  <div class="mbk-bottombar">
    <div class="mbk-bottombar-wrap">
      <button id="saveBtn" class="mbk-btn mbk-btn-primary" type="submit" form="vaccinationForm">ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†</button>
      <button id="dashBtn" class="mbk-btn mbk-btn-ghost" type="button">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "/js/firebase-config.js";
   import { collection, addDoc, serverTimestamp, getDocs, query, where, orderBy, limit }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Ø¹Ù†Ø§ØµØ±
    const ctxAnimal  = document.getElementById("ctxAnimal");
    const ctxDate    = document.getElementById("ctxDate");
    const form       = document.getElementById("vaccinationForm");
    const animalNumberEl = document.getElementById("animalNumber");  // (Ù‚Ø¯ ØªÙƒÙˆÙ† null Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…Ø© Ù‚Ø¯ÙŠÙ…Ø©)
    const eventDateEl = document.getElementById("eventDate");
    const vaccineEl  = document.getElementById("vaccine");
    const saveBtn    = document.getElementById("saveBtn");
    const dashBtn    = document.getElementById("dashBtn");
    const warn       = document.getElementById("warn");

    // Bulk UI
    const bulkBox       = document.getElementById("bulkBox");
    const bulkList      = document.getElementById("bulkList");
    const bulkSearch    = document.getElementById("bulkSearch");
    const bulkSelectAll = document.getElementById("bulkSelectAll");
    const bulkClearAll  = document.getElementById("bulkClearAll");

    const bulkSelected = new Set();   // Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    let bulkAllNumbers = [];          // ÙƒÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ù…ÙÙ„ØªØ±Ø©)
    let bulkLoaded = false;

    dashBtn?.addEventListener("click", () => (location.href = "dashboard.html"));

    // âœ… Infobar: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ (forms-init) ÙˆØ¥Ù„Ø§ fallback Ø¨Ø³ÙŠØ·
    function getBar(){
      try{
        if (window.ensureInfoBar) return window.ensureInfoBar(form);
      }catch(_){}
      // fallback
      let bar = document.getElementById("sysbar") || document.getElementById("infobar") || document.querySelector(".infobar");
      if (!bar){
        bar = document.createElement("div");
        bar.id = "infobar";
        bar.className = "infobar";
        bar.style.display = "none";
        const main = document.querySelector(".mbk-main");
        (main || document.body).insertBefore(bar, (main || document.body).firstChild);
      }
      return bar;
    }
    function msg(text, type="warning"){
      const bar = getBar();
      if (!bar) return;
      try{
        if (window.showMsg) return window.showMsg(bar, text, type);
      }catch(_){}
      bar.style.display = "block";
      bar.textContent = String(text||"");
    }

    function todayLocal(){
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().slice(0,10);
    }
    function showWarn(t){ if (warn) warn.textContent = t; }
    function clearWarn(){ if (warn) warn.textContent = ""; }

    // =========================================================
    // âœ… Murabbik: Save happens ONLY after Central Validation (mbk:valid)
    // - no local form submit handler
    // - vaccination bulk/single handled here safely
    // =========================================================
    function parseNumbers(raw){
      const s = String(raw||"");
      const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9',
                   'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
      const latin = s.replace(/[Ù -Ù©Û°-Û¹]/g, ch => map[ch] || ch);
      const arr = latin.match(/\d+/g) || [];
      return [...new Set(arr.map(x=>String(x).replace(/\D/g,'')).filter(Boolean))];
    }

    function addDays(ymd, days){
      const d = new Date(String(ymd||"").slice(0,10));
      if (Number.isNaN(d.getTime())) return "";
      d.setDate(d.getDate() + Number(days||0));
      const x = new Date(d.getTime());
      x.setMinutes(x.getMinutes() - x.getTimezoneOffset());
      return x.toISOString().slice(0,10);
    }
    // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ (Ù†Ø³Ø®Ø© Ø£ÙˆÙ„Ù‰)
    async function createVaccinationTasks(uid, animalNumber, eventDate, vaccine, doseType){
      const num = String(animalNumber||"").trim();
      const dt  = String(eventDate||"").slice(0,10);
      const vx  = String(vaccine||"").trim();
      const dose= String(doseType||"").trim();

      if (!uid || !num || !dt || !vx) return;

      const tasks = [];

      const isFMD = vx.includes("FMD") || vx.includes("Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ©");
      const isLSD = vx.includes("LSD") || vx.includes("Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ÙŠ");
      const is3d  = vx.includes("3 Ø£ÙŠØ§Ù…") || vx.includes("3 Ø§ÙŠØ§Ù…") || vx.includes("Ø«Ù„Ø§Ø«");
      const isPaste = vx.includes("Ø¨Ø§Ø³ØªØ±") || vx.includes("Paste") || vx.includes("HS/");
      const isRespLive = vx.includes("ØªÙ†ÙØ³ÙŠ Ø­ÙŠ");
      const isRespDead = vx.includes("ØªÙ†ÙØ³ÙŠ Ù…ÙŠØª") || vx.includes("Ù…Ù†ÙØµÙ„");

      if (isFMD){
        if (dose === "primary"){
          tasks.push({ dueDate: addDays(dt, 21), title: `Ù…Ù†Ø´Ù‘Ø· ${vx} (+21 ÙŠÙˆÙ…)`, stage: "booster21" });
        } else if (dose === "booster"){
          tasks.push({ dueDate: addDays(dt, 180), title: `Ø¥Ø¹Ø§Ø¯Ø© ${vx} (Ø¨Ø¹Ø¯ 6 Ø´Ù‡ÙˆØ±)`, stage: "repeat6m" });
        }
      } else if (isLSD || is3d){
        tasks.push({ dueDate: addDays(dt, 365), title: `Ø¥Ø¹Ø§Ø¯Ø© ${vx} (Ø³Ù†ÙˆÙŠ)`, stage: "annual" });
      } else if (isPaste){
        if (dose === "primary"){
          tasks.push({ dueDate: addDays(dt, 30), title: `Ù…Ù†Ø´Ù‘Ø· ${vx} (+30 ÙŠÙˆÙ…)`, stage: "booster30" });
          tasks.push({ dueDate: addDays(dt, 180), title: `Ø¥Ø¹Ø§Ø¯Ø© ${vx} (Ø¨Ø¹Ø¯ 6 Ø´Ù‡ÙˆØ±)`, stage: "repeat6m" });
        } else if (dose === "booster"){
          tasks.push({ dueDate: addDays(dt, 180), title: `Ø¥Ø¹Ø§Ø¯Ø© ${vx} (Ø¨Ø¹Ø¯ 6 Ø´Ù‡ÙˆØ±)`, stage: "repeat6m" });
        }
      } else if (isRespLive){
        if (dose === "primary"){
          tasks.push({ dueDate: addDays(dt, 30), title: `Ù…Ù†Ø´Ù‘Ø· ${vx} (+30 ÙŠÙˆÙ…)`, stage: "booster30" });
          tasks.push({ dueDate: addDays(dt, 365), title: `Ø¥Ø¹Ø§Ø¯Ø© ${vx} (Ø³Ù†ÙˆÙŠ)`, stage: "annual" });
        } else if (dose === "booster"){
          tasks.push({ dueDate: addDays(dt, 365), title: `Ø¥Ø¹Ø§Ø¯Ø© ${vx} (Ø³Ù†ÙˆÙŠ)`, stage: "annual" });
        }
      } else if (isRespDead){
        if (dose === "primary"){
          tasks.push({ dueDate: addDays(dt, 21), title: `Ù…Ù†Ø´Ù‘Ø· ${vx} (+21 ÙŠÙˆÙ…)`, stage: "booster21" });
          tasks.push({ dueDate: addDays(dt, 180), title: `Ø¥Ø¹Ø§Ø¯Ø© ${vx} (Ø¨Ø¹Ø¯ 6 Ø´Ù‡ÙˆØ±)`, stage: "repeat6m" });
        } else if (dose === "booster"){
          tasks.push({ dueDate: addDays(dt, 180), title: `Ø¥Ø¹Ø§Ø¯Ø© ${vx} (Ø¨Ø¹Ø¯ 6 Ø´Ù‡ÙˆØ±)`, stage: "repeat6m" });
        }
      }

      for (const t of tasks){
        if (!t.dueDate) continue;
        await addDoc(collection(db,"tasks"), {
          type: "task",
          taskType: "ØªØ­ØµÙŠÙ†",
          title: t.title,
          stage: t.stage,
          dueDate: t.dueDate,
          vaccine: vx,
          doseType: dose,
          animalNumber: num,
          userId: uid,
          status: "open",
          createdAt: serverTimestamp(),
          source: "vaccination.html"
        });
      }
    }

    async function saveFromCentral(fd){
      const uid = auth?.currentUser?.uid;
      if (!uid){
        msg("Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.", "error");
        return;
      }

      const vaccine = String(fd.vaccine || vaccineEl?.value || "").trim();
      const doseType = String(fd.doseType || "").trim();
      const dt = String(fd.eventDate || eventDateEl?.value || "").slice(0,10);

      // targets: Ù…Ù† bulkSelected Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ§Ø± (Ø¬Ù…Ø§Ø¹ÙŠ)ØŒ ÙˆØ¥Ù„Ø§ Ù…Ù† Ø§Ù„Ø­Ù‚Ù„
      let targets = [];
      const mode = document.getElementById("modeBulk")?.checked ? "bulk" : "single";
      if (mode === "bulk" && bulkSelected.size){
        targets = [...bulkSelected].map(String);
      } else {
        targets = parseNumbers(fd.animalNumber || fd.animalId || "");
      }
      targets = [...new Set(targets.filter(Boolean))];

      if (!targets.length){
        msg("Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† (Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©).", "error");
        return;
      }
      if (!dt){
        msg("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ†.", "error");
        return;
      }
      if (!vaccine){
        msg("Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ†.", "error");
        return;
      }
      if (!doseType){
        msg("Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¹Ø©.", "error");
        return;
      }

      saveBtn.disabled = true;
      let ok = 0;
      const skipped = [];

      for (const animalNumber of targets){
        
        // 3) Ø§Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø« (Ù…Ø³ØªØ¨Ø¹Ø¯ ØªÙ†Ø§Ø³Ù„ÙŠÙ‹Ø§ Ù…Ø³Ù…ÙˆØ­)
        const payload = {
          animalId: String(animalNumber),
          animalNumber: String(animalNumber),
          userId: uid,
          eventType: "ØªØ­ØµÙŠÙ†",
          type: "vaccination",
          vaccine,
          doseType,
          eventDate: dt,
          date: dt,
          source: "vaccination.html",
          createdAt: serverTimestamp(),
        };

        await addDoc(collection(db,"events"), payload);
        if (window.updateAnimalByEvent) {
          try{ await window.updateAnimalByEvent(payload); }catch(_){}
        }

        // 4) Ø°ÙƒØ§Ø¡ Ø§Ù„ØªØ­ØµÙŠÙ†: Tasks
      try{
  await createVaccinationTasks(uid, animalNumber, dt, vaccine, doseType);
}catch(err){
  const reason = (err && (err.code || err.message)) ? ` (${err.code || err.message})` : "";
  skipped.push(`${animalNumber}: ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ† Ù„ÙƒÙ† ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª (Tasks)${reason}.`);
}

        ok++;
      }

      saveBtn.disabled = false;

      if (!ok){
        const lines = [
          "ğŸ” Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ ØªØ­ØµÙŠÙ†.",
          ...(skipped.length ? ["\nØ§Ù„Ø£Ø³Ø¨Ø§Ø¨:", ...skipped] : [])
        ];
        msg(lines.join("\n"), "error");
        return;
      }

      const lines = [
        `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ† Ù„Ø¹Ø¯Ø¯: ${ok}`,
      ];
      if (skipped.length){
        lines.push(`ğŸš« ØªÙ… ØªØ®Ø·ÙŠ: ${skipped.length}`);
        // Ø§Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 8 Ø£Ø³Ø¨Ø§Ø¨ ÙÙ‚Ø· Ù„ØªØ¬Ù†Ø¨ Ø±Ø³Ø§Ù„Ø© Ø·ÙˆÙŠÙ„Ø©
        lines.push(...skipped.slice(0,8));
        if (skipped.length > 8) lines.push("â€¦");
      }
      msg(lines.join("\n"), "success");
    }


    // âœ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© + Ø§Ù„ÙØ§Ù„ÙŠØ¯ÙŠØ´Ù†
    form.addEventListener("mbk:valid", (e)=>{
      const fd = e?.detail?.formData || {};
      saveFromCentral(fd);
    });

    // âœ… Ù„Ø§ ØªØ³Ù…Ø­ Ù„Ø£ÙŠ ÙƒØ±Ø§Ø´ ÙÙŠ hydrate (Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ø­Ø§ØµÙ„ Ø¹Ù†Ø¯Ùƒ)
    function hydrate(){
      const qp = new URLSearchParams(location.search);

      const id =
        qp.get("animalId") ||
        qp.get("animalIdd") ||
        qp.get("number") ||
        localStorage.getItem("lastAnimalId") ||
        "";

      const dt = qp.get("date") || todayLocal();

      // entryMode from URL
      const entryMode = (qp.get("entryMode") || "").toLowerCase();
      if (entryMode === "bulk"){
        const r = document.getElementById("modeBulk");
        if (r) r.checked = true;
      } else if (entryMode === "single"){
        const r = document.getElementById("modeSingle");
        if (r) r.checked = true;
      }

      // doseType from URL
      const dose = (qp.get("doseType") || "").toLowerCase();
      if (dose === "primary" || dose === "booster"){
        const r = document.querySelector(`input[name="doseType"][value="${dose}"]`);
        if (r) r.checked = true;
      }

      if (animalNumberEl){
        animalNumberEl.value = id;
        if (id) animalNumberEl.readOnly = true;
      }

      if (eventDateEl) eventDateEl.value = dt;

      if (ctxAnimal) ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${id || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}`;
      try{
        if (ctxDate) ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(dt).toLocaleDateString("ar-EG")}`;
      }catch(_){
        if (ctxDate) ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dt}`;
      }

      // apply mode UI now
      applyModeUI();
    }

    function getDoseType(){
      const el = document.querySelector('input[name="doseType"]:checked');
      return el ? el.value : null;
    }
    function getMode(){
      return document.querySelector('input[name="entryMode"]:checked')?.value || "single";
    }

    function applyModeUI(){
      const isBulk = (getMode() === "bulk");
      if (bulkBox) bulkBox.style.display = isBulk ? "block" : "none";
      if (animalNumberEl) animalNumberEl.disabled = isBulk;

      if (isBulk){
        // Ù„Ùˆ Auth Ø¬Ù‡Ù‘Ø² Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©ØŒ Ø£Ùˆ Ù„Ùˆ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø§ Ø­ØµÙ„Ø´ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡
        if (auth?.currentUser?.uid && !bulkLoaded){
          bulkLoaded = true;
          loadMyAnimalsToBulk();
        }
        renderBulkList(bulkSearch?.value || "");
      }
    }

    hydrate();

    // listeners UI context
    animalNumberEl?.addEventListener("input", ()=>{
      if (ctxAnimal) ctxAnimal.textContent = `Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ${animalNumberEl.value.trim() || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}`;
    });
    eventDateEl?.addEventListener("input", ()=>{
      try{
        if (ctxDate) ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(eventDateEl.value).toLocaleDateString("ar-EG")}`;
      }catch(_){
        if (ctxDate) ctxDate.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${eventDateEl.value}`;
      }
    });

    // Mode toggle
    document.querySelectorAll('input[name="entryMode"]').forEach(r=>{
      r.addEventListener("change", applyModeUI);
    });

    // Bulk rendering
    function renderBulkList(filterText=""){
      if (!bulkList) return;
      const f = String(filterText||"").trim();
      const list = f ? bulkAllNumbers.filter(n => n.includes(f)) : bulkAllNumbers;

      bulkList.innerHTML = "";
      for (const num of list){
        const row = document.createElement("div");
        row.className = "bulk-item";
        row.setAttribute("role","option");

        const left = document.createElement("div");
        left.className = "bulk-num";
        left.textContent = num;

        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.checked = bulkSelected.has(num);

        row.addEventListener("click", (e)=>{
          if (e.target === chk) return;
          chk.checked = !chk.checked;
          chk.dispatchEvent(new Event("change"));
        });

        chk.addEventListener("change", ()=>{
          if (chk.checked) bulkSelected.add(num);
          else bulkSelected.delete(num);
        });

        row.appendChild(left);
        row.appendChild(chk);
        bulkList.appendChild(row);
      }
    }

    bulkSearch?.addEventListener("input", ()=> renderBulkList(bulkSearch.value));

    bulkSelectAll?.addEventListener("click", ()=>{
      for (const n of bulkAllNumbers) bulkSelected.add(n);
      renderBulkList(bulkSearch?.value || "");
    });

    bulkClearAll?.addEventListener("click", ()=>{
      bulkSelected.clear();
      renderBulkList(bulkSearch?.value || "");
    });

    async function loadMyAnimalsToBulk(){
      if (!db){ msg("âŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.", "error"); return; }

      const uid = auth?.currentUser?.uid;
      if (!uid){ msg("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.", "warning"); return; }

      try{
        let snap;
        try{
          const q = query(
            collection(db,"animals"),
            where("userId","==",uid),
            orderBy("animalNumber","asc")
          );
          snap = await getDocs(q);
        }catch(_){
          const q = query(collection(db,"animals"), where("userId","==",uid));
          snap = await getDocs(q);
        }
// âœ… Fallback: Ù„Ùˆ Ù…ÙÙŠØ´ Ù†ØªØ§Ø¦Ø¬ Ø¨Ù€ userIdØŒ Ù‡Ø§Øª Ø£ÙˆÙ„ 500 Ø­ÙŠÙˆØ§Ù† Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
if (!snap || snap.size === 0){
  const q2 = query(collection(db,"animals"), limit(500));
  snap = await getDocs(q2);
}
       const nums = [];
snap.forEach(d=>{
  const a = d.data() || {};
  const status = (a.status || "active");

  const n =
    a.number ??
    a.animalNumber ??
    a.animalNo ??
    a.animalId ??
    a.id;

  if (status === "active" && n !== undefined && n !== null && String(n).trim()){
    nums.push(String(n).trim());
  }
});

        nums.sort((x,y)=>(Number(x)||0)-(Number(y)||0));
        bulkAllNumbers = nums;
        renderBulkList(bulkSearch?.value || "");
      }catch(e){
        console.error(e);
        msg("âŒ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ.", "error");
      }
    }

    onAuthStateChanged(auth, (user)=>{
      if (user && !bulkLoaded){
        bulkLoaded = true;
        // Ù„Ø§ Ù†Ø­Ù…Ù„ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙˆØ¶Ø¹ Ø¬Ù…Ø§Ø¹ÙŠ Ù…ÙØªÙˆØ­ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­ÙˆÙ‘Ù„ Ù„Ù‡
        if (getMode() === "bulk"){
          loadMyAnimalsToBulk();
        }
      }
    });

    // Back button
    const backBtn = document.getElementById("backToEventsBtn");
    backBtn?.addEventListener("click", ()=>{
      const qp = new URLSearchParams(location.search);
      const id = String(animalNumberEl?.value || "").trim() || qp.get("number") || localStorage.getItem("lastAnimalId") || "";
      const dt = String(eventDateEl?.value || "").trim() || qp.get("date") || todayLocal();
      location.href = `add-event.html?number=${encodeURIComponent(id)}&date=${encodeURIComponent(dt)}`;
    });
  </script>
</body>
</html>




