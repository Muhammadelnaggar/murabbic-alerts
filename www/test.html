<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>اختبار سريع للحفظ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:24px}
    #card{max-width:520px;margin:auto;border:1px solid #ddd;border-radius:12px;padding:16px}
    #log{margin-top:8px;opacity:.85}
    button{padding:10px 14px;border:0;border-radius:8px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:default}
  </style>
</head>
<body>
  <div id="card">
    <h2>🔎 اختبار سريع: حفظ حدث في Firestore</h2>
    <ol>
      <li>هيحاول يعمل دخول Anonymous تلقائيًا.</li>
      <li>اضغط الزر تحت علشان نسجّل حدث “تحصين” تجريبي.</li>
    </ol>

    <button id="btnTest">تجربة الحفظ</button>
    <div id="log"></div>
  </div>

  <!-- 1) إعدادات Firebase بتاعت مشروعك -->
  <script>
    window.firebaseConfig = {
      apiKey: "PLACEHOLDER",
      authDomain: "PLACEHOLDER.firebaseapp.com",
      projectId: "PLACEHOLDER",
      appId: "PLACEHOLDER"
    };
  </script>

  <!-- 2) ملفاتنا المشتركة -->
  <script type="module" src="/js/store.js"></script>
  <script type="module" src="/js/smart-tracker.js"></script>

  <!-- 3) سكربت الاختبار -->
  <script type="module">
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js';

    const logEl = document.getElementById('log');
    const btn   = document.getElementById('btnTest');
    const log = (t)=> logEl.textContent = t;

    // دخول Anonymous علشان القواعد تسمح بالحفظ
    const auth = getAuth();
    onAuthStateChanged(auth, (u)=>{
      if(u){ log('✅ دخلنا بحساب Anonymous: ' + u.uid.slice(0,8) + '…'); }
    });
    try {
      await signInAnonymously(auth);
    } catch(e) {
      log('⚠️ لازم تفعّل Anonymous Sign-in من Firebase Console > Authentication > Sign-in method');
      console.error(e);
    }

    // زر التجربة: يحفظ حدث vaccination تجريبي
    btn.addEventListener('click', async ()=>{
      btn.disabled = true; log('جارٍ الحفظ…');
      try {
        const today = new Date(); const pad = n=>String(n).padStart(2,'0');
        const ymd = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;

        const id = await window.Store.saveEvent({
          animalNumber: 'TEST-123',
          eventDate: ymd,
          type: 'vaccination',
          notes: 'اختبار يدوي',
          meta: { vaccine:'Demo', boosterDays: 7 }
        });

        log('تم الحفظ ✅ (Event ID: ' + id + '). افتح Firestore وشوفه في مجموعة events. ولو smart-tracker شغّال، هتلاقي Task booster في tasks.');
        console.log('✅ Event saved id =', id);
      } catch(e){
        log('خطأ: ' + (e.userFacing ? e.message : (e.message || 'تعذّر الحفظ')));
        console.error(e);
      } finally {
        btn.disabled = false;
      }
    });

    // لو مش عامل showInlineMessage في مشروعك، خلّيها Console
    window.showInlineMessage ??= (m)=>console.log('INFO:', m);
  </script>
</body>
</html>
