<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <title>تسجيل حدث الولادة — مُرَبِّك</title>
  <style>
    :root{
      --green:#0ea05a;--green-600:#0b7f47;--bg:#f7faf7;--text:#0f172a;
      --muted:#64748b;--card:#ffffff
    }
    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden;min-height:100%;height:100%}

    body{
      min-height:100dvh;
      margin:0;
      font-family:'Cairo',Tahoma,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      background:#fff;
      border-bottom:1px solid #e2e8f0;
      box-shadow:0 2px 4px rgba(0,0,0,.05)
    }
    .bar{
      max-width:920px;margin:0 auto;
      padding:14px 18px;
      display:flex;gap:8px;
      align-items:center;justify-content:space-between
    }
    .bar-right{display:flex;align-items:center;gap:10px;min-width:0}
    .bar-left{display:flex;align-items:center;gap:10px;justify-content:flex-start;white-space:nowrap}

    .brand{
      display:flex;align-items:center;gap:10px;
      text-decoration:none;
      color:var(--text);
    }
    .brand img{
      width:42px;height:42px;
      border-radius:10px;
      object-fit:cover;
      box-shadow:0 2px 6px rgba(0,0,0,.10);
    }
    .brand .name{
      font-weight:900;
      color:#0f172a;
      font-size:16px;
    }

   

    .title{font-weight:700;color:var(--green-600);font-size:18px}
    main{
      max-width:920px;
      margin:20px auto;
      padding:16px;
      padding-bottom:110px
    }
    .card{
      background:var(--card);
      border:1px solid #e2e8f0;
      border-radius:16px;
      padding:20px;
      box-shadow:0 2px 6px rgba(0,0,0,.05)
    }
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .row{display:grid;gap:14px;min-width:0}
    @media(min-width:720px){.row{grid-template-columns:repeat(2,1fr)}}
    label{
      font-weight:600;font-size:15px;
      color:#0f172a;
      display:block;margin-bottom:6px
    }
    input,select{
      width:100%;padding:12px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      background:#fff;font-size:16px
    }
    .radio-group{
      display:flex;flex-wrap:wrap;
      gap:10px;padding:6px 0
    }
    .radio-group label{
      font-weight:500;font-size:14px;
      background:#f1f5f9;
      border:1px solid #cbd5e1;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer
    }
    .radio-group input{margin-inline-start:6px}
    .actions-bar{
      position:fixed;bottom:0;left:0;right:0;
      background:#fff;
      border-top:1px solid #e2e8f0;
      box-shadow:0 -2px 6px rgba(0,0,0,.08);
      display:flex;gap:10px;
      padding:12px;z-index:20
    }
    .actions-bar button{
      flex:1;padding:14px;
      font-size:16px;font-weight:700;
      border-radius:12px;cursor:pointer;border:0
    }
    .actions-bar .save{background:var(--green);color:#fff}
    .actions-bar .ghost{background:#eef2f7;color:#0f172a}
    /* عنوان الصفحة */
.page-title{
  font-size:20px;
  font-weight:900;
  color:var(--green-600);
}

/* الشعار */
.brand img{
  width:52px;       /* أكبر شوية */
  height:52px;
}

.brand .name{
  font-size:18px;
  font-weight:900;  /* خط عريض */
  letter-spacing:.5px;
}

/* زر العودة */
.back-btn{
  text-decoration:none;
  padding:10px 14px;
  border-radius:12px;
  font-weight:700;
  font-size:14px;
  color:#0f172a;
  background:#f1f5f9;
  border:1px solid #cbd5e1;
  transition:.15s ease;
}

.back-btn:hover{
  background:#e2e8f0;
  border-color:#94a3b8;
}

  </style>
</head>
<body>

  <!-- تتبّع أساسي -->
  <script>window.dataLayer = window.dataLayer || [];</script>

 <header>
  <div class="bar">
    <!-- اليمين: العنوان -->
    <div class="bar-right">
      <div class="page-title">الولادة</div>
    </div>

    <!-- اليسار: زر الرجوع + الشعار -->
    <div class="bar-left">
      <a href="add-event.html" class="back-btn">
        ← العودة للأحداث
      </a>

      <a class="brand" href="dashboard.html" aria-label="Murabbik">
        <img src="logo.png" alt="شعار مُرَبِّك">
        <span class="name">مُرَبِّك</span>
      </a>
    </div>
  </div>

  <!-- infobar زي ما هو (مهم) -->
  <div class="infobar-wrap">
    <div id="info" class="infobar" role="status" aria-live="polite">
      <div class="msg-row">
        <div id="infoText" class="msg-text"></div>
        <button id="infoClose" class="msg-close" type="button">×</button>
      </div>
      <div id="infoActions" class="msg-actions"></div>
    </div>
  </div>
</header>


  <main>
    <form id="calving-form" class="card grid" autocomplete="off" novalidate
          data-validate="true" data-event="ولادة">
      <input type="hidden" data-field="animalId" id="animalId">
      <input type="hidden" data-field="species" id="species">
      

      <div class="row">
        <div>
          <label>رقم الحيوان</label>
          <input id="animalNumber" data-field="animalNumber" inputmode="numeric"
                 placeholder="مثال: 1023" required />
        </div>
        <div>
          <label>تاريخ الولادة</label>
          <input id="eventDate" data-field="eventDate" type="date" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>نوع الولادة</label>
          <select id="calvingKind" data-field="calvingKind" required>
            <option value="">اختر</option>
            <option value="طبيعية">طبيعية</option>
            <option value="متعسرة">متعسرة</option>
            <option value="قيصرية">قيصرية</option>
            <option value="نافقة">نافقة</option>
          </select>
        </div>
        <div class="live-only">
          <label>عدد المواليد</label>
          <div class="radio-group">
            <label><input type="radio" name="calfCount" data-field="calfCount" value="1" required> 1</label>
            <label><input type="radio" name="calfCount" data-field="calfCount" value="2"> 2</label>
            <label><input type="radio" name="calfCount" data-field="calfCount" value="3"> 3</label>
          </div>
        </div>
      </div>

      <div class="offspring-group live-only" id="offspring1">
        <label>المولود (1)</label>
        <div class="row">
          <div>
            <label>جنس المولود</label>
            <div class="radio-group">
              <label><input type="radio" name="calf1Sex" data-field="calf1Sex" value="ذكر" required> ذكر</label>
              <label><input type="radio" name="calf1Sex" data-field="calf1Sex" value="أنثى"> أنثى</label>
            </div>
          </div>
          <div>
            <label>رقم العجل</label>
            <input id="calfId" data-field="calfId" placeholder="رقم تعريف العجل" required />
          </div>
        </div>
      </div>

      <div class="offspring-group live-only" id="offspring2" style="display:none">
        <label>المولود (2)</label>
        <div class="row">
          <div>
            <label>جنس المولود</label>
            <div class="radio-group">
              <label><input type="radio" name="calf2Sex" data-field="calf2Sex" value="ذكر"> ذكر</label>
              <label><input type="radio" name="calf2Sex" data-field="calf2Sex" value="أنثى"> أنثى</label>
            </div>
          </div>
          <div>
            <label>رقم العجل</label>
            <input id="calf2Id" data-field="calf2Id" placeholder="رقم تعريف العجل الثاني" />
          </div>
        </div>
      </div>

      <div class="offspring-group live-only" id="offspring3" style="display:none">
        <label>المولود (3)</label>
        <div class="row">
          <div>
            <label>جنس المولود</label>
            <div class="radio-group">
              <label><input type="radio" name="calf3Sex" data-field="calf3Sex" value="ذكر"> ذكر</label>
              <label><input type="radio" name="calf3Sex" data-field="calf3Sex" value="أنثى"> أنثى</label>
            </div>
          </div>
          <div>
            <label>رقم العجل</label>
            <input id="calf3Id" data-field="calf3Id" placeholder="رقم تعريف العجل الثالث" />
          </div>
        </div>
      </div>

      <div class="row live-only">
        <div>
          <label>مصير العجل</label>
          <div class="radio-group">
            <label><input type="radio" name="calfFate" data-field="calfFate" value="تربية" required> تربية</label>
            <label><input type="radio" name="calfFate" data-field="calfFate" value="بيع"> بيع</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>آخر تلقيح مُخصِّب</label>
          <input id="lastFertile" type="date" data-field="lastFertileInseminationDate" required />
        </div>
        <div>
          <label>ملاحظات</label>
          <input id="notes" data-field="notes" placeholder="اختياري" />
        </div>
      </div>
    </form>
  </main>

  <div class="actions-bar">
    <button class="save" id="saveBtn" type="submit" form="calving-form">حفظ الولادة ✅</button>
    <button class="ghost" id="toCardBtn" type="button">فتح بطاقة الحيوان</button>
  </div>

  <script src="/js/app-core.js"></script>

  <script>
    /* ملء الرقم والتاريخ من add-event */
    (function(){
      const qs = new URLSearchParams(location.search);
      const $  = (id)=> document.getElementById(id);
      function toISO(s){
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        const d = new Date(s); if (isNaN(d)) return '';
        return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      }
      document.addEventListener('DOMContentLoaded', ()=>{
        const num  = qs.get('number') || qs.get('animalNumber') || '';
        const date = qs.get('date')   || qs.get('dt') || '';
        if (num  && $('animalNumber')) $('animalNumber').value = String(num).replace(/[^\d٠-٩۰-۹]/g,'');
        if (date && $('eventDate'))    $('eventDate').value    = toISO(date);
      });
    })();
  </script>


  

 <script type="module">
  import { db, auth } from '/js/firebase-config.js';
  import {
    collection, addDoc, serverTimestamp, setDoc, doc
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { updateAnimalByEvent } from '/js/animal-update.js';

  const form   = document.querySelector('#calving-form');
  const numEl  = document.getElementById('animalNumber');
  const kindEl = document.getElementById('calvingKind');

  // ✅ اعرض رسائل عبر النظام المركزي (forms-init.js)
 function showBar(msg, isError=false, actions=[]){
  if (typeof window.mbkShowBar === 'function') {
   window.mbkShowBar(msg, isError, actions);


    return;
  }
  alert(msg);
}


  // ✅ تطبيع الرقم عربي/إنجليزي
  function normNumberDigits(number){
    const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9',
                 '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
    return String(number || '')
      .trim()
      .replace(/[^\d٠-٩۰-۹]/g,'')
      .replace(/[٠-٩۰-۹]/g, d=>map[d]);
  }

  // ✅ UI فقط: مزامنة مجموعات العجول (مسموح)
  function syncCalfGroups(){
    const isDead = (kindEl.value === 'نافقة');
    const count = parseInt(
      form.querySelector('input[name="calfCount"]:checked')?.value || '1',
      10
    );

    document.querySelectorAll('.live-only').forEach(el=>{
      el.style.display = isDead ? 'none' : '';
    });

    const enableLive = !isDead;

    // required toggles
    const calfCountRadios = form.querySelectorAll('input[name="calfCount"]');
    calfCountRadios.forEach((r, i)=>{
      if (enableLive) r.required = (i === 0);
      else { r.required = false; r.checked = false; }
    });

    const calfId1 = document.getElementById('calfId');
    const calf1SexRadios = form.querySelectorAll('input[name="calf1Sex"]');
    const calfFateRadios = form.querySelectorAll('input[name="calfFate"]');

    if (calfId1){ calfId1.required = enableLive; if (!enableLive) calfId1.value=''; }
    calf1SexRadios.forEach((r,i)=>{ r.required = enableLive && i===0; if (!enableLive) r.checked=false; });
    calfFateRadios.forEach((r,i)=>{ r.required = enableLive && i===0; if (!enableLive) r.checked=false; });

    [['offspring2',2], ['offspring3',3]].forEach(([id,idx])=>{
      const group = document.getElementById(id);
      const vis = enableLive && count >= idx;
      if (group) group.style.display = vis ? '' : 'none';

      const idEl   = document.getElementById(`calf${idx}Id`);
      const sexRad = form.querySelectorAll(`input[name="calf${idx}Sex"]`);
      if (idEl){ idEl.required = vis; if (!vis) idEl.value=''; }
      sexRad.forEach((r,i)=>{ r.required = vis && i===0; if (!vis) r.checked=false; });
    });
  }

  kindEl?.addEventListener('change', syncCalfGroups);
  form.querySelectorAll('input[name="calfCount"]').forEach(r=> r.addEventListener('change', syncCalfGroups));
  document.addEventListener('DOMContentLoaded', syncCalfGroups);

  // ✅ القاعدة الذهبية: الصفحة لا تعمل submit listener
  // forms-init.js هو من يطلق mbk:valid بعد Gate + Validation

  function disableForm(disabled=true){
    form.querySelectorAll('input, select, button').forEach(el=>{
      if (el.id === 'toCardBtn') return;
      el.disabled = disabled;
    });
  }

  async function getUid(){
    return String(
      window.__tenant?.userId ||
      localStorage.getItem("userId") ||
      auth?.currentUser?.uid ||
      ""
    ).trim();
  }

  document.addEventListener('mbk:valid', async (e)=>{
    const formData = e.detail || {};

    const uid = await getUid();
    if (!uid){ showBar('سجّل الدخول أولًا.', true); return; }

    const kind = (formData.calvingKind || '').trim();
    const isDead = (kind === 'نافقة');

    const payload = {
      userId: uid,
      type: 'ولادة',
      eventType: 'ولادة',
      eventDate: (formData.eventDate || '').trim(),
      animalNumber: normNumberDigits(formData.animalNumber || ''),
      animalId: (formData.animalId || '').trim(),          // ✅ يملؤه forms-init
      species: formData.species || '',                     // ✅ يملؤه forms-init
      reproStatus: formData.reproStatus || 'عشار',
     lastFertileInseminationDate: formData.lastFertileInseminationDate || '',

      calvingKind: kind,

      calfCount: isDead ? '0' : (formData.calfCount || ''),
      calf1Sex:  isDead ? '' : (formData.calf1Sex || ''),
      calfId:    isDead ? '' : (formData.calfId || ''),
      calf2Sex:  isDead ? '' : (formData.calf2Sex || ''),
      calf2Id:   isDead ? '' : (formData.calf2Id || ''),
      calf3Sex:  isDead ? '' : (formData.calf3Sex || ''),
      calf3Id:   isDead ? '' : (formData.calf3Id || ''),
      calfFate:  isDead ? '' : (formData.calfFate || ''),
      notes:     formData.notes || '',

     

      createdAt: serverTimestamp()
    };
payload.idempotencyKey = `${payload.animalNumber}-ولادة-${payload.eventDate}`;

    try{
      disableForm(true);

      // 1) save event
      await addDoc(collection(db, 'events'), payload);

      // 2) update animal doc (نفس ملفك)
     await updateAnimalByEvent({ ...payload, type:'ولادة', eventType:'ولادة' });


      // 3) save calves (Idempotent) only if not dead
      if (!isDead) {
        const damId     = payload.animalId;
        const damNumber = payload.animalNumber;
        const birthDate = payload.eventDate;
        const species   = payload.species;

        const count = parseInt(payload.calfCount || '1',10) || 1;

        const calvesToSave = [];
        const pushCalf = (calfIdField, calfSexField)=>{
          const id  = normNumberDigits(formData[calfIdField] || '');
          const sex = (formData[calfSexField] || '').trim();
          if (!id || !sex) return;
          calvesToSave.push({
            userId: uid,
            damId,
            damNumber,
            birthDate,
            calfNumber: id,
            sex,
            species,
            createdAt: serverTimestamp()
          });
        };

        pushCalf('calfId','calf1Sex');
        if (count >= 2) pushCalf('calf2Id','calf2Sex');
        if (count >= 3) pushCalf('calf3Id','calf3Sex');

        for (const calf of calvesToSave){
          const calfDocId = `${uid}-${damNumber}-${birthDate}-${calf.calfNumber}`;
          await setDoc(doc(db,'calves',calfDocId), calf, { merge:true });
        }
      }

      showBar('تم حفظ الولادة وتسجيل العجول بنجاح ✅', false, [{
        label:'فتح قائمة الأحداث',
        className:'btn-ok',
        onClick: ()=> location.href =
          `/event-list.html?number=${encodeURIComponent(payload.animalNumber)}&date=${encodeURIComponent(payload.eventDate)}`
      }]);

    }catch(err){
      console.error(err);
      disableForm(false);
      showBar('تعذّر حفظ الحدث – تحقّق من الاتصال والصلاحيات.', true);
    }
  });

  document.getElementById('toCardBtn')?.addEventListener('click', ()=>{
    const num = normNumberDigits(numEl?.value || '');
    if (!num){
      showBar('أدخل رقم الحيوان أولًا قبل فتح البطاقة.', true);
      return;
    }
    location.href = `/cow-card.html?number=${encodeURIComponent(num)}`;
  });
</script>



</body>
</html>






