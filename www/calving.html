<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تسجيل حدث الولادة — مُرَبِّك</title>
  <style>
    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff; --danger:#c2410c }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Segoe UI','Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0}
    .bar{max-width:920px;margin:0 auto;padding:12px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .title{font-weight:700;color:var(--green-600)}

    main{max-width:920px;margin:16px auto;padding:16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    label{font-weight:600;font-size:14px;color:#0f172a}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:15px}
    textarea{min-height:80px;resize:vertical}
    .row{display:grid;gap:12px}
    @media(min-width:720px){.row{grid-template-columns:repeat(3,1fr)}}
    .actions{display:flex;gap:10px;justify-content:stretch;margin-top:12px}
    button{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
    .save{background:var(--green);color:#fff}
    .ghost{background:#eef2f7;color:#0f172a}

    .infobar{display:none;margin-top:12px;padding:12px;border-radius:10px;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .infobar.show{display:block}
    .error{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
  </style>
</head>
<body>
  <script>window.dataLayer = window.dataLayer || [];</script>
  <header>
    <div class="bar">
      <div class="title">تسجيل حدث الولادة</div>
      <a class="ghost" href="add-event.html" style="text-decoration:none;padding:10px 12px;border-radius:10px">عودة للأحداث</a>
    </div>
  </header>

  <main>
    <div class="card grid" id="formCard">
      <div class="row">
        <div>
          <label>رقم الحيوان</label>
          <input id="animalNumber" inputmode="numeric" placeholder="مثال: 1023" />
        </div>
        <div>
          <label>المعرّف (إن وجد)</label>
          <input id="animalId" placeholder="animalId" />
        </div>
        <div>
          <label>تاريخ الولادة</label>
          <input id="eventDate" type="date" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>نوع الولادة</label>
          <select id="calvingKind">
            <option value="طبيعية">طبيعية</option>
            <option value="متعسرة">متعسرة</option>
            <option value="قيصرية">قيصرية</option>
          </select>
        </div>
        <div>
          <label>عدد المواليد</label>
          <select id="calfCount">
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </div>
        <div>
          <label>المشيمة المحتبسة</label>
          <select id="retainedPlacenta">
            <option value="لا">لا</option>
            <option value="نعم">نعم</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>جنس المولود (1)</label>
          <select id="calf1Sex">
            <option value="غير محدد">غير محدد</option>
            <option value="ذكر">ذكر</option>
            <option value="أنثى">أنثى</option>
            <option value="ميت">ميت</option>
          </select>
        </div>
        <div>
          <label>جنس المولود (2)</label>
          <select id="calf2Sex">
            <option value="غير محدد">غير محدد</option>
            <option value="ذكر">ذكر</option>
            <option value="أنثى">أنثى</option>
            <option value="ميت">ميت</option>
          </select>
        </div>
        <div>
          <label>ملاحظات</label>
          <input id="notes" placeholder="اختياري" />
        </div>
      </div>

      <div class="actions">
        <button class="save" id="saveBtn">حفظ الولادة ✅</button>
        <button class="ghost" id="toCardBtn">فتح بطاقة الحيوان</button>
      </div>

      <div id="info" class="infobar"></div>
    </div>
  </main>

  <!-- ترتيب السكربتات حسب معايير مربيك (مُحدَّث لتفادي أخطاء 404 و Firebase) -->
  <script>window.dataLayer = window.dataLayer || [];</script>
  <!-- تأكد من تهيئة Firebase قبل أي سكربت قد يستدعي getApp() -->
  <script type="module" src="/js/firebase-config.js"></script>
  <script src="/js/app-core.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>
  <script src="/js/api.js"></script>
  <!-- فallback خفيف في حال /js/api.js غير موجود أو لم يعرِّف window.api -->
  <script>
    (function(){
      if(!window.api){
        console.warn('[calving] /js/api.js غير متاح — تفعيل فالباك fetch');
        window.api = {
          async post(url, body){
            const base = window.API_BASE || '';
            const uid = localStorage.getItem('userId') || localStorage.getItem('tenantId') || '';
            const res = await fetch(base + url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-User-Id': uid },
              body: JSON.stringify(body)
            });
            let json = null; try{ json = await res.clone().json(); }catch(_){ }
            return res.ok ? (json || { ok:true }) : { error:true, status: res.status, body: (json||await res.text()) };
          }
        };
      }
    })();
  </script>
  <!-- ضع السكربتات التي قد تستخدم Firebase بعد firebase-config -->
  <script type="module" src="/js/timeline.js"></script>
  <script type="module" src="/js/smart-checks.js"></script>
  <script type="module">
    // ✅ بدلًا من تحميل api.js كملف منفصل (سبب الخطأ 404/MIME)
    // نضمّن غلاف API بسيط هنا متوافق مع /api/*

    const API_BASE = window.API_BASE || '';
    window.api = {
      async post(path, data){
        try{
          const res = await fetch(API_BASE + path, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-User-Id': localStorage.getItem('userId') || ''
            },
            body: JSON.stringify(data)
          });
          return await res.json();
        }catch(err){
          console.error('API error', err);
          return {error: true, message: err.message};
        }
      }
    };

    const $ = (id)=>document.getElementById(id);

    function getQuery(){
      const p = new URLSearchParams(location.search);
      return Object.fromEntries(p.entries());
    }
    function getCtx(){
      const q = getQuery();
      return {
        animalId: q.animalId || q.id || localStorage.getItem('currentAnimalId') || localStorage.getItem('lastAnimalId') || '',
        animalNumber: q.number || q.animalNumber || localStorage.getItem('currentAnimalNumber') || '',
        eventDate: q.date || q.eventDate || localStorage.getItem('lastEventDate') || new Date().toISOString().slice(0,10)
      };
    }

    const ctx = getCtx();
    $('animalId').value = ctx.animalId;
    $('animalNumber').value = ctx.animalNumber;
    $('eventDate').value = ctx.eventDate;
    $('calf2Sex').disabled = true;

    $('calfCount').addEventListener('change', ()=>{
      const two = $('calfCount').value === '2';
      $('calf2Sex').disabled = !two;
      if(!two){ $('calf2Sex').value = 'غير محدد'; }
    });

    $('toCardBtn').addEventListener('click', ()=>{
      const number = $('animalNumber').value || ctx.animalNumber || '';
      if(!number){ return showMsg('من فضلك أدخل رقم الحيوان لفتح البطاقة', true); }
      location.href = `cow-card.html?number=${encodeURIComponent(number)}`;
    });

    $('saveBtn').addEventListener('click', onSave);

    async function onSave(){
      try{
        const animalId = $('animalId').value.trim();
        const animalNumber = $('animalNumber').value.trim();
        const eventDate = $('eventDate').value;
        if(!animalId && !animalNumber){
          return showMsg('أدخل رقم الحيوان أو المعرّف قبل الحفظ', true);
        }
        if(!eventDate){
          return showMsg('من فضلك اختر تاريخ الولادة', true);
        }
        const today = new Date().toISOString().slice(0,10);
        if(eventDate > today){
          return showMsg('تاريخ الولادة لا يمكن أن يكون في المستقبل', true);
        }

        const payload = {
          type: 'ولادة',
          eventType: 'calving',
          eventDate,
          animalId: animalId || undefined,
          animalNumber: animalNumber || undefined,
          calvingKind: $('calvingKind').value,
          calfCount: Number($('calfCount').value),
          calf1Sex: $('calf1Sex').value,
          calf2Sex: $('calf2Sex').value,
          retainedPlacenta: $('retainedPlacenta').value === 'نعم',
          notes: $('notes').value.trim() || undefined,
          source: location.pathname
        };

        try{ window.t?.event && t.event('calving_save_attempt', payload); }catch(_){ }

        const res = await window.api.post('/api/events', payload);
        if(!res || res.error){
          console.warn('API response', res);
          return showMsg('تعذّر الحفظ عبر الخادم — سيتم الحفظ لاحقًا أو جرّب مجددًا', true);
        }

        localStorage.setItem('lastAnimalId', animalId || ctx.animalId || '');
        localStorage.setItem('lastEventDate', eventDate);

        try{ t.event('calving_save_success', {eventDate, calfCount: payload.calfCount}); }catch(_){ }
        showMsg('✅ تم حفظ حدث الولادة بنجاح. يمكنك المتابعة أو فتح البطاقة.', false);

      }catch(err){
        console.error(err);
        showMsg('حدث خطأ غير متوقع أثناء الحفظ', true);
      }
    }

    function showMsg(text, isError){
      const el = $('info');
      el.className = 'infobar ' + (isError ? 'show error' : 'show');
      el.textContent = text;
    }
  </script>
</body>
</html>
