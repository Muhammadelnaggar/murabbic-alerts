<!DOCTYPE html>
<html lang="ar" dir="rtl" data-page="calving">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  

  <title>تسجيل ولادة — مُرَبِّيك</title>

  <style>
    :root{
      --green:#0ea05a;--green-600:#0b7f47;--bg:#f7faf7;--text:#0f172a;
      --muted:#64748b;--card:#ffffff
    }
    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{
      margin:0;
      font-family:'Cairo',Tahoma,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      background:#fff;
      border-bottom:1px solid #e2e8f0;
      box-shadow:0 2px 4px rgba(0,0,0,.05)
    }
    main{
      max-width:920px;
      margin:20px auto;
      padding:16px;
      padding-bottom:110px
    }
    .card{
      background:var(--card);
      border:1px solid #e2e8f0;
      border-radius:16px;
      padding:20px;
      box-shadow:0 2px 6px rgba(0,0,0,.05)
    }
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .row{display:grid;gap:14px;min-width:0}
    @media(min-width:720px){.row{grid-template-columns:repeat(2,1fr)}}
    label{
      font-weight:600;font-size:15px;
      color:#0f172a;
      display:block;margin-bottom:6px
    }
    input,select{
      width:100%;padding:12px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      background:#fff;font-size:16px
    }
    .radio-group{
      display:flex;flex-wrap:wrap;
      gap:10px;padding:6px 0
    }
    .radio-group label{
      font-weight:500;font-size:14px;
      background:#f1f5f9;
      border:1px solid #cbd5e1;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer
    }
    .radio-group input{margin-inline-start:6px}

    .actions-bar{
      position:fixed;bottom:0;left:0;right:0;
      background:#fff;
      border-top:1px solid #e2e8f0;
      box-shadow:0 -2px 6px rgba(0,0,0,.08);
      display:flex;gap:10px;
      padding:12px;z-index:20
    }
    .actions-bar button{
      flex:1;padding:14px;
      font-size:16px;font-weight:700;
      border-radius:12px;cursor:pointer;border:0
    }
    .actions-bar .save{background:var(--green);color:#fff}
    .actions-bar .ghost{background:#eef2f7;color:#0f172a}

    .infobar{
      display:none;margin-top:14px;padding:12px;
      border-radius:10px;font-size:14px;font-weight:700;
      text-align:center;margin-inline:auto;max-width:560px
    }
    /* رسالة خطأ */
.infobar.error{
  background:#fff1f2;
  border:1px solid #fecaca;
  color:#b91c1c;
}

/* رسالة نجاح */
.infobar.success{
  background:#ecfdf5;
  border:1px solid #bbf7d0;
  color:#065f46;
}

/* رسالة عادية (معلومة / جاري التحقق) */
.infobar.info{
  background:#eff6ff;
  border:1px solid #bfdbfe;
  color:#1e40af;
}


    /* ===== Header (Calving) ===== */
    .mbk-head{
      max-width:920px;margin:0 auto;
      padding:12px 16px;
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;
    }
    .mbk-logo{height:56px;width:auto;object-fit:contain;opacity:.70}
    .mbk-center{flex:1;text-align:center;line-height:1.15}
    .mbk-page-title{font-weight:900;color:var(--green-600);font-size:18px}
    .mbk-app-name{font-weight:800;font-size:13px;opacity:.85;margin-top:4px}
    .mbk-back{
      width:44px;height:44px;border-radius:999px;
      background:#f1f5f9;border:1px solid #cbd5e1;
      color:#0f172a;text-decoration:none;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;
    }

    #sysbar{
      display:none;
      max-width:920px;
      margin:10px auto 0;
    }
    #sysbar.show{display:block}

    /* أزرار تفاعلية داخل الانفوبار */
    .infobar .sys-actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .infobar .sys-btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #cbd5e1;
      background:#fff;
      cursor:pointer;
      font-weight:800;
      font-size:14px;
      color:#0f172a;
      min-width:140px;
    }
    .infobar .sys-btn.primary{
      border:0;
      background:var(--green);
      color:#fff;
    }
    .infobar.error .sys-btn.primary{
      background:#dc2626;
    }

    /* مسافة خفيفة بين مجموعات المواليد */
    .offspring-group{padding-top:4px}
  </style>
</head>

<body>
  <!-- تتبّع أساسي -->
  <script>window.dataLayer = window.dataLayer || [];</script>

  <header>
    <div class="mbk-head">
      <img class="mbk-logo" src="/images/logo.png" alt="مُرَبِّيك">
      <div class="mbk-center">
        <div class="mbk-page-title">تسجيل ولادة</div>
        <div class="mbk-app-name">مُرَبِّيك</div>
      </div>
      <a class="mbk-back" href="add-event.html">رجوع</a>
    </div>
  </header>

  <!-- ✅ كل رسائل النظام هنا تحت العنوان مباشرة -->
  <div id="sysbar" class="infobar" role="status" aria-live="polite"></div>

  <main>
    <form id="calving-form" class="card grid" autocomplete="off" novalidate
          data-validate="true" data-event="ولادة">

      <input type="hidden" data-field="animalId" id="animalId">
      <input type="hidden" data-field="species" id="species">
      <input type="hidden" data-field="reproStatus" value="عشار">

      <div class="row">
        <div>
          <label>رقم الحيوان</label>
          <input id="animalNumber" data-field="animalNumber" inputmode="numeric"
                 placeholder="مثال: 1023" required />
        </div>
        <div>
          <label>تاريخ الولادة</label>
          <input id="eventDate" data-field="eventDate" type="date" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>نوع الولادة</label>
          <select id="calvingKind" data-field="calvingKind" required>
            <option value="">اختر</option>
            <option value="طبيعية">طبيعية</option>
            <option value="متعسرة">متعسرة</option>
            <option value="قيصرية">قيصرية</option>
            <option value="نافقة">نافقة</option>
          </select>
        </div>
        <div class="live-only">
          <label>عدد المواليد</label>
          <div class="radio-group">
            <label><input type="radio" name="calfCount" data-field="calfCount" value="1" required> 1</label>
            <label><input type="radio" name="calfCount" data-field="calfCount" value="2"> 2</label>
            <label><input type="radio" name="calfCount" data-field="calfCount" value="3"> 3</label>
          </div>
        </div>
      </div>

      <!-- ===================== مولود (1) ===================== -->
      <div class="offspring-group live-only" id="offspring1">
        <label>المولود (1)</label>

        <div class="row">
          <div>
            <label>جنس المولود</label>
            <div class="radio-group">
              <label><input type="radio" name="calf1Sex" data-field="calf1Sex" value="ذكر" required> ذكر</label>
              <label><input type="radio" name="calf1Sex" data-field="calf1Sex" value="أنثى"> أنثى</label>
            </div>
          </div>
          <div>
            <label>رقم العجل</label>
            <input id="calfId" data-field="calfId" placeholder="رقم تعريف العجل" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label>مصير العجل (1)</label>
            <div class="radio-group">
              <label><input type="radio" name="calf1Fate" data-field="calf1Fate" value="تربية" required> تربية</label>
              <label><input type="radio" name="calf1Fate" data-field="calf1Fate" value="بيع"> بيع</label>
            </div>
          </div>
        </div>
      </div>

      <!-- ===================== مولود (2) ===================== -->
      <div class="offspring-group live-only" id="offspring2" style="display:none">
        <label>المولود (2)</label>

        <div class="row">
          <div>
            <label>جنس المولود</label>
            <div class="radio-group">
              <label><input type="radio" name="calf2Sex" data-field="calf2Sex" value="ذكر" required> ذكر</label>
              <label><input type="radio" name="calf2Sex" data-field="calf2Sex" value="أنثى"> أنثى</label>
            </div>
          </div>
          <div>
            <label>رقم العجل</label>
            <input id="calf2Id" data-field="calf2Id" placeholder="رقم تعريف العجل الثاني" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label>مصير العجل (2)</label>
            <div class="radio-group">
              <label><input type="radio" name="calf2Fate" data-field="calf2Fate" value="تربية" required> تربية</label>
              <label><input type="radio" name="calf2Fate" data-field="calf2Fate" value="بيع"> بيع</label>
            </div>
          </div>
        </div>
      </div>

      <!-- ===================== مولود (3) ===================== -->
      <div class="offspring-group live-only" id="offspring3" style="display:none">
        <label>المولود (3)</label>

        <div class="row">
          <div>
            <label>جنس المولود</label>
            <div class="radio-group">
              <label><input type="radio" name="calf3Sex" data-field="calf3Sex" value="ذكر" required> ذكر</label>
              <label><input type="radio" name="calf3Sex" data-field="calf3Sex" value="أنثى"> أنثى</label>
            </div>
          </div>
          <div>
            <label>رقم العجل</label>
            <input id="calf3Id" data-field="calf3Id" placeholder="رقم تعريف العجل الثالث" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label>مصير العجل (3)</label>
            <div class="radio-group">
              <label><input type="radio" name="calf3Fate" data-field="calf3Fate" value="تربية" required> تربية</label>
              <label><input type="radio" name="calf3Fate" data-field="calf3Fate" value="بيع"> بيع</label>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>آخر تلقيح مُخصِّب</label>
          <input id="lastInseminationDate" type="date" data-field="lastInseminationDate" required />
        </div>
        <div>
          <label>ملاحظات</label>
          <input id="notes" data-field="notes" placeholder="اختياري" />
        </div>
      </div>

    </form>
  </main>

  <div class="actions-bar">
    <button class="save" id="saveBtn" type="submit" form="calving-form">حفظ الولادة ✅</button>
    <button class="ghost" id="toCardBtn" type="button">فتح بطاقة الحيوان</button>
  </div>

  <script src="/js/app-core.js"></script>

  <script>
    /* ملء الرقم والتاريخ من add-event */
    (function(){
      const qs = new URLSearchParams(location.search);
      const $  = (id)=> document.getElementById(id);
      function toISO(s){
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        const d = new Date(s); if (isNaN(d)) return '';
        return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      }
      document.addEventListener('DOMContentLoaded', ()=>{
        const num  = qs.get('number') || qs.get('animalNumber') || '';
        const date = qs.get('date')   || qs.get('dt') || qs.get('eventDate') || '';
        if (num && $('animalNumber')) {
          $('animalNumber').value = String(num).replace(/[^\d٠-٩۰-۹]/g,'');
          $('animalNumber').dispatchEvent(new Event('input', { bubbles:true }));
          $('animalNumber').dispatchEvent(new Event('change', { bubbles:true }));
        }
        if (date && $('eventDate')) {
          $('eventDate').value = toISO(date);
          $('eventDate').dispatchEvent(new Event('input', { bubbles:true }));
          $('eventDate').dispatchEvent(new Event('change', { bubbles:true }));
        }
      });
    })();
  </script>
<script type="module">
  import { initEventShell } from "/js/event-shell.js";
  initEventShell({ pageId: "calving", title: "تسجيل ولادة", logoSrc: "/images/logo.png", backHref: "add-event.html" });
</script>

  <script type="module">
    import { db, auth } from '/js/firebase-config.js';
    import {
      collection, addDoc, serverTimestamp, query, where, limit, getDocs
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { updateAnimalByEvent } from '/js/animal-update.js';

    const form   = document.querySelector('#calving-form');
    const sysbar = document.getElementById('sysbar');
    const numEl  = document.getElementById('animalNumber');
    const kindEl = document.getElementById('calvingKind');

    function scrollToSysbar(){
      try{ sysbar?.scrollIntoView({ behavior:'smooth', block:'start' }); }catch(_){}
    }

    function showSysbar(msg, { error=false, actions=[] } = {}){
      sysbar.style.display = 'block';
      sysbar.classList.add('show');
      sysbar.classList.toggle('error', !!error);

      const safeMsg = String(msg || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      sysbar.innerHTML = `<div class="sys-msg">${safeMsg}</div>`;

      if (Array.isArray(actions) && actions.length){
        const wrap = document.createElement('div');
        wrap.className = 'sys-actions';

        actions.forEach((a)=>{
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'sys-btn' + (a.primary ? ' primary' : '');
          btn.textContent = a.label || 'إجراء';
          btn.addEventListener('click', ()=>{ try{ a.onClick && a.onClick(); }catch(_){ } });
          wrap.appendChild(btn);
        });

        sysbar.appendChild(wrap);
      }

      scrollToSysbar();
    }

    /* مزامنة مجموعات العجول (UI فقط) */
    function syncCalfGroups(){
      const isDead = (kindEl.value === 'نافقة');
      const count = parseInt(
        form.querySelector('input[name="calfCount"]:checked')?.value || '1',
        10
      );

      document.querySelectorAll('.live-only').forEach(el=>{
        el.style.display = isDead ? 'none' : '';
      });

      const enableLive = !isDead;

      // required/checked للعدد
      const calfCountRadios = form.querySelectorAll('input[name="calfCount"]');
      calfCountRadios.forEach((r, i)=>{
        if (enableLive) r.required = (i === 0);
        else { r.required = false; r.checked = false; }
      });

      // مولود (1)
      const calfId1 = document.getElementById('calfId');
      const calf1SexRadios  = form.querySelectorAll('input[name="calf1Sex"]');
      const calf1FateRadios = form.querySelectorAll('input[name="calf1Fate"]');

      if (calfId1){ calfId1.required = enableLive; if (!enableLive) calfId1.value=''; }
      calf1SexRadios.forEach((r,i)=>{ r.required = enableLive && i===0; if (!enableLive) r.checked=false; });
      calf1FateRadios.forEach((r,i)=>{ r.required = enableLive && i===0; if (!enableLive) r.checked=false; });

      // مولود (2) و(3)
      [['offspring2',2], ['offspring3',3]].forEach(([id,idx])=>{
        const group = document.getElementById(id);
        const vis = enableLive && count >= idx;
        if (group) group.style.display = vis ? '' : 'none';

        const idEl   = document.getElementById(`calf${idx}Id`);
        const sexRad = form.querySelectorAll(`input[name="calf${idx}Sex"]`);
        const fateRad= form.querySelectorAll(`input[name="calf${idx}Fate"]`);

        if (idEl){ idEl.required = vis; if (!vis) idEl.value=''; }
        sexRad.forEach((r,i)=>{ r.required = vis && i===0; if (!vis) r.checked=false; });
        fateRad.forEach((r,i)=>{ r.required = vis && i===0; if (!vis) r.checked=false; });
      });
    }

    kindEl?.addEventListener('change', syncCalfGroups);
    form.querySelectorAll('input[name="calfCount"]').forEach(r=> r.addEventListener('change', syncCalfGroups));
    document.addEventListener('DOMContentLoaded', syncCalfGroups);

    async function getUid(){
      if (auth.currentUser) return auth.currentUser.uid;
      const u = await new Promise(res => onAuthStateChanged(auth, u => res(u)));
      return u?.uid || '';
    }

    function disableForm(disabled=true){
      form.querySelectorAll('input, select, button').forEach(el=>{
        if (el.id === 'toCardBtn') return;
        el.disabled = disabled;
      });
    }

    /* منع تكرار ولادة لنفس اليوم */
    async function existsCalvingSameDay(uid, number, dateISO){
      const num = String(number || '').trim();
      const q1 = query(
        collection(db, 'events'),
        where('userId', '==', uid),
        where('animalNumber', '==', num),
        where('eventType', '==', 'ولادة'),
        where('eventDate', '==', dateISO),
        limit(1)
      );
      const snap = await getDocs(q1);
      return !snap.empty;
    }

    /* الحفظ الفعلي — بعد mbk:valid من forms-init.js */
    document.addEventListener('mbk:valid', async (e)=>{
      const { formData } = e.detail;

      const uid = await getUid();
      if (!uid){
        showSysbar('سجّل الدخول أولًا.', { error:true });
        return;
      }

      const _animalNumber = (formData.animalNumber || '').trim();
      const _eventDate    = (formData.eventDate || '').trim();

      const payload = {
        userId: uid,
        type: 'ولادة',
        eventType: 'ولادة',
        eventDate: _eventDate,
        animalNumber: _animalNumber,
        animalId: (formData.animalId || '').trim(),
        species: formData.species || '',
        reproStatus: formData.reproStatus || 'عشار',
        lastInseminationDate: (formData.lastInseminationDate || '').trim(),
        lastFertileInseminationDate: (formData.lastInseminationDate || '').trim(), // توافق قديم

        calvingKind: formData.calvingKind || '',
        calfCount: formData.calfCount || '',
        calf1Sex:  formData.calf1Sex || '',
        calfId:    formData.calfId || '',
        calf2Sex:  formData.calf2Sex || '',
        calf2Id:   formData.calf2Id || '',
        calf3Sex:  formData.calf3Sex || '',
        calf3Id:   formData.calf3Id || '',

        calf1Fate: formData.calf1Fate || '',
        calf2Fate: formData.calf2Fate || '',
        calf3Fate: formData.calf3Fate || '',

        notes:     formData.notes || '',
        idempotencyKey: `${_animalNumber}-ولادة-${_eventDate}`,
        createdAt: serverTimestamp()
      };

      try{
        disableForm(true);

        const alreadyExists = await existsCalvingSameDay(uid, payload.animalNumber, payload.eventDate);
        if (alreadyExists) {
          disableForm(false);
          showSysbar('⚠️ تم تسجيل ولادة لهذا الحيوان في نفس التاريخ من قبل.', { error: true });
          return;
        }

        showSysbar('جارِ الحفظ…');

        // حفظ حدث الولادة
        await addDoc(collection(db, 'events'), payload);

        // تحديث وثيقة الحيوان
        await updateAnimalByEvent({ ...payload, type:'calving', eventType:'calving' });

        // حفظ العجول في calves (لو مش نافقة)
        const isDead = (String(payload.calvingKind || '').trim() === 'نافقة');
        if (!isDead) {
          const damId     = payload.animalId;
          const damNumber = payload.animalNumber;
          const birthDate = payload.eventDate;
          const species   = payload.species;

          const calvesToSave = [];
          const count = parseInt(payload.calfCount || '1',10) || 1;

          // ✅ دالة واحدة صحيحة (بدون تكرار)
          const pushCalf = (calfIdField, calfSexField, calfFateField)=>{
            const id   = (formData[calfIdField] || '').trim();
            const sex  = (formData[calfSexField] || '').trim();
            const fate = (formData[calfFateField] || '').trim();
            if (!id || !sex) return;
            calvesToSave.push({
              userId: uid,
              damId,
              damNumber,
              birthDate,
              calfNumber: id,
              sex,
              fate,
              species,
              createdAt: serverTimestamp()
            });
          };

          pushCalf('calfId','calf1Sex','calf1Fate');
          if (count >= 2) pushCalf('calf2Id','calf2Sex','calf2Fate');
          if (count >= 3) pushCalf('calf3Id','calf3Sex','calf3Fate');

          for (const calf of calvesToSave){
            await addDoc(collection(db,'calves'), calf);
          }
        }

        showSysbar('تم حفظ الولادة وتسجيل العجول بنجاح ✅', {
          actions:[
            {
              label:'فتح قائمة الأحداث',
              primary:true,
              onClick:()=> location.href = `/event-list.html?number=${encodeURIComponent(payload.animalNumber)}`
            },
            {
              label:'فتح بطاقة الحيوان',
              onClick:()=> location.href = `/cow-card.html?number=${encodeURIComponent(payload.animalNumber)}`
            }
          ]
        });

      }catch(err){
        console.error(err);
        disableForm(false);
        showSysbar('تعذّر حفظ الحدث – تحقّق من الاتصال والصلاحيات.', { error:true });
      }
    });

    document.getElementById('toCardBtn')?.addEventListener('click', ()=>{
      const num = (numEl?.value || '').trim();
      if (!num){
        showSysbar('أدخل رقم الحيوان أولًا قبل فتح البطاقة.', { error:true });
        return;
      }
      location.href = `/cow-card.html?number=${encodeURIComponent(num)}`;
    });
  </script>
</body>
</html>



