<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <title>تسجيل حدث الولادة — مُرَبِّك</title>
  <style>
    :root{--green:#0ea05a;--green-600:#0b7f47;--bg:#f7faf7;--text:#0f172a;--muted:#64748b;--card:#ffffff}
    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{margin:0;font-family:'Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .bar{max-width:920px;margin:0 auto;padding:14px 18px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .title{font-weight:700;color:var(--green-600);font-size:18px}
    main{max-width:920px;margin:20px auto;padding:16px;padding-bottom:110px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;padding:20px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .row{display:grid;gap:14px;min-width:0}
    @media(min-width:720px){.row{grid-template-columns:repeat(2,1fr)}}
    label{font-weight:600;font-size:15px;color:#0f172a;display:block;margin-bottom:6px}
    input,select{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:16px}
    .radio-group{display:flex;flex-wrap:wrap;gap:10px;padding:6px 0}
    .radio-group label{font-weight:500;font-size:14px;background:#f1f5f9;border:1px solid #cbd5e1;border-radius:8px;padding:6px 10px;cursor:pointer}
    .radio-group input{margin-inline-start:6px}
    .actions-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #e2e8f0;box-shadow:0 -2px 6px rgba(0,0,0,.08);display:flex;gap:10px;padding:12px;z-index:20}
    .actions-bar button{flex:1;padding:14px;font-size:16px;font-weight:700;border-radius:12px;cursor:pointer;border:0}
    .actions-bar .save{background:var(--green);color:#fff}
    .actions-bar .ghost{background:#eef2f7;color:#0f172a}
    .infobar{display:none;margin-top:14px;padding:12px;border-radius:10px;font-size:14px;font-weight:700;text-align:center;margin-inline:auto;max-width:560px}
    .infobar.show{display:block}
    .infobar.error{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412}
    .infobar:not(.error){background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
  </style>
</head>
<body>
  <script>window.dataLayer = window.dataLayer || [];</script>
 

  <header>
    <div class="bar">
      <div class="title">تسجيل حدث الولادة</div>
      <a class="ghost" href="add-event.html" style="text-decoration:none;padding:10px 12px;border-radius:10px">عودة للأحداث</a>
    </div>
  </header>

  <main>
   <form id="calving-form" class="card grid" autocomplete="off" novalidate>
      <div class="row">
        <div>
          <label>رقم الحيوان</label>
         <input id="animalNumber" data-field="animalNumber" inputmode="numeric" placeholder="مثال: 1023" required />
        </div>
        <div>
          <label>تاريخ الولادة</label>
        <input id="eventDate" data-field="eventDate" type="date" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>نوع الولادة</label>
          <select id="calvingKind" required>
            <option value="">اختر</option>
            <option value="طبيعية">طبيعية</option>
            <option value="متعسرة">متعسرة</option>
            <option value="قيصرية">قيصرية</option>
            <option value="نافقة">نافقة</option>
          </select>
        </div>
        <div class="live-only">
          <label>عدد المواليد</label>
          <div class="radio-group">
            <label><input type="radio" name="calfCount" value="1" required> 1</label>
            <label><input type="radio" name="calfCount" value="2"> 2</label>
            <label><input type="radio" name="calfCount" value="3"> 3</label>
          </div>
        </div>
      </div>

      <div class="offspring-group live-only" id="offspring1">
        <label>المولود (1)</label>
        <div class="row">
          <div>
            <label>جنس المولود</label>
            <div class="radio-group">
              <label><input type="radio" name="calf1Sex" value="ذكر" required> ذكر</label>
              <label><input type="radio" name="calf1Sex" value="أنثى"> أنثى</label>
            </div>
          </div>
          <div>
            <label>رقم العجل</label>
            <input id="calfId" placeholder="رقم تعريف العجل" required />
          </div>
        </div>
      </div>

      <div class="offspring-group live-only" id="offspring2" style="display:none">
        <label>المولود (2)</label>
        <div class="row">
          <div>
            <label>جنس المولود</label>
            <div class="radio-group">
              <label><input type="radio" name="calf2Sex" value="ذكر"> ذكر</label>
              <label><input type="radio" name="calf2Sex" value="أنثى"> أنثى</label>
            </div>
          </div>
          <div>
            <label>رقم العجل</label>
            <input id="calf2Id" placeholder="رقم تعريف العجل الثاني" />
          </div>
        </div>
      </div>

      <div class="offspring-group live-only" id="offspring3" style="display:none">
        <label>المولود (3)</label>
        <div class="row">
          <div>
            <label>جنس المولود</label>
            <div class="radio-group">
              <label><input type="radio" name="calf3Sex" value="ذكر"> ذكر</label>
              <label><input type="radio" name="calf3Sex" value="أنثى"> أنثى</label>
            </div>
          </div>
          <div>
            <label>رقم العجل</label>
            <input id="calf3Id" placeholder="رقم تعريف العجل الثالث" />
          </div>
        </div>
      </div>

      <div class="row live-only">
        <div>
          <label>مصير العجل</label>
          <div class="radio-group">
            <label><input type="radio" name="calfFate" value="تربية" required> تربية</label>
            <label><input type="radio" name="calfFate" value="بيع"> بيع</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>ملاحظات</label>
          <input id="notes" placeholder="اختياري" />
        </div>
      </div>

     <div id="info" class="infobar"></div>
    </form>
  </main>

  <div class="actions-bar">
    <button class="save" id="saveBtn" type="submit" form="calving-form">حفظ الولادة ✅</button>
    <button class="ghost" id="toCardBtn">فتح بطاقة الحيوان</button>
  </div>

  <!-- اختياري: سكربتاتك للذكاء/التتبع لو متاحة -->
  <script src="/js/app-core.js"></script>
   <script type="module" src="/js/firebase-config.js"></script>
  <script type="module" src="/js/timeline.js"></script>
  <script type="module" src="/js/smart-checks.js"></script>
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const $  = (id)=> document.getElementById(id);

  function toISO(s){
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const d = new Date(s); if (isNaN(d)) return '';
    // ISO محلي بدون انزياح المنطقة الزمنية
    return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const num  = qs.get('number') || qs.get('animalNumber') || '';
    const date = qs.get('date')   || qs.get('dt') || '';
    if (num  && $('animalNumber')) $('animalNumber').value = String(num).replace(/[^\d٠-٩۰-۹]/g,'');
    if (date && $('eventDate'))    $('eventDate').value    = toISO(date);
  });
})();
</script>

 <script type="module">
  import { db } from '/js/firebase-config.js';
  import { attachFormValidation, calvingDecision } from '/js/form-rules.js';
  import { collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const form   = document.querySelector('#calving-form');      // تأكد من id الفورم
  const uid    = localStorage.getItem('userId') || localStorage.getItem('uid') || '';
  const numEl  = form.querySelector('[data-field="animalNumber"]');
  const dateEl = form.querySelector('[data-field="eventDate"]');

  // فعّل الفالديشن العام الموجود في SCHEMAS للنوع calving
  attachFormValidation(form, 'calving', { todayISO: new Date().toISOString().slice(0,10) });

  // تحميل النوع + الحالة التناسلية + آخر تلقيح (للحساب)
async function fetchCtx(){
  const num = (numEl?.value || '').trim();
  if (!uid || !num) return { species:'', reproStatus:'', lastInseminationISO:'' };

  // الحيوان: النوع + الحالة التناسلية
  const aSnap = await getDocs(query(
    collection(db,'animals'),
    where('userId','==',uid),
    where('animalNumber','==',num),
    limit(1)
  ));
  const animal = aSnap.empty ? {} : aSnap.docs[0].data();
  const species     = animal.type || animal.species || animal['النوع'] || '';
  const reproStatus = animal.reproStatus || animal['الحالة التناسلية'] || '';

  // آخر تلقيح (يتطلب إندكس مركّب)
  const eSnap = await getDocs(query(
    collection(db,'events'),
    where('userId','==',uid),
    where('animalNumber','==',num),
    where('type','in',['تلقيح','insemination']),
    orderBy('eventDate','desc'),
    limit(1)
  ));
  const lastInseminationISO = eSnap.empty ? '' : (eSnap.docs[0].data().eventDate || '');

  return { species, reproStatus, lastInseminationISO };
}

  // قرار قبل الحفظ: عشار + حد أدنى لأيام الحمل (255 أبقار / 285 جاموس) + تاريخ منطقي
  form.addEventListener('submit', async (e)=>{
    const { species, reproStatus, lastInseminationISO } = await fetchCtx();
    const ok = calvingDecision({
      species,
      reproStatus,
      lastInseminationISO,
      eventDateISO: (dateEl?.value || '').trim(),
      animalNumber: (numEl?.value || '').trim(),
      abortionUrl: '/abortion.html'
    });
    if (!ok) { e.preventDefault(); e.stopPropagation(); }
  });
</script>

</body>
</html>







