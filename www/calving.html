<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</title>
  <style>
    :root{
      --green:#0ea05a;--green-600:#0b7f47;--bg:#f7faf7;--text:#0f172a;
      --muted:#64748b;--card:#ffffff
    }
    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{
      margin:0;
      font-family:'Cairo',Tahoma,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      background:#fff;
      border-bottom:1px solid #e2e8f0;
      box-shadow:0 2px 4px rgba(0,0,0,.05)
    }
    .bar{
      max-width:920px;margin:0 auto;
      padding:14px 18px;
      display:flex;gap:8px;
      align-items:center;justify-content:space-between
    }
    .title{font-weight:700;color:var(--green-600);font-size:18px}
    main{
      max-width:920px;
      margin:20px auto;
      padding:16px;
      padding-bottom:110px
    }
    .card{
      background:var(--card);
      border:1px solid #e2e8f0;
      border-radius:16px;
      padding:20px;
      box-shadow:0 2px 6px rgba(0,0,0,.05)
    }
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .row{display:grid;gap:14px;min-width:0}
    @media(min-width:720px){.row{grid-template-columns:repeat(2,1fr)}}
    label{
      font-weight:600;font-size:15px;
      color:#0f172a;
      display:block;margin-bottom:6px
    }
    input,select{
      width:100%;padding:12px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      background:#fff;font-size:16px
    }
    .radio-group{
      display:flex;flex-wrap:wrap;
      gap:10px;padding:6px 0
    }
    .radio-group label{
      font-weight:500;font-size:14px;
      background:#f1f5f9;
      border:1px solid #cbd5e1;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer
    }
    .radio-group input{margin-inline-start:6px}
    .actions-bar{
      position:fixed;bottom:0;left:0;right:0;
      background:#fff;
      border-top:1px solid #e2e8f0;
      box-shadow:0 -2px 6px rgba(0,0,0,.08);
      display:flex;gap:10px;
      padding:12px;z-index:20
    }
    .actions-bar button{
      flex:1;padding:14px;
      font-size:16px;font-weight:700;
      border-radius:12px;cursor:pointer;border:0
    }
    .actions-bar .save{background:var(--green);color:#fff}
    .actions-bar .ghost{background:#eef2f7;color:#0f172a}
    .infobar{
      display:none;margin-top:14px;padding:12px;
      border-radius:10px;font-size:14px;font-weight:700;
      text-align:center;margin-inline:auto;max-width:560px
    }
    .infobar.show{display:block}
    .infobar.error{
      background:#fff7ed;border:1px solid #fed7aa;color:#9a3412
    }
    .infobar:not(.error){
      background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46
    }

    /* Popup ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø© */
    #mbkModalOverlay{
      position:fixed;inset:0;
      background:rgba(15,23,42,0.40);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    #mbkModal{
      background:#ffffff;
      border-radius:18px;
      padding:18px 20px 16px;
      max-width:320px;
      width:90%;
      text-align:center;
      box-shadow:0 18px 40px rgba(0,0,0,.22);
    }
    #mbkModalText{
      font-weight:700;
      font-size:15px;
      margin-bottom:14px;
      line-height:1.6;
    }
    #mbkModalBtn{
      margin-top:4px;
      padding:10px 14px;
      width:100%;
      border-radius:999px;
      border:0;
      cursor:pointer;
      background:#16a34a;
      color:#fff;
      font-weight:700;
      font-size:15px;
    }
  </style>
</head>
<body>

  <!-- ØªØªØ¨Ù‘Ø¹ Ø£Ø³Ø§Ø³ÙŠ -->
  <script>window.dataLayer = window.dataLayer || [];</script>

  <!-- Popup -->
  <div id="mbkModalOverlay">
    <div id="mbkModal">
      <div id="mbkModalText"></div>
      <button id="mbkModalBtn" type="button">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>

  <header>
    <div class="bar">
      <div class="title">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</div>
      <a class="ghost" href="add-event.html"
         style="text-decoration:none;padding:10px 12px;border-radius:10px">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø­Ø¯Ø§Ø«</a>
    </div>
  </header>

  <main>
    <form id="calving-form" class="card grid" autocomplete="off" novalidate
          data-validate="true" data-event="ÙˆÙ„Ø§Ø¯Ø©">
      <input type="hidden" data-field="animalId" id="animalId">
      <input type="hidden" data-field="species" id="species">
      <input type="hidden" data-field="reproStatus" value="Ø¹Ø´Ø§Ø±">

      <div class="row">
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
          <input id="animalNumber" data-field="animalNumber" inputmode="numeric"
                 placeholder="Ù…Ø«Ø§Ù„: 1023" required />
        </div>
        <div>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</label>
          <input id="eventDate" data-field="eventDate" type="date" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</label>
          <select id="calvingKind" data-field="calvingKind" required>
            <option value="">Ø§Ø®ØªØ±</option>
            <option value="Ø·Ø¨ÙŠØ¹ÙŠØ©">Ø·Ø¨ÙŠØ¹ÙŠØ©</option>
            <option value="Ù…ØªØ¹Ø³Ø±Ø©">Ù…ØªØ¹Ø³Ø±Ø©</option>
            <option value="Ù‚ÙŠØµØ±ÙŠØ©">Ù‚ÙŠØµØ±ÙŠØ©</option>
            <option value="Ù†Ø§ÙÙ‚Ø©">Ù†Ø§ÙÙ‚Ø©</option>
          </select>
        </div>
        <div class="live-only">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</label>
          <div class="radio-group">
            <label><input type="radio" name="calfCount" data-field="calfCount" value="1" required> 1</label>
            <label><input type="radio" name="calfCount" data-field="calfCount" value="2"> 2</label>
            <label><input type="radio" name="calfCount" data-field="calfCount" value="3"> 3</label>
          </div>
        </div>
      </div>

      <div class="offspring-group live-only" id="offspring1">
        <label>Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯ (1)</label>
        <div class="row">
          <div>
            <label>Ø¬Ù†Ø³ Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯</label>
            <div class="radio-group">
              <label><input type="radio" name="calf1Sex" data-field="calf1Sex" value="Ø°ÙƒØ±" required> Ø°ÙƒØ±</label>
              <label><input type="radio" name="calf1Sex" data-field="calf1Sex" value="Ø£Ù†Ø«Ù‰"> Ø£Ù†Ø«Ù‰</label>
            </div>
          </div>
          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¬Ù„</label>
            <input id="calfId" data-field="calfId" placeholder="Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ø¬Ù„" required />
          </div>
        </div>
      </div>

      <div class="offspring-group live-only" id="offspring2" style="display:none">
        <label>Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯ (2)</label>
        <div class="row">
          <div>
            <label>Ø¬Ù†Ø³ Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯</label>
            <div class="radio-group">
              <label><input type="radio" name="calf2Sex" data-field="calf2Sex" value="Ø°ÙƒØ±"> Ø°ÙƒØ±</label>
              <label><input type="radio" name="calf2Sex" data-field="calf2Sex" value="Ø£Ù†Ø«Ù‰"> Ø£Ù†Ø«Ù‰</label>
            </div>
          </div>
          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¬Ù„</label>
            <input id="calf2Id" data-field="calf2Id" placeholder="Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ø¬Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ" />
          </div>
        </div>
      </div>

      <div class="offspring-group live-only" id="offspring3" style="display:none">
        <label>Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯ (3)</label>
        <div class="row">
          <div>
            <label>Ø¬Ù†Ø³ Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯</label>
            <div class="radio-group">
              <label><input type="radio" name="calf3Sex" data-field="calf3Sex" value="Ø°ÙƒØ±"> Ø°ÙƒØ±</label>
              <label><input type="radio" name="calf3Sex" data-field="calf3Sex" value="Ø£Ù†Ø«Ù‰"> Ø£Ù†Ø«Ù‰</label>
            </div>
          </div>
          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¬Ù„</label>
            <input id="calf3Id" data-field="calf3Id" placeholder="Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ø¬Ù„ Ø§Ù„Ø«Ø§Ù„Ø«" />
          </div>
        </div>
      </div>

      <div class="row live-only">
        <div>
          <label>Ù…ØµÙŠØ± Ø§Ù„Ø¹Ø¬Ù„</label>
          <div class="radio-group">
            <label><input type="radio" name="calfFate" data-field="calfFate" value="ØªØ±Ø¨ÙŠØ©" required> ØªØ±Ø¨ÙŠØ©</label>
            <label><input type="radio" name="calfFate" data-field="calfFate" value="Ø¨ÙŠØ¹"> Ø¨ÙŠØ¹</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­ Ù…ÙØ®ØµÙ‘ÙØ¨</label>
          <input id="lastFertile" type="date" data-field="lastFertileInseminationDate" required />
        </div>
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input id="notes" data-field="notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
        </div>
      </div>

      <div id="info" class="infobar"></div>
    </form>
  </main>

  <div class="actions-bar">
    <button class="save" id="saveBtn" type="submit" form="calving-form">Ø­ÙØ¸ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© âœ…</button>
    <button class="ghost" id="toCardBtn">ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
  </div>

  <script src="/js/app-core.js"></script>

  <script>
    /* Ù…Ù„Ø¡ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† add-event */
    (function(){
      const qs = new URLSearchParams(location.search);
      const $  = (id)=> document.getElementById(id);
      function toISO(s){
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        const d = new Date(s); if (isNaN(d)) return '';
        return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      }
      document.addEventListener('DOMContentLoaded', ()=>{
        const num  = qs.get('number') || qs.get('animalNumber') || '';
        const date = qs.get('date')   || qs.get('dt') || '';
        if (num  && $('animalNumber')) $('animalNumber').value = String(num).replace(/[^\dÙ -Ù©Û°-Û¹]/g,'');
        if (date && $('eventDate'))    $('eventDate').value    = toISO(date);
      });
    })();
  </script>

  <script type="module">
    import { db, auth } from '/js/firebase-config.js';
    import {
      collection, addDoc, serverTimestamp, query, where, limit,
      getDocs, orderBy
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { updateAnimalByEvent } from '/js/animal-update.js';

    /* ===== Popup helper ===== */
    const modalOverlay = document.getElementById('mbkModalOverlay');
    const modalText    = document.getElementById('mbkModalText');
    const modalBtn     = document.getElementById('mbkModalBtn');
    let modalCallback  = null;

    function showPopup(msg, ok=false, cb){
      modalText.textContent = msg;
      modalCallback = typeof cb === 'function' ? cb : null;
      modalBtn.style.background = ok ? '#16a34a' : '#dc2626';
      modalOverlay.style.display = 'flex';
    }
    modalBtn.addEventListener('click', ()=>{
      modalOverlay.style.display = 'none';
      if (modalCallback){ const fn = modalCallback; modalCallback=null; fn(); }
    });

    const form   = document.querySelector('#calving-form');
    const info   = document.getElementById('info');
    const numEl  = document.getElementById('animalNumber');
    const dateEl = document.getElementById('eventDate');
    const kindEl = document.getElementById('calvingKind');
    const saveBtn= document.getElementById('saveBtn');

    const animalIdEl = document.getElementById('animalId');
    const speciesEl  = document.getElementById('species');
    const lastFertileEl = document.getElementById('lastFertile');

    /* Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ø¬ÙˆÙ„ */
    function syncCalfGroups(){
      const isDead = (kindEl.value === 'Ù†Ø§ÙÙ‚Ø©');
      const count = parseInt(
        form.querySelector('input[name="calfCount"]:checked')?.value || '1',
        10
      );

      document.querySelectorAll('.live-only').forEach(el=>{
        el.style.display = isDead ? 'none' : '';
      });

      const calfId1 = document.getElementById('calfId');
      const calf1SexRadios = form.querySelectorAll('input[name="calf1Sex"]');
      const calfFateRadios = form.querySelectorAll('input[name="calfFate"]');
      const enableLive = !isDead;

      if (calfId1){ calfId1.required = enableLive; if (!enableLive) calfId1.value=''; }
      calf1SexRadios.forEach((r,i)=>{ r.required = enableLive && i===0; if (!enableLive) r.checked=false; });
      calfFateRadios.forEach((r,i)=>{ r.required = enableLive && i===0; if (!enableLive) r.checked=false; });

      [['offspring2',2], ['offspring3',3]].forEach(([id,idx])=>{
        const group = document.getElementById(id);
        const vis = enableLive && count >= idx;
        if (group) group.style.display = vis ? '' : 'none';

        const idEl   = document.getElementById(`calf${idx}Id`);
        const sexRad = form.querySelectorAll(`input[name="calf${idx}Sex"]`);
        if (idEl){ idEl.required = vis; if (!vis) idEl.value=''; }
        sexRad.forEach((r,i)=>{ r.required = vis && i===0; if (!vis) r.checked=false; });
      });
    }
    kindEl?.addEventListener('change', syncCalfGroups);
    form.querySelectorAll('input[name="calfCount"]').forEach(r=> r.addEventListener('change', syncCalfGroups));
    document.addEventListener('DOMContentLoaded', syncCalfGroups);

    /* Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© */
    function todayISO(){
      const d=new Date(); d.setHours(0,0,0,0);
      return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    }
    async function getUid(){
      if (auth.currentUser) return auth.currentUser.uid;
      const u = await new Promise(res => onAuthStateChanged(auth, u => res(u)));
      return u?.uid || '';
    }
    function disableForm(disabled=true){
      form.querySelectorAll('input, select, button').forEach(el=>{
        if (el.id === 'toCardBtn') return;
        el.disabled = disabled;
      });
    }
    const MIN_GD = { 'Ø£Ø¨Ù‚Ø§Ø±': 255, 'Ø¬Ø§Ù…ÙˆØ³': 285 };

    function normSpecies(data){
      const s = String(
        data.animalTypeAr || data.animalType || data.species || ''
      ).trim();
      if (s === 'cow' || /Ø¨Ù‚Ø±/i.test(s))       return 'Ø£Ø¨Ù‚Ø§Ø±';
      if (s === 'buffalo' || /Ø¬Ø§Ù…ÙˆØ³/i.test(s)) return 'Ø¬Ø§Ù…ÙˆØ³';
      return s;
    }
    function daysBetweenISO(a,b){
      const A = new Date(a), B = new Date(b);
      if (isNaN(A) || isNaN(B)) return NaN;
      A.setHours(0,0,0,0); B.setHours(0,0,0,0);
      return Math.round((B - A)/86400000);
    }
    function cmpISO(a,b){ return new Date(a) - new Date(b); }

    /* Ù‚Ø±Ø§Ø¡Ø© Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ù…Ù† Ø¹Ø¯Ø© Ø­Ù‚ÙˆÙ„ ÙˆØ¨Ø£Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„ÙØ© */
    async function fetchAnimalDocByNumber(number){
      const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9',
                   'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
      const raw = String(number || '')
        .trim()
        .replace(/[^\dÙ -Ù©Û°-Û¹]/g,'')
        .replace(/[Ù -Ù©Û°-Û¹]/g, d=>map[d]);
      const asStr = raw;
      const asNum = raw ? Number(raw) : NaN;

      const tries = [
        ['animalNumber','==',asStr],
        ['animalNumber','==',asNum],
        ['number','==',asStr],
        ['number','==',asNum],
        ['animalNo','==',asStr],
        ['animalNo','==',asNum],
      ].filter(t => !(typeof t[2] === 'number' && Number.isNaN(t[2])));

      for (const [field,op,val] of tries){
        const q1 = query(collection(db,'animals'), where(field, op, val), limit(1));
        const snap = await getDocs(q1);
        if (!snap.empty){
          const doc = snap.docs[0];
          return { id: doc.id, data: doc.data() || {} };
        }
      }
      return null;
    }

    async function fetchSignalsFromEvents(number){
      const uid = await getUid();
      const num = String(number||'').trim();

      const qEv = query(
        collection(db,'events'),
        where('userId','==', uid),
        where('animalNumber','==', num),
        orderBy('eventDate','desc'),
        limit(50)
      );

      const snap = await getDocs(qEv);
      let pregnant = null;
      let lastFertileDate = null;
      let lastBoundary = null;

      for (const d of snap.docs){
        const ev = d.data() || {};
        const type = ev.eventType || ev.type || '';
        const res  = ev.result || ev.status || '';
        const dt   = ev.eventDate;

        if (type === 'ÙˆÙ„Ø§Ø¯Ø©' || type === 'Ø¥Ø¬Ù‡Ø§Ø¶'){
          if (!lastBoundary) lastBoundary = dt;
          if (pregnant === null) pregnant = false;
          continue;
        }
        if (type === 'ØªØ´Ø®ÙŠØµ Ø­Ù…Ù„'){
          const normRes = String(res).replace(/\s+/g,'').replace(/[ÙÙ‹ÙŒÙÙÙÙ’Ù‘]/g,'');
          if (normRes.includes('Ø¹Ø´Ø§Ø±') && pregnant === null) pregnant = true;
          if (normRes.includes('ÙØ§Ø±ØºÙ‡') || normRes.includes('ÙØ§Ø±ØºØ©')){
            if (pregnant === null) pregnant = false;
          }
        }
        if (!lastFertileDate && (type === 'ØªÙ„Ù‚ÙŠØ­ Ù…Ø®ØµØ¨' || ev.fertile === true || res === 'Ù…Ø®ØµØ¨')){
          lastFertileDate = dt;
        }
        if (pregnant !== null && lastFertileDate) break;
      }

      return { pregnant, lastFertileDate, lastBoundary };
    }

    function offerAbort(number, evISO, g, sp){
      const msg =
        `Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©: Ø¹Ù…Ø± Ø§Ù„Ø­Ù…Ù„ ${g} ÙŠÙˆÙ… ÙˆÙ‡Ùˆ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ (${MIN_GD[sp]} ÙŠÙˆÙ… Ù„Ù„Ù€${sp}).`;
      showPopup(msg, false, ()=>{
        // Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ù†Ø¹Ø±Ø¶ Ø²Ø±Ù‘ÙŠÙ† ÙÙŠ Ø§Ù„Ù€ infobar ÙƒØ¨Ø¯ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        info.className = 'infobar show error';
        info.innerHTML =
          `Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©: Ø¹Ù…Ø± Ø§Ù„Ø­Ù…Ù„ ${g} ÙŠÙˆÙ… ÙˆÙ‡Ùˆ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ (${MIN_GD[sp]} ÙŠÙˆÙ… Ù„Ù„Ù€${sp}).<br>` +
          `<div style="margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
             <button id="goAbort"
                     style="padding:8px 12px;border-radius:10px;border:0;background:#ef4444;color:#fff;font-weight:700;cursor:pointer">
               ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ù‡Ø§Ø¶ Ø§Ù„Ø¢Ù†
             </button>
             <button id="editDate"
                     style="padding:8px 12px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;font-weight:700;cursor:pointer">
               ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©
             </button>
           </div>`;
        document.getElementById('goAbort')?.addEventListener('click', ()=>{
          const url = `/abortion.html?number=${encodeURIComponent(String(number||''))}&date=${encodeURIComponent(evISO)}`;
          location.href = url;
        });
        document.getElementById('editDate')?.addEventListener('click', ()=>{
          dateEl?.focus({preventScroll:true});
          dateEl?.scrollIntoView({behavior:'smooth', block:'center'});
        });
      });
    }

    async function precheck(number){
      disableForm(true);
      info.className = 'infobar show';
      info.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†â€¦';

      const a = await fetchAnimalDocByNumber(number);
      if (!a){
        info.className = 'infobar show error';
        info.textContent = 'Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
        showPopup('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„: Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', false);
        return;
      }

      const sp = normSpecies(a.data);
      if (!sp || !MIN_GD[sp]) {
        info.className = 'infobar show error';
        info.textContent = 'Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ/ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù†.';
        showPopup('Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ùˆ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù†.', false);
        return;
      }

      const rsDoc = a.data.reproductiveStatus || a.data.reproStatus || '';
      const rsNorm = String(rsDoc)
        .replace(/\s+/g,'')
        .replace(/[ÙÙ‹ÙŒÙÙÙÙ’Ù‘]/g,''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„
      const isPregDoc = /Ø¹Ø´Ø§Ø±|Ø­Ø§Ù…Ù„/i.test(rsNorm);

      const { pregnant: pregEv, lastFertileDate: lfEv, lastBoundary } =
        await fetchSignalsFromEvents(number);

      const isPreg = (pregEv !== null) ? pregEv : isPregDoc;

      const lfDoc = a.data.lastInseminationDate || a.data.lastFertileInseminationDate || '';
      const lf = lfEv || lfDoc;

      if (!isPreg){
        info.className = 'infobar show error';
        info.textContent = 'Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©: Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ© Ù„ÙŠØ³Øª "Ø¹Ø´Ø§Ø±".';
        showPopup('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©: Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ© Ù„ÙŠØ³Øª "Ø¹Ø´Ø§Ø±".', false);
        return;
      }
      if (!lf){
        info.className = 'infobar show error';
        info.textContent = 'Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ "Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­ Ù…ÙØ®ØµÙ‘ÙØ¨".';
        showPopup('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ® Ù„Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­ Ù…ÙØ®ØµÙ‘ÙØ¨.', false);
        return;
      }

      if (lastBoundary && cmpISO(lastBoundary, lf) >= 0){
        info.className = 'infobar show error';
        info.textContent = `Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©: Ø¢Ø®Ø± Ø­Ø¯Ø« (${lastBoundary}) ÙŠÙ„ØºÙŠ Ø£ÙŠ Ø­Ù…Ù„ Ø­Ø§Ù„ÙŠ.`;
        showPopup('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©: ÙŠÙˆØ¬Ø¯ Ø­Ø¯Ø« ÙˆÙ„Ø§Ø¯Ø©/Ø¥Ø¬Ù‡Ø§Ø¶ Ø£Ø­Ø¯Ø« Ù…Ù† Ø§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ù…Ø®ØµÙ‘ÙØ¨.', false);
        return;
      }

      const evISO = (dateEl?.value && dateEl.value.trim()) || todayISO();
      const g = daysBetweenISO(lf, evISO);
      if (!(g >= MIN_GD[sp])){
        offerAbort(number, evISO, g, sp);
        disableForm(false);
        return;
      }

      if (speciesEl)  speciesEl.value  = sp;
      if (animalIdEl) animalIdEl.value = a.id;
      if (lastFertileEl && !lastFertileEl.value) lastFertileEl.value = lf;
      if (dateEl && !dateEl.value) dateEl.value = evISO;

      info.className = 'infobar show';
      info.textContent = 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„ âœ…';
      disableForm(false);
    }

    function kickPrecheck(){
      const n = (numEl?.value||'').trim();
      if (!n){
        info.className = 'infobar show error';
        info.textContent = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø£ÙˆÙ„Ù‹Ø§.';
        disableForm(true);
        return;
      }
      precheck(n);
    }

    info.setAttribute('role','status');
    info.setAttribute('aria-live','polite');

    onAuthStateChanged(auth, ()=> kickPrecheck());
    numEl?.addEventListener('change', kickPrecheck);
    numEl?.addEventListener('blur', kickPrecheck);

    /* Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± ÙˆÙ„Ø§Ø¯Ø© Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… */
    async function existsCalvingSameDay(uid, number, dateISO){
      const num = String(number || '').trim();
      const q1 = query(
        collection(db, 'events'),
        where('userId', '==', uid),
        where('animalNumber', '==', num),
        where('eventType', '==', 'ÙˆÙ„Ø§Ø¯Ø©'),
        where('eventDate', '==', dateISO),
        limit(1)
      );
      const snap = await getDocs(q1);
      return !snap.empty;
    }

    /* Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: Ù†Ø·Ù„Ù‚ mbk:valid ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª */
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const uid    = await getUid();
      if (!uid){
        showPopup('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.', false);
        return;
      }

      const number = (numEl?.value || '').trim();
      const evISO  = (dateEl?.value || '').trim();
      if (!number || !evISO){
        showPopup('Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨Ø§Ù†.', false);
        return;
      }

      if (evISO > todayISO()){
        showPopup('ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„.', false);
        return;
      }

      await precheck(number);
      if (info.classList.contains('error')) return;

      if (!form.reportValidity()){
        showPopup('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø«.', false);
        return;
      }

      if (await existsCalvingSameDay(uid, number, evISO)){
        showPopup('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ ÙˆÙ„Ø§Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø­ÙŠÙˆØ§Ù† ÙÙŠ Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®.', false);
        return;
      }

      const formData = {};
      form.querySelectorAll('[data-field]').forEach(el=>{
        const key = el.getAttribute('data-field');
        let val = '';
        if (el.type === 'radio') {
          const chosen = form.querySelector(`input[name="${el.name}"]:checked`);
          val = chosen ? chosen.value : '';
        } else {
          val = (el.value||'').trim();
        }
        formData[key] = val;
      });

      document.dispatchEvent(new CustomEvent('mbk:valid', { detail:{ formData } }));
    });

    /* Ø§Ù„Ø­ÙØ¸ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø­Ø¯Ø« + Ø§Ù„Ø¹Ø¬ÙˆÙ„ */
    document.addEventListener('mbk:valid', async (e)=>{
      const { formData } = e.detail;
      const uid = await getUid();
      if (!uid){ showPopup('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.', false); return; }

      const payload = {
        userId: uid,
        type: 'ÙˆÙ„Ø§Ø¯Ø©',
        eventType: 'ÙˆÙ„Ø§Ø¯Ø©',
        eventDate: (formData.eventDate || '').trim(),
        animalNumber: (formData.animalNumber || '').trim(),
        animalId: (formData.animalId || '').trim(),
        species: formData.species || '',
        reproStatus: formData.reproStatus || 'Ø¹Ø´Ø§Ø±',
        lastFertileInseminationDate: formData.lastFertileInseminationDate || '',
        calvingKind: formData.calvingKind || '',
        calfCount: formData.calfCount || '',
        calf1Sex:  formData.calf1Sex || '',
        calfId:    formData.calfId || '',
        calf2Sex:  formData.calf2Sex || '',
        calf2Id:   formData.calf2Id || '',
        calf3Sex:  formData.calf3Sex || '',
        calf3Id:   formData.calf3Id || '',
        calfFate:  formData.calfFate || '',
        notes:     formData.notes || '',
        idempotencyKey: `${(formData.animalNumber||'').trim()}-ÙˆÙ„Ø§Ø¯Ø©-${(formData.eventDate||'').trim()}`,
        createdAt: serverTimestamp()
      };

           try{
        disableForm(true);

        // 1) Ù†Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø« ÙƒÙ…Ø§ Ù‡Ùˆ (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ)
        await addDoc(collection(db, 'events'), payload);

        // 2) Ù†Ø¨Ø¹ÙØª Ù†Ø³Ø®Ø© "Ù…ÙÙˆØ­Ù‘ÙØ¯Ø©" Ù„Ù…Ø­Ø±Ù‘Ùƒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­ÙŠÙˆØ§Ù†
        const updatePayload = {
          ...payload,
          type: 'calving',      // ğŸ‘ˆ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ‘ÙØ­Ø¯ Ø§Ù„Ù„ÙŠ animal-update.js ÙØ§Ù‡Ù…Ù‡
          eventType: 'calving'  // ğŸ‘ˆ Ù†ÙØ³ Ø§Ù„Ø´ÙŠØ¡ØŒ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù…Ù„Ù ÙŠØ³ØªØ®Ø¯Ù… eventType
        };

        await updateAnimalByEvent(updatePayload);


        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø¬ÙˆÙ„ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© calves
        const damId     = payload.animalId;
        const damNumber = payload.animalNumber;
        const birthDate = payload.eventDate;
        const species   = payload.species;

        const calvesToSave = [];
        const count = parseInt(payload.calfCount || '1',10) || 1;

        const pushCalf = (idx, calfIdField, calfSexField)=>{
          const id  = (formData[calfIdField] || '').trim();
          const sex = (formData[calfSexField] || '').trim();
          if (!id || !sex) return;
          calvesToSave.push({
            userId: uid,
            damId,
            damNumber,
            birthDate,
            calfNumber: id,
            sex,
            species,
            createdAt: serverTimestamp()
          });
        };

        pushCalf(1,'calfId','calf1Sex');
        if (count >= 2) pushCalf(2,'calf2Id','calf2Sex');
        if (count >= 3) pushCalf(3,'calf3Id','calf3Sex');

        for (const calf of calvesToSave){
          await addDoc(collection(db,'calves'), calf);
        }

        showPopup('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø¬ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…', true, ()=>{
          location.href = `/event-list.html?number=${encodeURIComponent(payload.animalNumber)}`;
        });

      }catch(err){
        console.error(err);
        disableForm(false);
        showPopup('ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø« â€“ ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.', false);
      }
    });

    document.getElementById('toCardBtn')?.addEventListener('click', ()=>{
      const num = (numEl?.value || '').trim();
      if (!num){
        showPopup('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø£ÙˆÙ„Ù‹Ø§ Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.', false);
        return;
      }
      location.href = `/cow-card.html?number=${encodeURIComponent(num)}`;
    });
  </script>

</body>
</html>

