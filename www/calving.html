<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© â€” Ù…ÙØ±ÙØ¨Ù‘ÙÙƒ</title>
  <style>
    :root{--green:#0ea05a;--green-600:#0b7f47;--bg:#f7faf7;--text:#0f172a;--muted:#64748b;--card:#ffffff}
    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{margin:0;font-family:'Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .bar{max-width:920px;margin:0 auto;padding:14px 18px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .title{font-weight:700;color:var(--green-600);font-size:18px}
    main{max-width:920px;margin:20px auto;padding:16px;padding-bottom:110px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;padding:20px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .row{display:grid;gap:14px;min-width:0}
    @media(min-width:720px){.row{grid-template-columns:repeat(2,1fr)}}
    label{font-weight:600;font-size:15px;color:#0f172a;display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:16px}
    textarea{min-height:80px;resize:vertical}
    .radio-group{display:flex;flex-wrap:wrap;gap:10px;padding:6px 0}
    .radio-group label{font-weight:500;font-size:14px;background:#f1f5f9;border:1px solid #cbd5e1;border-radius:8px;padding:6px 10px;cursor:pointer;transition:all .2s}
    .radio-group input{margin-inline-start:6px}
    .radio-group label:hover{background:#e2e8f0}
    .actions-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #e2e8f0;box-shadow:0 -2px 6px rgba(0,0,0,.08);display:flex;gap:10px;padding:12px;z-index:20}
    .actions-bar button{flex:1;padding:14px;font-size:16px;font-weight:700;border-radius:12px;cursor:pointer;border:0}
    .actions-bar .save{background:var(--green);color:#fff}
    .actions-bar .ghost{background:#eef2f7;color:#0f172a}

    /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯/Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„ÙƒØ§Ø±Øª */
    .infobar{
      display:none;
      padding:12px;
      border-radius:10px;
      font-size:14px;
      font-weight:700;
      text-align:center;
      max-width:560px;
      margin:16px auto 0;   /* â† ÙŠÙˆØ³Ù‘Ø· Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø£ÙÙ‚ÙŠØ§Ù‹ */
    }
    .infobar.show{display:block}
    .infobar.error{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412}
    .infobar:not(.error){background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
  </style>

  <!-- ğŸ‘‡ Ø­Ù…Ù‘Ù„ Firebase Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø£ÙŠ Ø³ÙƒØ±Ø¨Øª Ø¢Ø®Ø± ÙŠØ³ØªØ®Ø¯Ù…Ù‡ -->
  <script type="module" src="/js/firebase-config.js"></script>
</head>
<body>
  <script>window.dataLayer = window.dataLayer || [];</script>
  <header>
    <div class="bar">
      <div class="title">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</div>
      <a class="ghost" href="add-event.html" style="text-decoration:none;padding:10px 12px;border-radius:10px">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø­Ø¯Ø§Ø«</a>
    </div>
  </header>

  <main>
    <div class="card grid" id="formCard">
      <div class="row">
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
          <input id="animalNumber" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 1023" required />
        </div>
        <div>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</label>
          <input id="eventDate" type="date" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>ÙˆÙ‚Øª Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</label>
          <input id="eventTime" type="time" required />
        </div>
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</label>
          <select id="calvingKind" required>
            <option value="">Ø§Ø®ØªØ±</option>
            <option value="Ø·Ø¨ÙŠØ¹ÙŠØ©">Ø·Ø¨ÙŠØ¹ÙŠØ©</option>
            <option value="Ù…ØªØ¹Ø³Ø±Ø©">Ù…ØªØ¹Ø³Ø±Ø©</option>
            <option value="Ù‚ÙŠØµØ±ÙŠØ©">Ù‚ÙŠØµØ±ÙŠØ©</option>
            <option value="Ù†Ø§ÙÙ‚Ø©">Ù†Ø§ÙÙ‚Ø©</option>
          </select>
        </div>
      </div>

      <div class="row live-only">
        <div>
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</label>
          <div class="radio-group">
            <label><input type="radio" name="calfCount" value="1" required> 1</label>
            <label><input type="radio" name="calfCount" value="2"> 2</label>
            <label><input type="radio" name="calfCount" value="3"> 3</label>
          </div>
        </div>
        <div>
          <label>Ù…ØµÙŠØ± Ø§Ù„Ø¹Ø¬Ù„</label>
          <div class="radio-group">
            <label><input type="radio" name="calfFate" value="ØªØ±Ø¨ÙŠØ©" required> ØªØ±Ø¨ÙŠØ©</label>
            <label><input type="radio" name="calfFate" value="Ø¨ÙŠØ¹"> Ø¨ÙŠØ¹</label>
          </div>
        </div>
      </div>

      <!-- Ù…ÙˆÙ„ÙˆØ¯ (1) -->
      <div class="offspring-group live-only" id="offspring1">
        <label>Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯ (1)</label>
        <div class="row">
          <div>
            <label>Ø¬Ù†Ø³ Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯</label>
            <div class="radio-group">
              <label><input type="radio" name="calf1Sex" value="Ø°ÙƒØ±" required> Ø°ÙƒØ±</label>
              <label><input type="radio" name="calf1Sex" value="Ø£Ù†Ø«Ù‰"> Ø£Ù†Ø«Ù‰</label>
            </div>
          </div>
          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¬Ù„</label>
            <input id="calfId" placeholder="Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ø¬Ù„" required />
          </div>
        </div>
      </div>

      <!-- Ù…ÙˆÙ„ÙˆØ¯ (2) -->
      <div class="offspring-group live-only" id="offspring2" style="display:none">
        <label>Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯ (2)</label>
        <div class="row">
          <div>
            <label>Ø¬Ù†Ø³ Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯</label>
            <div class="radio-group">
              <label><input type="radio" name="calf2Sex" value="Ø°ÙƒØ±"> Ø°ÙƒØ±</label>
              <label><input type="radio" name="calf2Sex" value="Ø£Ù†Ø«Ù‰"> Ø£Ù†Ø«Ù‰</label>
            </div>
          </div>
          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¬Ù„</label>
            <input id="calf2Id" placeholder="Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ø¬Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ" />
          </div>
        </div>
      </div>

      <!-- Ù…ÙˆÙ„ÙˆØ¯ (3) -->
      <div class="offspring-group live-only" id="offspring3" style="display:none">
        <label>Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯ (3)</label>
        <div class="row">
          <div>
            <label>Ø¬Ù†Ø³ Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯</label>
            <div class="radio-group">
              <label><input type="radio" name="calf3Sex" value="Ø°ÙƒØ±"> Ø°ÙƒØ±</label>
              <label><input type="radio" name="calf3Sex" value="Ø£Ù†Ø«Ù‰"> Ø£Ù†Ø«Ù‰</label>
            </div>
          </div>
          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¬Ù„</label>
            <input id="calf3Id" placeholder="Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ø¬Ù„ Ø§Ù„Ø«Ø§Ù„Ø«" />
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input id="notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
        </div>
        <div>
          <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</label>
          <input id="tzView" disabled />
        </div>
      </div>

      <div id="info" class="infobar"></div>
    </div>
  </main>

  <div class="actions-bar">
    <button class="save" id="saveBtn">Ø­ÙØ¸ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© âœ…</button>
    <button class="ghost" id="toCardBtn">ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</button>
  </div>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª (Ø°ÙƒØ§Ø¡/ØªØªØ¨Ø¹) â€” Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© ÙØ§ÙŠØ±Ø¨ÙŠØ² -->
  <script src="/js/app-core.js"></script>
  <script type="module" src="/js/timeline.js"></script>
  <script type="module" src="/js/smart-checks.js"></script>

  <!-- Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© + ÙƒØªØ§Ø¨Ø© ÙØ§ÙŠØ±Ø³ØªÙˆØ± -->
  <script type="module">
    import { db, auth, ensureAuth } from '/js/firebase-config.js';
    import { collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const $ = (id)=>document.getElementById(id);
    const qs=(s)=>document.querySelector(s);
    const qsa=(s)=>Array.from(document.querySelectorAll(s));

    const EVENTS = localStorage.getItem('events_collection') || 'events';
    const CALVES = localStorage.getItem('calves_collection') || 'calves';

    try{ window.dataLayer.push({event:'calving_form_view'}); }catch{}

    function val(name){ const el = qs(`[name="${name}"]:checked`); return el ? el.value : ''; }
    function showMsg(text,isError){
      const el = $('info');
      el.className = 'infobar ' + (isError ? 'show error' : 'show');
      el.textContent = text;
      try{ el.scrollIntoView({behavior:'smooth', block:'center'}); }catch{}
    }

    function getPreferredTZ(){
      const p = new URLSearchParams(location.search);
      return p.get('tz') || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
    }
    function partsNow(tz){
      const d = new Date();
      const parts = new Intl.DateTimeFormat('en-GB', {
        timeZone: tz, hour12:false,
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit'
      }).formatToParts(d).reduce((acc, p)=> (acc[p.type]=p.value, acc), {});
      return { y:parts.year, m:parts.month, d:parts.day, hh:parts.hour, mm:parts.minute };
    }
    function pad(n){ return String(n).padStart(2,'0'); }

    (function hydrate(){
      const tz = getPreferredTZ();
      $('tzView').value = tz;

      const p = new URLSearchParams(location.search);
      const num  = p.get('number') || p.get('animalNumber') || '';
      if(num) $('animalNumber').value = num;

      const r = partsNow(tz);
      const defDate = `${r.y}-${r.m}-${r.d}`;
      const defTime = `${pad(r.hh)}:${pad(r.mm)}`;

      $('eventDate').value = p.get('date') || defDate;
      $('eventTime').value = p.get('time') || defTime;
    })();

    ['animalNumber','eventDate','eventTime','calvingKind','notes'].forEach(id=>{
      const el = $(id);
      el?.addEventListener('change', ()=>{
        try{ window.dataLayer.push({event:'calving_field_change', field:id, value: el.value}); }catch{}
      });
    });
    qsa('[name="calfCount"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        try{ window.dataLayer.push({event:'calf_count_change', value:r.value}); }catch{}
      });
    });

    function updateOffspringUI(){
      const c = val('calfCount');
      $('offspring2').style.display = (c==='2'||c==='3') ? '' : 'none';
      $('offspring3').style.display = (c==='3') ? '' : 'none';
    }
    function disableGroup(name,disabled){ qsa(`[name="${name}"]`).forEach(r=>{ r.disabled=disabled; if(disabled) r.checked=false; }); }
    function disableInputs(selector,disabled){ qsa(selector).forEach(el=>{ el.disabled=disabled; if(disabled&&'value' in el) el.value=''; }); }
    function updateModeUI(){
      const k=$('calvingKind').value, dead=(k==='Ù†Ø§ÙÙ‚Ø©');
      qsa('.live-only').forEach(el=> el.style.display = dead ? 'none' : '');
      ['calfCount','calf1Sex','calf2Sex','calf3Sex','calfFate'].forEach(n=>disableGroup(n,dead));
      disableInputs('#calfId,#calf2Id,#calf3Id',dead);
      if(dead){ qsa('[name="calfCount"]').forEach(r=> r.checked=false); }
      updateOffspringUI();
    }
    qsa('[name="calfCount"]').forEach(r=> r.addEventListener('change', updateOffspringUI));
    $('calvingKind').addEventListener('change', updateModeUI);
    updateModeUI();

    $('toCardBtn').addEventListener('click', ()=>{
      const n = ($('animalNumber').value || '').trim();
      if(!n){ showMsg('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø£ÙˆÙ„Ù‹Ø§', true); return; }
      location.href = `cow-card.html?number=${encodeURIComponent(n)}`;
    });

    $('saveBtn').addEventListener('click', onSave);

    async function onSave(){
      const btn=$('saveBtn');
      const restore=()=>{ btn.disabled=false; btn.textContent='Ø­ÙØ¸ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© âœ…'; };

      try{ window.dataLayer.push({ event:'calving_save_attempt' }); }catch{}

      try{
        btn.disabled=true; btn.textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦';

        const animalNumber = $('animalNumber').value.trim();
        const eventDate    = $('eventDate').value;
        const eventTime    = $('eventTime').value;
        const calvingKind  = $('calvingKind').value;

        if(!animalNumber){ showMsg('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†',true); return restore(); }
        if(!eventDate)   { showMsg('Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©',true); return restore(); }
        if(!eventTime)   { showMsg('Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©',true); return restore(); }
        if(!calvingKind) { showMsg('Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©',true); return restore(); }

        const dead  = (calvingKind === 'Ù†Ø§ÙÙ‚Ø©');
        const count = dead ? 0 : Number(val('calfCount'));
        if(!dead && !count){ showMsg('Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯',true); return restore(); }

        const calves = [];
        if(!dead){
          const fate = val('calfFate'); if(!fate){ showMsg('Ø§Ø®ØªØ± Ù…ØµÙŠØ± Ø§Ù„Ø¹Ø¬Ù„',true); return restore(); }
          const sex1 = val('calf1Sex'); const id1 = $('calfId').value.trim();
          if(!sex1 || !id1){ showMsg('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯ (1)',true); return restore(); }
          calves.push({number:id1, sex:sex1, fate});
          if(count>=2){
            const sex2 = val('calf2Sex'); const id2 = $('calf2Id').value.trim();
            if(!sex2 || !id2){ showMsg('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯ (2)',true); return restore(); }
            calves.push({number:id2, sex:sex2, fate});
          }
          if(count>=3){
            const sex3 = val('calf3Sex'); const id3 = $('calf3Id').value.trim();
            if(!sex3 || !id3){ showMsg('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯ (3)',true); return restore(); }
            calves.push({number:id3, sex:sex3, fate});
          }
        }

        const tz = getPreferredTZ();

        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ù…Ø¹ ØªØ­ÙˆÙŠÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ùˆ Ù…Ø´ Ù…ÙˆÙ‚Ù‘Ø¹)
        await ensureAuth('/login.html');
        const uid = auth?.currentUser?.uid || localStorage.getItem('userId') || localStorage.getItem('tenantId') || null;

        const evRef = await addDoc(collection(db, EVENTS), {
          type:'ÙˆÙ„Ø§Ø¯Ø©',
          eventType:'calving',
          eventDate,
          eventTime,
          eventTZ: tz,
          animalNumber,
          calvingKind,
          calfCount: count,
          notes: ($('notes').value.trim() || null),
          uid,
          source: location.pathname,
          createdAt: serverTimestamp()
        });

        for(const c of calves){
          await addDoc(collection(db, CALVES), {
            number: c.number,
            sex: c.sex,
            fate: c.fate,
            birthDate: eventDate,
            birthTime: eventTime,
            birthTZ: tz,
            damNumber: animalNumber,
            eventId: evRef.id,
            uid,
            source: location.pathname,
            createdAt: serverTimestamp()
          });
        }

        try { window.dataLayer.push({event:'calving_save_success', animalNumber, calvingKind, calfCount:count, dead, tz}); } catch {}

        showMsg('âœ… ØªÙ… Ø­ÙØ¸ Ø­Ø¯Ø« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© ÙˆØ§Ù„Ø¹Ø¬ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', false);
        btn.textContent='ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“';
        setTimeout(()=>{ location.href='dashboard.html'; }, 1200);

      }catch(err){
        console.error(err);
        showMsg('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ²', true);
        try { window.dataLayer.push({ event:'calving_save_error', error:String(err && err.message || err) }); } catch {}
        restore();
      }
    }
  </script>
</body>
</html>
