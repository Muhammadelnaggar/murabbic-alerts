<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>الأمراض</title>
  <style>
    body{direction:rtl;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f9f9f9;padding:20px;margin:0}
    h2{text-align:center;color:#2c3e50;font-size:24px;margin-bottom:20px}
    form{display:flex;flex-direction:column;gap:15px;max-width:720px;margin:auto}
    label{font-weight:bold;font-size:18px}
    input,button{padding:14px;border-radius:8px;border:1px solid #ccc;font-size:18px;width:100%;box-sizing:border-box}
    .disease-buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .disease-buttons button{background:#8bc34a;color:#000;border:none;cursor:pointer;font-size:18px;padding:16px;display:flex;align-items:center;justify-content:center;gap:8px;transition:background-color .3s}
    .disease-buttons button:hover{background:#7cb342}
    #msg{margin-top:12px;font-weight:bold;text-align:center;font-size:16px;display:none;padding:10px;border-radius:8px}
    #msg.success{background:#d1e7dd;color:#0f5132;display:block}
    #msg.error{background:#f8d7da;color:#842029;display:block}
    .actions{display:none;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}
    .actions .btn{padding:10px 14px;border-radius:8px;border:1px solid #2c3e50;background:#fff;color:#2c3e50;font-weight:bold;cursor:pointer}
    .actions .btn.primary{background:#2c3e50;color:#fff;border-color:#2c3e50}
  </style>
</head>
<body>

  <h2>🧪 تسجيل الأمراض</h2>

  <form id="diseaseForm" onsubmit="return false">
    <label for="animalId">رقم الحيوان</label>
    <input type="text" id="animalId" name="animalId" readonly />

    <label for="diseaseDate">تاريخ التشخيص</label>
    <input type="date" id="diseaseDate" name="diseaseDate" required />

    <label>اختر المرض</label>
    <div class="disease-buttons" id="diseaseButtons">
      <button type="button" data-name="التهاب ضرع">التهاب ضرع</button>
      <button type="button" data-name="التهاب رئوي">التهاب رئوي</button>
      <button type="button" data-name="عرج">عرج</button>
      <button type="button" data-name="اسهال">اسهال</button>
      <button type="button" data-name="التهاب سرة">التهاب سرة</button>
      <button type="button" data-name="انقلاب منفحة">انقلاب منفحة</button>
      <button type="button" data-name="ابتلاع جسم معدني">ابتلاع جسم معدني</button>
      <button type="button" data-name="التهاب جلد عقدي">التهاب جلد عقدي</button>
      <button type="button" data-name="حمي قلاعية">حمي قلاعية</button>
      <button type="button" data-name="حمي الثلاث ايام">حمي الثلاث ايام</button>
      <button type="button" data-name="تسمم دموي">تسمم دموي</button>
      <button type="button" data-name="لكمة كرش">لكمة كرش</button>
      <button type="button" data-name="اجهاد حراري">اجهاد حراري</button>
      <button type="button" data-name="التهاب العين">التهاب العين</button>
      <button type="button" data-name="طفيليات دم">طفيليات دم</button>
      <button type="button" data-name="حمي اللبن">حمي اللبن</button>
      <button type="button" data-name="نقص ماغنسيوم">نقص ماغنسيوم</button>
      <button type="button" data-name="نقص فوسفور">نقص فوسفور</button>
    </div>

    <div id="msg"></div>
    <div class="actions" id="afterSave">
      <button type="button" class="btn" id="btnClear">تسجيل مرض آخر</button>
      <button type="button" class="btn primary" id="btnDash">لوحة التحكم</button>
    </div>
  </form>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0dtFS3R-MQ-LJfd_dB1YOTxiwDVshIYc",
    authDomain: "murabbik.firebaseapp.com",
    projectId: "murabbik",
    storageBucket: "murabbik.appspot.com",
    messagingSenderId: "402719243568",
    appId: "1:402719243568:web:631114a260d23202dd5cf5"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const msgDiv = document.getElementById("msg");
  const actionsBox = document.getElementById("afterSave");
  const btnClear   = document.getElementById("btnClear");
  const btnDash    = document.getElementById("btnDash");

  const animalIdInput    = document.getElementById("animalId");
  const diseaseDateInput = document.getElementById("diseaseDate");
  const container        = document.getElementById("diseaseButtons");

  // اليوم المحلي بصيغة YYYY-MM-DD
  function todayLocal(){
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  }

  // تعبئة من الرابط أو التخزين المحلي
  (function hydrate(){
    const qp = new URLSearchParams(location.search);
    const preId   = qp.get("animalId") || qp.get("number") || localStorage.getItem("lastAnimalId");
    const preDate = qp.get("date") || todayLocal();
    if (!preId){
      alert("❗ لم يتم تحديد الحيوان، سيتم تحويلك لتسجيل حيوان جديد");
      location.href = "add-animal.html";
      return;
    }
    animalIdInput.value    = preId;
    diseaseDateInput.value = preDate;
  })();

  function showMsg(text, type="success"){
    msgDiv.textContent = text;
    msgDiv.className = type === "success" ? "success" : "error";
    msgDiv.style.display = "block";
    actionsBox.style.display = type === "success" ? "flex" : "none";
  }
  function clearMsg(){
    msgDiv.textContent = "";
    msgDiv.style.display = "none";
    actionsBox.style.display = "none";
  }

  btnClear.addEventListener('click', clearMsg);
  btnDash.addEventListener('click', ()=> location.href='dashboard.html');

  // تفويض الحدث لكل الأزرار
  container.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button[data-name]');
    if (!btn) return;

    const animalId   = (animalIdInput.value || "").trim();
    const diseaseDate= diseaseDateInput.value;

    if (!animalId || !diseaseDate){
      showMsg("يرجى إدخال رقم الحيوان وتاريخ التشخيص أولاً","error");
      return;
    }

    const name = btn.dataset.name;

    // الحالات الخاصة: فتح صفحات مخصصة وتمرير الرقم والتاريخ
    if (name === "التهاب ضرع"){
      location.href = `mastitis.html?animalId=${encodeURIComponent(animalId)}&date=${encodeURIComponent(diseaseDate)}`;
      return;
    }
    if (name === "عرج"){
      location.href = `lameness.html?animalId=${encodeURIComponent(animalId)}&date=${encodeURIComponent(diseaseDate)}`;
      return;
    }

    // تعطيل كل الأزرار أثناء الحفظ
    const all = container.querySelectorAll('button');
    all.forEach(b=> b.disabled = true);

    const eventData = {
      animalId,
      animalNumber: animalId,
      eventDate: diseaseDate,
      eventType: name,
      type: "مرض",
      isSmartAlert: true,
      alertRule: "مرض",
      createdAt: serverTimestamp()
    };

    try{
      await addDoc(collection(db,"events"), eventData);
      showMsg(`✅ تم تسجيل مرض "${name}" بنجاح`);
    }catch(err){
      console.error("خطأ في تسجيل المرض:", err);
      showMsg("❌ حدث خطأ أثناء التسجيل، حاول مرة أخرى.","error");
    }finally{
      all.forEach(b=> b.disabled = false);
    }
  });
</script>

</body>
</html>
