<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ø£Ù…Ø±Ø§Ø¶</title>
  <style>
    body{direction:rtl;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f9f9f9;padding:20px;margin:0}
    h2{text-align:center;color:#2c3e50;font-size:24px;margin-bottom:20px}
    form{display:flex;flex-direction:column;gap:15px;max-width:720px;margin:auto}
    label{font-weight:bold;font-size:18px}
    input,button{padding:14px;border-radius:8px;border:1px solid #ccc;font-size:18px;width:100%;box-sizing:border-box}
    .disease-buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .disease-buttons button{background:#8bc34a;color:#000;border:none;cursor:pointer;font-size:18px;padding:16px;display:flex;align-items:center;justify-content:center;gap:8px;transition:background-color .3s}
    .disease-buttons button:hover{background:#7cb342}
    #msg{margin-top:12px;font-weight:bold;text-align:center;font-size:16px;display:none;padding:10px;border-radius:8px}
    #msg.success{background:#d1e7dd;color:#0f5132;display:block}
    #msg.error{background:#f8d7da;color:#842029;display:block}
    .actions{display:none;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}
    .actions .btn{padding:10px 14px;border-radius:8px;border:1px solid #2c3e50;background:#fff;color:#2c3e50;font-weight:bold;cursor:pointer}
    .actions .btn.primary{background:#2c3e50;color:#fff;border-color:#2c3e50}
  </style>
</head>
<body>

  <h2>ğŸ§ª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶</h2>

  <form id="diseaseForm" onsubmit="return false">
    <label for="animalId">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
    <input type="text" id="animalId" name="animalId" readonly />

    <label for="diseaseDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ´Ø®ÙŠØµ</label>
    <input type="date" id="diseaseDate" name="diseaseDate" required />

    <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø¶</label>
    <div class="disease-buttons" id="diseaseButtons">
      <button type="button" data-name="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¶Ø±Ø¹">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¶Ø±Ø¹</button>
      <button type="button" data-name="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ</button>
      <button type="button" data-name="Ø¹Ø±Ø¬">Ø¹Ø±Ø¬</button>
      <button type="button" data-name="Ø§Ø³Ù‡Ø§Ù„">Ø§Ø³Ù‡Ø§Ù„</button>
      <button type="button" data-name="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø³Ø±Ø©">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø³Ø±Ø©</button>
      <button type="button" data-name="Ø§Ù†Ù‚Ù„Ø§Ø¨ Ù…Ù†ÙØ­Ø©">Ø§Ù†Ù‚Ù„Ø§Ø¨ Ù…Ù†ÙØ­Ø©</button>
      <button type="button" data-name="Ø§Ø¨ØªÙ„Ø§Ø¹ Ø¬Ø³Ù… Ù…Ø¹Ø¯Ù†ÙŠ">Ø§Ø¨ØªÙ„Ø§Ø¹ Ø¬Ø³Ù… Ù…Ø¹Ø¯Ù†ÙŠ</button>
      <button type="button" data-name="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¬Ù„Ø¯ Ø¹Ù‚Ø¯ÙŠ">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¬Ù„Ø¯ Ø¹Ù‚Ø¯ÙŠ</button>
      <button type="button" data-name="Ø­Ù…ÙŠ Ù‚Ù„Ø§Ø¹ÙŠØ©">Ø­Ù…ÙŠ Ù‚Ù„Ø§Ø¹ÙŠØ©</button>
      <button type="button" data-name="Ø­Ù…ÙŠ Ø§Ù„Ø«Ù„Ø§Ø« Ø§ÙŠØ§Ù…">Ø­Ù…ÙŠ Ø§Ù„Ø«Ù„Ø§Ø« Ø§ÙŠØ§Ù…</button>
      <button type="button" data-name="ØªØ³Ù…Ù… Ø¯Ù…ÙˆÙŠ">ØªØ³Ù…Ù… Ø¯Ù…ÙˆÙŠ</button>
      <button type="button" data-name="Ù„ÙƒÙ…Ø© ÙƒØ±Ø´">Ù„ÙƒÙ…Ø© ÙƒØ±Ø´</button>
      <button type="button" data-name="Ø§Ø¬Ù‡Ø§Ø¯ Ø­Ø±Ø§Ø±ÙŠ">Ø§Ø¬Ù‡Ø§Ø¯ Ø­Ø±Ø§Ø±ÙŠ</button>
      <button type="button" data-name="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø¹ÙŠÙ†">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø¹ÙŠÙ†</button>
      <button type="button" data-name="Ø·ÙÙŠÙ„ÙŠØ§Øª Ø¯Ù…">Ø·ÙÙŠÙ„ÙŠØ§Øª Ø¯Ù…</button>
      <button type="button" data-name="Ø­Ù…ÙŠ Ø§Ù„Ù„Ø¨Ù†">Ø­Ù…ÙŠ Ø§Ù„Ù„Ø¨Ù†</button>
      <button type="button" data-name="Ù†Ù‚Øµ Ù…Ø§ØºÙ†Ø³ÙŠÙˆÙ…">Ù†Ù‚Øµ Ù…Ø§ØºÙ†Ø³ÙŠÙˆÙ…</button>
      <button type="button" data-name="Ù†Ù‚Øµ ÙÙˆØ³ÙÙˆØ±">Ù†Ù‚Øµ ÙÙˆØ³ÙÙˆØ±</button>
    </div>

    <div id="msg"></div>
    <div class="actions" id="afterSave">
      <button type="button" class="btn" id="btnClear">ØªØ³Ø¬ÙŠÙ„ Ù…Ø±Ø¶ Ø¢Ø®Ø±</button>
      <button type="button" class="btn primary" id="btnDash">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    </div>
  </form>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0dtFS3R-MQ-LJfd_dB1YOTxiwDVshIYc",
    authDomain: "murabbik.firebaseapp.com",
    projectId: "murabbik",
    storageBucket: "murabbik.appspot.com",
    messagingSenderId: "402719243568",
    appId: "1:402719243568:web:631114a260d23202dd5cf5"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const msgDiv = document.getElementById("msg");
  const actionsBox = document.getElementById("afterSave");
  const btnClear   = document.getElementById("btnClear");
  const btnDash    = document.getElementById("btnDash");

  const animalIdInput    = document.getElementById("animalId");
  const diseaseDateInput = document.getElementById("diseaseDate");
  const container        = document.getElementById("diseaseButtons");

  // Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨ØµÙŠØºØ© YYYY-MM-DD
  function todayLocal(){
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  }

  // ØªØ¹Ø¨Ø¦Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
  (function hydrate(){
    const qp = new URLSearchParams(location.search);
    const preId   = qp.get("animalId") || qp.get("number") || localStorage.getItem("lastAnimalId");
    const preDate = qp.get("date") || todayLocal();
    if (!preId){
      alert("â— Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŒ Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„ØªØ³Ø¬ÙŠÙ„ Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯");
      location.href = "add-animal.html";
      return;
    }
    animalIdInput.value    = preId;
    diseaseDateInput.value = preDate;
  })();

  function showMsg(text, type="success"){
    msgDiv.textContent = text;
    msgDiv.className = type === "success" ? "success" : "error";
    msgDiv.style.display = "block";
    actionsBox.style.display = type === "success" ? "flex" : "none";
  }
  function clearMsg(){
    msgDiv.textContent = "";
    msgDiv.style.display = "none";
    actionsBox.style.display = "none";
  }

  btnClear.addEventListener('click', clearMsg);
  btnDash.addEventListener('click', ()=> location.href='dashboard.html');

  // ØªÙÙˆÙŠØ¶ Ø§Ù„Ø­Ø¯Ø« Ù„ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  container.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button[data-name]');
    if (!btn) return;

    const animalId   = (animalIdInput.value || "").trim();
    const diseaseDate= diseaseDateInput.value;

    if (!animalId || !diseaseDate){
      showMsg("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ´Ø®ÙŠØµ Ø£ÙˆÙ„Ø§Ù‹","error");
      return;
    }

    const name = btn.dataset.name;

    // Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ©: ÙØªØ­ ØµÙØ­Ø§Øª Ù…Ø®ØµØµØ© ÙˆØªÙ…Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
    if (name === "Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¶Ø±Ø¹"){
      location.href = `mastitis.html?animalId=${encodeURIComponent(animalId)}&date=${encodeURIComponent(diseaseDate)}`;
      return;
    }
    if (name === "Ø¹Ø±Ø¬"){
      location.href = `lameness.html?animalId=${encodeURIComponent(animalId)}&date=${encodeURIComponent(diseaseDate)}`;
      return;
    }

    // ØªØ¹Ø·ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸
    const all = container.querySelectorAll('button');
    all.forEach(b=> b.disabled = true);

    const eventData = {
      animalId,
      animalNumber: animalId,
      eventDate: diseaseDate,
      eventType: name,
      type: "Ù…Ø±Ø¶",
      isSmartAlert: true,
      alertRule: "Ù…Ø±Ø¶",
      createdAt: serverTimestamp()
    };

    try{
      await addDoc(collection(db,"events"), eventData);
      showMsg(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø±Ø¶ "${name}" Ø¨Ù†Ø¬Ø§Ø­`);
    }catch(err){
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶:", err);
      showMsg("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.","error");
    }finally{
      all.forEach(b=> b.disabled = false);
    }
  });
</script>

</body>
</html>
