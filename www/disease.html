<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ø£Ù…Ø±Ø§Ø¶</title>
  <style>
    body{direction:rtl;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f9f9f9;padding:20px;margin:0}
    h2{text-align:center;color:#2c3e50;font-size:24px;margin-bottom:20px}
    form{display:flex;flex-direction:column;gap:15px}
    label{font-weight:bold;font-size:18px}
    input,button{padding:14px;border-radius:8px;border:1px solid #ccc;font-size:18px;width:100%;box-sizing:border-box}
    .disease-buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .disease-buttons button{background:#8bc34a;color:black;border:none;cursor:pointer;font-size:18px;padding:16px;display:flex;align-items:center;justify-content:center;gap:8px;transition:background-color .3s}
    .disease-buttons button.selected{border:2px solid #2c3e50;background:#558b2f;color:#fff}
    #msg{margin-top:20px;font-weight:bold;text-align:center;font-size:18px;display:none;padding:10px;border-radius:8px}
    #msg.success{background:#d1e7dd;color:#0f5132;display:block}
    #msg.error{background:#f8d7da;color:#842029;display:block}
  </style>
</head>
<body>

  <h2>ğŸ§ª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶</h2>

  <form id="diseaseForm">
    <label for="animalId">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
    <input type="text" id="animalId" name="animalId" readonly />

    <label for="diseaseDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ´Ø®ÙŠØµ</label>
    <input type="date" id="diseaseDate" name="diseaseDate" required />

    <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø¶</label>
    <div class="disease-buttons" id="diseaseButtons">
      <button type="button" data-name="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¶Ø±Ø¹">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¶Ø±Ø¹</button>
      <button type="button" data-name="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ</button>
      <button type="button" data-name="Ø¹Ø±Ø¬">Ø¹Ø±Ø¬</button>
      <button type="button" data-name="Ø§Ø³Ù‡Ø§Ù„">Ø§Ø³Ù‡Ø§Ù„</button>
      <button type="button" data-name="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø³Ø±Ø©">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø³Ø±Ø©</button>
      <button type="button" data-name="Ø§Ù†Ù‚Ù„Ø§Ø¨ Ù…Ù†ÙØ­Ø©">Ø§Ù†Ù‚Ù„Ø§Ø¨ Ù…Ù†ÙØ­Ø©</button>
      <button type="button" data-name="Ø§Ø¨ØªÙ„Ø§Ø¹ Ø¬Ø³Ù… Ù…Ø¹Ø¯Ù†ÙŠ">Ø§Ø¨ØªÙ„Ø§Ø¹ Ø¬Ø³Ù… Ù…Ø¹Ø¯Ù†ÙŠ</button>
      <button type="button" data-name="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¬Ù„Ø¯ Ø¹Ù‚Ø¯ÙŠ">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¬Ù„Ø¯ Ø¹Ù‚Ø¯ÙŠ</button>
      <button type="button" data-name="Ø­Ù…ÙŠ Ù‚Ù„Ø§Ø¹ÙŠØ©">Ø­Ù…ÙŠ Ù‚Ù„Ø§Ø¹ÙŠØ©</button>
      <button type="button" data-name="Ø­Ù…Ù„ Ø§Ù„Ø«Ù„Ø§Ø« Ø§ÙŠØ§Ù…">Ø­Ù…Ù„ Ø§Ù„Ø«Ù„Ø§Ø« Ø§ÙŠØ§Ù…</button>
      <button type="button" data-name="ØªØ³Ù…Ù… Ø¯Ù…ÙˆÙŠ">ØªØ³Ù…Ù… Ø¯Ù…ÙˆÙŠ</button>
      <button type="button" data-name="Ù„ÙƒÙ…Ø© ÙƒØ±Ø´">Ù„ÙƒÙ…Ø© ÙƒØ±Ø´</button>
      <button type="button" data-name="Ø§Ø¬Ù‡Ø§Ø¯ Ø­Ø±Ø§Ø±ÙŠ">Ø§Ø¬Ù‡Ø§Ø¯ Ø­Ø±Ø§Ø±ÙŠ</button>
      <button type="button" data-name="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø¹ÙŠÙ†">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø¹ÙŠÙ†</button>
      <button type="button" data-name="Ø·ÙÙŠÙ„ÙŠØ§Øª Ø¯Ù…">Ø·ÙÙŠÙ„ÙŠØ§Øª Ø¯Ù…</button>
      <button type="button" data-name="Ø­Ù…ÙŠ Ø§Ù„Ù„Ø¨Ù†">Ø­Ù…ÙŠ Ø§Ù„Ù„Ø¨Ù†</button>
      <button type="button" data-name="Ù†Ù‚Øµ Ù…Ø§ØºÙ†Ø³ÙŠÙˆÙ…">Ù†Ù‚Øµ Ù…Ø§ØºÙ†Ø³ÙŠÙˆÙ…</button>
      <button type="button" data-name="Ù†Ù‚Øµ ÙÙˆØ³ÙÙˆØ±">Ù†Ù‚Øµ ÙÙˆØ³ÙÙˆØ±</button>
    </div>
  </form>

  <div id="msg"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // âœ… ØµÙØ­Ø© Ù…Ø³ØªÙ‚Ù„Ø© (Ø­Ø³Ø¨ Ø£Ø³Ù„ÙˆØ¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: Ø³ÙƒØ±Ø¨Øª Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ ØµÙØ­Ø©)
  const firebaseConfig = {
    apiKey: "AIzaSyB0dtFS3R-MQ-LJfd_dB1YOTxiwDVshIYc",
    authDomain: "murabbik.firebaseapp.com",
    projectId: "murabbik",
    storageBucket: "murabbik.appspot.com",
    messagingSenderId: "402719243568",
    appId: "1:402719243568:web:631114a260d23202dd5cf5"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const msgDiv = document.getElementById("msg");
  const btnWrap = document.getElementById("diseaseButtons");
  const animalIdInput   = document.getElementById("animalId");
  const diseaseDateInput= document.getElementById("diseaseDate");

  // ğŸ”¹ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨ØµÙŠØºØ© YYYY-MM-DD (Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©)
  function todayLocal(){
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  }

  // ğŸ”¹ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø³ÙŠØ§Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ localStorage
  (function hydrate(){
    const qp = new URLSearchParams(location.search);
    const presetId   = qp.get("animalId") || qp.get("number") || qp.get("animalNumber") || localStorage.getItem("lastAnimalId") || "";
    const presetDate = qp.get("date")     || todayLocal();
    animalIdInput.value    = presetId;
    diseaseDateInput.value = presetDate;

    if (!presetId){
      alert("â— Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­ÙŠÙˆØ§Ù†.\nØ³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø£ÙˆÙ„Ù‹Ø§.");
      location.href = "add-event.html";
    }
  })();

  function showMsg(text, type="success"){
    msgDiv.textContent = text;
    msgDiv.className = type === "success" ? "success" : "error";
    msgDiv.style.display = "block";
  }

  function disableAll(disabled=true){
    btnWrap.querySelectorAll('button').forEach(b => b.disabled = disabled);
  }

  // ğŸ”¹ ØªÙÙˆÙŠØ¶ Ø­Ø¯Ø« ÙŠØºØ·ÙŠ ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  btnWrap.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;

    const animalId = (animalIdInput.value||"").trim();
    const diseaseDate = (diseaseDateInput.value||"").trim();
    const diseaseName = btn.dataset.name;
    if(!animalId || !diseaseDate){
      alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ´Ø®ÙŠØµ Ø£ÙˆÙ„Ù‹Ø§");
      return;
    }

    // âœ… Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ©: Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø§ØªÙ‡Ø§ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ ÙÙˆØ±ÙŠ
    if (diseaseName === "Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¶Ø±Ø¹"){
      location.href = `mastitis.html?animalId=${encodeURIComponent(animalId)}&date=${encodeURIComponent(diseaseDate)}`;
      return;
    }
    if (diseaseName === "Ø¹Ø±Ø¬"){
      location.href = `lameness.html?animalId=${encodeURIComponent(animalId)}&date=${encodeURIComponent(diseaseDate)}`;
      return;
    }

    // âœ… Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶: ØªØ³Ø¬ÙŠÙ„ ÙÙˆØ±ÙŠ ÙÙŠ events
    try{
      disableAll(true);
      msgDiv.style.display = "none";

      const userId = localStorage.getItem("userId") || null;
      // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø³ÙŠØ§Ù‚
      localStorage.setItem("lastAnimalId", animalId);

      const eventData = {
        userId,                 // Ø±Ø¨Ø· Ø¨Ø§Ù„Ù…Ø§Ù„Ùƒ
        animalId,               // Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†
        animalNumber: animalId, // ØªÙˆØ§ÙÙ‚
        eventDate: diseaseDate, // Ø§Ù„ØªØ§Ø±ÙŠØ®
        eventType: diseaseName, // Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø¶
        type: "Ù…Ø±Ø¶",            // ØªØµÙ†ÙŠÙ
        isSmartAlert: true,     // Ù„Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§
        alertRule: "Ù…Ø±Ø¶",
        createdAt: serverTimestamp()
      };

      await addDoc(collection(db, "events"), eventData);

      showMsg(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø±Ø¶ "${diseaseName}" Ø¨Ù†Ø¬Ø§Ø­`, "success");

      // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: Ù†ÙØªØ­ ØµÙØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬
      setTimeout(()=>{
        location.href = `treatment-followup.html?animalId=${encodeURIComponent(animalId)}&date=${encodeURIComponent(diseaseDate)}&disease=${encodeURIComponent(diseaseName)}`;
      }, 1200);

    }catch(err){
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶:", err);
      showMsg("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
      disableAll(false);
    }
  });
</script>

</body>
</html>
