<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>تسجيل أمراض — مُرَبِّك</title>
  <style>
    :root{
      --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a;
      --muted:#64748b; --card:#ffffff; --border:#e2e8f0; --warn:#c2410c
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--border)}
    .bar{max-width:920px;margin:0 auto;padding:12px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .title{font-weight:800;color:var(--green-600)}
    main{max-width:920px;margin:16px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;padding:14px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.row{grid-template-columns:repeat(3,1fr)}}
    label{font-weight:700;font-size:14px;color:#0f172a}
    input,select{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:15px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--green);color:#fff}
    .btn.ghost{background:#eef2f7;color:#0f172a}
    .pill{display:inline-block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46;border-radius:999px;padding:3px 10px;font-size:12px;font-weight:800}

    /* لوحة الأمراض كأزرار تحفظ مباشرة */
    .diseases{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.diseases{grid-template-columns:repeat(3,1fr)}}
    .dis-btn{padding:14px;border:1px solid var(--border);background:#fff;border-radius:14px;cursor:pointer;text-align:center;font-weight:800}
    .dis-btn:hover{background:#f8fffb}
    .dis-btn[disabled]{opacity:.5;cursor:not-allowed}

    /* شريط الرسالة */
    .infobar{display:none;margin-top:10px;padding:12px;border-radius:12px;font-weight:800;text-align:center}
    .infobar.show{display:block}
    .infobar.ok{background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .infobar.err{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412}

    .nav-links{display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap}
    .nav-links a{padding:10px 12px;border-radius:10px;text-decoration:none;border:1px solid var(--border);background:#fff}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">تسجيل أمراض <span class="pill">مُرَبِّك</span></div>
      <a class="ghost" href="dashboard.html" style="text-decoration:none;padding:10px 12px;border-radius:10px">لوحة التحكم</a>
    </div>
  </header>

  <main>
    <div class="card grid">
      <div class="row">
        <div>
          <label>رقم الحيوان <span style="color:#dc2626">*</span></label>
          <input id="animalNumber" inputmode="numeric" placeholder="مثال: 1023" required />
        </div>
        <div>
          <label>تاريخ التشخيص <span style="color:#dc2626">*</span></label>
          <input id="eventDate" type="date" required />
        </div>
        <div>
          <label>ملاحظات (اختياري)</label>
          <input id="notes" placeholder="اختياري" />
        </div>
      </div>
    </div>

    <div class="card grid">
      <div style="font-weight:800;color:#0b7f47">اختر المرض (يتم الحفظ فورًا ما عدا الضرع/العرج):</div>
      <div class="diseases">
        <!-- أمراض تُحفظ مباشرة -->
        <button class="dis-btn" data-code="metritis" data-type="التهاب رحم">التهاب رحم</button>
        <button class="dis-btn" data-code="retained_placenta" data-type="احتباس مشيمة">احتباس مشيمة</button>
        <button class="dis-btn" data-code="ketosis" data-type="كيتوزيس">كيتوزيس</button>
        <button class="dis-btn" data-code="milk_fever" data-type="حمى اللبن">حمى اللبن</button>
        <button class="dis-btn" data-code="pneumonia" data-type="التهاب رئة">التهاب رئة</button>
        <button class="dis-btn" data-code="diarrhea" data-type="إسهال">إسهال</button>
        <button class="dis-btn" data-code="bloat" data-type="نفاخ">نفاخ</button>
        <button class="dis-btn" data-code="parasitic" data-type="طفيليات">طفيليات</button>
        <button class="dis-btn" data-code="injury" data-type="إصابة/جرح">إصابة / جرح</button>

        <!-- يستثنى: يفتح صفحاتهم -->
        <button class="dis-btn" data-open="mastitis.html">التهاب الضرع (صفحة خاصة)</button>
        <button class="dis-btn" data-open="lameness.html">العرج (صفحة خاصة)</button>
      </div>

      <div id="info" class="infobar"></div>
      <div class="nav-links" id="afterLinks" style="display:none">
        <a id="openEvents" href="#">فتح صفحة الأحداث</a>
        <a href="dashboard.html">الانتقال للوحة التحكم</a>
      </div>
    </div>
  </main>

  <!-- تتبع بسيط -->
  <script>
    (function(){
      window.dataLayer = window.dataLayer || [];
      window.t = window.t || { event:(name,p={})=>{ try{ dataLayer.push({event:name, ts:Date.now(), ...p}); }catch{} } };
      t.event('page_view', { page: location.pathname, feature:'diseases' });
    })();
  </script>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { db, auth, ensureAuth } from '/js/firebase-config.js';
    import { addDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const $ = (id)=>document.getElementById(id);
    const info = $('info');
    const afterLinks = $('afterLinks');
    const openEvents = $('openEvents');

    const REDIRECT_DELAY = 2600; // مهلـة قبل التحويل بعد النجاح

    function todayLocal(){
      const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
      return d.toISOString().slice(0,10);
    }
    // ملء الحقول من URL/localStorage
    (function hydrate(){
      const p = new URLSearchParams(location.search);
      const num  = p.get('number')||p.get('animalNumber')||p.get('animalId')||localStorage.getItem('currentAnimalNumber')||localStorage.getItem('currentAnimalId')||'';
      const date = p.get('date')||p.get('eventDate')||localStorage.getItem('currentEventDate')||todayLocal();
      $('animalNumber').value = num;
      $('eventDate').value    = /^\d{4}-\d{2}-\d{2}$/.test(date)? date : todayLocal();
      try{
        localStorage.setItem('currentAnimalNumber', num);
        localStorage.setItem('currentEventDate', $('eventDate').value);
      }catch{}
    })();

    function showMsg(text, ok){
      if(!info) return;
      info.textContent = text;
      info.className = 'infobar show ' + (ok?'ok':'err');
      try{ info.scrollIntoView({behavior:'smooth', block:'center'}); }catch{}
    }

    function isFuture(iso){ return iso > todayLocal(); }

    async function saveDisease(diseaseCode, arabicType){
      // تحقق مدخلات أساسية
      const number = ($('animalNumber').value||'').trim();
      const date   = $('eventDate').value;
      const notes  = ($('notes').value||'').trim() || null;

      if(!number || !date){
        showMsg('أدخل رقم الحيوان وتاريخ التشخيص أولًا.', false);
        return;
      }
      if(isFuture(date)){
        showMsg('تاريخ التشخيص لا يمكن أن يكون في المستقبل.', false);
        return;
      }

      try{
        await ensureAuth();
        const uid = auth.currentUser?.uid || null;
        if(!uid){ showMsg('يجب تسجيل الدخول.', false); return; }

        const tenantId = localStorage.getItem('tenantId') || null;

        // وفق القواعد: userId = uid
        const payload = {
          type: arabicType,           // يظهر بالعربي في الجداول
          eventType: 'health',        // يصنّف ضمن "صحة"
          diseaseCode: diseaseCode,   // كود المرض
          diseaseName: arabicType,    // اسم المرض (عربي)
          eventDate: date,
          animalNumber: number,
          animalId: number,           // توافق
          notes,
          userId: uid,
          tenantId,
          source: location.pathname,
          createdAt: serverTimestamp()
        };

        const ref = await addDoc(collection(db,'events'), payload);
        if(!ref?.id) throw new Error('NO_ID');

        // تتبع
        try{ window.t && window.t.event('disease_save',{ code:diseaseCode, animal:number, date }); }catch{}

        // إعداد روابط بعد الحفظ + تحويل تلقائي للأحداث
        const evUrl = `add-event.html?number=${encodeURIComponent(number)}&date=${encodeURIComponent(date)}`;
        if(openEvents) openEvents.href = evUrl;
        if(afterLinks) afterLinks.style.display = 'flex';

        showMsg('✅ تم حفظ الحالة بنجاح. سيتم فتح صفحة الأحداث…', true);
        setTimeout(()=>{ location.href = evUrl; }, REDIRECT_DELAY);
      }catch(err){
        console.error('[disease save] FAILED', err);
        showMsg('❌ تعذّر الحفظ في فايرستور. تأكّد من تسجيل الدخول والصلاحيات.', false);
      }
    }

    // ربط أزرار الأمراض
    document.querySelectorAll('.dis-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const open = btn.getAttribute('data-open');
        if(open){
          // صفحات خاصة: لا حفظ هنا
          const number = ($('animalNumber').value||'').trim();
          const date   = $('eventDate').value || todayLocal();
          const url = new URL(open, location.origin);
          url.searchParams.set('number', number);
          url.searchParams.set('date', date);
          location.href = url.toString();
          return;
        }
        const code = btn.getAttribute('data-code');
        const name = btn.getAttribute('data-type');
        // حفظ فوري
        saveDisease(code, name);
      });
    });

    // تحديث التاريخ المحفوظ محليًا عند تغييره
    $('eventDate')?.addEventListener('change', ()=>{
      try{ localStorage.setItem('currentEventDate', $('eventDate').value||todayLocal()); }catch{}
    });
    $('animalNumber')?.addEventListener('change', ()=>{
      try{ localStorage.setItem('currentAnimalNumber', ($('animalNumber').value||'').trim()); }catch{}
    });
  </script>
</body>
</html>
