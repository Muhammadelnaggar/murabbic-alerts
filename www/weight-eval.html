<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>تقدير الوزن بالكاميرا — مُرَبِّك</title>
  <style>
    :root{ --green:#0ea05a; --border:#c5e1a5; --card:#ffffff; --bg:#f7faf7; --text:#0f172a; }
    *{box-sizing:border-box;}
    body{margin:0;font-family:'Cairo','Segoe UI',Tahoma,sans-serif;background:var(--bg);color:var(--text);}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--border);
      padding:12px 16px;display:flex;align-items:center;gap:12px;}
    h1{margin:0;font-size:18px;color:var(--green);font-weight:800;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:12px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0;}
    label{font-weight:700;color:#14532d;font-size:13px;margin-bottom:4px;display:block}
    input[type="text"],input[type="date"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fcfff8}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;}
    .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#e8f5e9;
      font-weight:700;font-size:14px;color:#064e3b;cursor:pointer;}
    video,img.preview{width:100%;border:1px solid var(--border);border-radius:12px;background:#fff}
    canvas{display:none;}
    .kpi3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px;}
    .kpi{border:1px solid var(--border);background:#fcfff8;border-radius:12px;padding:10px;text-align:center;}
    .kpi .lbl{font-size:12px;color:#2b593a;}
    .kpi .val{font-weight:800;color:#14532d;font-size:16px;}
    .hint{font-size:12px;color:#555;margin-top:10px;}
    .toast{position:fixed;bottom:12px;left:12px;right:12px;margin:auto;max-width:520px;background:#e8f5e9;
      color:#064e3b;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-weight:700;display:none}
    .err{background:#fff1f2;color:#7f1d1d;border-color:#fecdd3}
    .sep{display:flex;align-items:center;gap:8px;margin:10px 0;color:#2b593a;font-weight:700}
    .sep::before,.sep::after{content:"";flex:1;height:1px;background:var(--border)}
    .hidden{display:none !important;}
    /* ✅ بادج وضع المصدر */
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);
      border-radius:999px;background:#fff;font-size:12px;color:#14532d;margin:6px 0}
    .badge.err{background:#fff1f2;color:#7f1d1d;border-color:#fecdd3}
  </style>
</head>
<body>
  <!-- تتبّع ذكي -->
  <script>window.dataLayer = window.dataLayer || [];</script>
  <script src="/js/app-core.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>
  <script type="module" src="/js/timeline.js"></script>
  <script type="module" src="/js/smart-checks.js"></script>
  
  

  <header><h1>📏 تقدير الوزن بالكاميرا</h1></header>

  <section class="card">
    <!-- رقم الحيوان + التاريخ -->
    <div class="row">
      <div>
        <label for="animalNumber">رقم الحيوان</label>
        <input id="animalNumber" type="text" inputmode="numeric" placeholder="مثال: 245" />
      </div>
      <div>
        <label for="eventDate">تاريخ الحدث</label>
        <input id="eventDate" type="date" />
      </div>
    </div>

    <!-- ✅ بادج وضع المصدر -->
    <div id="modeBadge" class="badge">الوضع: كاميرا (حفظ مسموح)</div>

    <!-- مصدر 1: كاميرا -->
    <video id="awCam" class="source" playsinline autoplay muted></video>
    <!-- مصدر 2: صورة بديلة -->
    <img id="awPreview" class="source preview hidden" alt="معاينة الصورة المختارة" />

    <!-- اختيار صورة -->
    <div class="sep">أو اختر صورة</div>
    <div class="chips">
      <input id="awFile" type="file" accept="image/*" capture="environment" class="hidden">
      <label for="awFile" class="chip">📸 اختيار صورة</label>
      <button id="awStart" class="chip" type="button">تشغيل الكاميرا</button>
      <button id="awShot"  class="chip" type="button">التقاط & تقدير</button>
      <button id="awSave"  class="chip" type="button">حفظ كحدث</button>
    </div>

    <canvas id="awCan"></canvas>

    <div class="kpi3">
      <div class="kpi"><div class="lbl">المقياس</div><div class="val" id="awScale">—</div></div>
      <div class="kpi"><div class="lbl">عرض الصدر (سم)</div><div class="val" id="awChestW">—</div></div>
      <div class="kpi"><div class="lbl">الوزن التقديري</div><div class="val" id="awWeight">—</div></div>
    </div>

    <div class="hint">
      ضع علامة ArUco مربّع 5 سم بجوار الحيوان وعلى نفس مسافة الكاميرا/الصورة.  
      الخوارزمية تلتقط الحيوان + العلامة تلقائيًا وتقدّر الوزن.
    </div>
  </section>

  <div id="toast" class="toast"></div>

  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <script type="module">
  // ========= DOM =========
  const $=id=>document.getElementById(id);
  const v=$('awCam'), imgPrev=$('awPreview'), file=$('awFile');
  const can=$('awCan'), ctx=can.getContext('2d');
  const outScale=$('awScale'), outChestW=$('awChestW'), outWeight=$('awWeight');
  const btnStart=$('awStart'), btnShot=$('awShot'), btnSave=$('awSave');
  const inpNum=$('animalNumber'), inpDate=$('eventDate'); const toast=$('toast');
  const modeBadge = $('modeBadge');

  // ========= ثوابت/حالة =========
  const ARUCO_MARKER_CM=5, GIRTH_FACTOR=3.05;
  let stream=null, cvReady=false, pxPerCm=null, lastShot=null, currentSource='camera';
  const isDemo = new URLSearchParams(location.search).get('demo') === '1';

  // ========= تتبّع =========
  try { window.t?.event && window.t.event('page_view', {page: location.pathname, feature:'weight_estimation'});} catch(e){}

  // ========= مساعدات =========
  function setSaveEnabled(yes){
    btnSave.disabled = !yes;
    btnSave.style.opacity = yes ? '1' : '0.5';
    btnSave.style.pointerEvents = yes ? 'auto' : 'none';
  }
  function setSource(s){
    currentSource = s;
    if(s === 'camera'){
      v.classList.remove('hidden');
      imgPrev.classList.add('hidden');
      modeBadge.textContent = 'الوضع: كاميرا (حفظ مسموح)';
      modeBadge.classList.remove('err');
      setSaveEnabled(true);
    } else {
      imgPrev.classList.remove('hidden');
      v.classList.add('hidden');
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
      modeBadge.textContent = isDemo ? 'الوضع: صورة (عرض Demo — الحفظ مسموح)' : 'الوضع: صورة (عرض فقط — الحفظ غير مسموح)';
      modeBadge.classList.toggle('err', !isDemo);
      setSaveEnabled(isDemo);
    }
  }
  function fireTrack(event, meta={}){
    try {
      window.dataLayer.push({event, page: location.pathname, feature:'weight_estimation', ...meta});
      window.t?.event && window.t.event(event, meta);
    } catch(e){}
  }
  function showToast(msg, isErr=false){
    toast.textContent = msg; toast.classList.toggle('err', !!isErr);
    toast.style.display='block'; clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{ toast.style.display='none'; }, 2600);
  }

  // ========= تهيئة الحقول =========
  initContextFields();
  function initContextFields(){
    const q=new URLSearchParams(location.search);
    const num = q.get('number') || q.get('animalNumber') || localStorage.getItem('currentAnimalNumber') || '';
    const dt  = q.get('date') || q.get('eventDate') || localStorage.getItem('lastEventDate') || new Date().toISOString().slice(0,10);
    if(num) inpNum.value = num;
    if(dt)  inpDate.value = dt;
  }
  function pushContext(){
    if(inpNum.value) localStorage.setItem('currentAnimalNumber', inpNum.value.trim());
    if(inpDate.value) localStorage.setItem('lastEventDate', inpDate.value);
  }

  // ========= الكاميرا =========
  btnStart.onclick=async()=>{
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
      v.srcObject=stream;
      setSource('camera'); fireTrack('camera_start');
    }catch(e){ showToast('تعذّر فتح الكاميرا', true); }
  };

  // ========= اختيار صورة =========
  file.onchange = ()=>{
    const f=file.files?.[0]; if(!f) return;
    const url=URL.createObjectURL(f);
    imgPrev.onload=()=>URL.revokeObjectURL(url);
    imgPrev.src=url;
    setSource('image'); fireTrack('image_selected', {size:f.size, type:f.type});
  };

  // ========= التقاط/تقدير =========
  btnShot.onclick=()=>{
    if(!cvReady) return showToast('انتظر تحميل OpenCV.js', true);

    if(currentSource==='camera'){
      if(!v.videoWidth) return showToast('الكاميرا غير جاهزة', true);
      can.width=v.videoWidth; can.height=v.videoHeight;
      ctx.drawImage(v,0,0,can.width,can.height);
    } else {
      if(!imgPrev.naturalWidth) return showToast('اختر صورة أولًا', true);
      can.width = imgPrev.naturalWidth; can.height = imgPrev.naturalHeight;
      ctx.drawImage(imgPrev,0,0,can.width,can.height);
    }

    lastShot=ctx.getImageData(0,0,can.width,can.height);

    const scale=detectArucoPxPerCm(lastShot);
    if(!scale){ outScale.textContent='—'; return showToast('لم تُكتشف علامة ArUco', true); }
    pxPerCm=scale; outScale.textContent=pxPerCm.toFixed(2)+' px/cm';

    const mask=animalMask(lastShot);
    if(!mask) return showToast('تعذّر تحديد الحيوان', true);

    const chestPx=measureWidthAtSlice(mask,0.45);
    if(!chestPx) return showToast('فشل قياس العرض', true);

    const chestCm=chestPx/pxPerCm;
    outChestW.textContent=chestCm.toFixed(1);
    const HG=chestCm*GIRTH_FACTOR;
    const W=Math.round((HG*HG*HG)/10880);
    outWeight.textContent=W+' كجم';

    fireTrack('weight_estimated', {source: currentSource, px_per_cm:pxPerCm, chest_cm:chestCm, weight_kg:W});
  };

  async function postJSON(url, body){
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    let data = null; try { data = await res.json(); } catch(e){}
    return { ok: res.ok, status: res.status, data };
  }
 
  // ========= الحفظ =========
  btnSave.onclick=async()=>{
    const animalNumber = (inpNum.value||'').trim();
    const eventDate    = inpDate.value || new Date().toISOString().slice(0,10);
    const weightKg     = parseInt((outWeight.textContent||'').replace(/\D/g,'')) || null;

    if(!animalNumber) return showToast('أدخل رقم الحيوان أولًا', true);
    if(!weightKg)     return showToast('نفّذ التقدير قبل الحفظ', true);
    // اشتراطات التشغيل المتفق عليها:
if (currentSource === 'image' && !isDemo) {
  return showToast('الحفظ للصورة غير مسموح — استخدم الكاميرا أو فعّل وضع Demo.', true);
}
if (currentSource === 'camera' && (!pxPerCm || !isFinite(pxPerCm) || pxPerCm <= 0)) {
  return showToast('لا بد من اكتشاف علامة القياس ArUco قبل الحفظ.', true);
}

    const payload={
      eventType:'تقدير وزن',
      feature:'weight_estimation',
      sourceMode: currentSource,
      method: 'auto(aruco+mask)',
      marker_cm: ARUCO_MARKER_CM,
      px_per_cm: pxPerCm || null,
      chest_cm: Number(outChestW.textContent)||null,
      estimatedWeightKg: weightKg,
      animalNumber, eventDate,
      source: location.pathname
    };

    pushContext();
    fireTrack('weight_save_click', {animalNumber, eventDate, weightKg, source: currentSource});

    try {
    const res = await postJSON('/api/events', payload);
      if(!res || res?.ok===false) throw new Error('API failed');
      showToast('✅ تم حفظ حدث الوزن عبر API');
      fireTrack('weight_saved_api', {ok:true});
    } catch (e) {
      try{
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
        const { getFirestore, collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
        const cfg = (await import('/js/firebase-config.js')).default;
        const app = initializeApp(cfg);
        const db  = getFirestore(app, 'murabbikdata');
        await addDoc(collection(db,'events'), {
          type: 'weight',
          eventType: 'تقدير وزن',
          method: payload.method,
          marker_cm: payload.marker_cm,
          px_per_cm: payload.px_per_cm,
          chest_cm: payload.chest_cm,
          estimatedWeightKg: payload.estimatedWeightKg,
          animalNumber: payload.animalNumber,
          eventDate: payload.eventDate,
          source: payload.source,
          sourceMode: payload.sourceMode,
          createdAt: serverTimestamp()
        });
        showToast('✅ تم حفظ حدث الوزن في Firestore (بديل)');
        fireTrack('weight_saved_firestore', {ok:true});
      }catch(err){
        console.error(err);
        showToast('تعذّر الحفظ عبر API وFirestore', true);
        fireTrack('weight_saved_failed', {ok:false, reason:'api+firestore'});
      }
    }
  };

  // ========= CV Helpers =========
  function detectArucoPxPerCm(imgData){
    if(!window.cv) return null; const cv = window.cv;
    const src=cv.matFromImageData(imgData);
    const gray=new cv.Mat(); cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY,0);
    const dict=new cv.aruco_Dictionary(cv.DICT_4X4_50);
    const params=new cv.aruco_DetectorParameters();
    const corners=new cv.MatVector(); const ids=new cv.Mat();
    cv.aruco.detectMarkers(gray,dict,corners,ids,params);
    let scale=null;
    if(!ids.empty()){
      const c=corners.get(0).data32F;
      const d01=Math.hypot(c[0]-c[2],c[1]-c[3]);
      const d12=Math.hypot(c[2]-c[4],c[3]-c[5]);
      const sidePx=(d01+d12)/2; scale=sidePx/ARUCO_MARKER_CM;
    }
    src.delete();gray.delete();corners.delete();ids.delete();
    return scale;
  }
  function animalMask(imgData){
    const cv = window.cv; if(!cv) return null;
    const src=cv.matFromImageData(imgData);
    const gray=new cv.Mat(); cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY,0);
    cv.medianBlur(gray,gray,3);
    const bin=new cv.Mat(); cv.threshold(gray,bin,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU);
    const kernel=cv.Mat.ones(5,5,cv.CV_8U); cv.morphologyEx(bin,bin,cv.MORPH_OPEN,kernel);
    const contours=new cv.MatVector(), hierarchy=new cv.Mat();
    cv.findContours(bin,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);
    let maxA=0,best=-1;
    for(let i=0;i<contours.size();i++){const a=cv.contourArea(contours.get(i)); if(a>maxA){maxA=a;best=i;}}
    if(best<0){src.delete();gray.delete();bin.delete();kernel.delete();contours.delete();hierarchy.delete();return null;}
    const mask=cv.Mat.zeros(bin.rows,bin.cols,cv.CV_8U);
    cv.drawContours(mask,contours,best,new cv.Scalar(255,255,255,255),-1);
    src.delete();gray.delete();bin.delete();contours.delete();hierarchy.delete();
    return mask;
  }
  function measureWidthAtSlice(mask,fracY){
    const y=Math.round(mask.rows*fracY);
    let x0=-1,x1=-1;
    for(let x=0;x<mask.cols;x++){ if(mask.ucharPtr(y,x)[0]>0){x0=x;break;} }
    for(let x=mask.cols-1;x>=0;x--){ if(mask.ucharPtr(y,x)[0]>0){x1=x;break;} }
    return (x0>=0&&x1>x0)?(x1-x0):null;
  }

  // ========= جاهزية OpenCV =========
  window.cv = window.cv || {};
  window.cv.onRuntimeInitialized = ()=>{ cvReady=true; fireTrack('cv_ready'); };
  </script>
</body>
</html>
