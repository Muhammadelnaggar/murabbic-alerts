<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯ - Ù…Ø±Ø¨ÙŠÙƒ</title>
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <meta name="theme-color" content="#2e7d32" />
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>

  <style>
    :root{
      --bg:#f7faf7;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --brand:#0ea05a;
      --brand-600:#0b7f47;
      --danger:#c2410c;
    }

    .mbk-top{
      position: sticky; top:0; z-index:50;
      background:#fff;
      border-bottom:1px solid var(--border);
    }
    .mbk-head{
      max-width:980px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .mbk-title{ line-height:1.1; }
    .mbk-page{ font-size:18px; font-weight:900; color:var(--text); }
    .mbk-app{ font-size:13px; font-weight:900; color:var(--brand-600); opacity:.9; }
    .mbk-logo{ height:46px; width:auto; object-fit:contain; opacity:.95; }

    *{box-sizing:border-box}
    body{
      margin:0;
      padding-bottom:70px;
      background:var(--bg);
      font-family:'Cairo','Arial',sans-serif;
      color:var(--text);
    }

    .meta{padding:8px 10px;text-align:center;font-size:16px}
    .warning{min-height:22px;text-align:center;color:var(--danger);font-size:14px}

    .form{
      margin:12px;
      padding:14px;
      background:var(--card);
      border-radius:12px;
      box-shadow:0 2px 5px rgba(0,0,0,.08);
      display:grid;
      gap:10px
    }

    .form input, .form textarea{
      width:100%;
      padding:12px;
      border:1px solid #ccc;
      border-radius:10px;
      font-size:16px;
      font-family:inherit;
    }

    .hint{
      font-size:13px;
      color:var(--muted);
      line-height:1.6;
      padding:0 2px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      margin:12px;
    }
    @media(min-width:768px){.grid{grid-template-columns:repeat(3,1fr);} }

    .btn{
      padding:14px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      text-align:center;
      transition:.2s;
      box-shadow:0 2px 5px rgba(0,0,0,.06);
      font-size:16px
    }
    .btn:hover{
      background:var(--brand);
      border-color:var(--brand);
      color:#fff;
      transform:translateY(-2px);
      box-shadow:0 6px 12px rgba(0,0,0,.12)
    }

    #inlineMsg{margin:12px;padding:10px;background:#f1f8e9;border:1px solid #c5e1a5;border-radius:10px;display:none}
    #inlineMsg .text{font-size:14px;font-weight:700;color:var(--text);text-align:center}

    .mbk-bottom-nav{
      position:fixed;
      bottom:0; left:0; right:0;
      height:58px;
      background:#ffffff;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-around;
      align-items:center;
      z-index:9999;
    }
    .mbk-bottom-nav .mbk-nav-link{
      text-decoration:none;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#ffffff;
      color:var(--text);
      font-size:0.9rem;
      white-space:nowrap;
    }
    .mbk-nav-link-disabled{opacity:0.5; pointer-events:none;}
  </style>
</head>

<body>
  <header class="mbk-top">
    <div class="mbk-head">
      <div class="mbk-title">
        <div class="mbk-page">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø«</div>
        <div class="mbk-app">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
      </div>
      <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
    </div>
  </header>

  <div class="meta" id="animalInfo">ğŸ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</div>
  <div class="meta" id="dateInfo"></div>
  <div class="warning" id="warn"></div>

  <div class="form">
    <!-- âœ… Ø­Ù‚Ù„ ÙˆØ§Ø­Ø¯ (ÙØ±Ø¯ÙŠ/Ø¬Ù…Ø§Ø¹ÙŠ) -->
    <textarea id="animalNumbers" inputmode="numeric" placeholder="Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª (Ø§ÙƒØªØ¨ Ø±Ù‚Ù…Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø£Ùˆ Ø¹Ø¯Ø© Ø£Ø±Ù‚Ø§Ù…... ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø±)"
      style="min-height:110px; line-height:1.6; resize:vertical;"></textarea>

    <div class="hint">
      âœ… Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: Ø§ÙƒØªØ¨ ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø± (Ø²Ø± Enter).<br>
      Ù…Ø«Ø§Ù„:<br>
      <b>31</b> Ø«Ù… Enter Ø«Ù… <b>32</b>
    </div>

    <input id="eventDate" type="date" />
  </div>

  <div id="inlineMsg"><div class="text"></div></div>

  <div class="grid" id="eventButtons">
    <button class="btn" data-page="calving.html">ğŸ‘¶ ÙˆÙ„Ø§Ø¯Ø©</button>
    <button class="btn" data-page="insemination.html">ğŸ“… ØªÙ„Ù‚ÙŠØ­</button>
    <button class="btn" data-page="vaccination.html">ğŸ’‰ ØªØ­ØµÙŠÙ†</button>
    <button class="btn" data-page="dry-off.html">ğŸš« ØªØ¬ÙÙŠÙ</button>
    <button class="btn" data-page="close-up.html">ğŸ¼ ØªØ­Ø¶ÙŠØ± Ù„Ù„ÙˆÙ„Ø§Ø¯Ø©</button>
    <button class="btn" data-page="daily-milk.html">ğŸ¥› Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
    <button class="btn" data-page="nutrition.html">ğŸŒ¿ ØªØºØ°ÙŠØ©</button>
    <button class="btn" data-page="pregnancy-diagnosis.html">ğŸ§ª ØªØ´Ø®ÙŠØµ Ø§Ù„Ø­Ù…Ù„</button>
    <button class="btn" data-page="disease.html">ğŸ”¬ Ø§Ù„ØªØ´Ø®ÙŠØµ</button>
    <button class="btn" id="btnTrimming" data-action="trimming">ğŸ¦¶ ØªÙ‚Ù„ÙŠÙ… Ø§Ù„Ø­ÙˆØ§ÙØ±</button>
    <button class="btn" data-page="abortion.html">ğŸ©¸ Ø¥Ø¬Ù‡Ø§Ø¶</button>
    <button class="btn" data-page="early-fetal-death.html">ğŸ’” Ù…ÙˆØª Ø¬Ù†ÙŠÙ†ÙŠ Ù…Ø¨ÙƒØ±</button>

    <!-- âœ… Ù†ÙØ³ Ù…Ù„ÙÙƒ -->
    <button class="btn" data-page="ovysynch.html">ğŸ“Œ ØªØ²Ø§Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¶ ÙˆØ§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</button>

    <button class="btn" data-page="event-list.html">ğŸ“œ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</button>
    <button class="btn" data-page="heat.html">ğŸ”¥ Ø´ÙŠØ§Ø¹</button>
    <button class="btn" data-page="death.html">â˜ ï¸ Ù†ÙÙˆÙ‚</button>
    <button class="btn" data-page="cull.html">ğŸš« Ø§Ø³ØªØ¨Ø¹Ø§Ø¯</button>
    <button class="btn" data-page="sale.html">ğŸ’° Ø¨ÙŠØ¹</button>
    <button class="btn" data-page="smart-camera.html">ğŸ¤– Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø°ÙƒÙŠØ©</button>
  </div>

  <script>window.dataLayer = window.dataLayer || [];</script>
  <script src="/js/app-core.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>
  <script type="module" src="/js/api.js"></script>

  <script>
    function updateCowCardNav(number, multi){
      const link = document.querySelector('[data-nav="cow-card"]');
      if (!link) return;

      // âœ… Ù„Ùˆ Ø£ÙƒØªØ± Ù…Ù† Ø±Ù‚Ù…: Ù…Ù‚ÙÙˆÙ„ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
      if (multi){
        link.href = '#';
        link.classList.add('mbk-nav-link-disabled');
        return;
      }

      if (number){
        link.href = 'cow-card.html?number=' + encodeURIComponent(number);
        link.classList.remove('mbk-nav-link-disabled');
      } else {
        link.href = '#';
        link.classList.add('mbk-nav-link-disabled');
      }
    }

    (function(){
      const $ = s=>document.querySelector(s);
      const $$ = s=>document.querySelectorAll(s);

      const norm = v => (v==null||v==='undefined'||v==='null'||v==='NaN')? '' : String(v).trim();
      const todayISO = ()=>{const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10);};

      // âœ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØµÙ„/Ø§Ù„Ø£Ø³Ø·Ø±
      const DIGITS = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
      const toLatinKeepSep = (s)=> String(s||'').replace(/[Ù -Ù©Û°-Û¹]/g, d => DIGITS[d] || d);
      const toDigitsOnly = (s)=> String(s||'').replace(/[Ù -Ù©Û°-Û¹]/g, d => DIGITS[d] || d).replace(/[^\d]/g,'');

      function parseNumbers(raw){
        const s = toLatinKeepSep(raw || '');
        // âœ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„ Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙƒÙ…Ø§ Ù‡ÙŠ (ÙŠØ¯Ø¹Ù… ÙÙˆØ§ØµÙ„/Ù…Ø³Ø§ÙØ§Øª/Ø£Ø³Ø·Ø±)
        // ÙŠÙ…Ù†Ø¹ ØªÙƒÙˆÙŠÙ† Ø±Ù‚Ù… "32" Ø¨Ø§Ù„Ø®Ø·Ø£ Ù„Ùˆ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø£Ø¯Ø®Ù„ ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø±Ù‚Ù…ÙŠÙ† Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù…
       const matches = s.match(/\d+/g) || [];

        const list = matches.map(x=>toDigitsOnly(x)).filter(Boolean);
        // unique Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        return [...new Set(list)];
      }

      function hydrate(){
        const qs = new URLSearchParams(location.search);

        const rawDate = norm(qs.get('eventDate') || qs.get('date') || '');
        const date = /^\d{4}-\d{2}-\d{2}$/.test(rawDate) ? rawDate : todayISO();
        $('#dateInfo').textContent = `ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ: ${date}`;
        if (!norm($('#eventDate').value)) $('#eventDate').value = date;

        // Ù„Ùˆ Ø¬Ø§ÙŠ number Ù…Ù† ØµÙØ­Ø© ØªØ§Ù†ÙŠØ©: Ø­Ø·Ù‡ ÙƒØ³Ø·Ø± ÙˆØ§Ø­Ø¯
        const rawNum = norm(qs.get('number') || qs.get('animalNumber') || '');
        const one = toDigitsOnly(rawNum);
        if (one){
          $('#animalNumbers').value = one;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø²Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        const list = parseNumbers($('#animalNumbers').value);
        if (list.length === 1){
          $('#animalInfo').textContent = `ğŸ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${list[0]}`;
          updateCowCardNav(list[0], false);
        } else if (list.length > 1){
          $('#animalInfo').textContent = `ğŸ„ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ: ${list.length} Ø£Ø±Ù‚Ø§Ù…`;
          updateCowCardNav('', true);
        } else {
          $('#animalInfo').textContent = `ğŸ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ØºÙŠØ± Ù…Ø­Ø¯Ø¯`;
          updateCowCardNav('', false);
        }
      }

      function getCtxOrWarn(targetPage){
        const raw = norm($('#animalNumbers').value);
        const list = parseNumbers(raw);

        let date = norm($('#eventDate').value) || todayISO();
        if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) date = todayISO();

        if (!list.length){
          $('#warn').textContent = 'âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø£ÙˆÙ„Ù‹Ø§.';
          updateCowCardNav('', false);
          return null;
        }

        const isOvsynch = /ovysynch/i.test(String(targetPage||'')) || /ovsynch/i.test(String(targetPage||''));

        
        const isHeat = /heat\.html/i.test(String(targetPage||''));
        const isGroupAllowed = isOvsynch || isHeat;
// âœ… Ù„Ùˆ Ø£ÙƒØªØ± Ù…Ù† Ø±Ù‚Ù…:
        if (list.length > 1){
          // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ù…Ù‚ÙÙˆÙ„Ø©
          updateCowCardNav('', true);

          // Ù…Ø³Ù…ÙˆØ­ Ø¬Ù…Ø§Ø¹ÙŠ ÙÙ‚Ø· Ù„Ù€ Ovsynch Ø­Ø§Ù„ÙŠÙ‹Ø§
          if (!isGroupAllowed){
            $('#warn').textContent = 'âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø« ÙØ±Ø¯ÙŠ ÙÙ‚Ø· Ø­Ø§Ù„ÙŠÙ‹Ø§. Ø§ÙƒØªØ¨ Ø±Ù‚Ù…Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§.';
            return null;
          }

          $('#warn').textContent = '';
          $('#animalInfo').textContent = `ğŸ„ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ: ${list.length} Ø£Ø±Ù‚Ø§Ù…`;
          return { mode:'group', bulk:list.join(','), number:list[0], date };
        }

        // âœ… Ø±Ù‚Ù… ÙˆØ§Ø­Ø¯
        $('#warn').textContent = '';
        $('#animalInfo').textContent = `ğŸ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${list[0]}`;
        updateCowCardNav(list[0], false);
        return { mode:'single', number:list[0], date };
      }

      function buildUrl(page, ctx){
        const u = new URL(page, location.href);
        const isOvsynch = /ovysynch/i.test(String(page)) || /ovsynch/i.test(String(page));

        
        const isHeat = /heat\.html/i.test(String(page));
if ((isOvsynch || isHeat) && ctx.mode === 'group'){
          u.searchParams.set('mbkMode','group');
          u.searchParams.set('bulk', ctx.bulk);
        } else {
          u.searchParams.set('number', ctx.number);
        }

        u.searchParams.set('date', ctx.date);
        u.searchParams.set('eventDate', ctx.date);
        return u.toString();
      }

      function wireButtons(){
        $$('#eventButtons .btn[data-page]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.preventDefault();
            const target = btn.getAttribute('data-page') || '';
            const ctx = getCtxOrWarn(target); if(!ctx) return;
            location.href = buildUrl(target, ctx);
          }, {passive:false});
        });
      }

      // âœ… ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø¹Ù†ÙˆØ§Ù†/Ø²Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
      function wireLive(){
        const input = $('#animalNumbers');
        if (!input) return;
        input.addEventListener('input', ()=>{
          const list = parseNumbers(input.value);
          if (list.length === 1){
            $('#animalInfo').textContent = `ğŸ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${list[0]}`;
            updateCowCardNav(list[0], false);
          } else if (list.length > 1){
            $('#animalInfo').textContent = `ğŸ„ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ: ${list.length} Ø£Ø±Ù‚Ø§Ù…`;
            updateCowCardNav('', true);
          } else {
            $('#animalInfo').textContent = `ğŸ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ØºÙŠØ± Ù…Ø­Ø¯Ø¯`;
            updateCowCardNav('', false);
          }
        }, {passive:true});
      }

      async function saveTrimmingInline(){
        const ctx = getCtxOrWarn('trimming'); if(!ctx) return;
        if (ctx.mode !== 'single'){
          $('#warn').textContent = 'âš ï¸ ØªÙ‚Ù„ÙŠÙ… Ø§Ù„Ø­ÙˆØ§ÙØ± ÙŠÙØ³Ø¬Ù„ Ù„ÙØ±Ø¯ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·.';
          return;
        }
        try{
          const payload = { type:'ØªÙ‚Ù„ÙŠÙ… Ø§Ù„Ø­ÙˆØ§ÙØ±', number:ctx.number, eventDate:ctx.date, source:location.pathname };
          if(typeof window.api?.post === 'function'){
            await window.api.post('/api/events', payload);
          }
          const box = document.getElementById('inlineMsg');
          box.querySelector('.text').textContent = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªÙ‚Ù„ÙŠÙ… Ø§Ù„Ø­ÙˆØ§ÙØ± Ù„Ù„Ø­ÙŠÙˆØ§Ù† Ø±Ù‚Ù… ${ctx.number} Ø¨ØªØ§Ø±ÙŠØ® ${ctx.date}.`;
          box.style.display = 'block';
          window.dataLayer.push({event:'event_saved', eventType:'trimming', number:ctx.number, date:ctx.date});
        }catch(err){
          const box = document.getElementById('inlineMsg');
          box.querySelector('.text').textContent = `âŒ ØªØ¹Ø°Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ Ù„Ø§Ø­Ù‚Ù‹Ø§.`;
          box.style.display = 'block';
          console.error('Trimming save failed', err);
        }
      }

      function wireTrimming(){
        document.getElementById('btnTrimming')?.addEventListener('click', (e)=>{
          e.preventDefault();
          saveTrimmingInline();
        }, {passive:false});
      }

      hydrate();
      wireLive();
      wireButtons();
      wireTrimming();
    })();
  </script>

  <nav class="mbk-bottom-nav">
    <a href="dashboard.html" class="mbk-nav-link">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
    <a href="#" class="mbk-nav-link mbk-nav-link-disabled" data-nav="cow-card">ğŸ§¾ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</a>
  </nav>

</body>
</html>

