<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة التحكم - مربيك</title>
  <style>
    :root{--bg:#fff9db;--card:#ffffff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:var(--green)}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .tile{background:#eafbe7;border:2px solid #c5e1a5;border-radius:12px;padding:18px;text-align:center;font-weight:bold;cursor:pointer}
    .tile .icon{display:block;font-size:28px;margin-bottom:8px}
    .tile:hover{background:#dcedc8}

    /* Weather widget */
    #weatherCard{display:none;align-items:center;gap:12px}
    #weatherBadge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;border:1px solid var(--border);padding:8px 12px;background:var(--muted)}
    #wLoc{font-weight:bold}
    .wvals{display:flex;gap:10px;flex-wrap:wrap}
    .wval{background:#f7fff4;border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:90px;text-align:center}
    .btn{appearance:none;border:1px solid var(--green);background:#fff;color:var(--green);border-radius:10px;padding:8px 12px;font-weight:bold;cursor:pointer}
    .btn:hover{background:#f4fff1}
    @media(max-width:560px){.wvals{gap:6px}.wval{min-width:78px;padding:6px 8px}}
  </style>
</head>
<body>
  <h1>📊 لوحة التحكم - مربيك</h1>
  
  <!-- الطقس و THI -->
  <div id="weatherCard" class="card">
    <div id="weatherBadge">
      <span>🌦️</span>
      <span id="wLoc">—</span>
    </div>
    <div class="wvals" style="flex:1">
      <div class="wval"><div>الحرارة</div><b id="wTemp">—°C</b></div>
      <div class="wval"><div>الرطوبة</div><b id="wHum">—%</b></div>
      <div class="wval"><div>THI</div><b id="wTHI">—</b></div>
      <div class="wval"><div>الحالة</div><b id="wState">—</b></div>
    </div>
    <button id="wRefresh" class="btn">تحديث</button>
  </div>

  <!-- روابط سريعة -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">➕</span>تسجيل حيوان جديد</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">📋</span>قائمة الحيوانات</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">🗓️</span>تسجيل الأحداث</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">🔔</span>التنبيهات الذكية</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">🆔</span>البطاقة الذكية</div>
    
    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">📊</span>تقارير اللبن</div>
    <div class="tile" onclick="location.href='farm-economy.html'"><span class="icon">💰</span>اقتصاد المزرعة</div>
    <div class="tile" onclick="location.href='evaluation.html'"><span class="icon">📈</span>تقييم الحيوانات</div>
    <div class="tile" onclick="location.href='nutrition.html'"><span class="icon">🌿</span>تركيبة التغذية</div>
    <div class="tile" onclick="location.href='smart-feeding.html'"><span class="icon">🧠</span>التغذية الذكية</div>
  </div>

<script type="module">
  import { db } from './js/firebase-config.js';
  import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // عناصر الويدجت
  const chip   = document.getElementById('weatherCard');
  const wLoc   = document.getElementById('wLoc');
  const wTemp  = document.getElementById('wTemp');
  const wHum   = document.getElementById('wHum');
  const wTHI   = document.getElementById('wTHI');
  const wState = document.getElementById('wState');
  const wRefresh = document.getElementById('wRefresh');

  // تأكيد وجود مفتاح المنطقة في localStorage (لا يغيّر التصميم/الابحار)
  (function ensureRegionKey(){
    let key = localStorage.getItem('userRegionKey');
    if (key) return;
    const c = localStorage.getItem('userCountry');
    const r = localStorage.getItem('userRegion');
    if (c && r) key = `${c}:${r}`; else key = 'مصر:القاهرة';
    localStorage.setItem('userRegionKey', key);
  })();

  // خريطة إحداثيات مبسطة (fallback إذا لم نجدها في Firestore)
  const GEO = {
    'مصر:القاهرة': {lat:30.0444, lon:31.2357},
    'مصر:الجيزة':  {lat:30.0131, lon:31.2089},
    'مصر:الإسكندرية': {lat:31.2001, lon:29.9187},
    'السعودية:الرياض': {lat:24.7136, lon:46.6753},
    'السعودية:مكة المكرمة': {lat:21.3891, lon:39.8579},
    'الإمارات:دبي': {lat:25.2048, lon:55.2708},
    'قطر:الدوحة': {lat:25.2854, lon:51.5310},
    'الكويت:العاصمة': {lat:29.3759, lon:47.9774},
    'البحرين:العاصمة': {lat:26.2235, lon:50.5876},
    'عُمان:مسقط': {lat:23.5880, lon:58.3829}
  };

  async function getCoords(regionKey){
    try{ const s = await getDoc(doc(db,'geoRegions', regionKey)); if (s.exists()) return s.data(); }catch{}
    return GEO[regionKey] || null;
  }

  function THI(c, rh){ const f=c*9/5+32; return Math.round(((f - (0.55 - 0.0055*rh)*(f - 58)))*10)/10; }
  function thiColor(thi){
    if (thi < 68) return {bg:'#c8e6c9', txt:'مريح'};
    if (thi < 72) return {bg:'#fff9c4', txt:'توتر خفيف'};
    if (thi < 79) return {bg:'#ffe0b2', txt:'توتر متوسط'};
    if (thi < 84) return {bg:'#ffccbc', txt:'توتر شديد'};
    return {bg:'#ffcdd2', txt:'توتر شديد جدًا'};
  }

  function saveCache(key, data){ localStorage.setItem('weather:'+key, JSON.stringify({...data, ts:Date.now()})); }
  function loadCache(key){ try{ const o=JSON.parse(localStorage.getItem('weather:'+key)||'null'); return o && (Date.now()-o.ts)<3600000 ? o : null; }catch{return null;} }

  async function fetchWeather(lat, lon){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`;
    const r = await fetch(url); const j = await r.json();
    return { t: j.current?.temperature_2m, h: j.current?.relative_humidity_2m };
  }

  async function renderWeather(force=false){
    const key = localStorage.getItem('userRegionKey');
    if(!key){ chip.style.display='none'; return; }
    wLoc.textContent = key;

    let data = !force && loadCache(key);
    if(!data){
      const coords = await getCoords(key);
      if(!coords){ chip.style.display='none'; return; }
      data = await fetchWeather(coords.lat, coords.lon);
      if (!data || data.t==null || data.h==null){ chip.style.display='none'; return; }
      saveCache(key, data);
    }

    const thi = THI(data.t, data.h);
    const {bg, txt} = thiColor(thi);

    chip.style.display='flex';
    chip.style.background = bg;
    wTemp.textContent = `${Math.round(data.t)}°C`;
    wHum.textContent  = `${Math.round(data.h)}%`;
    wTHI.textContent  = thi;
    wState.textContent= txt;
  }

  document.addEventListener('DOMContentLoaded', ()=> renderWeather());
  wRefresh.addEventListener('click', ()=> renderWeather(true));
</script>

</body>
</html>

