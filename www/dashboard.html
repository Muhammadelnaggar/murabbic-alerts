<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة التحكم - مربيك</title>
  <style>
    :root{--bg:#fff9db;--card:#ffffff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:var(--green)}

    /* الشبكة */
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}

    /* الكروت */
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)
    }

    /* البلاطات (قلب مربيك) */
    .tile{
      background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
      padding:16px;text-align:center;font-weight:bold;cursor:pointer;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;min-height:118px;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease
    }
    .tile .icon{
      display:block;width:44px;height:44px;line-height:44px;border-radius:50%;
      border:1px solid var(--border);font-size:24px
    }
    .tile small{font-weight:normal;color:#335c33}
    .tile:hover{background:#dcedc8;transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.08)}

    /* أيقونة مركّبة للبطاقة الذكية */
    .tile .icon.icon-layer{position:relative;display:inline-flex;align-items:center;justify-content:center}
    .icon-layer .i-main{font-size:24px;line-height:1}
    .icon-layer .i-badge{position:absolute;bottom:-4px;right:-4px;font-size:14px;background:#fff;border:1px solid var(--border);border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,.08)}

    /* ويدجت الطقس (نسخة مضغوطة) */
    #weatherCard{display:none;gap:12px;padding:10px 12px;display:grid;grid-template-columns:clamp(90px,26vw,140px) 1fr;align-items:center}
    #weatherCard.compact .wvals{display:flex;gap:6px;flex-wrap:wrap}
    /* تخطيط الساعة يسار، البيانات يمين متكدسة */
    #weatherCard .thi-clock{grid-column:1;grid-row:1 / span 3;justify-self:center}
    #weatherCard #weatherBadge{grid-column:2;grid-row:1}
    #weatherCard #wRefresh{grid-column:2;grid-row:1;justify-self:end;align-self:start}
    #weatherCard .wvals{grid-column:2;grid-row:2}
    #weatherCard .herd-toggle{grid-column:2;grid-row:3;justify-content:flex-start}
    #weatherCard.compact #weatherBadge{
      display:inline-flex;align-items:center;gap:8px;border-radius:999px;border:1px solid var(--border);
      padding:6px 10px;background:var(--muted);font-size:14px
    }
    #wLoc{font-weight:bold}
    #weatherCard.compact .wval{
      background:#f7fff4;border:1px solid var(--border);border-radius:10px;
      padding:6px 8px;min-width:72px;text-align:center;font-size:13px
    }
    .btn{appearance:none;border:1px solid var(--green);background:#fff;color:var(--green);
      border-radius:10px;padding:6px 10px;font-weight:bold;cursor:pointer;font-size:12px}
    .btn:hover{background:#f4fff1}

    /* محوّل نوع القطيع */
    .herd-toggle{display:flex;gap:6px;align-items:center}
    .herd-toggle .seg{appearance:none;border:1px solid var(--green);background:#fff;color:var(--green);border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    .herd-toggle .seg.active{background:var(--green);color:#fff}

    /* مؤشر THI الصغير */
    .thi-scale{min-width:160px;max-width:260px;display:flex;flex-direction:column;gap:4px}
    .thi-track{position:relative;height:8px;border-radius:999px;background:#e0e0e0;overflow:hidden}
    .thi-marker{position:absolute;top:50%;width:10px;height:10px;border:2px solid var(--green);background:#fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 0 2px rgba(255,255,255,.6)}
    .thi-labels{display:flex;justify-content:space-between;font-size:11px;color:#335c33;padding:0 2px}

    /* Tooltip THI */
    .thi-tooltip{position:absolute;top:-30px;transform:translateX(-50%);background:#1b5e20;color:#fff;font-size:11px;padding:4px 6px;border-radius:6px;white-space:nowrap;display:none}
    .thi-tooltip::after{content:'';position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);border-width:5px;border-style:solid;border-color:#1b5e20 transparent transparent transparent}

    /* مؤشر THI الصغير */
    .thi-scale{min-width:160px;max-width:260px;display:flex;flex-direction:column;gap:4px}
    .thi-track{position:relative;height:8px;border-radius:999px;background:#e0e0e0;overflow:hidden}
    .thi-marker{position:absolute;top:50%;width:10px;height:10px;border:2px solid var(--green);background:#fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 0 2px rgba(255,255,255,.6)}
    .thi-labels{display:flex;justify-content:space-between;font-size:11px;color:#335c33;padding:0 2px}

    /* Tooltip THI */
    .thi-tooltip{position:absolute;top:-30px;transform:translateX(-50%);background:#1b5e20;color:#fff;font-size:11px;padding:4px 6px;border-radius:6px;white-space:nowrap;display:none}
    .thi-tooltip::after{content:'';position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);border-width:5px;border-style:solid;border-color:#1b5e20 transparent transparent transparent}

    /* بلاطة كبيرة + أزرار فرعية */
    .tile-lg{min-height:140px}
    .tile-2x{grid-column:span 2}
    @media(max-width:560px){.tile-2x{grid-column:span 1}}
    .subactions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px}
    .subbtn{appearance:none;border:2px solid var(--green);background:#fff;color:var(--green);border-radius:999px;padding:12px 16px;font-size:16px;font-weight:700;cursor:pointer;min-width:160px}
    .subbtn:hover{background:#f4fff1}

    @media(max-width:560px){
      .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
      .tile{min-height:110px;padding:14px}
      .tile-m-full{grid-column:1 / -1}
    }
  /* عدّاد THI بشكل ساعة */
    .thi-clock{position:relative;width:clamp(64px,22vw,120px);height:clamp(64px,22vw,120px);margin:4px 6px}
    .thi-clock .dial{position:absolute;inset:0;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .thi-clock .arc{position:absolute;inset:0;border-radius:50%;-webkit-mask:radial-gradient(farthest-side, transparent 62%, #000 63%);mask:radial-gradient(farthest-side, transparent 62%, #000 63%)}
    .thi-clock .needle{position:absolute;left:50%;top:50%;width:2px;height:42%;background:#000;transform-origin:bottom center;transform:translate(-50%,-100%) rotate(var(--angle,-120deg));border-radius:2px;transition:transform .9s cubic-bezier(.22,.8,.2,1);will-change:transform}
    
    .thi-clock .center{position:absolute;left:50%;top:50%;width:8px;height:8px;border-radius:50%;background:#000;transform:translate(-50%,-50%)}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);-webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);-webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);-webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .needle::after{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:inherit}
    

    @media(max-width:560px){#weatherCard{grid-template-columns:clamp(84px,32vw,120px) 1fr;align-items:center}.herd-toggle{justify-content:flex-start}}
  
  
  @media (prefers-reduced-motion: reduce){ .thi-clock .needle{ transition:none } }
  </style>
</head>
<body>
  <h1>📊 لوحة التحكم - مربيك</h1>

  <!-- الطقس و THI (مضغوط) -->
  <div id="weatherCard" class="card" aria-label="الطقس و مؤشر الحرارة-الرطوبة">
    <div id="weatherBadge">
      <span>🌦️</span>
      <span id="wLoc">—</span>
    </div>
    <button id="wRefresh" class="btn" style="margin-inline-start:auto">تحديث</button>
    <div class="wvals" style="flex:1">
      <div class="wval"><div>الحرارة</div><b id="wTemp">—°C</b></div>
      <div class="wval"><div>الرطوبة</div><b id="wHum">—%</b></div>
      <div class="wval"><div>THI</div><b id="wTHI">—</b></div>
      <div class="wval"><div>الحالة</div><b id="wState">—</b></div>
    </div>
    <div class="herd-toggle" role="group" aria-label="نوع القطيع">
      <button class="seg" id="herdCow" type="button">أبقار</button>
      <button class="seg active" id="herdBuffalo" type="button">جاموس</button>
    </div>
    <div class="thi-clock" aria-label="مؤشر THI">
      <div class="dial" id="thiDial"><div class="arc" id="thiArc"></div></div>
      <div class="needle" id="thiNeedle"></div>
      <div class="center"></div>
      <div class="thi-tooltip" id="thiTip" style="display:none"></div>
    </div>
  </div>

  <!-- روابط سريعة -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">➕</span>حيوان جديد</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">📋</span>حيواناتي</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">🗓️</span>حدث جديد</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">🔔</span>أرشيف التنبيهات</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon icon-layer"><span class="i-main">🐮</span><span class="i-badge">💳</span></span>البطاقة الذكية</div>

    <div class="tile" id="milkTraitsCard" role="button" tabindex="0">
      <span class="icon">🐄</span>
      سمات حيوان اللبن /كاميرا
    </div>

    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">📊</span>تقارير اللبن</div>
    <div class="tile" onclick="location.href='farm-economy.html'"><span class="icon">💰</span>اقتصاد المزرعه</div>

    <!-- ⛔ تمت إزالة بلاطة تقييم الحيوانات (evaluation.html) بناءً على طلبك -->

    <!-- تقييم التغذية بالحالة الجسميّة (BCS) -->
    <div class="tile tile-lg tile-2x tile-m-full" id="smartNutritionTile" role="group" tabindex="0">
      <span class="icon">🧠</span>
      تقييم التغذية الذكي
      
      <div class="subactions" aria-label="اختيارات التقييم">
        <button class="subbtn" id="goFeces">الروث بالكاميرا</button>
        <button class="subbtn" id="goBCS">الحالة الجسميّة بالكاميرا</button>
        <button class="subbtn" id="goRation">تقييم العليقة</button>
      </div>
    </div>

    <!-- تقييم الروث بالكاميرا -->
    
  </div>

<script>
// ويدجت الطقس — نسخة مستقلة مع محوّل أبقار/جاموس
(function(){
  const chip   = document.getElementById('weatherCard');
  const wLoc   = document.getElementById('wLoc');
  const wTemp  = document.getElementById('wTemp');
  const wHum   = document.getElementById('wHum');
  const wTHI   = document.getElementById('wTHI');
  const wState = document.getElementById('wState');
  const wRefresh = document.getElementById('wRefresh');
  const thiTrack = document.querySelector('.thi-track');
  const thiMarker = document.getElementById('thiMarker');
  const thiTip = document.getElementById('thiTip');
  const thiDial = document.getElementById('thiDial');
  const thiArc = document.getElementById('thiArc');
  const thiNeedle = document.getElementById('thiNeedle');
  const thiCenter = document.querySelector('.thi-clock .center');
  const thiL1 = document.getElementById('thiL1');
  const thiL2 = document.getElementById('thiL2');
  const thiL3 = document.getElementById('thiL3');
  const thiL4 = document.getElementById('thiL4');
  const herdCow = document.getElementById('herdCow');
  const herdBuffalo = document.getElementById('herdBuffalo');
  let tipTimer = null;
  function showTip(){ if(!thiTip) return; thiTip.style.display='block'; clearTimeout(tipTimer); tipTimer=setTimeout(()=>{ thiTip.style.display='none'; }, 1800);} 
  function hideTip(){ if(!thiTip) return; thiTip.style.display='none'; }

  // إظهار الويدجت فورًا
  chip.style.display='grid';
  chip.classList.add('compact');

  // المنطقة الافتراضية
  let key = localStorage.getItem('userRegionKey');
  if(!key){
    const c = localStorage.getItem('userCountry');
    const r = localStorage.getItem('userRegion');
    key = (c && r) ? `${c}:${r}` : 'مصر:القاهرة';
    localStorage.setItem('userRegionKey', key);
  }
  wLoc.textContent = key;

  // محوّل نوع القطيع
  function getProfile(){ return (localStorage.getItem('herdProfile') === 'cow') ? 'cow' : 'buffalo'; }
  function setProfile(p){ localStorage.setItem('herdProfile', p); }
  function syncToggle(){
    const p = getProfile();
    herdCow?.classList.toggle('active', p==='cow');
    herdBuffalo?.classList.toggle('active', p==='buffalo');
  }

  const GEO = {
    'مصر:القاهرة': {lat:30.0444, lon:31.2357},
    'مصر:الجيزة':  {lat:30.0131, lon:31.2089},
    'مصر:الإسكندرية': {lat:31.2001, lon:29.9187},
    'السعودية:الرياض': {lat:24.7136, lon:46.6753},
    'السعودية:مكة المكرمة': {lat:21.3891, lon:39.8579},
    'الإمارات:دبي': {lat:25.2048, lon:55.2708},
    'قطر:الدوحة': {lat:25.2854, lon:51.5310},
    'الكويت:العاصمة': {lat:29.3759, lon:47.9774},
    'البحرين:العاصمة': {lat:26.2235, lon:50.5876},
    'عُمان:مسقط': {lat:23.5880, lon:58.3829}
  };

  function THI(c, rh){
    const f = c*9/5 + 32;
    return Math.round(((f - (0.55 - 0.0055*rh)*(f - 58)))*10)/10;
  }

  function bands(){
    return getProfile()==='cow' ? {t1:68,t2:72,t3:79,t4:84} : {t1:66,t2:70,t3:77,t4:82};
  }
  function colorAndText(thi, b){
    let txt;
    if (thi < b.t1) txt='مريح';
    else if (thi < b.t2) txt='اجهاد خفيف';
    else if (thi < b.t3) txt='اجهاد متوسط';
    else if (thi < b.t4) txt='اجهاد شديد';
    else txt='اجهاد شديد جدا';

    let bg;
    if (thi < b.t1) bg='#c8e6c9';
    else if (thi < b.t2) bg='#fff9c4';
    else if (thi < b.t3) bg='#ffe0b2';
    else if (thi < b.t4) bg='#ffccbc';
    else bg='#ffcdd2';
    return {bg, txt};
  }

  function saveCache(key, data){ localStorage.setItem('weather:'+key, JSON.stringify({...data, ts:Date.now()})); }
  function loadCache(key){ try{ const o=JSON.parse(localStorage.getItem('weather:'+key)||'null'); return o && (Date.now()-o.ts)<3600000 ? o : null;}catch{ return null; } }

  async function fetchWeather(lat, lon){
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=Africa%2FCairo`;
      const r = await fetch(url); const j = await r.json();
      return { t: j.current?.temperature_2m, h: j.current?.relative_humidity_2m };
    }catch{ return null; }
  }

  async function renderWeather(force=false){
    let data = !force && loadCache(key);
    if(!data){
      const coords = GEO[key];
      if(!coords){ return; }
      data = await fetchWeather(coords.lat, coords.lon);
      if(data && data.t!=null && data.h!=null) saveCache(key, data);
    }
    if(!data){ return; }

    const b = bands();
    // حدّث العناوين أسفل الشريط
    if (thiL1) thiL1.textContent = b.t1;
    if (thiL2) thiL2.textContent = b.t2;
    if (thiL3) thiL3.textContent = b.t3;
    if (thiL4) thiL4.textContent = b.t4;

    const thi = THI(data.t, data.h);
    const {bg, txt} = colorAndText(thi, b);

    // تحديث عدّاد الساعة (دائري)
    const minTHI=50, maxTHI=90;
    const pct = v => ((v - minTHI) * 100 / (maxTHI - minTHI));
    if (thiArc){
      const minTHI=50, maxTHI=90;
      const pct = v => ((v - minTHI) * 100 / (maxTHI - minTHI));
      const arcSpanPct = 240/360*100; // ثلثا الساعة العلويان
      const pArc = v => (pct(v)/100) * arcSpanPct;
      const p1 = pArc(b.t1), p2 = pArc(b.t2), p3 = pArc(b.t3);
      thiArc.style.background = `conic-gradient(from -120deg,
        #90caf9 0% ${p1}%,
        #fff59d ${p1}% ${p2}%,
        #ffcc80 ${p2}% ${p3}%,
        #ef5350 ${p3}% ${arcSpanPct}%,
        transparent ${arcSpanPct}% 100%)`;
    }
    if (thiNeedle){
      const minTHI=50, maxTHI=90;
      const pct = v => ((v - minTHI) * 100 / (maxTHI - minTHI));
      const p = Math.max(0, Math.min(100, pct(thi)));
      const angle = -120 + (p * 2.4); // 0→100% عبر 240°
      thiNeedle.style.setProperty('--angle', angle + 'deg');
    }

    chip.style.background = bg;
    wTemp.textContent = `${Math.round(data.t)}°C`;
    wHum.textContent  = `${Math.round(data.h)}%`;
    wTHI.textContent  = thi;
    wState.textContent= txt;
  }

  // أحداث
  window.renderWeather = renderWeather; // للزر تحديث
  document.addEventListener('DOMContentLoaded', ()=> { syncToggle(); renderWeather(); });
  wRefresh.addEventListener('click', ()=> { renderWeather(true); showTip(); });
  herdCow?.addEventListener('click', ()=>{ setProfile('cow'); syncToggle(); renderWeather(true); });
  herdBuffalo?.addEventListener('click', ()=>{ setProfile('buffalo'); syncToggle(); renderWeather(true); });
  if (thiMarker){ thiMarker.addEventListener('mouseenter', showTip); thiMarker.addEventListener('mouseleave', hideTip); thiMarker.addEventListener('touchstart', (e)=>{ e.preventDefault(); showTip(); }, {passive:false}); }
})();
</script>

<script type="module">
  const veBtn = document.getElementById('milkTraitsCard');
  veBtn?.addEventListener('click', () => {
    const qs  = new URLSearchParams(location.search);
    const id  = qs.get('animalId')
               || localStorage.getItem('currentAnimalId')
               || localStorage.getItem('lastAnimalId')
               || '';
    const url = id ? `visual-eval.html?focus=milk&animalId=${encodeURIComponent(id)}` : `visual-eval.html?focus=milk`;
    location.href = url;
  });
</script>

<script>
(function(){
  function todayCairo(){
    const now = new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'}));
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function buildQS(base){
    const qs = new URLSearchParams();
    const id     = localStorage.getItem('currentAnimalId')     || '';
    const number = localStorage.getItem('currentAnimalNumber') || '';
    const date   = localStorage.getItem('currentEventDate')    || todayCairo();

    if (id)     qs.set('animalId', id);
    if (number) qs.set('number', number);
    if (date)   qs.set('date', date);

    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      qs.set('demo','1');
    }
    return base + '?' + qs.toString();
  }

  // اختيارات داخل بلاطة "تقييم التغذية الذكي"
  const fecesBtn  = document.getElementById('goFeces');
  if(fecesBtn){
    const go = ()=> location.href = buildQS('feces-eval.html');
    fecesBtn.addEventListener('click', go);
  }
  const bcsBtn    = document.getElementById('goBCS');
  if(bcsBtn){
    const go = ()=> location.href = buildQS('bcs-eval.html');
    bcsBtn.addEventListener('click', go);
  }
  const rationBtn = document.getElementById('goRation');
  if(rationBtn){
    const go = ()=> location.href = 'smart-feeding.html';
    rationBtn.addEventListener('click', go);
  }
})();
</script>

</body>
</html>
