<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>

  <link rel="stylesheet" href="css/forms.css">
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1b5e20"/>

  <style>
    :root{--bg:#fff9db;--card:#fff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:#1b5e20}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .tile{position:relative;background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;padding:16px;text-align:center;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;min-height:118px}
    .tile .icon{display:block;width:44px;height:44px;line-height:44px;border-radius:50%;border:1px solid var(--border);font-size:24px;margin-bottom:6px}
    .tile .badge{position:absolute;top:8px;left:8px;background:#f7fff4;border:1px solid var(--border);color:#335c33;border-radius:999px;padding:2px 8px;font-size:11px}
    @media(max-width:560px){.dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}.tile{min-height:110px;padding:14px}}

    /* ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ (ÙƒÙ…Ø§ Ù‡Ùˆ) */
    #weatherClassic{background:#ffe3e8;border:1.5px solid #ffccd5;border-radius:16px;padding:12px;margin-bottom:8px}
    #weatherClassic .bar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    #weatherClassic .seg{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    #weatherClassic .seg.active{background:#2e7d32;color:#fff}
    #weatherClassic .btn{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:8px;padding:4px 10px;font-size:12px;cursor:pointer}
    #weatherClassic .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    #weatherClassic .pill{background:#f7fff4;border:1px solid #c5e1a5;border-radius:12px;padding:8px;text-align:center}
    #weatherClassic .pill b{display:block;margin-top:4px}
    #weatherClassic .right{grid-row:1 / span 3;grid-column:2;display:flex;align-items:center;justify-content:center}
    .thi-clock{position:relative;width:160px;height:160px}
    .thi-clock .dial{position:absolute;inset:0;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .thi-clock .arc{position:absolute;inset:0;border-radius:50%;-webkit-mask:radial-gradient(farthest-side,transparent 55%, #000 56%);mask:radial-gradient(farthest-side,transparent 55%, #000 56%)}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);-webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .needle{position:absolute;left:50%;top:50%;width:2px;height:42%;background:#000;transform-origin:bottom center;transform:translate(-50%,-100%) rotate(var(--angle,-120deg));border-radius:2px;transition:transform .9s cubic-bezier(.22,.8,.2,1)}
    .thi-clock .needle::after{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:inherit}
    .thi-clock .center{position:absolute;left:50%;top:50%;width:8px;height:8px;border-radius:50%;background:#000;transform:translate(-50%,-50%)}

    /* ÙÙ„Ø§ØªØ± Ø§Ù„Ù†ÙˆØ¹ (Ø§Ù„Ø®ÙŠØ§Ø± A) */
    #speciesFilter{text-align:center;margin:10px 0}
    #speciesFilter .filter-btn{background:#fff;border:2px solid var(--green);color:var(--green);padding:6px 14px;border-radius:12px;cursor:pointer;font-weight:bold;margin:0 4px;font-size:15px}
    #speciesFilter .filter-btn.active{background:var(--green);color:#fff}

    /* Ø­Ù„Ù‚Ø§Øª KPIs */
    .section{margin-top:12px}
    .section .title{font-weight:900;color:#1b5e20;margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .kpi{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px;min-height:72px}
    .kpi-ring svg{width:60px;height:60px;display:block}
    .kpi-ring circle.bg{fill:none;stroke:#e0e0e0;stroke-width:6}
    .kpi-ring circle.fg{fill:none;stroke:#2e7d32;stroke-width:6;stroke-linecap:round;stroke-dasharray:113.097;stroke-dashoffset:113.097;transform:rotate(-90deg);transform-origin:22px 22px;transition:stroke-dashoffset .7s ease, stroke .3s ease}
    .kpi-title{font-weight:800;color:#1b5e20;font-size:13px}
    .kpi-value{font-weight:900;font-size:20px;color:#065f46;line-height:1}
    .kpi-sub{font-size:11px;color:#4f5b62}
  </style>
</head>
<body>
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>

  <!-- ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ (ÙƒÙ…Ø§ Ù‡Ùˆ) -->
  <div id="weatherClassic" class="card" aria-label="Ø§Ù„Ø·Ù‚Ø³ Ùˆ Ù…Ø¤Ø´Ø± THI">
    <div class="bar">
      <button class="btn" id="wxRefresh" type="button">ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn" id="wxPin" type="button">Ø«Ø¨Ù‘Øª</button>
      <span style="margin-inline-start:auto;font-weight:bold;">Ø§Ù„Ù…ÙˆØ¶Ø¹</span>
      <button class="seg" id="segFarm" type="button">Ù…Ø²Ø±Ø¹ØªÙŠ</button>
      <button class="seg" id="segGPS" type="button">Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>
    <div class="grid">
      <div class="pill"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wxTemp">â€”Â°C</b></div>
      <div class="right">
        <div class="thi-clock">
          <div class="dial"><div id="thiArc" class="arc"></div></div>
          <div id="thiNeedle" class="needle"></div>
          <div class="center"></div>
        </div>
      </div>
      <div class="pill"><div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wxHum">â€”%</b></div>
      <div class="pill"><div>THI</div><b id="wxTHI">â€”</b></div>
      <div class="pill" style="grid-column:1 / span 2"><div>Ø§Ù„Ø­Ø§Ù„Ø©</div><b id="wxState">â€”</b></div>
    </div>
  </div>

  <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ù†ÙˆØ¹ (Ø§Ù„Ø®ÙŠØ§Ø± A: Ø£Ø³ÙÙ„ Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ù…Ø¨Ø§Ø´Ø±Ø©) -->
  <div id="speciesFilter">
    <button class="filter-btn active" data-species="all">ğŸ„ğŸƒ Ø§Ù„ÙƒÙ„</button>
    <button class="filter-btn" data-species="cow">ğŸ„ Ø£Ø¨Ù‚Ø§Ø±</button>
    <button class="filter-btn" data-species="buffalo">ğŸƒ Ø¬Ø§Ù…ÙˆØ³</button>
  </div>

  <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙƒÙ…Ø§ Ù‡ÙŠ -->
  <div class="dashboard">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">ğŸ®</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>
    <div class="tile" onclick="location.href='groups.html'"><span class="icon">ğŸ‘¥</span>Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø±Ø¨ÙŠÙƒ</div>
    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="tile" id="sensorsTile" role="button" tabindex="0">
      <span class="icon">ğŸ›°ï¸</span> Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª
      <span class="badge" id="sensorsStatus">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦</span>
    </div>
    <div class="tile" role="button" tabindex="0" onclick="location.href='nutrition-eval.html'">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ©</div>
  </div>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹: ØªÙ†Ø§Ø³Ù„ÙŠ -->
  <div class="card section" id="sec-repro">
    <div class="title">ğŸ§¬ Ù…Ø¤Ø´Ø±Ø§Øª ØªÙ†Ø§Ø³Ù„ÙŠØ©</div>
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-pregRate21" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ù…Ù„ 21ÙŠ</div><div class="kpi-value" id="v-pregRate21">â€”%</div><div class="kpi-sub">SRÃ—CR Ø®Ù„Ø§Ù„ 21 ÙŠÙˆÙ…</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-conception" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø®ØµØ§Ø¨ (CR)</div><div class="kpi-value" id="v-conception">â€”%</div><div class="kpi-sub">Ù†Ø¬Ø§Ø­ Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-spc" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª Ù„ÙƒÙ„ Ø­Ù…Ù„</div><div class="kpi-value" id="v-spc">â€”</div><div class="kpi-sub">Services/Conception</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-openDays" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©</div><div class="kpi-value" id="v-openDays">â€”</div><div class="kpi-sub">Ù…Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ù„Ù„Ø­Ù…Ù„</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-ci" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">ÙØ§ØµÙ„ ÙˆÙ„Ø§Ø¯ØªÙŠÙ†</div><div class="kpi-value" id="v-ci">â€” ÙŠÙˆÙ…</div><div class="kpi-sub">Calving Interval</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-abortion" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶</div><div class="kpi-value" id="v-abortion">â€”%</div><div class="kpi-sub">Ø¢Ø®Ø± 12 Ø´Ù‡Ø±</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-deadCalv" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">ÙˆÙ„Ø§Ø¯Ø§Øª Ù†Ø§ÙÙ‚Ø©</div><div class="kpi-value" id="v-deadCalv">â€”%</div><div class="kpi-sub">Ø¢Ø®Ø± 12 Ø´Ù‡Ø±</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-afc" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ø§Ù„Ø¹Ù…Ø± Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ÙˆÙ„Ø§Ø¯Ø©</div><div class="kpi-value" id="v-afc">â€” Ø´Ù‡Ø±</div><div class="kpi-sub">Heifers ÙÙ‚Ø·</div></div></div>
    </div>
  </div>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹: Ø¥Ù†ØªØ§Ø¬ÙŠ -->
  <div class="card section" id="sec-prod">
    <div class="title">ğŸ¼ Ù…Ø¤Ø´Ø±Ø§Øª Ø¥Ù†ØªØ§Ø¬ÙŠØ©</div>
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-milkAvg" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ù…ØªÙˆØ³Ø· Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</div><div class="kpi-value" id="v-milkAvg">â€” ÙƒØ¬Ù…</div><div class="kpi-sub">Ù„ÙƒÙ„ Ø±Ø£Ø³ ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-milkTotal" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</div><div class="kpi-value" id="v-milkTotal">â€” ÙƒØ¬Ù…</div><div class="kpi-sub" id="v-milkTrend">â€” Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø£Ù…Ø³</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-inMilkPct" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨</div><div class="kpi-value" id="v-inMilkPct">â€”%</div><div class="kpi-sub" id="v-inMilkCount">â€” Ø±Ø£Ø³</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-dim" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ù…ØªÙˆØ³Ø· DIM</div><div class="kpi-value" id="v-dim">â€”</div><div class="kpi-sub">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨</div></div></div>
    </div>
  </div>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹: Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ -->
  <div class="card section" id="sec-cull">
    <div class="title">ğŸšª Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯</div>
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-cull-prod" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø¥Ù†ØªØ§Ø¬ÙŠ</div><div class="kpi-value" id="v-cull-prod">â€”%</div><div class="kpi-sub">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ø§Øª</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-cull-repro" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØªÙ†Ø§Ø³Ù„ÙŠ</div><div class="kpi-value" id="v-cull-repro">â€”%</div><div class="kpi-sub">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ø§Øª</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-cull-health" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØµØ­ÙŠ</div><div class="kpi-value" id="v-cull-health">â€”%</div><div class="kpi-sub">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ø§Øª</div></div></div>
    </div>
  </div>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹: Ø§Ù„ØªØºØ°ÙŠØ© -->
  <div class="card section" id="sec-nutri">
    <div class="title">ğŸ¥— Ù…Ø¤Ø´Ø±Ø§Øª ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØºØ°ÙŠØ©</div>
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-fce" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù„Ù â†’ Ù„Ø¨Ù†</div><div class="kpi-value" id="v-fce">â€”</div><div class="kpi-sub">ÙƒØ¬Ù… Ù„Ø¨Ù†/ÙƒØ¬Ù… Ù…Ø§Ø¯Ø© Ø¬Ø§ÙØ©</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-dmi" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø§ÙØ© Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø©</div><div class="kpi-value" id="v-dmi">â€”%</div><div class="kpi-sub">% Ù…Ù† ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù…</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-iofc" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">ØµØ§ÙÙŠ Ø¯Ø®Ù„ Ø§Ù„Ù„Ø¨Ù† (IOFC)</div><div class="kpi-value" id="v-iofc">â€”</div><div class="kpi-sub">(Ø³Ø¹Ø±Ã—Ø¥Ù†ØªØ§Ø¬)âˆ’ØªÙƒÙ„ÙØ© Ø§Ù„ØªØºØ°ÙŠØ©</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-feces" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø±ÙˆØ«</div><div class="kpi-value" id="v-feces">â€”</div><div class="kpi-sub">Ù…ØªÙˆØ³Ø· Ø¢Ø®Ø± Ø£Ø³Ø¨ÙˆØ¹</div></div></div>
      <div class="kpi"><div class="kpi-ring"><svg viewBox="0 0 44 44"><circle class="bg" cx="22" cy="22" r="18"/><circle id="r-bcs" class="fg" cx="22" cy="22" r="18"/></svg></div><div><div class="kpi-title">BCS Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div><div class="kpi-value" id="v-bcs">â€”</div><div class="kpi-sub">Ù…ØªÙˆØ³Ø· Ø¢Ø®Ø± Ù‚ÙŠØ§Ø³</div></div></div>
    </div>
  </div>

  <!-- Ø§Ù„Ø·Ù‚Ø³ (ÙƒÙ…Ø§ Ù‡Ùˆ) -->
  <script>
    (function(){
      const box=document.getElementById('weatherClassic');
      const tEl=wxTemp, hEl=wxHum, thiEl=wxTHI, sEl=wxState, thiArc=document.getElementById('thiArc'), thiNeedle=document.getElementById('thiNeedle');
      const btnRefresh=wxRefresh, btnPin=wxPin, segFarm=segFarm, segGPS=segGPS;
      if(!box) return;
      const DEF={lat:30.0444,lon:31.2357,place:'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©'};
      const LS_PIN='mbk_farm', LS_WX='mbk_wx_cache', LS_REG='mbk_reg_geo';
      let mode='reg', pinned=null;

      function THI(c,rh){ const f=c*9/5+32; return Math.round(((f-(0.55-0.0055*rh)*(f-58)))*10)/10; }
      // Ø­Ø³Ø§Ø³ÙŠØ© Ø£Ø¨Ø³Ø· Ù„Ù„Ø¬Ø§Ù…ÙˆØ³: Ù†Ø­Ø±Ùƒ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø¯Ø±Ø¬ØªÙŠÙ† Ù„Ø£Ø³ÙÙ„
      function bandsFor(species){ const base={t1:66,t2:70,t3:77,t4:82}; if(species==='buffalo') return {t1:64,t2:68,t3:75,t4:80}; return base; }
      // species Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„ÙÙ„ØªØ±
      function currentSpecies(){ const a=document.querySelector('#speciesFilter .filter-btn.active'); return a?.dataset?.species||'all'; }
      function colorAndText(thi,s){
        const b=bandsFor(s);
        if(thi<b.t1) return {bg:'#c8e6c9',txt:'Ù…Ø±ÙŠØ­'};
        if(thi<b.t2) return {bg:'#fff9c4',txt:'Ø¥Ø¬Ù‡Ø§Ø¯ Ø®ÙÙŠÙ'};
        if(thi<b.t3) return {bg:'#ffe0b2',txt:'Ø¥Ø¬Ù‡Ø§Ø¯ Ù…ØªÙˆØ³Ø·'};
        if(thi<b.t4) return {bg:'#ffccbc',txt:'Ø¥Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯'};
        return {bg:'#ffcdd2',txt:'Ø¥Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯ Ø¬Ø¯Ù‹Ø§'};
      }
      function drawTHI(thi){
        thiArc.style.background='conic-gradient(from -120deg,#90caf9 0% 25%,#fff59d 25% 50%,#ffcc80 50% 75%,#ef5350 75% 100%)';
        const ang=-120+((thi-50)/40)*240; thiNeedle.style.setProperty('--angle',ang+'deg');
        const {bg,txt}=colorAndText(thi,currentSpecies()); box.style.background=bg; sEl.textContent=txt;
      }
      const readJSON=k=>{try{return JSON.parse(localStorage.getItem(k)||'null')}catch{return null}};
      const writeJSON=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
      function readTenantAddress(){const T=window.__TENANT__||{};return{country:T.country||T.address?.country,region:T.region||T.address?.region,city:T.city||T.address?.city}}
      function regKey(a){return [a.city,a.region,a.country].filter(Boolean).join('|').toLowerCase()||'default'}
      async function geocodeFromRegistration(){const addr=readTenantAddress();if(!addr.country&&!addr.region&&!addr.city) return null; const key=regKey(addr); const c=readJSON(LS_REG); if(c&&c.key===key&&c.lat&&c.lon) return c; try{const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent([addr.city,addr.region,addr.country].filter(Boolean).join(', '))}&count=1&language=ar`); const j=await r.json(); const it=j?.results?.[0]; if(it){const res={lat:it.latitude,lon:it.longitude,place:[it.name,it.admin1,it.country].filter(Boolean).join('ØŒ '),key}; writeJSON(LS_REG,res); return res}}catch{} return null}
      function getPinned(){return readJSON(LS_PIN)}
      function savePinned(lat,lon,place){writeJSON(LS_PIN,{lat,lon,place:place||'Ù…Ø²Ø±Ø¹ØªÙŠ'})}
      function getGPS(){return new Promise(res=>{if(!navigator.geolocation) return res(null); navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lon:p.coords.longitude,place:'Ù…ÙˆÙ‚Ø¹ÙŠ'}),_=>res(null),{enableHighAccuracy:true,timeout:5000})})}
      async function pickCoords(){ if(pinned) return pinned; if(mode==='gps'){const g=await getGPS(); if(g) return g} const reg=await geocodeFromRegistration(); if(reg) return reg; return DEF }
      function wxGetCached(){const x=readJSON(LS_WX); if(x&&Date.now()-x.ts<60000) return x.data; return null}
      function wxSetCached(d){writeJSON(LS_WX,{ts:Date.now(),data:d})}
      async function fetchWeather(lat,lon){const cached=wxGetCached(); if(cached&&typeof cached.t==='number'&&typeof cached.h==='number') return cached; try{const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`,{cache:'no-store'}); const j=await r.json(); const d={t:j.current?.temperature_2m,h:j.current?.relative_humidity_2m}; if(typeof d.t==='number'&&typeof d.h==='number') wxSetCached(d); return d}catch{return null}}
      function activate(w){segFarm.classList.toggle('active',w==='reg'); segGPS.classList.toggle('active',w==='gps')}
      async function render(){const c=await pickCoords(); const d=await fetchWeather(c.lat,c.lon); if(!d){wxTemp.textContent='â€”Â°C'; wxHum.textContent='â€”%'; wxTHI.textContent='â€”'; wxState.textContent='â€”'; return} const t=Math.round(d.t), h=Math.round(d.h), thi=THI(t,h); wxTemp.textContent=`${t}Â°C`; wxHum.textContent=`${h}%`; wxTHI.textContent=thi; drawTHI(thi)}
      async function boot(){pinned=getPinned()||null; mode='reg'; activate('reg'); segFarm.addEventListener('click',()=>{mode='reg';activate('reg');render()}); segGPS.addEventListener('click',()=>{mode='gps';activate('gps');render()}); wxRefresh.addEventListener('click',render); wxPin.addEventListener('click',async()=>{mode='gps';const g=await getGPS(); if(g){savePinned(g.lat,g.lon,g.place); pinned=g} mode='reg';activate('reg');render()}); render()}
      document.addEventListener('DOMContentLoaded', boot);
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†ÙˆØ¹
      document.getElementById('speciesFilter').addEventListener('click', (e)=>{ if(e.target.classList.contains('filter-btn')) render(); });
    })();
  </script>

  <!-- Ù†ÙˆØ§Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø¹Ø¨Ø± /api/herd-stats -->
  <script>
    // ============= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© =============
    const ringLen = 113.097;
    const $ = (s)=>document.querySelector(s);
    const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
    function setRing(id, pct, palette='up'){
      const el = document.getElementById(id); if(!el) return;
      const p = isFinite(pct)? clamp(pct,0,100) : 0;
      el.style.strokeDashoffset = (ringLen*(1-p/100)).toFixed(2);
      let c = '#2e7d32';
      if(palette==='down'){ // Ø§Ù„Ø£Ù‚Ù„ Ø£ÙØ¶Ù„
        if(p<=80) c='#2e7d32'; else if(p<=120) c='#fdd835'; else if(p<=150) c='#ef6c00'; else c='#c62828';
      }else{ // Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„
        if(p>=80) c='#2e7d32'; else if(p>=60) c='#7cb342'; else if(p>=40) c='#fdd835'; else if(p>=20) c='#ef6c00'; else c='#c62828';
      }
      el.style.stroke = c;
    }
    function setText(sel,val,suffix=''){const el=$(sel); if(!el) return; el.textContent=(val==null||val==='')?'â€”':(val+suffix)}

    // ============= ÙÙ„ØªØ± Ø§Ù„Ù†ÙˆØ¹ =============
    let species='all';
    document.querySelectorAll('#speciesFilter .filter-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('#speciesFilter .filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        species = btn.dataset.species;
        pullAndRender();
      });
    });

    // ============= Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª =============
    let timer=null;
    async function pullAndRender(){
      try{
        // ÙŠÙÙØªØ±Ø¶ Ø£Ù† tenant-bootstrap ÙŠØ­Ù‚Ù† Ø§Ù„Ù‡ÙˆÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ø§Ù„Ù‡ÙŠØ¯Ø± X-User-Id)
        const r = await fetch(`/api/herd-stats?species=${species}`, {cache:'no-store'});
        const j = await r.json();

        // ØªÙ†Ø§Ø³Ù„ÙŠ
        const R = j.repro || {};
        setText('#v-pregRate21', R.pregnancyRate21, '%');   setRing('r-pregRate21', R.pregnancyRate21);
        setText('#v-conception', R.conceptionRate, '%');     setRing('r-conception', R.conceptionRate);
        setText('#v-spc', R.servicesPerConception);          setRing('r-spc', R.servicesPerConception? clamp(100 - (Math.max(1,Math.min(5,Number(R.servicesPerConception)))-1)*20,0,100):0, 'down');
        setText('#v-openDays', R.avgOpenDays);               setRing('r-openDays', R.avgOpenDays? clamp(150 - Math.min(150,R.avgOpenDays),0,100):0, 'down');
        setText('#v-ci', R.calvingInterval? (R.calvingInterval+' ÙŠÙˆÙ…') : null); setRing('r-ci', R.calvingInterval? clamp(500 - Math.min(500,R.calvingInterval),0,100):0, 'down');
        setText('#v-abortion', R.abortionRate, '%');         setRing('r-abortion', (R.abortionRate!=null)? (100 - R.abortionRate) : 0, 'down');
        setText('#v-deadCalv', R.deadCalvingRate, '%');      setRing('r-deadCalv', (R.deadCalvingRate!=null)? (100 - R.deadCalvingRate) : 0, 'down');
        setText('#v-afc', R.ageFirstCalvingMonths? (R.ageFirstCalvingMonths+' Ø´Ù‡Ø±'): null); setRing('r-afc', R.ageFirstCalvingMonths? clamp(36*3 - Math.min(36*3,R.ageFirstCalvingMonths*3),0,100):0, 'down');

        // Ø¥Ù†ØªØ§Ø¬ÙŠ
        const P = j.production || {};
        setText('#v-milkAvg', (P.avgDailyMilk!=null)? P.avgDailyMilk.toFixed?.(1) ?? P.avgDailyMilk : null, ' ÙƒØ¬Ù…'); setRing('r-milkAvg', clamp((Number(P.avgDailyMilk)||0)*3,0,100));
        setText('#v-milkTotal', P.totalDailyMilk, ' ÙƒØ¬Ù…');   setRing('r-milkTotal', clamp((Number(P.totalDailyMilk)||0)*0.5,0,100));
        setText('#v-inMilkPct', P.inMilkPct, '%');           setRing('r-inMilkPct', P.inMilkPct);
        setText('#v-inMilkCount', P.inMilkCount? (P.inMilkCount+' Ø±Ø£Ø³'): null);
        setText('#v-dim', P.avgDIM);                         setRing('r-dim', P.avgDIM? clamp(200 - Math.min(200,P.avgDIM),0,100):0, 'down');
        setText('#v-milkTrend', (P.trendVsYesterdayPct==null)? 'â€”' : (P.trendVsYesterdayPct>0? `â†‘ ${P.trendVsYesterdayPct}%` : (P.trendVsYesterdayPct<0? `â†“ ${Math.abs(P.trendVsYesterdayPct)}%` : 'Ø«Ø§Ø¨Øª 0%')));

        // Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯
        const C = j.culling || {};
        setText('#v-cull-prod', C.production, '%'); setRing('r-cull-prod', (C.production??0), 'down');
        setText('#v-cull-repro', C.reproductive, '%'); setRing('r-cull-repro', (C.reproductive??0), 'down');
        setText('#v-cull-health', C.health, '%'); setRing('r-cull-health', (C.health??0), 'down');

        // Ø§Ù„ØªØºØ°ÙŠØ©
        const N = j.nutrition || {};
        setText('#v-fce', N.feedToMilkEfficiency); setRing('r-fce', N.feedToMilkEfficiency? clamp(Number(N.feedToMilkEfficiency)*50,0,100):0);
        setText('#v-dmi', N.dmiPctBW, '%');        setRing('r-dmi', N.dmiPctBW? clamp(Number(N.dmiPctBW)*10,0,100):0);
        setText('#v-iofc', N.iofc, ' Ø¬Ù†ÙŠÙ‡/Ø±Ø£Ø³');  setRing('r-iofc', N.iofc? clamp(50 + Math.min(50, Number(N.iofc)/10),0,100):0);
        setText('#v-feces', N.fecesScoreAvg);
        setText('#v-bcs', N.bcsAvg);

      }catch(e){
        console.warn('herd-stats fetch error', e);
      }finally{
        clearTimeout(timer);
        timer = setTimeout(pullAndRender, 60000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
      }
    }

    // Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„
    document.addEventListener('DOMContentLoaded', pullAndRender);
  </script>

  <!-- Ø£Ø³Ø§Ø³ÙŠØ§ØªÙƒ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© -->
  <script src="/js/tenant-bootstrap.js"></script>
  <script type="module" src="/js/app-core.js"></script>

  <!-- ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª ÙƒÙ…Ø§ Ù‡Ùˆ -->
  <script>
    (function(){
      const tile=document.getElementById('sensorsTile');
      const badge=document.getElementById('sensorsStatus');
      function setBadge(txt,ok){ if(!badge) return; badge.textContent=txt; badge.style.background=ok?'#e8f5e9':'#fff8e1'; badge.style.borderColor=ok?'#c5e1a5':'#ffecb3'; }
      async function ping(){
        try{
          setBadge('Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦',false);
          const r=await fetch('/api/sensors/health');
          if(!r.ok){ setBadge('ØºÙŠØ± Ù…ØªØµÙ„',false); return; }
          const j=await r.json();
          setBadge(`Ù…ØªØµÙ„ â€¢ ${Number(j?.devices||0)}`,true);
        }catch{ setBadge('ØºÙŠØ± Ù…ØªØµÙ„',false); }
      }
      tile?.addEventListener('click',()=>{ location.href='sensor-test.html'; });
      document.addEventListener('DOMContentLoaded',()=>{ ping(); setInterval(ping,60000); });
    })();
  </script>
</body>
</html>
