<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>
<link rel="stylesheet" href="css/forms.css">
<link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#1b5e20"/>

<style>
:root{--bg:#fff9db;--card:#fff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
*{box-sizing:border-box}
html,body{overflow-x:hidden}
body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
h1{margin:0 0 16px;text-align:center;color:#1b5e20;font-weight:900}

/* ÙƒØ§Ø±Øª Ø¹Ø§Ù… */
.card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-top:12px}

/* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª */
.dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.tile{position:relative;background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
  padding:16px;text-align:center;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:6px;min-height:118px}
.tile .icon{display:block;width:44px;height:44px;line-height:44px;border-radius:50%;border:1px solid var(--border);font-size:24px;margin-bottom:6px}

/* ====== ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (THI Clock) ====== */
#weatherClassic{background:#ffe3e8;border:1.5px solid #ffccd5;border-radius:16px;padding:12px}
#weatherClassic .bar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
#weatherClassic .seg{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
#weatherClassic .seg.active{background:#2e7d32;color:#fff}
#weatherClassic .btn{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:8px;padding:4px 10px;font-size:12px;cursor:pointer}
#weatherClassic .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
#weatherClassic .pill{background:#f7fff4;border:1px solid #c5e1a5;border-radius:12px;padding:8px;text-align:center}
#weatherClassic .pill b{display:block;margin-top:4px}
#weatherClassic .right{grid-row:1 / span 3;grid-column:2;display:flex;align-items:center;justify-content:center}
.thi-clock{position:relative;width:180px;height:180px}
.thi-clock .dial{position:absolute;inset:0;border-radius:50%;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.1)}
.thi-clock .arc{position:absolute;inset:0;border-radius:50%;
  -webkit-mask:radial-gradient(farthest-side,transparent 55%, #000 56%);
          mask:radial-gradient(farthest-side,transparent 55%, #000 56%)}
.thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;
  background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);
  -webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);
          mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
.thi-clock .needle{position:absolute;left:50%;top:50%;width:2px;height:42%;background:#000;transform-origin:bottom center;
  transform:translate(-50%,-100%) rotate(var(--angle,-120deg));border-radius:2px;transition:transform .9s cubic-bezier(.22,.8,.2,1)}
.thi-clock .needle::after{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:8px;height:8px;border-radius:50%;background:inherit}
.thi-clock .center{position:absolute;left:50%;top:50%;width:10px;height:10px;border-radius:50%;background:#000;transform:translate(-50%,-50%)}

/* KPIs Ø§Ù„Ø­Ù„Ù‚ÙŠØ© Ø§Ù„Ù…Ø®ØªØµØ±Ø© */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.kpi{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px;min-height:72px}
.kpi-ring{flex:0 0 auto}
.kpi-ring svg{width:60px;height:60px;display:block}
.kpi-ring circle.bg{fill:none;stroke:#e0e0e0;stroke-width:6}
.kpi-ring circle.fg{fill:none;stroke:#2e7d32;stroke-width:6;stroke-linecap:round;stroke-dasharray:113.097;stroke-dashoffset:113.097;transform:rotate(-90deg);transform-origin:22px 22px;transition:stroke-dashoffset .7s ease, stroke .3s ease}
.kpi-body{display:flex;flex-direction:column;gap:2px}
.kpi-title{font-weight:800;color:#1b5e20;font-size:13px}
.kpi-value{font-weight:900;font-size:20px;color:#065f46;line-height:1}
.kpi-sub{font-size:11px;color:#4f5b62}
.kpi:hover{transform:translateY(-1px);box-shadow:0 2px 10px rgba(0,0,0,.06)}

/* ØªØ¨ÙˆÙŠØ¨Ø§Øª */
.tabs{display:flex;gap:8px;margin:14px 0 10px;overflow:auto}
.tab-btn{padding:6px 14px;border-radius:999px;background:#e8f5e9;border:1px solid #c5e1a5;color:#2e7d32;font-weight:700;white-space:nowrap;cursor:pointer}
.tab-btn.active{background:#2e7d32;color:#fff;border-color:#2e7d32}
.tab-content{display:none}
.tab-content.active{display:block}

/* Toggle Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹ */
.herd-type{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.herd-type .opt{padding:6px 14px;border-radius:999px;border:1px solid #c5e1a5;background:#fff;color:#2e7d32;font-weight:700;cursor:pointer}
.herd-type .opt.active{background:#2e7d32;color:#fff;border-color:#2e7d32}
.badge{display:inline-block;border:1px solid #c5e1a5;border-radius:999px;padding:2px 8px;font-size:11px;background:#fff}

@media(max-width:560px){
  .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
  .tile{min-height:110px;padding:14px}
  .tile-m-full{grid-column:1 / -1}
}

/* ===== Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¥Ø¨Ø±Ø© (ÙƒÙ„ 2 ÙÙŠ ØµÙ) ===== */
.gauges-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:8px;text-align:center}
.gauge-title{font-weight:800;margin-bottom:4px;font-size:15px;color:#1b5e20}
.gauge canvas{width:140px;height:140px;max-width:100%}
.gauge-read{margin-top:6px;font-size:14px;font-weight:bold;color:#064e3b}
.gauge-value{font-size:20px;margin-inline-end:6px;color:#064e3b}
.gauge-desc{font-size:13px}
@media(max-width:560px){ .gauges-grid{grid-template-columns:1fr 1fr} }
</style>

<!-- Ù…ÙƒØªØ¨Ø© Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¨Ø±Ø© -->
<script src="https://cdn.jsdelivr.net/npm/canvas-gauges@2.1.7/dist/gauge.min.js"></script>
</head>
<body>
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>

  <!-- ================== ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ================== -->
  <div id="weatherClassic" class="card" aria-label="Ø§Ù„Ø·Ù‚Ø³ Ùˆ Ù…Ø¤Ø´Ø± THI">
    <div class="bar">
      <button class="btn" id="wxRefresh" type="button">ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn" id="wxPin" type="button">Ø«Ø¨Ù‘Øª</button>
      <span style="margin-inline-start:auto;font-weight:bold;">Ø§Ù„Ù…ÙˆØ¶Ø¹</span>
      <button class="seg" id="segFarm" type="button">Ù…Ø²Ø±Ø¹ØªÙŠ</button>
      <button class="seg" id="segGPS" type="button">Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>

    <div class="grid">
      <div class="pill"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wxTemp">â€”Â°C</b></div>
      <div class="right">
        <div class="thi-clock">
          <div class="dial"><div id="thiArc" class="arc"></div></div>
          <div id="thiNeedle" class="needle"></div>
          <div class="center"></div>
        </div>
      </div>
      <div class="pill"><div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wxHum">â€”%</b></div>
      <div class="pill"><div>THI</div><b id="wxTHI">â€”</b></div>
      <div class="pill" style="grid-column:1 / span 2"><div>Ø§Ù„Ø­Ø§Ù„Ø©</div><b id="wxState">â€”</b></div>
    </div>
  </div>

  <!-- âœ… Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¨Ø±Ø© Ø§Ù„Ø°ÙƒÙŠØ© (Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ù‚Ø³ Ù…Ø¨Ø§Ø´Ø±Ø©) -->
  <div class="card" id="needleGauges" aria-label="Ù…Ø¤Ø´Ø±Ø§Øª ØªÙ†ÙÙŠØ°ÙŠØ©">
    <div style="font-weight:800;color:#1b5e20;margin-bottom:10px">ğŸ§­ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</div>
    <div class="gauges-grid">
      <div class="gauge">
        <div class="gauge-title">Ø§Ù„Ø®ØµÙˆØ¨Ø©</div>
        <canvas id="gFert"></canvas>
        <div class="gauge-read">
          <span class="gauge-value" id="vFert">â€”%</span>
          <span class="gauge-desc" id="dFert">â€”</span>
        </div>
      </div>
      <div class="gauge">
        <div class="gauge-title">Ø§Ù„ØµØ­Ø©</div>
        <canvas id="gHealth"></canvas>
        <div class="gauge-read">
          <span class="gauge-value" id="vHealth">â€”%</span>
          <span class="gauge-desc" id="dHealth">â€”</span>
        </div>
      </div>
      <div class="gauge">
        <div class="gauge-title">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†</div>
        <canvas id="gMilk"></canvas>
        <div class="gauge-read">
          <span class="gauge-value" id="vMilk">â€”%</span>
          <span class="gauge-desc" id="dMilk">â€”</span>
        </div>
      </div>
      <div class="gauge">
        <div class="gauge-title">ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØºØ°ÙŠØ©</div>
        <canvas id="gFeed"></canvas>
        <div class="gauge-read">
          <span class="gauge-value" id="vFeed">â€”%</span>
          <span class="gauge-desc" id="dFeed">â€”</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª / Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
  <div class="dashboard card" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">ğŸ®</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>
    <div class="tile" id="groupsTile" role="button" tabindex="0"
         onclick="(window.dataLayer=window.dataLayer||[]).push({event:'tile_click',tile:'groups',page:'dashboard'}); location.href='groups.html'">
      <span class="icon">ğŸ‘¥</span> Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø±Ø¨ÙŠÙƒ
    </div>
    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="tile" id="sensorsTile" role="button" tabindex="0">
      <span class="badge" id="sensorsStatus">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦</span> ğŸ›°ï¸ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª
    </div>
    <div class="tile" id="nutritionEvalTile" role="button" tabindex="0" onclick="location.href='nutrition-eval.html'">
      ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ©
    </div>
  </div>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ø­Ù„Ù‚Ø§Øª Ù…Ø®ØªØµØ±Ø©) -->
  <div class="card" id="herdGauges" aria-label="Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹">
    <div style="font-weight:800;color:#1b5e20;margin-bottom:10px;display:flex;align-items:center;gap:8px">
      ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ø¥Ù†ØªØ§Ø¬ÙŠ + ØªÙ†Ø§Ø³Ù„ÙŠ)
      <span id="g-date" style="margin-inline-start:auto" class="badge">â€”</span>
    </div>

    <div class="kpi-grid">
      <div class="kpi" data-key="inMilkPct" data-hint="Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-inmilk" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨</div>
          <div class="kpi-value" id="v-inmilk">â€”%</div>
          <div class="kpi-sub">Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†</div>
        </div>
      </div>

      <div class="kpi" data-key="pregRate" data-hint="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø± Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-preg" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø±</div>
          <div class="kpi-value" id="v-preg">â€”%</div>
          <div class="kpi-sub">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹</div>
        </div>
      </div>

      <div class="kpi" data-key="freshShare" data-hint="Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø¶Ù…Ù† Ø§Ù„Ø­Ù„Ø§Ø¨">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-fresh" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</div>
          <div class="kpi-value" id="v-fresh">â€”%</div>
          <div class="kpi-sub">Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹ ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨</div>
        </div>
      </div>

      <div class="kpi" data-key="dryShare" data-hint="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬Ø§Ù Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-dry" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">Ø¬Ø§Ù</div>
          <div class="kpi-value" id="v-dry">â€”%</div>
          <div class="kpi-sub">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹</div>
        </div>
      </div>

      <div class="kpi" data-key="serviceRate" data-hint="Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¤Ù‡Ù„Ø§Øª Ø®Ù„Ø§Ù„ 21 ÙŠÙˆÙ…">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-service" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ„Ù‚ÙŠØ­</div>
          <div class="kpi-value" id="v-service">â€”%</div>
          <div class="kpi-sub">21 ÙŠÙˆÙ…</div>
        </div>
      </div>

      <div class="kpi" data-key="conceptionRate" data-hint="Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª Ø§Ù„ØªÙŠ Ø§Ù†ØªÙ‡Øª Ø¨Ø­Ù…Ù„ / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-conception" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø®ØµØ§Ø¨</div>
          <div class="kpi-value" id="v-conception">â€”%</div>
          <div class="kpi-sub">ÙŠØ³ØªÙ†Ø¯ Ù„Ø±Ø¨Ø· Ø§Ù„ØªÙ„Ù‚ÙŠØ­ Ø¨Ø§Ù„ØªØ´Ø®ÙŠØµ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ====== -->
  <script src="/js/tenant-bootstrap.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/app-core.js"></script>

  <!-- ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ + THI Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (ÙƒÙ…Ø§ Ù‡Ùˆ) -->
  <script>
  (function(){
    const box = document.getElementById('weatherClassic');
    const tEl = document.getElementById('wxTemp');
    const hEl = document.getElementById('wxHum');
    const thiEl = document.getElementById('wxTHI');
    const sEl = document.getElementById('wxState');
    const thiArc = document.getElementById('thiArc');
    const thiNeedle = document.getElementById('thiNeedle');
    const btnRefresh = document.getElementById('wxRefresh');
    const btnPin = document.getElementById('wxPin');
    const segFarm = document.getElementById('segFarm');
    const segGPS  = document.getElementById('segGPS');
    if(!box||!tEl||!hEl||!thiEl||!sEl||!btnRefresh||!btnPin||!segFarm||!segGPS) return;

    const DEF = { lat:30.0444, lon:31.2357, place:'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©' };
    const LS_PIN='mbk_farm', LS_WX='mbk_wx_cache', LS_REG='mbk_reg_geo', LS_SPEC='mbk.herd.species';
    let mode='reg', pinned=null;

    const getSpec = ()=> (localStorage.getItem(LS_SPEC) || 'cow');
    function THI(c,rh){ const f=c*9/5+32; return Math.round(((f-(0.55-0.0055*rh)*(f-58)))); }
    function bands(){ return getSpec()==='buffalo'? {t1:64,t2:68,t3:74,t4:79} : {t1:66,t2:70,t3:77,t4:82}; }
    function colorAndText(thi,b){
      if(thi<b.t1) return {bg:'#c8e6c9',txt:'Ù…Ø±ÙŠØ­'};
      if(thi<b.t2) return {bg:'#fff9c4',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø®ÙÙŠÙ'};
      if(thi<b.t3) return {bg:'#ffe0b2',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ù…ØªÙˆØ³Ø·'};
      if(thi<b.t4) return {bg:'#ffccbc',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯'};
      return {bg:'#ffcdd2',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯ Ø¬Ø¯Ø§'};
    }
    function drawTHI(thi){
      const ang=-120+((thi-50)/40)*240;
      thiEl.textContent=thi;
      if(thiNeedle) thiNeedle.style.setProperty('--angle',ang+'deg');
      const {bg,txt}=colorAndText(thi,bands());
      box.style.background = bg; sEl.textContent = txt + (getSpec()==='buffalo'?' (Ø¬Ø§Ù…ÙˆØ³)':' (Ø£Ø¨Ù‚Ø§Ø±)');
    }
    const readJSON=(k)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch{ return null; } };
    const writeJSON=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };
    function readTenantAddress(){
      const T = window.__TENANT__ || {};
      const country = T.country || T.countryCode || T.address?.country || T.profile?.country;
      const region  = T.region  || T.state  || T.governorate || T.address?.region || T.profile?.region;
      const city    = T.city    || T.town   || T.address?.city || T.profile?.city;
      return { country, region, city };
    }
    function regKey(addr){ const parts = [addr.city, addr.region, addr.country].filter(Boolean).join('|').toLowerCase(); return parts || 'default'; }
    async function geocodeFromRegistration(){
      const addr = readTenantAddress(); if(!addr.country && !addr.region && !addr.city) return null;
      const key = regKey(addr); const cached = readJSON(LS_REG); if(cached && cached.key===key && cached.lat && cached.lon) return cached;
      try{
        const q = encodeURIComponent([addr.city, addr.region, addr.country].filter(Boolean).join(', '));
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1&language=ar`);
        const j = await r.json(); const item = j?.results?.[0];
        if(item){ const place = [item.name, item.admin1, item.country].filter(Boolean).join('ØŒ ');
          const res = { lat:item.latitude, lon:item.longitude, place, key }; writeJSON(LS_REG, res); return res; }
      }catch(e){}
      return null;
    }
    function getPinned(){ return readJSON(LS_PIN); }
    function savePinned(lat,lon,place){ writeJSON(LS_PIN, {lat,lon,place:place||'Ù…Ø²Ø±Ø¹ØªÙŠ'}); }
    function getGPS(){ return new Promise((resolve)=>{ if(!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(p=>resolve({lat:p.coords.latitude,lon:p.coords.longitude,place:'Ù…ÙˆÙ‚Ø¹ÙŠ'}), _=>resolve(null), {enableHighAccuracy:true, timeout:5000}); }); }
    async function pickCoords(){ if(pinned) return pinned; if(mode==='gps'){ const g = await getGPS(); if(g) return g; }
      const reg = await geocodeFromRegistration(); if(reg) return reg; return DEF; }
    function wxGetCached(){ const x = readJSON(LS_WX); if(x && Date.now()-x.ts < 60_000) return x.data; return null; }
    function wxSetCached(data){ writeJSON(LS_WX, {ts:Date.now(), data}); }
    async function fetchWeather(lat, lon){
      const cached = wxGetCached(); if(cached && typeof cached.t==='number' && typeof cached.h==='number') return cached;
      try{
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`, {cache:'no-store'});
        const j=await r.json(); const data = { t:j.current?.temperature_2m, h:j.current?.relative_humidity_2m };
        if(typeof data.t==='number' && typeof data.h==='number') wxSetCached(data); return data;
      }catch{ return null; }
    }
    function activate(which){ segFarm.classList.toggle('active', which==='reg'); segGPS.classList.toggle('active', which==='gps'); }
    async function render(){
      const c = await pickCoords(); const data = await fetchWeather(c.lat, c.lon);
      if(!data){ tEl.textContent='â€”Â°C'; hEl.textContent='â€”%'; thiEl.textContent='â€”'; sEl.textContent='â€”'; return; }
      const t=Math.round(data.t), h=Math.round(data.h); tEl.textContent=`${t}Â°C`; hEl.textContent=`${h}%`;
      drawTHI( THI(t,h) );
    }
    async function boot(){
      pinned = getPinned() || null; mode = 'reg'; activate('reg');
      segFarm.addEventListener('click', ()=>{ mode='reg'; activate('reg'); render(); });
      segGPS .addEventListener('click', ()=>{ mode='gps'; activate('gps'); render(); });
      btnRefresh.addEventListener('click', render);
      btnPin.addEventListener('click', async ()=>{ mode='gps'; const g = await getGPS(); if(g){ savePinned(g.lat,g.lon,g.place); pinned=g; } mode='reg'; activate('reg'); render(); });
      window.addEventListener('storage', (e)=>{ if(e.key===LS_SPEC) render(); });
      document.addEventListener('mbk:spec-changed', render);
      render();
    }
    document.addEventListener('DOMContentLoaded', boot);
  })();
  </script>

  <!-- ===== KPIs Ø§Ù„Ø­Ù„Ù‚ÙŠØ© + Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Firestore) ÙƒÙ…Ø§ ÙƒØ§Ù†Øª ===== -->
  <script type="module" id="herd-kpis">
  import { db } from '/js/firebase-config.js';
  import { collection, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const $ = s => document.getElementById(s);
  const RING_LEN = 113.097;

  // ØªØ¨ÙˆÙŠØ¨Ø§Øª
  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.getElementById('tab-'+b.dataset.tab).classList.add('active');
    });
  });

  const norm = s => String(s||'').toLowerCase()
    .replace(/[\u0610-\u061a\u064b-\u065f\u0670\u06d6-\u06ed]/g,'').trim();
  const toDate = v => {
    if(!v) return null;
    if(typeof v==='string') return new Date(v);
    if(v instanceof Date) return v;
    if(typeof v==='object' && typeof v.seconds==='number') return new Date(v.seconds*1000);
    return null;
  };
  const daysBetween = (a,b)=> Math.floor((a-b)/86400000);

  const isDry = an => {
    const st = norm(an.productionStatus || an.lactationStatus || an.status || an['Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„Ù„Ø¨Ù†ÙŠØ©'] || '');
    const dryBool = an.dry === true || an.isDry === true || an.dryCow === true || an['Ø¬Ø§Ù'] === true;
    return dryBool || an.inMilk === false || /(dry|dryoff|Ø¬Ø§Ù|Ø¬Ø§ÙÙ‡|Ø¬Ø§ÙØ©)/.test(st);
  };
  const isInMilk = an => {
    if (isDry(an)) return false;
    if (an.inMilk === true) return true;
    const st = norm(an.productionStatus || an.lactationStatus || an.status || an['Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„Ù„Ø¨Ù†ÙŠØ©'] || '');
    return /(Ø­Ù„Ø§Ø¨|ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨|Ù…Ø­Ù„Ø¨|Ù…Ù†ØªØ¬|Ø­Ù„ÙŠØ¨|milk|milking|lact)/.test(st);
  };
  const isPreg = an => {
    const rs = String(an.reproductiveStatus || an.pregStatus || an['Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©'] || '').toLowerCase();
    return an.pregnant===true || rs.includes('preg') || rs.includes('Ø¹Ø´Ø§Ø±') || rs.includes('Ø­Ø§Ù…Ù„');
  };
  const getDIM = an => {
    const calv = toDate(an.calvingDate || an.lastCalvingDate || an.calvedAt || an['ØªØ§Ø±ÙŠØ®_Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©']);
    return calv ? Math.max(0, daysBetween(new Date(), calv)) : 0;
  };

  const INSEM = ['ØªÙ„Ù‚ÙŠØ­','insemination'];
  const PD    = ['ØªØ´Ø®ÙŠØµ\\s*Ø­Ù…Ù„','pregnancy\\s*diagnosis'];
  const CALV  = ['ÙˆÙ„Ø§Ø¯Ù‡','ÙˆÙ„Ø§Ø¯Ø©','calving'];
  const ABORT = ['Ø§Ø¬Ù‡Ø§Ø¶','abortion'];
  const MILK  = ['Ù„Ø¨Ù†','milk'];
  const HEALTH = ['Ø¹Ø±Ø¬','lameness','mastitis','ØªÙ‡Ø§Ø¨','Ø­Ù…Ù‰','fever','treat','Ø¹Ù„Ø§Ø¬'];
  const isType = (t, patterns) => patterns.some(p => new RegExp(p,'i').test(String(t||'')));

  const LS_SPEC='mbk.herd.species';
  const specNote = $('spec-note');
  function setSpecUI(spec){
    document.getElementById('opt-cow').classList.toggle('active', spec==='cow');
    document.getElementById('opt-buffalo').classList.toggle('active', spec==='buffalo');
    specNote.textContent = spec==='cow' ? 'Ù…Ø¹Ø§ÙŠÙŠØ±: Ø£Ø¨Ù‚Ø§Ø±' : 'Ù…Ø¹Ø§ÙŠÙŠØ±: Ø¬Ø§Ù…ÙˆØ³';
  }
  function getStoredSpec(){ return localStorage.getItem(LS_SPEC) || null; }
  function setStoredSpec(s){
    localStorage.setItem(LS_SPEC, s); setSpecUI(s);
    document.dispatchEvent(new CustomEvent('mbk:spec-changed', {detail:{spec:s}}));
    recompute();
  }
  document.getElementById('opt-cow').addEventListener('click', ()=> setStoredSpec('cow'));
  document.getElementById('opt-buffalo').addEventListener('click', ()=> setStoredSpec('buffalo'));

  function autoDetectSpec(animals){
    let buff=0, cow=0;
    for(const a of animals){
      const sp = norm(a.species||a.type||a['Ø§Ù„Ù†ÙˆØ¹']||'');
      if(/Ø¬Ø§Ù…ÙˆØ³|buff/.test(sp)) buff++;
      else if(/cow|Ø¨Ù‚Ø±|Ø§Ø¨Ù‚Ø§Ø±|Ø£Ø¨Ù‚Ø§Ø±/.test(sp)) cow++;
    }
    return buff>cow ? 'buffalo' : 'cow';
  }

  function getBench(spec){
    if(spec==='buffalo'){
      return { CR:{good:48,warn:38}, PR:{good:20,warn:15}, OPEN:{good:130,warn:155,lowerBetter:true}, CI:{good:410,warn:450,lowerBetter:true}, SC:{good:2.2,warn:2.6,lowerBetter:true} };
    }
    return { CR:{good:55,warn:45}, PR:{good:25,warn:18}, OPEN:{good:110,warn:130,lowerBetter:true}, CI:{good:380,warn:410,lowerBetter:true}, SC:{good:2.0,warn:2.4,lowerBetter:true} };
  }
  function kpiColor(value, rule){
    if(value==null || isNaN(value)) return '#065f46';
    const v = Number(value);
    if(rule.lowerBetter){ if(v<=rule.good) return '#2e7d32'; if(v<=rule.warn) return '#fdd835'; return '#ef6c00'; }
    else{ if(v>=rule.good) return '#2e7d32'; if(v>=rule.warn) return '#fdd835'; return '#ef6c00'; }
  }
  function setRing(idSuffix, pct, stroke){
    const el = document.getElementById('r-'+idSuffix); if(!el) return;
    const p = Math.max(0, Math.min(100, Number(pct)||0));
    const off = RING_LEN * (1 - p/100);
    el.style.setProperty('stroke-dashoffset', off.toFixed(2)); el.style.stroke = stroke || '#2e7d32';
  }

  function calcHerdFromAnimals(animals){
    const total = animals.length;
    let inMilk=0, fresh=0, dry=0, preg=0;
    for(const an of animals){
      const dryF  = isDry(an);
      const milkF = isInMilk(an);
      if (milkF){ inMilk++; const d = getDIM(an); if(d>=1 && d<=45) fresh++; }
      if (dryF){ dry++; }
      if (isPreg(an)) preg++;
    }
    const inMilkPct = total? Math.round(inMilk/total*100) : 0;
    const pregRate  = total? Math.round(preg/total*100)  : 0;
    const freshShare= inMilk? Math.round(fresh/inMilk*100) : 0;
    const dryShare  = total? Math.round(dry/total*100)   : 0;
    return { total, inMilk, inMilkPct, pregRate, freshShare, dryShare };
  }

  // Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ… ÙˆØ®Ù„Ø§ÙÙ‡
  function calcProduction(animals, events){
    const milking = animals.filter(isInMilk);
    const inMilk = milking.length;
    const today = new Date().toDateString();
    const milkToday = events.filter(e => isType(e.type, MILK) && toDate(e.eventDate)?.toDateString()===today);
    const sumMilk = milkToday.reduce((s,e)=> s + (Number(e.amount)||0), 0);
    const avgMilk = inMilk ? Math.round((sumMilk/inMilk)*10)/10 : 0;
    const avgDIM  = inMilk ? Math.round(milking.reduce((s,a)=> s+getDIM(a),0)/inMilk) : 0;
    return { sumMilk, avgMilk, inMilk, avgDIM };
  }

  // Ø±Ø¨Ø· PD+ Ø¨ØªÙ„Ù‚ÙŠØ­ Ø³Ø§Ø¨Ù‚ Ù„Ø­Ø³Ø§Ø¨ CR/PR/SR Ø³Ø±ÙŠØ¹
  function calcReproRates(animals, events){
    const now = new Date();
    const d21 = new Date(now.getTime() - 21*86400000);
    const d90 = new Date(now.getTime() - 90*86400000);
    const d180= new Date(now.getTime() -180*86400000);

    const eligible = animals.filter(a => isInMilk(a) && !isPreg(a) && getDIM(a) >= 60).length;
    const servicesLast21 = events.filter(e => isType(e.type, INSEM) && toDate(e.eventDate) >= d21).length;
    const serviceRate = eligible ? Math.round((servicesLast21/eligible)*100) : 0;

    const insems90 = events.filter(e=> isType(e.type,INSEM) && toDate(e.eventDate)>=d90);
    const pdPos90  = events.filter(e=>{
      const d = toDate(e.eventDate);
      const res = String(e.result || e.outcome || e['Ø§Ù„Ù†ØªÙŠØ¬Ø©'] || '').toLowerCase();
      return isType(e.type, PD) && d && d>=d90 && /(Ø¹Ø´Ø§Ø±|preg|positive|Ø­Ø§Ù…Ù„)/.test(res);
    });

    const insByAnimal = new Map();
    insems90.forEach(e=>{
      const key = e.animalId || e.animalNumber || e.number || e.tag;
      if(!key) return; const arr = insByAnimal.get(key)||[]; arr.push(e); insByAnimal.set(key,arr);
    });

    let linkedPreg=0;
    pdPos90.forEach(pd=>{
      const key = pd.animalId || pd.animalNumber || pd.number || pd.tag; if(!key) return;
      const dPD = toDate(pd.eventDate);
      const list = (insByAnimal.get(key)||[]).filter(x=> toDate(x.eventDate) && toDate(x.eventDate) <= dPD);
      if(!list.length) return; list.sort((a,b)=> toDate(b.eventDate)-toDate(a.eventDate));
      const lastIns = list[0]; if(dPD - toDate(lastIns.eventDate) <= 300*86400000) linkedPreg++;
    });
    const cr = insems90.length ? Math.min(100, Math.round((linkedPreg/insems90.length)*100)) : 0;

    const newPreg21 = events.filter(e=> isType(e.type,PD)
      && /(Ø¹Ø´Ø§Ø±|preg|positive|Ø­Ø§Ù…Ù„)/i.test(String(e.result||e.outcome||e['Ø§Ù„Ù†ØªÙŠØ¬Ø©']||'')) && toDate(e.eventDate)>=d21).length;
    const pr = eligible? Math.round((newPreg21/eligible)*100) : 0;

    // S/C (180 ÙŠÙˆÙ…) â€” Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠØ© ÙÙ‚Ø· ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    const insems180 = events.filter(e=> isType(e.type,INSEM) && toDate(e.eventDate)>=d180).length;
    const preg180   = events.filter(e=> isType(e.type,PD) && /(Ø¹Ø´Ø§Ø±|preg|positive|Ø­Ø§Ù…Ù„)/i.test(String(e.result||e.outcome||e['Ø§Ù„Ù†ØªÙŠØ¬Ø©']||'')) && toDate(e.eventDate)>=d180).length;
    const sc = preg180? (Math.round((insems180/preg180)*10)/10) : (insems180? (insems180).toFixed(1): 0);

    return { serviceRate, cr, pr, sc };
  }

  // === Â«Ø§Ù„Ø¬ÙˆØ¬ Ø§Ù„Ø£Ø±Ø¨Ø¹Â» Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ===

  // Ù‡Ø¯Ù Ø§Ù„Ù„Ø¨Ù† Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (Ø£Ø¨Ù‚Ø§Ø± Ø°Ø±ÙˆØ© 38ØŒ Ø¬Ø§Ù…ÙˆØ³ Ø°Ø±ÙˆØ© 16) Ø­Ø³Ø¨ DIM
  function targetMilkForAnimal(an){
    const sp = norm(an.species||an.type||an['Ø§Ù„Ù†ÙˆØ¹']||'cow');
    const peak = /Ø¬Ø§Ù…ÙˆØ³|buff/.test(sp) ? 16 : 38; // Ø§Ø®ØªÙŠØ§Ø±Ùƒ
    const d = getDIM(an);
    if(d===0) return 0;
    // Ù…Ù†Ø­Ù†Ù‰ Ø¨Ø³ÙŠØ· piecewise (Ù‚ÙˆÙŠ ÙˆØ¹Ù…Ù„ÙŠ)
    if(d<=10)  return peak*0.6*(d/10);       // ØµØ¹ÙˆØ¯ Ø£ÙˆÙ„ÙŠ
    if(d<=60)  return peak*(0.6 + 0.4*((d-10)/50)); // ÙˆØµÙˆÙ„ Ù„Ù„Ø°Ø±ÙˆØ©
    if(d<=150) return peak*(1 - 0.0015*(d-60));     // Ù‡Ø¨ÙˆØ· Ø¨Ø·ÙŠØ¡
    if(d<=300) return peak*(0.865 - 0.0025*(d-150)); // Ù‡Ø¨ÙˆØ· Ø£Ø³Ø±Ø¹
    return Math.max(peak*0.25, 0);
  }

  function herdMilkScore(animals, events){
    const milking = animals.filter(isInMilk);
    const inMilk = milking.length;
    if(!inMilk) return {score:0, avgMilk:0, avgTarget:0};

    const today = new Date().toDateString();
    const milkToday = events.filter(e => isType(e.type, MILK) && toDate(e.eventDate)?.toDateString()===today);
    const sumMilk = milkToday.reduce((s,e)=> s + (Number(e.amount)||0), 0);
    const avgMilk = inMilk ? (sumMilk/inMilk) : 0;

    const avgTarget = milking.reduce((s,a)=> s + targetMilkForAnimal(a), 0) / inMilk || 0;

    const raw = avgTarget>0 ? (avgMilk/avgTarget)*100 : 0;
    const score = Math.max(0, Math.min(100, Math.round(raw)));
    return { score, avgMilk:Math.round(avgMilk*10)/10, avgTarget:Math.round(avgTarget*10)/10 };
  }

  function herdFertilityScore(animals, events){
    const spec = getStoredSpec() || autoDetectSpec(animals);
    const B = getBench(spec);

    const R = calcReproRates(animals, events);
    // Ù…Ø²Ø¬ Ù…Ø±Ø¬Ù‘Ø­: CR 45%ØŒ PR 35%ØŒ SR 20%
    const sCR = Math.max(0, Math.min(100, (R.cr / B.CR.good)*100));
    const sPR = Math.max(0, Math.min(100, (R.pr / B.PR.good)*100));
    const sSR = Math.max(0, Math.min(100, (R.serviceRate / B.PR.good)*100)); // Ù†Ù‚ÙŠØ³Ù‡ Ù…Ù‚Ø§Ø¨Ù„ Ù‡Ø¯Ù PR Ø§Ù„Ø¹Ø§Ù… 25/20
    const score = Math.round(0.45*sCR + 0.35*sPR + 0.20*sSR);
    return { score, cr:R.cr, pr:R.pr, sr:R.serviceRate };
  }

  function herdHealthScore(animals, events){
    const now = new Date();
    const d90 = new Date(now.getTime() - 90*86400000);
    const ids = new Set(animals.map(a=> a.id || a.animalId || a.number || a.animalNumber || a.tag));
    const sickIds = new Set();
    events.forEach(e=>{
      if(isType(e.type, HEALTH) && toDate(e.eventDate)>=d90){
        const k = e.animalId || e.animalNumber || e.number || e.tag;
        if(k) sickIds.add(k);
      }
    });
    const total = ids.size || 1;
    const healthy = Math.max(0, total - sickIds.size);
    const pctHealthy = (healthy/total)*100;
    // Score Ù…Ø¨Ø§Ø´Ø± = % Ø±Ø¤ÙˆØ³ Ø¨Ù„Ø§ Ù…Ø±Ø¶ Ø¢Ø®Ø± 90 ÙŠÙˆÙ…
    return { score:Math.round(pctHealthy), healthyPct:Math.round(pctHealthy) };
  }

  function herdFeedingScore(animals, prod){
    const milking = animals.filter(isInMilk);
    const inMilk = milking.length;
    if(!inMilk) return { score:0, fe:0, dmi:0 };

    // ØªÙ‚Ø¯ÙŠØ± DMI Ø³Ø±ÙŠØ¹ (ÙˆØ²Ù† ØªÙ‚Ø¯ÙŠØ±ÙŠ: Ø£Ø¨Ù‚Ø§Ø± 600ØŒ Ø¬Ø§Ù…ÙˆØ³ 550Ø› Ù…Ø¹Ø§Ù…Ù„Ø§Øª 0.038/0.036)
    const estimateBW = an=>{
      const w = Number(an.weight||an.bodyWeight||0);
      if(w>0) return w;
      const sp = norm(an.species||an.type||an['Ø§Ù„Ù†ÙˆØ¹']||'cow');
      return /Ø¬Ø§Ù…ÙˆØ³|buff/.test(sp)? 550 : 600;
    };
    const coef = (a)=> (/Ø¬Ø§Ù…ÙˆØ³|buff/.test(norm(a.species||a.type||a['Ø§Ù„Ù†ÙˆØ¹']||''))) ? 0.036 : 0.038;
    const dmiHeads = milking.map(a => Math.round(estimateBW(a)*coef(a)*10)/10);
    const avgDMI = dmiHeads.reduce((s,x)=>s+x,0)/inMilk;
    const fe = avgDMI>0 ? (prod.avgMilk/avgDMI) : 0;

    // ØªØ­ÙˆÙŠÙ„ FE Ø¥Ù„Ù‰ Score: Ø£Ø¨Ù‚Ø§Ø± goodâ‰¥1.6 warnâ‰¥1.3Ø› Ø¬Ø§Ù…ÙˆØ³ goodâ‰¥1.3 warnâ‰¥1.1
    // Ù„Ø£Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹ Ù…Ø®ØªÙ„Ø·: Ù†Ø­Ø³Ø¨ Ù‡Ø¯Ù Ù…Ø®ØªÙ„Ø· ÙˆØ²Ù†Ù‹Ø§
    const cowCount = milking.filter(a=>!/Ø¬Ø§Ù…ÙˆØ³|buff/.test(norm(a.species||a.type||a['Ø§Ù„Ù†ÙˆØ¹']||''))).length;
    const bufCount = inMilk - cowCount;
    const good = (cowCount*1.6 + bufCount*1.3)/Math.max(inMilk,1);
    const warn = (cowCount*1.3 + bufCount*1.1)/Math.max(inMilk,1);
    let score = 0;
    if(fe>=good) score = 100;
    else if(fe>=warn) score = 60 + Math.round((fe-warn)/(good-warn)*40);
    else score = Math.max(0, Math.round((fe/(warn||1))*60*0.7)); // Ù…Ù†Ø­Ù†Ù‰ Ù…Ø­Ø§ÙØ¸
    return { score, fe:Math.round(fe*100)/100, dmi:Math.round(avgDMI*10)/10 };
  }

  // Ø±Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù…Ø®ØªØµØ±Ø©
  function renderKpiRings(base, reproRates, currentSpec){
    const B = getBench(currentSpec);
    const dryClr = (base.dryShare<=18)?'#2e7d32':(base.dryShare<=25?'#fdd835':'#ef6c00');
    $('g-date').textContent = new Date().toISOString().slice(0,10);

    setRing('inmilk', base.inMilkPct, '#2e7d32');  $('v-inmilk').textContent = base.inMilkPct + '%';
    const pregClr = currentSpec==='buffalo' ? (base.pregRate>=B.CR.good?'#2e7d32':(base.pregRate>=B.CR.warn?'#fdd835':'#ef6c00'))
                                            : (base.pregRate>=B.CR.good?'#2e7d32':(base.pregRate>=B.CR.warn?'#fdd835':'#ef6c00'));
    setRing('preg', base.pregRate, pregClr); $('v-preg').textContent = base.pregRate + '%';
    setRing('fresh', base.freshShare, '#2e7d32'); $('v-fresh').textContent = base.freshShare + '%';
    setRing('dry', base.dryShare, dryClr); $('v-dry').textContent = base.dryShare + '%';

    setRing('service', reproRates.serviceRate, kpiColor(reproRates.serviceRate,B.PR)); $('v-service').textContent = reproRates.serviceRate + '%';
    setRing('conception', reproRates.cr, kpiColor(reproRates.cr,B.CR)); $('v-conception').textContent = reproRates.cr + '%';
  }

  // ØªØ¨ÙˆÙŠØ¨Ø§Øª (Ù‚ÙŠÙ…)
  function renderTabs(prod, reproRates, extras, nut){
    $('k-sumMilk').textContent = (prod.sumMilk||0).toFixed ? prod.sumMilk.toFixed(1) : String(prod.sumMilk||0);
    $('k-avgMilk').textContent = prod.avgMilk ? (prod.avgMilk+' ÙƒØ¬Ù…') : 'â€”';
    $('k-inMilkNum').textContent = String(prod.inMilk||0);
    $('k-avgDIM').textContent = prod.avgDIM ? (prod.avgDIM+' ÙŠÙˆÙ…') : 'â€”';

    $('k-openDays').textContent = extras.openDays || 'â€”';
    $('k-ci').textContent = extras.ci || 'â€”';
    $('k-cr').textContent = (reproRates.cr||0)+'%';
    $('k-pr').textContent = (reproRates.pr||0)+'%';
    $('k-sc').textContent = (reproRates.sc||0);
    $('k-ar').textContent = (extras.ar||0)+'%';
    $('k-dcr').textContent= (extras.dcr||0)+'%';
    $('k-afc').textContent= extras.afc || 'â€”';

    $('k-dmi').textContent = nut.dmi ? (nut.dmi+' ÙƒØ¬Ù…') : 'â€”';
    $('k-fe').textContent  = nut.fe ? nut.fe.toFixed(2) : 'â€”';
    $('k-iofc').textContent= 'â€”'; // ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨ Ù‡Ù†Ø§
  }

  // Ø­Ø³Ø§Ø¨ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…Ø¨Ø³Ø·)
  function calcReproExtras(animals, events){
    const now = new Date();
    const d365 = new Date(now.getTime()-365*86400000);
    const open = animals.filter(a=> isInMilk(a) && !isPreg(a) );
    const openDays = open.length? Math.round(open.reduce((s,a)=> s+getDIM(a),0)/open.length) : 0;

    // CI
    const calvByAnimal = new Map();
    events.filter(e=> isType(e.type,CALV) && toDate(e.eventDate)).forEach(e=>{
      const key = e.animalId || e.animalNumber || e.number || e.tag;
      if(!key) return; const arr = calvByAnimal.get(key)||[]; arr.push(toDate(e.eventDate)); calvByAnimal.set(key,arr);
    });
    let ciVals=[]; for(const arr of calvByAnimal.values()){ arr.sort((a,b)=>a-b);
      if(arr.length>=2){ const last=arr[arr.length-1], prev=arr[arr.length-2]; ciVals.push(Math.floor((last-prev)/86400000)); } }
    const ci = ciVals.length? Math.round(ciVals.reduce((a,b)=>a+b,0)/ciVals.length):0;

    const aborts = events.filter(e=> isType(e.type,ABORT) && toDate(e.eventDate)>=d365 ).length;
    const calvs  = events.filter(e=> isType(e.type,CALV)  && toDate(e.eventDate)>=d365 ).length;
    const deadCalv = events.filter(e=> isType(e.type,CALV) && (/(Ù…ÙŠØª|Ù†Ø§ÙÙ‚|dead|still)/i.test(String(e.outcome||e.calfStatus||e['Ø­Ø§Ù„Ø©_Ø§Ù„Ø¹Ø¬Ù„']||''))) && toDate(e.eventDate)>=d365).length;

    return { openDays, ci, ar: calvs? Math.round((aborts/Math.max(calvs,1))*100):0, dcr: calvs? Math.round((deadCalv/calvs)*100):0, afc:'â€”' };
  }

  // ===== Ø§Ø´ØªØ±Ø§Ùƒ Firestore + Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø´Ø§Ù…Ù„Ø© =====
  let animals=[], events=[];
  let currentSpec = getStoredSpec() || 'cow';

  function recompute(){
    if(!getStoredSpec() && animals.length){
      currentSpec = autoDetectSpec(animals);
      setSpecUI(currentSpec);
    }
    setSpecUI(currentSpec);

    const base = calcHerdFromAnimals(animals);
    const prod = calcProduction(animals, events);
    const reproRates = calcReproRates(animals, events);
    const extras = calcReproExtras(animals, events);

    // Ø§Ù„Ø¬ÙˆØ¬ Ø§Ù„Ø£Ø±Ø¨Ø¹:
    const milk = herdMilkScore(animals, events);
    const fert = herdFertilityScore(animals, events);
    const health = herdHealthScore(animals, events);
    const feed = herdFeedingScore(animals, prod);

    // Ø±Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø§Øª + ØªØ¨ÙˆÙŠØ¨Ø§Øª
    renderKpiRings(base, reproRates, currentSpec);
    renderTabs(prod, reproRates, extras, { dmi:feed.dmi, fe:feed.fe });

    // Ø¯ÙØ¹ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬ÙˆØ¬
    updateNeedle('gMilk',  milk.score, 'vMilk','dMilk',  `Ù…ØªÙˆØ³Ø· ${milk.avgMilk} / Ù‡Ø¯Ù ${milk.avgTarget}`);
    updateNeedle('gFert',  fert.score, 'vFert','dFert',  `CR ${fert.cr}% Â· PR ${fert.pr}% Â· SR ${fert.sr}%`);
    updateNeedle('gHealth',health.score,'vHealth','dHealth',`${health.healthyPct}% Ø³Ù„ÙŠÙ…Ø© Ø¢Ø®Ø± 90ÙŠ`);
    updateNeedle('gFeed',  feed.score, 'vFeed','dFeed',  `FE ${feed.fe} Â· DMI ${feed.dmi}`);

    colorizeTab(currentSpec, base, reproRates, extras);
  }

  const userId = window.__TENANT__?.userId || localStorage.getItem('userId');
  if(userId){
    try{
      const qA = query(collection(db,'animals'), where('userId','==', userId));
      onSnapshot(qA, snap=>{ animals = snap.docs.map(d=> ({ id:d.id, ...d.data() })); recompute(); });
    }catch(e){ console.warn('animals query error', e); }
    try{
      const qE = query(collection(db,'events'), where('userId','==', userId));
      onSnapshot(qE, snap=>{
        events = snap.docs.map(d=> ({ id:d.id, ...d.data() }))
          .filter(e => { const d = toDate(e.eventDate); return d ? (Date.now()-d.getTime() <= 420*86400000) : true; });
        recompute();
      });
    }catch(e){ console.warn('events query error', e); }
  }

  // ===== Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¨Ø±Ø© (Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ«) =====
  const gauges = {};
  function gaugeLabel(v){ if(v<40) return 'Ø¶Ø¹ÙŠÙ'; if(v<70) return 'Ù…ØªÙˆØ³Ø·'; return 'Ù…Ù…ØªØ§Ø²'; }
  function ensureGauge(canvasId){
    if(gauges[canvasId]) return gauges[canvasId];
    gauges[canvasId] = new RadialGauge({
      renderTo: canvasId, width:140, height:140, minValue:0, maxValue:100, units:"%",
      majorTicks:["0","20","40","60","80","100"], minorTicks:2, strokeTicks:true,
      highlights:[ {from:0,to:40,color:"#d32f2f"}, {from:40,to:70,color:"#fbc02d"}, {from:70,to:100,color:"#388e3c"} ],
      needleType:"arrow", needleWidth:2, animationDuration:900, animationRule:"linear", value:0
    }).draw();
    return gauges[canvasId];
  }
  function updateNeedle(canvasId, value, valId, descId, extra){
    const g = ensureGauge(canvasId);
    const v = Math.max(0, Math.min(100, Math.round(value||0)));
    try{ g.value = v; }catch(e){}
    const valEl = document.getElementById(valId); if(valEl) valEl.textContent = v + '%';
    const dEl = document.getElementById(descId); if(dEl) dEl.textContent = extra ? `${gaugeLabel(v)} â€” ${extra}` : gaugeLabel(v);
  }

  // Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø­Ø³Ø¨ Benchmarks
  function colorizeTab(spec, base, reproRates, extras){
    const B = getBench(spec);
    document.getElementById('k-openDays').style.color = (function(v){ return v<=B.OPEN.good?'#2e7d32':(v<=B.OPEN.warn?'#fdd835':'#ef6c00'); })(extras.openDays||0);
    document.getElementById('k-ci').style.color       = (function(v){ return v<=B.CI.good?'#2e7d32':(v<=B.CI.warn?'#fdd835':'#ef6c00'); })(extras.ci||0);
    document.getElementById('k-cr').style.color       = kpiColor(reproRates.cr,B.CR);
    document.getElementById('k-pr').style.color       = kpiColor(reproRates.pr,B.PR);
    document.getElementById('k-sc').style.color       = kpiColor(reproRates.sc,B.SC);
  }

  // Ù…Ø²Ø§Ù…Ù†Ø© Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹
  function initSpec(){
    let s = getStoredSpec();
    if(!s) s = autoDetectSpec(animals);
    setSpecUI(s||'cow');
  }
  document.addEventListener('DOMContentLoaded', initSpec);
  </script>

  <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø°ÙƒÙŠØ© (ÙƒÙ…Ø§ Ù‡ÙŠ) -->
  <script type="module" src="/js/smart-alerts.js"></script>
</body>
</html>
