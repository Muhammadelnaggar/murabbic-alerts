<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>
  <style>
    :root{--bg:#fff9db;--card:#ffffff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:var(--green)}

    /* Ø§Ù„Ø´Ø¨ÙƒØ© */
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}

    /* Ø§Ù„ÙƒØ±ÙˆØª */
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)
    }

    /* Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª (Ù‚Ù„Ø¨ Ù…Ø±Ø¨ÙŠÙƒ) */
    .tile{
      background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
      padding:16px;text-align:center;font-weight:bold;cursor:pointer;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;min-height:118px;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease
    }
    .tile .icon{
      display:block;width:44px;height:44px;line-height:44px;border-radius:50%;
      border:1px solid var(--border);font-size:24px
    }
    .tile small{font-weight:normal;color:#335c33}
    .tile:hover{background:#dcedc8;transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.08)}

    /* ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ (Ù†Ø³Ø®Ø© Ù…Ø¶ØºÙˆØ·Ø©) */
    #weatherCard{display:none;align-items:center;gap:10px;padding:10px 12px}
    #weatherCard.compact .wvals{display:flex;gap:6px;flex-wrap:wrap}
    #weatherCard.compact #weatherBadge{
      display:inline-flex;align-items:center;gap:8px;border-radius:999px;border:1px solid var(--border);
      padding:6px 10px;background:var(--muted);font-size:14px
    }
    #wLoc{font-weight:bold}
    #weatherCard.compact .wval{
      background:#f7fff4;border:1px solid var(--border);border-radius:10px;
      padding:6px 8px;min-width:72px;text-align:center;font-size:13px
    }
    .btn{appearance:none;border:1px solid var(--green);background:#fff;color:var(--green);
      border-radius:10px;padding:6px 10px;font-weight:bold;cursor:pointer;font-size:12px}
    .btn:hover{background:#f4fff1}

    @media(max-width:560px){
      .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
      .tile{min-height:110px;padding:14px}
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>

  <!-- Ø§Ù„Ø·Ù‚Ø³ Ùˆ THI (Ù…Ø¶ØºÙˆØ·) -->
  <div id="weatherCard" class="card" aria-label="Ø§Ù„Ø·Ù‚Ø³ Ùˆ Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø±Ø§Ø±Ø©-Ø§Ù„Ø±Ø·ÙˆØ¨Ø©">
    <div id="weatherBadge">
      <span>ğŸŒ¦ï¸</span>
      <span id="wLoc">â€”</span>
    </div>
    <div class="wvals" style="flex:1">
      <div class="wval"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wTemp">â€”Â°C</b></div>
      <div class="wval"><div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wHum">â€”%</b></div>
      <div class="wval"><div>THI</div><b id="wTHI">â€”</b></div>
      <div class="wval"><div>Ø§Ù„Ø­Ø§Ù„Ø©</div><b id="wState">â€”</b></div>
    </div>
    <button id="wRefresh" class="btn">ØªØ­Ø¯ÙŠØ«</button>
  </div>

  <!-- Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>ØªØ³Ø¬ÙŠÙ„ Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>Ø§Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">ğŸ†”</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>

    <div class="tile" id="milkTraitsCard" role="button" tabindex="0">
      <span class="icon">ğŸ¥›</span>
      Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨ØµØ±ÙŠ Ù„ØµÙØ§Øª Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†
      <small>Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø¶Ø±Ø¹/Ø¬Ø§Ù†Ø¨ÙŠ/Ø®Ù„ÙÙŠ)</small>
    </div>

    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="tile" onclick="location.href='farm-economy.html'"><span class="icon">ğŸ’°</span>Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</div>

    <!-- â›” ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø¨Ù„Ø§Ø·Ø© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª (evaluation.html) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ -->

    <div class="tile" onclick="location.href='nutrition.html'"><span class="icon">ğŸŒ¿</span>ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„ØªØºØ°ÙŠØ©</div>
    <div class="tile" onclick="location.href='smart-feeding.html'"><span class="icon">ğŸ§ </span>Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</div>

    <!-- ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ© Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ù…ÙŠÙ‘Ø© (BCS) -->
    <div class="tile" id="bcsNutritionCard" role="button" tabindex="0">
      <span class="icon">ğŸ§</span>
      Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªØºØ°ÙŠØ© (Ù‚ÙŠØ§Ø³ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ù…ÙŠÙ‘Ø© Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)
      <small>BCS â†’ ØªÙˆØµÙŠØ§Øª ØªØºØ°ÙŠØ©</small>
    </div>

    <!-- ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø±ÙˆØ« Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <div class="tile" id="fecesEvalCard" role="button" tabindex="0">
      <span class="icon">ğŸ’©</span>
      Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªØºØ°ÙŠØ© (Ø¨ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø±ÙˆØ« Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)
      <small>Feces score â†’ ØªÙˆØµÙŠØ§Øª</small>
    </div>
  </div>

<script>
// ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ â€” Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Firebase
(function(){
  const chip   = document.getElementById('weatherCard');
  const wLoc   = document.getElementById('wLoc');
  const wTemp  = document.getElementById('wTemp');
  const wHum   = document.getElementById('wHum');
  const wTHI   = document.getElementById('wTHI');
  const wState = document.getElementById('wState');
  const wRefresh = document.getElementById('wRefresh');

  // Ø£Ø¸Ù‡Ø± Ø§Ù„ÙˆÙŠØ¯Ø¬Øª ÙÙˆØ±Ù‹Ø§ Ø¨Ø´ÙƒÙ„ Ù…Ø¶ØºÙˆØ·
  chip.style.display='flex';
  chip.classList.add('compact');

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  let key = localStorage.getItem('userRegionKey');
  if(!key){
    const c = localStorage.getItem('userCountry');
    const r = localStorage.getItem('userRegion');
    key = (c && r) ? `${c}:${r}` : 'Ù…ØµØ±:Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©';
    localStorage.setItem('userRegionKey', key);
  }
  wLoc.textContent = key;

  const GEO = {
    'Ù…ØµØ±:Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©': {lat:30.0444, lon:31.2357},
    'Ù…ØµØ±:Ø§Ù„Ø¬ÙŠØ²Ø©':  {lat:30.0131, lon:31.2089},
    'Ù…ØµØ±:Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©': {lat:31.2001, lon:29.9187},
    'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©:Ø§Ù„Ø±ÙŠØ§Ø¶': {lat:24.7136, lon:46.6753},
    'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©:Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©': {lat:21.3891, lon:39.8579},
    'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª:Ø¯Ø¨ÙŠ': {lat:25.2048, lon:55.2708},
    'Ù‚Ø·Ø±:Ø§Ù„Ø¯ÙˆØ­Ø©': {lat:25.2854, lon:51.5310},
    'Ø§Ù„ÙƒÙˆÙŠØª:Ø§Ù„Ø¹Ø§ØµÙ…Ø©': {lat:29.3759, lon:47.9774},
    'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†:Ø§Ù„Ø¹Ø§ØµÙ…Ø©': {lat:26.2235, lon:50.5876},
    'Ø¹ÙÙ…Ø§Ù†:Ù…Ø³Ù‚Ø·': {lat:23.5880, lon:58.3829}
  };

  function THI(c, rh){ const f=c*9/5+32; return Math.round(((f - (0.55 - 0.0055*rh)*(f - 58)))*10)/10; }
  function thiColor(thi){
    if (thi < 68) return {bg:'#c8e6c9', txt:'Ù…Ø±ÙŠØ­'};
    if (thi < 72) return {bg:'#fff9c4', txt:'ØªÙˆØªØ± Ø®ÙÙŠÙ'};
    if (thi < 79) return {bg:'#ffe0b2', txt:'ØªÙˆØªØ± Ù…ØªÙˆØ³Ø·'};
    if (thi < 84) return {bg:'#ffccbc', txt:'ØªÙˆØªØ± Ø´Ø¯ÙŠØ¯'};
    return {bg:'#ffcdd2', txt:'ØªÙˆØªØ± Ø´Ø¯ÙŠØ¯ Ø¬Ø¯Ù‹Ø§'};
  }
  function saveCache(key, data){ localStorage.setItem('weather:'+key, JSON.stringify({...data, ts:Date.now()})); }
  function loadCache(key){ try{ const o=JSON.parse(localStorage.getItem('weather:'+key)||'null'); return o && (Date.now()-o.ts)<3600000 ? o : null; }catch{return null;} }
  async function fetchWeather(lat, lon){
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=Africa%2FCairo`;
      const r = await fetch(url); const j = await r.json();
      return { t: j.current?.temperature_2m, h: j.current?.relative_humidity_2m };
    }catch(e){ return null; }
  }

  async function renderWeather(force=false){
    let data = !force && loadCache(key);
    if(!data){
      const coords = GEO[key];
      if(!coords){ return; }
      data = await fetchWeather(coords.lat, coords.lon);
      if(data && data.t!=null && data.h!=null) saveCache(key, data);
    }
    if(!data){ return; }

    const thi = THI(data.t, data.h);
    const {bg, txt} = thiColor(thi);
    chip.style.background = bg;
    wTemp.textContent = `${Math.round(data.t)}Â°C`;
    wHum.textContent  = `${Math.round(data.h)}%`;
    wTHI.textContent  = thi;
    wState.textContent= txt;
  }

  window.renderWeather = renderWeather; // Ø¥ØªØ§Ø­Ø© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„Ø²Ø±
  document.addEventListener('DOMContentLoaded', ()=> renderWeather());
  wRefresh.addEventListener('click', ()=> renderWeather(true));
})();
</script>

<script type="module">
  const veBtn = document.getElementById('milkTraitsCard');
  veBtn?.addEventListener('click', () => {
    const qs  = new URLSearchParams(location.search);
    const id  = qs.get('animalId')
               || localStorage.getItem('currentAnimalId')
               || localStorage.getItem('lastAnimalId')
               || '';
    const url = id ? `visual-eval.html?focus=milk&animalId=${encodeURIComponent(id)}` : `visual-eval.html?focus=milk`;
    location.href = url;
  });
</script>

<script>
(function(){
  function todayCairo(){
    const now = new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'}));
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function buildQS(base){
    const qs = new URLSearchParams();
    const id     = localStorage.getItem('currentAnimalId')     || '';
    const number = localStorage.getItem('currentAnimalNumber') || '';
    const date   = localStorage.getItem('currentEventDate')    || todayCairo();

    if (id)     qs.set('animalId', id);
    if (number) qs.set('number', number);
    if (date)   qs.set('date', date);

    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      qs.set('demo','1');
    }
    return base + '?' + qs.toString();
  }

  // feces eval
  const feces = document.getElementById('fecesEvalCard');
  if(feces){
    const go = ()=> location.href = buildQS('feces-eval.html');
    feces.addEventListener('click', go);
    feces.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); go(); }});
  }

  // BCS â†’ Nutrition
  const bcs = document.getElementById('bcsNutritionCard');
  if(bcs){
    const go = ()=> location.href = buildQS('bcs-eval.html'); // ÙŠÙØªØ­ ØµÙØ­Ø© BCS Ù„Ø¯ÙŠÙƒ
    bcs.addEventListener('click', go);
    bcs.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); go(); }});
  }
})();
</script>

</body>
</html>
