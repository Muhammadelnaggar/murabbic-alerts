<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة التحكم - مربيك</title>
  <link rel="icon" type="image/png" sizes="32x32" href="img/dashboard-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="img/dashboard-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="img/dashboard-180.png">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{--bg:#fff9db;--card:#ffffff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20;overflow-x:hidden}
    h1{margin:0 0 16px;text-align:center;color:#1b5e20}
    /* لوجو العنوان */
    .brand{display:flex;align-items:center;justify-content:center;gap:10px}
    .brand-icon{height:28px;width:28px;object-fit:contain}
    .brand-icon-svg{height:28px;width:28px;display:inline-block;vertical-align:middle}
    @media(max-width:560px){.brand-icon{height:24px;width:24px}.brand-icon-svg{height:24px;width:24px}}
    @media(max-width:560px){.brand-icon{height:24px;width:24px}}
    

    /* الشبكة */
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}

    /* الكروت */
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)
    }

    /* البلاطات (قلب مربيك) */
    .tile{position:relative; background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
      padding:16px;text-align:center;font-weight:bold;cursor:pointer;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;min-height:118px;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease
    }
    .tile .icon{
      display:block;width:44px;height:44px;line-height:44px;border-radius:50%;
      border:1px solid var(--border);font-size:24px
    }
    .tile small{font-weight:normal;color:#335c33}
    .tile:hover{background:#dcedc8;transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .tile .badge{position:absolute;top:8px;left:8px;background:#f7fff4;border:1px solid var(--border);color:#335c33;border-radius:999px;padding:2px 8px;font-size:11px;box-shadow:0 1px 2px rgba(0,0,0,.04)}

    /* أيقونة مركّبة للبطاقة الذكية */
    .tile .icon.icon-layer{position:relative;display:inline-flex;align-items:center;justify-content:center}
    .icon-layer .i-main{font-size:24px;line-height:1}
    .icon-layer .i-badge{position:absolute;bottom:-4px;right:-4px;font-size:14px;background:#fff;border:1px solid var(--border);border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,.08)}

    /* ويدجت الطقس (نسخة مضغوطة) */
    #weatherCard{display:none;gap:12px;padding:10px 12px;display:grid;grid-template-columns:clamp(110px,34vw,160px) 1fr;align-items:center}
    #weatherCard.compact .wvals{display:grid;grid-template-columns:1fr;gap:8px}
    /* تخطيط الساعة يسار، البيانات يمين متكدسة */
    #weatherCard .thi-clock{grid-column:1;grid-row:1 / span 3;justify-self:center}
    #weatherCard #weatherBadge{grid-column:2;grid-row:1}
    #weatherCard #wRefresh{grid-column:2;grid-row:1;justify-self:end;align-self:start}
    #weatherCard .wvals{grid-column:2;grid-row:3}
    #weatherCard .herd-toggle{grid-column:2;grid-row:4;justify-content:flex-start}
    
    #weatherCard .loc-toggle{grid-column:2;grid-row:2;justify-content:flex-start}
    .loc-toggle{display:flex;gap:6px;align-items:center}
    .loc-toggle .seg{appearance:none;border:1px solid var(--green);background:#fff;color:#2e7d32;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    .loc-toggle .seg.active{background:var(--green);color:#fff}
    
    
    
    #weatherBadge .src{font-size:12px;color:#335c33;border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:#f7fff4;margin-inline-start:6px}
    #weatherCard.compact #weatherBadge{
      display:inline-flex;align-items:center;gap:8px;border-radius:999px;border:1px solid var(--border);
      padding:6px 10px;background:var(--muted);font-size:14px
    }
    #wLoc{font-weight:bold}
    #weatherCard.compact .wval{background:#f7fff4;border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:auto;width:100%;text-align:center;font-size:13px}
    .btn{appearance:none;border:1px solid var(--green);background:#fff;color:var(--green);
      border-radius:10px;padding:6px 10px;font-weight:bold;cursor:pointer;font-size:12px}
    .btn:hover{background:#f4fff1}

    /* محوّل نوع القطيع */
    .herd-toggle{display:flex;gap:6px;align-items:center}
    .herd-toggle .seg{appearance:none;border:1px solid var(--green);background:#fff;color:var(--green);border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    .herd-toggle .seg.active{background:var(--green);color:#fff}

    /* مؤشر THI الصغير */
    .thi-scale{min-width:160px;max-width:260px;display:flex;flex-direction:column;gap:4px}
    .thi-track{position:relative;height:8px;border-radius:999px;background:#e0e0e0;overflow:hidden}
    .thi-marker{position:absolute;top:50%;width:10px;height:10px;border:2px solid var(--green);background:#fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 0 2px rgba(255,255,255,.6)}
    .thi-labels{display:flex;justify-content:space-between;font-size:11px;color:#335c33;padding:0 2px}

    /* Tooltip THI */
    .thi-tooltip{position:absolute;top:-30px;transform:translateX(-50%);background:#1b5e20;color:#fff;font-size:11px;padding:4px 6px;border-radius:6px;white-space:nowrap;display:none}
    .thi-tooltip::after{content:'';position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);border-width:5px;border-style:solid;border-color:#1b5e20 transparent transparent transparent}

    /* مؤشر THI الصغير */
    .thi-scale{min-width:160px;max-width:260px;display:flex;flex-direction:column;gap:4px}
    .thi-track{position:relative;height:8px;border-radius:999px;background:#e0e0e0;overflow:hidden}
    .thi-marker{position:absolute;top:50%;width:10px;height:10px;border:2px solid var(--green);background:#fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 0 2px rgba(255,255,255,.6)}
    .thi-labels{display:flex;justify-content:space-between;font-size:11px;color:#335c33;padding:0 2px}

    /* Tooltip THI */
    .thi-tooltip{position:absolute;top:-30px;transform:translateX(-50%);background:#1b5e20;color:#fff;font-size:11px;padding:4px 6px;border-radius:6px;white-space:nowrap;display:none}
    .thi-tooltip::after{content:'';position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);border-width:5px;border-style:solid;border-color:#1b5e20 transparent transparent transparent}

    /* بلاطة كبيرة + أزرار فرعية */
    .tile-lg{min-height:140px}
    .tile-2x{grid-column:span 2}
    @media(max-width:560px){.tile-2x{grid-column:span 1}}
    .subactions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px}
    .subbtn{appearance:none;border:2px solid var(--green);background:#fff;color:var(--green);border-radius:999px;padding:12px 16px;font-size:16px;font-weight:700;cursor:pointer;min-width:160px}
    .subbtn:hover{background:#f4fff1}

    @media(max-width:560px){
      .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
      .tile{min-height:110px;padding:14px}
      .tile-m-full{grid-column:1 / -1}
    }
  /* عدّاد THI بشكل ساعة */
    .thi-clock{position:relative;width:clamp(110px,34vw,160px);height:clamp(110px,34vw,160px);margin:4px 6px}
    .thi-clock .dial{position:absolute;inset:0;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .thi-clock .arc{position:absolute;inset:0;border-radius:50%;-webkit-mask:radial-gradient(farthest-side, transparent 55%, #000 56%);mask:radial-gradient(farthest-side, transparent 55%, #000 56%)}
    .thi-clock .needle{position:absolute;left:50%;top:50%;width:2px;height:42%;background:#000;transform-origin:bottom center;transform:translate(-50%,-100%) rotate(var(--angle,-120deg));border-radius:2px;transition:transform .9s cubic-bezier(.22,.8,.2,1);will-change:transform}
    
    .thi-clock .center{position:absolute;left:50%;top:50%;width:8px;height:8px;border-radius:50%;background:#000;transform:translate(-50%,-50%)}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);-webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
   
    .thi-clock .needle::after{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:inherit}
    

    @media(max-width:560px){#weatherCard{grid-template-columns:clamp(110px,40vw,170px) 1fr;align-items:center}.herd-toggle{justify-content:flex-start}}
  
  
  @media (prefers-reduced-motion: reduce){ .thi-clock .needle{ transition:none } }
  /* منع أي سكرول أفقي وضمان تناسب العناصر مع الشاشة */
    html,body{overflow-x:hidden}
    #weatherCard,.dashboard{max-width:100%}
    .card,.tile{min-width:0}
    img,svg{max-width:100%;height:auto}
  img,svg{max-width:100%;height:auto}

.gauge { width: 100%; aspect-ratio: 2 / 1; position: relative; }
.gauge svg { width: 100%; height: 100%; display:block; }
.gauge .val {
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  font-weight:700; color:#065f46; font-size:22px;
}


  </style>
</head>
<body>
  <h1 class="brand">
    <img id="brandImg" class="brand-icon" alt="لوحة التحكم" style="display:none"/>
    <svg id="brandSvg" class="brand-icon-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="أيقونة لوحة التحكم">
      <!-- سهم/صح باللون الأزرق -->
      <path d="M6 38 L18 50 L40 18" fill="none" stroke="#1e88e5" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- قاعدة الأعمدة -->
      <rect x="28" y="46" width="30" height="6" rx="3" fill="#1e88e5"/>
      <!-- الأعمدة -->
      <rect x="30" y="30" width="6" height="16" rx="3" fill="#ef5350"/>
      <rect x="40" y="24" width="6" height="22" rx="3" fill="#fdd835"/>
      <rect x="50" y="16" width="6" height="30" rx="3" fill="#7cb342"/>
    </svg>
    لوحة التحكم - مربيك
  </h1>

  <!-- الطقس و THI (مضغوط) -->
  <div id="weatherCard" class="card" aria-label="الطقس و مؤشر الحرارة-الرطوبة">
    <div id="weatherBadge">
      <span>🌦️</span>
      <span id="wLoc">—</span>
      <span id="wSrc" class="src">المصدر: طقس</span>
    </div>
    <button id="wRefresh" class="btn" style="margin-inline-start:auto" type="button">تحديث</button>
    <div class="loc-toggle" role="group" aria-label="مصدر الموقع">
      <button class="seg" id="modeFarm" type="button">مزرعتي</button>
      <button class="seg" id="modeGPS" type="button">موقعي</button>
      <button class="btn" id="setFarmBtn" type="button" title="تعيين موقع المزرعة">تعيين</button>
    </div>
    
    <div class="wvals" style="flex:1">
      <div class="wval"><div>الحرارة</div><b id="wTemp">—°C</b></div>
      <div class="wval"><div>الرطوبة</div><b id="wHum">—%</b></div>
      <div class="wval"><div>THI</div><b id="wTHI">—</b></div>
      <div class="wval"><div>الحالة</div><b id="wState">—</b></div>
    </div>
    <div class="herd-toggle" role="group" aria-label="نوع القطيع">
      <button class="seg" id="herdCow" type="button">أبقار</button>
      <button class="seg active" id="herdBuffalo" type="button">جاموس</button>
    </div>
    <div class="thi-clock" aria-label="مؤشر THI">
      <div class="dial" id="thiDial"><div class="arc" id="thiArc"></div></div>
      <div class="needle" id="thiNeedle"></div>
      <div class="center"></div>
      <div class="thi-tooltip" id="thiTip" style="display:none"></div>
    </div>
  </div>

  <!-- روابط سريعة -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">➕</span>حيوان جديد</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">📋</span>حيواناتي</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">🗓️</span>حدث جديد</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">🔔</span>أرشيف التنبيهات</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon icon-layer"><span class="i-main">🐮</span><span class="i-badge">💳</span></span>البطاقة الذكية</div>

    <div class="tile" id="milkTraitsCard" role="button" tabindex="0">
      <span class="icon">🐄</span>
      سمات حيوان اللبن /كاميرا
    </div>

    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">📊</span>تقارير اللبن</div>
    <div class="tile" id="sensorsTile" role="button" tabindex="0">
      <span class="icon">🛰️</span>
      الأجهزة والحساسات
      <span class="badge" id="sensorsStatus">جارٍ الفحص…</span>
    </div>

    <!-- ⛔ تمت إزالة بلاطة تقييم الحيوانات (evaluation.html) بناءً على طلبك -->

    <!-- تقييم التغذية بالحالة الجسميّة (BCS) -->
    <div class="tile tile-lg tile-2x tile-m-full" id="smartNutritionTile" role="group" tabindex="0">
      <span class="icon">🧠</span>
      تقييم التغذية الذكي
      
      <div class="subactions" aria-label="اختيارات التقييم">
        <button class="subbtn" id="goFeces">الروث بالكاميرا</button>
        <button class="subbtn" id="goBCS">الحالة الجسميّة بالكاميرا</button>
        <button class="subbtn" id="goRation">تقييم العليقة</button>
      </div>
    </div>

    <!-- تقييم الروث بالكاميرا -->
    
  </div>
<!-- [HERD-ANALYSIS] نتائج القطيع -->
<section id="herd-analysis" style="margin:10px 12px">
  <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
    <div class="card" style="background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px">
      <h4 style="margin:0 0 6px;color:#11825d;font-size:14px">عِشار القطيع</h4>
      <div class="gauge" data-key="pregnant"></div>
      <div class="line" id="line-pregnant" style="font-size:13px;color:#333;margin-top:6px">—</div>
    </div>
    <div class="card" style="background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px">
      <h4 style="margin:0 0 6px;color:#11825d;font-size:14px">ملقّحات (نافذة التحليل)</h4>
      <div class="gauge" data-key="inseminated"></div>
      <div class="line" id="line-inseminated" style="font-size:13px;color:#333;margin-top:6px">—</div>
    </div>
    <div class="card" style="background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px">
      <h4 style="margin:0 0 6px;color:#11825d;font-size:14px">مفتوحة</h4>
      <div class="gauge" data-key="open"></div>
      <div class="line" id="line-open" style="font-size:13px;color:#333;margin-top:6px">—</div>
    </div>
    <div class="card" style="background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px">
      <h4 style="margin:0 0 6px;color:#11825d;font-size:14px">Conception%</h4>
      <div class="gauge" data-key="conception"></div>
      <div class="line" id="line-conception" style="font-size:13px;color:#333;margin-top:6px">—</div>
    </div>
  </div>

  <div class="card" style="margin-top:10px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px">
    <h4 style="margin:0 0 6px;color:#11825d;font-size:14px">ملخص أرقام</h4>
    <div id="herd-numbers" style="font-size:13px;color:#333">—</div>
  </div>
</section>
<script src="js/mbk-animals.js?v=2"></script>

<script>
// ويدجت الطقس — نسخة مستقلة مع محوّل أبقار/جاموس
(function(){
  const chip   = document.getElementById('weatherCard');
  const wLoc   = document.getElementById('wLoc');
  const wTemp  = document.getElementById('wTemp');
  const wHum   = document.getElementById('wHum');
  const wTHI   = document.getElementById('wTHI');
  const wState = document.getElementById('wState');
  const wSrc = document.getElementById('wSrc');
  const wRefresh = document.getElementById('wRefresh');
  const thiTrack = document.querySelector('.thi-track');
  const thiMarker = document.getElementById('thiMarker');
  const thiTip = document.getElementById('thiTip');
  const thiDial = document.getElementById('thiDial');
  const thiArc = document.getElementById('thiArc');
  const thiNeedle = document.getElementById('thiNeedle');
  const thiCenter = document.querySelector('.thi-clock .center');
  const thiL1 = document.getElementById('thiL1');
  const thiL2 = document.getElementById('thiL2');
  const thiL3 = document.getElementById('thiL3');
  const thiL4 = document.getElementById('thiL4');
  const herdCow = document.getElementById('herdCow');
  const herdBuffalo = document.getElementById('herdBuffalo');
  // عناصر وضع الموقع
  const modeFarm = document.getElementById('modeFarm');
  const modeGPS = document.getElementById('modeGPS');
  const setFarmBtn = document.getElementById('setFarmBtn');
  let tipTimer = null;
  function showTip(){ if(!thiTip) return; thiTip.style.display='block'; clearTimeout(tipTimer); tipTimer=setTimeout(()=>{ thiTip.style.display='none'; }, 1800);} 
  function hideTip(){ if(!thiTip) return; thiTip.style.display='none'; }

  // إظهار الويدجت فورًا
  chip.style.display='grid';
  chip.classList.add('compact');

  // الموقع بالـ GPS تلقائي
  wLoc.textContent = 'جارِ تحديد الموقع…';

  // محوّل نوع القطيع
  function getProfile(){ return (localStorage.getItem('herdProfile') === 'cow') ? 'cow' : 'buffalo'; }
  function setProfile(p){ localStorage.setItem('herdProfile', p); }
  function syncToggle(){
    const p = getProfile();
    herdCow?.classList.toggle('active', p==='cow');
    herdBuffalo?.classList.toggle('active', p==='buffalo');
  }

  // وضع الموقع (مزرعتي / موقعي)
  function getLocMode(){
    const saved = localStorage.getItem('locMode');
    if (saved==='gps' || saved==='farm') return saved;
    return localStorage.getItem('farmCoords') ? 'farm' : 'gps';
  }
  function setLocMode(m){ localStorage.setItem('locMode', m); syncLocMode(); }
  function syncLocMode(){
    const m = getLocMode();
    modeFarm?.classList.toggle('active', m==='farm');
    modeGPS?.classList.toggle('active', m==='gps');
  }
  function getFarmCoords(){ try{ const o = JSON.parse(localStorage.getItem('farmCoords')||'null'); return o && o.lat!=null && o.lon!=null ? o : null; }catch{ return null; }}
  async function setFarm(coords, name){ localStorage.setItem('farmCoords', JSON.stringify({lat:coords.lat, lon:coords.lon, name:name||''})); setLocMode('farm'); }

  // استخدام الحساسات (نعم/لا)

  const GEO = {
    'مصر:القاهرة': {lat:30.0444, lon:31.2357},
    'مصر:الجيزة':  {lat:30.0131, lon:31.2089},
    'مصر:الإسكندرية': {lat:31.2001, lon:29.9187},
    'مصر:الشرقية': {lat:30.587, lon:31.502}, // محافظة الشرقية (زقازيق تقريبًا)
    'السعودية:الرياض': {lat:24.7136, lon:46.6753},
    'السعودية:مكة المكرمة': {lat:21.3891, lon:39.8579},
    'الإمارات:دبي': {lat:25.2048, lon:55.2708},
    'قطر:الدوحة': {lat:25.2854, lon:51.5310},
    'الكويت:العاصمة': {lat:29.3759, lon:47.9774},
    'البحرين:العاصمة': {lat:26.2235, lon:50.5876},
    'عُمان:مسقط': {lat:23.5880, lon:58.3829}
  };

  function THI(c, rh){
    const f = c*9/5 + 32;
    return Math.round(((f - (0.55 - 0.0055*rh)*(f - 58)))*10)/10;
  }

  function bands(){
    return getProfile()==='cow' ? {t1:68,t2:72,t3:79,t4:84} : {t1:66,t2:70,t3:77,t4:82};
  }
  function colorAndText(thi, b){
    let txt;
    if (thi < b.t1) txt='مريح';
    else if (thi < b.t2) txt='اجهاد خفيف';
    else if (thi < b.t3) txt='اجهاد متوسط';
    else if (thi < b.t4) txt='اجهاد شديد';
    else txt='اجهاد شديد جدا';

    let bg;
    if (thi < b.t1) bg='#c8e6c9';
    else if (thi < b.t2) bg='#fff9c4';
    else if (thi < b.t3) bg='#ffe0b2';
    else if (thi < b.t4) bg='#ffccbc';
    else bg='#ffcdd2';
    return {bg, txt};
  }

  function saveCache(key, data){ localStorage.setItem('weather:'+key, JSON.stringify({...data, ts:Date.now()})); }
  function loadCache(key){ try{ const o=JSON.parse(localStorage.getItem('weather:'+key)||'null'); return o && (Date.now()-o.ts)<3600000 ? o : null;}catch{ return null; } }

  async function fetchWeather(lat, lon){
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`;
      const r = await fetch(url); const j = await r.json();
      return { t: j.current?.temperature_2m, h: j.current?.relative_humidity_2m };
    }catch{ return null; }
  }

  async function renderWeather(force=false){
    try{
      const coords = await getCoords(force);
      if(!coords){ chip.style.display='grid'; return; }
      const cacheKey = `${getLocMode()==='farm'?'farm':'gps'}:${coords.lat.toFixed(2)},${coords.lon.toFixed(2)}`;
      let data = !force && loadCache(cacheKey);
      if(!data){
        data = await fetchWeather(coords.lat, coords.lon);
        if(data && data.t!=null && data.h!=null) saveCache(cacheKey, data);
      }
      if(!data){ return; }

    // محاولة استخدام الحساسات إذا مفعّلة
    let usedSrc = 'weather';

      const place = coords.label || await reverseGeocode(coords.lat, coords.lon);
      wLoc.textContent = (getLocMode()==='farm') ? (place ? `مزرعتك: ${place}` : 'مزرعتك') : (place || 'موقعك الحالي');

      const b = bands();
      const thi = THI(data.t, data.h);
      const {bg, txt} = colorAndText(thi, b);

      if (thiArc){
        const minTHI=50, maxTHI=90;
        const pct = v => ((v - minTHI) * 100 / (maxTHI - minTHI));
        const arcSpanPct = 240/360*100; // ثلثا الساعة العلويان
        const pArc = v => (pct(v)/100) * arcSpanPct;
        const p1 = pArc(b.t1), p2 = pArc(b.t2), p3 = pArc(b.t3);
        thiArc.style.background = `conic-gradient(from -120deg, #90caf9 0% ${p1}%, #fff59d ${p1}% ${p2}%, #ffcc80 ${p2}% ${p3}%, #ef5350 ${p3}% ${arcSpanPct}%, transparent ${arcSpanPct}% 100%)`;
      }
      if (thiNeedle){
        const minTHI=50, maxTHI=90;
        const pct = v => ((v - minTHI) * 100 / (maxTHI - minTHI));
        const p = Math.max(0, Math.min(100, pct(thi)));
        const angle = -120 + (p * 2.4); // 0→100% عبر 240°
        thiNeedle.style.setProperty('--angle', angle + 'deg');
      }

      chip.style.background = bg;
    if (wSrc){ wSrc.textContent = (usedSrc==='sensor') ? 'المصدر: حساس' : 'المصدر: طقس'; }
      wTemp.textContent = `${Math.round(data.t)}°C`;
      wHum.textContent  = `${Math.round(data.h)}%`;
      wTHI.textContent  = thi;
      wState.textContent= txt;
    }catch(e){}
  }

  async function readGPS(force=false){
    try{
      const saved = JSON.parse(localStorage.getItem('lastGPS')||'null');
      if(saved && !force && (Date.now()-saved.ts) < 10*60*1000) return {lat:saved.lat, lon:saved.lon};
    }catch{}
    if (navigator.geolocation){
      try{
        const pos = await new Promise(res=>navigator.geolocation.getCurrentPosition(p=>res(p), _=>res(null), {maximumAge:600000, timeout:6000}));
        if(pos){
          const c={lat:pos.coords.latitude, lon:pos.coords.longitude};
          localStorage.setItem('lastGPS', JSON.stringify({...c, ts: Date.now()}));
          return c;
        }
      }catch{}
    }
    return null;
  }

  async function getCoords(force=false){
    const mode = getLocMode();
    if(mode==='farm'){
      const f = getFarmCoords();
      if (f) return {lat:f.lat, lon:f.lon, label:f.name||''};
      // لو غير محددة نرجع للـGPS
      const g = await readGPS(force);
      if (g) return g;
      return GEO['مصر:القاهرة'];
    } else {
      const g = await readGPS(force);
      if (g) return g;
      const f = getFarmCoords();
      if (f) return {lat:f.lat, lon:f.lon, label:f.name||''};
      return GEO['مصر:القاهرة'];
    }
  }

  async function reverseGeocode(lat, lon){
    try{
      const u = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=ar`;
      const r = await fetch(u); const j = await r.json();
      const g = j?.results?.[0];
      if(g){
        const parts = [g.country, g.admin1, g.name].filter(Boolean);
        return parts.join('، ');
      }
    }catch{}
    return 'موقعك الحالي';
  }

  // أحداث
  window.renderWeather = renderWeather; // للزر تحديث
  document.addEventListener('DOMContentLoaded', ()=> { syncToggle(); syncLocMode(); renderWeather(); });
  wRefresh?.addEventListener('click', ()=> { renderWeather(true); showTip(); });
  modeFarm?.addEventListener('click', ()=>{ setLocMode('farm'); renderWeather(true); });
  modeGPS?.addEventListener('click', ()=>{ setLocMode('gps');  renderWeather(true); });
  setFarmBtn?.addEventListener('click', async ()=>{
    let coords = await readGPS(true);
    if (!coords){
      const text = prompt('أدخل الإحداثيات بصيغة lat,lon (مثال: 30.59,31.50)');
      if (text){
        const parts = text.split(',').map(s=>parseFloat(s.trim()));
        if (parts.length===2 && !isNaN(parts[0]) && !isNaN(parts[1])) coords = {lat:parts[0], lon:parts[1]};
      }
    }
    if (coords){
      const name = await reverseGeocode(coords.lat, coords.lon);
      await setFarm(coords, name);
      renderWeather(true);
    }
  });
  herdCow?.addEventListener('click', ()=>{ setProfile('cow'); syncToggle(); renderWeather(true); });
  herdBuffalo?.addEventListener('click', ()=>{ setProfile('buffalo'); syncToggle(); renderWeather(true); });
  if (thiMarker){ thiMarker.addEventListener('mouseenter', showTip); thiMarker.addEventListener('mouseleave', hideTip); thiMarker.addEventListener('touchstart', (e)=>{ e.preventDefault(); showTip(); }, {passive:false}); }
})();
</script>

<script type="module">
  const veBtn = document.getElementById('milkTraitsCard');
  veBtn?.addEventListener('click', () => {
    const qs  = new URLSearchParams(location.search);
    const id  = qs.get('animalId')
               || localStorage.getItem('currentAnimalId')
               || localStorage.getItem('lastAnimalId')
               || '';
    const url = id ? `visual-eval.html?focus=milk&animalId=${encodeURIComponent(id)}` : `visual-eval.html?focus=milk`;
    location.href = url;
  });
</script>

<script>
(function(){
  function todayCairo(){
    const now = new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'}));
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function buildQS(base){
    const qs = new URLSearchParams();
    const id     = localStorage.getItem('currentAnimalId')     || '';
    const number = localStorage.getItem('currentAnimalNumber') || '';
    const date   = localStorage.getItem('currentEventDate')    || todayCairo();

    if (id)     qs.set('animalId', id);
    if (number) qs.set('number', number);
    if (date)   qs.set('date', date);

    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      qs.set('demo','1');
    }
    return base + '?' + qs.toString();
  }

  // اختيارات داخل بلاطة "تقييم التغذية الذكي"
  const fecesBtn  = document.getElementById('goFeces');
  if(fecesBtn){
    const go = ()=> location.href = buildQS('feces-eval.html');
    fecesBtn.addEventListener('click', go);
  }
  const bcsBtn    = document.getElementById('goBCS');
  if(bcsBtn){
    const go = ()=> location.href = buildQS('bcs-eval.html');
    bcsBtn.addEventListener('click', go);
  }
  const rationBtn = document.getElementById('goRation');
  if(rationBtn){
    const go = ()=> location.href = 'smart-feeding.html';
    rationBtn.addEventListener('click', go);
  }
})();
</script>

<script>
// بلاطة الأجهزة والحساسات: حالة اتصال سريعة + انتقال للصفحة
(function(){
  const tile = document.getElementById('sensorsTile');
  const badge = document.getElementById('sensorsStatus');
  function setBadge(txt, ok){ if(!badge) return; badge.textContent = txt; badge.style.background = ok?'#e8f5e9':'#fff8e1'; badge.style.borderColor = ok?'#c5e1a5':'#ffecb3'; }

  function getApiBase(){
    const v = (localStorage.getItem('API_BASE')||'').trim();
    if(!/^https?:\/\//.test(v) || v.includes('localhost')) return '';
    return v;
  }

  async function ping(){
    try{
      setBadge('جارٍ الاتصال…', false);
      const ctl = new AbortController(); const to = setTimeout(()=>ctl.abort(), 30000); // 15s بسبب Cold Start
      const API_BASE = getApiBase();
      const url = API_BASE ? `${API_BASE}/api/sensors/health` : '/api/sensors/health';
      const opts = { signal: ctl.signal };
      if (API_BASE) opts.mode = 'cors';
      const r = await fetch(url, opts); clearTimeout(to);

      if (r.status === 503){ setBadge('غير مفعّل', false); return; } // السيرفر بدون Service Account
      if (!r.ok){ setBadge('غير متصل', false); return; }

      const j = await r.json();
      const n = Number(j?.devices||0);
      setBadge(`متصل • ${n}`, true);
    }catch{ setBadge('غير متصل', false); }
  }

  tile?.addEventListener('click', ()=>{ location.href='sensor-test.html'; });
  document.addEventListener('DOMContentLoaded', ()=>{
    ping();
    setTimeout(ping, 6000);   // محاولة ثانية بعد 6 ثواني
    setTimeout(ping, 25000);  // محاولة ثالثة تحسبًا لـ Cold Start الطويل
    setInterval(ping, 60000); // تحديث كل دقيقة
  });
})();

// تحميل أيقونة العنوان من السيرفر مع بدائل تلقائية
<script>
(function(){
  const img = document.getElementById('brandImg');
  const svg = document.getElementById('brandSvg');
  if(!img) return;

  // جرّب المسارات الصحيحة فقط (بدون /www/)
  const candidates = [
    'images/dashboard.svg',
    'images/dashboard.png',
    'images/dashboard.webp',
    'images/dashboard.jpg'
  ];

  function tryLoad(i){
    if(i >= candidates.length) return; // يظل يستخدم الـSVG المضمّن
    const src = candidates[i] + (candidates[i].includes('?') ? '' : '?v=1');
    const test = new Image();
    test.onload = ()=>{
      img.src = src;
      img.style.display = 'inline-block';
      svg && svg.remove();
    };
    test.onerror = ()=> tryLoad(i+1);
    test.src = src;
  }
  tryLoad(0);
})();
</script>

  function tryLoad(i){
    if(i>=candidates.length) return; // هيفضل يستخدم الـSVG المضمّن
    const src = candidates[i];
    const test = new Image();
    test.onload = ()=>{ img.src = src; img.style.display='inline-block'; if(svg) svg.remove(); };
    test.onerror = ()=> tryLoad(i+1);
    test.src = src + (src.includes('?')?'':'?v=1');
  }
  tryLoad(0);
})();
</script>
  <!-- قبل </body> مباشرة -->
<script src="js/herd-gauges.js?v=2"></script>
<script src="js/smart-alerts.js?v=2"></script>
</body>
</html>






