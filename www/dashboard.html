<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>

  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <link rel="stylesheet" href="/css/forms.css">

  <style>
    :root{
      --bg:#fff9db;
      --card:#ffffff;
      --muted:#e8f5e9;
      --green:#2e7d32;
      --border:#c5e1a5;
      --text:#1b5e20;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:10px;
      background:var(--bg);
      font-family:Arial,Helvetica,sans-serif;
      color:var(--text);
      direction:rtl;
    }
    h1{
      margin:8px 0 10px;
      text-align:center;
      color:var(--green);
      font-size:24px;
      font-weight:800;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:8px;
      margin-bottom:8px;
      box-shadow:0 1px 4px rgba(0,0,0,.04);
    }
    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    #thiBar{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-size:12px;
      background:#e8f5e9;
    }
    #thiBar strong{color:#1b5e20;}
    #thiStatus{font-weight:bold;}

    /* THI mini gauge */
    .thi-mini{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      font-size:11px;
    }
    .thi-circle{
      width:40px;height:40px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:bold;font-size:13px;
      border:2px solid #c5e1a5;
      background:#fff;
    }

    /* Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª Ø§Ù„Ù…Ø®ØªØµØ±Ø© */
    .tiles{
      display:grid;
      grid-template-columns:repeat(3,minmax(90px,1fr));
      gap:6px;
      margin-bottom:8px;
    }
    .tile{
      background:#eafbe7;
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px 2px;
      text-align:center;
      font-size:10px;
      cursor:pointer;
    }

    /* Ø¹Ù†ÙˆØ§Ù† Ù‚Ø³Ù… */
    .section-title{
      font-weight:800;
      font-size:13px;
      margin:4px 2px 4px;
      color:#1b5e20;
      display:flex;
      align-items:center;
      gap:6px;
    }

    /* ÙƒÙ„ Ù…Ø¤Ø´Ø±ÙŠÙ† ÙÙŠ ØµÙ */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
    }
    .kpi{
      background:#ffffff;
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px;
      font-size:9px;
      display:flex;
      flex-direction:column;
      gap:1px;
      min-height:40px;
    }
    .kpi-label{font-weight:700;color:#1b5e20;}
    .kpi-value{font-size:15px;font-weight:800;color:#066b3b;}
    .kpi-sub{font-size:8px;color:#607d8b;}

    #statusBar{
      margin-top:4px;
      font-size:9px;
      text-align:center;
      color:#388e3c;
    }
  </style>
</head>
<body>
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>

  <!-- Ø´Ø±ÙŠØ· THI Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© -->
  <div id="thiBar" class="card">
    <div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©: <strong id="wxTemp">--</strong>Â°C |
      Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: <strong id="wxHum">--</strong>% |
      THI: <strong id="wxTHI">--</strong>
    </div>
    <div class="thi-mini">
      <div class="thi-circle" id="thiCircle">--</div>
      <div>Ø§Ù„Ø­Ø§Ù„Ø©: <span id="thiStatus">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±...</span></div>
    </div>
  </div>

  <!-- Ø§Ø®ØªØµØ§Ø±Ø§Øª -->
  <div class="tiles">
    <div class="tile" onclick="location.href='add-animal.html'">â• Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='animal-list.html'">ğŸ“‹ Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
    <div class="tile" onclick="location.href='add-event.html'">ğŸ—“ï¸ Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='alerts.html'">ğŸ”” Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
    <div class="tile" onclick="location.href='cow-card.html'">ğŸ® Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>
    <div class="tile" onclick="location.href='groups.html'">ğŸ‘¥ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø±Ø¨ÙŠÙƒ</div>
    <div class="tile" onclick="location.href='milk-reports.html'">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="tile" onclick="location.href='sensor-test.html'">ğŸ›°ï¸ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª</div>
    <div class="tile" onclick="location.href='nutrition-eval.html'">ğŸ¥— ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ©</div>
  </div>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ -->
  <div class="card">
    <div class="section-title">ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ (ØªÙ†Ø§Ø³Ù„ÙŠ + Ø¥Ù†ØªØ§Ø¬ÙŠ)</div>
    <div id="kpiGrid" class="kpi-grid">
      <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø³ÙƒØ±Ø¨Øª -->
    </div>
    <div id="statusBar">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹...</div>
  </div>

<script>
// ================= Ø¥Ø¹Ø¯Ø§Ø¯ API_BASE =================
// Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ø´ØºØ§Ù„Ø© Ù…Ù† Render Ø£Ùˆ Ø¯ÙˆÙ…ÙŠÙ† Ø­Ù‚ÙŠÙ‚ÙŠ â†’ relative
// Ù„Ùˆ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ file:/// â†’ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Render
const API_BASE = (location.origin.startsWith('http') && !location.origin.startsWith('file'))
  ? ''
  : 'https://murabbic-alerts.onrender.com';

// Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ tenant / userId
function getTenantId(){
  const T = window.__TENANT__ || {};
  return T.userId || T.uid || T.id ||
         localStorage.getItem('userId') ||
         localStorage.getItem('uid') ||
         'demo-user';
}
const TENANT_ID = getTenantId();

// ============= Ø³ÙƒØ±Ø¨Øª THI (Ø·Ù‚Ø³ Ù…Ù† Open-Meteo) =============
async function loadWeatherTHI(){
  const tEl = document.getElementById('wxTemp');
  const hEl = document.getElementById('wxHum');
  const thiEl = document.getElementById('wxTHI');
  const statusEl = document.getElementById('thiStatus');
  const circle = document.getElementById('thiCircle');

  try{
    // Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© ÙƒÙ€ DefaultØ› ØªÙ‚Ø¯Ø± ØªØºÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²Ø±Ø¹Ø©
    const lat=30.0444, lon=31.2357;
    const r = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`,
      {cache:'no-store'}
    );
    const j = await r.json();
    const t = Math.round(j.current.temperature_2m);
    const h = Math.round(j.current.relative_humidity_2m);
    const thi = Math.round(((t*9/5+32) - (0.55-0.0055*h)*((t*9/5+32)-58)));

    tEl.textContent=t;
    hEl.textContent=h;
    thiEl.textContent=thi;
    circle.textContent=thi;

    let txt,bg,color;
    if(thi<68){txt='Ø±Ø§Ø­Ø©';bg='#c8e6c9';color='#2e7d32';}
    else if(thi<72){txt='Ø¥Ø¬Ù‡Ø§Ø¯ Ø®ÙÙŠÙ';bg='#fff9c4';color='#f9a825';}
    else if(thi<78){txt='Ø¥Ø¬Ù‡Ø§Ø¯ Ù…ØªÙˆØ³Ø·';bg='#ffe0b2';color='#fb8c00';}
    else{txt='Ø¥Ø¬Ù‡Ø§Ø¯ Ø¹Ø§Ù„ÙŠ';bg='#ffcdd2';color='#e53935';}
    statusEl.textContent=txt;
    statusEl.style.color=color;
    circle.style.background=bg;
    circle.style.borderColor=color;
    circle.style.color=color;
  }catch(e){
    statusEl.textContent='ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹';
    statusEl.style.color='#e53935';
  }
}

// ============= Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ =============
async function fetchJSON(path){
  const res = await fetch(API_BASE + path,{
    headers:{'X-User-Id':TENANT_ID},
    cache:'no-store'
  });
  if(!res.ok) throw new Error(path+' '+res.status);
  return res.json();
}

function norm(s){
  return String(s||'').toLowerCase()
    .replace(/[\u0610-\u061a\u064b-\u065f\u0670\u06d6-\u06ed]/g,'')
    .trim();
}
function toDate(v){
  if(!v) return null;
  if(typeof v==='number') return new Date(v);
  const s=String(v);
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00');
  return new Date(s);
}
function daysBetween(a,b){return Math.floor((a-b)/86400000);}

function isActive(an){
  const st = norm(an.status||an.lifeStatus||'');
  if(['sold','dead','died','archived','inactive','Ù…Ø¨Ø§Ø¹','Ù…Ø¨Ø§Ø¹Ø©','Ù†Ø§ÙÙ‚','Ù…ÙŠØª'].includes(st)) return false;
  if(an.active===false) return false;
  return true;
}
function isInMilk(an){
  if(an.inMilk===true) return true;
  if(an.inMilk===false) return false;
  const st = norm(an.productionStatus||an.lactationStatus||'');
  if(st.includes('dry')||st.includes('Ø¬Ø§Ù')) return false;
  return /(milk|lact|Ø­Ù„Ø§Ø¨|Ù…Ø­Ù„Ø¨|Ù…Ù†ØªØ¬)/.test(st);
}
function getDIM(an){
  const calv = toDate(an.lastCalvingDate || an.calvingDate);
  if(!calv) return 0;
  return Math.max(0, daysBetween(new Date(), calv));
}

async function loadHerdKPIs(){
  const statusBar = document.getElementById('statusBar');
  const grid = document.getElementById('kpiGrid');

  const box = (label,val,sub='') =>
    `<div class="kpi">
       <div class="kpi-label">${label}</div>
       <div class="kpi-value">${val ?? '-'}</div>
       ${sub?`<div class="kpi-sub">${sub}</div>`:''}
     </div>`;

  try{
    const [stats, animalsResp] = await Promise.all([
      fetchJSON('/api/herd-stats'),
      fetchJSON('/api/animals')
    ]);

    const animals = (animalsResp || []).filter(isActive);
    const total = animals.length;

    // Ø­Ù„ÙŠØ¨
    let inMilk=0, dimSum=0, milkTotal=0, milkCount=0;
    for(const an of animals){
      if(isInMilk(an)){
        inMilk++;
        dimSum += getDIM(an);
      }
      const m = Number(an.dailyMilk || an.lastMilkKg || 0);
      if(m>0){milkTotal+=m;milkCount++;}
    }
    const inMilkPct = total ? Math.round(inMilk*100/total) : 0;
    const avgDIM = inMilk ? Math.round(dimSum/inMilk) : 0;
    const avgMilk = milkCount ? +(milkTotal/milkCount).toFixed(1) : 0;
    if(!milkTotal && avgMilk && inMilk) milkTotal = Math.round(avgMilk*inMilk);

    // Ù…Ù† /api/herd-stats
    const t = stats.totals || {};
    const fert = stats.fertility || {};
    const pregPct = t.pregnant?.pct ?? 0;

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª (ÙƒÙ„ 2 ÙÙŠ ØµÙ)
    grid.innerHTML =
      // ØªÙ†Ø§Ø³Ù„ÙŠ
      box('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©', t.totalActive ?? total, 'Ù…Ø³ØªØ¨Ø¹Ø¯ Ù…Ù†Ù‡Ø§ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©/Ø§Ù„Ù†Ø§ÙÙ‚Ø©/Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©') +
      box('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø­Ù„ÙŠØ¨', inMilk ? `${inMilk} (${inMilkPct}%)` : '0', 'Ù†Ø³Ø¨ØªÙ‡Ù… Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹') +
      box('Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø±', pregPct ? pregPct+'%' : '0%', 'Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø´Ø·') +
      box('Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø®ØµØ§Ø¨ %', fert.conceptionRatePct!=null? fert.conceptionRatePct+'%' : '0%', 'Ù…Ù† Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©') +
      box('Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©', '--', 'Ù…Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø­ØªÙ‰ Ø§Ù„Ø­Ù…Ù„ (ÙŠÙØ³ØªÙƒÙ…Ù„ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø«)') +
      box('Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ù…Ù„ (Ù†Ø§ÙØ°Ø© 21 ÙŠÙˆÙ…)', '--', 'ÙŠØªØ·Ù„Ø¨ Ø£Ø­Ø¯Ø§Ø« Ø´ÙŠØ§Ø¹/ØªÙ„Ù‚ÙŠØ­ Ù…Ù†ØªØ¸Ù…Ø©') +
      box('Ø®Ø¯Ù…Ø§Øª Ù„ÙƒÙ„ Ø­Ù…Ù„ (S/C)', '--', 'Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª / Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…ÙˆÙ„') +
      box('Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶', '--', 'Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù…ÙˆÙ„') +
      box('Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø§ÙÙ‚Ø©', '--', 'Dead Calving Rate') +
      box('Ø§Ù„Ø¹Ù…Ø± Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ÙˆÙ„Ø§Ø¯Ø© (Ø´Ù‡Ø±)', '--') +
      // Ø¥Ù†ØªØ§Ø¬ÙŠ
      box('Ù…ØªÙˆØ³Ø· Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†/Ø¨Ù‚Ø±Ø©', avgMilk? avgMilk+' ÙƒØ¬Ù…':'--', 'Ø­Ø³Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¨Ù† Ø§Ù„Ù…Ø³Ø¬Ù„Ø©') +
      box('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ', milkTotal? milkTotal+' ÙƒØ¬Ù…':'--', 'ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø· Ã— Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ø§Ø¨') +
      box('Ù…ØªÙˆØ³Ø· DIM', avgDIM || '--', 'Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ø­Ù„ÙŠØ¨ Ù„Ù„Ø£Ø¨Ù‚Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø©') +
      box('Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø¨Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø­Ù„ÙŠØ¨', inMilkPct? inMilkPct+'%':'--', 'Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø´Ø·') +
      // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯
      box('Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø¥Ù†ØªØ§Ø¬ÙŠ', '--') +
      box('Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØªÙ†Ø§Ø³Ù„ÙŠ', '--') +
      box('Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØµØ­ÙŠ', '--') +
      // ØªØºØ°ÙŠØ©
      box('ÙƒÙØ§Ø¡Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù„Ù Ø¥Ù„ÙŠ Ù„Ø¨Ù†', '--', 'ÙŠØªØ·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØªØºØ°ÙŠØ©') +
      box('ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø§ÙØ© Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø©', '--') +
      box('ØµØ§ÙÙŠ Ø¯Ø®Ù„ Ø§Ù„Ù„Ø¨Ù† Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„ØªØºØ°ÙŠØ©', '--') +
      box('ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø±ÙˆØ«', '--') +
      box('ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ù…ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', '--');

    statusBar.textContent = 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ.';
  }catch(e){
    console.error('herd stats error', e);
    statusBar.textContent = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† /api/herd-stats Ø£Ùˆ /api/animals.';
  }
}

// ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
document.addEventListener('DOMContentLoaded',()=>{
  loadWeatherTHI();
  loadHerdKPIs();
});
</script>

<!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª -->
<script src="/js/tenant-bootstrap.js"></script>
<script src="/js/app-core.js" type="module"></script>
</body>
</html>
