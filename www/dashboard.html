<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø¤ÙƒÙ‘Ø¯Ø© -->
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1b5e20"/>

  <style>
    :root{--bg:#fff9db;--card:#fff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:#1b5e20}

    /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
    .brand{display:flex;align-items:center;justify-content:center;gap:10px}
    .brand-icon{height:28px;width:28px;object-fit:contain;display:none}
    .brand-icon-svg{height:28px;width:28px;display:inline-block;vertical-align:middle}

    /* ÙƒØ±ÙˆØª Ø¹Ø§Ù…Ø© */
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}

    /* ====== Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… (ÙƒÙ„Ø§Ø³ÙŠÙƒ) ====== */
    #weatherClassic{background:#ffe3e8;border:1.5px solid #ffccd5;border-radius:16px;padding:12px}
    #weatherClassic .bar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    #weatherClassic .seg{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    #weatherClassic .seg.active{background:#2e7d32;color:#fff}
    #weatherClassic .btn{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:8px;padding:4px 10px;font-size:12px;cursor:pointer}
    #weatherClassic .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    #weatherClassic .pill{background:#f7fff4;border:1px solid #c5e1a5;border-radius:12px;padding:8px;text-align:center}
    #weatherClassic .pill b{display:block;margin-top:4px}
    #weatherClassic .right{grid-row:1 / span 3;grid-column:2;display:flex;align-items:center;justify-content:center}

    /* Ø³Ø§Ø¹Ø© THI (ÙƒÙ…Ø§ Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©) */
    .thi-clock{position:relative;width:160px;height:160px}
    .thi-clock .dial{position:absolute;inset:0;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .thi-clock .arc{position:absolute;inset:0;border-radius:50%;
      -webkit-mask:radial-gradient(farthest-side,transparent 55%, #000 56%);
              mask:radial-gradient(farthest-side,transparent 55%, #000 56%)}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;
      background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);
      -webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);
              mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .needle{position:absolute;left:50%;top:50%;width:2px;height:42%;background:#000;transform-origin:bottom center;
      transform:translate(-50%,-100%) rotate(var(--angle,-120deg));border-radius:2px;transition:transform .9s cubic-bezier(.22,.8,.2,1)}
    .thi-clock .needle::after{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:inherit}
    .thi-clock .center{position:absolute;left:50%;top:50%;width:8px;height:8px;border-radius:50%;background:#000;transform:translate(-50%,-50%)}

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª */
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .tile{position:relative;background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
      padding:16px;text-align:center;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;
      align-items:center;justify-content:center;gap:6px;min-height:118px}
    .tile .icon{display:block;width:44px;height:44px;line-height:44px;border-radius:50%;border:1px solid var(--border);font-size:24px}
    .tile .badge{position:absolute;top:8px;left:8px;background:#f7fff4;border:1px solid var(--border);color:#335c33;border-radius:999px;padding:2px 8px;font-size:11px}

    /* Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ (herd-gauges) */
    .gauge{width:100%;aspect-ratio:2/1;position:relative}
    .gauge svg{width:100%;height:100%;display:block}
    .gauge .val{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#065f46;font-size:22px}

    /* Ø¨Ù„Ø§Ø·Ø© ÙƒØ¨ÙŠØ±Ø© */
    .tile-lg{min-height:140px}
    .tile-2x{grid-column:span 2}
    .subactions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px}
    .subbtn{appearance:none;border:2px solid var(--green);background:#fff;color:#2e7d32;border-radius:999px;padding:12px 16px;font-size:16px;font-weight:700;cursor:pointer;min-width:160px}
    .subbtn:hover{background:#f4fff1}

    @media(max-width:560px){
      .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
      .tile{min-height:110px;padding:14px}
      .tile-m-full{grid-column:1 / -1}
    }
  </style>
</head>
<body>
  <h1 class="brand">
    <img id="brandImg" class="brand-icon" alt="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"/>
    <svg class="brand-icon-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Ù„ÙˆØ­Ø©">
      <path d="M6 38 L18 50 L40 18" fill="none" stroke="#1e88e5" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="28" y="46" width="30" height="6" rx="3" fill="#1e88e5"/>
      <rect x="30" y="30" width="6" height="16" rx="3" fill="#ef5350"/>
      <rect x="40" y="24" width="6" height="22" rx="3" fill="#fdd835"/>
      <rect x="50" y="16" width="6" height="30" rx="3" fill="#7cb342"/>
    </svg>
    Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ
  </h1>

  <!-- ================== Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… (ÙƒÙ…Ø§ ÙƒØ§Ù†) ================== -->
  <div id="weatherClassic" class="card" aria-label="Ø§Ù„Ø·Ù‚Ø³ Ùˆ Ù…Ø¤Ø´Ø± THI">
    <div class="bar">
      <button class="btn" id="wxRefresh" type="button">ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn" id="wxPin" type="button">Ø«Ø¨Ù‘Øª</button>
      <span style="margin-inline-start:auto;font-weight:bold;">Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
      <button class="seg" id="segFarm" type="button">Ù…Ø²Ø±Ø¹ØªÙŠ</button>
      <button class="seg" id="segGPS" type="button">Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>

    <div class="grid">
      <div class="pill"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wxTemp">â€”Â°C</b></div>
      <div class="right">
        <div class="thi-clock">
          <div class="dial"><div id="thiArc" class="arc"></div></div>
          <div id="thiNeedle" class="needle"></div>
          <div class="center"></div>
        </div>
      </div>
      <div class="pill"><div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wxHum">â€”%</b></div>
      <div class="pill"><div>THI</div><b id="wxTHI">â€”</b></div>
      <div class="pill" style="grid-column:1 / span 2"><div>Ø§Ù„Ø­Ø§Ù„Ø©</div><b id="wxState">â€”</b></div>
    </div>
  </div>
  <!-- ============================================================= -->

  <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª / Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">ğŸ®</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>

    <div class="tile" id="milkTraitsCard" role="button" tabindex="0">
      <span class="icon">ğŸ„</span>
      Ø³Ù…Ø§Øª Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ù„Ø¨Ù† /ÙƒØ§Ù…ÙŠØ±Ø§
    </div>

    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>

    <div class="tile" id="sensorsTile" role="button" tabindex="0">
      <span class="icon">ğŸ›°ï¸</span>
      Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª
      <span class="badge" id="sensorsStatus">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦</span>
    </div>

    <div class="tile tile-lg tile-2x tile-m-full" id="smartNutritionTile" role="group" tabindex="0">
      <span class="icon">ğŸ§ </span>
      ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ
      <div class="subactions" aria-label="Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…">
        <button class="subbtn" id="goFeces">Ø§Ù„Ø±ÙˆØ« Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="subbtn" id="goBCS">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ù…ÙŠÙ‘Ø© Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="subbtn" id="goRation">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù„ÙŠÙ‚Ø©</button>
      </div>
    </div>
  </div>

  <!-- [HERD-ANALYSIS] Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚Ø·ÙŠØ¹ -->
  <section id="herd-analysis" style="margin:10px 12px">
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
      <div class="card"><h4 style="margin:0 0 6px;color:#11825d;font-size:14px">Ø¹ÙØ´Ø§Ø± Ø§Ù„Ù‚Ø·ÙŠØ¹</h4><div class="gauge" data-key="pregnant"></div><div class="line" id="line-pregnant" style="font-size:13px;color:#333;margin-top:6px">â€”</div></div>
      <div class="card"><h4 style="margin:0 0 6px;color:#11825d;font-size:14px">Ù…Ù„Ù‚Ù‘Ø­Ø§Øª (Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„)</h4><div class="gauge" data-key="inseminated"></div><div class="line" id="line-inseminated" style="font-size:13px;color:#333;margin-top:6px">â€”</div></div>
      <div class="card"><h4 style="margin:0 0 6px;color:#11825d;font-size:14px">Ù…ÙØªÙˆØ­Ø©</h4><div class="gauge" data-key="open"></div><div class="line" id="line-open" style="font-size:13px;color:#333;margin-top:6px">â€”</div></div>
      <div class="card"><h4 style="margin:0 0 6px;color:#11825d;font-size:14px">Conception%</h4><div class="gauge" data-key="conception"></div><div class="line" id="line-conception" style="font-size:13px;color:#333;margin-top:6px">â€”</div></div>
    </div>
    <div class="card" style="margin-top:10px"><h4 style="margin:0 0 6px;color:#11825d;font-size:14px">Ù…Ù„Ø®Øµ Ø£Ø±Ù‚Ø§Ù…</h4><div id="herd-numbers" style="font-size:13px;color:#333">â€”</div></div>
  </section>
  <!-- ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ -->
<script> if (localStorage.getItem('SMART_ON') === null) localStorage.setItem('SMART_ON','1'); </script>

  <!-- Ø«Ø¨Ù‘Øª dataLayer + t.event (Ù‚Ø¨Ù„ Ø£ÙŠ Ø³ÙƒØ±Ø¨Øª) -->
  <script>
    window.dataLayer = window.dataLayer || [];
    window.t = window.t || { event: (name, props) => { try{ window.dataLayer.push({ event:name, ts:Date.now(), ...(props||{}) }); }catch(e){} } };
  </script>
  <script>
  if (localStorage.getItem('SMART_ON') === null) localStorage.setItem('SMART_ON','1');
</script>

  <!-- ØªØ­Ù„ÙŠÙ„Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©: ÙŠØ³Ø¬Ù„ page_view ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ -->
  <script src="/js/app-core.js" defer></script>

  <!-- Firebase (Ù„Ù„Ù€ timeline/alerts) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyB0dtFS3R-MQ-LJfd_dB1YOTxiwDVshIYc",
      authDomain: "murabbik.firebaseapp.com",
      projectId: "murabbik",
      storageBucket: "murabbik.appspot.com",
      messagingSenderId: "402719243568",
      appId: "1:402719243568:web:631114a260d23202dd5cf5"
    };
    const app = initializeApp(firebaseConfig);
    getFirestore(app);
  </script>

  <!-- Ø§Ù„Ø®Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ + Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠØ© -->
  <script type="module" src="/js/timeline.js"></script>
  <script type="module" src="/js/smart-checks.js"></script>

  <!-- ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ± Ø¨ØµØ±ÙŠ) -->
  <script type="module">
    const tenantId = localStorage.getItem('tenantId') || 'default';
    const userId   = localStorage.getItem('userId');
    timeline?.init({ tenantId, userId });
    smart?.startAlertsWatcher({ tenantId, userId, onAlert: a => alert('ğŸ”” ' + a.message) });
  </script>

  <!-- ===== ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ (Ø³ÙƒØ±Ø¨Øª Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…) ===== -->
  <script>
    (function(){
      const segFarm = document.getElementById('segFarm');
      const segGPS  = document.getElementById('segGPS');
      const btnRef  = document.getElementById('wxRefresh');
      const btnPin  = document.getElementById('wxPin');
      const tEl = document.getElementById('wxTemp');
      const hEl = document.getElementById('wxHum');
      const thiEl = document.getElementById('wxTHI');
      const sEl = document.getElementById('wxState');
      const thiArc = document.getElementById('thiArc');
      const thiNeedle = document.getElementById('thiNeedle');

      function getMode(){ return (localStorage.getItem('locMode')==='farm')?'farm':'gps'; }
      function setMode(m){ localStorage.setItem('locMode',m); syncSeg(); }
      function syncSeg(){ const m=getMode(); segFarm.classList.toggle('active',m==='farm'); segGPS.classList.toggle('active',m==='gps'); }
      function getFarm(){ try{ const x=JSON.parse(localStorage.getItem('farmCoords')||'null'); return (x&&x.lat!=null)?x:null; }catch{return null;} }
      async function setFarm(c){ localStorage.setItem('farmCoords',JSON.stringify(c)); setMode('farm'); }

      function THI(c,rh){ const f=c*9/5+32; return Math.round(((f-(0.55-0.0055*rh)*(f-58)))*10)/10; }
      function bands(buffalo=true){ return buffalo?{t1:66,t2:70,t3:77,t4:82}:{t1:68,t2:72,t3:79,t4:84}; }
      function colorAndText(thi,b){
        if(thi<b.t1) return {bg:'#c8e6c9',txt:'Ù…Ø±ÙŠØ­'};
        if(thi<b.t2) return {bg:'#fff9c4',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø®ÙÙŠÙ'};
        if(thi<b.t3) return {bg:'#ffe0b2',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ù…ØªÙˆØ³Ø·'};
        if(thi<b.t4) return {bg:'#ffccbc',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯'};
        return {bg:'#ffcdd2',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯ Ø¬Ø¯Ø§'};
      }

      async function readGPS(force=false){
        try{ const c=JSON.parse(localStorage.getItem('lastGPS')||'null'); if(c && !force && (Date.now()-c.ts)<600000) return {lat:c.lat,lon:c.lon}; }catch{}
        if(navigator.geolocation){
          try{ const pos=await new Promise(res=>navigator.geolocation.getCurrentPosition(p=>res(p),_=>res(null),{maximumAge:600000,timeout:6000}));
               if(pos){ const out={lat:pos.coords.latitude,lon:pos.coords.longitude}; localStorage.setItem('lastGPS',JSON.stringify({...out,ts:Date.now()})); return out; } }catch{}
        }
        return null;
      }

      async function getCoords(force=false){
        const m=getMode();
        if(m==='farm'){ const f=getFarm(); if(f) return f; const g=await readGPS(force); if(g) return g; return {lat:30.0444,lon:31.2357}; }
        else { const g=await readGPS(force); if(g) return g; const f=getFarm(); if(f) return f; return {lat:30.0444,lon:31.2357}; }
      }

      async function fetchWeather(lat,lon){
        try{
          const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`);
          const j=await r.json();
          return { t:j.current?.temperature_2m, h:j.current?.relative_humidity_2m };
        }catch{ return null; }
      }

      function drawTHI(thi,isBuffalo=true){
        const b=bands(isBuffalo);
        if(thiArc){
          const min=50,max=90,p=v=>((v-min)*100/(max-min)), span=240/360*100, pArc=v=>(p(v)/100)*span;
          const p1=pArc(b.t1),p2=pArc(b.t2),p3=pArc(b.t3);
          thiArc.style.background = `conic-gradient(from -120deg,#90caf9 0% ${p1}%,#fff59d ${p1}% ${p2}%,#ffcc80 ${p2}% ${p3}%,#ef5350 ${p3}% ${span}%,transparent ${span}% 100%)`;
        }
        if(thiNeedle){
          const min=50,max=90,p=v=>((v-min)*100/(max-min));
          const ang=-120+Math.max(0,Math.min(100,p(thi)))*2.4;
          thiNeedle.style.setProperty('--angle',ang+'deg');
        }
        const {bg,txt}=colorAndText(thi,b);
        document.getElementById('weatherClassic').style.background = bg;
        sEl.textContent = txt;
      }

      async function render(force=false){
        syncSeg();
        const c = await getCoords(force);
        if(!c) return;
        const data = await fetchWeather(c.lat,c.lon);
        if(!data) return;
        const t = Math.round(data.t), h = Math.round(data.h);
        const thi = THI(t, h);
        tEl.textContent = `${t}Â°C`;
        hEl.textContent = `${h}%`;
        thiEl.textContent = thi;
        drawTHI(thi,true); // Ø¬Ø§Ù…ÙˆØ³ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
      }

      segFarm.addEventListener('click', ()=>{ setMode('farm'); render(true); });
      segGPS .addEventListener('click', ()=>{ setMode('gps');  render(true); });
      btnRef .addEventListener('click', ()=> render(true));
      btnPin .addEventListener('click', async ()=>{
        const g=await readGPS(true);
        if(g){ await setFarm(g); alert('âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©'); render(true); }
        else { alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¢Ù†'); }
      });

      document.addEventListener('DOMContentLoaded', ()=> render());
    })();
  </script>
  <!-- ===== /ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ ===== -->

  <!-- â­ Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§: Ø­Ù‚Ù† Ø§Ù„Ù€UID Ù‚Ø¨Ù„ Ø£ÙŠ Ø³ÙƒØ±Ø¨Øª ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹ /api -->
  <script src="/js/tenant-bootstrap.js"></script>

  <!-- Ø¨Ù„Ø§Ø·Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª (ØªØ³ØªØ®Ø¯Ù… /api) -->
  <script>
    (function(){
      const tile = document.getElementById('sensorsTile');
      const badge = document.getElementById('sensorsStatus');
      function setBadge(txt, ok){ if(!badge) return; badge.textContent = txt; badge.style.background = ok?'#e8f5e9':'#fff8e1'; badge.style.borderColor = ok?'#c5e1a5':'#ffecb3'; }
      function getApiBase(){ const v=(localStorage.getItem('API_BASE')||'').trim(); if(!/^https?:\/\//.test(v) || v.includes('localhost')) return ''; return v; }
      async function ping(){
        try{
          setBadge('Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦', false);
          const ctl=new AbortController(); const to=setTimeout(()=>ctl.abort(),30000);
          const API_BASE=getApiBase(); const url=API_BASE?`${API_BASE}/api/sensors/health`:'/api/sensors/health';
          const opts={ signal:ctl.signal }; if(API_BASE) opts.mode='cors';
          const r=await fetch(url,opts); clearTimeout(to);
          if(r.status===503){ setBadge('ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„', false); return; }
          if(!r.ok){ setBadge('ØºÙŠØ± Ù…ØªØµÙ„', false); return; }
          const j=await r.json(); const n=Number(j?.devices||0); setBadge(`Ù…ØªØµÙ„ â€¢ ${n}`, true);
        }catch{ setBadge('ØºÙŠØ± Ù…ØªØµÙ„', false); }
      }
      tile?.addEventListener('click', ()=>{ location.href='sensor-test.html'; });
      document.addEventListener('DOMContentLoaded', ()=>{
        ping(); setTimeout(ping,6000); setTimeout(ping,25000); setInterval(ping,60000);
      });
    })();
  </script>

  <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ø¥Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ù…Ø§Øª -->
  <script type="module">
    const veBtn = document.getElementById('milkTraitsCard');
    veBtn?.addEventListener('click', () => {
      const qs  = new URLSearchParams(location.search);
      const id  = qs.get('animalId') || localStorage.getItem('currentAnimalId') || localStorage.getItem('lastAnimalId') || '';
      const url = id ? `visual-eval.html?focus=milk&animalId=${encodeURIComponent(id)}` : `visual-eval.html?focus=milk`;
      location.href = url;
    });
  </script>

  <!-- ØªØ­Ù…ÙŠÙ„ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¹ Ø¨Ø¯Ø§Ø¦Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© -->
  <script>
    (function(){
      const img=document.getElementById('brandImg'); const svg=document.querySelector('.brand-icon-svg'); if(!img) return;
      const candidates=[
        '/images/dashboard.svg','/images/dashboard.png','/images/dashboard.webp','/images/dashboard.jpg',
        'images/dashboard.svg','images/dashboard.png','images/dashboard.webp','images/dashboard.jpg'
      ];
      function tryLoad(i){
        if(i>=candidates.length) return;
        const src=candidates[i] + (candidates[i].includes('?')?'':'?v=1');
        const test=new Image();
        test.onload=()=>{ img.src=src; img.style.display='inline-block'; svg && svg.remove(); };
        test.onerror=()=>tryLoad(i+1);
        test.src=src;
      }
      tryLoad(0);
    })();
  </script>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙŠ ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ /api (Ø¨Ø¹Ø¯ tenant-bootstrap) -->
  <script src="js/mbk-animals.js?v=2"></script>
  <script src="js/herd-gauges.js?v=2"></script>
  <script src="js/smart-alerts.js?v=2"></script>
  <!-- (1) ØªØªØ¨Ù‘Ø¹ Ø£Ø³Ø§Ø³ÙŠ -->
<script>
  (function () {
    window.dataLayer = window.dataLayer || [];
    // Ù…Ø®Ø²Ù† Ø¨Ø³ÙŠØ· Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø©
    window.__sentEvents = window.__sentEvents || new Set();

    window.t = window.t || {
      event: function (name, props) {
        try {
          props = props || {};
          // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± page_view Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø±
          if (name === 'page_view') {
            var key = 'pv:' + (props.page || location.pathname);
            if (window.__sentEvents.has(key)) return;
            window.__sentEvents.add(key);
          }
          dataLayer.push({ event: name, ts: Date.now(), ...props });
        } catch (e) {}
      }
    };

    // Ø£Ø·Ù„Ù‚ page_view Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    t.event('page_view', { page: location.pathname });
  })();
</script>

<script src="/js/app-core.js" defer></script>
<script type="module" src="/js/timeline.js"></script>
<script type="module" src="/js/smart-checks.js"></script>

<!-- (2) Ø§Ù„Ù‡ÙˆÙŠØ© + ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª -->
<script src="/js/tenant-bootstrap.js"></script>
<script src="/js/api.js" defer></script>

<!-- (3) ÙØ­Øµ Ø§Ù„ØµØ­Ø©/Ø§Ù„ØªÙ„ÙŠÙ…ØªØ±Ù‰ â€” Ø¢Ø®Ø± Ø³ÙƒØ±Ø¨Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ -->
<script type="module" src="/js/health-check.js"></script>
</body>
</html>

</body>
</html>




