<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>
  <style>
    :root{--bg:#fff9db;--card:#ffffff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:var(--green)}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .tile{background:#eafbe7;border:2px solid #c5e1a5;border-radius:12px;padding:18px;text-align:center;font-weight:bold;cursor:pointer}
    .tile .icon{display:block;font-size:28px;margin-bottom:8px}
    .tile:hover{background:#dcedc8}

    /* Weather widget */
    #weatherCard{display:none;align-items:center;gap:12px}
    #weatherBadge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;border:1px solid var(--border);padding:8px 12px;background:var(--muted)}
    #wLoc{font-weight:bold}
    .wvals{display:flex;gap:10px;flex-wrap:wrap}
    .wval{background:#f7fff4;border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:90px;text-align:center}
    .btn{appearance:none;border:1px solid var(--green);background:#fff;color:var(--green);border-radius:10px;padding:8px 12px;font-weight:bold;cursor:pointer}
    .btn:hover{background:#f4fff1}
    @media(max-width:560px){.wvals{gap:6px}.wval{min-width:78px;padding:6px 8px}}
  </style>
</head>
<body>
  <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>
  
  <!-- Ø§Ù„Ø·Ù‚Ø³ Ùˆ THI -->
  <div id="weatherCard" class="card">
    <div id="weatherBadge">
      <span>ğŸŒ¦ï¸</span>
      <span id="wLoc">â€”</span>
    </div>
    <div class="wvals" style="flex:1">
      <div class="wval"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wTemp">â€”Â°C</b></div>
      <div class="wval"><div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wHum">â€”%</b></div>
      <div class="wval"><div>THI</div><b id="wTHI">â€”</b></div>
      <div class="wval"><div>Ø§Ù„Ø­Ø§Ù„Ø©</div><b id="wState">â€”</b></div>
    </div>
    <button id="wRefresh" class="btn">ØªØ­Ø¯ÙŠØ«</button>
  </div>

  <!-- Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>ØªØ³Ø¬ÙŠÙ„ Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">ğŸ†”</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>
    
    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="tile" onclick="location.href='farm-economy.html'"><span class="icon">ğŸ’°</span>Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</div>
    <div class="tile" onclick="location.href='evaluation.html'"><span class="icon">ğŸ“ˆ</span>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</div>
    <div class="tile" onclick="location.href='nutrition.html'"><span class="icon">ğŸŒ¿</span>ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„ØªØºØ°ÙŠØ©</div>
    <div class="tile" onclick="location.href='smart-feeding.html'"><span class="icon">ğŸ§ </span>Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</div>
  </div>

<script type="module">
  import { db } from './js/firebase-config.js';
  import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆÙŠØ¯Ø¬Øª
  const chip   = document.getElementById('weatherCard');
  const wLoc   = document.getElementById('wLoc');
  const wTemp  = document.getElementById('wTemp');
  const wHum   = document.getElementById('wHum');
  const wTHI   = document.getElementById('wTHI');
  const wState = document.getElementById('wState');
  const wRefresh = document.getElementById('wRefresh');

  // ØªØ£ÙƒÙŠØ¯ ÙˆØ¬ÙˆØ¯ Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙÙŠ localStorage (Ù„Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ù„ØªØµÙ…ÙŠÙ…/Ø§Ù„Ø§Ø¨Ø­Ø§Ø±)
  (function ensureRegionKey(){
    let key = localStorage.getItem('userRegionKey');
    if (key) return;
    const c = localStorage.getItem('userCountry');
    const r = localStorage.getItem('userRegion');
    if (c && r) key = `${c}:${r}`; else key = 'Ù…ØµØ±:Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©';
    localStorage.setItem('userRegionKey', key);
  })();

  // Ø®Ø±ÙŠØ·Ø© Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø¨Ø³Ø·Ø© (fallback Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯Ù‡Ø§ ÙÙŠ Firestore)
  const GEO = {
    'Ù…ØµØ±:Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©': {lat:30.0444, lon:31.2357},
    'Ù…ØµØ±:Ø§Ù„Ø¬ÙŠØ²Ø©':  {lat:30.0131, lon:31.2089},
    'Ù…ØµØ±:Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©': {lat:31.2001, lon:29.9187},
    'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©:Ø§Ù„Ø±ÙŠØ§Ø¶': {lat:24.7136, lon:46.6753},
    'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©:Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©': {lat:21.3891, lon:39.8579},
    'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª:Ø¯Ø¨ÙŠ': {lat:25.2048, lon:55.2708},
    'Ù‚Ø·Ø±:Ø§Ù„Ø¯ÙˆØ­Ø©': {lat:25.2854, lon:51.5310},
    'Ø§Ù„ÙƒÙˆÙŠØª:Ø§Ù„Ø¹Ø§ØµÙ…Ø©': {lat:29.3759, lon:47.9774},
    'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†:Ø§Ù„Ø¹Ø§ØµÙ…Ø©': {lat:26.2235, lon:50.5876},
    'Ø¹ÙÙ…Ø§Ù†:Ù…Ø³Ù‚Ø·': {lat:23.5880, lon:58.3829}
  };

  async function getCoords(regionKey){
    try{ const s = await getDoc(doc(db,'geoRegions', regionKey)); if (s.exists()) return s.data(); }catch{}
    return GEO[regionKey] || null;
  }

  function THI(c, rh){ const f=c*9/5+32; return Math.round(((f - (0.55 - 0.0055*rh)*(f - 58)))*10)/10; }
  function thiColor(thi){
    if (thi < 68) return {bg:'#c8e6c9', txt:'Ù…Ø±ÙŠØ­'};
    if (thi < 72) return {bg:'#fff9c4', txt:'ØªÙˆØªØ± Ø®ÙÙŠÙ'};
    if (thi < 79) return {bg:'#ffe0b2', txt:'ØªÙˆØªØ± Ù…ØªÙˆØ³Ø·'};
    if (thi < 84) return {bg:'#ffccbc', txt:'ØªÙˆØªØ± Ø´Ø¯ÙŠØ¯'};
    return {bg:'#ffcdd2', txt:'ØªÙˆØªØ± Ø´Ø¯ÙŠØ¯ Ø¬Ø¯Ù‹Ø§'};
  }

  function saveCache(key, data){ localStorage.setItem('weather:'+key, JSON.stringify({...data, ts:Date.now()})); }
  function loadCache(key){ try{ const o=JSON.parse(localStorage.getItem('weather:'+key)||'null'); return o && (Date.now()-o.ts)<3600000 ? o : null; }catch{return null;} }

  async function fetchWeather(lat, lon){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`;
    const r = await fetch(url); const j = await r.json();
    return { t: j.current?.temperature_2m, h: j.current?.relative_humidity_2m };
  }

  async function renderWeather(force=false){
    const key = localStorage.getItem('userRegionKey');
    if(!key){ chip.style.display='none'; return; }
    wLoc.textContent = key;

    let data = !force && loadCache(key);
    if(!data){
      const coords = await getCoords(key);
      if(!coords){ chip.style.display='none'; return; }
      data = await fetchWeather(coords.lat, coords.lon);
      if (!data || data.t==null || data.h==null){ chip.style.display='none'; return; }
      saveCache(key, data);
    }

    const thi = THI(data.t, data.h);
    const {bg, txt} = thiColor(thi);

    chip.style.display='flex';
    chip.style.background = bg;
    wTemp.textContent = `${Math.round(data.t)}Â°C`;
    wHum.textContent  = `${Math.round(data.h)}%`;
    wTHI.textContent  = thi;
    wState.textContent= txt;
  }

  document.addEventListener('DOMContentLoaded', ()=> renderWeather());
  wRefresh.addEventListener('click', ()=> renderWeather(true));
</script>

</body>
</html>

