<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>
<link rel="stylesheet" href="css/forms.css">
<link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#1b5e20">

<style>
:root{--bg:#fff9db;--card:#fff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
*{box-sizing:border-box}
body{background:var(--bg);font-family:Arial;margin:0;padding:16px;color:#1b5e20}
h1{text-align:center;margin:0 0 16px;font-weight:900}

.card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:12px}
.dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
.tile{background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;padding:14px;text-align:center;font-weight:bold;cursor:pointer}
.tile .icon{font-size:22px;margin-bottom:6px;display:block}

.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:10px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:4px}
.kpi-title{font-weight:700;font-size:14px}
.kpi-value{font-size:22px;font-weight:900;color:#00796b}

.tabs{display:flex;gap:8px;margin-top:16px;margin-bottom:10px;overflow:auto}
.tab-btn{
padding:6px 16px;background:#e8f5e9;border:1px solid #c5e1a5;color:#2e7d32;font-weight:700;
border-radius:999px;cursor:pointer;white-space:nowrap}
.tab-btn.active{background:#2e7d32;color:#fff;border-color:#2e7d32}
.tab-content{display:none}
.tab-content.active{display:block}
</style>
</head>

<body>

<h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>

<!-- âœ… Ø§Ù„Ø·Ù‚Ø³ -->
<div id="weatherClassic" class="card">
<div class="grid">
<div>Temp: <b id="wxTemp">â€”</b></div>
<div>Hum: <b id="wxHum">â€”</b></div>
<div>THI: <b id="wxTHI">â€”</b></div>
</div>
</div>

<!-- âœ… Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª -->
<div class="dashboard card">
<div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
<div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
<div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
<div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
<div class="tile" onclick="location.href='cow-card.html'"><span class="icon">ğŸ„</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</div>
<div class="tile" onclick="location.href='groups.html'"><span class="icon">ğŸ‘¥</span>Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</div>
<div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>Ù„Ø¨Ù†</div>
<div class="tile" onclick="location.href='nutrition-eval.html'"><span class="icon">ğŸ¥›</span>ØªØºØ°ÙŠØ©</div>
</div>

<!-- âœ… KPIs Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© -->
<div class="card">
<div style="font-weight:bold;margin-bottom:8px">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</div>
<div class="kpi-grid">
<div class="kpi"><div class="kpi-title">ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨</div><div id="v-inmilk" class="kpi-value">â€”%</div></div>
<div class="kpi"><div class="kpi-title">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø±</div><div id="v-preg" class="kpi-value">â€”%</div></div>
<div class="kpi"><div class="kpi-title">Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</div><div id="v-fresh" class="kpi-value">â€”%</div></div>
<div class="kpi"><div class="kpi-title">Ø¬Ø§Ù</div><div id="v-dry" class="kpi-value">â€”%</div></div>
</div>
</div>

<!-- âœ… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
<div class="card">
<div class="tabs">
<button class="tab-btn active" data-tab="prod">Ø¥Ù†ØªØ§Ø¬</button>
<button class="tab-btn" data-tab="repro">ØªÙ†Ø§Ø³Ù„</button>
<button class="tab-btn" data-tab="cull">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯</button>
<button class="tab-btn" data-tab="nut">ØªØºØ°ÙŠØ©</button>
</div>

<div class="tab-content active" id="tab-prod">
<div class="kpi-grid">
<div class="kpi"><div class="kpi-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div><div id="avgMilk" class="kpi-value">â€”</div></div>
<div class="kpi"><div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</div><div id="sumMilk" class="kpi-value">â€”</div></div>
<div class="kpi"><div class="kpi-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ø§Ø¨</div><div id="inMilkNum" class="kpi-value">â€”</div></div>
<div class="kpi"><div class="kpi-title">Ù…ØªÙˆØ³Ø· DIM</div><div id="avgDIM" class="kpi-value">â€”</div></div>
</div>
</div>

<div class="tab-content" id="tab-repro">
<div class="kpi-grid">
<div class="kpi"><div class="kpi-title">Open Days</div><div id="openDays" class="kpi-value">â€”</div></div>
<div class="kpi"><div class="kpi-title">Calving Interval</div><div id="ci" class="kpi-value">â€”</div></div>
<div class="kpi"><div class="kpi-title">Pregnancy Rate</div><div id="pr" class="kpi-value">â€”%</div></div>
<div class="kpi"><div class="kpi-title">Conception Rate</div><div id="cr" class="kpi-value">â€”%</div></div>
</div>
</div>

<div class="tab-content" id="tab-cull">
<div class="kpi-grid">
<div class="kpi"><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø¥Ù†ØªØ§Ø¬ÙŠ</div><div id="culProd" class="kpi-value">â€”%</div></div>
<div class="kpi"><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØªÙ†Ø§Ø³Ù„ÙŠ</div><div id="culRep" class="kpi-value">â€”%</div></div>
<div class="kpi"><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØµØ­ÙŠ</div><div id="culHealth" class="kpi-value">â€”%</div></div>
</div>
</div>

<div class="tab-content" id="tab-nut">
<div class="kpi-grid">
<div class="kpi"><div class="kpi-title">Feed Efficiency</div><div id="fe" class="kpi-value">â€”</div></div>
<div class="kpi"><div class="kpi-title">DMI</div><div id="dmi" class="kpi-value">â€”</div></div>
<div class="kpi"><div class="kpi-title">IOFC</div><div id="iofc" class="kpi-value">â€”</div></div>
</div>
</div>
</div>

<script type="module">
import { db } from '/js/firebase-config.js';
import { collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const $ = id=>document.getElementById(id);
const TD = v=>v?.seconds?new Date(v.seconds*1000):new Date(v);

let animals=[], events=[];

function render(){
const total=animals.length;
const inMilk=animals.filter(a=>a.inMilk).length;
$('v-inmilk').textContent = total?Math.round(inMilk/total*100)+'%':'â€”%';
$('inMilkNum').textContent = inMilk;

// Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…
const today=new Date().toDateString();
const todays=events.filter(e=>e.type?.includes("Ù„Ø¨Ù†") && TD(e.eventDate).toDateString()==today);
const sumMilk=todays.reduce((a,e)=>a+(Number(e.amount)||0),0);
$('sumMilk').textContent = sumMilk;
$('avgMilk').textContent = inMilk?Math.round(sumMilk/inMilk):'â€”';

// ØªÙ†Ø§Ø³Ù„
const preg=animals.filter(a=>a.pregnant).length;
$('v-preg').textContent= total?Math.round(preg/total*100)+'%':'â€”%';
$('pr').textContent = $('v-preg').textContent;

// placeholders Ø§Ù„Ø¢Ø®Ø±Ù‰ ØªØ¬Ù‡Ø² Ù„Ø§Ø­Ù‚Ù‹Ø§
}

// Firestore
const uid=localStorage.getItem("userId");
if(uid){
onSnapshot(query(collection(db,"animals"),where("userId","==",uid)),snap=>{
animals=snap.docs.map(d=>({...d.data()}));
render();
});
onSnapshot(query(collection(db,"events"),where("userId","==",uid)),snap=>{
events=snap.docs.map(d=>({...d.data()}));
render();
});
}

// Tabs
document.querySelectorAll('.tab-btn').forEach(b=>{
b.onclick=()=>{
document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
b.classList.add('active');
document.getElementById('tab-'+b.dataset.tab).classList.add('active');
};
});
</script>

</body>
</html>
