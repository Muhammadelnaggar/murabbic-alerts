<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="css/forms.css">
  <script type="module" src="js/forms-init.js"></script>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <meta name="theme-color" content="#1b5e20"/>

  <style>
    body{background:#fff9db;font-family:Arial;margin:0;padding:14px;color:#1b5e20}
    h1{text-align:center;font-weight:800;margin:10px 0 18px}

    .card{background:#fff;border:1px solid #c5e1a5;border-radius:14px;padding:14px;margin-top:12px}

    .tabs{display:flex;gap:10px;overflow:auto;margin-bottom:10px}
    .tab-btn{
      padding:6px 14px;border:1px solid #c5e1a5;background:#e8f5e9;color:#2e7d32;
      font-size:13px;border-radius:999px;cursor:pointer;font-weight:700;
      white-space:nowrap;
    }
    .tab-btn.active{background:#2e7d32;color:#fff;border-color:#2e7d32}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
    .kpi{
      background:#fff;border:1px solid #c5e1a5;border-radius:12px;padding:12px;
      min-height:70px;display:flex;flex-direction:column;gap:4px;
    }
    .kpi-title{font-size:14px;font-weight:700;color:#1b5e20}
    .kpi-value{font-size:22px;font-weight:900;color:#00796b}
  </style>
</head>

<body>

<h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>

<div class="card">
  <div class="tabs">
    <button class="tab-btn active" data-tab="prod">Ø¥Ù†ØªØ§Ø¬</button>
    <button class="tab-btn" data-tab="repro">ØªÙ†Ø§Ø³Ù„</button>
    <button class="tab-btn" data-tab="cull">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯</button>
    <button class="tab-btn" data-tab="nut">ØªØºØ°ÙŠØ©</button>
  </div>

  <!-- ğŸ”¹ Ø¥Ù†ØªØ§Ø¬ -->
  <div class="tab-content active" id="tab-prod">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-title">Ù…ØªÙˆØ³Ø· Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†</div><div id="avgMilk" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</div><div id="sumMilk" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ø§Ø¨</div><div id="inMilkNum" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Ù…ØªÙˆØ³Ø· DIM</div><div id="avgDIM" class="kpi-value">â€”</div></div>
    </div>
  </div>

  <!-- ğŸ”¹ ØªÙ†Ø§Ø³Ù„ -->
  <div class="tab-content" id="tab-repro">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-title">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©</div><div id="openDays" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Ø§Ù„ÙØ§ØµÙ„ Ø¨ÙŠÙ† ÙˆÙ„Ø§Ø¯ØªÙŠÙ†</div><div id="ci" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Conception Rate</div><div id="cr" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">Pregnancy Rate</div><div id="pr" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">S/C</div><div id="sc" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Abortion %</div><div id="ar" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">Dead Calving %</div><div id="dcr" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">Age @1st Calving</div><div id="afc" class="kpi-value">â€”</div></div>
    </div>
  </div>

  <!-- ğŸ”¹ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ -->
  <div class="tab-content" id="tab-cull">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-title">Ø¥Ù†ØªØ§Ø¬ÙŠ</div><div id="culProd" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">ØªÙ†Ø§Ø³Ù„ÙŠ</div><div id="culRep" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">ØµØ­ÙŠ</div><div id="culHealth" class="kpi-value">â€”%</div></div>
    </div>
  </div>

  <!-- ğŸ”¹ ØªØºØ°ÙŠØ© -->
  <div class="tab-content" id="tab-nut">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-title">Feed Efficiency</div><div id="fe" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">DMI</div><div id="dmi" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">IOFC</div><div id="iofc" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">BCS</div><div id="bcs" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Feces Score</div><div id="feces" class="kpi-value">â€”</div></div>
    </div>
  </div>

</div>


<script type="module">
import { db } from '/js/firebase-config.js';
import { collection, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const $=id=>document.getElementById(id);
const toDate=v=>v?.seconds?new Date(v.seconds*1000):new Date(v);
const days=(a,b)=>Math.floor((a-b)/86400000);
const now=new Date();
let animals=[],events=[];

function render(){
  const total=animals.length;
  const inMilk=animals.filter(a=>a.inMilk).length;
  const inMilkAnimals=animals.filter(a=>a.inMilk);

  // âœ… Ø¥Ù†ØªØ§Ø¬
  const milkEv=events.filter(e=>e.type?.includes('Ù„Ø¨Ù†'));
  const todayEv=milkEv.filter(e=>toDate(e.eventDate).toDateString()==now.toDateString());
  const sumMilk=todayEv.reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
  const avgMilk=inMilk?Math.round(sumMilk/inMilk):0;
  const avgDIM=inMilkAnimals.length?
    Math.round(inMilkAnimals.reduce((s,a)=>s+days(now,toDate(a.lastCalvingDate))),0)/inMilkAnimals.length:0;

  $('inMilkNum').textContent=inMilk;
  $('sumMilk').textContent=sumMilk||'â€”';
  $('avgMilk').textContent=avgMilk||'â€”';
  $('avgDIM').textContent=avgDIM||'â€”';

  // âœ… ØªÙ†Ø§Ø³Ù„
  const preg=animals.filter(a=>a.pregnant).length;
  const pr=total?Math.round(preg/total*100):0;
  $('pr').textContent=pr+'%';

  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Placeholder Ù„Ø­ÙŠÙ† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  $('openDays').textContent='â€”';
  $('ci').textContent='â€”';
  $('cr').textContent='â€”%';
  $('sc').textContent='â€”';
  $('ar').textContent='â€”%';
  $('dcr').textContent='â€”%';
  $('afc').textContent='â€”';

  // âœ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ â€” Placeholder
  $('culProd').textContent='â€”%';
  $('culRep').textContent='â€”%';
  $('culHealth').textContent='â€”%';

  // âœ… ØªØºØ°ÙŠØ© â€” Placeholder
  $('fe').textContent='â€”';
  $('dmi').textContent='â€”';
  $('iofc').textContent='â€”';
  $('bcs').textContent='â€”';
  $('feces').textContent='â€”';
}

// ØªØ¨ÙˆÙŠØ¨Ø§Øª
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
  }
});

// âœ… ØªØ­Ù…ÙŠÙ„ Ø­ÙŠ
const userId=localStorage.getItem('userId');
if(userId){
  onSnapshot(query(collection(db,'animals'),where('userId','==',userId)),snap=>{
    animals=snap.docs.map(d=>({...d.data()}));
    render();
  });

  onSnapshot(query(collection(db,'events'),where('userId','==',userId)),snap=>{
    events=snap.docs.map(d=>({...d.data()}));
    render();
  });
}
</script>

</body>
</html>
