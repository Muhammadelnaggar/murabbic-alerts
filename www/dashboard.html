<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة التحكم - مربيك</title>

  <!-- أيقونة مؤكّدة -->
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1b5e20"/>

  <style>
    :root{--bg:#fff9db;--card:#fff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:#1b5e20}

    /* العنوان */
    .brand{display:flex;align-items:center;justify-content:center;gap:10px}
    .brand-icon{height:28px;width:28px;object-fit:contain;display:none}
    .brand-icon-svg{height:28px;width:28px;display:inline-block;vertical-align:middle}

    /* كروت عامة */
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}

    /* ====== الويدجت القديم (كلاسيك) ====== */
    #weatherClassic{background:#ffe3e8;border:1.5px solid #ffccd5;border-radius:16px;padding:12px}
    #weatherClassic .bar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    #weatherClassic .seg{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    #weatherClassic .seg.active{background:#2e7d32;color:#fff}
    #weatherClassic .btn{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:8px;padding:4px 10px;font-size:12px;cursor:pointer}
    #weatherClassic .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    #weatherClassic .pill{background:#f7fff4;border:1px solid #c5e1a5;border-radius:12px;padding:8px;text-align:center}
    #weatherClassic .pill b{display:block;margin-top:4px}
    #weatherClassic .right{grid-row:1 / span 3;grid-column:2;display:flex;align-items:center;justify-content:center}

    /* ساعة THI */
    .thi-clock{position:relative;width:160px;height:160px}
    .thi-clock .dial{position:absolute;inset:0;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .thi-clock .arc{position:absolute;inset:0;border-radius:50%;
      -webkit-mask:radial-gradient(farthest-side,transparent 55%, #000 56%);
              mask:radial-gradient(farthest-side,transparent 55%, #000 56%)}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;
      background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);
      -webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);
              mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .needle{position:absolute;left:50%;top:50%;width:2px;height:42%;background:#000;transform-origin:bottom center;
      transform:translate(-50%,-100%) rotate(var(--angle,-120deg));border-radius:2px;transition:transform .9s cubic-bezier(.22,.8,.2,1)}
    .thi-clock .needle::after{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:inherit}
    .thi-clock .center{position:absolute;left:50%;top:50%;width:8px;height:8px;border-radius:50%;background:#000;transform:translate(-50%,-50%)}

    /* شبكة البلاطات */
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .tile{position:relative;background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
      padding:16px;text-align:center;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;
      align-items:center;justify-content:center;gap:6px;min-height:118px}
    .tile .icon{display:block;width:44px;height:44px;line-height:44px;border-radius:50%;border:1px solid var(--border);font-size:24px;margin-bottom:6px}
    .tile .badge{position:absolute;top:8px;left:8px;background:#f7fff4;border:1px solid var(--border);color:#335c33;border-radius:999px;padding:2px 8px;font-size:11px}

    /* المقاييس (herd-gauges) */
    .gauge{width:100%;aspect-ratio:2/1;position:relative}
    .gauge svg{width:100%;height:100%;display:block}
    .gauge .val{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#065f46;font-size:22px}

    @media(max-width:560px){
      .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
      .tile{min-height:110px;padding:14px}
      .tile-m-full{grid-column:1 / -1}
    }
  </style>
</head>
<body>
  <h1 class="brand">
    <img id="brandImg" class="brand-icon" alt="لوحة التحكم"/>
    <svg class="brand-icon-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="لوحة">
      <path d="M6 38 L18 50 L40 18" fill="none" stroke="#1e88e5" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="28" y="46" width="30" height="6" rx="3" fill="#1e88e5"/>
      <rect x="30" y="30" width="6" height="16" rx="3" fill="#ef5350"/>
      <rect x="40" y="24" width="6" height="22" rx="3" fill="#fdd835"/>
      <rect x="50" y="16" width="6" height="30" rx="3" fill="#7cb342"/>
    </svg>
    لوحة التحكم - مربيك
  </h1>

  <!-- ================== الويدجت القديم (كما كان) ================== -->
  <div id="weatherClassic" class="card" aria-label="الطقس و مؤشر THI">
    <div class="bar">
      <button class="btn" id="wxRefresh" type="button">تحديث</button>
      <button class="btn" id="wxPin" type="button">ثبّت</button>
      <span style="margin-inline-start:auto;font-weight:bold;">الموضع</span>
      <button class="seg" id="segFarm" type="button">مزرعتي</button>
      <button class="seg" id="segGPS" type="button">موقعي</button>
    </div>

    <div class="grid">
      <div class="pill"><div>الحرارة</div><b id="wxTemp">—°C</b></div>
      <div class="right">
        <div class="thi-clock">
          <div class="dial"><div id="thiArc" class="arc"></div></div>
          <div id="thiNeedle" class="needle"></div>
          <div class="center"></div>
        </div>
      </div>
      <div class="pill"><div>الرطوبة</div><b id="wxHum">—%</b></div>
      <div class="pill"><div>THI</div><b id="wxTHI">—</b></div>
      <div class="pill" style="grid-column:1 / span 2"><div>الحالة</div><b id="wxState">—</b></div>
    </div>
  </div>
  <!-- ============================================================= -->

  <!-- شبكة البلاطات / روابط سريعة -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">➕</span>حيوان جديد</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">📋</span>حيواناتي</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">🗓️</span>حدث جديد</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">🔔</span>أرشيف التنبيهات</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">🐮</span>البطاقة الذكية</div>
    <div class="tile" id="groupsTile" role="button" tabindex="0"
     onclick="(window.dataLayer=window.dataLayer||[]).push({event:'tile_click',tile:'groups',page:'dashboard'}); location.href='groups.html'">
  <span class="icon">👥</span>
  مجموعات مربيك
</div>

    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">📊</span>تقارير اللبن</div>
    <div class="tile" id="sensorsTile" role="button" tabindex="0">
      <span class="icon">🛰️</span>
      الأجهزة والحساسات
      <span class="badge" id="sensorsStatus">جارٍ الفحص…</span>
    </div>
    <div class="tile" id="nutritionEvalTile" role="button" tabindex="0" onclick="location.href='nutrition-eval.html'">
      تقييم التغذية
    </div>
  </div>

  <!-- سكربت الويدجت -->
  <script>
    (function(){
      const tEl=document.getElementById('wxTemp');
      const hEl=document.getElementById('wxHum');
      const thiEl=document.getElementById('wxTHI');
      const sEl=document.getElementById('wxState');
      const thiArc=document.getElementById('thiArc');
      const thiNeedle=document.getElementById('thiNeedle');

      function THI(c,rh){ const f=c*9/5+32; return Math.round(((f-(0.55-0.0055*rh)*(f-58)))*10)/10; }
      function bands(){ return {t1:66,t2:70,t3:77,t4:82}; }
      function colorAndText(thi,b){
        if(thi<b.t1) return {bg:'#c8e6c9',txt:'مريح'};
        if(thi<b.t2) return {bg:'#fff9c4',txt:'اجهاد خفيف'};
        if(thi<b.t3) return {bg:'#ffe0b2',txt:'اجهاد متوسط'};
        if(thi<b.t4) return {bg:'#ffccbc',txt:'اجهاد شديد'};
        return {bg:'#ffcdd2',txt:'اجهاد شديد جدا'};
      }
      async function fetchWeather(){
        try{
          const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=30.0444&longitude=31.2357&current=temperature_2m,relative_humidity_2m&timezone=auto`);
          const j=await r.json();
          return { t:j.current?.temperature_2m, h:j.current?.relative_humidity_2m };
        }catch{return null;}
      }
      function drawTHI(thi){
        const b=bands();
        if(thiArc){
          thiArc.style.background = `conic-gradient(from -120deg,#90caf9 0% 25%,#fff59d 25% 50%,#ffcc80 50% 75%,#ef5350 75% 100%)`;
        }
        if(thiNeedle){
          const ang=-120+((thi-50)/40)*240;
          thiNeedle.style.setProperty('--angle',ang+'deg');
        }
        const {bg,txt}=colorAndText(thi,b);
        document.getElementById('weatherClassic').style.background = bg;
        sEl.textContent = txt;
      }
      async function render(){
        const data=await fetchWeather();
        if(!data) return;
        const t=Math.round(data.t), h=Math.round(data.h);
        const thi=THI(t,h);
        tEl.textContent=`${t}°C`;
        hEl.textContent=`${h}%`;
        thiEl.textContent=thi;
        drawTHI(thi);
      }
      document.getElementById('wxRefresh').addEventListener('click',()=>render());
      document.addEventListener('DOMContentLoaded',()=>render());
    })();
  </script>

  <!-- فحص حالة الحساسات -->
  <script>
    (function(){
      const tile=document.getElementById('sensorsTile');
      const badge=document.getElementById('sensorsStatus');
      function setBadge(txt,ok){ if(!badge) return; badge.textContent=txt; badge.style.background=ok?'#e8f5e9':'#fff8e1'; badge.style.borderColor=ok?'#c5e1a5':'#ffecb3'; }
      async function ping(){
        try{
          setBadge('جارٍ الاتصال…',false);
          const r=await fetch('/api/sensors/health');
          if(!r.ok){ setBadge('غير متصل',false); return; }
          const j=await r.json();
          const n=Number(j?.devices||0);
          setBadge(`متصل • ${n}`,true);
        }catch{ setBadge('غير متصل',false); }
      }
      tile?.addEventListener('click',()=>{ location.href='sensor-test.html'; });
      document.addEventListener('DOMContentLoaded',()=>{ ping(); setInterval(ping,60000); });
    })();
  </script>
  <!-- لازم يكون موجود -->
<script src="/js/tenant-bootstrap.js"></script>
<script type="module" src="/js/app-core.js"></script>
<script>
  (function(){
    const t = document.getElementById('groupsTile');
    if(!t) return;
    t.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        t.click();
      }
    });
  })();
</script>

</body>
</html>


