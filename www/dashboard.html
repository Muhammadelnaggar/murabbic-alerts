<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>

  <link rel="stylesheet" href="css/forms.css">
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <meta name="theme-color" content="#1b5e20"/>

  <style>
    :root{
      --bg:#fff9db;
      --card:#fff;
      --muted:#dcedc8;
      --green:#2e7d32;
      --border:#c5e1a5;
    }
    *{box-sizing:border-box;}
    html,body{overflow-x:hidden;}
    body{
      margin:0;
      padding:12px;
      background:var(--bg);
      font-family:Arial,Helvetica,sans-serif;
      color:#1b5e20;
    }

    /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
    h1{
      margin:0 0 10px;
      text-align:center;
      color:#1b5e20;
      font-size:24px;
      font-weight:800;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .brand svg{
      width:26px;
      height:26px;
    }

    /* ÙƒØ§Ø±Øª Ø¹Ø§Ù… */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      box-shadow:0 1px 4px rgba(0,0,0,.04);
      margin-bottom:8px;
    }

    /* ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ (Ù…Ù† Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©) */
    #weatherClassic{
      background:#ffe3e8;
      border:1.5px solid #ffccd5;
      border-radius:16px;
      padding:10px;
    }
    #weatherClassic .bar{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:8px;
      font-size:12px;
    }
    #weatherClassic .btn,
    #weatherClassic .seg{
      appearance:none;
      border-radius:999px;
      padding:3px 10px;
      border:1px solid #2e7d32;
      background:#fff;
      color:#2e7d32;
      font-size:11px;
      cursor:pointer;
    }
    #weatherClassic .seg.active{
      background:#2e7d32;
      color:#fff;
    }
    #weatherClassic .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px;
      align-items:center;
    }
    #weatherClassic .pill{
      background:#f7fff4;
      border:1px solid #c5e1a5;
      border-radius:10px;
      padding:6px;
      text-align:center;
      font-size:11px;
    }
    #weatherClassic .pill b{
      display:block;
      margin-top:2px;
      font-size:15px;
    }
    #weatherClassic .right{
      grid-row:1 / span 3;
      grid-column:2;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .thi-clock{position:relative;width:120px;height:120px;}
    .thi-clock .dial{
      position:absolute;inset:0;border-radius:50%;
      background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.08);
    }
    .thi-clock .arc{
      position:absolute;inset:0;border-radius:50%;
      -webkit-mask:radial-gradient(farthest-side,transparent 55%,#000 56%);
              mask:radial-gradient(farthest-side,transparent 55%,#000 56%);
    }
    .thi-clock .dial::after{
      content:"";position:absolute;inset:3px;border-radius:50%;
      background:repeating-conic-gradient(#9e9e9e 0 2deg,transparent 0 18deg);
      -webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);
              mask:radial-gradient(farthest-side,transparent 68%,#000 69%);
      opacity:.25;
    }
    .thi-clock .needle{
      position:absolute;left:50%;top:50%;
      width:2px;height:40%;
      background:#000;
      transform-origin:bottom center;
      transform:translate(-50%,-100%) rotate(-120deg);
      border-radius:2px;
      transition:transform .9s cubic-bezier(.22,.8,.2,1);
    }
    .thi-clock .needle::after{
      content:"";position:absolute;top:-5px;left:50%;
      transform:translateX(-50%);
      width:6px;height:6px;border-radius:50%;background:inherit;
    }
    .thi-clock .center{
      position:absolute;left:50%;top:50%;
      width:7px;height:7px;border-radius:50%;
      background:#000;transform:translate(-50%,-50%);
    }

    /* ÙÙ„Ø§ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù† */
    #speciesFilter{
      display:flex;
      justify-content:center;
      gap:8px;
      margin:8px 0;
    }
    #speciesFilter button{
      padding:4px 10px;
      border-radius:10px;
      border:1px solid var(--green);
      background:#fff;
      color:var(--green);
      font-size:12px;
      cursor:pointer;
      font-weight:bold;
    }
    #speciesFilter button.active{
      background:var(--green);
      color:#fff;
    }

    /* Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª (ØªÙØªØ±Ùƒ ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§) */
    .dashboard{
      display:grid;
      grid-template-columns:repeat(3,minmax(90px,1fr));
      gap:6px;
      margin-bottom:8px;
    }
    .tile{
      position:relative;
      background:#eafbe7;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 4px;
      text-align:center;
      font-size:11px;
      font-weight:bold;
      cursor:pointer;
    }
    .tile .icon{
      display:block;
      margin:0 auto 4px;
      width:28px;height:28px;
      line-height:28px;
      border-radius:50%;
      border:1px solid var(--border);
      font-size:16px;
    }
    .tile .badge{
      position:absolute;
      top:4px;left:4px;
      padding:2px 6px;
      border-radius:999px;
      background:#f7fff4;
      border:1px solid var(--border);
      font-size:9px;
      color:#335c33;
    }

    /* KPIs: ÙƒÙ„ Ù…Ø¤Ø´Ø±ÙŠÙ† ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯ */
    .section-title{
      font-weight:800;
      font-size:13px;
      margin:6px 2px 4px;
      color:#1b5e20;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
    }
    .kpi{
      background:#ffffff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:10px;
      min-height:42px;
    }
    .kpi-label{
      font-weight:700;
      color:#1b5e20;
    }
    .kpi-value{
      font-size:16px;
      font-weight:800;
      color:#065f46;
    }
    .kpi-sub{
      font-size:9px;
      color:#607d8b;
    }

    #statusBar{
      margin-top:4px;
      font-size:9px;
      text-align:center;
      color:#388e3c;
    }

    @media(max-width:600px){
      .dashboard{grid-template-columns:repeat(3,minmax(90px,1fr));}
    }
  </style>
</head>
<body>
  <h1 class="brand">
    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
      <path d="M6 38 L18 50 L40 18" fill="none" stroke="#1e88e5" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="28" y="46" width="30" height="6" rx="3" fill="#1e88e5"/>
      <rect x="30" y="30" width="6" height="16" rx="3" fill="#ef5350"/>
      <rect x="40" y="24" width="6" height="22" rx="3" fill="#fdd835"/>
      <rect x="50" y="16" width="6" height="30" rx="3" fill="#7cb342"/>
    </svg>
    Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ
  </h1>

  <!-- ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø£ØµÙ„ÙŠ -->
  <div id="weatherClassic" class="card" aria-label="Ø§Ù„Ø·Ù‚Ø³ Ùˆ Ù…Ø¤Ø´Ø± THI">
    <div class="bar">
      <button class="btn" id="wxRefresh" type="button">ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn" id="wxPin" type="button">Ø«Ø¨Ù‘Øª</button>
      <span style="margin-inline-start:auto;font-weight:bold;">Ø§Ù„Ù…ÙˆØ¶Ø¹</span>
      <button class="seg" id="segFarm" type="button">Ù…Ø²Ø±Ø¹ØªÙŠ</button>
      <button class="seg" id="segGPS" type="button">Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>
    <div class="grid">
      <div class="pill">
        <div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wxTemp">â€”Â°C</b>
      </div>
      <div class="right">
        <div class="thi-clock">
          <div class="dial"><div id="thiArc" class="arc"></div></div>
          <div id="thiNeedle" class="needle"></div>
          <div class="center"></div>
        </div>
      </div>
      <div class="pill">
        <div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wxHum">â€”%</b>
      </div>
      <div class="pill">
        <div>THI</div><b id="wxTHI">â€”</b>
      </div>
      <div class="pill" style="grid-column:1 / span 2">
        <div>Ø§Ù„Ø­Ø§Ù„Ø©</div><b id="wxState">â€”</b>
      </div>
    </div>
  </div>

  <!-- ÙÙ„Ø§ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù† -->
  <div id="speciesFilter">
    <button class="active" data-species="all">ğŸ„ğŸƒ Ø§Ù„ÙƒÙ„</button>
    <button data-species="cow">ğŸ„ Ø£Ø¨Ù‚Ø§Ø±</button>
    <button data-species="buffalo">ğŸƒ Ø¬Ø§Ù…ÙˆØ³</button>
  </div>

  <!-- Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
  <div class="dashboard">
    <div class="tile" onclick="location.href='add-animal.html'">
      <span class="icon">â•</span>Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯
    </div>
    <div class="tile" onclick="location.href='animal-list.html'">
      <span class="icon">ğŸ“‹</span>Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ
    </div>
    <div class="tile" onclick="location.href='add-event.html'">
      <span class="icon">ğŸ—“ï¸</span>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯
    </div>
    <div class="tile" onclick="location.href='alerts.html'">
      <span class="icon">ğŸ””</span>Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    </div>
    <div class="tile" onclick="location.href='cow-card.html'">
      <span class="icon">ğŸ®</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©
    </div>
    <div class="tile" onclick="location.href='groups.html'">
      <span class="icon">ğŸ‘¥</span>Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø±Ø¨ÙŠÙƒ
    </div>
    <div class="tile" onclick="location.href='milk-reports.html'">
      <span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†
    </div>
    <div class="tile" id="sensorsTile">
      <span class="icon">ğŸ›°ï¸</span>
      Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª
      <span class="badge" id="sensorsStatus">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦</span>
    </div>
    <div class="tile" onclick="location.href='nutrition-eval.html'">
      <span class="icon">ğŸ¥—</span>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ©
    </div>
  </div>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹: ÙƒÙ„Ù‡Ø§ 2 ÙÙŠ ÙƒÙ„ ØµÙ -->
  <div class="card">
    <div class="section-title">ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ)</div>
    <div class="kpi-grid">
      <div class="kpi">
        <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
        <div class="kpi-value" id="k-total">-</div>
        <div class="kpi-sub">Ù…Ø³ØªØ¨Ø¹Ø¯ Ù…Ù†Ù‡Ø§ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©/Ø§Ù„Ù†Ø§ÙÙ‚Ø©/Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ø§Ø¨</div>
        <div class="kpi-value" id="k-inmilk-count">-</div>
        <div class="kpi-sub">+ Ù†Ø³Ø¨ØªÙ‡ Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹</div>
      </div>

      <div class="kpi">
        <div class="kpi-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø±</div>
        <div class="kpi-value" id="k-preg-pct">-</div>
        <div class="kpi-sub">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø´Ø·</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">% Conception (Ù…Ù† API)</div>
        <div class="kpi-value" id="k-cr">-</div>
        <div class="kpi-sub">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø®ØµØ§Ø¨ Ø§Ù„ÙƒÙ„ÙŠ</div>
      </div>

      <div class="kpi">
        <div class="kpi-label">Ù…ØªÙˆØ³Ø· DIM</div>
        <div class="kpi-value" id="k-dim">-</div>
        <div class="kpi-sub">Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ø­Ù„ÙŠØ¨ Ù„Ù„Ø­Ù„Ø§Ø¨</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨ %</div>
        <div class="kpi-value" id="k-inmilk-pct">-</div>
        <div class="kpi-sub">Ù†Ø³Ø¨Ø© Ù…Ù†ØªØ¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„Ø¢Ù†</div>
      </div>

      <div class="kpi">
        <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ø¥Ù†ØªØ§Ø¬/Ø¨Ù‚Ø±Ø© ÙÙŠ Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="kpi-value" id="k-milk-avg">-</div>
        <div class="kpi-sub">Ù…Ù† Ø¢Ø®Ø± Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø§Ù„Ù„Ø¨Ù† (Ø¥Ù† ÙˆÙØ¬Ø¯Øª)</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="kpi-value" id="k-milk-total">-</div>
        <div class="kpi-sub">ØªÙ‚Ø¯ÙŠØ±ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªÙˆØ³Ø· Ã— Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ø§Ø¨</div>
      </div>
    </div>
    <div id="statusBar">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹...</div>
  </div>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø·Ù‚Ø³ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ø¹ THI Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†) -->
  <script>
  (function(){
    const box=document.getElementById('weatherClassic');
    if(!box) return;
    const tEl=wxTemp= document.getElementById('wxTemp');
    const hEl=wxHum = document.getElementById('wxHum');
    const thiEl=document.getElementById('wxTHI');
    const sEl=document.getElementById('wxState');
    const thiArc=document.getElementById('thiArc');
    const thiNeedle=document.getElementById('thiNeedle');
    const btnRefresh=document.getElementById('wxRefresh');
    const btnPin=document.getElementById('wxPin');
    const segFarm=document.getElementById('segFarm');
    const segGPS=document.getElementById('segGPS');

    const DEF={lat:30.0444,lon:31.2357,place:'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©'};
    const LS_PIN='mbk_farm';
    const LS_WX='mbk_wx_cache';
    const LS_REG='mbk_reg_geo';

    let mode='reg', pinned=null;

    function THI(c,rh){
      const f=c*9/5+32;
      return Math.round(((f-(0.55-0.0055*rh)*(f-58)))*10)/10;
    }
    function currentSpecies(){
      const a=document.querySelector('#speciesFilter button.active');
      return (a && a.dataset.species) || 'all';
    }
    function bandsFor(species){
      const base={t1:66,t2:70,t3:77,t4:82};
      if(species==='buffalo') return {t1:64,t2:68,t3:75,t4:80};
      return base;
    }
    function colorAndText(thi,species){
      const b=bandsFor(species);
      if(thi<b.t1) return {bg:'#c8e6c9',txt:'Ù…Ø±ÙŠØ­'};
      if(thi<b.t2) return {bg:'#fff9c4',txt:'Ø¥Ø¬Ù‡Ø§Ø¯ Ø®ÙÙŠÙ'};
      if(thi<b.t3) return {bg:'#ffe0b2',txt:'Ø¥Ø¬Ù‡Ø§Ø¯ Ù…ØªÙˆØ³Ø·'};
      if(thi<b.t4) return {bg:'#ffccbc',txt:'Ø¥Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯'};
      return {bg:'#ffcdd2',txt:'Ø¥Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯ Ø¬Ø¯Ù‹Ø§'};
    }
    function drawTHI(thi){
      thiArc.style.background='conic-gradient(from -120deg,#90caf9 0% 25%,#fff59d 25% 50%,#ffcc80 50% 75%,#ef5350 75% 100%)';
      const ang=-120+((thi-50)/40)*240;
      thiNeedle.style.transform=`translate(-50%,-100%) rotate(${ang}deg)`;
      const st=colorAndText(thi,currentSpecies());
      box.style.background=st.bg;
      sEl.textContent=st.txt;
    }
    const readJSON=k=>{try{return JSON.parse(localStorage.getItem(k)||'null')}catch{return null}};
    const writeJSON=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};

    function readTenantAddress(){
      const T=window.__TENANT__||{};
      return{
        country:T.country||T.address?.country,
        region:T.region||T.address?.region,
        city:T.city||T.address?.city
      };
    }
    function regKey(a){
      return [a.city,a.region,a.country].filter(Boolean).join('|').toLowerCase()||'default';
    }
    async function geocodeFromRegistration(){
      const addr=readTenantAddress();
      if(!addr.country&&!addr.region&&!addr.city) return null;
      const key=regKey(addr);
      const c=readJSON(LS_REG);
      if(c && c.key===key && c.lat && c.lon) return c;
      try{
        const q=encodeURIComponent([addr.city,addr.region,addr.country].filter(Boolean).join(', '));
        const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1&language=ar`);
        const j=await r.json();
        const it=j?.results?.[0];
        if(it){
          const res={lat:it.latitude,lon:it.longitude,place:[it.name,it.admin1,it.country].filter(Boolean).join('ØŒ '),key};
          writeJSON(LS_REG,res);
          return res;
        }
      }catch(e){}
      return null;
    }
    function getPinned(){return readJSON(LS_PIN);}
    function savePinned(lat,lon,place){writeJSON(LS_PIN,{lat,lon,place:place||'Ù…Ø²Ø±Ø¹ØªÙŠ'});}
    function getGPS(){
      return new Promise(res=>{
        if(!navigator.geolocation) return res(null);
        navigator.geolocation.getCurrentPosition(
          p=>res({lat:p.coords.latitude,lon:p.coords.longitude,place:'Ù…ÙˆÙ‚Ø¹ÙŠ'}),
          _=>res(null),
          {enableHighAccuracy:true,timeout:5000}
        );
      });
    }
    async function pickCoords(){
      if(pinned) return pinned;
      if(mode==='gps'){
        const g=await getGPS();
        if(g) return g;
      }
      const reg=await geocodeFromRegistration();
      if(reg) return reg;
      return DEF;
    }
    function wxGetCached(){
      const x=readJSON(LS_WX);
      if(x && Date.now()-x.ts<60000) return x.data;
      return null;
    }
    function wxSetCached(d){writeJSON(LS_WX,{ts:Date.now(),data:d});}

    async function fetchWeather(lat,lon){
      const cached=wxGetCached();
      if(cached && typeof cached.t==='number') return cached;
      try{
        const r=await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`,
          {cache:'no-store'}
        );
        const j=await r.json();
        const d={t:j.current?.temperature_2m,h:j.current?.relative_humidity_2m};
        if(typeof d.t==='number'&&typeof d.h==='number') wxSetCached(d);
        return d;
      }catch(e){return null;}
    }
    function activate(which){
      segFarm.classList.toggle('active',which==='reg');
      segGPS.classList.toggle('active',which==='gps');
    }

    async function render(){
      const c=await pickCoords();
      const d=await fetchWeather(c.lat,c.lon);
      if(!d){tEl.textContent='â€”Â°C';hEl.textContent='â€”%';thiEl.textContent='â€”';sEl.textContent='â€”';return;}
      const t=Math.round(d.t), h=Math.round(d.h), thi=THI(t,h);
      tEl.textContent=`${t}Â°C`;
      hEl.textContent=`${h}%`;
      thiEl.textContent=thi;
      drawTHI(thi);
    }

    async function boot(){
      pinned=getPinned()||null;
      mode='reg'; activate('reg');
      segFarm.addEventListener('click',()=>{mode='reg';activate('reg');render();});
      segGPS.addEventListener('click',()=>{mode='gps';activate('gps');render();});
      btnRefresh.addEventListener('click',render);
      btnPin.addEventListener('click',async()=>{
        mode='gps';
        const g=await getGPS();
        if(g){savePinned(g.lat,g.lon,g.place);pinned=g;}
        mode='reg';activate('reg');render();
      });
      render();
      // Ù„Ùˆ ØºÙŠÙ‘Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø­Ø¯Ù‘Ø« Ø§Ù„ØªÙØ³ÙŠØ± ÙÙ‚Ø·
      document.getElementById('speciesFilter').addEventListener('click',e=>{
        if(e.target.tagName==='BUTTON' && thiEl.textContent!=='â€”'){
          const thi=Number(thiEl.textContent)||0;
          if(thi) drawTHI(thi);
        }
      });
    }
    document.addEventListener('DOMContentLoaded',boot);
  })();
  </script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹: ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ /api/herd-stats Ùˆ /api/animals -->
  <script>
    (function(){
      const statusEl = document.getElementById('statusBar');
     const API_BASE = location.origin.includes('render.com')
  ? location.origin
  : 'https://murabbic-alerts.onrender.com';


      function getTenantId(){
        const T = window.__TENANT__ || {};
        return T.userId || T.uid || T.id ||
               localStorage.getItem('userId') ||
               localStorage.getItem('uid') ||
               sessionStorage.getItem('userId') ||
               'default';
      }
      const TENANT = getTenantId();

      const speciesFilter = document.getElementById('speciesFilter');
      let currentSpecies = 'all';
      speciesFilter.addEventListener('click', e=>{
        if(e.target.tagName!=='BUTTON')return;
        speciesFilter.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        currentSpecies = e.target.dataset.species || 'all';
        loadAll();
      });

      function norm(txt){
        return String(txt||'')
          .toLowerCase()
          .replace(/[\u0610-\u061a\u064b-\u065f\u0670\u06d6-\u06ed]/g,'')
          .trim();
      }
      function toDate(v){
        if(!v) return null;
        if(typeof v==='number') return new Date(v);
        const s=String(v);
        if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00');
        return new Date(s);
      }
      function daysBetween(a,b){
        return Math.floor((a-b)/86400000);
      }
      function isActive(an){
        const st = norm(an.status||an.lifeStatus||'');
        if(['sold','dead','died','archived','inactive','Ù…Ø¨Ø§Ø¹Ù‡','Ù…ÙŠØª','Ù†Ø§ÙÙ‚','Ù…Ø¤Ø±Ø´ÙØ©'].includes(st)) return false;
        if(an.active===false) return false;
        return true;
      }
      function isSpecies(an){
        if(currentSpecies==='all') return true;
        const t = norm(an.animaltype || an.animalType || an.animalTypeAr || an.species || '');
        if(currentSpecies==='cow') return t.includes('cow') || t.includes('Ø¨Ù‚Ø±');
        if(currentSpecies==='buffalo') return t.includes('buff') || t.includes('Ø¬Ø§Ù…ÙˆØ³');
        return true;
      }
      function isPreg(an){
        const rs = norm(an.reproductiveStatus || an.pregStatus || an.pregnancyStatus || '');
        return rs.includes('preg') || rs.includes('Ø¹Ø´Ø§Ø±') || an.pregnant===true;
      }
      function isInMilk(an){
        const st = norm(an.productionStatus || an.lactationStatus || an.status || '');
        if(an.inMilk===true) return true;
        if(an.inMilk===false) return false;
        if(st.includes('Ø¬Ø§Ù') || st.includes('dry')) return false;
        return /(milk|lact|Ø­Ù„Ø§Ø¨|Ù…Ø­Ù„Ø¨|Ù…Ù†ØªØ¬)/.test(st);
      }
      function getDIM(an){
        const calv = toDate(an.lastCalvingDate || an.calvingDate || an.birthDateCalving);
        if(!calv) return 0;
        return Math.max(0, daysBetween(new Date(), calv));
      }

      async function fetchJSON(url){
        const res = await fetch(url, {
          headers:{'X-User-Id': TENANT},
          cache:'no-store'
        });
        if(!res.ok) throw new Error(url+' '+res.status);
        return res.json();
      }

      async function loadAll(){
        try{
          statusEl.textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹...';

          const [herdStats, animals] = await Promise.all([
            fetchJSON(`${API_BASE}/api/herd-stats`),
            fetchJSON(`${API_BASE}/api/animals`)
          ]);

          const list = (animals || []).filter(isActive).filter(isSpecies);

          const total = list.length;
          let inMilk=0, preg=0, dimSum=0;
          for(const an of list){
            if(isInMilk(an)){
              inMilk++;
              dimSum += getDIM(an);
            }
            if(isPreg(an)) preg++;
          }
          const inMilkPct = total ? Math.round(inMilk*100/total) : 0;
          const pregPct = total ? Math.round(preg*100/total) : 0;
          const avgDIM = inMilk ? Math.round(dimSum/inMilk) : 0;

          // Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† ØªÙ‚Ø¯ÙŠØ±ÙŠ: Ù…Ù† Ø­Ù‚Ù„ dailyMilk Ø¥Ù† Ù…ÙˆØ¬ÙˆØ¯
          let milkTotal=0, milkCount=0;
          for(const an of list){
            const m = Number(an.dailyMilk || an.lastMilkKg || 0);
            if(m>0){milkTotal+=m; milkCount++;}
          }
          const milkAvg = milkCount ? +(milkTotal/milkCount).toFixed(1) : 0;
          if(!milkTotal && inMilk && milkAvg){ milkTotal = milkAvg*inMilk; }

          const cr = herdStats?.fertility?.conceptionRatePct ?? null;

          // ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù‚ÙŠÙ…
          document.getElementById('k-total').textContent = total || 0;
          document.getElementById('k-inmilk-count').textContent =
            inMilk ? `${inMilk} (${inMilkPct}%)` : inMilk;
          document.getElementById('k-inmilk-pct').textContent = inMilkPct ? inMilkPct+'%' : '0%';
          document.getElementById('k-preg-pct').textContent = pregPct ? pregPct+'%' : '0%';
          document.getElementById('k-dim').textContent = avgDIM || '-';
          document.getElementById('k-cr').textContent = (cr!=null)? cr+'%' : (herdStats?.ok?'-':'0%');
          document.getElementById('k-milk-avg').textContent =
            milkAvg ? milkAvg+' ÙƒØ¬Ù…' : 'â€”';
          document.getElementById('k-milk-total').textContent =
            milkTotal ? Math.round(milkTotal)+' ÙƒØ¬Ù…' : 'â€”';

          statusEl.textContent = 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø¨ '+(currentSpecies==='all'?'ÙƒÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª':(currentSpecies==='cow'?'Ø§Ù„Ø£Ø¨Ù‚Ø§Ø± ÙÙ‚Ø·':'Ø§Ù„Ø¬Ø§Ù…ÙˆØ³ ÙÙ‚Ø·'));
        }catch(e){
          console.warn(e);
          statusEl.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹. ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ /api/herd-stats Ùˆ /api/animals.';
        }
      }

      // ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª
      (function(){
        const tile=document.getElementById('sensorsTile');
        const badge=document.getElementById('sensorsStatus');
        if(!tile || !badge) return;
        const setBadge=(txt,ok)=>{
          badge.textContent=txt;
          badge.style.background=ok?'#e8f5e9':'#fff8e1';
          badge.style.borderColor=ok?'#c5e1a5':'#ffecb3';
        };
        async function ping(){
          try{
            setBadge('Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦',false);
            const r=await fetch(`${API_BASE}/api/sensors/health`,{cache:'no-store'});
            if(!r.ok){ setBadge('ØºÙŠØ± Ù…ØªØµÙ„',false); return; }
            const j=await r.json();
            setBadge(`Ù…ØªØµÙ„ â€¢ ${Number(j.devices||0)}`,true);
          }catch{ setBadge('ØºÙŠØ± Ù…ØªØµÙ„',false); }
        }
        tile.addEventListener('click',()=>{ location.href='sensor-test.html'; });
        ping();
        setInterval(ping,60000);
      })();

      document.addEventListener('DOMContentLoaded', loadAll);
    })();
  </script>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹) -->
  <script src="/js/tenant-bootstrap.js"></script>
  <script src="/js/app-core.js" type="module"></script>
</body>
</html>

