<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>
<link rel="stylesheet" href="css/forms.css">
<link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#1b5e20"/>

<style>
:root{--bg:#fff9db;--card:#fff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
*{box-sizing:border-box}
body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
h1{margin:0 0 16px;text-align:center;font-weight:900}

.card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:12px}
.dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
.tile{position:relative;background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;padding:14px;text-align:center;font-weight:bold;cursor:pointer}
.tile .icon{display:block;font-size:22px;margin-bottom:6px}

.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:6px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:4px;min-height:70px}
.kpi-title{font-weight:800;font-size:14px}
.kpi-value{font-size:22px;font-weight:900;color:#065f46}

.tabs{display:flex;gap:8px;margin:14px 0 10px;overflow:auto}
.tab-btn{padding:6px 14px;border-radius:999px;background:#e8f5e9;border:1px solid #c5e1a5;color:#2e7d32;font-weight:700;white-space:nowrap;cursor:pointer}
.tab-btn.active{background:#2e7d32;color:#fff;border-color:#2e7d32}
.tab-content{display:none}
.tab-content.active{display:block}

.wx-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.wx-pill{background:#f7fff4;border:1px solid #c5e1a5;border-radius:12px;padding:8px;text-align:center}
.wx-pill b{display:block;margin-top:4px}

.badge{display:inline-block;border:1px solid #c5e1a5;border-radius:999px;padding:2px 8px;font-size:11px;background:#fff}
hr.sep{border:none;border-top:1px dashed #c5e1a5;margin:10px 0}
@media(max-width:560px){.dashboard{grid-template-columns:repeat(auto-fill,minmax(130px,1fr))}}
</style>
</head>
<body>

<h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>

<!-- Ø§Ù„Ø·Ù‚Ø³ (Ù†Ø³Ø®Ø© Ø®ÙÙŠÙØ© â€“ Ù†ÙØ³ Ø§Ù„Ù€ IDs Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚) -->
<div id="weatherClassic" class="card" aria-label="Ø§Ù„Ø·Ù‚Ø³ Ùˆ THI">
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
    <button id="wxRefresh" class="tab-btn" type="button">ØªØ­Ø¯ÙŠØ«</button>
    <span style="margin-inline-start:auto" class="badge" id="wxPlace">â€”</span>
  </div>
  <div class="wx-grid">
    <div class="wx-pill"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wxTemp">â€”Â°C</b></div>
    <div class="wx-pill"><div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wxHum">â€”%</b></div>
    <div class="wx-pill" style="grid-column:1 / span 2"><div>THI</div><b id="wxTHI">â€”</b></div>
  </div>
</div>

<!-- Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª -->
<div class="dashboard card" aria-label="Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©">
  <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
  <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
  <div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
  <div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
  <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">ğŸ®</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</div>
  <div class="tile" onclick="location.href='groups.html'"><span class="icon">ğŸ‘¥</span>Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</div>
  <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
  <div class="tile" onclick="location.href='nutrition-eval.html'"><span class="icon">ğŸ¥›</span>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ©</div>
</div>

<!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (ÙƒÙ…Ø§ Ù‡ÙŠ) -->
<div class="card" id="herdQuick" aria-label="Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©">
  <div style="display:flex;gap:8px;align-items:center">
    <b>Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</b>
    <span id="g-date" class="badge" style="margin-inline-start:auto">â€”</span>
  </div>
  <div class="kpi-grid">
    <div class="kpi"><div class="kpi-title">ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨</div><div id="v-inmilk" class="kpi-value">â€”%</div></div>
    <div class="kpi"><div class="kpi-title">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹ÙØ´Ø§Ø±</div><div id="v-preg" class="kpi-value">â€”%</div></div>
    <div class="kpi"><div class="kpi-title">Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© (Ù…Ù† Ø§Ù„Ø­Ù„Ø§Ø¨)</div><div id="v-fresh" class="kpi-value">â€”%</div></div>
    <div class="kpi"><div class="kpi-title">Ø¬Ø§Ù</div><div id="v-dry" class="kpi-value">â€”%</div></div>
  </div>
</div>

<!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª: Ø¥Ù†ØªØ§Ø¬ / ØªÙ†Ø§Ø³Ù„ / Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ / ØªØºØ°ÙŠØ© -->
<div class="card" id="tabsCard">
  <div class="tabs">
    <button class="tab-btn active" data-tab="prod">Ø¥Ù†ØªØ§Ø¬</button>
    <button class="tab-btn" data-tab="repro">ØªÙ†Ø§Ø³Ù„</button>
    <button class="tab-btn" data-tab="cull">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯</button>
    <button class="tab-btn" data-tab="nut">ØªØºØ°ÙŠØ©</button>
  </div>

  <!-- Ø¥Ù†ØªØ§Ø¬ -->
  <div class="tab-content active" id="tab-prod">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div><div id="k-avgMilk" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</div><div id="k-sumMilk" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ø§Ø¨</div><div id="k-inMilkNum" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Ù…ØªÙˆØ³Ø· DIM</div><div id="k-avgDIM" class="kpi-value">â€”</div></div>
    </div>
  </div>

  <!-- ØªÙ†Ø§Ø³Ù„ -->
  <div class="tab-content" id="tab-repro">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©</div><div id="k-openDays" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Ø§Ù„ÙØ§ØµÙ„ Ø¨ÙŠÙ† ÙˆÙ„Ø§Ø¯ØªÙŠÙ† (ÙŠÙˆÙ…)</div><div id="k-ci" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Conception Rate</div><div id="k-cr" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">Pregnancy Rate (21d)</div><div id="k-pr" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">S/C</div><div id="k-sc" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Abortion %</div><div id="k-ar" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">Dead Calving %</div><div id="k-dcr" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">Ø§Ù„Ø¹Ù…Ø± Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ÙˆÙ„Ø§Ø¯Ø© (Ø´Ù‡Ø±)</div><div id="k-afc" class="kpi-value">â€”</div></div>
    </div>
  </div>

  <!-- Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ -->
  <div class="tab-content" id="tab-cull">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø¥Ù†ØªØ§Ø¬ÙŠ</div><div id="k-culProd" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØªÙ†Ø§Ø³Ù„ÙŠ</div><div id="k-culRep" class="kpi-value">â€”%</div></div>
      <div class="kpi"><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØµØ­ÙŠ</div><div id="k-culHealth" class="kpi-value">â€”%</div></div>
    </div>
  </div>

  <!-- ØªØºØ°ÙŠØ© -->
  <div class="tab-content" id="tab-nut">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-title">Feed Efficiency</div><div id="k-fe" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">DMI (ÙƒØ¬Ù…/Ø±Ø£Ø³)</div><div id="k-dmi" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">IOFC (ÙŠÙˆÙ…ÙŠ/Ø±Ø£Ø³)</div><div id="k-iofc" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">BCS (Ù…ØªÙˆØ³Ø·)</div><div id="k-bcs" class="kpi-value">â€”</div></div>
      <div class="kpi"><div class="kpi-title">Feces Score (Ù…ØªÙˆØ³Ø·)</div><div id="k-feces" class="kpi-value">â€”</div></div>
    </div>
  </div>
</div>

<!-- ØªØ±ØªÙŠØ¨Ø§Øª Murabbik Ø§Ù„Ù…Ø¹ØªØ§Ø¯Ø© -->
<script src="/js/tenant-bootstrap.js"></script>
<script type="module" src="/js/app-core.js"></script>

<!-- Firestore + Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª -->
<script type="module">
import { db } from '/js/firebase-config.js';
import { collection, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const $ = s => document.getElementById(s);

// ---------- ØªØ¨ÙˆÙŠØ¨ ÙˆØ§Ø¬Ù‡Ø© ----------
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.getElementById('tab-'+b.dataset.tab).classList.add('active');
  });
});

// ---------- Helpers ----------
const norm = s => String(s||'').toLowerCase().trim();
const toDate = v => v?.seconds ? new Date(v.seconds*1000) : (v? new Date(v): null);
const daysBetween = (a,b)=> Math.floor((a-b)/86400000);

const isDry = an => {
  const st = norm(an.productionStatus || an.lactationStatus || an.status || an['Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„Ù„Ø¨Ù†ÙŠØ©']);
  return an.inMilk===false || an.dry===true || /(dry|Ø¬Ø§Ù|Ø¬Ø§ÙØ©|dryoff)/.test(st);
};

const isInMilk = an => !isDry(an) && (an.inMilk===true || /(Ø­Ù„Ø§Ø¨|Ù…Ù†ØªØ¬|milk|lact)/.test(norm(an.productionStatus||an.status)));

const getDIM = an => {
  const calv = toDate(an.calvingDate || an.lastCalvingDate || an.calvedAt || an['ØªØ§Ø±ÙŠØ®_Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©']);
  return calv ? Math.max(0, daysBetween(new Date(), calv)) : 0;
};
const isPreg = an => /(preg|Ø¹Ø´Ø§Ø±|Ø­Ø§Ù…Ù„)/.test(norm(an.reproductiveStatus||an.pregStatus)) || an.pregnant===true;

const INSEM = ['ØªÙ„Ù‚ÙŠØ­','insemination'];
const PD    = ['ØªØ´Ø®ÙŠØµ','pregnancy'];
const CALV  = ['ÙˆÙ„Ø§Ø¯Ø©','calving'];
const ABORT = ['Ø§Ø¬Ù‡Ø§Ø¶','abortion'];
const DEAD  = ['Ù…ÙŠØª','Ù†Ø§ÙÙ‚','dead','stillbirth'];
const MILK  = ['Ù„Ø¨Ù†','milk'];

const isType = (t, arr)=> arr.some(p=> new RegExp(p,'i').test(String(t||'')));

// ---------- Ø§Ù„Ø·Ù‚Ø³ (Ø®ÙÙŠÙ) ----------
(async function wx(){
  const tEl=$('wxTemp'), hEl=$('wxHum'), thiEl=$('wxTHI'), plc=$('wxPlace'), btn=$('wxRefresh');
  async function draw(){
    try{
      const geo = JSON.parse(localStorage.getItem('mbk_reg_geo')||'null') || {lat:30.0444, lon:31.2357, place:'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©'};
      const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geo.lat}&longitude=${geo.lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`, {cache:'no-store'});
      const j = await r.json();
      const t = Math.round(j.current?.temperature_2m ?? NaN);
      const h = Math.round(j.current?.relative_humidity_2m ?? NaN);
      const f = (c)=>c*9/5+32;
      const THI = Math.round((f(t) - (0.55-0.0055*h)*(f(t)-58)));
      tEl.textContent=isFinite(t)?`${t}Â°C`:'â€”Â°C';
      hEl.textContent=isFinite(h)?`${h}%`:'â€”%';
      thiEl.textContent=isFinite(THI)?THI:'â€”';
      plc.textContent=geo.place||'â€”';
    }catch{ tEl.textContent='â€”Â°C'; hEl.textContent='â€”%'; thiEl.textContent='â€”'; }
  }
  btn?.addEventListener('click', draw); draw();
})();

// ---------- ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ----------
let animals=[], events=[];
const uid = window.__TENANT__?.userId || localStorage.getItem('userId');

// Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¹Ø§Ù…Ø©
function recompute(){
  $('g-date').textContent = new Date().toISOString().slice(0,10);

  // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù‚Ø·ÙŠØ¹
  const total = animals.length;
  const inMilk = animals.filter(isInMilk).length;
  const fresh = animals.filter(a=> isInMilk(a) && getDIM(a)>=1 && getDIM(a)<=45 ).length;
  const dry   = animals.filter(isDry).length;
  const preg  = animals.filter(isPreg).length;

  $('v-inmilk').textContent = total? Math.round(inMilk/total*100)+'%':'â€”%';
  $('v-fresh').textContent  = inMilk? Math.round(fresh/inMilk*100)+'%':'â€”%';
  $('v-dry').textContent    = total? Math.round(dry/total*100)+'%':'â€”%';
  $('v-preg').textContent   = total? Math.round(preg/total*100)+'%':'â€”%';

  // Ø¥Ù†ØªØ§Ø¬ (Ø§Ù„ÙŠÙˆÙ…)
  const todayStr = new Date().toDateString();
  const milkToday = events.filter(e => isType(e.type, MILK) && toDate(e.eventDate)?.toDateString()===todayStr);
  const sumMilk = milkToday.reduce((s,e)=> s + (Number(e.amount)||0), 0);
  const avgMilk = inMilk? (sumMilk/inMilk): 0;
  const avgDIM  = inMilk? Math.round(animals.filter(isInMilk).reduce((s,a)=>s+getDIM(a),0)/inMilk): 0;

  $('k-sumMilk').textContent = String(Math.round(sumMilk*10)/10);
  $('k-avgMilk').textContent = inMilk? (Math.round(avgMilk*10)/10)+' ÙƒØ¬Ù…':'â€”';
  $('k-inMilkNum').textContent = String(inMilk);
  $('k-avgDIM').textContent = avgDIM? (avgDIM+' ÙŠÙˆÙ…'):'â€”';

  // ØªÙ†Ø§Ø³Ù„
  const open = animals.filter(a=> isInMilk(a) && !isPreg(a) );
  const openDays = open.length? Math.round(open.reduce((s,a)=> s+getDIM(a),0)/open.length) : 0;
  $('k-openDays').textContent = openDays? String(openDays):'â€”';

  // CI: Ù…ØªÙˆØ³Ø· ÙØ±Ù‚ Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯ØªÙŠÙ† Ù„ÙƒÙ„ Ø£Ù†Ø«Ù‰ Ù„Ø¯ÙŠÙ‡Ø§ â‰¥2 ÙˆÙ„Ø§Ø¯Ø§Øª
  let ciVals=[];
  const calvByAnimal = new Map();
  events.filter(e=> isType(e.type,CALV) && toDate(e.eventDate)).forEach(e=>{
    const key = e.animalId || e.animalNumber || e.number || e.tag;
    if(!key) return;
    const arr = calvByAnimal.get(key) || [];
    arr.push(toDate(e.eventDate));
    calvByAnimal.set(key, arr);
  });
  for(const arr of calvByAnimal.values()){
    arr.sort((a,b)=>a-b);
    if(arr.length>=2){
      const last = arr[arr.length-1], prev = arr[arr.length-2];
      ciVals.push(daysBetween(last,prev));
    }
  }
  const ci = ciVals.length? Math.round(ciVals.reduce((a,b)=>a+b,0)/ciVals.length):0;
  $('k-ci').textContent = ci? String(ci):'â€”';

  // Conception & Pregnancy rate
  const now = new Date();
  const d90 = new Date(now.getTime()-90*86400000);
  const d21 = new Date(now.getTime()-21*86400000);

  const insems90 = events.filter(e=> isType(e.type,INSEM) && toDate(e.eventDate) && toDate(e.eventDate)>=d90).length;
  const pregPos90= events.filter(e=> isType(e.type,PD) && /(Ø¹Ø´Ø§Ø±|preg|positive|Ø­Ø§Ù…Ù„)/i.test(String(e.result||e.outcome||e['Ø§Ù„Ù†ØªÙŠØ¬Ø©']||'')) && toDate(e.eventDate) && toDate(e.eventDate)>=d90 ).length;
  const cr = insems90? Math.round((pregPos90/insems90)*100) : 0;
  $('k-cr').textContent = (cr||0) + '%';

  const eligible = animals.filter(a=> isInMilk(a) && !isPreg(a) && getDIM(a)>=60).length;
  const newPreg21 = events.filter(e=> isType(e.type,PD) && /(Ø¹Ø´Ø§Ø±|preg|positive|Ø­Ø§Ù…Ù„)/i.test(String(e.result||e.outcome||e['Ø§Ù„Ù†ØªÙŠØ¬Ø©']||'')) && toDate(e.eventDate)>=d21 ).length;
  const pr = eligible? Math.round((newPreg21/eligible)*100) : 0;
  $('k-pr').textContent = (pr||0) + '%';

  // S/C (Ø¢Ø®Ø± 180 ÙŠÙˆÙ…): Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª Ã· Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ù…Ù„ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©
  const d180 = new Date(now.getTime()-180*86400000);
  const insems180 = events.filter(e=> isType(e.type,INSEM) && toDate(e.eventDate)>=d180).length;
  const preg180   = events.filter(e=> isType(e.type,PD) && /(Ø¹Ø´Ø§Ø±|preg|positive|Ø­Ø§Ù…Ù„)/i.test(String(e.result||e.outcome||e['Ø§Ù„Ù†ØªÙŠØ¬Ø©']||'')) && toDate(e.eventDate)>=d180).length;
  $('k-sc').textContent = preg180? (Math.round((insems180/preg180)*10)/10) : (insems180? (insems180).toFixed(1): 'â€”');

  // Abortion Ùˆ Dead Calving (Ø¢Ø®Ø± 365 ÙŠÙˆÙ…) ÙƒÙ†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª/Ø§Ù„Ø­Ù…Ù„
  const d365 = new Date(now.getTime()-365*86400000);
  const aborts = events.filter(e=> isType(e.type,ABORT) && toDate(e.eventDate)>=d365 ).length;
  const calvs  = events.filter(e=> isType(e.type,CALV)  && toDate(e.eventDate)>=d365 ).length;
  const deadCalv = events.filter(e=> isType(e.type,CALV) && (/(Ù…ÙŠØª|Ù†Ø§ÙÙ‚|dead|still)/i.test(String(e.outcome||e.calfStatus||e['Ø­Ø§Ù„Ø©_Ø§Ù„Ø¹Ø¬Ù„']||''))) && toDate(e.eventDate)>=d365).length;
  $('k-ar').textContent  = (calvs? Math.round((aborts/(preg180||calvs))*100):0) + '%';
  $('k-dcr').textContent = (calvs? Math.round((deadCalv/calvs)*100):0) + '%';

  // Age at First Calving (AFC) Ø¨Ø§Ù„Ø£Ø´Ù‡Ø±
  const afcVals=[];
  animals.forEach(a=>{
    const bd = toDate(a.birthDate || a.dob || a['ØªØ§Ø±ÙŠØ®_Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯']);
    const fc = toDate(a.firstCalvingDate) || (calvByAnimal.get(a.animalNumber||a.number||a.id)?.[0]);
    if(bd && fc){ afcVals.push( Math.round(daysBetween(fc,bd)/30.44) ); }
  });
  $('k-afc').textContent = afcVals.length? Math.round(afcVals.reduce((s,x)=>s+x,0)/afcVals.length):'â€”';

  // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ (ØªØ¨ÙˆÙŠØ¨)
  const cullEvents = events.filter(e=> /(Ø¨ÙŠØ¹|Ù†ÙÙˆÙ‚|Ø°Ø¨Ø­|sell|cull|death)/i.test(String(e.type||e.reason||'')) && toDate(e.eventDate)>=d365 );
  const cullTotal = animals.length || 1;
  const byCat = {prod:0, rep:0, health:0};
  cullEvents.forEach(e=>{
    const txt = norm(e.reason || e.cullReason || e.type);
    if(/(Ø§Ù†ØªØ§Ø¬|milk|low|production)/.test(txt)) byCat.prod++;
    else if(/(Ø¹Ù‚Ù…|ØªÙ†Ø§Ø³Ù„|repro|fert|infertile)/.test(txt)) byCat.rep++;
    else byCat.health++;
  });
  $('k-culProd').textContent   = Math.round((byCat.prod/cullTotal)*100)+'%';
  $('k-culRep').textContent    = Math.round((byCat.rep/cullTotal)*100)+'%';
  $('k-culHealth').textContent = Math.round((byCat.health/cullTotal)*100)+'%';

  // ØªØºØ°ÙŠØ©
  const priceMilk = Number(localStorage.getItem('mbk.pricePerKgMilk')||localStorage.getItem('nutrition.pricePerKgMilk')||0) || 0;
  const feedCostHead = Number(localStorage.getItem('mbk.feedCostPerHead')||localStorage.getItem('nutrition.feedCostPerHead')||0) || 0;

  // ØªÙ‚Ø¯ÙŠØ± ÙˆØ²Ù†: Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ ÙˆØ²Ù† Ø¨Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ù†Ø£Ø®Ø° 600 Ù„Ù„Ø£Ø¨Ù‚Ø§Ø± Ùˆ 550 Ù„Ù„Ø¬Ø§Ù…ÙˆØ³
  const estimateBW = an=>{
    const w = Number(an.weight||an.bodyWeight||0);
    if(w>0) return w;
    const sp = norm(an.species||an.type||an['Ø§Ù„Ù†ÙˆØ¹']||'cow');
    return /Ø¬Ø§Ù…ÙˆØ³|buff/.test(sp)? 550 : 600;
  };
  // ØªÙ‚Ø¯ÙŠØ± DMI = 0.038*BW Ù„Ù„Ø£Ø¨Ù‚Ø§Ø± (Ø¬Ø§Ù…ÙˆØ³ 0.036 ÙƒØ§ÙØªØ±Ø§Ø¶)
  const dmiPerHead = animals.filter(isInMilk).map(a=>{
    const sp = norm(a.species||a.type||a['Ø§Ù„Ù†ÙˆØ¹']||'cow');
    const r = /Ø¬Ø§Ù…ÙˆØ³|buff/.test(sp)? 0.036 : 0.038;
    return Math.round(estimateBW(a)*r*10)/10;
  });
  const avgDMI = dmiPerHead.length? Math.round(dmiPerHead.reduce((s,x)=>s+x,0)/dmiPerHead.length*10)/10 : 0;
  $('k-dmi').textContent = avgDMI? (avgDMI+' ÙƒØ¬Ù…'):'â€”';

  const fe = avgDMI? Math.round((avgMilk/avgDMI)*100)/100 : 0; // ÙƒÙØ§Ø¡Ø© ØªØ­ÙˆÙŠÙ„ = Ù„Ø¨Ù†/Ù…Ø§Ø¯Ø© Ø¬Ø§ÙØ©
  $('k-fe').textContent = fe? fe.toFixed(2) : 'â€”';

  const iofc = (priceMilk && feedCostHead)? Math.round((priceMilk*avgMilk - feedCostHead)*10)/10 : 0;
  $('k-iofc').textContent = (iofc || iofc===0)? iofc+' Ø¬Ù†ÙŠÙ‡' : 'â€”';

  // BCS & Feces (Ù…ØªÙˆØ³Ø· Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¥Ù† ÙˆØ¬Ø¯Øª)
  const bcsEv = events.filter(e=> /(BCS|Ø­Ø§Ù„Ø© Ø¬Ø³Ù…ÙŠØ©)/i.test(String(e.type||'')) && Number(e.score)>0 );
  const fecEv = events.filter(e=> /(Ø±ÙˆØ«|Feces)/i.test(String(e.type||'')) && Number(e.score)>0 );
  const bcsAvg = bcsEv.length? Math.round((bcsEv.reduce((s,e)=>s+Number(e.score),0)/bcsEv.length)*100)/100 : 0;
  const fecAvg = fecEv.length? Math.round((fecEv.reduce((s,e)=>s+Number(e.score),0)/fecEv.length)*100)/100 : 0;
  $('k-bcs').textContent   = bcsAvg? bcsAvg.toFixed(2): 'â€”';
  $('k-feces').textContent = fecAvg? fecAvg.toFixed(2): 'â€”';
}

// Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
if(uid){
  onSnapshot(query(collection(db,'animals'), where('userId','==',uid)), snap=>{
    animals = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
    recompute();
  });
  onSnapshot(query(collection(db,'events'), where('userId','==',uid)), snap=>{
    events = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
    // Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø³Ù†Ø© ÙˆØ±Ø¨Ø¹ ÙÙ‚Ø· Ù„ØªØ³Ø±ÙŠØ¹
    const maxAgeMs = 420*86400000;
    events = events.filter(e=> { const d = toDate(e.eventDate); return d? (Date.now()-d.getTime()<=maxAgeMs):true; });
    recompute();
  });
} else {
  // Ø¹Ø±Ø¶ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ùˆ Ù…Ø§ ÙÙŠØ´ userId
  ['v-inmilk','v-preg','v-fresh','v-dry','k-sumMilk','k-avgMilk','k-inMilkNum','k-avgDIM','k-openDays','k-ci','k-cr','k-pr','k-sc','k-ar','k-dcr','k-afc','k-culProd','k-culRep','k-culHealth','k-fe','k-dmi','k-iofc','k-bcs','k-feces'].forEach(id=>{$(id).textContent='â€”';});
}
</script>

<script type="module" src="/js/smart-alerts.js"></script>
</body>
</html>
