<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>
<link rel="stylesheet" href="css/forms.css">
<link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#1b5e20"/>

<style>
:root{--bg:#fff9db;--card:#fff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
*{box-sizing:border-box}
html,body{overflow-x:hidden}
body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
h1{margin:0 0 16px;text-align:center;color:#1b5e20;font-weight:900}

/* ÙƒØ§Ø±Øª Ø¹Ø§Ù… */
.card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-top:12px}

/* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª */
.dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.tile{position:relative;background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
  padding:16px;text-align:center;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:6px;min-height:118px}
.tile .icon{display:block;width:44px;height:44px;line-height:44px;border-radius:50%;border:1px solid var(--border);font-size:24px;margin-bottom:6px}

/* ====== ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (THI Clock) ====== */
#weatherClassic{background:#ffe3e8;border:1.5px solid #ffccd5;border-radius:16px;padding:12px}
#weatherClassic .bar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
#weatherClassic .seg{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
#weatherClassic .seg.active{background:#2e7d32;color:#fff}
#weatherClassic .btn{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:8px;padding:4px 10px;font-size:12px;cursor:pointer}
#weatherClassic .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
#weatherClassic .pill{background:#f7fff4;border:1px solid #c5e1a5;border-radius:12px;padding:8px;text-align:center}
#weatherClassic .pill b{display:block;margin-top:4px}
#weatherClassic .right{grid-row:1 / span 3;grid-column:2;display:flex;align-items:center;justify-content:center}
.thi-clock{position:relative;width:180px;height:180px}
.thi-clock .dial{position:absolute;inset:0;border-radius:50%;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.1)}
.thi-clock .arc{position:absolute;inset:0;border-radius:50%;
  -webkit-mask:radial-gradient(farthest-side,transparent 55%, #000 56%);
          mask:radial-gradient(farthest-side,transparent 55%, #000 56%)}
.thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;
  background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);
  -webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);
          mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
.thi-clock .needle{position:absolute;left:50%;top:50%;width:2px;height:42%;background:#000;transform-origin:bottom center;
  transform:translate(-50%,-100%) rotate(var(--angle,-120deg));border-radius:2px;transition:transform .9s cubic-bezier(.22,.8,.2,1)}
.thi-clock .needle::after{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:8px;height:8px;border-radius:50%;background:inherit}
.thi-clock .center{position:absolute;left:50%;top:50%;width:10px;height:10px;border-radius:50%;background:#000;transform:translate(-50%,-50%)}

/* KPIs Ø§Ù„Ø­Ù„Ù‚ÙŠØ© Ø§Ù„Ù…Ø®ØªØµØ±Ø© */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.kpi{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px;min-height:72px}
.kpi-ring{flex:0 0 auto}
.kpi-ring svg{width:60px;height:60px;display:block}
.kpi-ring circle.bg{fill:none;stroke:#e0e0e0;stroke-width:6}
.kpi-ring circle.fg{fill:none;stroke:#2e7d32;stroke-width:6;stroke-linecap:round;stroke-dasharray:113.097;stroke-dashoffset:113.097;transform:rotate(-90deg);transform-origin:22px 22px;transition:stroke-dashoffset .7s ease, stroke .3s ease}
.kpi-body{display:flex;flex-direction:column;gap:2px}
.kpi-title{font-weight:800;color:#1b5e20;font-size:13px}
.kpi-value{font-weight:900;font-size:20px;color:#065f46;line-height:1}
.kpi-sub{font-size:11px;color:#4f5b62}
.kpi:hover{transform:translateY(-1px);box-shadow:0 2px 10px rgba(0,0,0,.06)}

/* ØªØ¨ÙˆÙŠØ¨Ø§Øª */
.tabs{display:flex;gap:8px;margin:14px 0 10px;overflow:auto}
.tab-btn{padding:6px 14px;border-radius:999px;background:#e8f5e9;border:1px solid #c5e1a5;color:#2e7d32;font-weight:700;white-space:nowrap;cursor:pointer}
.tab-btn.active{background:#2e7d32;color:#fff;border-color:#2e7d32}
.tab-content{display:none}
.tab-content.active{display:block}

/* Toggle Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹ */
.herd-type{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.herd-type .opt{padding:6px 14px;border-radius:999px;border:1px solid #c5e1a5;background:#fff;color:#2e7d32;font-weight:700;cursor:pointer}
.herd-type .opt.active{background:#2e7d32;color:#fff;border-color:#2e7d32}
.badge{display:inline-block;border:1px solid #c5e1a5;border-radius:999px;padding:2px 8px;font-size:11px;background:#fff}

@media(max-width:560px){
  .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
  .tile{min-height:110px;padding:14px}
  .tile-m-full{grid-column:1 / -1}
}
</style>
<link rel="stylesheet" href="css/gauge.css">
</head>
<body>
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>

  <!-- ================== ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ================== -->
  <div id="weatherClassic" class="card" aria-label="Ø§Ù„Ø·Ù‚Ø³ Ùˆ Ù…Ø¤Ø´Ø± THI">
    <div class="bar">
      <button class="btn" id="wxRefresh" type="button">ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn" id="wxPin" type="button">Ø«Ø¨Ù‘Øª</button>
      <span style="margin-inline-start:auto;font-weight:bold;">Ø§Ù„Ù…ÙˆØ¶Ø¹</span>
      <button class="seg" id="segFarm" type="button">Ù…Ø²Ø±Ø¹ØªÙŠ</button>
      <button class="seg" id="segGPS" type="button">Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>

    <div class="grid">
      <div class="pill"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wxTemp">â€”Â°C</b></div>
      <div class="right">
        <div class="thi-clock">
          <div class="dial"><div id="thiArc" class="arc"></div></div>
          <div id="thiNeedle" class="needle"></div>
          <div class="center"></div>
        </div>
      </div>
      <div class="pill"><div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wxHum">â€”%</b></div>
      <div class="pill"><div>THI</div><b id="wxTHI">â€”</b></div>
      <div class="pill" style="grid-column:1 / span 2"><div>Ø§Ù„Ø­Ø§Ù„Ø©</div><b id="wxState">â€”</b></div>
    </div>
  </div>

  <div id="kpi-gauges" style="display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin:12px 0">
    <div id="g-thi"></div>
    <div id="g-prod"></div>
    <div id="g-repro"></div>
    <div id="g-health"></div>
  </div>

  <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª / Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
  <div class="dashboard card" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">ğŸ®</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>
    <div class="tile" id="groupsTile" role="button" tabindex="0"
         onclick="(window.dataLayer=window.dataLayer||[]).push({event:'tile_click',tile:'groups',page:'dashboard'}); location.href='groups.html'">
      <span class="icon">ğŸ‘¥</span> Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø±Ø¨ÙŠÙƒ
    </div>
    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="tile" id="sensorsTile" role="button" tabindex="0">
      <span class="icon">ğŸ›°ï¸</span> Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª
      <span class="badge" id="sensorsStatus">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦</span>
    </div>
    <div class="tile" id="nutritionEvalTile" role="button" tabindex="0" onclick="location.href='nutrition-eval.html'">
      ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ©
    </div>
  </div>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ø­Ù„Ù‚Ø§Øª Ù…Ø®ØªØµØ±Ø©) -->
  <div class="card" id="herdGauges" aria-label="Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹">
    <div style="font-weight:800;color:#1b5e20;margin-bottom:10px;display:flex;align-items:center;gap:8px">
      ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ø¥Ù†ØªØ§Ø¬ÙŠ + ØªÙ†Ø§Ø³Ù„ÙŠ)
      <span id="g-date" style="margin-inline-start:auto" class="badge">â€”</span>
    </div>

    <div class="kpi-grid">
      <div class="kpi" data-key="inMilkPct" data-hint="Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-inmilk" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨</div>
          <div class="kpi-value" id="v-inmilk">â€”%</div>
          <div class="kpi-sub">Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†</div>
        </div>
      </div>

      <div class="kpi" data-key="pregRate" data-hint="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø± Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-preg" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø±</div>
          <div class="kpi-value" id="v-preg">â€”%</div>
          <div class="kpi-sub">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹</div>
        </div>
      </div>

      <div class="kpi" data-key="freshShare" data-hint="Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø¶Ù…Ù† Ø§Ù„Ø­Ù„Ø§Ø¨">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-fresh" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</div>
          <div class="kpi-value" id="v-fresh">â€”%</div>
          <div class="kpi-sub">Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹ ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨</div>
        </div>
      </div>

      <div class="kpi" data-key="dryShare" data-hint="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬Ø§Ù Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-dry" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">Ø¬Ø§Ù</div>
          <div class="kpi-value" id="v-dry">â€”%</div>
          <div class="kpi-sub">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹</div>
        </div>
      </div>

      <div class="kpi" data-key="serviceRate" data-hint="Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¤Ù‡Ù„Ø§Øª Ø®Ù„Ø§Ù„ 21 ÙŠÙˆÙ…">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-service" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ„Ù‚ÙŠØ­</div>
          <div class="kpi-value" id="v-service">â€”%</div>
          <div class="kpi-sub">21 ÙŠÙˆÙ…</div>
        </div>
      </div>

      <div class="kpi" data-key="conceptionRate" data-hint="Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª Ø§Ù„ØªÙŠ Ø§Ù†ØªÙ‡Øª Ø¨Ø­Ù…Ù„ / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª">
        <div class="kpi-ring" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle id="r-conception" class="fg" cx="22" cy="22" r="18"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-title">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø®ØµØ§Ø¨</div>
          <div class="kpi-value" id="v-conception">â€”%</div>
          <div class="kpi-sub">ÙŠØ³ØªÙ†Ø¯ Ù„Ø±Ø¨Ø· Ø§Ù„ØªÙ„Ù‚ÙŠØ­ Ø¨Ø§Ù„ØªØ´Ø®ÙŠØµ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨ Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹ -->
  <div class="card">
    <div class="herd-type">
      <b>Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹:</b>
      <button class="opt" data-spec="cow" id="opt-cow">Ø£Ø¨Ù‚Ø§Ø±</button>
      <button class="opt" data-spec="buffalo" id="opt-buffalo">Ø¬Ø§Ù…ÙˆØ³</button>
      <span class="badge" id="spec-note" style="margin-inline-start:auto">â€”</span>
    </div>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª: Ø¥Ù†ØªØ§Ø¬ / ØªÙ†Ø§Ø³Ù„ / Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ / ØªØºØ°ÙŠØ© -->
  <div class="card" id="tabsCard">
    <div class="tabs">
      <button class="tab-btn active" data-tab="prod">Ø¥Ù†ØªØ§Ø¬</button>
      <button class="tab-btn" data-tab="repro">ØªÙ†Ø§Ø³Ù„</button>
      <button class="tab-btn" data-tab="cull">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯</button>
      <button class="tab-btn" data-tab="nut">ØªØºØ°ÙŠØ©</button>
    </div>

    <div class="tab-content active" id="tab-prod">
      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div><div id="k-avgMilk" class="kpi-value">â€”</div></div>
        <div class="kpi"><div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</div><div id="k-sumMilk" class="kpi-value">â€”</div></div>
        <div class="kpi"><div class="kpi-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ø§Ø¨</div><div id="k-inMilkNum" class="kpi-value">â€”</div></div>
        <div class="kpi"><div class="kpi-title">Ù…ØªÙˆØ³Ø· DIM</div><div id="k-avgDIM" class="kpi-value">â€”</div></div>
      </div>
    </div>

    <div class="tab-content" id="tab-repro">
      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©</div><div id="k-openDays" class="kpi-value">â€”</div></div>
        <div class="kpi"><div class="kpi-title">Ø§Ù„ÙØ§ØµÙ„ Ø¨ÙŠÙ† ÙˆÙ„Ø§Ø¯ØªÙŠÙ† (ÙŠÙˆÙ…)</div><div id="k-ci" class="kpi-value">â€”</div></div>
        <div class="kpi"><div class="kpi-title">Conception Rate</div><div id="k-cr" class="kpi-value">â€”%</div></div>
        <div class="kpi"><div class="kpi-title">Pregnancy Rate (21d)</div><div id="k-pr" class="kpi-value">â€”%</div></div>
        <div class="kpi"><div class="kpi-title">S/C</div><div id="k-sc" class="kpi-value">â€”</div></div>
        <div class="kpi"><div class="kpi-title">Abortion %</div><div id="k-ar" class="kpi-value">â€”%</div></div>
        <div class="kpi"><div class="kpi-title">Dead Calving %</div><div id="k-dcr" class="kpi-value">â€”%</div></div>
        <div class="kpi"><div class="kpi-title">Ø§Ù„Ø¹Ù…Ø± Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ÙˆÙ„Ø§Ø¯Ø© (Ø´Ù‡Ø±)</div><div id="k-afc" class="kpi-value">â€”</div></div>
      </div>
    </div>

    <div class="tab-content" id="tab-cull">
      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø¥Ù†ØªØ§Ø¬ÙŠ</div><div id="k-culProd" class="kpi-value">â€”%</div></div>
        <div class="kpi"><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØªÙ†Ø§Ø³Ù„ÙŠ</div><div id="k-culRep" class="kpi-value">â€”%</div></div>
        <div class="kpi"><div class="kpi-title">Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØµØ­ÙŠ</div><div id="k-culHealth" class="kpi-value">â€”%</div></div>
      </div>
    </div>

    <div class="tab-content" id="tab-nut">
      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-title">Feed Efficiency</div><div id="k-fe" class="kpi-value">â€”</div></div>
        <div class="kpi"><div class="kpi-title">DMI (ÙƒØ¬Ù…/Ø±Ø£Ø³)</div><div id="k-dmi" class="kpi-value">â€”</div></div>
        <div class="kpi"><div class="kpi-title">IOFC (ÙŠÙˆÙ…ÙŠ/Ø±Ø£Ø³)</div><div id="k-iofc" class="kpi-value">â€”</div></div>
        <div class="kpi"><div class="kpi-title">BCS (Ù…ØªÙˆØ³Ø·)</div><div id="k-bcs" class="kpi-value">â€”</div></div>
        <div class="kpi"><div class="kpi-title">Feces Score (Ù…ØªÙˆØ³Ø·)</div><div id="k-feces" class="kpi-value">â€”</div></div>
      </div>
    </div>
  </div>

  <!-- ====== Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ====== -->
  <script src="/js/tenant-bootstrap.js"></script>
  <script type="module" src="/js/app-core.js"></script>

  <!-- ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ + THI Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ -->
  <script id="wx-reg">
  (function(){
    const box = document.getElementById('weatherClassic');
    const tEl = document.getElementById('wxTemp');
    const hEl = document.getElementById('wxHum');
    const thiEl = document.getElementById('wxTHI');
    const sEl = document.getElementById('wxState');
    const thiArc = document.getElementById('thiArc');
    const thiNeedle = document.getElementById('thiNeedle');
    const btnRefresh = document.getElementById('wxRefresh');
    const btnPin = document.getElementById('wxPin');
    const segFarm = document.getElementById('segFarm');
    const segGPS  = document.getElementById('segGPS');
    if(!box||!tEl||!hEl||!thiEl||!sEl||!thiArc||!thiNeedle||!btnRefresh||!btnPin||!segFarm||!segGPS) return;

    const DEF = { lat:30.0444, lon:31.2357, place:'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©' };
    const LS_PIN='mbk_farm', LS_WX='mbk_wx_cache', LS_REG='mbk_reg_geo';
    let mode='reg', pinned=null;

    function THI(c,rh){ const f=c*9/5+32; return Math.round(((f-(0.55-0.0055*rh)*(f-58)))); }
    function bands(){ return {t1:66,t2:70,t3:77,t4:82}; }
    function colorAndText(thi,b){
      if(thi<b.t1) return {bg:'#c8e6c9',txt:'Ù…Ø±ÙŠØ­'};
      if(thi<b.t2) return {bg:'#fff9c4',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø®ÙÙŠÙ'};
      if(thi<b.t3) return {bg:'#ffe0b2',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ù…ØªÙˆØ³Ø·'};
      if(thi<b.t4) return {bg:'#ffccbc',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯'};
      return {bg:'#ffcdd2',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯ Ø¬Ø¯Ø§'};
    }
    function drawTHI(thi){
      thiArc.style.background =
        'conic-gradient(from -120deg,#90caf9 0% 25%,#fff59Ø¯ 25% 50%,#ffcc80 50% 75%,#ef5350 75% 100%)'.replace('Ø¯','9');
      const ang=-120+((thi-50)/40)*240;
      thiNeedle.style.setProperty('--angle',ang+'deg');
      const {bg,txt}=colorAndText(thi,bands());
      box.style.background = bg; sEl.textContent = txt;
    }
    const readJSON=(k)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch{ return null; } };
    const writeJSON=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };

    function readTenantAddress(){
      const T = window.__TENANT__ || {};
      const country = T.country || T.countryCode || T.address?.country || T.profile?.country;
      const region  = T.region  || T.state  || T.governorate || T.address?.region || T.profile?.region;
      const city    = T.city    || T.town   || T.address?.city || T.profile?.city;
      return { country, region, city };
    }
    function regKey(addr){
      const parts = [addr.city, addr.region, addr.country].filter(Boolean).join('|').toLowerCase();
      return parts || 'default';
    }
    async function geocodeFromRegistration(){
      const addr = readTenantAddress();
      if(!addr.country && !addr.region && !addr.city) return null;
      const key = regKey(addr);
      const cached = readJSON(LS_REG);
      if(cached && cached.key===key && cached.lat && cached.lon) return cached;
      const q = encodeURIComponent([addr.city, addr.region, addr.country].filter(Boolean).join(', '));
      try{
        const ctl = AbortSignal.timeout ? { signal:AbortSignal.timeout(6000) } : {};
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1&language=ar`, ctl);
        const j = await r.json();
        const item = j?.results?.[0];
        if(item){
          const place = [item.name, item.admin1, item.country].filter(Boolean).join('ØŒ ');
          const res = { lat:item.latitude, lon:item.longitude, place, key };
          writeJSON(LS_REG, res); return res;
        }
      }catch(e){}
      return null;
    }
    function getPinned(){ return readJSON(LS_PIN); }
    function savePinned(lat,lon,place){ writeJSON(LS_PIN, {lat,lon,place:place||'Ù…Ø²Ø±Ø¹ØªÙŠ'}); }

    function getGPS(){
      return new Promise((resolve)=>{
        if(!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          p => resolve({ lat:p.coords.latitude, lon:p.coords.longitude, place:'Ù…ÙˆÙ‚Ø¹ÙŠ' }),
          _ => resolve(null),
          { enableHighAccuracy:true, timeout:5000 }
        );
      });
    }
    async function pickCoords(){
      if(pinned) return pinned;
      if(mode==='gps'){ const g = await getGPS(); if(g) return g; }
      const reg = await geocodeFromRegistration(); if(reg) return reg;
      return DEF;
    }
    function wxGetCached(){ const x = readJSON(LS_WX); if(x && Date.now()-x.ts < 60_000) return x.data; return null; }
    function wxSetCached(data){ writeJSON(LS_WX, {ts:Date.now(), data}); }
    async function fetchWeather(lat, lon){
      const cached = wxGetCached();
      if(cached && typeof cached.t==='number' && typeof cached.h==='number') return cached;
      try{
        const ctl = AbortSignal.timeout ? { signal:AbortSignal.timeout(6000) } : {};
        const r = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`,
          { cache:'no-store', ...ctl }
        );
        const j=await r.json();
        const data = { t:j.current?.temperature_2m, h:j.current?.relative_humidity_2m };
        if(typeof data.t==='number' && typeof data.h==='number') wxSetCached(data);
        return data;
      }catch{ return null; }
    }
    function activate(which){
      segFarm.classList.toggle('active', which==='reg');
      segGPS .classList.toggle('active', which==='gps');
    }
    async function render(){
      const c = await pickCoords();
      const data = await fetchWeather(c.lat, c.lon);
      if(!data || typeof data.t!=='number' || typeof data.h!=='number'){
        tEl.textContent='â€”Â°C'; hEl.textContent='â€”%'; thiEl.textContent='â€”'; sEl.textContent='â€”'; return;
      }
      const t=Math.round(data.t), h=Math.round(data.h), thi=THI(t,h);
      tEl.textContent=`${t}Â°C`; hEl.textContent=`${h}%`; thiEl.textContent=thi; drawTHI(thi);
    }
    async function boot(){
      pinned = getPinned() || null;
      mode = 'reg'; activate('reg');
      segFarm.addEventListener('click', ()=>{ mode='reg'; activate('reg'); render(); });
      segGPS .addEventListener('click', ()=>{ mode='gps'; activate('gps'); render(); });
      btnRefresh.addEventListener('click', render);
      btnPin.addEventListener('click', async ()=>{ mode='gps'; const g = await getGPS(); if(g){ savePinned(g.lat,g.lon,g.place); pinned=g; } mode='reg'; activate('reg'); render(); });
      render();
    }
    document.addEventListener('DOMContentLoaded', boot);
  })();
  </script>

  <!-- ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª -->
  <script>
    (function(){
      const tile=document.getElementById('sensorsTile');
      const badge=document.getElementById('sensorsStatus');
      function setBadge(txt,ok){ if(!badge) return; badge.textContent=txt; badge.style.background=ok?'#e8f5e9':'#fff8e1'; badge.style.borderColor=ok?'#c5e1a5':'#ffecb3'; }
      async function ping(){
        try{
          setBadge('Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦',false);
          const r=await fetch('/api/sensors/health');
          if(!r.ok){ setBadge('ØºÙŠØ± Ù…ØªØµÙ„',false); return; }
          const j=await r.json();
          const n=Number(j?.devices||0);
          setBadge(`Ù…ØªØµÙ„ â€¢ ${n}`,true);
        }catch{ setBadge('ØºÙŠØ± Ù…ØªØµÙ„',false); }
      }
      tile?.addEventListener('click',()=>{ location.href='sensor-test.html'; });
      document.addEventListener('DOMContentLoaded',()=>{ ping(); setInterval(ping,60000); });
    })();
  </script>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ + Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Firestore) -->
  <script type="module" id="herd-gauges-fs">
  import { db } from '/js/firebase-config.js';
  import { collection, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const $ = s => document.getElementById(s);
  const RING_LEN = 113.097;

  // ØªØ¨ÙˆÙŠØ¨
  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.getElementById('tab-'+b.dataset.tab).classList.add('active');
    });
  });

  // Helpers
  const norm = s => String(s||'').toLowerCase()
      .replace(/[\u0610-\u061a\u064b-\u065f\u0670\u06d6-\u06ed]/g,'')
      .trim();
  const toDate = v => {
    if(!v) return null;
    if(typeof v==='string') return new Date(v);
    if(v instanceof Date) return v;
    if(typeof v==='object' && typeof v.seconds==='number') return new Date(v.seconds*1000);
    return null;
  };
  const daysBetween = (a,b)=> Math.floor((a-b)/86400000);

  const isDry = an => {
    const st = norm(an.productionStatus || an.lactationStatus || an.status || an['Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„Ù„Ø¨Ù†ÙŠØ©'] || '');
    const dryBool = an.dry === true || an.isDry === true || an.dryCow === true || an['Ø¬Ø§Ù'] === true;
    return dryBool || an.inMilk === false || /(dry|dryoff|Ø¬Ø§Ù|Ø¬Ø§ÙÙ‡|Ø¬Ø§ÙØ©)/.test(st);
  };
  const isInMilk = an => {
    if (isDry(an)) return false;
    if (an.inMilk === true) return true;
    const st = norm(an.productionStatus || an.lactationStatus || an.status || an['Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„Ù„Ø¨Ù†ÙŠØ©'] || '');
    return /(Ø­Ù„Ø§Ø¨|ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨|Ù…Ø­Ù„Ø¨|Ù…Ù†ØªØ¬|Ø­Ù„ÙŠØ¨|milk|milking|lact)/.test(st);
  };
  const isPreg = an => {
    const rs = String(an.reproductiveStatus || an.pregStatus || an['Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©'] || '').toLowerCase();
    return an.pregnant===true || rs.includes('preg') || rs.includes('Ø¹Ø´Ø§Ø±') || rs.includes('Ø­Ø§Ù…Ù„');
  };
  const getDIM = an => {
    const calv = toDate(an.calvingDate || an.lastCalvingDate || an.calvedAt || an['ØªØ§Ø±ÙŠØ®_Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©']);
    return calv ? Math.max(0, daysBetween(new Date(), calv)) : 0;
  };

  // Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  const INSEM = ['ØªÙ„Ù‚ÙŠØ­','insemination'];
  const PD    = ['ØªØ´Ø®ÙŠØµ\\s*Ø­Ù…Ù„','pregnancy\\s*diagnosis'];
  const CALV  = ['ÙˆÙ„Ø§Ø¯Ù‡','ÙˆÙ„Ø§Ø¯Ø©','calving'];
  const ABORT = ['Ø§Ø¬Ù‡Ø§Ø¶','abortion'];
  const DEAD  = ['Ù…ÙŠØª','Ù†Ø§ÙÙ‚','dead','still'];
  const MILK  = ['Ù„Ø¨Ù†','milk'];
  const isType = (t, patterns) => patterns.some(p => new RegExp(p,'i').test(String(t||'')));

  // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ (Ø£Ø¨Ù‚Ø§Ø±/Ø¬Ø§Ù…ÙˆØ³)
  const LS_SPEC = 'mbk.herd.species';
  const optCow = $('opt-cow'), optBuff = $('opt-buffalo'), specNote = $('spec-note');
  function setSpecUI(spec){
    optCow.classList.toggle('active', spec==='cow');
    optBuff.classList.toggle('active', spec==='buffalo');
    specNote.textContent = spec==='cow' ? 'Ù…Ø¹Ø§ÙŠÙŠØ±: Ø£Ø¨Ù‚Ø§Ø±' : 'Ù…Ø¹Ø§ÙŠÙŠØ±: Ø¬Ø§Ù…ÙˆØ³';
  }
  function getStoredSpec(){ return localStorage.getItem(LS_SPEC) || null; }
  function setStoredSpec(s){ localStorage.setItem(LS_SPEC, s); setSpecUI(s); recompute(); }

  optCow.addEventListener('click', ()=> setStoredSpec('cow'));
  optBuff.addEventListener('click', ()=> setStoredSpec('buffalo'));

  function autoDetectSpec(animals){
    let buff=0, cow=0;
    for(const a of animals){
      const sp = norm(a.species||a.type||a['Ø§Ù„Ù†ÙˆØ¹']||'');
      if(/Ø¬Ø§Ù…ÙˆØ³|buff/.test(sp)) buff++;
      else if(/cow|Ø¨Ù‚Ø±|Ø§Ø¨Ù‚Ø§Ø±|Ø£Ø¨Ù‚Ø§Ø±/.test(sp)) cow++;
    }
    return buff>cow ? 'buffalo' : 'cow';
  }

  // Benchmarks
  function getBench(spec){
    if(spec==='buffalo'){
      return { CR:{good:48, warn:38}, PR:{good:20, warn:15}, OPEN:{good:130, warn:155, lowerBetter:true}, CI:{good:410, warn:450, lowerBetter:true}, SC:{good:2.2, warn:2.6, lowerBetter:true} };
    }
    return { CR:{good:55, warn:45}, PR:{good:25, warn:18}, OPEN:{good:110, warn:130, lowerBetter:true}, CI:{good:380, warn:410, lowerBetter:true}, SC:{good:2.0, warn:2.4, lowerBetter:true} };
  }

  function kpiColor(value, rule){
    if(value==null || isNaN(value)) return '#065f46';
    const v = Number(value);
    if(rule.lowerBetter){
      if(v<=rule.good) return '#2e7d32';
      if(v<=rule.warn) return '#fdd835';
      return '#ef6c00';
    }else{
      if(v>=rule.good) return '#2e7d32';
      if(v>=rule.warn) return '#fdd835';
      return '#ef6c00';
    }
  }

  function setRing(idSuffix, pct, stroke){
    const el = document.getElementById('r-'+idSuffix);
    if(!el) return;
    const p = Math.max(0, Math.min(100, Number(pct)||0));
    const off = RING_LEN * (1 - p/100);
    el.style.setProperty('stroke-dashoffset', off.toFixed(2));
    el.style.stroke = stroke || '#2e7d32';
  }

  function calcHerdFromAnimals(animals){
    const total = animals.length;
    let inMilk=0, fresh=0, dry=0, preg=0, open=0, sumDimOpen=0;

    for(const an of animals){
      const dryF  = isDry(an);
      const milkF = isInMilk(an);

      if (milkF){ inMilk++; const d = getDIM(an); if(d>=1 && d<=45) fresh++; }
      if (dryF){ dry++; }
      if (isPreg(an)) preg++;
      else if (milkF){ open++; sumDimOpen += getDIM(an); }
    }

    const inMilkPct = total? Math.round(inMilk/total*100) : 0;
    const pregRate  = total? Math.round(preg/total*100)  : 0;
    const freshShare= inMilk? Math.round(fresh/inMilk*100) : 0;
    const dryShare  = total? Math.round(dry/total*100)   : 0;
    const openDim   = open? Math.round(sumDimOpen/open)  : 0;

    return { total, inMilk, inMilkPct, preg, pregRate, fresh, freshShare, dry, dryShare, open, openDim };
  }

  function calcReproFromEvents(animals, events){
    const now = new Date();
    const d21 = new Date(now.getTime() - 21*86400000);
    const d90 = new Date(now.getTime() - 90*86400000);
    const d180 = new Date(now.getTime() - 180*86400000);

    const eligible = animals.filter(a => isInMilk(a) && !isPreg(a) && getDIM(a) >= 60).length;

    const servicesLast21 = events.filter(e =>
      isType(e.type, INSEM) && toDate(e.eventDate) && toDate(e.eventDate) >= d21
    ).length;
    const serviceRate = eligible ? Math.round( (servicesLast21 / eligible) * 100 ) : 0;

    const insems90 = events.filter(e=> isType(e.type,INSEM) && toDate(e.eventDate) && toDate(e.eventDate)>=d90);
    const pdPos90  = events.filter(e=>{
      const d = toDate(e.eventDate);
      const res = String(e.result || e.outcome || e['Ø§Ù„Ù†ØªÙŠØ¬Ø©'] || '').toLowerCase();
      return isType(e.type, PD) && d && d>=d90 && /(Ø¹Ø´Ø§Ø±|preg|positive|Ø­Ø§Ù…Ù„)/.test(res);
    });

    const insByAnimal = new Map();
    insems90.forEach(e=>{
      const key = e.animalId || e.animalNumber || e.number || e.tag;
      if(!key) return;
      const arr = insByAnimal.get(key)||[];
      arr.push(e);
      insByAnimal.set(key,arr);
    });

    let linkedPreg=0;
    pdPos90.forEach(pd=>{
      const key = pd.animalId || pd.animalNumber || pd.number || pd.tag;
      if(!key) return;
      const dPD = toDate(pd.eventDate);
      const list = (insByAnimal.get(key)||[]).filter(x=> toDate(x.eventDate) && toDate(x.eventDate) <= dPD);
      if(!list.length) return;
      list.sort((a,b)=> toDate(b.eventDate)-toDate(a.eventDate));
      const lastIns = list[0];
      if(dPD - toDate(lastIns.eventDate) <= 300*86400000) linkedPreg++;
    });

    const cr = insems90.length ? Math.min(100, Math.round((linkedPreg/insems90.length)*100)) : 0;

    const newPreg21 = events.filter(e=> isType(e.type,PD)
      && /(Ø¹Ø´Ø§Ø±|preg|positive|Ø­Ø§Ù…Ù„)/i.test(String(e.result||e.outcome||e['Ø§Ù„Ù†ØªÙŠØ¬Ø©']||'')) && toDate(e.eventDate)>=d21).length;
    const pr = eligible? Math.round((newPreg21/eligible)*100) : 0;

    const insems180 = events.filter(e=> isType(e.type,INSEM) && toDate(e.eventDate)>=d180).length;
    const preg180   = events.filter(e=> isType(e.type,PD) && /(Ø¹Ø´Ø§Ø±|preg|positive|Ø­Ø§Ù…Ù„)/i.test(String(e.result||e.outcome||e['Ø§Ù„Ù†ØªÙŠØ¬Ø©']||'')) && toDate(e.eventDate)>=d180).length;
    const sc = preg180? (Math.round((insems180/preg180)*10)/10) : (insems180? (insems180).toFixed(1): 0);

    return { serviceRate, cr, pr, sc };
  }

  function calcProduction(animals, events){
    const milking = animals.filter(isInMilk);
    const inMilk = milking.length;
    const today = new Date().toDateString();

    const milkToday = events.filter(e => isType(e.type, MILK) && toDate(e.eventDate)?.toDateString()===today);
    const sumMilk = milkToday.reduce((s,e)=> s + (Number(e.amount)||0), 0);
    const avgMilk = inMilk ? Math.round((sumMilk/inMilk)*10)/10 : 0;
    const avgDIM  = inMilk ? Math.round(milking.reduce((s,a)=> s+getDIM(a),0)/inMilk) : 0;

    return { sumMilk, avgMilk, inMilk, avgDIM };
  }

  function calcReproExtras(animals, events){
    const now = new Date();
    const d365 = new Date(now.getTime()-365*86400000);

    const open = animals.filter(a=> isInMilk(a) && !isPreg(a) );
    const openDays = open.length? Math.round(open.reduce((Ø³,a)=> Ø³+getDIM(a),0)/open.length) : 0; // Ø³=Ø³

    let ciVals=[];
    const calvByAnimal = new Map();
    events.filter(e=> isType(e.type,CALV) && toDate(e.eventDate)).forEach(e=>{
      const key = e.animalId || e.animalNumber || e.number || e.tag;
      if(!key) return;
      const arr = calvByAnimal.get(key) || [];
      arr.push(toDate(e.eventDate));
      calvByAnimal.set(key, arr);
    });
    for(const arr of calvByAnimal.values()){
      arr.sort((a,b)=>a-b);
      if(arr.length>=2){
        const last = arr[arr.length-1], prev = arr[arr.length-2];
        ciVals.push(daysBetween(last,prev));
      }
    }
    const ci = ciVals.length? Math.round(ciVals.reduce((a,b)=>a+b,0)/ciVals.length):0;

    const aborts = events.filter(e=> isType(e.type,ABORT) && toDate(e.eventDate)>=d365 ).length;
    const calvs  = events.filter(e=> isType(e.type,CALV)  && toDate(e.eventDate)>=d365 ).length;
    const deadCalv = events.filter(e=> isType(e.type,CALV) && (/(Ù…ÙŠØª|Ù†Ø§ÙÙ‚|dead|still)/i.test(String(e.outcome||e.calfStatus||e['Ø­Ø§Ù„Ø©_Ø§Ù„Ø¹Ø¬Ù„']||''))) && toDate(e.eventDate)>=d365).length;

    const afcVals=[];
    animals.forEach(a=>{
      const bd = toDate(a.birthDate || a.dob || a['ØªØ§Ø±ÙŠØ®_Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯']);
      let fc = a.firstCalvingDate ? toDate(a.firstCalvingDate) : null;
      if(!fc){
        const key = a.animalId || a.animalNumber || a.number || a.id || a.tag;
        const arr = calvByAnimal.get(key);
        if(arr && arr.length) fc = arr[0];
      }
      if(bd && fc){ afcVals.push( Math.round(daysBetween(fc,bd)/30.44) ); }
    });
    const afc = afcVals.length? Math.round(afcVals.reduce((s,x)=>s+x,0)/afcVals.length):0;

    return { openDays, ci, ar: calvs? Math.round((aborts/Math.max(calvs,1))*100):0, dcr: calvs? Math.round((deadCalv/calvs)*100):0, afc };
  }

  function calcNutrition(animals, prod){
    const priceMilk = Number(localStorage.getItem('mbk.pricePerKgMilk')||localStorage.getItem('nutrition.pricePerKgMilk')||0) || 0;
    const feedCostHead = Number(localStorage.getItem('mbk.feedCostPerHead')||localStorage.getItem('nutrition.feedCostPerHead')||0) || 0;

    const estimateBW = an=>{
      const w = Number(an.weight||an.bodyWeight||0);
      if(w>0) return w;
      const sp = norm(an.species||an.type||an['Ø§Ù„Ù†ÙˆØ¹']||'cow');
      return /Ø¬Ø§Ù…ÙˆØ³|buff/.test(sp)? 550 : 600;
    };
    const milking = animals.filter(isInMilk);
    const coef = (a)=> (/Ø¬Ø§Ù…ÙˆØ³|buff/.test(norm(a.species||a.type||a['Ø§Ù„Ù†ÙˆØ¹']||''))) ? 0.036 : 0.038;
    const dmiHeads = milking.map(a => Math.round(estimateBW(a)*coef(a)*10)/10);
    const avgDMI = dmiHeads.length? Math.round(dmiHeads.reduce((s,x)=>s+x,0)/dmiHeads.length*10)/10 : 0;

    const fe = (avgDMI>0)? Math.round((prod.avgMilk/avgDMI)*100)/100 : 0;
    const iofc = (priceMilk && feedCostHead) ? Math.round((priceMilk*prod.avgMilk - feedCostHead)*10)/10 : 0;

    return { avgDMI, fe, iofc };
  }

  function renderGauges(base, reproRates, spec){
    const d = $('g-date'); if(d) d.textContent = new Date().toISOString().slice(0,10);

    setRing('inmilk', base.inMilkPct, '#2e7d32');  $('v-inmilk').textContent = base.inMilkPct + '%';
    setRing('preg',   base.pregRate,  kpiColor(base.pregRate, {good: (spec==='buffalo'?48:55), warn:(spec==='buffalo'?38:45)})); $('v-preg').textContent   = base.pregRate  + '%';
    setRing('fresh',  base.freshShare,'#2e7d32');  $('v-fresh').textContent  = base.freshShare+ '%';
    const dryClr = (base.dryShare<=18)?'#2e7d32':(base.dryShare<=25?'#fdd835':'#ef6c00');
    setRing('dry', base.dryShare, dryClr); $('v-dry').textContent = base.dryShare + '%';

    setRing('service', reproRates.serviceRate, kpiColor(reproRates.serviceRate, getBench(spec).PR)); $('v-service').textContent = reproRates.serviceRate + '%';
    setRing('conception', reproRates.cr, kpiColor(reproRates.cr, getBench(spec).CR)); $('v-conception').textContent = reproRates.cr + '%';
  }

  function colorizeTab(spec, base, reproRates, extras){
    const B = getBench(spec);
    $('k-openDays').style.color = kpiColor(extras.openDays, B.OPEN);
    $('k-ci').style.color       = kpiColor(extras.ci, B.CI);
    $('k-cr').style.color       = kpiColor(reproRates.cr, B.CR);
    $('k-pr').style.color       = kpiColor(reproRates.pr, B.PR);
    $('k-sc').style.color       = kpiColor(reproRates.sc, B.SC);
  }

  function renderTabs(prod, reproRates, extras, nut){
    $('k-sumMilk').textContent = String(prod.sumMilk.toFixed ? prod.sumMilk.toFixed(1) : Math.round(prod.sumMilk*10)/10);
    $('k-avgMilk').textContent = prod.avgMilk ? (prod.avgMilk+' ÙƒØ¬Ù…') : 'â€”';
    $('k-inMilkNum').textContent = String(prod.inMilk);
    $('k-avgDIM').textContent = prod.avgDIM ? (prod.avgDIM+' ÙŠÙˆÙ…') : 'â€”';

    $('k-openDays').textContent = extras.openDays || 'â€”';
    $('k-ci').textContent = extras.ci || 'â€”';
    $('k-cr').textContent = (reproRates.cr||0)+'%';
    $('k-pr').textContent = (reproRates.pr||0)+'%';
    $('k-sc').textContent = (reproRates.sc||0);
    $('k-ar').textContent = (extras.ar||0)+'%';
    $('k-dcr').textContent= (extras.dcr||0)+'%';
    $('k-afc').textContent= extras.afc || 'â€”';

    $('k-dmi').textContent = nut.avgDMI ? (nut.avgDMI+' ÙƒØ¬Ù…') : 'â€”';
    $('k-fe').textContent  = nut.fe ? nut.fe.toFixed(2) : 'â€”';
    $('k-iofc').textContent= (nut.iofc || nut.iofc===0) ? (nut.iofc+' Ø¬Ù†ÙŠÙ‡') : 'â€”';
  }

  let aSub=[], eSub=[];
  let currentSpec = getStoredSpec() || 'cow';

  function recompute(){
    if(!getStoredSpec() && aSub.length){
      currentSpec = autoDetectSpec(aSub);
      setSpecUI(currentSpec);
    }
    setSpecUI(currentSpec);

    const base = calcHerdFromAnimals(aSub);
    const prod = calcProduction(aSub, eSub);
    const reproRates = calcReproFromEvents(aSub, eSub, currentSpec);
    const extras = calcReproExtras(aSub, eSub);
    const nut = calcNutrition(aSub, prod);

    renderGauges(base, reproRates, currentSpec);
    renderTabs(prod, reproRates, extras, nut);
    colorizeTab(currentSpec, base, reproRates, extras);
  }

  const userId = window.__TENANT__?.userId || localStorage.getItem('userId');
  if(userId){
    try{
      const qA = query(collection(db, 'animals'), where('userId','==', userId));
      onSnapshot(qA, snap=>{ aSub = snap.docs.map(d=> ({ id:d.id, ...d.data() })); recompute(); });
    }catch(e){ console.warn('animals query error', e); }

    try{
      const qE = query(collection(db, 'events'), where('userId','==', userId));
      onSnapshot(qE, snap=>{
        eSub = snap.docs.map(d=> ({ id:d.id, ...d.data() }))
          .filter(e => {
            const d = toDate(e.eventDate);
            return d ? (Date.now() - d.getTime() <= 420*86400000) : true; // Ø¢Ø®Ø± ~14 Ø´Ù‡Ø±
          });
        recompute();
      });
    }catch(e){ console.warn('events query error', e); }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.kpi').forEach(el => { el.title = el.dataset.hint || ''; });
  });
  </script>

  <script type="module" src="/js/smart-alerts.js"></script>
  <script type="module">
  import { renderGauge, MBK_BANDS } from '/js/gauge.js';
  renderGauge(document.getElementById('g-thi'),   { value: 74, label: 'THI', unit: '', bands: MBK_BANDS.thi });
  renderGauge(document.getElementById('g-prod'),  { value: 82, label: 'Ø¥Ù†ØªØ§Ø¬', unit: '%', bands: MBK_BANDS.production });
  renderGauge(document.getElementById('g-repro'), { value: 58, label: 'ØªÙ†Ø§Ø³Ù„', unit: '%', bands: MBK_BANDS.reproduction });
  renderGauge(document.getElementById('g-health'),{ value: 91, label: 'ØµØ­Ø© (ØµÙØ§Øª/Ø±ÙˆØ«)', unit: '%', bands: MBK_BANDS.health });
  </script>
</body>
</html>
