<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body{background:#fff9db;font-family:Arial,sans-serif;padding:20px;color:#1b5e20;margin:0}
    h1{text-align:center;font-size:28px;font-weight:bold;margin:0 0 10px}
    /* Ø´Ø±ÙŠØ· Ù…Ø¤Ø´Ø±Ø§Øª Ù„Ù„Ù‚Ø·ÙŠØ¹ ÙƒÙ„Ù‡ */
    .smartbar{max-width:980px;margin:0 auto 12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #c5e1a5;background:#f1f8e9}
    /* Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© */
    .dashboard{max-width:980px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:15px}
    .card{background:#eafbe7;padding:20px;border-radius:12px;text-align:center;font-size:18px;font-weight:bold;cursor:pointer;border:2px solid #c5e1a5;box-shadow:2px 2px 5px rgba(0,0,0,.1)}
    .card:hover{background:#dcedc8}
    .icon{font-size:30px;margin-bottom:10px;display:block}
  </style>
</head>
<body>
  <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ -->
  <div class="smartbar">
    <span class="chip" id="chipDay">ğŸ“… Ø§Ù„ÙŠÙˆÙ…: â€”</span>
    <span class="chip">ğŸ¥› Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…: <b id="chipMilk">â€”</b> Ù„ØªØ±</span>
    <span class="chip">ğŸ“… ØªÙ„Ù‚ÙŠØ­Ø§Øª (30ÙŠ): <b id="chipIns">â€”</b></span>
    <span class="chip">ğŸ‘¶ ÙˆÙ„Ø§Ø¯Ø§Øª (30ÙŠ): <b id="chipCalv">â€”</b></span>
    <span class="chip">ğŸ’° ØµØ§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…: <b id="chipNet">â€”</b></span>
  </div>

  <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙƒØ§Ù…Ù„Ø© -->
  <div class="dashboard">
    <div class="card" onclick="location.href='add-animal.html'">
      <span class="icon">â•</span>ØªØ³Ø¬ÙŠÙ„ Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯
    </div>
    <div class="card" onclick="location.href='animal-list.html'">
      <span class="icon">ğŸ“‹</span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª
    </div>
    <div class="card" onclick="location.href='add-event.html'">
      <span class="icon">ğŸ—“ï¸</span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    </div>
    <div class="card" onclick="location.href='alerts.html'">
      <span class="icon">ğŸ””</span>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©
    </div>
    <div class="card" onclick="return openCowCardSmart(event)">
      <span class="icon">ğŸ†”</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©
    </div>
    <div class="card" onclick="location.href='daily-milk.html'">
      <span class="icon">ğŸ¥›</span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ
    </div>
    <div class="card" onclick="location.href='milk-reports.html'">
      <span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†
    </div>
    <div class="card" onclick="location.href='farm-economy.html'">
      <span class="icon">ğŸ’°</span>Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©
    </div>
    <div class="card" onclick="location.href='evaluation.html'">
      <span class="icon">ğŸ“ˆ</span>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª
    </div>
    <div class="card" onclick="location.href='smart-feeding.html'">
      <span class="icon">ğŸ½ï¸</span>Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©
    </div>
  </div>

<script type="module">
  // ===== Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
  const todayLocal = ()=>{ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };
  try { document.getElementById('chipDay').textContent = 'ğŸ“… Ø§Ù„ÙŠÙˆÙ…: ' + new Date(todayLocal()).toLocaleDateString('ar-EG'); }
  catch { document.getElementById('chipDay').textContent = 'ğŸ“… Ø§Ù„ÙŠÙˆÙ…: ' + todayLocal(); }
  const fmt = n => (n===null||n===undefined||isNaN(n)) ? 'â€”' : new Intl.NumberFormat('ar-EG',{maximumFractionDigits:1}).format(n);

  // ===== Ø²Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ© (ÙŠÙØªØ­ Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ ÙŠØ¸Ù‡Ø± Mini-Prompt)
  window.openCowCardSmart = function(e){
    e.preventDefault();
    const qs = new URLSearchParams(location.search);
    const id = qs.get('animalId') || localStorage.getItem('lastAnimalId') || '';
    if (id){
      localStorage.setItem('lastAnimalId', id);
      location.href = `cow-card.html?animalId=${encodeURIComponent(id)}&number=${encodeURIComponent(id)}`;
      return false;
    }
    if (document.getElementById('quickPrompt')) return false;
    const box = document.createElement('div');
    box.id = 'quickPrompt';
    box.style.cssText = 'position:fixed;inset:auto 12px 12px 12px;z-index:9999;background:#f1f8e9;border:1px solid #c5e1a5;border-radius:12px;padding:12px;display:flex;gap:8px;align-items:center';
    box.innerHTML = `
      <span style="font-weight:bold;color:#2e7d32">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†:</span>
      <input id="qpInput" type="text" inputmode="numeric" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px" placeholder="Ù…Ø«Ø§Ù„: 105">
      <button id="qpGo" style="padding:10px 14px;border:0;border-radius:8px;background:#2e7d32;color:#fff;font-weight:bold">ÙØªØ­</button>
      <button id="qpClose" style="padding:10px 14px;border:1px solid #2e7d32;border-radius:8px;background:#fff;color:#2e7d32;font-weight:bold">Ø¥Ù„ØºØ§Ø¡</button>
    `;
    document.body.appendChild(box);
    const input = box.querySelector('#qpInput');
    const go = ()=>{ const v=input.value.trim(); if(v){ box.remove(); localStorage.setItem('lastAnimalId', v); location.href = `cow-card.html?animalId=${encodeURIComponent(v)}&number=${encodeURIComponent(v)}`; } else input.focus(); };
    box.querySelector('#qpGo').onclick = go;
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') go(); });
    box.querySelector('#qpClose').onclick = ()=> box.remove();
    input.focus();
    return false;
  };

  // ===== Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ (Firestore) â€” Ø®ÙÙŠÙØ© ÙˆØ¨Ø³ÙŠØ·Ø©
  try {
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
    const { getFirestore, collection, getDocs, query, where, Timestamp } =
      await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
    const { getAuth, onAuthStateChanged } =
      await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');

    const mod = await import('./js/firebase-config.js'); // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯
    const app = initializeApp(mod.firebaseConfig);
    const db  = getFirestore(app);
    const auth= getAuth(app);

    onAuthStateChanged(auth, async (user)=>{
      if (!user) return;

      const now = new Date();
      const startToday = new Date(now); startToday.setHours(0,0,0,0);
      const tsToday = Timestamp.fromDate(startToday);
      const ts30    = Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), now.getDate()-30));

      // 1) Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ… (dailyMilk Ø«Ù… events ÙƒÙ€ fallback)
      let milkLiters=0, milkEntries=0;
      try{
        const q1 = query(collection(db,'dailyMilk'), where('userId','==',user.uid), where('createdAt','>=', tsToday));
        (await getDocs(q1)).forEach(doc=>{ const d=doc.data(); const n=parseFloat(d.amount||d.liters||0)||0; milkLiters+=n; milkEntries++; });
      }catch{}
      if (milkEntries===0){
        const q2 = query(collection(db,'events'), where('userId','==',user.uid), where('createdAt','>=', tsToday));
        (await getDocs(q2)).forEach(doc=>{ const d=doc.data(); const t=(d.type||'')+(d.eventType||''); if(/Ù„Ø¨Ù†|milk/i.test(t)){ const n=parseFloat(d.amount||d.liters||0)||0; milkLiters+=n; milkEntries++; }});
      }
      document.getElementById('chipMilk').textContent = fmt(milkLiters);

      // 2) ØªÙ„Ù‚ÙŠØ­Ø§Øª + 3) ÙˆÙ„Ø§Ø¯Ø§Øª (30 ÙŠÙˆÙ…) â€” Ù‚Ø·ÙŠØ¹ ÙƒÙ„Ù‡
      let ins=0, cal=0;
      const q3 = query(collection(db,'events'), where('userId','==',user.uid), where('createdAt','>=', ts30));
      (await getDocs(q3)).forEach(doc=>{
        const t = ((doc.data().type||'') + ' ' + (doc.data().eventType||'')).toLowerCase();
        if (t.includes('ØªÙ„Ù‚ÙŠØ­') || t.includes('insemin')) ins++;
        else if (t.includes('ÙˆÙ„Ø§Ø¯') || t.includes('calv')) cal++;
      });
      document.getElementById('chipIns').textContent  = fmt(ins);
      document.getElementById('chipCalv').textContent = fmt(cal);

      // 4) ØµØ§ÙÙŠ Ø§Ù„ÙŠÙˆÙ… = (Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ù„Ø¨Ù†) â€“ (ØªÙƒÙ„ÙØ© Ø¹Ù„Ù Ø§Ù„Ù‚Ø·ÙŠØ¹)
      const price = parseFloat(localStorage.getItem('econPrice')||'0')||0; // Ø³Ø¹Ø± Ø§Ù„Ù„ØªØ±
      const feedC = parseFloat(localStorage.getItem('econFeed') ||'0')||0; // ØªÙƒÙ„ÙØ©/Ø¨Ù‚Ø±Ø©/ÙŠÙˆÙ…
      const herd  = parseInt  (localStorage.getItem('econHerd') ||'0')||0; // Ø­Ø¬Ù… Ø§Ù„Ù‚Ø·ÙŠØ¹
      const revenue = price * milkLiters;
      const feed    = feedC * herd;
      const net     = revenue - feed;
      document.getElementById('chipNet').textContent = (revenue||feed) ? fmt(net) : 'â€”';
    });
  } catch(e) {
    // Ù„Ùˆ Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø²ØŒ Ù†Ø³ÙŠØ¨ Ø§Ù„Ø´Ø±Ø·Ø§Øª â€” Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø§ ØªØªØ¹Ø·Ù„
    console.warn('Smartbar KPIs disabled:', e);
  }
</script>
</body>
</html>
