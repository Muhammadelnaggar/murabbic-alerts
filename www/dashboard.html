<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة التحكم - مربيك</title>
  <style>
    :root{--bg:#fff9db;--card:#ffffff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:var(--green)}

    /* الشبكة */
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}

    /* الكروت */
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)
    }

    /* البلاطات (قلب مربيك) */
    .tile{
      background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
      padding:16px;text-align:center;font-weight:bold;cursor:pointer;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;min-height:118px;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease
    }
    .tile .icon{
      display:block;width:44px;height:44px;line-height:44px;border-radius:50%;
      border:1px solid var(--border);font-size:24px
    }
    .tile small{font-weight:normal;color:#335c33}
    .tile:hover{background:#dcedc8;transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.08)}

    /* ويدجت الطقس (نسخة مضغوطة) */
    #weatherCard{display:none;align-items:center;gap:10px;padding:10px 12px}
    #weatherCard.compact .wvals{display:flex;gap:6px;flex-wrap:wrap}
    #weatherCard.compact #weatherBadge{
      display:inline-flex;align-items:center;gap:8px;border-radius:999px;border:1px solid var(--border);
      padding:6px 10px;background:var(--muted);font-size:14px
    }
    #wLoc{font-weight:bold}
    #weatherCard.compact .wval{
      background:#f7fff4;border:1px solid var(--border);border-radius:10px;
      padding:6px 8px;min-width:72px;text-align:center;font-size:13px
    }
    .btn{appearance:none;border:1px solid var(--green);background:#fff;color:var(--green);
      border-radius:10px;padding:6px 10px;font-weight:bold;cursor:pointer;font-size:12px}
    .btn:hover{background:#f4fff1}

    @media(max-width:560px){
      .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
      .tile{min-height:110px;padding:14px}
    }
  </style>
</head>
<body>
  <h1>📊 لوحة التحكم - مربيك</h1>

  <!-- الطقس و THI (مضغوط) -->
  <div id="weatherCard" class="card" aria-label="الطقس و مؤشر الحرارة-الرطوبة">
    <div id="weatherBadge">
      <span>🌦️</span>
      <span id="wLoc">—</span>
    </div>
    <div class="wvals" style="flex:1">
      <div class="wval"><div>الحرارة</div><b id="wTemp">—°C</b></div>
      <div class="wval"><div>الرطوبة</div><b id="wHum">—%</b></div>
      <div class="wval"><div>THI</div><b id="wTHI">—</b></div>
      <div class="wval"><div>الحالة</div><b id="wState">—</b></div>
    </div>
    <button id="wRefresh" class="btn">تحديث</button>
  </div>

  <!-- روابط سريعة -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">➕</span>تسجيل حيوان جديد</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">📋</span>قائمة الحيوانات</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">🗓️</span>تسجيل الأحداث</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">🔔</span>ارشيف التنبيهات الذكية</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">🆔</span>البطاقة الذكية</div>

    <div class="tile" id="milkTraitsCard" role="button" tabindex="0">
      <span class="icon">🥛</span>
      التقييم البصري لصفات إنتاج اللبن
      <small>بالكاميرا (ضرع/جانبي/خلفي)</small>
    </div>

    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">📊</span>تقارير اللبن</div>
    <div class="tile" onclick="location.href='farm-economy.html'"><span class="icon">💰</span>اقتصاد المزرعة</div>

    <!-- ⛔ تمت إزالة بلاطة تقييم الحيوانات (evaluation.html) بناءً على طلبك -->

    <div class="tile" onclick="location.href='nutrition.html'"><span class="icon">🌿</span>تركيبة التغذية</div>
    <div class="tile" onclick="location.href='smart-feeding.html'"><span class="icon">🧠</span>التغذية الذكية</div>

    <!-- تقييم التغذية بالحالة الجسميّة (BCS) -->
    <div class="tile" id="bcsNutritionCard" role="button" tabindex="0">
      <span class="icon">🧍</span>
      التقييم الذكي للتغذية (قياس الحالة الجسميّة بالكاميرا)
      <small>BCS → توصيات تغذية</small>
    </div>

    <!-- تقييم الروث بالكاميرا -->
    <div class="tile" id="fecesEvalCard" role="button" tabindex="0">
      <span class="icon">💩</span>
      التقييم الذكي للتغذية (بتقييم الروث بالكاميرا)
      <small>Feces score → توصيات</small>
    </div>
  </div>

<script>
// ويدجت الطقس — نسخة مستقلة لا تعتمد على Firebase
(function(){
  const chip   = document.getElementById('weatherCard');
  const wLoc   = document.getElementById('wLoc');
  const wTemp  = document.getElementById('wTemp');
  const wHum   = document.getElementById('wHum');
  const wTHI   = document.getElementById('wTHI');
  const wState = document.getElementById('wState');
  const wRefresh = document.getElementById('wRefresh');

  // أظهر الويدجت فورًا بشكل مضغوط
  chip.style.display='flex';
  chip.classList.add('compact');

  // إعداد المنطقة الافتراضية
  let key = localStorage.getItem('userRegionKey');
  if(!key){
    const c = localStorage.getItem('userCountry');
    const r = localStorage.getItem('userRegion');
    key = (c && r) ? `${c}:${r}` : 'مصر:القاهرة';
    localStorage.setItem('userRegionKey', key);
  }
  wLoc.textContent = key;

  const GEO = {
    'مصر:القاهرة': {lat:30.0444, lon:31.2357},
    'مصر:الجيزة':  {lat:30.0131, lon:31.2089},
    'مصر:الإسكندرية': {lat:31.2001, lon:29.9187},
    'السعودية:الرياض': {lat:24.7136, lon:46.6753},
    'السعودية:مكة المكرمة': {lat:21.3891, lon:39.8579},
    'الإمارات:دبي': {lat:25.2048, lon:55.2708},
    'قطر:الدوحة': {lat:25.2854, lon:51.5310},
    'الكويت:العاصمة': {lat:29.3759, lon:47.9774},
    'البحرين:العاصمة': {lat:26.2235, lon:50.5876},
    'عُمان:مسقط': {lat:23.5880, lon:58.3829}
  };

  function THI(c, rh){ const f=c*9/5+32; return Math.round(((f - (0.55 - 0.0055*rh)*(f - 58)))*10)/10; }
  function thiColor(thi){
    if (thi < 68) return {bg:'#c8e6c9', txt:'مريح'};
    if (thi < 72) return {bg:'#fff9c4', txt:'توتر خفيف'};
    if (thi < 79) return {bg:'#ffe0b2', txt:'توتر متوسط'};
    if (thi < 84) return {bg:'#ffccbc', txt:'توتر شديد'};
    return {bg:'#ffcdd2', txt:'توتر شديد جدًا'};
  }
  function saveCache(key, data){ localStorage.setItem('weather:'+key, JSON.stringify({...data, ts:Date.now()})); }
  function loadCache(key){ try{ const o=JSON.parse(localStorage.getItem('weather:'+key)||'null'); return o && (Date.now()-o.ts)<3600000 ? o : null; }catch{return null;} }
  async function fetchWeather(lat, lon){
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=Africa%2FCairo`;
      const r = await fetch(url); const j = await r.json();
      return { t: j.current?.temperature_2m, h: j.current?.relative_humidity_2m };
    }catch(e){ return null; }
  }

  async function renderWeather(force=false){
    let data = !force && loadCache(key);
    if(!data){
      const coords = GEO[key];
      if(!coords){ return; }
      data = await fetchWeather(coords.lat, coords.lon);
      if(data && data.t!=null && data.h!=null) saveCache(key, data);
    }
    if(!data){ return; }

    const thi = THI(data.t, data.h);
    const {bg, txt} = thiColor(thi);
    chip.style.background = bg;
    wTemp.textContent = `${Math.round(data.t)}°C`;
    wHum.textContent  = `${Math.round(data.h)}%`;
    wTHI.textContent  = thi;
    wState.textContent= txt;
  }

  window.renderWeather = renderWeather; // إتاحة الوظيفة للزر
  document.addEventListener('DOMContentLoaded', ()=> renderWeather());
  wRefresh.addEventListener('click', ()=> renderWeather(true));
})();
</script>

<script type="module">
  const veBtn = document.getElementById('milkTraitsCard');
  veBtn?.addEventListener('click', () => {
    const qs  = new URLSearchParams(location.search);
    const id  = qs.get('animalId')
               || localStorage.getItem('currentAnimalId')
               || localStorage.getItem('lastAnimalId')
               || '';
    const url = id ? `visual-eval.html?focus=milk&animalId=${encodeURIComponent(id)}` : `visual-eval.html?focus=milk`;
    location.href = url;
  });
</script>

<script>
(function(){
  function todayCairo(){
    const now = new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'}));
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function buildQS(base){
    const qs = new URLSearchParams();
    const id     = localStorage.getItem('currentAnimalId')     || '';
    const number = localStorage.getItem('currentAnimalNumber') || '';
    const date   = localStorage.getItem('currentEventDate')    || todayCairo();

    if (id)     qs.set('animalId', id);
    if (number) qs.set('number', number);
    if (date)   qs.set('date', date);

    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      qs.set('demo','1');
    }
    return base + '?' + qs.toString();
  }

  // feces eval
  const feces = document.getElementById('fecesEvalCard');
  if(feces){
    const go = ()=> location.href = buildQS('feces-eval.html');
    feces.addEventListener('click', go);
    feces.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); go(); }});
  }

  // BCS → Nutrition
  const bcs = document.getElementById('bcsNutritionCard');
  if(bcs){
    const go = ()=> location.href = buildQS('bcs-eval.html'); // يفتح صفحة BCS لديك
    bcs.addEventListener('click', go);
    bcs.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); go(); }});
  }
})();
</script>

</body>
</html>
