<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø¤ÙƒÙ‘Ø¯Ø© -->
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1b5e20"/>

  <style>
    :root{--bg:#fff9db;--card:#fff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:#1b5e20}

    /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
    .brand{display:flex;align-items:center;justify-content:center;gap:10px}
    .brand-icon{height:28px;width:28px;object-fit:contain;display:none}
    .brand-icon-svg{height:28px;width:28px;display:inline-block;vertical-align:middle}

    /* ÙƒØ±ÙˆØª Ø¹Ø§Ù…Ø© */
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}

    /* ====== Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… (ÙƒÙ„Ø§Ø³ÙŠÙƒ) ====== */
    #weatherClassic{background:#ffe3e8;border:1.5px solid #ffccd5;border-radius:16px;padding:12px}
    #weatherClassic .bar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    #weatherClassic .seg{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    #weatherClassic .seg.active{background:#2e7d32;color:#fff}
    #weatherClassic .btn{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:8px;padding:4px 10px;font-size:12px;cursor:pointer}
    #weatherClassic .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    #weatherClassic .pill{background:#f7fff4;border:1px solid #c5e1a5;border-radius:12px;padding:8px;text-align:center}
    #weatherClassic .pill b{display:block;margin-top:4px}
    #weatherClassic .right{grid-row:1 / span 3;grid-column:2;display:flex;align-items:center;justify-content:center}

    /* Ø³Ø§Ø¹Ø© THI */
    .thi-clock{position:relative;width:160px;height:160px}
    .thi-clock .dial{position:absolute;inset:0;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .thi-clock .arc{position:absolute;inset:0;border-radius:50%;
      -webkit-mask:radial-gradient(farthest-side,transparent 55%, #000 56%);
              mask:radial-gradient(farthest-side,transparent 55%, #000 56%)}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;
      background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);
      -webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);
              mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .needle{position:absolute;left:50%;top:50%;width:2px;height:42%;background:#000;transform-origin:bottom center;
      transform:translate(-50%,-100%) rotate(var(--angle,-120deg));border-radius:2px;transition:transform .9s cubic-bezier(.22,.8,.2,1)}
    .thi-clock .needle::after{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:inherit}
    .thi-clock .center{position:absolute;left:50%;top:50%;width:8px;height:8px;border-radius:50%;background:#000;transform:translate(-50%,-50%)}

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª */
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .tile{position:relative;background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
      padding:16px;text-align:center;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;
      align-items:center;justify-content:center;gap:6px;min-height:118px}
    .tile .icon{display:block;width:44px;height:44px;line-height:44px;border-radius:50%;border:1px solid var(--border);font-size:24px;margin-bottom:6px}
    .tile .badge{position:absolute;top:8px;left:8px;background:#f7fff4;border:1px solid var(--border);color:#335c33;border-radius:999px;padding:2px 8px;font-size:11px}

    /* Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ (herd-gauges) */
    .gauge{width:100%;aspect-ratio:2/1;position:relative}
    .gauge svg{width:100%;height:100%;display:block}
    .gauge .val{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#065f46;font-size:22px}
    /* ===== KPIs Ø§Ù„Ø­Ù„Ù‚ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ===== */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:10px;
}
.kpi{
  display:flex;align-items:center;gap:10px;
  border:1px solid var(--border);border-radius:12px;background:#fff;
  padding:10px;min-height:72px
}
.kpi-ring{flex:0 0 auto}
.kpi-ring svg{width:60px;height:60px;display:block}
.kpi-ring circle.bg{fill:none;stroke:#e0e0e0;stroke-width:6}
.kpi-ring circle.fg{
  fill:none;stroke:#2e7d32;stroke-width:6;stroke-linecap:round;
  stroke-dasharray:113.097;stroke-dashoffset:113.097;
  transform:rotate(-90deg);transform-origin:22px 22px;
  transition:stroke-dashoffset .7s ease, stroke .3s ease
}
.kpi-body{display:flex;flex-direction:column;gap:2px}
.kpi-title{font-weight:800;color:#1b5e20;font-size:13px}
.kpi-value{font-weight:900;font-size:20px;color:#065f46;line-height:1}
.kpi-sub{font-size:11px;color:#4f5b62}
.kpi{ transition: transform .12s ease, box-shadow .12s ease }
.kpi:hover{ transform: translateY(-1px); box-shadow:0 2px 10px rgba(0,0,0,.06) }


    @media(max-width:560px){
      .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
      .tile{min-height:110px;padding:14px}
      .tile-m-full{grid-column:1 / -1}
    }
  </style>
</head>
<body>
  <h1 class="brand">
    <img id="brandImg" class="brand-icon" alt="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"/>
    <svg class="brand-icon-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Ù„ÙˆØ­Ø©">
      <path d="M6 38 L18 50 L40 18" fill="none" stroke="#1e88e5" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="28" y="46" width="30" height="6" rx="3" fill="#1e88e5"/>
      <rect x="30" y="30" width="6" height="16" rx="3" fill="#ef5350"/>
      <rect x="40" y="24" width="6" height="22" rx="3" fill="#fdd835"/>
      <rect x="50" y="16" width="6" height="30" rx="3" fill="#7cb342"/>
    </svg>
    Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ
  </h1>

  <!-- ================== Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… (ÙƒÙ…Ø§ ÙƒØ§Ù†) ================== -->
  <div id="weatherClassic" class="card" aria-label="Ø§Ù„Ø·Ù‚Ø³ Ùˆ Ù…Ø¤Ø´Ø± THI">
    <div class="bar">
      <button class="btn" id="wxRefresh" type="button">ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn" id="wxPin" type="button">Ø«Ø¨Ù‘Øª</button>
      <span style="margin-inline-start:auto;font-weight:bold;">Ø§Ù„Ù…ÙˆØ¶Ø¹</span>
      <button class="seg" id="segFarm" type="button">Ù…Ø²Ø±Ø¹ØªÙŠ</button>
      <button class="seg" id="segGPS" type="button">Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>

    <div class="grid">
      <div class="pill"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wxTemp">â€”Â°C</b></div>
      <div class="right">
        <div class="thi-clock">
          <div class="dial"><div id="thiArc" class="arc"></div></div>
          <div id="thiNeedle" class="needle"></div>
          <div class="center"></div>
        </div>
      </div>
      <div class="pill"><div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wxHum">â€”%</b></div>
      <div class="pill"><div>THI</div><b id="wxTHI">â€”</b></div>
      <div class="pill" style="grid-column:1 / span 2"><div>Ø§Ù„Ø­Ø§Ù„Ø©</div><b id="wxState">â€”</b></div>
    </div>
  </div>
  <!-- ============================================================= -->

  <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª / Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">ğŸ®</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>
    <div class="tile" id="groupsTile" role="button" tabindex="0"
     onclick="(window.dataLayer=window.dataLayer||[]).push({event:'tile_click',tile:'groups',page:'dashboard'}); location.href='groups.html'">
  <span class="icon">ğŸ‘¥</span>
  Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø±Ø¨ÙŠÙƒ
</div>

    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="tile" id="sensorsTile" role="button" tabindex="0">
      <span class="icon">ğŸ›°ï¸</span>
      Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª
      <span class="badge" id="sensorsStatus">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦</span>
    </div>
    <div class="tile" id="nutritionEvalTile" role="button" tabindex="0" onclick="location.href='nutrition-eval.html'">
      ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ©
    </div>
  </div>
<!-- Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ø¥Ù†ØªØ§Ø¬ÙŠ + ØªÙ†Ø§Ø³Ù„ÙŠ) -->
<div class="card" id="herdGauges" aria-label="Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù‚Ø·ÙŠØ¹" style="margin-top:12px">
  <div style="font-weight:800;color:#1b5e20;margin-bottom:10px;display:flex;align-items:center;gap:8px">
    ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ø¥Ù†ØªØ§Ø¬ÙŠ + ØªÙ†Ø§Ø³Ù„ÙŠ)
    <span id="g-date" style="margin-inline-start:auto;font-size:12px;border:1px solid #c5e1a5;border-radius:999px;padding:2px 8px;background:#fff">â€”</span>
  </div>

  <div class="kpi-grid">
    <!-- ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨ % -->
    <div class="kpi" data-key="inMilkPct" data-hint="Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹">
      <div class="kpi-ring" aria-hidden="true">
        <svg viewBox="0 0 44 44">
          <circle class="bg" cx="22" cy="22" r="18"></circle>
          <circle id="r-inmilk" class="fg" cx="22" cy="22" r="18"
                  stroke-dasharray="113.097" stroke-dashoffset="113.097"></circle>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨</div>
        <div class="kpi-value" id="v-inmilk">â€”%</div>
        <div class="kpi-sub">Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†</div>
      </div>
    </div>

    <!-- Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø± % -->
    <div class="kpi" data-key="pregRate" data-hint="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø± Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹">
      <div class="kpi-ring" aria-hidden="true">
        <svg viewBox="0 0 44 44">
          <circle class="bg" cx="22" cy="22" r="18"></circle>
          <circle id="r-preg" class="fg" cx="22" cy="22" r="18"
                  stroke-dasharray="113.097" stroke-dashoffset="113.097"></circle>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø±</div>
        <div class="kpi-value" id="v-preg">â€”%</div>
        <div class="kpi-sub">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹</div>
      </div>
    </div>

    <!-- Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© ÙƒÙ†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ø­Ù„Ø§Ø¨ -->
    <div class="kpi" data-key="freshShare" data-hint="Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø¶Ù…Ù† Ø§Ù„Ø­Ù„Ø§Ø¨">
      <div class="kpi-ring" aria-hidden="true">
        <svg viewBox="0 0 44 44">
          <circle class="bg" cx="22" cy="22" r="18"></circle>
          <circle id="r-fresh" class="fg" cx="22" cy="22" r="18"
                  stroke-dasharray="113.097" stroke-dashoffset="113.097"></circle>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</div>
        <div class="kpi-value" id="v-fresh">â€”%</div>
        <div class="kpi-sub">Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹ ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨</div>
      </div>
    </div>

    <!-- Ø¬Ø§Ù % -->
    <div class="kpi" data-key="dryShare" data-hint="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬Ø§Ù Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹">
      <div class="kpi-ring" aria-hidden="true">
        <svg viewBox="0 0 44 44">
          <circle class="bg" cx="22" cy="22" r="18"></circle>
          <circle id="r-dry" class="fg" cx="22" cy="22" r="18"
                  stroke-dasharray="113.097" stroke-dashoffset="113.097"></circle>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">Ø¬Ø§Ù</div>
        <div class="kpi-value" id="v-dry">â€”%</div>
        <div class="kpi-sub">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹</div>
      </div>
    </div>

    <!-- Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ„Ù‚ÙŠØ­ 21ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ) -->
    <div class="kpi" data-key="serviceRate" data-hint="ØªÙ‚Ø¯ÙŠØ±ÙŠ/Ù‚Ø±ÙŠØ¨Ù‹Ø§">
      <div class="kpi-ring" aria-hidden="true">
        <svg viewBox="0 0 44 44">
          <circle class="bg" cx="22" cy="22" r="18"></circle>
          <circle id="r-service" class="fg" cx="22" cy="22" r="18"
                  stroke-dasharray="113.097" stroke-dashoffset="113.097"></circle>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ„Ù‚ÙŠØ­ 21ÙŠ</div>
        <div class="kpi-value" id="v-service">â€”%</div>
        <div class="kpi-sub">ÙŠÙØ³ØªÙƒÙ…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§</div>
      </div>
    </div>

    <!-- Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø®ØµØ§Ø¨ -->
    <div class="kpi" data-key="conceptionRate" data-hint="Ù‚Ø±ÙŠØ¨Ù‹Ø§">
      <div class="kpi-ring" aria-hidden="true">
        <svg viewBox="0 0 44 44">
          <circle class="bg" cx="22" cy="22" r="18"></circle>
          <circle id="r-conception" class="fg" cx="22" cy="22" r="18"
                  stroke-dasharray="113.097" stroke-dashoffset="113.097"></circle>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø®ØµØ§Ø¨</div>
        <div class="kpi-value" id="v-conception">â€”%</div>
        <div class="kpi-sub">ÙŠÙØ³ØªÙƒÙ…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§</div>
      </div>
    </div>
  </div>
</div>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ÙˆÙŠØ¯Ø¬Øª -->
<!-- Ø·Ù‚Ø³ Ø¨Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙÙ‚Ø· (Ù„Ø§ Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª) -->
<!-- Ø·Ù‚Ø³ Ø­Ø³Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¨Ù„Ø¯/Ù…Ù†Ø·Ù‚Ø©/Ù…Ø¯ÙŠÙ†Ø©) + Ø®ÙŠØ§Ø± GPS + ØªØ«Ø¨ÙŠØª Ù…Ø­Ù„ÙŠ -->
<script id="wx-reg">
(function(){
  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const box = document.getElementById('weatherClassic');
  const tEl = document.getElementById('wxTemp');
  const hEl = document.getElementById('wxHum');
  const thiEl = document.getElementById('wxTHI');
  const sEl = document.getElementById('wxState');
  const thiArc = document.getElementById('thiArc');
  const thiNeedle = document.getElementById('thiNeedle');
  const btnRefresh = document.getElementById('wxRefresh');
  const btnPin = document.getElementById('wxPin');
  const segFarm = document.getElementById('segFarm'); // Ù‡Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ ÙƒÙ€ "Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„"
  const segGPS  = document.getElementById('segGPS');

  if(!box||!tEl||!hEl||!thiEl||!sEl||!thiArc||!thiNeedle||!btnRefresh||!btnPin||!segFarm||!segGPS) return;

  const DEF = { lat:30.0444, lon:31.2357, place:'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©' };               // Ø§ÙØªØ±Ø§Ø¶ÙŠ
  const LS_PIN   = 'mbk_farm';                                              // ØªØ«Ø¨ÙŠØª ÙŠØ¯ÙˆÙŠ (GPS)
  const LS_WX    = 'mbk_wx_cache';                                          // ÙƒØ§Ø´ Ø·Ù‚Ø³
  const LS_REG   = 'mbk_reg_geo';                                           // ÙƒØ§Ø´ Ø¬ÙŠÙˆÙƒÙˆØ¯ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„

  let mode = 'reg';   // reg(Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„) | gps(Ù…ÙˆÙ‚Ø¹ÙŠ)
  let pinned = null;  // {lat,lon,place} Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù…Ù„ "Ø«Ø¨Ù‘Øª"

  // ===== THI Ùˆ Ø§Ù„Ø£Ù„ÙˆØ§Ù† =====
  function THI(c,rh){ const f=c*9/5+32; return Math.round(((f-(0.55-0.0055*rh)*(f-58)))*10)/10; }
  function bands(){ return {t1:66,t2:70,t3:77,t4:82}; }
  function colorAndText(thi,b){
    if(thi<b.t1) return {bg:'#c8e6c9',txt:'Ù…Ø±ÙŠØ­'};
    if(thi<b.t2) return {bg:'#fff9c4',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø®ÙÙŠÙ'};
    if(thi<b.t3) return {bg:'#ffe0b2',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ù…ØªÙˆØ³Ø·'};
    if(thi<b.t4) return {bg:'#ffccbc',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯'};
    return {bg:'#ffcdd2',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯ Ø¬Ø¯Ø§'};
  }
  function drawTHI(thi){
    thiArc.style.background =
      'conic-gradient(from -120deg,#90caf9 0% 25%,#fff59d 25% 50%,#ffcc80 50% 75%,#ef5350 75% 100%)';
    const ang=-120+((thi-50)/40)*240;
    thiNeedle.style.setProperty('--angle',ang+'deg');
    const {bg,txt}=colorAndText(thi,bands());
    box.style.background = bg; sEl.textContent = txt;
  }

  // ===== Helpers Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ =====
  const readJSON=(k)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch{ return null; } };
  const writeJSON=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };

  // ===== Ù…ØµØ¯Ø± "Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„": Ù…Ù† window.__TENANT__ =====
  function readTenantAddress(){
    const T = window.__TENANT__ || {};
    const country = T.country || T.countryCode || T.address?.country || T.profile?.country;
    const region  = T.region  || T.state  || T.governorate || T.address?.region || T.profile?.region;
    const city    = T.city    || T.town   || T.address?.city || T.profile?.city;
    return { country, region, city };
  }
  function regKey(addr){
    const parts = [addr.city, addr.region, addr.country].filter(Boolean).join('|').toLowerCase();
    return parts || 'default';
  }
  async function geocodeFromRegistration(){
    const addr = readTenantAddress();
    if(!addr.country && !addr.region && !addr.city) return null;

    const key = regKey(addr);
    const cached = readJSON(LS_REG);
    if(cached && cached.key===key && cached.lat && cached.lon) return cached;

    // Ù†Ø¨Ù†ÙŠ Ù†Øµ Ø¨Ø­Ø« Ù…Ø¹Ù‚ÙˆÙ„
    const q = encodeURIComponent([addr.city, addr.region, addr.country].filter(Boolean).join(', '));
    try{
      // Geocoding Ù…Ù† Open-Meteo (Ø¨Ø¯ÙˆÙ† Ù…ÙØ§ØªÙŠØ­)
      const ctl = AbortSignal.timeout ? { signal:AbortSignal.timeout(6000) } : {};
      const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1&language=ar`, ctl);
      const j = await r.json();
      const item = j?.results?.[0];
      if(item){
        const place = [item.name, item.admin1, item.country].filter(Boolean).join('ØŒ ');
        const res = { lat:item.latitude, lon:item.longitude, place, key };
        writeJSON(LS_REG, res);
        return res;
      }
    }catch(e){}
    return null;
  }

  // ===== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª =====
  function getPinned(){ return readJSON(LS_PIN); }
  function savePinned(lat,lon,place){ writeJSON(LS_PIN, {lat,lon,place:place||'Ù…Ø²Ø±Ø¹ØªÙŠ'}); }

  function getGPS(){
    return new Promise((resolve)=>{
      if(!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(
        p => resolve({ lat:p.coords.latitude, lon:p.coords.longitude, place:'Ù…ÙˆÙ‚Ø¹ÙŠ' }),
        _ => resolve(null),
        { enableHighAccuracy:true, timeout:5000 }
      );
    });
  }

  async function pickCoords(){
    // Ø£ÙˆÙ„ÙˆÙŠØ©: Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ù…Ù„ ØªØ«Ø¨ÙŠØª ÙŠØ¯ÙˆÙŠ
    if(pinned) return pinned;

    if(mode==='gps'){
      const g = await getGPS();
      if(g) return g;
    }

    // Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    const reg = await geocodeFromRegistration();
    if(reg) return reg;

    // Ø§ÙØªØ±Ø§Ø¶ÙŠ
    return DEF;
  }

  // ===== Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù‚Ø³ + ÙƒØ§Ø´ Ø¯Ù‚ÙŠÙ‚Ø© =====
  function wxGetCached(){
    const x = readJSON(LS_WX);
    if(x && Date.now()-x.ts < 60_000) return x.data;
    return null;
  }
  function wxSetCached(data){ writeJSON(LS_WX, {ts:Date.now(), data}); }

  async function fetchWeather(lat, lon){
    const cached = wxGetCached();
    if(cached && typeof cached.t==='number' && typeof cached.h==='number') return cached;
    try{
      const ctl = AbortSignal.timeout ? { signal:AbortSignal.timeout(6000) } : {};
      const r = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`,
        { cache:'no-store', ...ctl }
      );
      const j=await r.json();
      const data = { t:j.current?.temperature_2m, h:j.current?.relative_humidity_2m };
      if(typeof data.t==='number' && typeof data.h==='number') wxSetCached(data);
      return data;
    }catch{ return null; }
  }

  function activate(which){
    segFarm.classList.toggle('active', which==='reg');
    segGPS .classList.toggle('active', which==='gps');
  }

  async function render(){
    const c = await pickCoords();
    const data = await fetchWeather(c.lat, c.lon);
    if(!data || typeof data.t!=='number' || typeof data.h!=='number'){
      tEl.textContent='â€”Â°C'; hEl.textContent='â€”%'; thiEl.textContent='â€”'; sEl.textContent='â€”'; return;
    }
    const t=Math.round(data.t), h=Math.round(data.h), thi=THI(t,h);
    tEl.textContent=`${t}Â°C`; hEl.textContent=`${h}%`; thiEl.textContent=thi; drawTHI(thi);
  }

  async function boot(){
    pinned = getPinned() || null;       // Ù„Ùˆ ÙƒØ§Ù† ÙÙŠÙ‡ ØªØ«Ø¨ÙŠØª Ù‚Ø¯ÙŠÙ…
    mode = 'reg';                       // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    activate('reg');

    segFarm.addEventListener('click', ()=>{ mode='reg'; activate('reg'); render(); });
    segGPS .addEventListener('click', ()=>{ mode='gps'; activate('gps'); render(); });
    btnRefresh.addEventListener('click', render);

    btnPin.addEventListener('click', async ()=>{
      mode='gps';
      const g = await getGPS();
      if(g){ savePinned(g.lat, g.lon, g.place); pinned = g; }
      mode='reg'; activate('reg'); render();
      (window.dataLayer=window.dataLayer||[]).push({event:'farm_pin_local', source:'gps'});
    });

    render();
  }

  document.addEventListener('DOMContentLoaded', boot);
})();
</script>


  <!-- ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª -->
  <script>
    (function(){
      const tile=document.getElementById('sensorsTile');
      const badge=document.getElementById('sensorsStatus');
      function setBadge(txt,ok){ if(!badge) return; badge.textContent=txt; badge.style.background=ok?'#e8f5e9':'#fff8e1'; badge.style.borderColor=ok?'#c5e1a5':'#ffecb3'; }
      async function ping(){
        try{
          setBadge('Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦',false);
          const r=await fetch('/api/sensors/health');
          if(!r.ok){ setBadge('ØºÙŠØ± Ù…ØªØµÙ„',false); return; }
          const j=await r.json();
          const n=Number(j?.devices||0);
          setBadge(`Ù…ØªØµÙ„ â€¢ ${n}`,true);
        }catch{ setBadge('ØºÙŠØ± Ù…ØªØµÙ„',false); }
      }
      tile?.addEventListener('click',()=>{ location.href='sensor-test.html'; });
      document.addEventListener('DOMContentLoaded',()=>{ ping(); setInterval(ping,60000); });
    })();
  </script>
  <!-- Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ -->
<script src="/js/tenant-bootstrap.js"></script>
<script type="module" src="/js/app-core.js"></script>
<script>
  (function(){
    const t = document.getElementById('groupsTile');
    if(!t) return;
    t.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        t.click();
      }
    });
  })();
</script>

<script type="module" id="herd-gauges-fs">
import { db } from '/js/firebase-config.js';
import { collection, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const $ = s => document.querySelector(s);

// ---------- Helpers ----------
  const norm = s => String(s||'')
    
  .toLowerCase()
  .replace(/[\u0610-\u061a\u064b-\u065f\u0670\u06d6-\u06ed]/g,'')
  .trim();

const toDate = v => {
  if(!v) return null;
  if(typeof v==='string') return new Date(v);
  if(v instanceof Date) return v;
  if(typeof v==='object' && typeof v.seconds==='number') return new Date(v.seconds*1000);
  return null;
};
  const isInMilk = an => {
  if (isDry(an)) return false;                    // Ø§Ù„Ø¬Ø§Ù Ù„ÙŠØ³ ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨
  if (an.inMilk === true) return true;            // Ø¹Ù„Ù… ØµØ±ÙŠØ­
  const st = norm(
    an.productionStatus ||
    an.lactationStatus ||
    an.status ||
    an['Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„Ù„Ø¨Ù†ÙŠØ©'] || ''
  );
  // ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù„Ù„Ø­Ù„Ø§Ø¨
  return /(Ø­Ù„Ø§Ø¨|ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨|Ù…Ø­Ù„Ø¨|Ù…Ù†ØªØ¬|Ø­Ù„ÙŠØ¨|milk|milking|lact)/.test(st);
};

const daysBetween = (a,b)=> Math.floor((a-b)/86400000);
const getDIM = an => {
  const calv = toDate(an.calvingDate || an.lastCalvingDate || an.calvedAt || an['ØªØ§Ø±ÙŠØ®_Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©']);
  return calv ? Math.max(0, daysBetween(new Date(), calv)) : 0;
};
const isDry = an => {
  const st = norm(
    an.productionStatus ||      // â† Ù…Ù‡Ù…: "Ø¬Ø§Ù" Ø¹Ù†Ø¯Ùƒ Ù‡Ù†Ø§
    an.lactationStatus ||
    an.status ||
    an['Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„Ù„Ø¨Ù†ÙŠØ©'] ||
    an['Ø­Ø§Ù„Ø©_Ø§Ù„Ø¥Ù†ØªØ§Ø¬'] ||
    ''
  );
  const dryBool = an.dry === true || an.isDry === true || an.dryCow === true || an['Ø¬Ø§Ù'] === true;
  return dryBool || an.inMilk === false || /(dry|dryoff|dry-off|Ø¬Ø§Ù|Ø¬Ø§ÙÙ‡|Ø¬Ø§ÙØ©)/.test(st);
};


const isPreg = an => {
  const rs = String(an.reproductiveStatus || an.pregStatus || an['Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©'] || '').toLowerCase();
  return an.pregnant===true || rs.includes('preg') || rs.includes('Ø¹Ø´Ø§Ø±');
};
const isFresh = an => {
  const d = getDIM(an);
  const lactNo = Number(an.lactationNumber ?? an.lactNo ?? an.lactNum ?? an['Ø±Ù‚Ù…_Ø§Ù„Ø­Ù„Ø§Ø¨'] ?? 0);
  return d>=1 && d<=45 && !isDry(an) && lactNo>0;
};



function calc(animals){
  const total = animals.length;
  let inMilk=0, fresh=0, dry=0, preg=0, open=0, sumDimOpen=0;

  for(const an of animals){
    const dryF  = isDry(an);
    const milkF = isInMilk(an);

    if (milkF){ inMilk++; if(isFresh(an)) fresh++; }
    if (dryF){ dry++; }

    if (isPreg(an)) preg++;
    else if (milkF){ open++; sumDimOpen += getDIM(an); }
  }

  const inMilkPct = total? Math.round(inMilk/total*100) : 0;
  const pregRate  = total? Math.round(preg/total*100)  : 0;
  const freshShare= inMilk? Math.round(fresh/inMilk*100) : 0;
  const dryShare  = total? Math.round(dry/total*100)   : 0;
  const openDim   = open? Math.round(sumDimOpen/open)  : 0;
  return { total, inMilk, inMilkPct, preg, pregRate, fresh, freshShare, dry, dryShare, open, openDim };
}


// Ø§Ø­Ø°Ù arcPath(...) Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©

// Ù…Ø­ÙŠØ· Ø§Ù„Ø­Ù„Ù‚Ø© Ù„ÙÙ€ r=18 => 2Ï€r â‰ˆ 113.097
const RING_LEN = 113.097;

// Ù„ÙˆÙ† Ø¯Ù„Ø§Ù„ÙŠ Ø¨Ø³ÙŠØ· (ØªÙ‚Ø¯ÙŠØ±ÙŠ) Ø­Ø³Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø©
function colorFor(key, pct){
  // Ø­Ø¯ÙˆØ¯ Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© Ø¹Ø§Ù…Ø©
  if(key==='dryShare'){ // Ø§Ù„Ø£Ù‚Ù„ Ø£ÙØ¶Ù„ Ø¹Ø§Ø¯Ø©
    if(pct <= 18) return '#2e7d32';
    if(pct <= 25) return '#fdd835';
    return '#ef6c00';
  }
  // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„
  if(pct >= 80) return '#2e7d32';
  if(pct >= 60) return '#7cb342';
  if(pct >= 40) return '#fdd835';
  if(pct >= 20) return '#ef6c00';
  return '#c2185b';
}

function setRing(idSuffix, pct, key){
  const el = document.getElementById('r-'+idSuffix);
  if(!el) return;
  const p = Math.max(0, Math.min(100, Number(pct)||0));
  const off = RING_LEN * (1 - p/100); // Ø£ØµØºØ± offset = ØªØ¹Ø¨Ø¦Ø© Ø£ÙƒØ¨Ø±
  el.setAttribute('stroke-dashoffset', off.toFixed(2));
  el.style.stroke = colorFor(key || idSuffix, p);
}

function renderGauges(k){
  // Ø§Ù„ØªØ§Ø±ÙŠØ®
  const d = document.getElementById('g-date');
  if(d) d.textContent = new Date().toISOString().slice(0,10);

  // ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨
  setRing('inmilk', k.inMilkPct, 'inMilkPct');
  const vIn = document.getElementById('v-inmilk');
  if(vIn) vIn.textContent = k.inMilkPct + '%';

  // Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø±
  setRing('preg', k.pregRate, 'pregRate');
  const vPr = document.getElementById('v-preg');
  if(vPr) vPr.textContent = k.pregRate + '%';

  // Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© (Ù…Ù† Ø§Ù„Ø­Ù„Ø§Ø¨)
  setRing('fresh', k.freshShare, 'freshShare');
  const vFr = document.getElementById('v-fresh');
  if(vFr) vFr.textContent = k.freshShare + '%';

  // Ø¬Ø§Ù %
  setRing('dry', k.dryShare, 'dryShare');
  const vDr = document.getElementById('v-dry');
  if(vDr) vDr.textContent = k.dryShare + '%';

  // Ù…Ø³ØªÙ‚Ø¨Ù„Ù‹Ø§ (ØµÙØ± Ø§Ù„Ø¢Ù†)
  setRing('service', 0, 'serviceRate');
  const vSr = document.getElementById('v-service');
  if(vSr) vSr.textContent = 'â€”%';

  setRing('conception', 0, 'conceptionRate');
  const vCo = document.getElementById('v-conception');
  if(vCo) vCo.textContent = 'â€”%';
}


function dedupe(list){
  const map = new Map();
  for(const an of list){
    const key = an.animalNumber ?? an.number ?? an.id ?? an.uid ?? an.tag;
    if(!map.has(key)) map.set(key, an);
  }
  return [...map.values()];
}

(function startLive(){
  const userId = window.__TENANT__?.userId || localStorage.getItem('userId');
  if(!userId){ console.warn('MBK KPIs: Ù„Ø§ ÙŠÙˆØ¬Ø¯ userId'); return; }

  // âœ… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØµÙÙˆÙØªÙŠÙ† Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
  let aSub = [], bSub = [];

  // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© (fallback) Ù…ØªØ§Ø­Ø© Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§
  const paintDemoOnError = ()=> renderGauges({ inMilkPct:70, pregRate:70, freshShare:14, dryShare:30 });

  // Ø¹Ø¯Ù‘Ø§Ø¯ ÙˆØµÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ¹Ù„ÙŠ
  let updates = 0;

  const recompute = ()=>{
    const animals = dedupe([...aSub, ...bSub]);
    const k = calc(animals);
    updates++;
    renderGauges(k);
    (window.dataLayer=window.dataLayer||[]).push({event:'kpi_render', inMilkPct:k.inMilkPct, pregRate:k.pregRate});
    try{ localStorage.setItem('animals_cache', JSON.stringify(animals)); }catch{}
  };


  try{
    const col = collection(db, 'users', userId, 'animals');
  onSnapshot(col, snap=>{ aSub = snap.docs.map(d=> ({ id:d.id, ...d.data() })); recompute(); },
  err=> { console.warn('users/{uid}/animals snapshot error', err); paintDemoOnError(); });
  }catch(e){ console.warn('users/{uid}/animals not available', e); }

  try{
    const q = query(collection(db, 'animals'), where('userId','==', userId));
  onSnapshot(q, snap=>{ bSub = snap.docs.map(d=> ({ id:d.id, ...d.data() })); recompute(); },
  err=> { console.warn('animals where userId==uid snapshot error', err); paintDemoOnError(); });
  }catch(e){ console.warn('animals top-level query not available', e); }
    // âœ… Ù„Ùˆ Ù…ÙÙŠØ´ Ø¯Ø§ØªØ§ Ø®Ù„Ø§Ù„ 1200ms: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ù‚ÙŠÙ… ØªÙˆØ¶ÙŠØ­ÙŠØ©
  setTimeout(()=>{
    if (updates === 0) {
      try{
        const cached = JSON.parse(localStorage.getItem('animals_cache') || '[]');
        if (cached.length){ renderGauges(calc(cached)); return; }
      }catch{}
      paintDemoOnError();
    }
  }, 1200);

})();
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.kpi').forEach(el => {
      el.title = el.dataset.hint || '';
    });
  });
</script>

</body>
</html>












