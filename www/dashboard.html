<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>
  <style>
    :root{--bg:#fff9db;--card:#ffffff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:var(--green)}

    /* Ø§Ù„Ø´Ø¨ÙƒØ© */
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}

    /* Ø§Ù„ÙƒØ±ÙˆØª */
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)
    }

    /* Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª (Ù‚Ù„Ø¨ Ù…Ø±Ø¨ÙŠÙƒ) */
    .tile{
      background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
      padding:16px;text-align:center;font-weight:bold;cursor:pointer;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;min-height:118px;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease
    }
    .tile .icon{
      display:block;width:44px;height:44px;line-height:44px;border-radius:50%;
      border:1px solid var(--border);font-size:24px
    }
    .tile small{font-weight:normal;color:#335c33}
    .tile:hover{background:#dcedc8;transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.08)}

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø±ÙƒÙ‘Ø¨Ø© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ© */
    .tile .icon.icon-layer{position:relative;display:inline-flex;align-items:center;justify-content:center}
    .icon-layer .i-main{font-size:24px;line-height:1}
    .icon-layer .i-badge{position:absolute;bottom:-4px;right:-4px;font-size:14px;background:#fff;border:1px solid var(--border);border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,.08)}

    /* ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ (Ù†Ø³Ø®Ø© Ù…Ø¶ØºÙˆØ·Ø©) */
    #weatherCard{display:none;gap:12px;padding:10px 12px;display:grid;grid-template-columns:clamp(110px,34vw,160px) 1fr;align-items:center}
    #weatherCard.compact .wvals{display:grid;grid-template-columns:1fr;gap:8px}
    /* ØªØ®Ø·ÙŠØ· Ø§Ù„Ø³Ø§Ø¹Ø© ÙŠØ³Ø§Ø±ØŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠÙ…ÙŠÙ† Ù…ØªÙƒØ¯Ø³Ø© */
    #weatherCard .thi-clock{grid-column:1;grid-row:1 / span 3;justify-self:center}
    #weatherCard #weatherBadge{grid-column:2;grid-row:1}
    #weatherCard #wRefresh{grid-column:2;grid-row:1;justify-self:end;align-self:start}
    #weatherCard .wvals{grid-column:2;grid-row:3}
    #weatherCard .herd-toggle{grid-column:2;grid-row:4;justify-content:flex-start}
    #weatherCard .loc-toggle{grid-column:2;grid-row:2;justify-content:flex-start}
    .loc-toggle{display:flex;gap:6px;align-items:center}
    .loc-toggle .seg{appearance:none;border:1px solid var(--green);background:#fff;color:#2e7d32;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    .loc-toggle .seg.active{background:var(--green);color:#fff}
    #weatherCard.compact #weatherBadge{
      display:inline-flex;align-items:center;gap:8px;border-radius:999px;border:1px solid var(--border);
      padding:6px 10px;background:var(--muted);font-size:14px
    }
    #wLoc{font-weight:bold}
    #weatherCard.compact .wval{background:#f7fff4;border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:auto;width:100%;text-align:center;font-size:13px}
    .btn{appearance:none;border:1px solid var(--green);background:#fff;color:var(--green);
      border-radius:10px;padding:6px 10px;font-weight:bold;cursor:pointer;font-size:12px}
    .btn:hover{background:#f4fff1}

    /* Ù…Ø­ÙˆÙ‘Ù„ Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹ */
    .herd-toggle{display:flex;gap:6px;align-items:center}
    .herd-toggle .seg{appearance:none;border:1px solid var(--green);background:#fff;color:var(--green);border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    .herd-toggle .seg.active{background:var(--green);color:#fff}

    /* Ù…Ø¤Ø´Ø± THI Ø§Ù„ØµØºÙŠØ± */
    .thi-scale{min-width:160px;max-width:260px;display:flex;flex-direction:column;gap:4px}
    .thi-track{position:relative;height:8px;border-radius:999px;background:#e0e0e0;overflow:hidden}
    .thi-marker{position:absolute;top:50%;width:10px;height:10px;border:2px solid var(--green);background:#fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 0 2px rgba(255,255,255,.6)}
    .thi-labels{display:flex;justify-content:space-between;font-size:11px;color:#335c33;padding:0 2px}

    /* Tooltip THI */
    .thi-tooltip{position:absolute;top:-30px;transform:translateX(-50%);background:#1b5e20;color:#fff;font-size:11px;padding:4px 6px;border-radius:6px;white-space:nowrap;display:none}
    .thi-tooltip::after{content:'';position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);border-width:5px;border-style:solid;border-color:#1b5e20 transparent transparent transparent}

    /* Ù…Ø¤Ø´Ø± THI Ø§Ù„ØµØºÙŠØ± */
    .thi-scale{min-width:160px;max-width:260px;display:flex;flex-direction:column;gap:4px}
    .thi-track{position:relative;height:8px;border-radius:999px;background:#e0e0e0;overflow:hidden}
    .thi-marker{position:absolute;top:50%;width:10px;height:10px;border:2px solid var(--green);background:#fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 0 2px rgba(255,255,255,.6)}
    .thi-labels{display:flex;justify-content:space-between;font-size:11px;color:#335c33;padding:0 2px}

    /* Tooltip THI */
    .thi-tooltip{position:absolute;top:-30px;transform:translateX(-50%);background:#1b5e20;color:#fff;font-size:11px;padding:4px 6px;border-radius:6px;white-space:nowrap;display:none}
    .thi-tooltip::after{content:'';position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);border-width:5px;border-style:solid;border-color:#1b5e20 transparent transparent transparent}

    /* Ø¨Ù„Ø§Ø·Ø© ÙƒØ¨ÙŠØ±Ø© + Ø£Ø²Ø±Ø§Ø± ÙØ±Ø¹ÙŠØ© */
    .tile-lg{min-height:140px}
    .tile-2x{grid-column:span 2}
    @media(max-width:560px){.tile-2x{grid-column:span 1}}
    .subactions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px}
    .subbtn{appearance:none;border:2px solid var(--green);background:#fff;color:var(--green);border-radius:999px;padding:12px 16px;font-size:16px;font-weight:700;cursor:pointer;min-width:160px}
    .subbtn:hover{background:#f4fff1}

    @media(max-width:560px){
      .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
      .tile{min-height:110px;padding:14px}
      .tile-m-full{grid-column:1 / -1}
    }
  /* Ø¹Ø¯Ù‘Ø§Ø¯ THI Ø¨Ø´ÙƒÙ„ Ø³Ø§Ø¹Ø© */
    .thi-clock{position:relative;width:clamp(110px,34vw,160px);height:clamp(110px,34vw,160px);margin:4px 6px}
    .thi-clock .dial{position:absolute;inset:0;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .thi-clock .arc{position:absolute;inset:0;border-radius:50%;-webkit-mask:radial-gradient(farthest-side, transparent 55%, #000 56%);mask:radial-gradient(farthest-side, transparent 55%, #000 56%)}
    .thi-clock .needle{position:absolute;left:50%;top:50%;width:2px;height:42%;background:#000;transform-origin:bottom center;transform:translate(-50%,-100%) rotate(var(--angle,-120deg));border-radius:2px;transition:transform .9s cubic-bezier(.22,.8,.2,1);will-change:transform}
    
    .thi-clock .center{position:absolute;left:50%;top:50%;width:8px;height:8px;border-radius:50%;background:#000;transform:translate(-50%,-50%)}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);-webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);-webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);-webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .needle::after{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:inherit}
    

    @media(max-width:560px){#weatherCard{grid-template-columns:clamp(110px,40vw,170px) 1fr;align-items:center}.herd-toggle{justify-content:flex-start}}
  
  
  @media (prefers-reduced-motion: reduce){ .thi-clock .needle{ transition:none } }
  </style>
</head>
<body>
  <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</h1>

  <!-- Ø§Ù„Ø·Ù‚Ø³ Ùˆ THI (Ù…Ø¶ØºÙˆØ·) -->
  <div id="weatherCard" class="card" aria-label="Ø§Ù„Ø·Ù‚Ø³ Ùˆ Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø±Ø§Ø±Ø©-Ø§Ù„Ø±Ø·ÙˆØ¨Ø©">
    <div id="weatherBadge">
      <span>ğŸŒ¦ï¸</span>
      <span id="wLoc">â€”</span>
    </div>
    $1
    <div class="loc-toggle" role="group" aria-label="Ù…ØµØ¯Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹">
      <button class="seg" id="modeFarm" type="button">Ù…Ø²Ø±Ø¹ØªÙŠ</button>
      <button class="seg" id="modeGPS" type="button">Ù…ÙˆÙ‚Ø¹ÙŠ</button>
      <button class="btn" id="setFarmBtn" type="button" title="ØªØ¹ÙŠÙŠÙ† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©">ØªØ¹ÙŠÙŠÙ†</button>
    </div>
    <div class="wvals" style="flex:1">
      <div class="wval"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wTemp">â€”Â°C</b></div>
      <div class="wval"><div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wHum">â€”%</b></div>
      <div class="wval"><div>THI</div><b id="wTHI">â€”</b></div>
      <div class="wval"><div>Ø§Ù„Ø­Ø§Ù„Ø©</div><b id="wState">â€”</b></div>
    </div>
    <div class="herd-toggle" role="group" aria-label="Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹">
      <button class="seg" id="herdCow" type="button">Ø£Ø¨Ù‚Ø§Ø±</button>
      <button class="seg active" id="herdBuffalo" type="button">Ø¬Ø§Ù…ÙˆØ³</button>
    </div>
    <div class="thi-clock" aria-label="Ù…Ø¤Ø´Ø± THI">
      <div class="dial" id="thiDial"><div class="arc" id="thiArc"></div></div>
      <div class="needle" id="thiNeedle"></div>
      <div class="center"></div>
      <div class="thi-tooltip" id="thiTip" style="display:none"></div>
    </div>
  </div>

  <!-- Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon icon-layer"><span class="i-main">ğŸ®</span><span class="i-badge">ğŸ’³</span></span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>

    <div class="tile" id="milkTraitsCard" role="button" tabindex="0">
      <span class="icon">ğŸ„</span>
      Ø³Ù…Ø§Øª Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ù„Ø¨Ù† /ÙƒØ§Ù…ÙŠØ±Ø§
    </div>

    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="tile" onclick="location.href='farm-economy.html'"><span class="icon">ğŸ’°</span>Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ù…Ø²Ø±Ø¹Ù‡</div>

    <!-- â›” ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø¨Ù„Ø§Ø·Ø© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª (evaluation.html) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ -->

    <!-- ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ© Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ù…ÙŠÙ‘Ø© (BCS) -->
    <div class="tile tile-lg tile-2x tile-m-full" id="smartNutritionTile" role="group" tabindex="0">
      <span class="icon">ğŸ§ </span>
      ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ
      
      <div class="subactions" aria-label="Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…">
        <button class="subbtn" id="goFeces">Ø§Ù„Ø±ÙˆØ« Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="subbtn" id="goBCS">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ù…ÙŠÙ‘Ø© Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="subbtn" id="goRation">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù„ÙŠÙ‚Ø©</button>
      </div>
    </div>

    <!-- ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø±ÙˆØ« Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    
  </div>

<script>
// ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø·Ù‚Ø³ â€” Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ù…Ø¹ Ù…Ø­ÙˆÙ‘Ù„ Ø£Ø¨Ù‚Ø§Ø±/Ø¬Ø§Ù…ÙˆØ³
(function(){
  const chip   = document.getElementById('weatherCard');
  const wLoc   = document.getElementById('wLoc');
  const wTemp  = document.getElementById('wTemp');
  const wHum   = document.getElementById('wHum');
  const wTHI   = document.getElementById('wTHI');
  const wState = document.getElementById('wState');
  const wRefresh = document.getElementById('wRefresh');
  const thiTrack = document.querySelector('.thi-track');
  const thiMarker = document.getElementById('thiMarker');
  const thiTip = document.getElementById('thiTip');
  const thiDial = document.getElementById('thiDial');
  const thiArc = document.getElementById('thiArc');
  const thiNeedle = document.getElementById('thiNeedle');
  const thiCenter = document.querySelector('.thi-clock .center');
  const thiL1 = document.getElementById('thiL1');
  const thiL2 = document.getElementById('thiL2');
  const thiL3 = document.getElementById('thiL3');
  const thiL4 = document.getElementById('thiL4');
  const herdCow = document.getElementById('herdCow');
  const herdBuffalo = document.getElementById('herdBuffalo');
  // Ø¹Ù†Ø§ØµØ± ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
  const modeFarm = document.getElementById('modeFarm');
  const modeGPS = document.getElementById('modeGPS');
  const setFarmBtn = document.getElementById('setFarmBtn');
  let tipTimer = null;
  function showTip(){ if(!thiTip) return; thiTip.style.display='block'; clearTimeout(tipTimer); tipTimer=setTimeout(()=>{ thiTip.style.display='none'; }, 1800);} 
  function hideTip(){ if(!thiTip) return; thiTip.style.display='none'; }

  // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆÙŠØ¯Ø¬Øª ÙÙˆØ±Ù‹Ø§
  chip.style.display='grid';
  chip.classList.add('compact');

  // Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„Ù€ GPS ØªÙ„Ù‚Ø§Ø¦ÙŠ
  wLoc.textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹â€¦';

  // Ù…Ø­ÙˆÙ‘Ù„ Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø·ÙŠØ¹
  function getProfile(){ return (localStorage.getItem('herdProfile') === 'cow') ? 'cow' : 'buffalo'; }
  function setProfile(p){ localStorage.setItem('herdProfile', p); }
  function syncToggle(){
    const p = getProfile();
    herdCow?.classList.toggle('active', p==='cow');
    herdBuffalo?.classList.toggle('active', p==='buffalo');
  }

  // ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø²Ø±Ø¹ØªÙŠ / Ù…ÙˆÙ‚Ø¹ÙŠ)
  function getLocMode(){
    const saved = localStorage.getItem('locMode');
    if (saved==='gps' || saved==='farm') return saved;
    return localStorage.getItem('farmCoords') ? 'farm' : 'gps';
  }
  function setLocMode(m){ localStorage.setItem('locMode', m); syncLocMode(); }
  function syncLocMode(){
    const m = getLocMode();
    modeFarm?.classList.toggle('active', m==='farm');
    modeGPS?.classList.toggle('active', m==='gps');
  }
  function getFarmCoords(){ try{ const o = JSON.parse(localStorage.getItem('farmCoords')||'null'); return o && o.lat!=null && o.lon!=null ? o : null; }catch{ return null; }}
  async function setFarm(coords, name){ localStorage.setItem('farmCoords', JSON.stringify({lat:coords.lat, lon:coords.lon, name:name||''})); setLocMode('farm'); }

  const GEO = {
    'Ù…ØµØ±:Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©': {lat:30.0444, lon:31.2357},
    'Ù…ØµØ±:Ø§Ù„Ø¬ÙŠØ²Ø©':  {lat:30.0131, lon:31.2089},
    'Ù…ØµØ±:Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©': {lat:31.2001, lon:29.9187},
    'Ù…ØµØ±:Ø§Ù„Ø´Ø±Ù‚ÙŠØ©': {lat:30.587, lon:31.502}, // Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ© (Ø²Ù‚Ø§Ø²ÙŠÙ‚ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§)
    'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©:Ø§Ù„Ø±ÙŠØ§Ø¶': {lat:24.7136, lon:46.6753},
    'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©:Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©': {lat:21.3891, lon:39.8579},
    'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª:Ø¯Ø¨ÙŠ': {lat:25.2048, lon:55.2708},
    'Ù‚Ø·Ø±:Ø§Ù„Ø¯ÙˆØ­Ø©': {lat:25.2854, lon:51.5310},
    'Ø§Ù„ÙƒÙˆÙŠØª:Ø§Ù„Ø¹Ø§ØµÙ…Ø©': {lat:29.3759, lon:47.9774},
    'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†:Ø§Ù„Ø¹Ø§ØµÙ…Ø©': {lat:26.2235, lon:50.5876},
    'Ø¹ÙÙ…Ø§Ù†:Ù…Ø³Ù‚Ø·': {lat:23.5880, lon:58.3829}
  };

  function THI(c, rh){
    const f = c*9/5 + 32;
    return Math.round(((f - (0.55 - 0.0055*rh)*(f - 58)))*10)/10;
  }

  function bands(){
    return getProfile()==='cow' ? {t1:68,t2:72,t3:79,t4:84} : {t1:66,t2:70,t3:77,t4:82};
  }
  function colorAndText(thi, b){
    let txt;
    if (thi < b.t1) txt='Ù…Ø±ÙŠØ­';
    else if (thi < b.t2) txt='Ø§Ø¬Ù‡Ø§Ø¯ Ø®ÙÙŠÙ';
    else if (thi < b.t3) txt='Ø§Ø¬Ù‡Ø§Ø¯ Ù…ØªÙˆØ³Ø·';
    else if (thi < b.t4) txt='Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯';
    else txt='Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯ Ø¬Ø¯Ø§';

    let bg;
    if (thi < b.t1) bg='#c8e6c9';
    else if (thi < b.t2) bg='#fff9c4';
    else if (thi < b.t3) bg='#ffe0b2';
    else if (thi < b.t4) bg='#ffccbc';
    else bg='#ffcdd2';
    return {bg, txt};
  }

  function saveCache(key, data){ localStorage.setItem('weather:'+key, JSON.stringify({...data, ts:Date.now()})); }
  function loadCache(key){ try{ const o=JSON.parse(localStorage.getItem('weather:'+key)||'null'); return o && (Date.now()-o.ts)<3600000 ? o : null;}catch{ return null; } }

  async function fetchWeather(lat, lon){
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`;
      const r = await fetch(url); const j = await r.json();
      return { t: j.current?.temperature_2m, h: j.current?.relative_humidity_2m };
    }catch{ return null; }
  }

  async function renderWeather(force=false){
    try{
      const coords = await getCoords(force);
      if(!coords){ chip.style.display='grid'; return; }
      const cacheKey = `${getLocMode()==='farm'?'farm':'gps'}:${coords.lat.toFixed(2)},${coords.lon.toFixed(2)}`;
      let data = !force && loadCache(cacheKey);
      if(!data){
        data = await fetchWeather(coords.lat, coords.lon);
        if(data && data.t!=null && data.h!=null) saveCache(cacheKey, data);
      }
      if(!data){ return; }

      const place = coords.label || await reverseGeocode(coords.lat, coords.lon);
      wLoc.textContent = (getLocMode()==='farm') ? (place ? `Ù…Ø²Ø±Ø¹ØªÙƒ: ${place}` : 'Ù…Ø²Ø±Ø¹ØªÙƒ') : (place || 'Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ');

      const b = bands();
      const thi = THI(data.t, data.h);
      const {bg, txt} = colorAndText(thi, b);

      if (thiArc){
        const minTHI=50, maxTHI=90;
        const pct = v => ((v - minTHI) * 100 / (maxTHI - minTHI));
        const arcSpanPct = 240/360*100; // Ø«Ù„Ø«Ø§ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ§Ù†
        const pArc = v => (pct(v)/100) * arcSpanPct;
        const p1 = pArc(b.t1), p2 = pArc(b.t2), p3 = pArc(b.t3);
        thiArc.style.background = `conic-gradient(from -120deg, #90caf9 0% ${p1}%, #fff59d ${p1}% ${p2}%, #ffcc80 ${p2}% ${p3}%, #ef5350 ${p3}% ${arcSpanPct}%, transparent ${arcSpanPct}% 100%)`;
      }
      if (thiNeedle){
        const minTHI=50, maxTHI=90;
        const pct = v => ((v - minTHI) * 100 / (maxTHI - minTHI));
        const p = Math.max(0, Math.min(100, pct(thi)));
        const angle = -120 + (p * 2.4); // 0â†’100% Ø¹Ø¨Ø± 240Â°
        thiNeedle.style.setProperty('--angle', angle + 'deg');
      }

      chip.style.background = bg;
      wTemp.textContent = `${Math.round(data.t)}Â°C`;
      wHum.textContent  = `${Math.round(data.h)}%`;
      wTHI.textContent  = thi;
      wState.textContent= txt;
    }catch(e){}
  }

  async function readGPS(force=false){
    try{
      const saved = JSON.parse(localStorage.getItem('lastGPS')||'null');
      if(saved && !force && (Date.now()-saved.ts) < 10*60*1000) return {lat:saved.lat, lon:saved.lon};
    }catch{}
    if (navigator.geolocation){
      try{
        const pos = await new Promise(res=>navigator.geolocation.getCurrentPosition(p=>res(p), _=>res(null), {maximumAge:600000, timeout:6000}));
        if(pos){
          const c={lat:pos.coords.latitude, lon:pos.coords.longitude};
          localStorage.setItem('lastGPS', JSON.stringify({...c, ts: Date.now()}));
          return c;
        }
      }catch{}
    }
    return null;
  }

  async function getCoords(force=false){
    const mode = getLocMode();
    if(mode==='farm'){
      const f = getFarmCoords();
      if (f) return {lat:f.lat, lon:f.lon, label:f.name||''};
      // Ù„Ùˆ ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© Ù†Ø±Ø¬Ø¹ Ù„Ù„Ù€GPS
      const g = await readGPS(force);
      if (g) return g;
      return GEO['Ù…ØµØ±:Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©'];
    } else {
      const g = await readGPS(force);
      if (g) return g;
      const f = getFarmCoords();
      if (f) return {lat:f.lat, lon:f.lon, label:f.name||''};
      return GEO['Ù…ØµØ±:Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©'];
    }
  }

  async function reverseGeocode(lat, lon){
    try{
      const u = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=ar`;
      const r = await fetch(u); const j = await r.json();
      const g = j?.results?.[0];
      if(g){
        const parts = [g.country, g.admin1, g.name].filter(Boolean);
        return parts.join('ØŒ ');
      }
    }catch{}
    return 'Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ';
  }

  // Ø£Ø­Ø¯Ø§Ø«
  window.renderWeather = renderWeather; // Ù„Ù„Ø²Ø± ØªØ­Ø¯ÙŠØ«
  document.addEventListener('DOMContentLoaded', ()=> { syncToggle(); syncLocMode(); renderWeather(); });
  wRefresh.addEventListener('click', ()=> { renderWeather(true); showTip(); });
  modeFarm?.addEventListener('click', ()=>{ setLocMode('farm'); renderWeather(true); });
  modeGPS?.addEventListener('click', ()=>{ setLocMode('gps'); renderWeather(true); });
  setFarmBtn?.addEventListener('click', async ()=>{
    let coords = null;
    const useCurrent = confirm('ØªØ¹ÙŠÙŠÙ† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ Ø§Ø¶ØºØ· Ø¥Ù„ØºØ§Ø¡ Ù„ØªØ­Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§ (lat,lon).');
    if (useCurrent){ coords = await readGPS(true); }
    if (!coords){
      const text = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨ØµÙŠØºØ© lat,lon (Ù…Ø«Ø§Ù„: 30.59,31.50)');
      if (text){
        const parts = text.split(',').map(s=>parseFloat(s.trim()));
        if (parts.length===2 && !isNaN(parts[0]) && !isNaN(parts[1])) coords = {lat:parts[0], lon:parts[1]};
      }
    }
    if (coords){
      const name = await reverseGeocode(coords.lat, coords.lon);
      await setFarm(coords, name);
      renderWeather(true);
    }
  });
  herdCow?.addEventListener('click', ()=>{ setProfile('cow'); syncToggle(); renderWeather(true); });
  herdBuffalo?.addEventListener('click', ()=>{ setProfile('buffalo'); syncToggle(); renderWeather(true); });
  if (thiMarker){ thiMarker.addEventListener('mouseenter', showTip); thiMarker.addEventListener('mouseleave', hideTip); thiMarker.addEventListener('touchstart', (e)=>{ e.preventDefault(); showTip(); }, {passive:false}); }
})();
</script>

<script type="module">
  const veBtn = document.getElementById('milkTraitsCard');
  veBtn?.addEventListener('click', () => {
    const qs  = new URLSearchParams(location.search);
    const id  = qs.get('animalId')
               || localStorage.getItem('currentAnimalId')
               || localStorage.getItem('lastAnimalId')
               || '';
    const url = id ? `visual-eval.html?focus=milk&animalId=${encodeURIComponent(id)}` : `visual-eval.html?focus=milk`;
    location.href = url;
  });
</script>

<script>
(function(){
  function todayCairo(){
    const now = new Date(new Date().toLocaleString('en-US',{timeZone:'Africa/Cairo'}));
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function buildQS(base){
    const qs = new URLSearchParams();
    const id     = localStorage.getItem('currentAnimalId')     || '';
    const number = localStorage.getItem('currentAnimalNumber') || '';
    const date   = localStorage.getItem('currentEventDate')    || todayCairo();

    if (id)     qs.set('animalId', id);
    if (number) qs.set('number', number);
    if (date)   qs.set('date', date);

    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      qs.set('demo','1');
    }
    return base + '?' + qs.toString();
  }

  // Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø¨Ù„Ø§Ø·Ø© "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ"
  const fecesBtn  = document.getElementById('goFeces');
  if(fecesBtn){
    const go = ()=> location.href = buildQS('feces-eval.html');
    fecesBtn.addEventListener('click', go);
  }
  const bcsBtn    = document.getElementById('goBCS');
  if(bcsBtn){
    const go = ()=> location.href = buildQS('bcs-eval.html');
    bcsBtn.addEventListener('click', go);
  }
  const rationBtn = document.getElementById('goRation');
  if(rationBtn){
    const go = ()=> location.href = 'smart-feeding.html';
    rationBtn.addEventListener('click', go);
  }
})();
</script>

</body>
</html>
