<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>

  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <link rel="stylesheet" href="/css/forms.css">

  <style>
  :root{
  --bg:#f7faf7;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e2e8f0;
  --brand:#0ea05a;
  --brand-600:#0b7f47;
}

    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:10px;
      background:var(--bg);
      font-family:Arial,Helvetica,sans-serif;
      color:var(--text);
      direction:rtl;
    }
    h1{
      margin:8px 0 10px;
      text-align:center;
      color:var(--green);
      font-size:24px;
      font-weight:800;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:8px;
      margin-bottom:8px;
      box-shadow:0 1px 4px rgba(0,0,0,.04);
    }
    #thiBar{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-size:12px;
      background:#e8f5e9;
    }
    #thiBar strong{color:#1b5e20;}
    #thiStatus{font-weight:bold;}
    .thi-mini{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      font-size:11px;
    }
    .thi-circle{
      width:40px;height:40px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:bold;font-size:13px;
      border:2px solid #c5e1a5;
      background:#fff;
    }
    .tiles{
      display:grid;
      grid-template-columns:repeat(3,minmax(90px,1fr));
      gap:6px;
      margin-bottom:8px;
    }
    .tile{
      background:#eafbe7;
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px 2px;
      text-align:center;
      font-size:10px;
      cursor:pointer;
    }
    .section-title{
      font-weight:800;
      font-size:13px;
      margin:4px 2px 4px;
      color:#1b5e20;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
    }
    .kpi{
      background:#ffffff;
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px;
      font-size:9px;
      display:flex;
      flex-direction:column;
      gap:1px;
      min-height:40px;
    }
    .kpi-label{font-weight:700;color:#1b5e20;}
    .kpi-value{font-size:15px;font-weight:800;color:#066b3b;}
    .kpi-sub{font-size:8px;color:#607d8b;}
    #statusBar{
      margin-top:4px;
      font-size:9px;
      text-align:center;
      color:#388e3c;
    }
    .mini-gauge {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      margin: 4px auto;
      background: conic-gradient(#2e7d32 0deg, #e0e0e0 0deg);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:bold;
      color:#2e7d32;
    }
    body{ margin:0; padding:0; background:var(--bg); color:var(--text); font-family:'Cairo',Tahoma,Arial,sans-serif; }

.mbk-top{
  position: sticky; top:0; z-index:50;
  background:#fff;
  border-bottom:1px solid var(--border);
}
.mbk-head{
  max-width:980px;
  margin:0 auto;
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.mbk-title{ line-height:1.1; }
.mbk-page{ font-size:18px; font-weight:900; color:var(--text); }
.mbk-app{ font-size:13px; font-weight:900; color:var(--brand-600); opacity:.9; }
.mbk-logo{ height:46px; width:auto; object-fit:contain; opacity:.95; }

.page{
  max-width:980px;
  margin:10px auto 16px;
  padding:0 10px;
  padding-bottom:100px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… */
}
/* ===== Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¹Ø§Ø¦Ù… ===== */
.logout-floating{
  position:fixed;
  bottom:18px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:420px;
  background:#ffffff;
  border:1px solid #e2e8f0;
  border-radius:14px;
  box-shadow:0 8px 22px rgba(0,0,0,.08);
  padding:6px;
  z-index:999;
}

.logout-floating button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #fb8c00;
  background:#ffb74d;
  color:#5d2a00;
  font-weight:900;
  font-size:15px;
  cursor:pointer;
  transition:.15s ease;
}

.logout-floating button:hover{
  background:#ffa726;
  border-color:#ffa726;
}
  </style>
</head>
<body>

<script>
  window.API_BASE = "https://murabbic-alerts.onrender.com";
</script>

<header class="mbk-top">
  <div class="mbk-head">
    <div class="mbk-title">
      <div class="mbk-page">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <div class="mbk-app">Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ</div>
    </div>
    <img class="mbk-logo" src="/images/logo.png" alt="Ù…ÙØ±ÙØ¨Ù‘ÙÙŠÙƒ">
  </div>
</header>
<div class="page">
<!-- Ø´Ø±ÙŠØ· THI Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© -->
<div id="thiBar" class="card">
  <div>
    Ø§Ù„Ø­Ø±Ø§Ø±Ø©: <strong id="wxTemp">--</strong>Â°C |
    Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: <strong id="wxHum">--</strong>% |
    THI: <strong id="wxTHI">--</strong>
  </div>
  <div class="thi-mini">
    <div class="thi-circle" id="thiCircle">--</div>
    <div>Ø§Ù„Ø­Ø§Ù„Ø©: <span id="thiStatus">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±...</span></div>
  </div>
</div>

<!-- Ø§Ø®ØªØµØ§Ø±Ø§Øª -->
<div class="tiles">
  <div class="tile" onclick="location.href='add-animal.html'">â• Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
  <div class="tile" onclick="location.href='animal-list.html'">ğŸ“‹ Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
  <div class="tile" onclick="location.href='add-event.html'">ğŸ—“ï¸ Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
  <div class="tile" onclick="location.href='alerts.html'">ğŸ”” Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
  <div class="tile" onclick="location.href='cow-card.html'">ğŸ® Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>
  <div class="tile" onclick="location.href='groups.html'">ğŸ‘¥ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø±Ø¨ÙŠÙƒ</div>
  <div class="tile" onclick="location.href='milk-reports.html'">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
  <div class="tile" onclick="location.href='sensor-test.html'">ğŸ›°ï¸ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª</div>
  <div class="tile" onclick="location.href='nutrition-eval.html'">ğŸ¥— ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ©</div>
</div>

<!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ -->
<div class="card">
  <div class="section-title">ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ (ØªÙ†Ø§Ø³Ù„ÙŠ + Ø¥Ù†ØªØ§Ø¬ÙŠ)</div>
  <div id="kpiGrid" class="kpi-grid"></div>
  <div id="statusBar">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹...</div>
</div>
<script src="/js/tenant-bootstrap.js"></script>
<script type="module" src="/js/api.js"></script>
<script type="module" src="/js/app-core.js"></script>
  <script src="/js/smart-checks.js"></script>
  <script src="/js/alerts-ui.js"></script>
  <script type="module" src="/js/repro-auto.js"></script>



<script>
// ============ API BASE ============
const API_BASE = "https://murabbic-alerts.onrender.com";

// ============ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ============
function getTenantId() {
  try {
    const T = window.__TENANT__ || {};
    const fromObj = T.userId || T.uid || T.id || T.tenantId;
    const fromStorage =
      localStorage.getItem('userId') ||
      localStorage.getItem('uid') ||
      localStorage.getItem('tenantId');
    return fromObj || fromStorage || null;
  } catch (e) {
    return null;
  }
}

async function waitForTenant(maxMs = 2000) {
  const start = Date.now();
  while (Date.now() - start < maxMs) {
    const id = getTenantId();
    if (id) return id;
    await new Promise(r => setTimeout(r, 150));
  }
  return getTenantId();
}

async function fetchJSON(path){
  let uid = getTenantId();
  if (!uid && location.hostname !== 'localhost') {
    uid = await waitForTenant();
  }
  if (!uid) uid = 'demo-user';

  const headers = { 'Cache-Control':'no-store' };
  if (uid) headers['X-User-Id'] = uid;

  const res = await fetch(API_BASE + path, { headers, cache:'no-store' });
  if (!res.ok) throw new Error(path + ' ' + res.status);
  return res.json();
}

// ============ THI ============
async function loadWeatherTHI(){
  const tEl = document.getElementById('wxTemp');
  const hEl = document.getElementById('wxHum');
  const thiEl = document.getElementById('wxTHI');
  const statusEl = document.getElementById('thiStatus');
  const circle = document.getElementById('thiCircle');

  try{
    const lat = 30.0444, lon = 31.2357; // Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©
    const r = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`,
      { cache:'no-store' }
    );
    const j = await r.json();
    const t = Math.round(j.current.temperature_2m);
    const h = Math.round(j.current.relative_humidity_2m);
    const thi = Math.round(((t*9/5+32) - (0.55-0.0055*h)*((t*9/5+32)-58)));

    tEl.textContent = t;
    hEl.textContent = h;
    thiEl.textContent = thi;
    circle.textContent = thi;

    let txt, bg, color;
    if (thi < 68){ txt='Ø±Ø§Ø­Ø©'; bg='#c8e6c9'; color='#2e7d32'; }
    else if (thi < 72){ txt='Ø¥Ø¬Ù‡Ø§Ø¯ Ø®ÙÙŠÙ'; bg='#fff9c4'; color='#f9a825'; }
    else if (thi < 78){ txt='Ø¥Ø¬Ù‡Ø§Ø¯ Ù…ØªÙˆØ³Ø·'; bg='#ffe0b2'; color='#fb8c00'; }
    else { txt='Ø¥Ø¬Ù‡Ø§Ø¯ Ø¹Ø§Ù„ÙŠ'; bg='#ffcdd2'; color='#e53935'; }

    statusEl.textContent = txt;
    statusEl.style.color = color;
    circle.style.background = bg;
    circle.style.borderColor = color;
    circle.style.color = color;
  }catch(e){
    statusEl.textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹';
    statusEl.style.color = '#e53935';
  }
}

// ============ Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ============
function norm(s){
  return String(s||'').toLowerCase()
    .replace(/[\u0610-\u061a\u064b-\u065f\u0670\u06d6-\u06ed]/g,'')
    .trim();
}

function toDate(v){
  if(!v) return null;
  if(typeof v === 'number') return new Date(v);
  const s = String(v);
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00');
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

function daysBetween(a,b){
  return Math.floor((a - b) / 86400000);
}

function isActive(an){
  const st = norm(an.status || an.lifeStatus || '');
  if (['sold','dead','died','archived','inactive','Ù…Ø¨Ø§Ø¹','Ù…Ø¨Ø§Ø¹Ø©','Ù†Ø§ÙÙ‚','Ù…ÙŠØª'].includes(st)) return false;
  if (an.active === false) return false;
  return true;
}

function isInMilk(an){
  if (an.inMilk === true) return true;
  if (an.inMilk === false) return false;
  const st = norm(an.productionStatus || an.lactationStatus || '');
  if (st.includes('dry') || st.includes('Ø¬Ø§Ù')) return false;
  return /(milk|lact|Ø­Ù„Ø§Ø¨|Ù…Ø­Ù„Ø¨|Ù…Ù†ØªØ¬)/.test(st);
}

function getDIM(an){
  const calv = toDate(an.lastCalvingDate || an.calvingDate);
  if(!calv) return 0;
  return Math.max(0, daysBetween(new Date(), calv));
}

function box(label, value, sub='', gaugeId=null){
  const gaugeHTML = gaugeId
    ? `<div id="${gaugeId}" class="mini-gauge"></div>`
    : '';
  return `
    <div class="kpi">
      <div class="kpi-label">${label}</div>
      <div class="kpi-value">${value ?? '--'}</div>
      ${gaugeHTML}
      ${sub ? `<div class="kpi-sub">${sub}</div>` : ''}
    </div>
  `;
}

// ============ ØªØ­Ù…ÙŠÙ„ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ ============
async function loadHerdKPIs(){
  const statusBar = document.getElementById('statusBar');
  const grid = document.getElementById('kpiGrid');

  try{
    const [statsResp, animalsResp] = await Promise.all([
      fetchJSON(`/api/herd-stats`),
      fetchJSON(`/api/animals`)
    ]);

    const animalsArr =
      Array.isArray(animalsResp) ? animalsResp :
      Array.isArray(animalsResp?.items) ? animalsResp.items :
      Array.isArray(animalsResp?.data) ? animalsResp.data :
      Array.isArray(animalsResp?.animals) ? animalsResp.animals : [];

    const animals = animalsArr.filter(isActive);
    const total = animals.length;

    let inMilk = 0,
        dimSum = 0,
        milkTotal = 0,
        milkCount = 0;

    // Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø®ØµÙˆØ¨Ø© Ù…Ù† ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
    let pregCount = 0;                // Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø±
    let abortCount = 0;               // Ø¹Ø¯Ø¯ Ù…Ù† Ù„Ø¯ÙŠÙ‡Ù… Ø¥Ø¬Ù‡Ø§Ø¶ Ù…Ø³Ø¬Ù‘Ù„
    let servicesSum = 0;              // Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Ù„Ù„Ø­Ø§Ù…Ù„ÙŠÙ† ÙÙ‚Ø·)
    let servicesNForSPC = 0;          // Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ SPC
    let openDaysSum = 0;              // Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©
    let openDaysN = 0;                // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨Ù‚Ø§Ø± Ø§Ù„ØªÙŠ Ø­Ø³Ø¨Ù†Ø§ Ù„Ù‡Ø§ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©

    for (const an of animals){
      // ÙÙŠ Ø§Ù„Ø­Ù„ÙŠØ¨ + DIM + Ø§Ù„Ù„Ø¨Ù†
      if (isInMilk(an)){
        inMilk++;
        dimSum += getDIM(an);
      }
      const m = Number(an.dailyMilk || an.lastMilkKg || 0);
      if (m > 0){
        milkTotal += m;
        milkCount++;
      }

      // Ø­Ø§Ù„Ø© ØªÙ†Ø§Ø³Ù„ÙŠØ©
      const rep   = norm(an.reproductiveStatus || an.reproStatus || '');
      const diagR = norm(an.lastDiagnosisResult || '');
      const isPreg =
        rep.includes('Ø¹Ø´Ø§Ø±') ||
        diagR === 'Ø¹Ø´Ø§Ø±' ||
        rep.includes('pregnant');

      if (isPreg){
        pregCount++;

        // Ø®Ø¯Ù…Ø§Øª Ù„ÙƒÙ„ Ø­Ù…Ù„ (Ù…Ù† servicesCount ÙÙŠ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©)
        const services = Number(an.servicesCount || an.serviceCount || 0);
        if (services > 0){
          servicesSum += services;
          servicesNForSPC++;
        }

        // Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø© = Ù…Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø­ØªÙ‰ Ø§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ù…Ø®ØµØ¨
        const calv = toDate(an.lastCalvingDate || an.calvingDate);
        const ins  = toDate(an.lastInseminationDate || an.serviceDate);
        if (calv && ins){
          const d = daysBetween(ins, calv);
          if (d >= 0 && d < 400){ // ÙÙ„ØªØ± Ø£Ø±Ù‚Ø§Ù… Ø´Ø§Ø°Ø©
            openDaysSum += d;
            openDaysN++;
          }
        }
      }

      // Ø¥Ø¬Ù‡Ø§Ø¶
      if (an.lastAbortionDate || an.abortionDate){
        abortCount++;
      }
    }

    const inMilkPct = total ? Math.round(inMilk * 100 / total) : 0;
    const avgDIM    = inMilk ? Math.round(dimSum / inMilk) : 0;
    const avgMilk   = milkCount ? +(milkTotal / milkCount).toFixed(1) : 0;
    if (!milkTotal && avgMilk && inMilk) milkTotal = Math.round(avgMilk * inMilk);

    // Ø®ØµÙˆØ¨Ø© Ù…Ù† Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
    const pregPctDoc = total ? Math.round(pregCount * 100 / total) : 0;
    const servicesPerConceptionDoc =
      servicesNForSPC ? +(servicesSum / servicesNForSPC).toFixed(2) : 0;
    const conceptionRatePctDoc =
      servicesPerConceptionDoc ? Math.round(100 / servicesPerConceptionDoc) : 0;
    const openDaysAvgDoc =
      openDaysN ? Math.round(openDaysSum / openDaysN) : 0;
    const abortionRatePctDoc =
      (pregCount + abortCount)
        ? Math.round(abortCount * 100 / (pregCount + abortCount))
        : 0;

    const stats = statsResp || {};
    const t     = stats.totals    || {};
    const fert  = stats.fertility || {};

    const totalActive =
      t.totalActive != null ? t.totalActive : total;

    const pregPct =
      t?.pregnant?.pct != null ? t.pregnant.pct :
      (t.pregnantPct != null ? t.pregnantPct : pregPctDoc);

    const conceptionRatePct =
      fert.conceptionRatePct != null ? fert.conceptionRatePct : conceptionRatePctDoc;

    const openDaysAvg =
      stats.openDaysAvg != null ? stats.openDaysAvg : openDaysAvgDoc;

    const pregRate21d =
      stats.pregRate21d != null ? stats.pregRate21d : 0; // Ù‡Ù†ÙƒÙ…Ù‘Ù„Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ù† Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø´ÙŠØ§Ø¹

    const servicesPerConception =
      stats.servicesPerConception != null
        ? stats.servicesPerConception
        : servicesPerConceptionDoc;

    const abortionRatePct =
      stats.abortionRatePct != null ? stats.abortionRatePct : abortionRatePctDoc;

    // ØªØºØ°ÙŠØ© / Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ / â€¦ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (0 Ø§Ù„Ø¢Ù† Ù„Ùˆ Ù…Ø´ Ù…Ø­Ø³ÙˆØ¨Ø©)
    const cullProdPct   = stats.cullProdPct   ?? 0;
    const cullReproPct  = stats.cullReproPct  ?? 0;
    const cullHealthPct = stats.cullHealthPct ?? 0;
    const feedEfficiency= stats.feedEfficiency ?? 0;
    const dmiAvg        = stats.dmiAvg ?? 0;
    const iofc          = stats.iofc ?? 0;
    const fecesScore    = stats.fecesScore ?? 0;
    const bcsCamera     = stats.bcsCamera ?? 0;

    grid.innerHTML =
      box('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©', totalActive, 'Ù…Ø³ØªØ¨Ø¹Ø¯ Ù…Ù†Ù‡Ø§ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©/Ø§Ù„Ù†Ø§ÙÙ‚Ø©/Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©', 'g_active') +
      box('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø­Ù„ÙŠØ¨', `${inMilk} (${inMilkPct}%)`, 'Ù†Ø³Ø¨ØªÙ‡Ù… Ù…Ù† Ø§Ù„Ù‚Ø·ÙŠØ¹', 'g_inmilk') +
      box('Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø±', pregPct + '%', 'Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø´Ø·', 'g_preg') +
      box('Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø®ØµØ§Ø¨ %', conceptionRatePct + '%', 'Ù…Ø­Ø³ÙˆØ¨ Ù…Ù† S/C', 'g_fert') +
      box('Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©', openDaysAvg, 'Ù…Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ù„Ù„Ø­Ù…Ù„', 'g_openDays') +
      box('Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ù…Ù„ (21 ÙŠÙˆÙ…)', pregRate21d, '', 'g_pregRate') +
      box('Ø®Ø¯Ù…Ø§Øª Ù„ÙƒÙ„ Ø­Ù…Ù„ (S/C)', servicesPerConception, '', 'g_sc') +
      box('Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¶', abortionRatePct + '%', '', 'g_abort') +
      box('Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø§ÙÙ‚Ø©', stats.deadCalvingRatePct ?? 0 + '%', '', 'g_deadCalving') +
      box('Ø§Ù„Ø¹Ù…Ø± Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ÙˆÙ„Ø§Ø¯Ø©', stats.ageAtFirstCalvingMonths ?? 0, 'Ø¨Ø§Ù„Ø´Ù‡Ø±', 'g_afc') +
      box('Ù…ØªÙˆØ³Ø· Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†', avgMilk ?? 0, 'ÙƒØ¬Ù…/Ø¨Ù‚Ø±Ø©', 'g_avgMilk') +
      box('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ', milkTotal ?? 0, 'ÙƒØ¬Ù…', 'g_totalMilk') +
      box('Ù…ØªÙˆØ³Ø· DIM', avgDIM ?? 0, 'Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ø­Ù„ÙŠØ¨', 'g_dim') +
      box('Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø¨Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø­Ù„ÙŠØ¨', inMilkPct + '%', '', 'g_inmilkPct') +
      box('Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø¥Ù†ØªØ§Ø¬ÙŠ', cullProdPct + '%', '', 'g_cullProd') +
      box('Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØªÙ†Ø§Ø³Ù„ÙŠ', cullReproPct + '%', '', 'g_cullRepro') +
      box('Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØµØ­ÙŠ', cullHealthPct + '%', '', 'g_cullHealth') +
      box('ÙƒÙØ§Ø¡Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù„Ù', feedEfficiency, '', 'g_fe') +
      box('Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø§ÙØ© Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø©', dmiAvg, '', 'g_dmi') +
      box('ØµØ§ÙÙŠ Ø¯Ø®Ù„ Ø§Ù„Ù„Ø¨Ù† IOFC', iofc, 'Ø¬Ù†ÙŠÙ‡/Ø¨Ù‚Ø±Ø©/ÙŠÙˆÙ…', 'g_iofc') +
      box('ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø±ÙˆØ«', fecesScore, '', 'g_feces') +
      box('BCS Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', bcsCamera, '', 'g_bcs');

    // Ø§Ù„Ø¬ÙˆØ¬Ø²
    renderMiniGauge("g_active", totalActive ? 100 : 0);
    renderMiniGauge("g_inmilk", inMilkPct);
    renderMiniGauge("g_preg", pregPct);
    renderMiniGauge("g_fert", conceptionRatePct);
    renderMiniGauge("g_openDays", openDaysAvg);
    renderMiniGauge("g_pregRate", pregRate21d);
    renderMiniGauge("g_sc", servicesPerConception * 25); // ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¹Ø´Ø§Ù† Ø§Ù„Ù†Ø³Ø¨Ø© (1â€“4 Ø®Ø¯Ù…Ø§Øª)
    renderMiniGauge("g_abort", abortionRatePct);
    renderMiniGauge("g_deadCalving", stats.deadCalvingRatePct ?? 0);
    renderMiniGauge("g_afc", stats.ageAtFirstCalvingMonths ?? 0);
    renderMiniGauge("g_avgMilk", avgMilk ?? 0);
    renderMiniGauge("g_totalMilk", milkTotal ?? 0);
    renderMiniGauge("g_dim", avgDIM ?? 0);
    renderMiniGauge("g_inmilkPct", inMilkPct ?? 0);
    renderMiniGauge("g_cullProd", cullProdPct);
    renderMiniGauge("g_cullRepro", cullReproPct);
    renderMiniGauge("g_cullHealth", cullHealthPct);
    renderMiniGauge("g_fe", feedEfficiency);
    renderMiniGauge("g_dmi", dmiAvg);
    renderMiniGauge("g_iofc", iofc);
    renderMiniGauge("g_feces", fecesScore);
    renderMiniGauge("g_bcs", bcsCamera);

    statusBar.textContent = 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ.';
  }
  catch(e){
    console.error('herd stats error', e);
    document.getElementById('statusBar').textContent =
      'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
  }
}

// ============ mini-gauge ============
function renderMiniGauge(id, percent){
  const el = document.getElementById(id);
  if(!el) return;

  const val = Math.max(0, Math.min(100, percent));
  el.style.background =
    `conic-gradient(#2e7d32 ${val*3.6}deg, #e0e0e0 ${val*3.6}deg)`;
  el.style.color = '#2e7d32';
  el.textContent = val + '%';
}

// ============ ØªØ´ØºÙŠÙ„ ============


document.addEventListener('DOMContentLoaded', () => {
  loadWeatherTHI();
  loadHerdKPIs();
    try{
   window.smart?.startAlertsWatcher({
  userId: getTenantId(),
  onAlert: (p)=> window.mbk?.alertsUI?.show && window.mbk.alertsUI.show(p)
});}catch(e){}
});
import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js")
  .then(({ getAuth, signOut }) => {
    const btn = document.getElementById("logoutBtn");
    if(!btn) return;

    btn.addEventListener("click", async ()=>{
      const auth = getAuth();
      await signOut(auth);
      localStorage.clear();
      location.href="login.html";
    });
  });
  
</script>


</div>
  <div class="logout-floating">
  <button id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

</body>
</html>











