<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ</title>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø¤ÙƒÙ‘Ø¯Ø© -->
  <link rel="icon" type="image/svg+xml" href="/images/dashboard.svg">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1b5e20"/>

  <style>
    :root{--bg:#fff9db;--card:#fff;--muted:#dcedc8;--green:#2e7d32;--border:#c5e1a5}
    *{box-sizing:border-box}
    html,body{overflow-x:hidden}
    body{background:var(--bg);font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#1b5e20}
    h1{margin:0 0 16px;text-align:center;color:#1b5e20}

    /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
    .brand{display:flex;align-items:center;justify-content:center;gap:10px}
    .brand-icon{height:28px;width:28px;object-fit:contain;display:none}
    .brand-icon-svg{height:28px;width:28px;display:inline-block;vertical-align:middle}

    /* ÙƒØ±ÙˆØª Ø¹Ø§Ù…Ø© */
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}

    /* ====== Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… (ÙƒÙ„Ø§Ø³ÙŠÙƒ) ====== */
    #weatherClassic{background:#ffe3e8;border:1.5px solid #ffccd5;border-radius:16px;padding:12px}
    #weatherClassic .bar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    #weatherClassic .seg{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    #weatherClassic .seg.active{background:#2e7d32;color:#fff}
    #weatherClassic .btn{appearance:none;border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:8px;padding:4px 10px;font-size:12px;cursor:pointer}
    #weatherClassic .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    #weatherClassic .pill{background:#f7fff4;border:1px solid #c5e1a5;border-radius:12px;padding:8px;text-align:center}
    #weatherClassic .pill b{display:block;margin-top:4px}
    #weatherClassic .right{grid-row:1 / span 3;grid-column:2;display:flex;align-items:center;justify-content:center}

    /* Ø³Ø§Ø¹Ø© THI */
    .thi-clock{position:relative;width:160px;height:160px}
    .thi-clock .dial{position:absolute;inset:0;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .thi-clock .arc{position:absolute;inset:0;border-radius:50%;
      -webkit-mask:radial-gradient(farthest-side,transparent 55%, #000 56%);
              mask:radial-gradient(farthest-side,transparent 55%, #000 56%)}
    .thi-clock .dial::after{content:"";position:absolute;inset:3px;border-radius:50%;
      background:repeating-conic-gradient(#9e9e9e 0 2deg, transparent 0 18deg);
      -webkit-mask:radial-gradient(farthest-side,transparent 68%,#000 69%);
              mask:radial-gradient(farthest-side,transparent 68%,#000 69%);opacity:.33}
    .thi-clock .needle{position:absolute;left:50%;top:50%;width:2px;height:42%;background:#000;transform-origin:bottom center;
      transform:translate(-50%,-100%) rotate(var(--angle,-120deg));border-radius:2px;transition:transform .9s cubic-bezier(.22,.8,.2,1)}
    .thi-clock .needle::after{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:inherit}
    .thi-clock .center{position:absolute;left:50%;top:50%;width:8px;height:8px;border-radius:50%;background:#000;transform:translate(-50%,-50%)}

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª */
    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .tile{position:relative;background:#eafbe7;border:1.5px solid #c5e1a5;border-radius:14px;
      padding:16px;text-align:center;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;
      align-items:center;justify-content:center;gap:6px;min-height:118px}
    .tile .icon{display:block;width:44px;height:44px;line-height:44px;border-radius:50%;border:1px solid var(--border);font-size:24px;margin-bottom:6px}
    .tile .badge{position:absolute;top:8px;left:8px;background:#f7fff4;border:1px solid var(--border);color:#335c33;border-radius:999px;padding:2px 8px;font-size:11px}

    /* Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ (herd-gauges) */
    .gauge{width:100%;aspect-ratio:2/1;position:relative}
    .gauge svg{width:100%;height:100%;display:block}
    .gauge .val{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#065f46;font-size:22px}
    

    @media(max-width:560px){
      .dashboard{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
      .tile{min-height:110px;padding:14px}
      .tile-m-full{grid-column:1 / -1}
    }
  </style>
</head>
<body>
  <h1 class="brand">
    <img id="brandImg" class="brand-icon" alt="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"/>
    <svg class="brand-icon-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Ù„ÙˆØ­Ø©">
      <path d="M6 38 L18 50 L40 18" fill="none" stroke="#1e88e5" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="28" y="46" width="30" height="6" rx="3" fill="#1e88e5"/>
      <rect x="30" y="30" width="6" height="16" rx="3" fill="#ef5350"/>
      <rect x="40" y="24" width="6" height="22" rx="3" fill="#fdd835"/>
      <rect x="50" y="16" width="6" height="30" rx="3" fill="#7cb342"/>
    </svg>
    Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø±Ø¨ÙŠÙƒ
  </h1>

  <!-- ================== Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… (ÙƒÙ…Ø§ ÙƒØ§Ù†) ================== -->
  <div id="weatherClassic" class="card" aria-label="Ø§Ù„Ø·Ù‚Ø³ Ùˆ Ù…Ø¤Ø´Ø± THI">
    <div class="bar">
      <button class="btn" id="wxRefresh" type="button">ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn" id="wxPin" type="button">Ø«Ø¨Ù‘Øª</button>
      <span style="margin-inline-start:auto;font-weight:bold;">Ø§Ù„Ù…ÙˆØ¶Ø¹</span>
      <button class="seg" id="segFarm" type="button">Ù…Ø²Ø±Ø¹ØªÙŠ</button>
      <button class="seg" id="segGPS" type="button">Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>

    <div class="grid">
      <div class="pill"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><b id="wxTemp">â€”Â°C</b></div>
      <div class="right">
        <div class="thi-clock">
          <div class="dial"><div id="thiArc" class="arc"></div></div>
          <div id="thiNeedle" class="needle"></div>
          <div class="center"></div>
        </div>
      </div>
      <div class="pill"><div>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div><b id="wxHum">â€”%</b></div>
      <div class="pill"><div>THI</div><b id="wxTHI">â€”</b></div>
      <div class="pill" style="grid-column:1 / span 2"><div>Ø§Ù„Ø­Ø§Ù„Ø©</div><b id="wxState">â€”</b></div>
    </div>
  </div>
  <!-- ============================================================= -->

  <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª / Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
  <div class="dashboard" style="margin-top:12px">
    <div class="tile" onclick="location.href='add-animal.html'"><span class="icon">â•</span>Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='animal-list.html'"><span class="icon">ğŸ“‹</span>Ø­ÙŠÙˆØ§Ù†Ø§ØªÙŠ</div>
    <div class="tile" onclick="location.href='add-event.html'"><span class="icon">ğŸ—“ï¸</span>Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</div>
    <div class="tile" onclick="location.href='alerts.html'"><span class="icon">ğŸ””</span>Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
    <div class="tile" onclick="location.href='cow-card.html'"><span class="icon">ğŸ®</span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>
    <div class="tile" id="groupsTile" role="button" tabindex="0"
     onclick="(window.dataLayer=window.dataLayer||[]).push({event:'tile_click',tile:'groups',page:'dashboard'}); location.href='groups.html'">
  <span class="icon">ğŸ‘¥</span>
  Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø±Ø¨ÙŠÙƒ
</div>

    <div class="tile" onclick="location.href='milk-reports.html'"><span class="icon">ğŸ“Š</span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø¨Ù†</div>
    <div class="tile" id="sensorsTile" role="button" tabindex="0">
      <span class="icon">ğŸ›°ï¸</span>
      Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª
      <span class="badge" id="sensorsStatus">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦</span>
    </div>
    <div class="tile" id="nutritionEvalTile" role="button" tabindex="0" onclick="location.href='nutrition-eval.html'">
      ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØºØ°ÙŠØ©
    </div>
  </div>
<!-- Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ø¥Ù†ØªØ§Ø¬ÙŠ + ØªÙ†Ø§Ø³Ù„ÙŠ) -->
<div class="card" id="herdGauges" aria-label="Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù‚Ø·ÙŠØ¹" style="margin-top:12px">
  <div style="font-weight:800;color:#1b5e20;margin-bottom:10px;display:flex;align-items:center;gap:8px">
    ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ø¥Ù†ØªØ§Ø¬ÙŠ + ØªÙ†Ø§Ø³Ù„ÙŠ)
    <span id="g-date" style="margin-inline-start:auto;font-size:12px;border:1px solid #c5e1a5;border-radius:999px;padding:2px 8px;background:#fff">â€”</span>
  </div>

  <div class="gauge-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px">
    <!-- ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨ % -->
    <div class="gauge" data-key="inMilkPct">
      <svg viewBox="0 0 100 50">
        <path d="M10,50 A40,40 0 0 1 90,50" stroke="#e0e0e0" stroke-width="10" fill="none"/>
        <path id="fg-inmilk" d="" stroke="#2e7d32" stroke-width="10" stroke-linecap="round" fill="none"/>
      </svg>
      <div class="val"><div>ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨<br><b id="v-inmilk">â€”%</b></div></div>
    </div>

    <!-- Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø± % -->
    <div class="gauge" data-key="pregRate">
      <svg viewBox="0 0 100 50">
        <path d="M10,50 A40,40 0 0 1 90,50" stroke="#e0e0e0" stroke-width="10" fill="none"/>
        <path id="fg-preg" d="" stroke="#1e88e5" stroke-width="10" stroke-linecap="round" fill="none"/>
      </svg>
      <div class="val"><div>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø´Ø§Ø±<br><b id="v-preg">â€”%</b></div></div>
    </div>

    <!-- Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© ÙƒÙ†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ø­Ù„Ø§Ø¨ -->
    <div class="gauge" data-key="freshShare">
      <svg viewBox="0 0 100 50">
        <path d="M10,50 A40,40 0 0 1 90,50" stroke="#e0e0e0" stroke-width="10" fill="none"/>
        <path id="fg-fresh" d="" stroke="#8e24aa" stroke-width="10" stroke-linecap="round" fill="none"/>
      </svg>
      <div class="val"><div>Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©<br><b id="v-fresh">â€”%</b></div></div>
    </div>

    <!-- Ø¬Ø§Ù % Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·ÙŠØ¹ -->
    <div class="gauge" data-key="dryShare">
      <svg viewBox="0 0 100 50">
        <path d="M10,50 A40,40 0 0 1 90,50" stroke="#e0e0e0" stroke-width="10" fill="none"/>
        <path id="fg-dry" d="" stroke="#ef6c00" stroke-width="10" stroke-linecap="round" fill="none"/>
      </svg>
      <div class="val"><div>Ø¬Ø§Ù<br><b id="v-dry">â€”%</b></div></div>
    </div>

    <!-- Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ„Ù‚ÙŠØ­ 21ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ) -->
    <div class="gauge" data-key="serviceRate">
      <svg viewBox="0 0 100 50">
        <path d="M10,50 A40,40 0 0 1 90,50" stroke="#e0e0e0" stroke-width="10" fill="none"/>
        <path id="fg-service" d="" stroke="#3949ab" stroke-width="10" stroke-linecap="round" fill="none"/>
      </svg>
      <div class="val"><div>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ„Ù‚ÙŠØ­ 21ÙŠ<br><b id="v-service">â€”%</b></div></div>
    </div>

    <!-- Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø®ØµØ§Ø¨ -->
    <div class="gauge" data-key="conceptionRate">
      <svg viewBox="0 0 100 50">
        <path d="M10,50 A40,40 0 0 1 90,50" stroke="#e0e0e0" stroke-width="10" fill="none"/>
        <path id="fg-conception" d="" stroke="#c2185b" stroke-width="10" stroke-linecap="round" fill="none"/>
      </svg>
      <div class="val"><div>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø®ØµØ§Ø¨<br><b id="v-conception">â€”%</b></div></div>
    </div>
  </div>
</div>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ÙˆÙŠØ¯Ø¬Øª -->
  <script>
    (function(){
      const tEl=document.getElementById('wxTemp');
      const hEl=document.getElementById('wxHum');
      const thiEl=document.getElementById('wxTHI');
      const sEl=document.getElementById('wxState');
      const thiArc=document.getElementById('thiArc');
      const thiNeedle=document.getElementById('thiNeedle');

      function THI(c,rh){ const f=c*9/5+32; return Math.round(((f-(0.55-0.0055*rh)*(f-58)))*10)/10; }
      function bands(){ return {t1:66,t2:70,t3:77,t4:82}; }
      function colorAndText(thi,b){
        if(thi<b.t1) return {bg:'#c8e6c9',txt:'Ù…Ø±ÙŠØ­'};
        if(thi<b.t2) return {bg:'#fff9c4',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø®ÙÙŠÙ'};
        if(thi<b.t3) return {bg:'#ffe0b2',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ù…ØªÙˆØ³Ø·'};
        if(thi<b.t4) return {bg:'#ffccbc',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯'};
        return {bg:'#ffcdd2',txt:'Ø§Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯ Ø¬Ø¯Ø§'};
      }
      async function fetchWeather(){
        try{
          const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=30.0444&longitude=31.2357&current=temperature_2m,relative_humidity_2m&timezone=auto`);
          const j=await r.json();
          return { t:j.current?.temperature_2m, h:j.current?.relative_humidity_2m };
        }catch{return null;}
      }
      function drawTHI(thi){
        const b=bands();
        if(thiArc){
          thiArc.style.background = `conic-gradient(from -120deg,#90caf9 0% 25%,#fff59d 25% 50%,#ffcc80 50% 75%,#ef5350 75% 100%)`;
        }
        if(thiNeedle){
          const ang=-120+((thi-50)/40)*240;
          thiNeedle.style.setProperty('--angle',ang+'deg');
        }
        const {bg,txt}=colorAndText(thi,b);
        document.getElementById('weatherClassic').style.background = bg;
        sEl.textContent = txt;
      }
      async function render(){
        const data=await fetchWeather();
        if(!data) return;
        const t=Math.round(data.t), h=Math.round(data.h);
        const thi=THI(t,h);
        tEl.textContent=`${t}Â°C`;
        hEl.textContent=`${h}%`;
        thiEl.textContent=thi;
        drawTHI(thi);
      }
      document.getElementById('wxRefresh').addEventListener('click',()=>render());
      document.addEventListener('DOMContentLoaded',()=>render());
    })();
  </script>

  <!-- ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª -->
  <script>
    (function(){
      const tile=document.getElementById('sensorsTile');
      const badge=document.getElementById('sensorsStatus');
      function setBadge(txt,ok){ if(!badge) return; badge.textContent=txt; badge.style.background=ok?'#e8f5e9':'#fff8e1'; badge.style.borderColor=ok?'#c5e1a5':'#ffecb3'; }
      async function ping(){
        try{
          setBadge('Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦',false);
          const r=await fetch('/api/sensors/health');
          if(!r.ok){ setBadge('ØºÙŠØ± Ù…ØªØµÙ„',false); return; }
          const j=await r.json();
          const n=Number(j?.devices||0);
          setBadge(`Ù…ØªØµÙ„ â€¢ ${n}`,true);
        }catch{ setBadge('ØºÙŠØ± Ù…ØªØµÙ„',false); }
      }
      tile?.addEventListener('click',()=>{ location.href='sensor-test.html'; });
      document.addEventListener('DOMContentLoaded',()=>{ ping(); setInterval(ping,60000); });
    })();
  </script>
  <!-- Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ -->
<script src="/js/tenant-bootstrap.js"></script>
<script type="module" src="/js/app-core.js"></script>
<script>
  (function(){
    const t = document.getElementById('groupsTile');
    if(!t) return;
    t.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        t.click();
      }
    });
  })();
</script>
<script>
;(()=>{ // ; Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªØ­Ø§Ù… Ù…Ø¹ Ø³ÙƒØ±Ø¨Øª Ù‚Ø¨Ù„Ù‡ Ø¨Ù„Ø§ ÙØ§ØµÙ„Ø© Ù…Ù†Ù‚ÙˆØ·Ø©
  const $ = s=>document.querySelector(s);

  // Helpers
  const toDate = s=> s? new Date(s): null;
  const daysBetween = (a,b)=> Math.floor((a-b)/(24*3600*1000));
  const getDIM = an => { const calv=toDate(an?.calvingDate); if(!calv) return 0; return Math.max(0, daysBetween(new Date(), calv)); };
  const isDry = an => an?.lactationStatus==='Ø¬Ø§Ù' || an?.dry===true || an?.inMilk===false;
  const isPreg = an => an?.reproductiveStatus==='Ø¹Ø´Ø§Ø±' || an?.pregnant===true;
  const FRESH_FROM=1, FRESH_TO=45;
  const isFresh = an => { const d=getDIM(an); return d>=FRESH_FROM && d<=FRESH_TO && !isDry(an) && (Number(an?.lactationNumber||0)>0); };

  // Ø±Ø³Ù… Ù‚ÙˆØ³ Ù†ØµÙ Ø¯Ø§Ø¦Ø±Ø©
  function arcPath(percent){
    const p = Math.max(0, Math.min(100, Number(percent)||0));
    const theta = Math.PI * (1 - p/100);
    const R=40, cx=50, cy=50;
    const x = cx + R * Math.cos(theta);
    const y = cy + R * Math.sin(theta);
    const laf = p>50 ? 1 : 0;
    return `M10,50 A40,40 0 ${laf} 1 ${x.toFixed(2)},${y.toFixed(2)}`;
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø·ÙŠØ¹ (ÙŠØªØ­Ù…Ù„ Ø´ÙƒÙ„ÙŠÙ†: [] Ø£Ùˆ {data:[]})
  async function loadAnimals(){
    try{
      const r = await fetch('/api/animals',{cache:'no-store'});
      if(r.ok){
        const raw = await r.json();
        const arr = Array.isArray(raw) ? raw : (Array.isArray(raw?.data) ? raw.data : []);
        if(arr.length){ localStorage.setItem('animals_cache', JSON.stringify(arr)); return arr; }
      }
    }catch(e){}
    try{ return JSON.parse(localStorage.getItem('animals_cache')||'[]'); }catch{ return []; }
  }

  // Ù…Ø¹Ø¯Ù„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  async function loadExtraRates(){
    try{
      const since = new Date(Date.now()-21*24*3600*1000).toISOString().slice(0,10);
      const [srvRes, pregRes] = await Promise.allSettled([
        fetch(`/api/events?type=service&from=${since}`),
        fetch(`/api/events?type=preg_check&from=${since}`)
      ]);
      let serviceCount=null, conceptionRate=null;
      if(srvRes.status==='fulfilled' && srvRes.value.ok){
        const S = await srvRes.value.json(); serviceCount = Array.isArray(S)? S.length : 0;
      }
      if(pregRes.status==='fulfilled' && pregRes.value.ok){
        const P = await pregRes.value.json();
        const done = Array.isArray(P)? P.length : 0;
        const pos = (Array.isArray(P)? P : []).filter(e=> String(e?.result||'').includes('Ø­Ø§Ù…Ù„') || e?.pregnant===true).length;
        conceptionRate = done? Math.round((pos/done)*100) : null;
      }
      return { serviceCount, conceptionRate };
    }catch{ return { serviceCount:null, conceptionRate:null }; }
  }

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
  function calc(animals){
    const total = animals.length;
    let inMilk=0, fresh=0, dry=0, preg=0, open=0, sumDimOpen=0;
    for(const an of animals){
      const dryFlag = isDry(an);
      if(!dryFlag){ inMilk++; if(isFresh(an)) fresh++; } else { dry++; }
      if(isPreg(an)) preg++; else if(!dryFlag){ open++; sumDimOpen += getDIM(an); }
    }
    const inMilkPct = total? Math.round(inMilk/total*100) : 0;
    const pregRate  = total? Math.round(preg/total*100)  : 0;
    const freshShare= inMilk? Math.round(fresh/inMilk*100) : 0;
    const dryShare  = total? Math.round(dry/total*100)   : 0;
    const openDim   = open? Math.round(sumDimOpen/open)  : 0;
    return { total, inMilk, inMilkPct, preg, pregRate, fresh, freshShare, dry, dryShare, open, openDim };
  }

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ù‡
  function renderGauges(k, extra){
    $('#g-date').textContent = new Date().toISOString().slice(0,10);

    $('#fg-inmilk').setAttribute('d', arcPath(k.inMilkPct));
    $('#v-inmilk').textContent = k.inMilkPct + '%';

    $('#fg-preg').setAttribute('d', arcPath(k.pregRate));
    $('#v-preg').textContent = k.pregRate + '%';

    $('#fg-fresh').setAttribute('d', arcPath(k.freshShare));
    $('#v-fresh').textContent = k.freshShare + '%';

    $('#fg-dry').setAttribute('d', arcPath(k.dryShare));
    $('#v-dry').textContent = k.dryShare + '%';

    if(extra.serviceCount!=null && k.open>0){
      const sr = Math.max(0, Math.min(100, Math.round((extra.serviceCount/k.open)*100)));
      $('#fg-service').setAttribute('d', arcPath(sr));
      $('#v-service').textContent = sr + '%';
    }else{
      $('#fg-service').setAttribute('d', arcPath(0));
      $('#v-service').textContent = 'â€”%';
    }

    if(typeof extra.conceptionRate==='number'){
      $('#fg-conception').setAttribute('d', arcPath(extra.conceptionRate));
      $('#v-conception').textContent = extra.conceptionRate + '%';
    }else{
      $('#fg-conception').setAttribute('d', arcPath(0));
      $('#v-conception').textContent = 'â€”%';
    }
  }

  async function boot(){
    try{
      const animals = await loadAnimals();
      const k = calc(animals);
      const extra = await loadExtraRates();
      renderGauges(k, extra);
      (window.dataLayer=window.dataLayer||[]).push({event:'kpi_render', inMilkPct:k.inMilkPct, pregRate:k.pregRate});
    }catch(err){
      console.error('Herd gauges error:', err);
    }
  }

  // Ø´ØºÙ‘Ù„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ DOM
  document.addEventListener('DOMContentLoaded', boot);
})();
</script>


 <script>
async function loadAnimals(){
  try{
    const r = await fetch('/api/animals');
    if(r.ok){
      const raw = await r.json();
      // ÙŠÙ‚Ø¨Ù„ Ù…ØµÙÙˆÙØ© Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ ÙƒØ§Ø¦Ù† ÙÙŠÙ‡ data
      const arr = Array.isArray(raw) ? raw : (Array.isArray(raw?.data) ? raw.data : []);
      if(arr.length){ localStorage.setItem('animals_cache', JSON.stringify(arr)); return arr; }
    }
  }catch{}
  try{ return JSON.parse(localStorage.getItem('animals_cache')||'[]'); }catch{ return []; }
}
</script>

<script>
  async function loadExtraRates(){
    // Ù…Ø¹Ø¯Ù„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ùˆ Ù…ØªØ§Ø­Ø© Ù†Ù‡Ø§ÙŠØ§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    try{
      const since = new Date(Date.now()-21*24*3600*1000).toISOString().slice(0,10);
      const [srvRes, pregRes] = await Promise.allSettled([
        fetch(`/api/events?type=service&from=${since}`),
        fetch(`/api/events?type=preg_check&from=${since}`)
      ]);
      let service21=null, conception=null;
      if(srvRes.status==='fulfilled' && srvRes.value.ok){
        const S = await srvRes.value.json(); service21 = Array.isArray(S)? S.length : 0; // Ù‡Ù†Ø­ÙˆÙ‘Ù„Ù‡ % Ù„Ø§Ø­Ù‚Ø§Ù‹
      }
      if(pregRes.status==='fulfilled' && pregRes.value.ok){
        const P = await pregRes.value.json();
        const done = Array.isArray(P)? P.length : 0;
        const pos = (Array.isArray(P)? P : []).filter(e=> String(e?.result||'').includes('Ø­Ø§Ù…Ù„') || e?.pregnant===true).length;
        conception = done? Math.round((pos/done)*100) : null;
      }
      return { serviceCount: service21, conceptionRate: conception };
    }catch{ return { serviceCount:null, conceptionRate:null }; }
  }

  function calc(animals){
    const total = animals.length;
    let inMilk=0, fresh=0, dry=0, preg=0, open=0, sumDimOpen=0;

    for(const an of animals){
      const dryFlag = isDry(an);
      if(!dryFlag){ inMilk++; if(isFresh(an)) fresh++; } else { dry++; }
      if(isPreg(an)) preg++; else if(!dryFlag){ open++; sumDimOpen += getDIM(an); }
    }

    const inMilkPct = total? Math.round(inMilk/total*100) : 0;
    const pregRate  = total? Math.round(preg/total*100)    : 0;
    const freshShare= inMilk? Math.round(fresh/inMilk*100) : 0;
    const dryShare  = total? Math.round(dry/total*100)     : 0;
    const openDim   = open? Math.round(sumDimOpen/open)    : 0;

    return { total, inMilk, inMilkPct, preg, pregRate, fresh, freshShare, dry, dryShare, open, openDim };
  }

  function renderGauges(k, extra){
    $('#g-date').textContent = new Date().toISOString().slice(0,10);

    // ÙÙŠ Ø§Ù„Ø­Ù„Ø§Ø¨
    $('#fg-inmilk').setAttribute('d', arcPath(k.inMilkPct));
    $('#v-inmilk').textContent = k.inMilkPct + '%';

    // Ø§Ù„Ø¹Ø´Ø§Ø±
    $('#fg-preg').setAttribute('d', arcPath(k.pregRate));
    $('#v-preg').textContent = k.pregRate + '%';

    // Ø­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø­Ù„Ø§Ø¨
    $('#fg-fresh').setAttribute('d', arcPath(k.freshShare));
    $('#v-fresh').textContent = k.freshShare + '%';

    // Ø§Ù„Ø¬Ø§Ù Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    $('#fg-dry').setAttribute('d', arcPath(k.dryShare));
    $('#v-dry').textContent = k.dryShare + '%';

    // Ø§Ù„ØªÙ„Ù‚ÙŠØ­ 21ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ: Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª/Ø¹Ø¯Ø¯ Open)
    if(extra.serviceCount!=null && k.open>0){
      const sr = Math.max(0, Math.min(100, Math.round((extra.serviceCount/k.open)*100)));
      $('#fg-service').setAttribute('d', arcPath(sr));
      $('#v-service').textContent = sr + '%';
    }else{
      $('#fg-service').setAttribute('d', arcPath(0));
      $('#v-service').textContent = 'â€”%';
    }

    // Ø§Ù„Ø¥Ø®ØµØ§Ø¨
    if(typeof extra.conceptionRate==='number'){
      $('#fg-conception').setAttribute('d', arcPath(extra.conceptionRate));
      $('#v-conception').textContent = extra.conceptionRate + '%';
    }else{
      $('#fg-conception').setAttribute('d', arcPath(0));
      $('#v-conception').textContent = 'â€”%';
    }
  }

  async function boot(){
    const animals = await loadAnimals();
    const k = calc(animals);
    const extra = await loadExtraRates(); // ØºÙŠØ± Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
    renderGauges(k, extra);
  }

  document.addEventListener('DOMContentLoaded', boot);
})();
</script>
<script type="module">
/* ==== Herd Gauges from Firebase Firestore (LIVE) ==== */
import app from '/js/firebase-config.js';
import {
  getFirestore, collection, query, where, onSnapshot
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const $ = s => document.querySelector(s);

// ---------- Helpers (English fields) ----------
const toDate = s => s ? new Date(s) : null;
const daysBetween = (a,b)=> Math.floor((a-b)/(24*3600*1000));
const getDIM = an => {
  const calv = toDate(an.calvingDate || an.lastCalvingDate || an.calvedAt);
  if(!calv) return 0;
  return Math.max(0, daysBetween(new Date(), calv));
};
const isDry = an => {
  const st = String(an.lactationStatus || an.status || '').toLowerCase();
  return an.inMilk === false || st.includes('dry');
};
const isPreg = an => {
  const rs = String(an.reproductiveStatus || an.pregStatus || '').toLowerCase();
  return an.pregnant === true || rs.includes('preg');
};
const isFresh = an => {
  const d = getDIM(an);
  const lactNo = Number(an.lactationNumber ?? an.lactNo ?? an.lactNum ?? 0);
  return d>=1 && d<=45 && !isDry(an) && lactNo>0;
};

// Ø±Ø³Ù… Ù‚ÙˆØ³ Ù†ØµÙ Ø¯Ø§Ø¦Ø±Ø©
function arcPath(percent){
  const p = Math.max(0, Math.min(100, Number(percent)||0));
  const theta = Math.PI * (1 - p/100);
  const R=40, cx=50, cy=50;
  const x = cx + R * Math.cos(theta);
  const y = cy + R * Math.sin(theta);
  const laf = p>50 ? 1 : 0;
  return `M10,50 A40,40 0 ${laf} 1 ${x.toFixed(2)},${y.toFixed(2)}`;
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
function calc(animals){
  const total = animals.length;
  let inMilk=0, fresh=0, dry=0, preg=0, open=0, sumDimOpen=0;
  for(const an of animals){
    const dryF = isDry(an);
    if(!dryF){ inMilk++; if(isFresh(an)) fresh++; } else { dry++; }
    if(isPreg(an)) preg++; else if(!dryF){ open++; sumDimOpen += getDIM(an); }
  }
  const inMilkPct = total? Math.round(inMilk/total*100) : 0;
  const pregRate  = total? Math.round(preg/total*100)  : 0;
  const freshShare= inMilk? Math.round(fresh/inMilk*100) : 0;
  const dryShare  = total? Math.round(dry/total*100)   : 0;
  const openDim   = open? Math.round(sumDimOpen/open)  : 0;
  return { total, inMilk, inMilkPct, preg, pregRate, fresh, freshShare, dry, dryShare, open, openDim };
}

// ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¬ÙˆØ¬Ø²
function renderGauges(k){
  $('#g-date').textContent = new Date().toISOString().slice(0,10);
  $('#fg-inmilk').setAttribute('d', arcPath(k.inMilkPct)); $('#v-inmilk').textContent = k.inMilkPct + '%';
  $('#fg-preg').setAttribute('d', arcPath(k.pregRate));    $('#v-preg').textContent  = k.pregRate + '%';
  $('#fg-fresh').setAttribute('d', arcPath(k.freshShare)); $('#v-fresh').textContent = k.freshShare + '%';
  $('#fg-dry').setAttribute('d', arcPath(k.dryShare));     $('#v-dry').textContent   = k.dryShare + '%';
  // Ù†Ø³ÙŠØ¨ service/conception Ù…Ø¹Ø·Ù‘Ù„ÙŠÙ† Ù„Ø­Ø¯ Ù…Ø§ Ù†Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø«
  $('#fg-service').setAttribute('d', arcPath(0));          $('#v-service').textContent = 'â€”%';
  $('#fg-conception').setAttribute('d', arcPath(0));       $('#v-conception').textContent = 'â€”%';
}

// Ø¯Ù…Ø¬ Ù†ØªØ§Ø¦Ø¬ Ù…ØµØ¯Ø±ÙŠÙ† Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
function dedupe(list){
  const map = new Map();
  for(const an of list){
    const key = an.animalNumber ?? an.number ?? an.id ?? an.uid;
    if(!map.has(key)) map.set(key, an);
  }
  return [...map.values()];
}

// Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Firestore
(function startLive(){
  const db = getFirestore(app);
  const userId = (window.__TENANT__ && window.__TENANT__.userId) || localStorage.getItem('userId');
  if(!userId){ console.warn('MBK KPIs: Ù„Ø§ ÙŠÙˆØ¬Ø¯ userIdØŒ Ø§Ø­ÙØ¸Ù‡ ÙÙŠ localStorage.userId Ø£Ùˆ ÙˆÙÙ‘Ø±Ù‡ Ù…Ù† __TENANT__.'); return; }

  let aSub=[], bSub=[]; // a: users/{uid}/animals , b: animals where userId==uid
  const recompute = ()=> {
    const animals = dedupe([...aSub, ...bSub]);
    const k = calc(animals);
    renderGauges(k);
  };

  // Ù…Ø³Ø§Ø± 1: users/{uid}/animals
  try{
    const col = collection(db, 'users', userId, 'animals');
    onSnapshot(col, snap=>{
      aSub = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
      recompute();
    }, err=> console.warn('users/{uid}/animals snapshot error', err));
  }catch(e){ console.warn('users/{uid}/animals not available', e); }

  // Ù…Ø³Ø§Ø± 2: animals (top-level) Ù…Ø¹ userId
  try{
    const q = query(collection(db, 'animals'), where('userId','==', userId));
    onSnapshot(q, snap=>{
      bSub = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
      recompute();
    }, err=> console.warn('animals where userId==uid snapshot error', err));
  }catch(e){ console.warn('animals top-level query not available', e); }
})();
</script>

</body>
</html>






