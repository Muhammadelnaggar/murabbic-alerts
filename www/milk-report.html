<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تقرير اللبن — مُرَبِّك</title>
  <link rel="stylesheet" href="css/forms.css" />
  <script type="module" src="js/forms-init.js"></script>
  <!-- Chart.js للرسم -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{ --green:#0ea05a; --green-600:#0b7f47; --bg:#f7faf7; --text:#0f172a; --muted:#64748b; --card:#ffffff }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,'Cairo','Segoe UI',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0}
    .bar{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title{font-weight:800;color:var(--green-600)}
    main{max-width:1100px;margin:16px auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .grid{display:grid;gap:12px}
    .row{display:grid;gap:12px}
    @media(min-width:900px){ .row{grid-template-columns:repeat(4,1fr)} }
    label{font-weight:700;font-size:14px}
    input,select{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:15px}
    .metric{display:flex;flex-direction:column;gap:6px;padding:12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
    .metric .k{font-size:26px;font-weight:900}
    .muted{color:#64748b}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2f7;color:#0f172a;font-weight:700}
    .infobar{display:none;margin-top:8px;padding:10px;border-radius:10px;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .infobar.show{display:block}
    .error{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    canvas{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:6px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right}
  </style>
</head>
<body>
  <script>window.dataLayer = window.dataLayer || [];</script>

  <header>
    <div class="bar">
      <div class="title">📊 تقرير اللبن</div>
      <div class="actions">
        <a class="badge" href="dashboard.html">لوحة التحكم</a>
        <a class="badge" href="daily-milk.html">إدخال لبن يومي</a>
        <a class="badge" href="add-event.html">الأحداث</a>
      </div>
    </div>
  </header>

  <main>
    <!-- فلاتر -->
    <div class="card">
      <div class="row" style="grid-template-columns:repeat(5,1fr)">
        <div>
          <label>تاريخ الأساس</label>
          <input id="refDate" type="date" />
        </div>
        <div>
          <label>نوع القطيع</label>
          <select id="speciesFilter">
            <option value="all">الكل</option>
            <option value="أبقار">أبقار</option>
            <option value="جاموس">جاموس</option>
          </select>
        </div>
        <div>
          <label>الوحدة</label>
          <select id="unitSel">
            <option value="kg">كجم</option>
            <option value="l">لتر</option>
          </select>
        </div>
        <div style="align-self:end">
          <button id="refreshBtn" class="badge" style="border:1px solid #cbd5e1">تحديث 🔄</button>
        </div>
        <div style="align-self:end">
          <span id="status" class="muted"></span>
        </div>
      </div>
      <div id="msg" class="infobar"></div>
    </div>

    <!-- مؤشرات -->
    <div class="card">
      <div class="row">
        <div class="metric">
          <div class="muted">إجمالي اليوم (حسب النوع)</div>
          <div class="k" id="kDaily">—</div>
          <div class="muted" id="kDailyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">إجمالي الشهر</div>
          <div class="k" id="kMonthly">—</div>
          <div class="muted" id="kMonthlyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">إجمالي السنة</div>
          <div class="k" id="kYearly">—</div>
          <div class="muted" id="kYearlyBreak"></div>
        </div>
        <div class="metric">
          <div class="muted">متوسط القطيع اليومي</div>
          <div class="k" id="kAvg">—</div>
          <div class="muted" id="kAvgNote"></div>
        </div>
      </div>
    </div>

    <!-- الرسم -->
    <div class="card grid">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><b>Scatter</b> — الأفراد: (X) أيام الحليب — (Y) الإنتاج اليومي</div>
        <div class="muted">الضغط على النقطة يفتح بطاقة الحيوان</div>
      </div>
      <canvas id="scatterChart" height="330"></canvas>
    </div>

    <!-- تكلفة كجم اللبن من المادة الجافة -->
    <div class="card grid">
      <div class="row" style="grid-template-columns:repeat(3,1fr)">
        <div class="metric">
          <div class="muted">متوسط تكلفة كجم اللبن (شهر الأساس)</div>
          <div class="k" id="kCostPerKg">—</div>
          <div class="muted" id="kCostNote">تحسب من أحداث التغذية (dmIntakeKg × dmCostPerKg) ÷ إجمالي اللبن.</div>
        </div>
        <div class="metric">
          <div class="muted">بيانات التغذية المستخدمة</div>
          <div id="kCostDbg" class="muted">—</div>
        </div>
        <div class="metric">
          <div class="muted">ملاحظات</div>
          <div class="muted">في حال نقص الحقول في التغذية أو اللبن لن تُحتسب تلك السجلات.</div>
        </div>
      </div>
    </div>

    <!-- لائحة مختصرة (اختياري) -->
    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">أعلى 10 أفراد حسب الإنتاج اليومي</div>
      <table class="table" id="topTable">
        <thead><tr><th>رقم</th><th>النوع</th><th>DIM</th><th>إنتاج اليوم</th><th>حالة تناسلية</th><th>موسم</th><th>مجموعة</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- Firebase -->
  <script type="module" src="/js/firebase-config.js"></script>
  <script src="/js/app-core.js"></script>
  <script src="/js/tenant-bootstrap.js"></script>

  <!-- منطق الصفحة -->
  <script type="module">
    import { db, auth, ensureAuth } from '/js/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      collection, query, where, orderBy, limit, getDocs
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // عناصر
    const refDateEl = document.getElementById('refDate');
    const speciesSel = document.getElementById('speciesFilter');
    const unitSel = document.getElementById('unitSel');
    const refreshBtn = document.getElementById('refreshBtn');
    const msg = document.getElementById('msg');
    const statusEl = document.getElementById('status');

    const DIGITS={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
    const toLatin = s => String(s||'').replace(/[٠-٩۰-۹]/g, d=>DIGITS[d]).replace(/[^\d]/g,'');

    // أدوات وقت
    function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    function startOfMonthISO(d){ const x=new Date(d); x.setDate(1); return x.toISOString().slice(0,10) }
    function endOfMonthISO(d){ const x=new Date(d); x.setMonth(x.getMonth()+1); x.setDate(0); return x.toISOString().slice(0,10) }
    function startOfYearISO(d){ const x=new Date(d); x.setMonth(0,1); return x.toISOString().slice(0,10) }
    function endOfYearISO(d){ const x=new Date(d); x.setMonth(12,0); return x.toISOString().slice(0,10) }
    function daysBetweenISO(a,b){ const A=new Date(a), B=new Date(b); A.setHours(0,0,0,0); B.setHours(0,0,0,0); return Math.round((B-A)/86400000); }

    function fmt(n,dec=1){ if(n==null||isNaN(n)) return '—'; return Number(n).toLocaleString('ar-EG',{maximumFractionDigits:dec,minimumFractionDigits:dec}); }
    function showMsg(t,isErr=false){ msg.className='infobar '+(isErr?'show error':'show'); msg.innerHTML=(isErr?'❌ ':'✅ ')+t; }

    async function uid(){ if(auth.currentUser) return auth.currentUser.uid; return new Promise(r=>onAuthStateChanged(auth,u=>r(u?.uid||''))); }

    function normSpecies(data){
      const s = String(data?.animalTypeAr || data?.animalType || data?.species || '').trim();
      if (s==='cow' || /بقر/i.test(s)) return 'أبقار';
      if (s==='buffalo' || /جاموس/i.test(s)) return 'جاموس';
      return s || 'أبقار';
    }

    // جلب وثيقة الحيوان من animals
    async function fetchAnimalDocByNumber(number){
      const n = toLatin(number);
      const { getDocs, query, where, limit, collection } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
      const tries = [
        ['animalNumber','==',n], ['number','==',n], ['animalNo','==',n]
      ];
      for (const [f,op,val] of tries){
        const s = await getDocs(query(collection(db,'animals'), where(f,op,val), limit(1)));
        if (!s.empty){ const d=s.docs[0]; return { id:d.id, data:d.data()||{} }; }
      }
      return null;
    }

    // آخر ولادة لحساب DIM + آخر تشخيص للحالة التناسلية
    async function fetchFacts(number, refDate){
      const u = await uid();
      const qEv = query(
        collection(db,'events'),
        where('userId','==', u),
        where('animalNumber','==', String(number)),
        orderBy('eventDate','desc'),
        limit(80)
      );
      const s = await getDocs(qEv);
      let lastCalving=null, repro='غير محدد';
      for (const d of s.docs){
        const ev = d.data()||{};
        const type = (ev.eventType || ev.type || '').trim();
        const res  = (ev.result || ev.status || '').trim();
        if (!lastCalving && (type==='calving' || type==='ولادة')) lastCalving = ev.eventDate;
        if (type==='pregnancy_check' || type==='تشخيص حمل'){ repro = res || repro; break; }
      }
      const dim = lastCalving ? Math.max(0, daysBetweenISO(lastCalving, refDate)) : null;
      return { dim, lastCalving, repro };
    }

    // استخراج قيمة اللبن من حدث
    function readMilk(ev){
      const v = ev.milkKg ?? ev.milk ?? ev.yieldKg ?? ev.yield ?? ev.liters;
      const n = Number(v);
      return isFinite(n) ? n : 0;
    }

    // تصفية النوع
    function speciesOK(spWanted, sp){
      if (spWanted==='all') return true;
      return sp===spWanted;
    }

    // الرسم
    let scatter;
    function drawScatter(datasets){
      const ctx = document.getElementById('scatterChart').getContext('2d');
      if (scatter){ scatter.destroy(); }
      scatter = new Chart(ctx,{
        type:'scatter',
        data:{ datasets },
        options:{
          responsive:true,
          plugins:{
            legend:{ display:true, labels:{ usePointStyle:true } },
            tooltip:{
              callbacks:{
                label: (ctx)=>{
                  const p = ctx.raw;
                  /* p.meta: { number, milk, dim, repro, season, group } */
                  const lines = [
                    `رقم: ${p.meta.number}`,
                    `DIM: ${p.meta.dim ?? '—'}`,
                    `إنتاج: ${fmt(p.meta.milk,1)}`,
                    `حالة تناسلية: ${p.meta.repro || '—'}`,
                    `موسم: ${p.meta.season || '—'}`,
                    `مجموعة: ${p.meta.group || '—'}`
                  ];
                  return lines;
                }
              }
            }
          },
          scales:{
            x:{ title:{ display:true, text:'أيام الحليب (DIM)' } },
            y:{ title:{ display:true, text:'الإنتاج اليومي' } }
          },
          onClick:(_, elems)=>{
            if(!elems?.length) return;
            const d = elems[0];
            const meta = scatter.data.datasets[d.datasetIndex].data[d.index].meta;
            if(meta?.number){
              location.href = `cow-card.html?number=${encodeURIComponent(meta.number)}`;
            }
          }
        }
      });
    }

    // تحميل بيانات التقرير
    async function loadReport(){
      try{
        statusEl.textContent = 'جاري التحميل…';
        await ensureAuth();
        const u = await uid(); if(!u){ showMsg('سجّل الدخول أولًا.', true); return; }

        const refDate = refDateEl.value || todayISO();
        const monthFrom = startOfMonthISO(refDate);
        const monthTo   = endOfMonthISO(refDate);
        const yearFrom  = startOfYearISO(refDate);
        const yearTo    = endOfYearISO(refDate);
        const filterSp  = speciesSel.value;

        // ===== إنتاج اليوم/الشهر/السنة =====
        const evQ = query(
          collection(db,'events'),
          where('userId','==', u),
          where('eventDate','>=', yearFrom),
          where('eventDate','<=', yearTo),
          orderBy('eventDate','desc')
        );
        const snap = await getDocs(evQ);

        const daySum = { 'أبقار':0, 'جاموس':0, total:0, count:0 };
        const monthSum = { 'أبقار':0, 'جاموس':0, total:0 };
        const yearSum = { 'أبقار':0, 'جاموس':0, total:0 };

        // سنحتاج هذه للسكاتر وللتوب 10
        const dayAnimals = new Map(); // number -> {milk, event}
        const seenNumbers = new Set();

        for (const d of snap.docs){
          const ev = d.data()||{};
          const type = (ev.eventType || ev.type || '').trim();
          const isMilkEv = /daily[_\s-]?milk|إنتاج اللبن اليومي|milk/i.test(type);
          if (!isMilkEv) continue;

          const evDate = ev.eventDate;
          const milk = readMilk(ev);
          const number = String(ev.animalNumber || ev.number || ev.animalNo || '');
          if (!milk || !number) continue;

          // النوع (إن لم يوجد بالحدث هنجيب لاحقًا من animals عند الحاجة)
          let sp = String(ev.species || ev.animalTypeAr || ev.animalType || '').trim();
          if (sp==='cow' || /بقر/i.test(sp)) sp='أبقار';
          else if (sp==='buffalo' || /جاموس/i.test(sp)) sp='جاموس';

          // يومي
          if (evDate===refDate){
            if(!sp){ // مجهول، سنكمله لاحقًا عند بناء السكاتر
              dayAnimals.set(number,{ milk, event:ev, species:null });
            }else if (speciesOK(filterSp, sp)){
              daySum[sp] = (daySum[sp]||0) + milk;
              daySum.total += milk;
              daySum.count += 1;
              dayAnimals.set(number,{ milk, event:ev, species:sp });
            }else{
              // لو النوع لا يطابق الفلتر تجاهله من اليومي
              dayAnimals.set(number,{ milk, event:ev, species:sp }); // يبقى للسكاتر لو أردنا
            }
          }

          // شهري
          if (evDate>=monthFrom && evDate<=monthTo){
            if (!sp){ /* سنُكمل لاحقًا */ }
            else if (speciesOK(filterSp, sp)){
              monthSum[sp] = (monthSum[sp]||0) + milk;
              monthSum.total += milk;
            }
          }

          // سنوي
          if (speciesOK(filterSp, sp)){
            yearSum[sp] = (yearSum[sp]||0) + milk;
            yearSum.total += milk;
          }

          seenNumbers.add(number);
        }

        // جلب أنواع/تفاصيل الحيوانات المطلوبة (لمن لا نعرف نوعه أو للـ tooltip)
        const animalsMeta = new Map();
        for (const number of dayAnimals.keys()){
          try{
            const ad = await fetchAnimalDocByNumber(number);
            if (ad){
              const a = ad.data;
              animalsMeta.set(number, {
                species: normSpecies(a),
                group: a.group || a.groupName || a.pen || '',
                season: a.season || a.seasonName || '',
                repro: a.reproductiveStatus || a.reproStatus || ''
              });
            }else{
              animalsMeta.set(number, { species:'أبقار', group:'', season:'', repro:'' });
            }
          }catch{ animalsMeta.set(number, { species:'أبقار' }); }
        }

        // أكمل النوع المجهول وأعد الحساب اليومي حسب الفلتر
        if (filterSp!=='all'){
          // إعادة تصفير اليومي وإعادة الجمع بعد استكمال الأنواع
          daySum['أبقار']=0; daySum['جاموس']=0; daySum.total=0; daySum.count=0;
          for (const [num, v] of dayAnimals.entries()){
            const sp = v.species || animalsMeta.get(num)?.species || 'أبقار';
            if (speciesOK(filterSp, sp) && v.event?.eventDate===refDate){
              daySum[sp] += v.milk; daySum.total += v.milk; daySum.count += 1;
            }
          }
        }

        // عرض المؤشرات
        document.getElementById('kDaily').textContent   = fmt(daySum.total,1);
        document.getElementById('kDailyBreak').textContent = `أبقار: ${fmt(daySum['أبقار'],1)} — جاموس: ${fmt(daySum['جاموس'],1)}`;

        document.getElementById('kMonthly').textContent = fmt(monthSum.total,1);
        document.getElementById('kMonthlyBreak').textContent = `أبقار: ${fmt(monthSum['أبقار'],1)} — جاموس: ${fmt(monthSum['جاموس'],1)}`;

        document.getElementById('kYearly').textContent  = fmt(yearSum.total,1);
        document.getElementById('kYearlyBreak').textContent = `أبقار: ${fmt(yearSum['أبقار'],1)} — جاموس: ${fmt(yearSum['جاموس'],1)}`;

        const avg = daySum.count ? (daySum.total / daySum.count) : 0;
        document.getElementById('kAvg').textContent = fmt(avg,1);
        document.getElementById('kAvgNote').textContent = `مبني على ${daySum.count} حيوان لديه إدخال لبن اليوم.`;

        // ===== Scatter =====
        const dsCows = { label:'أبقار', data:[], pointRadius:5, showLine:false };
        const dsBuff = { label:'جاموس', data:[], pointRadius:5, showLine:false };

        const rowsForTop = [];

        for (const [number, rec] of dayAnimals.entries()){
          const meta = animalsMeta.get(number) || {};
          const sp = meta.species || 'أبقار';

          if (!speciesOK(filterSp, sp)) continue;

          // DIM + حالة تناسلية
          const facts = await fetchFacts(number, refDate);
          const dim = facts.dim ?? null;
          const season = meta.season || inferSeason(refDate);
          const point = {
            x: dim ?? 0,
            y: rec.milk,
            meta: {
              number, milk: rec.milk, dim,
              repro: facts.repro || meta.repro || '',
              season, group: meta.group || ''
            }
          };
          (sp==='جاموس' ? dsBuff : dsCows).data.push(point);

          rowsForTop.push({
            number, species: sp, dim: dim ?? '—',
            milk: rec.milk,
            repro: point.meta.repro || '—',
            season, group: point.meta.group || '—'
          });
        }

        drawScatter([dsCows, dsBuff]);

        // Top 10
        rowsForTop.sort((a,b)=>b.milk-a.milk);
        const tb = document.querySelector('#topTable tbody');
        tb.innerHTML = rowsForTop.slice(0,10).map(r=>`<tr>
          <td><a href="cow-card.html?number=${encodeURIComponent(r.number)}">${r.number}</a></td>
          <td>${r.species}</td><td>${r.dim}</td><td>${fmt(r.milk,1)}</td>
          <td>${r.repro}</td><td>${r.season}</td><td>${r.group}</td>
        </tr>`).join('');

        // ===== تكلفة كجم اللبن من المادة الجافة (شهري) =====
        const nutritQ = query(
          collection(db,'events'),
          where('userId','==', u),
          where('eventDate','>=', monthFrom),
          where('eventDate','<=', monthTo),
          orderBy('eventDate','desc')
        );
        const nutritSnap = await getDocs(nutritQ);

        let dmCostTotal = 0, milkMonthTotal = monthSum.total;
        let mealsCount=0;

        for (const d of nutritSnap.docs){
          const ev = d.data()||{};
          const type = (ev.eventType || ev.type || '').trim();
          const isNut = /nutrition|تغذية/i.test(type);
          if (!isNut) continue;

          const intake = Number(ev.dmIntakeKg ?? ev.dmKg ?? ev.dm_intake);
          const costKg = Number(ev.dmCostPerKg ?? ev.rationCostPerKgDM ?? ev.dm_cost);

          if (isFinite(intake) && isFinite(costKg) && intake>0 && costKg>=0){
            dmCostTotal += (intake * costKg);
            mealsCount++;
          }
        }
        const costPerKg = (milkMonthTotal>0 && dmCostTotal>0) ? (dmCostTotal / milkMonthTotal) : 0;
        document.getElementById('kCostPerKg').textContent = costPerKg ? `${fmt(costPerKg,2)} / كجم` : '—';
        document.getElementById('kCostDbg').textContent = `سجلات تغذية محسوبة: ${mealsCount} — إجمالي لبن الشهر: ${fmt(milkMonthTotal,0)} كجم`;

        statusEl.textContent = `آخر تحديث: ${new Date().toLocaleTimeString('ar-EG')}`;
        showMsg('تم تحديث التقرير ✅');
      }catch(e){
        console.error(e);
        showMsg('تعذّر تحميل التقرير.', true);
        statusEl.textContent = 'خطأ في التحميل';
      }
    }

    function inferSeason(dateISO){
      const m = new Date(dateISO).getMonth()+1;
      // تقسيم مبسّط
      if ([12,1,2].includes(m)) return 'شتاء';
      if ([3,4,5].includes(m))  return 'ربيع';
      if ([6,7,8].includes(m))  return 'صيف';
      return 'خريف';
    }

    // إقلاع
    document.addEventListener('DOMContentLoaded', ()=>{
      const today = todayISO();
      refDateEl.value = today;
      loadReport();
    });
    refreshBtn.addEventListener('click', loadReport);
    refDateEl.addEventListener('change', loadReport);
    speciesSel.addEventListener('change', loadReport);
    unitSel.addEventListener('change', loadReport);
  </script>
</body>
</html>
