<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Murabbik â€“ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</title>
  <style>
    :root{--bg:#fffdf5;--card:#ffffff;--border:#d9efd0;--ink:#134e35;--muted:#f7fff2;--acc:#2e7d32}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.45;color:var(--ink);padding:18px}
    .wrap{max-width:980px;margin:0 auto}
    .openbar{display:flex;gap:8px;align-items:center;justify-content:center;margin:0 0 12px;flex-wrap:wrap}
    .openbar small{opacity:.8}
    .openbar input{width:160px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fcfff8}
    .openbar button{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#e8f5e9;color:#1b5e20;font-weight:700;cursor:pointer}
    .kind-badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fcfff8;font-weight:700}
    .title{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;margin:0 0 12px}
    .title h1{margin:0;font-size:clamp(18px,4.6vw,28px);color:#14532d}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:700;font-size:13px;color:#0f5132}
    .chip[data-variant="ok"]{background:#e8f5e9;border-color:#c8e6c9;color:#1b5e20}
    .chip[data-variant="warn"]{background:#fff8e1;border-color:#ffe0b2;color:#7a4f00}
    .chip[data-variant="danger"]{background:#ffebee;border-color:#ffcdd2;color:#7f1d1d}
    .chip-repro::before{content:"ğŸ¼ ";} .chip-prod::before{content:"ğŸ“ˆ ";} .chip-health::before{content:"ğŸ©º ";}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .card h3{margin:0 0 10px;color:#17623b;font-size:18px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .fi{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fcfff8}
    .fi span{color:#2b593a;font-size:13px}
    .fi b{color:#0f5132;direction:ltr;unicode-bidi:plaintext;font-variant-numeric:tabular-nums}
    .milk-gauge-box{width:min(360px,92vw);aspect-ratio:2/1;position:relative;margin:8px auto;display:grid;place-items:center}
    .milk-gauge-box svg{position:absolute;inset:0;width:100%;height:100%;display:block}
    .milk-gauge-box svg *{vector-effect:non-scaling-stroke;shape-rendering:geometricPrecision}
    .milk-gauge-box .val{position:absolute;bottom:8%;inset-inline:0;text-align:center;font-weight:800;color:#065f46;font-size:clamp(14px,4vw,18px)}
    .legend{display:flex;gap:10px;justify-content:center;font-size:12px;color:#355}
    .leg{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .kpi3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:6px 0 10px}
    @media (max-width:560px){.kpi3{grid-template-columns:1fr}}
    .kpi{border:1px solid var(--border);background:#fcfff8;border-radius:12px;padding:10px;text-align:center}
    .kpi .lbl{font-size:12px;color:#2b593a}
    .kpi .val{font-weight:800;color:#14532d;font-size:clamp(16px,4.6vw,20px)}
    .chart-scroll{overflow-x:auto;overflow-y:hidden;border:1px dashed #c5e1a5;border-radius:12px;background:#fff}
    .prod-chart{display:block;height:240px}
    @media (max-width:560px){.prod-chart{height:200px}}
    .hint{font-size:12px;color:#456;margin-top:6px;text-align:center}
    .hl{display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;align-items:center}
    .hl.head{font-weight:700;color:#0f5132}
    .hl>div{border:1px solid var(--border);background:#fcfff8;border-radius:12px;padding:8px}
    @media (max-width:560px){.hl{grid-template-columns:100px 1fr}}
    @media (max-width:560px){.hl .note{grid-column:1 / -1}}
    .notice{margin:10px 0;padding:10px;border:1px dashed var(--border);background:#fcfff8;border-radius:12px;color:#14532d;font:13px system-ui}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="openbar" id="openbar">
      <small>Ø§ÙØªØ­ Ø¨Ø§Ù„Ø±Ù‚Ù…:</small>
      <input id="openNumber" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 108" />
      <span class="kind-badge">Ø§Ù„Ù†ÙˆØ¹: <span id="kindVal">â€”</span></span>
      <button id="openBtn">ÙØªØ­</button>
    </div>

    <div class="title" aria-label="Ø¹Ù†ÙˆØ§Ù† Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†">
      <h1 id="cardTitle">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø±Ù‚Ù… â€”</h1>
      <div class="chips" role="group" aria-label="Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†">
        <div class="chip chip-repro"  id="chipRepro"  data-variant="ok">â€”</div>
        <div class="chip chip-prod"   id="chipProd"   data-variant="ok">â€”</div>
        <div class="chip chip-health" id="chipHealth" data-variant="ok">â€”</div>
      </div>
    </div>

    <section class="card" aria-label="Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©">
      <h3>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
      <div class="grid" id="basicInfo">
        <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</span><b id="fiBirth">â€”</b></div>
        <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©</span><b id="fiLastCalving">â€”</b></div>
        <div class="fi"><span>Ø±Ù‚Ù… Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨</span><b id="fiLactNo">â€”</b></div>
        <div class="fi"><span>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ DIM</span><b id="fiDIM">â€”</b></div>
        <div class="fi"><span>Ø¹Ù…Ø± Ø§Ù„Ø­Ù…Ù„ (ÙŠÙˆÙ…)</span><b id="fiGestAge">â€”</b></div>
        <div class="fi"><span>Ø§Ù„Ø³Ù„Ø§Ù„Ø©</span><b id="fiBreed">â€”</b></div>
        <div class="fi"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span><b id="fiGroup">â€”</b></div>
      </div>
    </section>

    <section class="card" aria-label="ØªÙ‚ÙŠÙŠÙ… Ø³Ù…Ø§Øª Ø§Ù„Ù„Ø¨Ù†">
      <h3>ØªÙ‚ÙŠÙŠÙ… Ø³Ù…Ø§Øª Ø§Ù„Ù„Ø¨Ù†</h3>
      <div class="milk-gauge-box">
        <svg viewBox="0 0 100 50" preserveAspectRatio="xMidYMid meet">
          <path id="gBg" d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e5e7eb" stroke-width="12" stroke-linecap="round"/>
          <g id="gSlices"></g>
          <g id="needle" transform="rotate(180 50 50)">
            <line x1="50" y1="50" x2="50" y2="14" stroke="#111" stroke-width="1.8" />
            <circle cx="50" cy="50" r="2.2" fill="#111" />
          </g>
        </svg>
        <div class="val" id="milkGaugeVal" aria-live="polite">â€”</div>
      </div>
      <div class="legend" aria-hidden="true">
        <span class="leg"><span class="dot"></span>Ø¶Ø¹ÙŠÙ</span>
        <span class="leg"><span class="dot"></span>Ù…ØªÙˆØ³Ø·</span>
        <span class="leg"><span class="dot"></span>Ø¬ÙŠØ¯</span>
        <span class="leg"><span class="dot"></span>Ù…Ù…ØªØ§Ø²</span>
      </div>
    </section>

    <section class="card" aria-label="Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†">
      <h3>Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†</h3>
      <div class="kpi3">
        <div class="kpi"><div class="lbl">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</div><div class="val" id="kpiMilkToday">â€”</div></div>
        <div class="kpi"><div class="lbl">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù…ÙˆØ³Ù…</div><div class="val" id="kpiSeason">â€”</div></div>
        <div class="kpi"><div class="lbl">Ø¥Ù†ØªØ§Ø¬ 305 ÙŠÙˆÙ…</div><div class="val" id="kpi305">â€”</div></div>
      </div>
      <div class="chart-scroll" id="milkScroll">
        <svg id="milkChart" class="prod-chart" viewBox="0 0 100 60" preserveAspectRatio="none" aria-label="Ù…Ø®Ø·Ø· Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†"></svg>
      </div>
      <div class="hint">ÙŠØ¹Ø±Ø¶ ÙƒØ§Ù…Ù„ ÙØªØ±Ø© Ø§Ù„Ø­Ù„ÙŠØ¨ â€” Ø§Ø³Ø­Ø¨/ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠÙ‹Ø§ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù… (ÙƒØ¬Ù…/ÙŠÙˆÙ…)</div>
    </section>

    <section class="card" aria-label="Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©">
      <h3>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©</h3>
      <div class="grid">
        <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­</span><b id="fiLastIns">â€”</b></div>
        <div class="fi"><span>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† Ø§Ù„ØªÙ„Ù‚ÙŠØ­</span><b id="fiServiceInterval">â€”</b></div>
        <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø´ÙŠØ§Ø¹</span><b id="fiLastHeat">â€”</b></div>
        <div class="fi"><span>Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† Ø§Ù„Ø´ÙŠØ§Ø¹</span><b id="fiHeatInterval">â€”</b></div>
        <div class="fi"><span>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ovsynch</span><b id="fiOvsynch">â€”</b></div>
        <div class="fi"><span>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙ„Ù‚ÙŠØ­</span><b id="fiServicesCount">â€”</b></div>

      </div>
    </section>

    <section class="card" aria-label="Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©">
      <h3>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©</h3>
      <div class="grid">
        <div class="fi"><span>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span><b id="fiHealth">â€”</b></div>
        <div class="fi"><span>Ø¢Ø®Ø± ÙØ­Øµ</span><b id="fiLastCheck">â€”</b></div>
      </div>
      <div style="margin-top:10px">
        <div class="hl head">
          <div>Ø§Ù„ØªØ§Ø±ÙŠØ®</div><div>Ø§Ù„ØªØ´Ø®ÙŠØµ</div><div class="note">Ù…Ù„Ø§Ø­Ø¸Ø©</div>
        </div>
        <div id="healthList"></div>
      </div>
    </section>
  </div>

  <script type="module">
/* ======================= Firebase ======================= */
const fb = await import('/js/firebase-config.js');
if (fb.ensureAuth) await fb.ensureAuth();
const fs = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
const DB = fb.db || fs.getFirestore();
const { collection, doc, getDoc, getDocs, query, where, limit } = fs;
const userNow = fb?.auth?.currentUser || null;   // ensureAuth Ø³Ø¨Ù‚ ÙˆØ§ØªÙ†Ø§Ø¯Ù‰ ÙÙˆÙ‚
const UID = userNow?.uid ?? null;                // Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
const OWN = 'ownerUid';                          // Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
/* ======================= Helpers ======================= */
const $=(id)=>document.getElementById(id);
const put=(id,v)=>{const n=$(id); if(n) n.textContent=(v ?? 'â€”');};
const fmtD=(s)=> s? new Date(s).toLocaleDateString('ar-EG') : 'â€”';
const NF = new Intl.NumberFormat('ar-EG');
const todayStr = new Date().toISOString().slice(0,10);
const url = new URL(location.href);
const openbar=$('openbar'), openInput=$('openNumber'), openBtn=$('openBtn'), kindValEl=$('kindVal');

const normKind=(k)=>{const s=String(k??'').trim().toLowerCase();
  if(/^(cow|Ø¨Ù‚Ø±|Ø¨Ù‚Ø±Ø©)$/.test(s)) return 'cow';
  if(/^(buffalo|Ø¬Ø§Ù…ÙˆØ³|Ø¬Ø§Ù…ÙˆØ³Ù‡|Ø¬Ø§Ù…ÙˆØ³Ø©)$/.test(s)) return 'buffalo';
  return '';
};
const kindNameAr=(k)=> k==='buffalo' ? 'Ø¬Ø§Ù…ÙˆØ³Ø©' : k==='cow' ? 'Ø¨Ù‚Ø±Ø©' : 'Ø­ÙŠÙˆØ§Ù†';
const kindTitleAr=(k)=> k==='buffalo' ? 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø§Ù…ÙˆØ³Ø©' : k==='cow' ? 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù‚Ø±Ø©' : 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†';
// === Normalizers ===
function isDryKeyword(s=''){
  s = String(s).toLowerCase().trim();
  return /(dry\s*-?\s*off|^dry$|Ø¬Ø§Ù(Ø©)?|ØªØ¬ÙÙŠÙ)/i.test(s);
}
function normProdStatus(v){
  if (v == null) return null;
  return isDryKeyword(v) ? 'Ø¬Ø§Ù' : String(v).trim();
}

function isPregKeyword(s=''){
  s = String(s).toLowerCase().trim();
  return /(pregnan|Ø­Ø§Ù…Ù„|Ø¹Ù?Ø´Ø§Ø±|Ø¹Ø´Ø§Ø±|Ø§ÙŠØ¬Ø§Ø¨ÙŠ|Ù…ÙˆØ¬Ø¨)/i.test(s);
}
function normReproStatus(v){
  if (v == null) return null;
  return isPregKeyword(v) ? 'Ø¹ÙØ´Ø§Ø±' : String(v).trim();
}

function normalizeAnimalDoc(d = {}){
  const x = plainify(d); // Ù†ÙÙƒ Ø£ÙŠ Timestamp/Maps Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©

  const normalized = {
    id: x.id,

    // Ø£Ø³Ø§Ø³ÙŠ
    number: x.number ?? x.animalNumber ?? x.no ?? x['Ø±Ù‚Ù…'] ?? null,
    kind: normKind(x.animalType ?? x.kind ?? x.type ?? x['Ø§Ù„Ù†ÙˆØ¹'] ?? x['Ø§Ù„ÙØµÙŠÙ„Ø©'] ?? x.animalTypeAr),
    birthDate: x.birthDate ?? x.birth_date ?? x.dob ?? x['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯'] ?? null,
    lastCalvingDate: x.lastCalvingDate ?? x.lastCalving ?? x.calvingDate ?? x['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©'] ?? null,
    lactationNumber: x.lactationNumber ?? x.lactNo ?? x['Ø±Ù‚Ù… Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨'] ?? null,
    breed: x.breed ?? x.breedName ?? x['Ø§Ù„Ø³Ù„Ø§Ù„Ø©'] ?? null,
    group: x.group ?? x['Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©'] ?? null,

    // ØªÙ†Ø§Ø³Ù„ÙŠ
    pregnancyDate: x.pregnancyDate ?? x.pregnantFrom ?? x['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ù…Ù„'] ?? null,
    reproductiveStatus: normReproStatus(
      x.reproductiveStatus ?? x['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©'] ?? x.reproStatus ?? x.statusRepro
    ) ?? null,
    lastInseminationDate: x.lastInseminationDate ?? x.lastServiceDate ?? x['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­'] ?? null,
    servicesCount: x.servicesCount ?? x.inseminationsCount ?? x.SPC ?? x['Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙ„Ù‚ÙŠØ­'] ?? null,
    estrusDates: x.estrusDates ?? x.heatDates ?? x['ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø´ÙŠØ§Ø¹'] ?? [],
    serviceIntervalDays: x.serviceIntervalDays ?? x.serviceInterval ?? x['Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† Ø§Ù„ØªÙ„Ù‚ÙŠØ­'] ?? null,
    heatIntervalDays: x.heatIntervalDays ?? x.heatInterval ?? x['Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† Ø§Ù„Ø´ÙŠØ§Ø¹'] ?? null,

    // Ø¥Ù†ØªØ§Ø¬
    productionStatus: normProdStatus(
      x.productionStatus ?? x['Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬'] ?? x.prodStatus ?? x.status
    ) ?? null,
    milkTodayKg:   x.milkTodayKg   ?? x.todayMilk      ?? x['Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…']   ?? null,
    seasonTotalKg: x.seasonTotalKg ?? x.milkSeason     ?? x['Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù…ÙˆØ³Ù…']  ?? null,
    m305Kg:        x.m305Kg        ?? x.milk305        ?? x['Ø¥Ù†ØªØ§Ø¬ 305 ÙŠÙˆÙ…'] ?? null,

    // ØµØ­Ø©
    healthStatus:  x.healthStatus  ?? x['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©'] ?? 'Ø³Ù„ÙŠÙ…',
    lastCheckDate: x.lastCheckDate ?? x.healthCheckDate  ?? x['Ø¢Ø®Ø± ÙØ­Øµ'] ?? null,

    // Ø£Ø®Ø±Ù‰
    milkTraitsScore: Number(x.milkTraitsScore ?? x.milk_score ?? 0) || 0,
    ovsynch: x.ovsynch ?? null,
  };

  // Ù†ÙØ¹ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£ØµÙ„ÙŠØ© + Ø§Ù„Ù‚ÙŠÙÙ… Ø§Ù„Ù…ÙˆØ­Ù‘ÙØ¯Ø© (Ø¹Ù„Ø´Ø§Ù† Ù…Ø§ Ù†Ø¶ÙŠÙ‘Ø¹Ø´ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
  return { ...x, ...normalized };
} // â† Ù‡Ù†Ø§ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯Ø§Ù„Ø©


const TYPE_RULES=[
  ['milk', /(daily[_\s-]?milk|milk\s*daily|milk$|Ù„Ø¨Ù†|Ø§Ù†ØªØ§Ø¬)/i],
  ['calving', /(calving|ÙˆÙ„Ø§Ø¯|Ù†ÙØ§Ø³)/i],
  ['insemination', /(insemin|ai\b|a\.i\.|ØªÙ„Ù‚ÙŠØ­|Ø®Ø¯Ù…|Ø®Ø¯Ù…Ø©)/i],
  ['pregnancy', /(pregnan|Ø­Ø§Ù…Ù„|Ø¹Ù?Ø´Ø§Ø±|Ø¹Ø´Ø§Ø±|Ø§ÙŠØ¬Ø§Ø¨ÙŠ|Ù…ÙˆØ¬Ø¨)/i],
  ['heat', /(heat|estrus|Ø´ÙŠØ§Ø¹|Ø´Ø¨Ù‚)/i],
  ['dry', /(dry\s*-?\s*off|^dry$|Ø¬Ø§Ù(Ø©)?|ØªØ¬ÙÙŠÙ)/i],
  ['disease', /(mastitis|lameness|disease|ill|Ù…Ø±Ø¶|Ø§Ù„ØªÙ‡Ø§Ø¨|Ø¹Ø±Ø¬)/i],
];

const evType=(e)=>{const s=String(e.type??e.eventType??e.event??e.name??e.kind??e.category??'').toLowerCase(); for(const [T,rx] of TYPE_RULES) if(rx.test(s)) return T; return 'other';};
const evDate = (e)=>{
  let d = e?.eventDate ?? e?.date ?? e?.day ?? e?.createdAt ?? e?.ts ?? '';
  if (d && typeof d.toDate === 'function') d = d.toDate(); // Ø¯Ø¹Ù… Firestore Timestamp
  const t = d ? new Date(d) : null;
  return t && !isNaN(t) ? t.toISOString().slice(0,10) : '';
};
const toNum=(v)=>{const n=Number(v); return Number.isFinite(n)?n:0;};
function evMilkKg(e){
  const direct=toNum(e.milkKg??e.total??e.kg??e.milk??e.amount); if(direct>0) return direct;
  let sum=0; const partKey=/(^(am|pm|morning|noon|evening|morn|mid|eve)$)|(^milk\d$)|(^milk_(am|pm|morning|noon|evening)$)|(^ØµØ¨Ø§Ø­$|^Ø¸Ù‡Ø±$|^Ù…Ø³Ø§Ø¡$|^Ø­Ù„Ø¨Ø©\d$|^Ø­Ù„Ø¨Ù‡\d$)/i;
  for(const [k,v] of Object.entries(e)) if(partKey.test(k)) sum+=toNum(v); return sum;
}
// ÙŠØ­ÙˆÙ‘Ù„ Ø£ÙŠ Ù‚ÙŠÙ…Ø© (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Firestore Timestamp) Ù„ØµÙŠØºØ© JSON Ø¹Ø§Ø¯ÙŠØ©
// ========= Helpers (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ù…) =========
function plainify(obj){
  if (!obj || typeof obj !== 'object') return obj;
  // Firestore Timestamp â†’ ISO string
  if (typeof obj.toDate === 'function') {
    try { return obj.toDate().toISOString(); } catch { return obj.toString?.() ?? obj; }
  }
  if (Array.isArray(obj)) return obj.map(plainify);
  const out = {};
  for (const [k,v] of Object.entries(obj)) out[k] = plainify(v);
  return out;
}

/* ======================= Firestore ======================= */
async function fetchAnimalByNumber(n){
  if (n == null || String(n).trim() === '') return null;

  const nStr = String(n).trim();
  const nNum = Number(nStr);
  const A = collection(DB, 'animals');

  // (1) Ø¬Ø±Ù‘Ø¨ doc id = Ø§Ù„Ø±Ù‚Ù…
  try {
    const d = await getDoc(doc(DB, 'animals', nStr));
    if (d.exists()) {
      const data = d.data();
      if (!UID || data?.[OWN] === UID) {
        return normalizeAnimalDoc({ id: d.id, ...data });
      }
    }
  } catch {}

  // (2) animalNumber ÙƒÙ€ Number â€” Ù†ÙÙ‘Ø°Ù‡Ø§ ÙÙ‚Ø· Ù„Ùˆ nNum Ø±Ù‚Ù… ØµØ§Ù„Ø­
  if (Number.isFinite(nNum)) {
    try {
      const q1 = UID
        ? query(A, where(OWN,'==',UID), where('animalNumber','==', nNum), limit(1))
        : query(A, where('animalNumber','==', nNum), limit(1));
      const s1 = await getDocs(q1);
      if (!s1.empty) {
        const d = s1.docs[0];
        return normalizeAnimalDoc({ id: d.id, ...d.data() });
      }
    } catch {}
  }

  // (3) animalNumber ÙƒÙ€ String â€” Ø§Ø´Ø·Ø¨Ù‡Ø§ Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ Ø¯Ø§ÙŠÙ…Ù‹Ø§ Number
  try {
    const q2 = UID
      ? query(A, where(OWN,'==',UID), where('animalNumber','==', nStr), limit(1))
      : query(A, where('animalNumber','==', nStr), limit(1));
    const s2 = await getDocs(q2);
    if (!s2.empty) {
      const d = s2.docs[0];
      return normalizeAnimalDoc({ id: d.id, ...d.data() });
    }
  } catch {}

  return null;
}



async function fetchAnimal({number, animalId} = {}) {
  if (animalId) {
    const d = await getDoc(doc(DB,'animals', String(animalId)));
    if (d.exists()) {
      const data = d.data();
      if (!UID || data?.[OWN] === UID) {
        return normalizeAnimalDoc({ id: d.id, ...data });
      }
    }
  }

  const a = await fetchAnimalByNumber(number);
  if (a) return a;

  throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ÙŠÙˆØ§Ù† Ù…Ø·Ø§Ø¨Ù‚');
}


async function fetchEvents(animal){
  const E = collection(DB,'events');
  const rows = [];

  try{
    // Ø­Ø³Ø¨ Ø§Ù„Ù€ id
    if (animal.id) {
      const qById = UID
        ? query(E, where('animalId','==', animal.id), where(OWN,'==', UID))
        : query(E, where('animalId','==', animal.id));
      const sById = await getDocs(qById);
      sById.forEach(d => {
        const r = { id: d.id, ...d.data() };
        if (!UID || r[OWN] === UID) rows.push(r);
      });
    }

    // Ø­Ø³Ø¨ Ø§Ù„Ø±Ù‚Ù… (String Ùˆ Number) ÙˆÙÙŠ Ù…ÙØ§ØªÙŠØ­ Ø¨Ø¯ÙŠÙ„Ø©
    if (animal.number != null) {
      const nStr = String(animal.number), nNum = Number(nStr);

      const baseQs = [
        ...(Number.isFinite(nNum) ? [
          query(E, where('animalNumber','==', nNum)),
          query(E, where('number','==', nNum)),
        ] : []),
        query(E, where('animalNumber','==', nStr)),
        query(E, where('number','==', nStr)),
      ];

      for (const qy of baseQs) {
        const qf = UID ? query(qy, where(OWN,'==', UID)) : qy;
        const s = await getDocs(qf);
        s.forEach(d => {
          const r = { id: d.id, ...d.data() };
          if (!UID || r[OWN] === UID) rows.push(r);
        });
      }
    }
  }catch{}

  const uniq = new Map(rows.map(r => [r.id, r]));
  return [...uniq.values()].sort((a,b)=>(evDate(a)||'').localeCompare(evDate(b)||''));
}


/* ======================= Build state ======================= */
function buildState(animal, events){
  const st = {
    number: animal.number ?? animal.id?.slice(-6),

    // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
    reproductiveStatus: animal.reproductiveStatus || 'â€”',
    productionStatus:   animal.productionStatus   || 'â€”',
    healthStatus:       animal.healthStatus       || 'Ø³Ù„ÙŠÙ…',

    // Ø£Ø³Ø§Ø³ÙŠ
    birthDate:       animal.birthDate       || null,
    lastCalvingDate: animal.lastCalvingDate || null,
    lactationNumber: animal.lactationNumber ?? null,

    // DIM & Ø­Ù…Ù„
    daysInMilk: null,
    gestationDays: null,
    pregnancyDate: animal.pregnancyDate || null,

    // ØªØµÙ†ÙŠÙØ§Øª
    breed: animal.breed || 'â€”',
    group: animal.group || 'â€”',

    // Ø³ÙƒÙˆØ± Ø§Ù„Ù„Ø¨Ù†
    milkTraitsScore: animal.milkTraitsScore ?? 0,

    // ØªÙ†Ø§Ø³Ù„ÙŠ (Ù†Ø¨Ø¯Ø£ Ø¨Ù…Ø§ ÙÙŠ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©)
    inseminations: [],
    estrusDates: Array.isArray(animal.estrusDates) ? [...animal.estrusDates] : [],
    lastInseminationDate: animal.lastInseminationDate ?? null,
    servicesCount: animal.servicesCount ?? null,
    serviceIntervalDays: animal.serviceIntervalDays ?? null,
    heatIntervalDays: animal.heatIntervalDays ?? null,

    // Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† (Ù†Ø¨Ø¯Ø£ Ø¨Ù…Ø§ ÙÙŠ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©)
    milkTodayKg:   animal.milkTodayKg   ?? null,
    seasonTotalKg: animal.seasonTotalKg ?? null,
    m305Kg:        animal.m305Kg        ?? null,
    milkSeries: [],

    // ØµØ­Ø©
    lastCheckDate: animal.lastCheckDate || null,
    healthHistory: [],

    ovsynch: animal.ovsynch || null,
    isDry: false,
  };

  // Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  const milkTmp = [];
  let season = 0;

  for (const e of events) {
    const t = evType(e), d = evDate(e);

    if (t === 'dry')       { st.isDry = true; st.productionStatus = 'Ø¬Ø§Ù'; }
    if (t === 'pregnancy') { st.reproductiveStatus = 'Ø¹ÙØ´Ø§Ø±'; }

    if (t === 'calving' && d) st.lastCalvingDate = d;

    if (t === 'insemination' && d) st.inseminations.push(d);
    if (t === 'heat' && d)         st.estrusDates.push(d);

    if (t === 'pregnancy') {
      st.pregnancyDate = st.pregnancyDate || d || e.pregnancyDate || null;
      st.reproductiveStatus = 'Ø¹ÙØ´Ø§Ø±';
    }

    if (t === 'disease') {
      st.healthHistory.push({
        date: d || '',
        diagnosis: e.diagnosis || e.note || e.eventType || 'â€”',
        note: e.note || ''
      });
      st.healthStatus = 'Ø­Ø§Ù„Ø§Øª ØµØ­ÙŠØ© Ù…Ø³Ø¬Ù„Ø©';
      st.lastCheckDate = st.lastCheckDate || d || null;
    }

    if (t === 'milk') {
      const kg = evMilkKg(e);
      if (kg > 0) {
        season += kg;
        milkTmp.push({ d, kg });
        if (d === todayStr) st.milkTodayKg = kg;
      }
    }
  }

  // Ø¨Ø¹Ø¯ Ù…Ø§ Ø¹Ø±ÙÙ†Ø§ Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©ØŒ Ù†Ø­Ø³Ø¨ DIM
  if (st.lastCalvingDate){
    const ms = Date.now() - new Date(st.lastCalvingDate).getTime();
    st.daysInMilk = Math.max(0, Math.floor(ms / 86400000));
  }

  // ØªÙ†Ø§Ø³Ù„ÙŠ: ØªØ±ØªÙŠØ¨ ÙˆÙ‚ÙŠÙ… Ù…Ø´ØªÙ‚Ø©
  st.inseminations.sort();
  if (!st.lastInseminationDate) st.lastInseminationDate = st.inseminations.at(-1) || null;
  if (st.servicesCount == null) st.servicesCount = st.inseminations.length || null;
  st.estrusDates.sort();

  // Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†: Ù„Ùˆ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù…Ø§ ÙˆÙÙ‘Ø±ØªØ´ Ù‚ÙŠÙ…ØŒ ÙƒÙ…Ù‘Ù„Ù‡Ø§ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  if (st.seasonTotalKg == null) st.seasonTotalKg = season || null;

  if (milkTmp.length){
    const base = st.lastCalvingDate ? new Date(st.lastCalvingDate).getTime() : null;
    st.milkSeries = milkTmp.filter(p=>p.d).map(p=>{
      const di = base ? Math.max(0, Math.floor((new Date(p.d).getTime()-base)/86400000)) : 0;
      return { d: di, v: p.kg };
    }).sort((a,b)=>a.d-b.d);
  }

  // m305 ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ DIM â†’ Ø§Ø­Ø³Ø¨Ù‡ Ù‡Ù†Ø§
  if (st.m305Kg == null && st.daysInMilk > 0 && (st.seasonTotalKg || 0) > 0){
    st.m305Kg = Math.round((st.seasonTotalKg / st.daysInMilk) * 305);
  }

  // Ø£ÙˆÙ„ÙˆÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬
  if (st.isDry) {
    st.productionStatus = 'Ø¬Ø§Ù';
  } else if (!animal.productionStatus && st.daysInMilk != null) {
    st.productionStatus =
      st.daysInMilk < 60  ? 'Ø­Ù„ÙŠØ¨ Ù…Ø¨ÙƒØ±' :
      st.daysInMilk < 200 ? 'Ø­Ù„ÙŠØ¨ Ù…ØªÙˆØ³Ø·' :
                            'Ø­Ù„ÙŠØ¨ Ù…ØªØ£Ø®Ø±';
  }

  return st;
}


/* ======================= UI ======================= */
function arcPath(cx,cy,r,a0,a1){
  const A=(x)=>x*Math.PI/180, P=(ang)=>[cx+r*Math.cos(A(ang)), cy+r*Math.sin(A(ang))];
  const [x0,y0]=P(a0),[x1,y1]=P(a1);
  return`M ${x0.toFixed(3)} ${y0.toFixed(3)} A ${r} ${r} 0 0 1 ${x1.toFixed(3)} ${y1.toFixed(3)}`;
}
function renderGauge(score){
  score=Math.max(0,Math.min(100,Number(score)||0));
  const g=$('gSlices'); if(!g) return; g.innerHTML='';
  const colors=['#ef5350','#ffb74d','#fff176','#66bb6a'], steps=[0,25,50,75,100];
  for(let i=0;i<4;i++){
    const s=steps[i],e=steps[i+1],a0=180-(s/100)*180,a1=180-(e/100)*180;
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',arcPath(50,50,40,a0,a1));
    p.setAttribute('fill','none'); p.setAttribute('stroke',colors[i]);
    p.setAttribute('stroke-width','12'); p.setAttribute('stroke-linecap','round');
    g.appendChild(p);
  }
  const ang=180-(score/100)*180; const needle=$('needle'); if(needle) needle.setAttribute('transform',`rotate(${ang} 50 50)`);
  const label=score>=75?'Ù…Ù…ØªØ§Ø²':score>=50?'Ø¬ÙŠØ¯':score>=25?'Ù…ØªÙˆØ³Ø·':'Ø¶Ø¹ÙŠÙ';
  put('milkGaugeVal',`${label} â€” ${score}%`);
}
function renderMilkChart(series){
  const svg=$('milkChart'), sc=$('milkScroll');
  if(!svg||!sc||!Array.isArray(series)||!series.length){ svg.innerHTML=''; return; }
  const base=Math.max(sc.clientWidth,320), pxPer=Math.max(6,Math.min(11,Math.round(base/28))), pad=10;
  const data=series.map((p,i)=>({x:i,y:Number(p.v)||0})), N=data.length, W=pad*2+(N-1)*pxPer+20;
  svg.setAttribute('viewBox',`0 0 ${W} 60`); svg.style.width=W+'px';
  const maxY=Math.max(...data.map(d=>d.y),1), minY=Math.min(...data.map(d=>d.y),0), yR=Math.max(1,maxY-minY);
  const sx=(i)=>pad+(i*pxPer), sy=(v)=>60-6-((v-minY)*(60-12)/yR);
  svg.innerHTML='';
  const grid=document.createElementNS('http://www.w3.org/2000/svg','g');
  for(let i=1;i<=3;i++){
    const y=6+i*(60-12)/3;
    const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',6); ln.setAttribute('x2',W-6);
    ln.setAttribute('y1',y); ln.setAttribute('y2',y);
    ln.setAttribute('stroke','#e9f5dc'); ln.setAttribute('stroke-width','0.6');
    grid.appendChild(ln);
  }
  svg.appendChild(grid);
  let d=''; data.forEach((p,i)=>{ d+=(i?' L ':'M ')+sx(i).toFixed(2)+' '+sy(p.y).toFixed(2); });
  const area=d+` L ${sx(N-1).toFixed(2)} ${60-6} L ${sx(0).toFixed(2)} ${60-6} Z`;
  const ap=document.createElementNS('http://www.w3.org/2000/svg','path'); ap.setAttribute('d',area); ap.setAttribute('fill','#cdeccd'); ap.setAttribute('opacity','0.6'); svg.appendChild(ap);
  const lp=document.createElementNS('http://www.w3.org/2000/svg','path'); lp.setAttribute('d',d); lp.setAttribute('fill','none'); lp.setAttribute('stroke','#2e7d32'); lp.setAttribute('stroke-width','1.2'); svg.appendChild(lp);
  const cx=sx(N-1), cy=sy(data[N-1].y); const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
  dot.setAttribute('cx',cx); dot.setAttribute('cy',cy); dot.setAttribute('r',2); dot.setAttribute('fill','#1b5e20'); svg.appendChild(dot);
  setTimeout(()=>{ sc.scrollLeft=svg.scrollWidth; },0);
  addEventListener('resize',()=>renderMilkChart(series),{once:true});
}
function avgDaysBetween(dts){ if(!dts||dts.length<2) return null;
  const ms=dts.map(d=>new Date(d).getTime()).sort((a,b)=>a-b);
  const dif=[]; for(let i=1;i<ms.length;i++) dif.push((ms[i]-ms[i-1])/86400000);
  return Math.round(dif.reduce((a,b)=>a+b,0)/dif.length);
}
function setChip(el,text){ if(!el) return; const t=String(text||'').toLowerCase(); let v='ok';
  if(/Ù…ÙØªÙˆØ­|Ø®Ø·Ø± Ù…Ù†Ø®ÙØ¶|Ù…ØªÙˆØ³Ø·/.test(t)) v='warn'; if(/Ø­Ø§Ø¯|Ø´Ø¯ÙŠØ¯|Ù…Ø±Ø¶|Ù†ÙØ§Ø³ Ù…ØªØ¹Ø«Ø±/.test(t)) v='danger';
  el.textContent=text||'â€”'; el.setAttribute('data-variant',v);
}
function renderCard(state, kind){
  $('cardTitle').textContent = `${kindTitleAr(kind)} Ø±Ù‚Ù… ${state.number ?? 'â€”'}`;
  setChip($('chipRepro'),state.reproductiveStatus); setChip($('chipProd'),state.productionStatus); setChip($('chipHealth'),state.healthStatus);
  put('fiBirth',fmtD(state.birthDate)); put('fiLastCalving',fmtD(state.lastCalvingDate));
  put('fiLactNo',state.lactationNumber!=null?NF.format(state.lactationNumber):'â€”');
  const hideDIM = state.isDry || state.productionStatus === 'Ø¬Ø§Ù';
  put('fiDIM', (!hideDIM && state.daysInMilk!=null) ? NF.format(state.daysInMilk) : 'â€”');
  let g=state.gestationDays, ref=state.pregnancyDate||state.lastInseminationDate;
  if(g==null&&ref){const ms=Date.now()-new Date(ref).getTime(); g=Math.max(0,Math.floor(ms/86400000));}
  put('fiGestAge',g!=null?NF.format(g):'â€”'); put('fiBreed',state.breed||'â€”'); put('fiGroup',state.group||'â€”');
  renderGauge(state.milkTraitsScore);
  put('kpiMilkToday',state.milkTodayKg!=null?`${Number(state.milkTodayKg).toFixed(1)} ÙƒØ¬Ù…`:'â€”');
  put('kpiSeason',state.seasonTotalKg!=null?`${NF.format(Math.round(state.seasonTotalKg))} ÙƒØ¬Ù…`:'â€”');
  put('kpi305',state.m305Kg!=null?`${NF.format(Math.round(state.m305Kg))} ÙƒØ¬Ù…`:'â€”');
  renderMilkChart(state.milkSeries);
  put('fiLastIns',fmtD(state.lastInseminationDate));
  const spc = state.servicesCount;
  put('fiServicesCount', spc != null ? NF.format(spc) : 'â€”');
  const svcI = state.serviceIntervalDays ?? avgDaysBetween(state.inseminations);
  put('fiServiceInterval', svcI != null ? `${NF.format(svcI)} ÙŠÙˆÙ…` : 'â€”');
  const lastHeat=(state.estrusDates&&state.estrusDates.length)?state.estrusDates.at(-1):null; put('fiLastHeat',fmtD(lastHeat));
  const hI = state.heatIntervalDays ?? avgDaysBetween(state.estrusDates);
  put('fiHeatInterval', hI != null ? `${NF.format(hI)} ÙŠÙˆÙ…` : 'â€”');
  put('fiHealth',state.healthStatus||'â€”'); put('fiLastCheck',fmtD(state.lastCheckDate));
  const hl=$('healthList'); hl.innerHTML='';
  if(Array.isArray(state.healthHistory)&&state.healthHistory.length){
    state.healthHistory.slice(-6).forEach(it=>{
      const row=document.createElement('div'); row.className='hl';
      const d=document.createElement('div'); d.textContent=fmtD(it.date);
      const dx=document.createElement('div'); dx.textContent=it.diagnosis||'â€”';
      const nt=document.createElement('div'); nt.className='note'; nt.textContent=it.note||'';
      row.appendChild(d); row.appendChild(dx); row.appendChild(nt); hl.appendChild(row);
    });
  } else {
    const row=document.createElement('div'); row.className='hl';
    ['â€”','Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª',''].forEach((t,i)=>{const c=document.createElement('div'); if(i===2)c.className='note'; c.textContent=t; row.appendChild(c);});
    hl.appendChild(row);
  }
}

/* ======================= Load & Run ======================= */
async function loadAndRender({number, animalId, type}){
  try{
    let kind = normKind(type);
    const animal = await fetchAnimal({number, animalId});
    if(!kind) kind = animal.kind || normKind(localStorage.getItem('lastKind'));
    if(kind){ localStorage.setItem('lastKind',kind); if(kindValEl) kindValEl.textContent = kindNameAr(kind); }

    if (animal.id) localStorage.setItem('currentAnimalId', String(animal.id));
    if (animal.number!=null) {
      localStorage.setItem('currentAnimalNumber', String(animal.number));
      localStorage.setItem('lastAnimalNumber', String(animal.number));
    }

    const events = await fetchEvents(animal);
    const state  = buildState(animal, events);

    if(!events.length){
      const tip=document.createElement('div'); tip.className='notice';
      tip.innerHTML=`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯. <a href="/add-event.html?number=${encodeURIComponent(state.number||'')}" style="font-weight:700;color:#1b5e20">Ø£Ø¶Ù Ø£ÙˆÙ„ Ø­Ø¯Ø« Ø§Ù„Ø¢Ù†</a>.`;
      document.querySelector('.wrap')?.prepend(tip);
    }
    renderCard(state, kind);
  }catch(e){
    console.error(e);
    $('cardTitle').textContent='ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†';
  }
}

const numberParam = url.searchParams.get('number') || url.searchParams.get('animalNumber') || '';
const idParam     = url.searchParams.get('animalId') || '';
const typeParam   = (url.searchParams.get('type') || url.searchParams.get('kind') || url.searchParams.get('animaltype') || '').toLowerCase();

if (numberParam || idParam){
  if (openbar) openbar.style.display='none';
  if (typeParam && kindValEl) kindValEl.textContent = kindNameAr(normKind(typeParam));
  loadAndRender({number:numberParam, animalId:idParam, type:typeParam});
} else {
  const lastNum = localStorage.getItem('currentAnimalNumber') || localStorage.getItem('lastAnimalNumber') || '';
  if(lastNum && openInput){ openInput.value=lastNum; }
  if(openBtn){ openBtn.addEventListener('click', ()=>{ const n=(openInput.value||'').trim(); if(!n) return; loadAndRender({number:n}); }); }
}
  </script>
</body>
</html>
