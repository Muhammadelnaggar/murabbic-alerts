<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Murabbik â€“ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</title>
  <style>
    /* Ø£Ù„ÙˆØ§Ù† Ù†Ù‚Ø§Ø· Ø§Ù„Ù„ÙŠØ¬Ù†Ø¯ Ù„Ù„Ø¬ÙˆØ¬ */
.legend .leg:nth-child(1) .dot{background:#ef5350}
.legend .leg:nth-child(2) .dot{background:#ffb74d}
.legend .leg:nth-child(3) .dot{background:#fff176}
.legend .leg:nth-child(4) .dot{background:#66bb6a}

/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ± */
.ev-scroll{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
.ev-table{width:100%;border-collapse:separate;border-spacing:0}
.ev-table th,.ev-table td{padding:10px;border-bottom:1px solid var(--border);font:13px system-ui;vertical-align:top}
.ev-table thead th{position:sticky;top:0;background:#f8fff5;z-index:1;text-align:right}
.ev-table tr:hover td{background:#f7fff2}
.ev-date{white-space:nowrap;color:#0f5132;font-weight:700}
.ev-type{color:#14532d;font-weight:800}
.ev-note{color:#355}

    :root{--bg:#fffdf5;--card:#ffffff;--border:#d9efd0;--ink:#134e35;--muted:#f7fff2;--acc:#2e7d32}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.45;color:var(--ink);padding:18px}
    .wrap{max-width:980px;margin:0 auto}
    .openbar{display:flex;gap:8px;align-items:center;justify-content:center;margin:0 0 12px;flex-wrap:wrap}
    .openbar small{opacity:.8}
    .openbar input{width:160px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fcfff8}
    .openbar button{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#e8f5e9;color:#1b5e20;font-weight:700;cursor:pointer}
    .kind-badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fcfff8;font-weight:700}
    .title{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;margin:0 0 12px}
    .title h1{margin:0;font-size:clamp(18px,4.6vw,28px);color:#14532d}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:700;font-size:13px;color:#0f5132}
    .chip[data-variant="ok"]{background:#e8f5e9;border-color:#c8e6c9;color:#1b5e20}
    .chip[data-variant="warn"]{background:#fff8e1;border-color:#ffe0b2;color:#7a4f00}
    .chip[data-variant="danger"]{background:#ffebee;border-color:#ffcdd2;color:#7f1d1d}
    .chip-repro::before{content:"ğŸ¼ ";} .chip-prod::before{content:"ğŸ“ˆ ";} .chip-health::before{content:"ğŸ©º ";}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .card h3{margin:0 0 10px;color:#17623b;font-size:18px}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .fi{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fcfff8}
    .fi span{color:#2b593a;font-size:13px}
    .fi b{color:#0f5132;direction:ltr;unicode-bidi:plaintext;font-variant-numeric:tabular-nums;word-break:break-word}

    .milk-gauge-box{width:min(360px,92vw);aspect-ratio:2/1;position:relative;margin:8px auto;display:grid;place-items:center}
    .milk-gauge-box svg{position:absolute;inset:0;width:100%;height:100%;display:block}
    .milk-gauge-box svg *{vector-effect:non-scaling-stroke;shape-rendering:geometricPrecision}
    .milk-gauge-box .val{position:absolute;bottom:8%;inset-inline:0;text-align:center;font-weight:800;color:#065f46;font-size:clamp(14px,4vw,18px)}
    .legend{display:flex;gap:10px;justify-content:center;font-size:12px;color:#355}
    .leg{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}

    .kpi3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:6px 0 10px}
    @media (max-width:560px){.kpi3{grid-template-columns:1fr}}
    .kpi{border:1px solid var(--border);background:#fcfff8;border-radius:12px;padding:10px;text-align:center}
    .kpi .lbl{font-size:12px;color:#2b593a}
    .kpi .val{font-weight:800;color:#14532d;font-size:clamp(16px,4.6vw,20px)}

    .chart-scroll{overflow-x:auto;overflow-y:hidden;border:1px dashed #c5e1a5;border-radius:12px;background:#fff}
    .prod-chart{display:block;height:240px}
    @media (max-width:560px){.prod-chart{height:200px}}
    .hint{font-size:12px;color:#456;margin-top:6px;text-align:center}

    .hl{display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;align-items:center}
    .hl.head{font-weight:700;color:#0f5132}
    .hl>div{border:1px solid var(--border);background:#fcfff8;border-radius:12px;padding:8px}
    @media (max-width:560px){.hl{grid-template-columns:100px 1fr}}
    @media (max-width:560px){.hl .note{grid-column:1 / -1}}

    .notice{margin:10px 0;padding:10px;border:1px dashed var(--border);background:#fcfff8;border-radius:12px;color:#14532d;font:13px system-ui}
    /* ØµÙ ÙˆØ§Ø­Ø¯ Ø¸Ø§Ù‡Ø± + Ø±Ø£Ø³ Ù…Ø«Ø¨Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width:560px){
  .ev-scroll{ overflow:auto; }
  .ev-table{ table-layout: fixed; }
  .ev-table thead th{ position: sticky; top: 0; z-index:1; }

  .ev-table th, .ev-table td{
    padding:10px 8px;       /* Ø£ÙƒØ¨Ø± */
    font-size:13px;         /* Ø£ÙˆØ¶Ø­ */
    line-height:1.45;
  }

  /* Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø§Ø³Ù…: Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù…Ø¹ ellipsis */
  .ev-date, .ev-type{
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* Ø§Ù„ØªÙØ§ØµÙŠÙ„/Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø³Ø·Ø±ÙŠÙ† Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ø±ÙŠØ­Ø© */
  .ev-note{
    white-space:normal;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }
}

/* === Timeline (Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­ÙŠÙˆØ§Ù†) === */
.timeline-card{position:relative}
.tl-wrap{overflow-x:auto; overflow-y:hidden; border:1px solid var(--border); border-radius:12px; background:#fff;}
.tl-svg{display:block; height:120px; /* ÙŠØªÙƒÙŠÙ‘Ù Ø£ÙÙ‚ÙŠÙ‹Ø§ */ }
/* Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙŠØ¬Ù†Ø¯ ØªÙ…Ø§Ù…Ù‹Ø§ */
.tl-legend{display:none}

.tl-legend .leg{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#fcfff8}
.tl-dot{cursor:pointer}
.tl-tooltip{
  position:absolute; /* Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… inset Ù‡Ù†Ø§ */
  transform:translate(-50%,-8px);
  background:#0b3d2a; color:#fff; border-radius:8px; padding:8px 10px; font:12px/1.4 system-ui;
  box-shadow:0 6px 18px rgba(0,0,0,.18); pointer-events:none; z-index:50; display:none; max-width:min(80vw,320px)
}

.tl-tooltip b{display:block; font-weight:800; margin-bottom:4px}
.tl-date{opacity:.9; font-variant-numeric:tabular-nums}

/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†Ù‚Ø§Ø· Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø« */
:root{
  --tl-milk:#2e7d32; --tl-calving:#1b5e20; --tl-insem:#0d9488; --tl-preg:#a16207;
  --tl-heat:#ef6c00; --tl-dry:#6b7280; --tl-disease:#c62828; --tl-other:#4b5563;
}
/* Ø¥Ø¨Ø±Ø§Ø² ØµÙ Ø§Ù„Ø­Ø¯Ø« Ø¹Ù†Ø¯ Ø§Ù„Ù‚ÙØ² Ù…Ù† Ø§Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ† */
.ev-row--focus{
  outline:2px solid #2e7d32;
  background:#f1faee !important;
  transition: background .4s ease;
}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="openbar" id="openbar">
      <small>Ø§ÙØªØ­ Ø¨Ø§Ù„Ø±Ù‚Ù…:</small>
      <input id="openNumber" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 108" />
      <span class="kind-badge">Ø§Ù„Ù†ÙˆØ¹: <span id="kindVal">â€”</span></span>
      <button id="openBtn">ÙØªØ­</button>
    </div>

    <div class="title" aria-label="Ø¹Ù†ÙˆØ§Ù† Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†">
      <h1 id="cardTitle">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø±Ù‚Ù… â€”</h1>
      <div class="chips" role="group" aria-label="Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†">
        <div class="chip chip-repro"  id="chipRepro"  data-variant="ok">â€”</div>
        <div class="chip chip-prod"   id="chipProd"   data-variant="ok">â€”</div>
        <div class="chip chip-health" id="chipHealth" data-variant="ok">â€”</div>
      </div>
    </div>

   <section class="card" aria-label="Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©">
  <h3>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
  <div class="grid" id="basicInfo">
    <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</span><b id="fiBirth">â€”</b></div>
    <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©</span><b id="fiLastCalving">â€”</b></div>
    <div class="fi"><span>Ø±Ù‚Ù… Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨</span><b id="fiLactNo">â€”</b></div>
    <div class="fi"><span>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ DIM</span><b id="fiDIM">â€”</b></div>
    <div class="fi"><span>Ø¹Ù…Ø± Ø§Ù„Ø­Ù…Ù„ (ÙŠÙˆÙ…)</span><b id="fiGestAge">â€”</b></div>
    <div class="fi"><span>Ø§Ù„Ø³Ù„Ø§Ù„Ø©</span><b id="fiBreed">â€”</b></div>
    <div class="fi"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span><b id="fiGroup">â€”</b></div>
  </div>
</section>

<section class="card timeline-card" aria-label="Ø§Ù„Ø®Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ø£Ø­Ø¯Ø§Ø«">
  <h3>Ø§Ù„Ø®Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ</h3>
  <div class="tl-wrap" id="timelineBox">
    </div> <!-- ÙŠÙØ±Ø³Ù… SVG Ù‡Ù†Ø§ -->
 
  <div class="tl-tooltip" id="tlTip" role="status" aria-live="polite"></div>
  <div class="hint">Ø§Ø³Ø­Ø¨ Ø£ÙÙ‚ÙŠØ§Ù‹ Ù„Ù„ØªÙ†Ù‚Ù„ â€” Ø§Ø¶ØºØ·/Ø§Ù„Ù…Ø³ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø«.</div>
</section>

    <section class="card" aria-label="ØªÙ‚ÙŠÙŠÙ… Ø³Ù…Ø§Øª Ø§Ù„Ù„Ø¨Ù†">
      <h3>ØªÙ‚ÙŠÙŠÙ… Ø³Ù…Ø§Øª Ø§Ù„Ù„Ø¨Ù†</h3>
      <div class="milk-gauge-box">
        <svg viewBox="0 0 100 50" preserveAspectRatio="xMidYMid meet">
          <path id="gBg" d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e5e7eb" stroke-width="12" stroke-linecap="round"/>
          <g id="gSlices"></g>
          <g id="needle" transform="rotate(180 50 50)">
            <line x1="50" y1="50" x2="50" y2="14" stroke="#111" stroke-width="1.8" />
            <circle cx="50" cy="50" r="2.2" fill="#111" />
          </g>
        </svg>
        <div class="val" id="milkGaugeVal" aria-live="polite">â€”</div>
      </div>
      <div class="legend" aria-hidden="true">
        <span class="leg"><span class="dot"></span>Ø¶Ø¹ÙŠÙ</span>
        <span class="leg"><span class="dot"></span>Ù…ØªÙˆØ³Ø·</span>
        <span class="leg"><span class="dot"></span>Ø¬ÙŠØ¯</span>
        <span class="leg"><span class="dot"></span>Ù…Ù…ØªØ§Ø²</span>
      </div>
    </section>

    <section class="card" aria-label="Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†">
      <h3>Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†</h3>
      <div class="kpi3">
        <div class="kpi"><div class="lbl">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</div><div class="val" id="kpiMilkToday">â€”</div></div>
        <div class="kpi"><div class="lbl">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù…ÙˆØ³Ù…</div><div class="val" id="kpiSeason">â€”</div></div>
        <div class="kpi"><div class="lbl">Ø¥Ù†ØªØ§Ø¬ 305 ÙŠÙˆÙ…</div><div class="val" id="kpi305">â€”</div></div>
      </div>
      <div class="chart-scroll" id="milkScroll">
        <svg id="milkChart" class="prod-chart" viewBox="0 0 100 60" preserveAspectRatio="none" aria-label="Ù…Ø®Ø·Ø· Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†"></svg>
      </div>
      <div class="hint">ÙŠØ¹Ø±Ø¶ ÙƒØ§Ù…Ù„ ÙØªØ±Ø© Ø§Ù„Ø­Ù„ÙŠØ¨ â€” Ø§Ø³Ø­Ø¨/ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠÙ‹Ø§ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù… (ÙƒØ¬Ù…/ÙŠÙˆÙ…)</div>
    </section>

    <section class="card" aria-label="Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©">
      <h3>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©</h3>
      <div class="grid">
        <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­</span><b id="fiLastIns">â€”</b></div>
        <div class="fi"><span>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† Ø§Ù„ØªÙ„Ù‚ÙŠØ­</span><b id="fiServiceInterval">â€”</b></div>
        <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø´ÙŠØ§Ø¹</span><b id="fiLastHeat">â€”</b></div>
        <div class="fi"><span>Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† Ø§Ù„Ø´ÙŠØ§Ø¹</span><b id="fiHeatInterval">â€”</b></div>
        <div class="fi"><span>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ovsynch</span><b id="fiOvsynch">â€”</b></div>
        <div class="fi"><span>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙ„Ù‚ÙŠØ­</span><b id="fiServicesCount">â€”</b></div>
      </div>
    </section>

    <section class="card" aria-label="Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©">
      <h3>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©</h3>
      <div class="grid">
        <div class="fi"><span>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span><b id="fiHealth">â€”</b></div>
        <div class="fi"><span>Ø¢Ø®Ø± ÙØ­Øµ</span><b id="fiLastCheck">â€”</b></div>
      </div>
      <div style="margin-top:10px">
      
        <div id="healthList"></div>
      </div>
    </section>

    
    <!-- Ø¬Ø¯ÙŠØ¯: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø© -->
 <section class="card" aria-label="Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø©">
  <h3>Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø©</h3>
  <div id="evList"></div>
</section>
</div> 

  <script type="module">
/* ======================= Firebase ======================= */
const fb = await import('/js/firebase-config.js');
if (fb.ensureAuth) await fb.ensureAuth();
const fs = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
const DB = fb.db || fs.getFirestore(); // ÙŠÙØªØ±Ø¶ Ø£Ù† fb.db = getFirestore(app,'murabbikdata')
const { collection, doc, getDoc, getDocs, query, where, limit } = fs;
const userNow = fb?.auth?.currentUser || null;
const UID = userNow?.uid ?? null;
// Ø«ÙˆØ§Ø¨Øª Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
const ANIM_OWNER_FIELD = 'ownerUid'; // ÙÙŠ animals
const EVENT_USER_FIELD = 'userId';   // ÙÙŠ events

// Ù…Ø³Ø§Ø¹Ø¯ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¯Ø«
const evDate = (e={}) =>
  e.eventDate ||
  e.date ||
  e.day ||
  (e.createdAt?.toDate?.()?.toISOString?.().slice(0,10)) ||
  (e.createdAt instanceof Date ? e.createdAt.toISOString().slice(0,10) : null);

// Ù‡Ù†Ø§ØŸ
/* ======================= Helpers ======================= */
const $=(id)=>document.getElementById(id);
const put=(id,v)=>{const n=$(id); if(n) n.textContent=(v ?? 'â€”');};
const fmtD=(s)=> s? new Date(s).toLocaleDateString('ar-EG') : 'â€”';
const NF = new Intl.NumberFormat('ar-EG');
const todayStr = new Date().toISOString().slice(0,10);
const url = new URL(location.href);
const openbar=$('openbar'), openInput=$('openNumber'), openBtn=$('openBtn'), kindValEl=$('kindVal');
// ÙŠÙ‚Ø±Ø£ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© (80 Ø£Ùˆ "80%") ÙˆÙŠÙ‚ÙÙ„Ù‡Ø§ Ø¨ÙŠÙ† 0..100
// ÙŠÙ‚Ø±Ø£ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© (80 Ø£Ùˆ "80%" Ø£Ùˆ 0.78) ÙˆÙŠÙ‚ÙÙ„Ù‡Ø§ 0..100
const toPercent = (v)=>{
  if (v == null) return 0;
  let n = (typeof v === 'string')
    ? parseFloat(v.replace(/[^\d.-]+/g,''))   // ÙŠØ´ÙŠÙ„ Ø£ÙŠ Ø±Ù…ÙˆØ² ØºÙŠØ± Ø£Ø±Ù‚Ø§Ù…/Ø¹Ù„Ø§Ù…Ø© Ø¹Ø´Ø±ÙŠØ©
    : Number(v);

  if (!Number.isFinite(n)) return 0;

  // Ù„Ùˆ Ù…ÙƒØªÙˆØ¨Ø© ÙƒØ³Ù„Ø³Ù„Ø© ÙˆÙÙŠÙ‡Ø§ % Ù†Ø³ÙŠØ¨Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠØŒ ØºÙŠØ± ÙƒØ¯Ù‡ Ù„Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø¨ÙŠÙ† 0 Ùˆ1 Ù†Ø¹ØªØ¨Ø±Ù‡ ÙƒØ³Ø±ÙŠ ÙˆÙ†Ø­ÙˆÙ‘Ù„Ù‡ Ù„Ù…ÙŠØ©
  if (typeof v === 'string' && v.includes('%')) {
    // n ÙƒÙ…Ø§ Ù‡Ùˆ
  } else if (n >= 0 && n <= 1) {
    n = n * 100;
  }

  return Math.max(0, Math.min(100, Math.round(n)));
};


// ÙŠØ¬ÙŠØ¨ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªØ±Ø§Ø¹Ø§Øª
// Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø­Ø¯Ø« Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¥Ù† ÙˆÙØ¬Ø¯ØŒ Ø«Ù… Ø£ÙŠ Ø§Ø³Ù… Ù…ØªØ§Ø­ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ±Ø¬Ù…Ø©
function eventNameRaw(e = {}) {
  const pick = (obj, keys)=>{
    for (const k of keys) {
      const v = obj?.[k];
      if (v != null && String(v).trim() !== '') return String(v).trim();
    }
    return null;
  };

  // Ø£ÙØ¶Ù„ÙŠØ© Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª/Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
  const ar = pick(e, [
    'Ø§Ø³Ù…_Ø§Ù„Ø­Ø¯Ø«','Ø§Ø³Ù…','Ø¹Ù†ÙˆØ§Ù†','Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø¹Ù†ÙˆØ§Ù†_Ø§Ù„ØµÙØ­Ø©',
    'pageTitleAr','page_name_ar','page_ar','eventNameAr',
    'nameAr','titleAr','labelAr','Ù†ÙˆØ¹_Ø§Ù„Ø­Ø¯Ø«','Ø§Ù„ØªØ´Ø®ÙŠØµ'
  ]);
  if (ar) return ar;

  // ÙˆØ¥Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø£ÙŠ Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
  return pick(e, ['name','title','eventName','label','type','eventType','kind','category']) ?? 'â€”';
}


const normKind=(k)=>{const s=String(k??'').trim().toLowerCase();
  if(/^(cow|Ø¨Ù‚Ø±|Ø¨Ù‚Ø±Ø©)$/.test(s)) return 'cow';
  if(/^(buffalo|Ø¬Ø§Ù…ÙˆØ³|Ø¬Ø§Ù…ÙˆØ³Ù‡|Ø¬Ø§Ù…ÙˆØ³Ø©)$/.test(s)) return 'buffalo';
  return '';
};
const kindNameAr=(k)=> k==='buffalo' ? 'Ø¬Ø§Ù…ÙˆØ³Ø©' : k==='cow' ? 'Ø¨Ù‚Ø±Ø©' : 'Ø­ÙŠÙˆØ§Ù†';
const kindTitleAr=(k)=> k==='buffalo' ? 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø§Ù…ÙˆØ³Ø©' : k==='cow' ? 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù‚Ø±Ø©' : 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†';

function isDryKeyword(s=''){s=String(s).toLowerCase().trim();return /(dry\s*-?\s*off|^dry$|Ø¬Ø§Ù(Ø©)?|ØªØ¬ÙÙŠÙ)/i.test(s);}
function normProdStatus(v){if(v==null) return null; return isDryKeyword(v)?'Ø¬Ø§Ù':String(v).trim();}

function isPregKeyword(s=''){s=String(s).toLowerCase().trim();return /(pregnan|Ø­Ø§Ù…Ù„|Ø¹Ù?Ø´Ø§Ø±|Ø¹Ø´Ø§Ø±|Ø§ÙŠØ¬Ø§Ø¨ÙŠ|Ù…ÙˆØ¬Ø¨)/i.test(s);}
function normReproStatus(v){if(v==null) return null; return isPregKeyword(v)?'Ø¹ÙØ´Ø§Ø±':String(v).trim();}

// ÙŠØ­ÙˆÙ‘Ù„ Ø£ÙŠ Timestamp/Maps Ø¥Ù„Ù‰ JSON Ø¨Ø³ÙŠØ·
function plainify(obj){
  if (!obj || typeof obj !== 'object') return obj;
  if (typeof obj.toDate === 'function') { try { return obj.toDate().toISOString(); } catch { return obj.toString?.() ?? obj; } }
  if (Array.isArray(obj)) return obj.map(plainify);
  const out = {}; for (const [k,v] of Object.entries(obj)) out[k]=plainify(v); return out;
}

function normalizeAnimalDoc(d = {}){
  const x = plainify(d);
  const normalized = {
    id: x.id,

    // Ø£Ø³Ø§Ø³ÙŠ
    number: x.number ?? x.animalNumber ?? x.no ?? x['Ø±Ù‚Ù…'] ?? null,
    kind: normKind(x.animalType ?? x.kind ?? x.type ?? x['Ø§Ù„Ù†ÙˆØ¹'] ?? x['Ø§Ù„ÙØµÙŠÙ„Ø©'] ?? x.animalTypeAr),
    birthDate: x.birthDate ?? x.birth_date ?? x.dob ?? x['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯'] ?? null,
    lastCalvingDate: x.lastCalvingDate ?? x.lastCalving ?? x.calvingDate ?? x['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©'] ?? null,
    lactationNumber: x.lactationNumber ?? x.lactNo ?? x['Ø±Ù‚Ù… Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨'] ?? null,
    breed: x.breed ?? x.breedName ?? x['Ø§Ù„Ø³Ù„Ø§Ù„Ø©'] ?? null,
    group: x.group ?? x['Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©'] ?? null,

    // ØªÙ†Ø§Ø³Ù„ÙŠ
    pregnancyDate: x.pregnancyDate ?? x.pregnantFrom ?? x['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ù…Ù„'] ?? null,
    reproductiveStatus: normReproStatus(x.reproductiveStatus ?? x['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©'] ?? x.reproStatus ?? x.statusRepro) ?? null,
    lastInseminationDate: x.lastInseminationDate ?? x.lastServiceDate ?? x['ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­'] ?? null,
    servicesCount: x.servicesCount ?? x.inseminationsCount ?? x.SPC ?? x['Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙ„Ù‚ÙŠØ­'] ?? null,
    estrusDates: x.estrusDates ?? x.heatDates ?? x['ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø´ÙŠØ§Ø¹'] ?? [],
    serviceIntervalDays: x.serviceIntervalDays ?? x.serviceInterval ?? x['Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† Ø§Ù„ØªÙ„Ù‚ÙŠØ­'] ?? null,
    heatIntervalDays: x.heatIntervalDays ?? x.heatInterval ?? x['Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† Ø§Ù„Ø´ÙŠØ§Ø¹'] ?? null,

    // Ø¥Ù†ØªØ§Ø¬
    productionStatus: normProdStatus(x.productionStatus ?? x['Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬'] ?? x.prodStatus ?? x.status) ?? null,
    milkTodayKg:   x.milkTodayKg   ?? x.todayMilk   ?? x.dailyMilk   ?? x.daily_milk   ?? x['Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…']   ?? null,
    seasonTotalKg: x.seasonTotalKg ?? x.milkSeason     ?? x['Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù…ÙˆØ³Ù…']  ?? null,
    m305Kg:        x.m305Kg        ?? x.milk305        ?? x['Ø¥Ù†ØªØ§Ø¬ 305 ÙŠÙˆÙ…'] ?? null,

    // ØµØ­Ø©
    healthStatus:  x.healthStatus  ?? x['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©'] ?? 'Ø³Ù„ÙŠÙ…',
    lastCheckDate: x.lastCheckDate ?? x.healthCheckDate  ?? x['Ø¢Ø®Ø± ÙØ­Øµ'] ?? null,

    // Ø£Ø®Ø±Ù‰
   milkTraitsScore: toPercent(x.milkTraitsScore ?? x.milk_score ?? 0),
    ovsynch: x.ovsynch ?? null,
  };
  return { ...x, ...normalized };
}

const TYPE_RULES = [
  ['milk', /(daily[_\s-]?milk|milk\s*daily|milk$|Ù„Ø¨Ù†|Ø§Ù†ØªØ§Ø¬)/i],
  ['calving', /(calving|ÙˆÙ„Ø§Ø¯|Ù†ÙØ§Ø³)/i],
  ['insemination', /(insemin|ai\b|a\.i\.|ØªÙ„Ù‚ÙŠØ­|Ø®Ø¯Ù…|Ø®Ø¯Ù…Ø©)/i],
  ['pregnancy', /(pregnan|Ø­Ø§Ù…Ù„|Ø¹Ù?Ø´Ø§Ø±|Ø¹Ø´Ø§Ø±|Ø§ÙŠØ¬Ø§Ø¨ÙŠ|Ù…ÙˆØ¬Ø¨)/i],
  ['heat', /(heat|estrus|Ø´ÙŠØ§Ø¹|Ø´Ø¨Ù‚)/i],
  ['dry', /(dry\s*-?\s*off|^dry$|Ø¬Ø§Ù(Ø©)?|ØªØ¬ÙÙŠÙ)/i],
  ['disease', /(mastitis|lameness|disease|ill|Ù…Ø±Ø¶|Ø§Ù„ØªÙ‡Ø§Ø¨|Ø¹Ø±Ø¬)/i],
];

// Ù…ÙØ§ØªÙŠØ­ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø­Ù„Ø¨ (AM/PM... Ø¥Ù„Ø®)
const MILK_PART_KEY =
  /(^(am|pm|morning|noon|evening|morn|mid|eve)$)|(^milk\d$)|(^milk_(am|pm|morning|noon|evening)$)|(^ØµØ¨Ø§Ø­$|^Ø¸Ù‡Ø±$|^Ù…Ø³Ø§Ø¡$|^Ø­Ù„Ø¨Ø©\d$|^Ø­Ù„Ø¨Ù‡\d$)/i;

// Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† (ØªØ´Ù…Ù„ dailyMilk)
const MILK_DIRECT_KEYS = ['dailyMilk','daily_milk','milkKg','total','kg','milk','amount'];

const toNum = (v) => { const n = Number(v); return Number.isFinite(n) ? n : 0; };

const evType = (e = {}) => {
  const s = String(e.type ?? e.eventType ?? e.event ?? e.name ?? e.kind ?? e.category ?? '').toLowerCase();
  for (const [T, rx] of TYPE_RULES) if (rx.test(s)) return T;

  // Fallback: Ù„Ùˆ ÙÙŠÙ‡ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù„Ø¨Ù† Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ Ø£Ø¬Ø²Ø§Ø¡ Ù„Ø¨Ù†ØŒ Ø§Ø¹ØªØ¨Ø±Ù‡ milk
  if (MILK_DIRECT_KEYS.some(k => toNum(e[k]) > 0)) return 'milk';
  for (const [k, v] of Object.entries(e)) if (MILK_PART_KEY.test(k) && toNum(v) > 0) return 'milk';

  return 'other';
};

function evMilkKg(e = {}) {
  // Ø£ÙˆÙ„Ø§Ù‹: Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (ØªØ´Ù…Ù„ dailyMilk)
  for (const k of MILK_DIRECT_KEYS) {
    const n = toNum(e[k]);
    if (n > 0) return n;
  }
  // Ø«Ø§Ù†ÙŠØ§Ù‹: Ù†Ø¬Ù…Ø¹ Ø£Ø¬Ø²Ø§Ø¡ AM/PM/â€¦ Ø¥Ù† ÙˆÙØ¬Ø¯Øª
  let sum = 0;
  for (const [k, v] of Object.entries(e)) if (MILK_PART_KEY.test(k)) sum += toNum(v);
  return sum;
}


/* ======================= Firestore ======================= */
async function fetchAnimalByNumber(n){
  if (n == null || String(n).trim() === '') return null;
  const nStr = String(n).trim();
  const nNum = Number(nStr);
  const A = collection(DB, 'animals');

  // doc(id = Ø§Ù„Ø±Ù‚Ù… ÙƒÙ†Øµ)
  try {
    const d = await getDoc(doc(DB, 'animals', nStr));
    if (d.exists()) {
      const data = d.data();
      if (!UID || data?.[ANIM_OWNER_FIELD] === UID) {
        return normalizeAnimalDoc({ id: d.id, ...data });
      }
    }
  } catch {}

  // animalNumber = Number
  if (Number.isFinite(nNum)) {
    try {
      const q1 = UID
        ? query(A, where(ANIM_OWNER_FIELD,'==',UID), where('animalNumber','==',nNum), limit(1))
        : query(A, where('animalNumber','==',nNum), limit(1));
      const s1 = await getDocs(q1);
      if (!s1.empty) { const d = s1.docs[0]; return normalizeAnimalDoc({ id:d.id, ...d.data() }); }
    } catch {}
  }

  // animalNumber = String
  try {
    const q2 = UID
      ? query(A, where(ANIM_OWNER_FIELD,'==',UID), where('animalNumber','==',nStr), limit(1))
      : query(A, where('animalNumber','==',nStr), limit(1));
    const s2 = await getDocs(q2);
    if (!s2.empty) { const d = s2.docs[0]; return normalizeAnimalDoc({ id:d.id, ...d.data() }); }
  } catch {}

  return null;
}


async function fetchAnimal({ number, animalId } = {}) {
  if (animalId) {
    const d = await getDoc(doc(DB,'animals', String(animalId)));
    if (d.exists()) {
      const data = d.data();
      if (!UID || data?.[ANIM_OWNER_FIELD] === UID) {
        return normalizeAnimalDoc({ id:d.id, ...data });
      }
    }
  }
  const a = await fetchAnimalByNumber(number);
  if (a) return a;
  throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ÙŠÙˆØ§Ù† Ù…Ø·Ø§Ø¨Ù‚');
}
async function fetchEvents(animal){
  const E = collection(DB, 'events');
  const rows = [];

  try {
    // Ø­Ø³Ø¨ Ù…Ø¹Ø±Ù ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
    if (animal.id) {
      const qById = UID
        ? query(E, where('animalId','==', String(animal.id)), where(EVENT_USER_FIELD,'==',UID))
        : query(E, where('animalId','==', String(animal.id)));
      const sById = await getDocs(qById);
      sById.forEach(d => rows.push({ id:d.id, ...d.data() }));
    }

    // Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† (Ø³Ù„Ø³Ù„Ø© ÙˆØ±Ù‚Ù…)
    if (animal.number != null) {
      const nStr = String(animal.number);
      const nNum = Number(nStr);

      const baseQs = [
        query(E, where('animalNumber','==', nStr)),
        query(E, where('number','==', nStr)),
        ...(Number.isFinite(nNum) ? [
          query(E, where('animalNumber','==', nNum)),
          query(E, where('number','==', nNum)),
        ] : []),
      ];

      for (const q0 of baseQs) {
        const qf = UID ? query(q0, where(EVENT_USER_FIELD,'==',UID)) : q0;
        const s  = await getDocs(qf);
        s.forEach(d => rows.push({ id:d.id, ...d.data() }));
      }
    }
  } catch (e) {
    console.error('[fetchEvents] error:', e);
  }

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø«Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ØªØµØ§Ø¹Ø¯ÙŠÙ‹Ø§
  const uniq = new Map(rows.map(r => [r.id, r]));
  return [...uniq.values()].sort((a,b) => (evDate(a)||'').localeCompare(evDate(b)||''));
}

/* ======================= Build state ======================= */
function buildState(animal, events){
  const st={
    number: animal.number ?? animal.id?.slice(-6),
    reproductiveStatus: animal.reproductiveStatus || 'â€”',
    productionStatus:   animal.productionStatus   || 'â€”',
    healthStatus:       animal.healthStatus       || 'Ø³Ù„ÙŠÙ…',
    birthDate:       animal.birthDate       || null,
    lastCalvingDate: animal.lastCalvingDate || null,
    lactationNumber: animal.lactationNumber ?? null,
    daysInMilk: null, gestationDays: 
      null, pregnancyDate: animal.pregnancyDate || null,
    breed: animal.breed || 'â€”', group: animal.group || 'â€”',
    milkTraitsScore: animal.milkTraitsScore ?? 0,
    inseminations: [], estrusDates: Array.isArray(animal.estrusDates)?[...animal.estrusDates]:[],
    lastInseminationDate: animal.lastInseminationDate ?? null, servicesCount: animal.servicesCount ?? null,
    serviceIntervalDays: animal.serviceIntervalDays ?? null, heatIntervalDays: animal.heatIntervalDays ?? null,
    milkTodayKg: animal.milkTodayKg ?? null, seasonTotalKg: animal.seasonTotalKg ?? null, m305Kg: animal.m305Kg ?? null,
    milkSeries: [],
    lastCheckDate: animal.lastCheckDate || null, healthHistory: [],
    ovsynch: animal.ovsynch || null, isDry: false,
    __animalRaw: animal, // Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ â€œÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€
  };

  const milkTmp=[]; let season=0;
  for (const e of events){
    const t=evType(e), d=evDate(e);
    if (t==='dry') st.isDry=true, st.productionStatus='Ø¬Ø§Ù';
    if (t==='pregnancy') st.reproductiveStatus='Ø¹ÙØ´Ø§Ø±';
    if (t==='calving' && d) st.lastCalvingDate=d;
    if (t==='insemination' && d) st.inseminations.push(d);
    if (t==='heat' && d) st.estrusDates.push(d);
    if (t==='pregnancy'){ st.pregnancyDate = st.pregnancyDate || d || e.pregnancyDate || null; st.reproductiveStatus='Ø¹ÙØ´Ø§Ø±'; }
    if (t==='disease'){
      st.healthHistory.push({ date:d||'', diagnosis:e.diagnosis||e.note||e.eventType||'â€”', note:e.note||'' });
      st.healthStatus='Ø­Ø§Ù„Ø§Øª ØµØ­ÙŠØ© Ù…Ø³Ø¬Ù„Ø©'; st.lastCheckDate=st.lastCheckDate || d || null;
    }
    if (t==='milk'){
      const kg=evMilkKg(e);
      if (kg>0){ season+=kg; milkTmp.push({ d, kg }); if (d===todayStr) st.milkTodayKg=kg; }
    }
  }

  if (st.lastCalvingDate){
    const ms=Date.now()-new Date(st.lastCalvingDate).getTime();
    st.daysInMilk=Math.max(0,Math.floor(ms/86400000));
  }

  st.inseminations.sort();
  if (!st.lastInseminationDate) st.lastInseminationDate=st.inseminations.at(-1) || null;
  if (st.servicesCount==null) st.servicesCount=st.inseminations.length || null;
  st.estrusDates.sort();

  if (st.seasonTotalKg==null) st.seasonTotalKg=season || null;

  if (milkTmp.length){
    const base=st.lastCalvingDate?new Date(st.lastCalvingDate).getTime():null;
    st.milkSeries=milkTmp.filter(p=>p.d).map(p=>{
      const di=base?Math.max(0,Math.floor((new Date(p.d).getTime()-base)/86400000)):0;
      return { d:di, v:p.kg };
    }).sort((a,b)=>a.d-b.d);
  }

  if (st.m305Kg==null && st.daysInMilk>0 && (st.seasonTotalKg||0)>0){
    st.m305Kg=Math.round((st.seasonTotalKg/st.daysInMilk)*305);
  }

  if (st.isDry) st.productionStatus='Ø¬Ø§Ù';
  else if (!animal.productionStatus && st.daysInMilk!=null){
    st.productionStatus = st.daysInMilk<60?'Ø­Ù„ÙŠØ¨ Ù…Ø¨ÙƒØ±' : st.daysInMilk<200?'Ø­Ù„ÙŠØ¨ Ù…ØªÙˆØ³Ø·' : 'Ø­Ù„ÙŠØ¨ Ù…ØªØ£Ø®Ø±';
  }
  // Ù„Ùˆ Ù…ÙÙŠØ´ milkTraitsScore ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŒ Ø®Ø¯ Ø¢Ø®Ø± Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
// ØªØ­Ø¯ÙŠØ« Ø³ÙƒÙˆØ± "Ø³Ù…Ø§Øª Ø§Ù„Ù„Ø¨Ù†" Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
if ((st.milkTraitsScore == null || Number(st.milkTraitsScore) === 0) && Array.isArray(events) && events.length) {
  // Ù…Ø­ÙˆÙ„ Ù…Ø­Ù„ÙŠ Ø¢Ù…Ù† Ù„Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© (ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ "78" Ø£Ùˆ "78%" Ø£Ùˆ 0.78)
  const _toPercent = (v)=>{
    if (v == null) return 0;
    let n = (typeof v === 'string') ? parseFloat(v.replace(/[^\d.-]+/g,'')) : Number(v);
    if (!Number.isFinite(n)) return 0;
    // Ù„Ùˆ Ø§Ù„Ø³Ù„Ø³Ù„Ø© ÙÙŠÙ‡Ø§ % Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙˆÙ„Ùˆ Ø±Ù‚Ù… Ø¨ÙŠÙ† 0 Ùˆ 1 Ø§Ø¹ØªØ¨Ø±Ù‡ ÙƒØ³Ø±ÙŠ ÙˆØ­ÙˆÙ‘Ù„Ù‡ Ù„Ù… %
    if (typeof v === 'string' && v.includes('%')) {
      // n ÙƒÙ…Ø§ Ù‡Ùˆ
    } else if (n >= 0 && n <= 1) {
      n = n * 100;
    }
    return Math.max(0, Math.min(100, Math.round(n)));
  };

 // Ù…ÙØ§ØªÙŠØ­ Ù…Ø­ØªÙ…Ù„Ø© Ù„Ù„Ø³ÙƒÙˆØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (ØªØ´Ù…Ù„ overallScore)
const CAND_KEYS = [
  'overallScore','overall_score','overall',          // Ø§Ù„Ø¬Ø¯ÙŠØ¯
  'milkTraitsScore','traitsScore','milk_score',
  'score','milkTraits','traits','quality'
];

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…ÙŠÙ‚ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø¯Ø« ÙˆØ£ÙŠ ÙƒØ§Ø¦Ù†Ø§Øª ÙØ±Ø¹ÙŠØ©
const pullScore = (root)=>{
  const stack = [root];
  while (stack.length){
    const obj = stack.pop();
    if (!obj || typeof obj !== 'object') continue;

    for (const [k,v] of Object.entries(obj)){
      if (CAND_KEYS.includes(String(k))) {
        if (v != null && (typeof v === 'number' || typeof v === 'string')) return v;
      }
      if (v && typeof v === 'object') stack.push(v);
    }
  }
  return null;
};


  // Ø®ÙØ¯ Ø¢Ø®Ø± Ù‚ÙŠÙ…Ø© Ù…ØªØ§Ø­Ø© (Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…)
  for (let i = events.length - 1; i >= 0; i--) {
    const raw = pullScore(events[i]);
    if (raw != null) {
      st.milkTraitsScore = _toPercent(raw);
      break;
    }
  }
}
return st;
}

/* ======================= UI (Ù‚ÙŠØ§Ø³/Ø±Ø³Ù…) ======================= */
function arcPath(cx,cy,r,a0,a1){
  const A=(x)=>x*Math.PI/180, P=(ang)=>[cx+r*Math.cos(A(ang)), cy+r*Math.sin(A(ang))];
  const [x0,y0]=P(a0),[x1,y1]=P(a1);
  return`M ${x0.toFixed(3)} ${y0.toFixed(3)} A ${r} ${r} 0 0 1 ${x1.toFixed(3)} ${y1.toFixed(3)}`;
}
function renderGauge(score){
  score=Math.max(0,Math.min(100,Number(score)||0));
  const g=$('gSlices'); if(!g) return; g.innerHTML='';
  const colors=['#ef5350','#ffb74d','#fff176','#66bb6a'], steps=[0,25,50,75,100];
  for(let i=0;i<4;i++){
    const s=steps[i],e=steps[i+1],a0=180-(s/100)*180,a1=180-(e/100)*180;
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',arcPath(50,50,40,a0,a1));
    p.setAttribute('fill','none'); p.setAttribute('stroke',colors[i]);
    p.setAttribute('stroke-width','12'); p.setAttribute('stroke-linecap','round');
    g.appendChild(p);
  }
  const ang=180-(score/100)*180; const needle=$('needle'); if(needle) needle.setAttribute('transform',`rotate(${ang} 50 50)`);
  const label=score>=75?'Ù…Ù…ØªØ§Ø²':score>=50?'Ø¬ÙŠØ¯':score>=25?'Ù…ØªÙˆØ³Ø·':'Ø¶Ø¹ÙŠÙ';
  put('milkGaugeVal',`${label} â€” ${score}%`);
}
function renderMilkChart(series){
  const svg=$('milkChart'), sc=$('milkScroll');
  if(!svg||!sc||!Array.isArray(series)||!series.length){ svg.innerHTML=''; return; }
  const base=Math.max(sc.clientWidth,320), pxPer=Math.max(6,Math.min(11,Math.round(base/28))), pad=10;
  const data=series.map((p,i)=>({x:i,y:Number(p.v)||0})), N=data.length, W=pad*2+(N-1)*pxPer+20;
  svg.setAttribute('viewBox',`0 0 ${W} 60`); svg.style.width=W+'px';
  const maxY=Math.max(...data.map(d=>d.y),1), minY=Math.min(...data.map(d=>d.y),0), yR=Math.max(1,maxY-minY);
  const sx=(i)=>pad+(i*pxPer), sy=(v)=>60-6-((v-minY)*(60-12)/yR);
  svg.innerHTML='';
  const grid=document.createElementNS('http://www.w3.org/2000/svg','g');
  for(let i=1;i<=3;i++){
    const y=6+i*(60-12)/3;
    const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',6); ln.setAttribute('x2',W-6);
    ln.setAttribute('y1',y); ln.setAttribute('y2',y);
    ln.setAttribute('stroke','#e9f5dc'); ln.setAttribute('stroke-width','0.6');
    grid.appendChild(ln);
  }
  svg.appendChild(grid);
  let d=''; data.forEach((p,i)=>{ d+=(i?' L ':'M ')+sx(i).toFixed(2)+' '+sy(p.y).toFixed(2); });
  const area=d+` L ${sx(N-1).toFixed(2)} ${60-6} L ${sx(0).toFixed(2)} ${60-6} Z`;
  const ap=document.createElementNS('http://www.w3.org/2000/svg','path'); ap.setAttribute('d',area); ap.setAttribute('fill','#cdeccd'); ap.setAttribute('opacity','0.6'); svg.appendChild(ap);
  const lp=document.createElementNS('http://www.w3.org/2000/svg','path'); lp.setAttribute('d',d); lp.setAttribute('fill','none'); lp.setAttribute('stroke','#2e7d32'); lp.setAttribute('stroke-width','1.2'); svg.appendChild(lp);
  const cx=sx(N-1), cy=sy(data[N-1].y); const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
  dot.setAttribute('cx',cx); dot.setAttribute('cy',cy); dot.setAttribute('r',2); dot.setAttribute('fill','#1b5e20'); svg.appendChild(dot);
  setTimeout(()=>{ sc.scrollLeft=svg.scrollWidth; },0);
  addEventListener('resize',()=>renderMilkChart(series),{once:true});
}
    /* === Timeline Helpers === */
function _colorForType(t){
  switch(t){
    case 'calving': return getComputedStyle(document.documentElement).getPropertyValue('--tl-calving') || '#1b5e20';
    case 'insemination': return getComputedStyle(document.documentElement).getPropertyValue('--tl-insem') || '#0d9488';
    case 'pregnancy': return getComputedStyle(document.documentElement).getPropertyValue('--tl-preg') || '#a16207';
    case 'heat': return getComputedStyle(document.documentElement).getPropertyValue('--tl-heat') || '#ef6c00';
    case 'dry': return getComputedStyle(document.documentElement).getPropertyValue('--tl-dry') || '#6b7280';
    case 'disease': return getComputedStyle(document.documentElement).getPropertyValue('--tl-disease') || '#c62828';
    case 'milk': return getComputedStyle(document.documentElement).getPropertyValue('--tl-milk') || '#2e7d32';
    default: return getComputedStyle(document.documentElement).getPropertyValue('--tl-other') || '#4b5563';
  }
}
function _fmtDate(d){ try{ return new Date(d).toLocaleDateString('ar-EG'); }catch{ return d||'â€”'; } }

/* === Render Timeline === */
function renderTimeline(events, state){
  const box = document.getElementById('timelineBox');
  if (!box) return;
  box.innerHTML = '';

  // Ø¬Ù‡Ù‘Ø² ØµÙÙˆÙ (Ø¨ØªØ§Ø±ÙŠØ® ØµØ§Ù„Ø­ ÙÙ‚Ø·)
  const rows = (Array.isArray(events)?events:[])
    .map(e => ({ e, d: evDate(e) }))
    .filter(x => x.d);

  if (!rows.length){
    const empty = document.createElement('div');
    empty.style.cssText='padding:10px;color:#456;font:13px system-ui';
    empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯.';
    box.appendChild(empty);
    return;
  }

  // Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†
  let minT = Infinity, maxT = -Infinity;
  for (const r of rows){
    const t = +new Date(r.d);
    if (t < minT) minT = t;
    if (t > maxT) maxT = t;
  }
  if (!Number.isFinite(minT) || !Number.isFinite(maxT)) return;
  if (maxT - minT < 86400000){ minT -= 3*86400000; maxT += 3*86400000; } // ÙƒÙ„Ù‘Ù‡Ø§ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…

  // Ù„ÙˆØ­Ø©
  const padL = 40, padR = 40, padT = 28, padB = 38;
  const dotsW = Math.max(600, rows.length * 40);
  const W = padL + dotsW + padR, H = 120;
  const Y = Math.round(H/2) + 6;

  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('class','tl-svg');
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.style.width = W+'px';

  // Ø§Ù„Ù…Ø­ÙˆØ±
  const axis = document.createElementNS(svgNS, 'line');
  axis.setAttribute('x1', padL); axis.setAttribute('x2', W-padR);
  axis.setAttribute('y1', Y);    axis.setAttribute('y2', Y);
  axis.setAttribute('stroke', '#cfe9c8'); axis.setAttribute('stroke-width','2');
  svg.appendChild(axis);

  // ØªÙ‚Ø³ÙŠÙ…Ø§Øª Ø²Ù…Ù†ÙŠØ© + Ø¹Ù†Ø§ÙˆÙŠÙ†Ù‡Ø§ (ØªØ¸Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ø³ÙÙ„ØŒ Ù…Ø´ ÙÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø§Ø·)
  const ticks = 6;
  for (let i=0;i<=ticks;i++){
    const t = minT + (i*(maxT-minT)/ticks);
    const x = padL + ((t-minT)/(maxT-minT))*(W-padL-padR);

    const line = document.createElementNS(svgNS,'line');
    line.setAttribute('x1',x); line.setAttribute('x2',x);
    line.setAttribute('y1',Y-16); line.setAttribute('y2',Y+16);
    line.setAttribute('stroke','#e9f5dc'); line.setAttribute('stroke-width','0.8');
    svg.appendChild(line);

    const lbl = document.createElementNS(svgNS,'text');
    lbl.setAttribute('x',x); lbl.setAttribute('y',H-padB+26);
    lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('font-size','10');
    lbl.setAttribute('fill','#355');
    lbl.textContent = new Date(t).toLocaleDateString('ar-EG');
    svg.appendChild(lbl);
   
  } // ğŸ‘ˆ Ù…Ù‡Ù…: Ù‚ÙÙ„ Ø§Ù„Ø­Ù„Ù‚Ø© Ù‡Ù†Ø§

  // Tooltip â€” Ø®Ø§Ø±Ø¬ Ø£ÙŠ Ø­Ù„Ù‚Ø§Øª
  const tip = document.getElementById('tlTip');
  function showTipAt(svgEl, x, y, title, details, dateStr){
    if (!tip) return;
    tip.style.display='block';
    const svgRect  = svgEl.getBoundingClientRect();
    const hostRect = box.closest('.timeline-card').getBoundingClientRect();
    const sx = svgRect.left + (x / W) * svgRect.width;
    const sy = svgRect.top  + (y / H) * svgRect.height;
    tip.style.left = (sx - hostRect.left) + 'px';
    tip.style.top  = (sy - hostRect.top  - 14) + 'px';
    tip.innerHTML = `<b>${title||'â€”'}</b><div>${details||''}</div><div class="tl-date">${_fmtDate(dateStr)||''}</div>`;
  }
  function hideTip(){ if (tip) tip.style.display='none'; }
  box.addEventListener('scroll', hideTip, { passive:true });
  document.addEventListener('pointerdown', (ev)=>{ if(!box.contains(ev.target)) hideTip(); }, { passive:true });

  // Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙ‚Ø· (Ù„Ø§ Ù†Øµ ÙÙˆÙ‚Ù‡Ø§)
  rows.forEach(({e,d})=>{
    const t = +new Date(d);
    const x = padL + ((t-minT)/(maxT-minT))*(W-padL-padR);
    const y = Y;

    const tpe = evType(e);
    const color = _colorForType(tpe);

    // Ø³Ø§Ù‚
    const stem = document.createElementNS(svgNS,'line');
    stem.setAttribute('x1',x); stem.setAttribute('x2',x);
    stem.setAttribute('y1',y-14); stem.setAttribute('y2',y+14);
    stem.setAttribute('stroke', color); stem.setAttribute('stroke-width','1');
    stem.setAttribute('opacity','0.5');
    svg.appendChild(stem);

    // Ù†Ù‚Ø·Ø© Ù…Ø±Ø¦ÙŠØ©
    const dot = document.createElementNS(svgNS,'circle');
    dot.setAttribute('cx', x); dot.setAttribute('cy', y);
    dot.setAttribute('r', 6);
    dot.setAttribute('fill', color);
    dot.setAttribute('class', 'tl-dot');
    dot.setAttribute('tabindex','0');
    dot.setAttribute('role','button');
    dot.setAttribute('aria-label', `${eventNameRaw(e)} â€” ${_fmtDate(d)}`);
    svg.appendChild(dot);

    // Ù…Ù†Ø·Ù‚Ø© Ù„Ù…Ø³ ÙˆØ§Ø³Ø¹Ø©
    const hit = document.createElementNS(svgNS,'circle');
    hit.setAttribute('cx', x); hit.setAttribute('cy', y);
    hit.setAttribute('r', 16);
    hit.setAttribute('fill', 'transparent');
    hit.style.cursor = 'pointer';
    svg.appendChild(hit);

    const title   = eventNameRaw(e);
    const details = compactEventDetails(e);
    const dateStr = d;

    const openTip  = ()=> showTipAt(svg, x, y, title, details, dateStr);
    const closeTip = hideTip;

    // Ù…Ø§ÙˆØ³
    hit.addEventListener('mouseenter', openTip);
    hit.addEventListener('mouseleave', closeTip);
    // ÙƒÙ„ÙŠÙƒ
    hit.addEventListener('click', (ev)=>{ ev.stopPropagation(); openTip(); if (e.id) focusEventRow(e.id); });
    // Ù„Ù…Ø³
    hit.addEventListener('touchstart', ()=>{ openTip(); if (e.id) focusEventRow(e.id); clearTimeout(hit._to); hit._to=setTimeout(closeTip,2200); }, {passive:true});
    hit.addEventListener('touchend', closeTip,   {passive:true});
    hit.addEventListener('touchcancel', closeTip,{passive:true});
    // Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­
    dot.addEventListener('focus', openTip);
    dot.addEventListener('blur',  closeTip);
    dot.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter' || ev.key===' ') openTip(); });
  });

  const scroller = document.createElement('div');
  scroller.style.width = W+'px';
  scroller.appendChild(svg);
  box.appendChild(scroller);

  // Ù…Ø±Ù‘Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ø¢Ø®Ø± Ù†Ù‚Ø·Ø©
  setTimeout(()=>{ box.scrollLeft = box.scrollWidth; }, 0);
}

function avgDaysBetween(dts){ if(!dts||dts.length<2) return null;
  const ms=dts.map(d=>new Date(d).getTime()).sort((a,b)=>a-b);
  const dif=[]; for(let i=1;i<ms.length;i++) dif.push((ms[i]-ms[i-1])/86400000);
  return Math.round(dif.reduce((a,b)=>a+b,0)/dif.length);
}
function setChip(el,text){ if(!el) return; const t=String(text||'').toLowerCase(); let v='ok';
  if(/Ù…ÙØªÙˆØ­|Ø®Ø·Ø± Ù…Ù†Ø®ÙØ¶|Ù…ØªÙˆØ³Ø·/.test(t)) v='warn'; if(/Ø­Ø§Ø¯|Ø´Ø¯ÙŠØ¯|Ù…Ø±Ø¶|Ù†ÙØ§Ø³ Ù…ØªØ¹Ø«Ø±/.test(t)) v='danger';
  el.textContent=text||'â€”'; el.setAttribute('data-variant',v);
}
/* ======================= ÙˆØ¶Ø¹ ÙƒÙ„ Ø¨ÙŠØ§Ù† ÙÙŠ Ù…ÙƒØ§Ù†Ù‡ ======================= */
/** Ø£Ø¯Ø§Ø© ØµØºÙŠØ±Ø©: ØªØ¶ÙŠÙ ØµÙ .fi Ø¥Ù„Ù‰ Grid Ù…Ø¹ÙŠÙ‘Ù† Ù„Ùˆ ÙÙŠÙ‡ Ù‚ÙŠÙ…Ø© ÙØ¹Ù„Ø§Ù‹ */
function addFi(containerId, label, value) {
  if (value == null || value === '' || (Array.isArray(value) && !value.length)) return;
  const box = document.getElementById(containerId);
  if (!box) return;
  const fi = document.createElement('div');
  fi.className = 'fi';
  const sp = document.createElement('span'); sp.textContent = label;
  const b  = document.createElement('b');   b.textContent = Array.isArray(value) ? value.join('ØŒ ') : String(value);
  fi.appendChild(sp); fi.appendChild(b); box.appendChild(fi);
}

/** Aliases -> label + target grid Ù„ÙƒÙ„ Ø­Ù‚Ù„ Ø¥Ø¶Ø§ÙÙŠ Ø´Ø§Ø¦Ø¹ */
const EXTRA_FIELD_MAP = [
  // === Ø£Ø³Ø§Ø³ÙŠ (basicInfo) ===
  { keys: ['earTag','ear_tag','tag','Ø±Ù‚Ù…_Ø§Ù„ØªØ±Ù‚ÙŠÙ…'],           label: 'Ø±Ù‚Ù… Ø§Ù„ØªØ±Ù‚ÙŠÙ…',         target: 'basicInfo' },
  { keys: ['rfid','RFID'],                                    label: 'RFID',                target: 'basicInfo' },
  { keys: ['color','Ù„ÙˆÙ†'],                                    label: 'Ø§Ù„Ù„ÙˆÙ†',               target: 'basicInfo' },
  { keys: ['originFarm','origin','Ø§Ù„Ù…Ø²Ø±Ø¹Ø©_Ø§Ù„Ù…Ù†Ø´Ø£'],           label: 'Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…Ù†Ø´Ø£',        target: 'basicInfo' },
  { keys: ['pen','housing','Ø§Ù„Ø­Ø¸ÙŠØ±Ø©','Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©_Ø§Ù„Ø³ÙƒÙ†ÙŠØ©'],     label: 'Ø§Ù„Ø­Ø¸ÙŠØ±Ø©/Ø§Ù„Ù…ÙƒØ§Ù†',      target: 'basicInfo' },
  { keys: ['bodyWeight','weight','Ø§Ù„ÙˆØ²Ù†'],                    label: 'Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)',         target: 'basicInfo' },
  { keys: ['birthWeight','weightAtBirth','ÙˆØ²Ù†_Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©'],      label: 'ÙˆØ²Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© (ÙƒØ¬Ù…)',   target: 'basicInfo' },

  // === Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† (Ù†Ø¶ÙŠÙ Ø³Ø·ÙˆØ± Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù‚Ø³Ù…) ===
  { keys: ['milkFat','fat%','fat','Ø¯Ù‡Ù†'],                     label: 'Ø¯Ù‡Ù† %',               target: 'milkScroll' },   // Ù‡Ù†Ø¶ÙŠÙÙ‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø®Ø·Ø·
  { keys: ['milkProtein','protein%','protein','Ø¨Ø±ÙˆØªÙŠÙ†'],      label: 'Ø¨Ø±ÙˆØªÙŠÙ† %',            target: 'milkScroll' },
  { keys: ['milkLactose','lactose%','Ù„Ø§ÙƒØªÙˆØ²'],               label: 'Ù„Ø§ÙƒØªÙˆØ² %',            target: 'milkScroll' },
  { keys: ['milkSNF','snf','Ù…ÙˆØ§Ø¯_ØµÙ„Ø¨Ø©_Ù„Ø§Ø¯Ù‡Ù†ÙŠØ©'],             label: 'SNF %',               target: 'milkScroll' },

  // === ØªÙ†Ø§Ø³Ù„ÙŠ (grid Ø¯Ø§Ø®Ù„ Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©) ===
  { keys: ['expectedCalvingDate','dueDate','Ù…ÙˆØ¹Ø¯_Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©'],   label: 'Ù…ÙˆØ¹Ø¯ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹', target: 'fiServiceInterval' /* anchor only */ },
  { keys: ['pregnancyResult','pregStatus','Ù†ØªÙŠØ¬Ø©_Ø§Ù„Ø­Ù…Ù„'],     label: 'Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ù…Ù„',         target: 'fiServiceInterval' },
  { keys: ['bull','sire','Ø§Ù„Ø£Ø¨','Ø§Ù„Ø«ÙˆØ±'],                     label: 'Ø§Ù„Ø«ÙˆØ±/Ø§Ù„Ø£Ø¨',          target: 'fiServiceInterval' },

  // === ØµØ­ÙŠ (grid Ø¯Ø§Ø®Ù„ Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©) ===
  { keys: ['vaccinations','vaccinationProgram','Ø§Ù„ØªØ­ØµÙŠÙ†Ø§Øª'],  label: 'Ø§Ù„ØªØ­ØµÙŠÙ†Ø§Øª',           target: 'healthList' /* anchor only */ },
  { keys: ['lastMastitisDate','mastitisDate','Ø§Ù„ØªÙ‡Ø§Ø¨_Ø§Ù„Ø¶Ø±Ø¹_Ø¢Ø®Ø±'], label: 'Ø¢Ø®Ø± Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¶Ø±Ø¹', target: 'healthList' },
  { keys: ['lamenessScore','LS','Ø¹Ø±Ø¬'],                        label: 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¬',         target: 'healthList' },

  // === Ø³ÙƒÙˆØ±/ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ===
  { keys: ['bcs','bodyScore','BCS','Ø­Ø§Ù„Ø©_Ø§Ù„Ø¬Ø³Ù…'],             label: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ù… (BCS)',    target: 'basicInfo' },
  { keys: ['fecesScore','manureScore','Ø¯Ø±Ø¬Ø©_Ø§Ù„Ø±ÙˆØ«'],          label: 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±ÙˆØ«',          target: 'basicInfo' },
];

/** Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© aliases */
function firstDefined(obj, keys) {
  for (const k of keys) if (obj[k] != null && obj[k] !== '') return obj[k];
  return null;
}

/** Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† Ø¥Ø·Ø§Ù„Ø© Ø£Ùˆ ØªØºÙŠÙŠØ± Ø¨ØµØ±ÙŠ */
function renderExtrasIntoSections(animal) {
  // Ù†Ù…Ù†Ø¹ Ø£ÙŠ ØªØ³Ø±ÙŠØ¨ Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø§Ø³Ø©/Ø¯Ø§Ø®Ù„ÙŠØ©
  const BLOCK = new Set(['ownerUid','owner','uid','user','userId','__name__','__path__','id','createdAt','updatedAt']);
  const safeAnimal = {};
  for (const [k,v] of Object.entries(animal)) if (!BLOCK.has(k)) safeAnimal[k] = v;

  // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø®Ø·Ø·ØŒ Ù†Ø­Ø· Grid ØµØºÙŠØ± Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¥Ù† Ù„Ø²Ù…
  const milkScroll = document.getElementById('milkScroll');
  let prodGrid;
  if (milkScroll) {
    prodGrid = document.createElement('div');
    prodGrid.className = 'grid';
    prodGrid.style.margin = '8px 0';
    milkScroll.parentElement.insertBefore(prodGrid, milkScroll); // ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„Ù…Ø®Ø·Ø·
  }

  for (const def of EXTRA_FIELD_MAP) {
    const val = firstDefined(safeAnimal, def.keys);
    if (val == null) continue;

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù€container Ø­Ø³Ø¨ Ø§Ù„Ù‡Ø¯Ù
    let containerId = def.target;
    let containerEl = null;

    if (def.target === 'milkScroll' && prodGrid) {
      // Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ù†Ø¶ÙŠÙ ÙÙŠ Ø§Ù„Ù€grid Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙˆÙ‚ Ø§Ù„Ù…Ø®Ø·Ø·
      containerEl = prodGrid;
    } else if (def.target === 'fiServiceInterval') {
      // Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠ: Ù†Ø¶ÙŠÙ ÙÙŠ Grid Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠ (Ø£Ù‚Ø±Ø¨ .grid Ø¨Ø¹Ø¯ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…)
      const sec = Array.from(document.querySelectorAll('section.card h3'))
        .find(h => h.textContent.trim().includes('Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©'));
      if (sec) {
        const grid = sec.parentElement.querySelector('.grid');
        containerEl = grid;
      }
    } else if (def.target === 'healthList') {
      // Ø§Ù„ØµØ­ÙŠ: Ù†Ø¶ÙŠÙ Ø¯Ø§Ø®Ù„ Grid Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ØµØ­ÙŠ
      const sec = Array.from(document.querySelectorAll('section.card h3'))
        .find(h => h.textContent.trim().includes('Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©'));
      if (sec) {
        const grid = sec.parentElement.querySelector('.grid');
        containerEl = grid;
      }
    } else {
      containerEl = document.getElementById(containerId);
    }

    if (!containerEl) continue;

    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ .fi
    const fi = document.createElement('div'); fi.className = 'fi';
    const sp = document.createElement('span'); sp.textContent = def.label;
    const b  = document.createElement('b');
    b.textContent = Array.isArray(val) ? val.join('ØŒ ') : String(val);
    fi.appendChild(sp); fi.appendChild(b);

    containerEl.appendChild(fi);
  }
}

// Ù„ØºØ§ÙŠØ© Ù‡Ù†Ø§ØŸØŸ
function compactEventDetails(e){
  const t = evType(e);

  if (t === 'milk'){
    const kg = evMilkKg(e);
    if (kg > 0) return `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${kg} ÙƒØ¬Ù…`;
  }

  if (t === 'insemination'){
    const bull = e.bull || e.semen || e.sire || e.straw || e['Ø§Ù„Ø«ÙˆØ±'] || 'â€”';
    return `Ø§Ù„ØªÙØ§ØµÙŠÙ„: ØªÙ„Ù‚ÙŠØ­ â€” Ø§Ù„Ø«ÙˆØ±/Ø§Ù„Ø³Ø§Ø¦Ù„: ${bull}`;
  }

  if (t === 'pregnancy'){
    const res = e.pregnancyResult || e.result || e.status || e['Ù†ØªÙŠØ¬Ø©_Ø§Ù„Ø­Ù…Ù„'] || e['Ø§Ù„Ù†ØªÙŠØ¬Ø©'] || 'Ù…ÙˆØ¬Ø¨';
    return `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${res}`;
  }

  if (t === 'calving'){
    const sex  = e.calfSex || e.sex || e['Ø¬Ù†Ø³_Ø§Ù„Ø¹Ø¬Ù„'] || 'â€”';
    const diff = e.difficulty || e.assist || e['Ù…Ø³Ø§Ø¹Ø¯Ø©'] || 'Ø·Ø¨ÙŠØ¹ÙŠ';
    return `Ø§Ù„ØªÙØ§ØµÙŠÙ„: ÙˆÙ„Ø§Ø¯Ø© â€” Ø¬Ù†Ø³ Ø§Ù„Ø¹Ø¬Ù„: ${sex} â€” ${diff}`;
  }

  if (t === 'dry'){
    return 'Ø§Ù„Ù†ØªÙŠØ¬Ø©: ØªØ¬ÙÙŠÙ Ø§Ù„Ø­Ù„ÙŠØ¨';
  }

  if (t === 'disease'){
    const dx = e.diagnosis || e.disease || e.condition || e['Ø§Ù„ØªØ´Ø®ÙŠØµ'] || 'â€”';
    const res = e.result || e.status || e['Ø§Ù„Ù†ØªÙŠØ¬Ø©'];
    const nt = e.note ? ` â€” Ù…Ù„Ø§Ø­Ø¸Ø©: ${e.note}` : '';
    return `Ø§Ù„ØªØ´Ø®ÙŠØµ: ${dx}${res?` â€” Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${res}`:''}${nt}`;
  }

  // Ø¹Ø§Ù…: Ø§Ù„ØªÙ‚Ø· Â«Ù†ØªÙŠØ¬Ø©Â» Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
  const res = e.result || e.status || e['Ø§Ù„Ù†ØªÙŠØ¬Ø©'];
  if (res) return `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${res}`;

  // fallback Ù…Ø®ØªØµØ±
  const keys = ['value','amount','kg','note','details','desc','comment','ØªÙØ§ØµÙŠÙ„','Ù…Ù„Ø§Ø­Ø¸Ø©'];
  for (const k of keys){
    if (e[k] != null){
      const v = e[k];
      const txt = Array.isArray(v) ? v.join('ØŒ ')
               : (typeof v === 'number' ? NF.format(v)
               : String(v));
      return `${k}: ${txt}`;
    }
  }
  return 'â€”';
}
    
function renderEventsList(events){
  const box = document.getElementById('evList');
  if (!box) return;
  box.innerHTML = '';

  const wrap  = document.createElement('div'); wrap.className = 'ev-scroll';
  const table = document.createElement('table'); table.className = 'ev-table';
 table.innerHTML = `
  <thead>
    <tr>
      <th style="width:160px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      <th style="width:200px">Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«</th>
      <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„ / Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
    </tr>
  </thead>
  <tbody></tbody>
`;

  const tbody = table.querySelector('tbody');

  // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø«
  if (!Array.isArray(events) || !events.length){
   const tr = document.createElement('tr');
tr.innerHTML = `<td class="ev-date">â€”</td><td class="ev-type">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø«</td><td class="ev-note">â€”</td>`;

    tbody.appendChild(tr);
    wrap.appendChild(table); box.appendChild(wrap);
    requestAnimationFrame(scheduleFit);
    return;
  }

  // ÙØ±Ø² ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®Ø› Ù„Ùˆ Ù…ÙÙŠØ´ ØªØ§Ø±ÙŠØ® Ù†Ø³ÙŠØ¨Ù‡ ÙÙŠ Ø§Ù„Ø¢Ø®Ø±
  const rows = [...events].map(e => ({ e, d: evDate(e) || '' }))
    .sort((a,b) => (b.d||'').localeCompare(a.d||''));

 for (const {e, d} of rows){
  const tr = document.createElement('tr');
  tr.id = e.id ? `evrow-${e.id}` : '';
  tr.setAttribute('aria-selected','false');

  const dateTd = document.createElement('td');
  dateTd.className = 'ev-date';
  dateTd.textContent = d ? new Date(d).toLocaleDateString('ar-EG') : 'â€”';

  const nameTd = document.createElement('td');
  nameTd.className = 'ev-type';
  nameTd.textContent = eventNameRaw(e);   // ğŸ‘ˆ Ø§Ù„Ø¢Ù† ÙŠØ±Ø¬Ù‘Ø¹ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø£ÙˆÙ„Ø§Ù‹

  const detTd = document.createElement('td');
  detTd.className = 'ev-note';
  detTd.textContent = compactEventDetails(e);

  tr.appendChild(dateTd);
  tr.appendChild(nameTd);
  tr.appendChild(detTd);
  tbody.appendChild(tr);
}



  wrap.appendChild(table);
  box.appendChild(wrap);
  requestAnimationFrame(scheduleFit);
}
function focusEventRow(evId){
  if (!evId) return;
  const row = document.getElementById(`evrow-${evId}`);
  if (!row) return;

  // Ø­Ø¯Ù‘Ø¯ Ø§Ù„ÙˆØ¹Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ±
  const scroller = document.querySelector('#evList .ev-scroll') || row.closest('.ev-scroll') || document;
  // Ø´ÙŠÙ„ Ø§Ù„Ù‡Ø§ÙŠÙ„Ø§ÙŠØª Ø§Ù„Ù‚Ø¯ÙŠÙ…
  const old = scroller.querySelector('.ev-row--focus');
  if (old) old.classList.remove('ev-row--focus');

  // Ù‡Ø§ÙŠÙ„Ø§ÙŠØª + ØªÙ…Ø±ÙŠØ± Ù†Ø§Ø¹Ù…
  row.classList.add('ev-row--focus');
  row.setAttribute('aria-selected','true');
  const top = row.offsetTop - (scroller.clientHeight/2 - row.clientHeight/2);
  scroller.scrollTo({ top: Math.max(0, top), behavior: 'smooth' });

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø§ÙŠÙ„Ø§ÙŠØª Ø¨Ø¹Ø¯ Ø´ÙˆÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  clearTimeout(row._hlTO);
  row._hlTO = setTimeout(()=>{ row.classList.remove('ev-row--focus'); }, 2500);
}


/* ======================= Ø±Ø¨Ø· Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ======================= */
function renderCard(state, kind){
  $('cardTitle').textContent = `${kindTitleAr(kind)} Ø±Ù‚Ù… ${state.number ?? 'â€”'}`;
  setChip($('chipRepro'),state.reproductiveStatus); setChip($('chipProd'),state.productionStatus); setChip($('chipHealth'),state.healthStatus);

  put('fiBirth',fmtD(state.birthDate)); put('fiLastCalving',fmtD(state.lastCalvingDate));
  put('fiLactNo',state.lactationNumber!=null?NF.format(state.lactationNumber):'â€”');

  const hideDIM = state.isDry || state.productionStatus === 'Ø¬Ø§Ù';
  put('fiDIM', (!hideDIM && state.daysInMilk!=null) ? NF.format(state.daysInMilk) : 'â€”');

  let g=state.gestationDays, ref=state.pregnancyDate||state.lastInseminationDate;
  if(g==null&&ref){const ms=Date.now()-new Date(ref).getTime(); g=Math.max(0,Math.floor(ms/86400000));}
  put('fiGestAge',g!=null?NF.format(g):'â€”'); put('fiBreed',state.breed||'â€”'); put('fiGroup',state.group||'â€”');

  renderGauge(state.milkTraitsScore);
  put('kpiMilkToday',state.milkTodayKg!=null?`${Number(state.milkTodayKg).toFixed(1)} ÙƒØ¬Ù…`:'â€”');
  put('kpiSeason',state.seasonTotalKg!=null?`${NF.format(Math.round(state.seasonTotalKg))} ÙƒØ¬Ù…`:'â€”');
  put('kpi305',state.m305Kg!=null?`${NF.format(Math.round(state.m305Kg))} ÙƒØ¬Ù…`:'â€”');
  renderMilkChart(state.milkSeries);

  put('fiLastIns',fmtD(state.lastInseminationDate));
  const spc = state.servicesCount;
  put('fiServicesCount', spc != null ? NF.format(spc) : 'â€”');
  const svcI = state.serviceIntervalDays ?? avgDaysBetween(state.inseminations);
  put('fiServiceInterval', svcI != null ? `${NF.format(svcI)} ÙŠÙˆÙ…` : 'â€”');
  const lastHeat=(state.estrusDates&&state.estrusDates.length)?state.estrusDates.at(-1):null; put('fiLastHeat',fmtD(lastHeat));
  const hI = state.heatIntervalDays ?? avgDaysBetween(state.estrusDates);
  put('fiHeatInterval', hI != null ? `${NF.format(hI)} ÙŠÙˆÙ…` : 'â€”');
  put('fiOvsynch', state.ovsynch ?? 'â€”');
  put('fiHealth',state.healthStatus||'â€”'); put('fiLastCheck',fmtD(state.lastCheckDate));
  const hl=$('healthList'); hl.innerHTML='';
  if(Array.isArray(state.healthHistory)&&state.healthHistory.length){
    state.healthHistory.slice(-6).forEach(it=>{
      const row=document.createElement('div'); row.className='hl';
      const d=document.createElement('div'); d.textContent=fmtD(it.date);
      const dx=document.createElement('div'); dx.textContent=it.diagnosis||'â€”';
      const nt=document.createElement('div'); nt.className='note'; nt.textContent=it.note||'';
      row.appendChild(d); row.appendChild(dx); row.appendChild(nt); hl.appendChild(row);
    });
  } else {
    const row=document.createElement('div'); row.className='hl';
    ['â€”','Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª',''].forEach((t,i)=>{const c=document.createElement('div'); if(i===2)c.className='note'; c.textContent=t; row.appendChild(c);});
    hl.appendChild(row);
  }

  // Ø¬Ø¯ÙŠØ¯: Ø§Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ù† ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†
renderExtrasIntoSections(state.__animalRaw || {});
}
function fitEventsTableToOneRow(){
  const wrap = document.querySelector('.ev-scroll');
  if (!wrap) return;
  const thead = wrap.querySelector('thead');
  const first = wrap.querySelector('tbody tr');
  if (!thead || !first) return;

  // Ø§Ø¬Ù…Ø¹ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø±Ø£Ø³ + Ø£ÙˆÙ„ ØµÙ ÙÙ‚Ø·
  const headH = Math.ceil(thead.getBoundingClientRect().height);
  const rowH  = Math.ceil(first.getBoundingClientRect().height);
  const total = headH + rowH + 2; // Ù‡Ø§Ù…Ø´ Ø¨Ø³ÙŠØ·

  if (window.matchMedia('(max-width:560px)').matches){
    wrap.style.maxHeight = total + 'px';
  } else {
    wrap.style.maxHeight = '';    // Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©: Ø§Ø±Ø¬Ø¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
  }
}

// Ø£Ø¹ÙØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØªØ¨Ù†ÙŠ + Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚Ø§Ø³
let _fitTO;
function scheduleFit(){ clearTimeout(_fitTO); _fitTO = setTimeout(fitEventsTableToOneRow, 60); }
window.addEventListener('resize', scheduleFit);

/* ======================= Load & Run ======================= */
async function loadAndRender({number, animalId, type}){
  try{
    let kind = normKind(type);
    const animal = await fetchAnimal({number, animalId});
    if(!kind) kind = animal.kind || normKind(localStorage.getItem('lastKind'));
    if(kind){ localStorage.setItem('lastKind',kind); if(kindValEl) kindValEl.textContent = kindNameAr(kind); }

    if (animal.id) localStorage.setItem('currentAnimalId', String(animal.id));
    if (animal.number!=null) {
      localStorage.setItem('currentAnimalNumber', String(animal.number));
      localStorage.setItem('lastAnimalNumber', String(animal.number));
    }

    const events = await fetchEvents(animal);
    const state  = buildState(animal, events);

    if(!events.length){
      const tip=document.createElement('div'); tip.className='notice';
      tip.innerHTML=`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯. <a href="/add-event.html?number=${encodeURIComponent(state.number||'')}" style="font-weight:700;color:#1b5e20">Ø£Ø¶Ù Ø£ÙˆÙ„ Ø­Ø¯Ø« Ø§Ù„Ø¢Ù†</a>.`;
      document.querySelector('.wrap')?.prepend(tip);
    }
renderCard(state, kind);
renderTimeline(events, state);   // ğŸ‘ˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯
renderEventsList(events);

  }catch(e){
    console.error(e);
    $('cardTitle').textContent='ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†';
  }
}

const numberParam = url.searchParams.get('number') || url.searchParams.get('animalNumber') || '';
const idParam     = url.searchParams.get('animalId') || '';
const typeParam   = (url.searchParams.get('type') || url.searchParams.get('kind') || url.searchParams.get('animaltype') || '').toLowerCase();

if (numberParam || idParam){
  if (openbar) openbar.style.display='none';
  if (typeParam && kindValEl) kindValEl.textContent = kindNameAr(normKind(typeParam));
  loadAndRender({number:numberParam, animalId:idParam, type:typeParam});
} else {
  const lastNum = localStorage.getItem('currentAnimalNumber') || localStorage.getItem('lastAnimalNumber') || '';
  if(lastNum && openInput){ openInput.value=lastNum; }
  if(openBtn){ openBtn.addEventListener('click', ()=>{ const n=(openInput.value||'').trim(); if(!n) return; loadAndRender({number:n}); }); }
}
  </script>
</body>
</html>











