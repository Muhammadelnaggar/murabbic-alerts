<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>بطاقة الحيوان</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #1b8f3a;
      --yellow: #fff9cc;
      --text: #222;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic", sans-serif;
      background: var(--yellow);
      color: var(--text);
    }
    header {
      background: var(--green);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px; flex-wrap: wrap;
    }
    header .title {
      font-size: 26px;
      font-weight: 800;
      line-height: 1.2;
    }
    main { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    
    .item { padding: 14px; border-radius: 12px; border: 1px dashed var(--border); background:#fff; display:block; }
    .label { font-size: 16px; font-weight: 800; color: var(--green); margin: 0 0 6px; }
    .value { font-size: 19px; font-weight: 800; color: #111; }
    .toolbar { display:flex; flex-wrap: wrap; gap:10px; margin: 16px 0 0; }
    .btn {
      appearance: none; border: 0; cursor: pointer;
      background: var(--green); color: #fff; font-weight: 700;
      padding: 10px 14px; border-radius: 999px; transition: transform .05s ease;
      text-decoration: none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn.secondary { background: #fff; color: var(--green); border: 2px solid var(--green); }
    .btn:active { transform: translateY(1px); }
    .status { margin-top: 12px; font-size: 14px; color: var(--muted); }
    .error { color: #b91c1c; font-weight: 700; }
    .ok { color: var(--green); font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .loading { opacity: .7; }
      /* تبويب الصفحة الواحدة */
    .tabs { display:flex; gap:8px; padding:8px 16px; position: sticky; top: 0; background: var(--yellow); z-index: 5; border-bottom: 1px solid var(--border); }
    .tab { appearance:none; border:1px solid var(--green); background:#fff; color:var(--green); font-weight:700; padding:8px 12px; border-radius:999px; cursor:pointer; }
    .tab.active { background: var(--green); color:#fff; }
    .tab-section { display:block; }
    .tab-section.active { display:block; }
    .section-title{font-size:22px;font-weight:900;color:var(--green);margin:0 0 10px;}
    .cow-value{display:flex;align-items:center;gap:12px;margin:6px 0 12px;}
    .badge-score{font-size:24px;font-weight:900;letter-spacing:2px;background:#e8f5ea;color:#14532d;border:2px solid var(--green);border-radius:12px;padding:6px 10px;min-width:140px;text-align:center;}
    .cow-value .hint{color:var(--muted);font-size:13px;}
      .page-actions{position:fixed; inset-inline:0; bottom:0; background:var(--yellow); padding:12px 16px calc(12px + env(safe-area-inset-bottom)); border-top:1px solid var(--border); box-shadow:0 -8px 24px rgba(0,0,0,.08); z-index:1000; display:flex; flex-direction:column; gap:10px; align-items:center;}
    main{padding-bottom:calc(200px + env(safe-area-inset-bottom));}
      .page-actions .actions-secondary{display:flex; gap:10px; flex-wrap:wrap; justify-content:center;}
    .page-actions .btn.main{width:100%; max-width:520px; font-size:17px; padding:14px 18px;}
      .badge-number{display:none;background:#fff;color:var(--green);border:2px solid var(--green);border-radius:999px;padding:4px 12px;font-weight:900;font-size:16px;line-height:1;}
  </style>
</head>
<body>
  <header>
    <div class="title" id="page-title">بطاقة الحيوان</div>
    <span id="badge-number" class="badge-number" title="رقم الحيوان">—</span>
  </header>

  <main>
    
    <section class="tab-section active" id="tab-overview">
      <div id="info" class="card loading">
        <div class="row">
          <div class="item"><div class="label">السلالة</div><div id="v-breed" class="value">—</div></div>
          <div class="item"><div class="label">تاريخ الميلاد</div><div id="v-dob" class="value">—</div></div>
          <div class="item"><div class="label">عدد أيام الحليب</div><div id="v-dim" class="value">—</div></div>
          <div class="item"><div class="label">رقم موسم الحليب</div><div id="v-lact" class="value">—</div></div>
          <div class="item"><div class="label">الحالة الإنتاجية</div><div id="v-prod" class="value">—</div></div>
          <div class="item"><div class="label">الحالة التناسلية</div><div id="v-repro" class="value">—</div></div>
          <div class="item"><div class="label">المجموعة</div><div id="v-group" class="value">—</div></div>
        </div>
        
        <div id="status" class="status">جارِ التحميل…</div>
      </div>
    </section>

    <!-- قسم الحالة التناسلية -->
    <div id="reproCard" class="card" style="margin-top:12px;">
      <h3 class="section-title">الحالة التناسلية</h3>
      <div class="row">
        <div class="item"><div class="label">عدد مرات التلقيح</div><div id="sm-insem-count" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ آخر تلقيح</div><div id="sm-last-insem" class="value">—</div></div>
        <div class="item"><div class="label">الأيام منذ آخر تلقيح</div><div id="sm-days-since-insem" class="value">—</div></div>
        <div class="item"><div class="label">متوسط المدة بين التلقيحات (يوم)</div><div id="sm-insem-avg-interval" class="value">—</div></div>
        <div class="item"><div class="label">أيام الحمل (لو عشار)</div><div id="sm-gestation-days" class="value">—</div></div>
        <div class="item"><div class="label">سهولة الولادة الأخيرة</div><div id="sm-calving-ease" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ الولادة المتوقع</div><div id="sm-expected-calving" class="value">—</div></div>
      </div>
    </div>

    <!-- قسم الحالة الإنتاجية -->
    <section id="milk-section">
      <div id="milkCard" class="card" style="margin-top:12px;">
        <h3 class="section-title">الحالة الإنتاجية</h3>
        <div class="row">
          <div class="item"><div class="label">إنتاج اليوم (كجم)</div><div id="sm-milk-today" class="value">—</div></div>
          <div class="item"><div class="label">إنتاج آخر 7 أيام (كجم)</div><div id="sm-milk-week" class="value">—</div></div>
          <div class="item"><div class="label">إجمالي هذا الشهر (كجم)</div><div id="sm-milk-month" class="value">—</div></div>
          <div class="item"><div class="label">التراكمي منذ بداية الموسم (كجم)</div><div id="sm-milk-season" class="value">—</div></div>
        </div>
        <h3 class="section-title" style="margin:12px 0 8px;">منحنى إنتاج اللبن اليومي</h3>
        <div id="milkWrap" style="height:260px; position:relative;">
          <canvas id="milkChart" aria-label="منحنى إنتاج اللبن" role="img"></canvas>
        </div>
        <div id="milkStatus" class="status">جارِ تحميل القراءات…</div>
      </div>
    </section>

    <div id="errorBox" class="card" style="display:none">
      <div class="error">تعذّر تحميل بيانات الحيوان.</div>
      <div class="status">تأكد من الرابط أو من الصلاحيات. إذا فتحت الصفحة من قائمة الحيوانات فالمفترض أن يعمل الرابط تلقائيًا.</div>
      <div class="toolbar"><a class="btn secondary" href="animal-list.html">الرجوع لقائمة الحيوانات</a></div>
    </div>

    <!-- قسم الحالة الصحية -->
    <div id="healthCard" class="card" style="margin-top:12px;">
      <h3 class="section-title">الحالة الصحية</h3>
      <div class="row">
        <div class="item"><div class="label">آخر تشخيص</div><div id="sm-last-diagnosis" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ التشخيص</div><div id="sm-last-diagnosis-date" class="value">—</div></div>
      </div>
      <h3 class="section-title" style="margin:12px 0 8px;">جدول التحصينات</h3>
      <div style="overflow-x:auto;">
        <table id="vaccTable" style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align:right; border-bottom:1px solid var(--border); padding:8px;">اسم التحصين</th>
              <th style="text-align:right; border-bottom:1px solid var(--border); padding:8px;">تاريخ التحصين</th>
              <th style="text-align:right; border-bottom:1px solid var(--border); padding:8px;">نوع الجرعة</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- قسم التقييم الفني والاقتصادي -->
    <div id="evalCard" class="card" style="margin-top:12px;">
      <h3 class="section-title">التقييم الفني والاقتصادي</h3>
      <div class="hint">قيمة تقديرية مبسّطة موجّهة للمربي (Cow Value)</div>
      </div>
      <div class="row">
        <div class="item"><div class="label">التصنيف الإنتاجي الحالي</div><div class="value" id="ev-prod-class">—</div></div>
        <div class="item"><div class="label">مؤشر الخصوبة</div><div class="value" id="ev-fertility">—</div></div>
        <div class="item"><div class="label">مؤشر الصحة</div><div class="value" id="ev-health">—</div></div>
        <div class="item"><div class="label">تكلفة/كجم لبن (تقديري)</div><div class="value" id="ev-cost-milk">—</div></div>
      </div>
      <h3 class="section-title" style="margin:12px 0 8px;">ملاحظات فنية</h3>
      <ul id="evalList" style="margin:0; padding-inline-start:18px; line-height:1.9;">
        <li>—</li>
      </ul>
    </div>

    <div class="toolbar page-actions">
      <a id="btn-add-event" class="btn main" href="#">+ تسجيل حدث لهذا الحيوان</a>
      <div class="actions-secondary">
        <a id="btn-dashboard" class="btn secondary" href="dashboard.html">لوحة التحكم</a>
        <a id="btn-back-list" class="btn secondary" href="animal-list.html">قائمة الحيوانات</a>
      </div>
    </div>
  </main>

  <!-- تعتمد الصفحة على ملف firebase-config.js الذي يهيئ Firebase ويصدّر auth و db -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    // 1) استيراد Firebase v10 (مطابقة لنسخة مشروعك) + auth/db من firebase-config.js
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { doc, getDoc, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { auth, db } from './js/firebase-config.js';

// 2) المراجع إلى عناصر الواجهة
    // one-page layout: no tabs
    const infoBox = document.getElementById('info');
    const errBox  = document.getElementById('errorBox');
    const status  = document.getElementById('status');
    const titleEl = document.getElementById('page-title');
    const vBreed  = document.getElementById('v-breed');
    const vProd   = document.getElementById('v-prod');
    const vRepro  = document.getElementById('v-repro');
    const vLastC  = document.getElementById('v-lastCalving');
    const vLastI  = document.getElementById('v-lastInsem');
    const vDob    = document.getElementById('v-dob');
    const vLact   = document.getElementById('v-lact');
    const vDim    = document.getElementById('v-dim');
    const vGroup  = document.getElementById('v-group');
    const badgeEl = document.getElementById('badge-number');
    const btnAddEvent = document.getElementById('btn-add-event');

    // 3) أدوات مساعدة
    

    // 3) أدوات مساعدة
    const fmt = new Intl.DateTimeFormat('ar-EG', { dateStyle: 'medium' });
    const asDate = (x) => {
      if (!x) return '—';
      // يقبل Timestamp الخاص بـ Firestore أو نص ISO أو تاريخ JS
      try {
        if (typeof x?.toDate === 'function') return fmt.format(x.toDate());
        const d = (typeof x === 'string') ? new Date(x) : x;
        if (!isNaN(d)) return fmt.format(d);
      } catch {}
      return '—';
    };

    const getQP = (key) => new URLSearchParams(location.search).get(key);

    // تحميل كل أحداث الحيوان (مرّة واحدة)
    async function loadAllEvents(docId, number) {
      const eventsRef = collection(db, 'events');
      let snap = await getDocs(query(eventsRef, where('animalDocId','==', docId)));
      let rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      if ((!rows || rows.length === 0) && number) {
        snap = await getDocs(query(eventsRef, where('animalNumber','==', String(number))));
        rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }
      return rows;
    }

    // أدوات مساعدة للتواريخ
    const toJsDate = (x) => {
      if (!x) return null;
      try { if (typeof x.toDate === 'function') return x.toDate(); } catch {}
      const d = (typeof x === 'string') ? new Date(x) : x;
      return isNaN(d) ? null : d;
    };
    const daysBetween = (a,b) => {
      if (!a || !b) return null;
      const ms = Math.abs(b - a);
      return Math.floor(ms / (1000*60*60*24));
    };
    const isSameDay = (a,b) => a && b && a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();

    // تعبئة الأجواء الذكية
    async function fillSmartSections(rows, animalDoc) {
      const get = (id) => document.getElementById(id);
      const reproStatusEl = get('sm-repro-status');
      const lastInsemEl   = get('sm-last-insem');
      const insemCountEl  = get('sm-insem-count');
      const insemLastInt  = get('sm-insem-last-interval');
      const insemAvgInt   = get('sm-insem-avg-interval');

      const prodStatusEl  = get('sm-prod-status');
      const dimEl         = get('sm-dim');

      const lastDiagEl    = get('sm-last-diagnosis');
      const lastDiagDtEl  = get('sm-last-diagnosis-date');

      const milkTodayEl   = get('sm-milk-today');
      const milkWeekEl    = get('sm-milk-week');
      const milkMonthEl   = get('sm-milk-month');
      const milkSeasonEl  = get('sm-milk-season');

      const daysSinceInsemEl = get('sm-days-since-insem');
      const gestDaysEl    = get('sm-gestation-days');
      const expectedCalvingEl = get('sm-expected-calving');
      const calvingEaseEl = get('sm-calving-ease');

      const vaccTbody = document.querySelector('#vaccTable tbody');

      // الحالة التناسلية
      const repro = animalDoc.reproductiveStatus || animalDoc.reproStatus || '—';
      if (reproStatusEl) reproStatusEl.textContent = repro;

      const insemEvents = rows.filter(r => {
        const t = (r.type || r.eventType || '').toString().toLowerCase();
        return t.includes('تلقي') || t.includes('insemin');
      }).map(r => toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp)).filter(Boolean).sort((a,b)=>a-b);

      if (insemCountEl) insemCountEl.textContent = insemEvents.length ? String(insemEvents.length) : '—';
      if (lastInsemEl)  lastInsemEl.textContent  = insemEvents.length ? fmt.format(insemEvents[insemEvents.length-1]) : '—';

      if (insemEvents.length >= 2) {
        const intervals = insemEvents.slice(1).map((d,i)=> daysBetween(insemEvents[i], d)).filter(v=>v!=null);
        const lastInt   = intervals[intervals.length-1];
        const avgInt    = Math.round(intervals.reduce((a,b)=>a+b,0)/intervals.length);
        if (insemLastInt) insemLastInt.textContent = String(lastInt);
        if (insemAvgInt)  insemAvgInt.textContent  = String(avgInt);
      } else {
        if (insemLastInt) insemLastInt.textContent = '—';
        if (insemAvgInt)  insemAvgInt.textContent  = '—';
      }

      // أيام منذ آخر تلقيح + حساب حمل وتاريخ ولادة متوقع
      const lastInsem = insemEvents.length ? insemEvents[insemEvents.length-1] : null;
      if (lastInsemEl) lastInsemEl.textContent = lastInsem ? fmt.format(lastInsem) : '—';
      if (daysSinceInsemEl) daysSinceInsemEl.textContent = lastInsem ? String(daysBetween(lastInsem, new Date())) : '—';

      const aType = animalDoc.type || animalDoc.animalType || '';
      let gestStd = 280; // أبقار
      if (/جاموس/i.test(aType) || /buffalo/i.test(aType)) gestStd = 310; // جاموس

      const reproTxt = animalDoc.reproductiveStatus || animalDoc.reproStatus || '';
      const isPreg = /عشار|preg/i.test(reproTxt);
      if (isPreg && lastInsem) {
        const gd = daysBetween(lastInsem, new Date());
        if (gestDaysEl)    gestDaysEl.textContent = String(gd);
        const exp = new Date(lastInsem.getTime());
        exp.setDate(exp.getDate() + gestStd);
        if (expectedCalvingEl) expectedCalvingEl.textContent = fmt.format(exp);
      } else {
        if (gestDaysEl)    gestDaysEl.textContent = '—';
        if (expectedCalvingEl) expectedCalvingEl.textContent = '—';
      }

      // سهولة الولادة الأخيرة
      const lastCalvingEvent = rows.filter(r => {
        const t = (r.type || r.eventType || '').toString().toLowerCase();
        return t.includes('ولاد') || t.includes('calv');
      }).sort((a,b)=> (toJsDate(b.eventDate||b.date||b.createdAt||b.timestamp) - toJsDate(a.eventDate||a.date||a.createdAt||a.timestamp)))[0];
      if (calvingEaseEl) calvingEaseEl.textContent = lastCalvingEvent ? (lastCalvingEvent.calvingEase || lastCalvingEvent.ease || lastCalvingEvent.dystocia || lastCalvingEvent.score || '—') : '—';

      // الحالة الإنتاجية + DIM (في البيانات الأساسية)
      let lastCalving = animalDoc.lastCalvingDate || animalDoc.lastCalving || null;
      lastCalving = toJsDate(lastCalving);
      if (!lastCalving) {
        const calvings = rows.filter(r => {
          const t = (r.type || r.eventType || '').toString().toLowerCase();
          return t.includes('ولاد') || t.includes('calv');
        }).map(r => toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp)).filter(Boolean).sort((a,b)=>b-a);
        if (calvings.length) lastCalving = calvings[0];
      }
      if (vDim) vDim.textContent = lastCalving ? String(daysBetween(lastCalving, new Date())) : '—';

      // الذكاء الصحي — آخر تشخيص
      const diagnosisEvents = rows.filter(r => {
        const t = (r.type || r.eventType || '').toString().toLowerCase();
        return t.includes('تشخيص') || t.includes('مرض') || t.includes('diagnos') || t.includes('disease');
      }).sort((a,b)=> (toJsDate(b.eventDate||b.date||b.createdAt||b.timestamp) - toJsDate(a.eventDate||a.date||a.createdAt||a.timestamp)));

      if (diagnosisEvents.length) {
        const last = diagnosisEvents[0];
        const name = last.diseaseName || last.diagnosis || last.diagnosisName || last.disease || '—';
        if (lastDiagEl)   lastDiagEl.textContent   = name;
        if (lastDiagDtEl) lastDiagDtEl.textContent = fmt.format(toJsDate(last.eventDate||last.date||last.createdAt||last.timestamp));
      } else {
        if (lastDiagEl)   lastDiagEl.textContent   = '—';
        if (lastDiagDtEl) lastDiagDtEl.textContent = '—';
      }

      // جدول التحصينات
      if (vaccTbody) {
        const vaccs = rows.filter(r => {
          const t = (r.type || r.eventType || '').toString().toLowerCase();
          return t.includes('تحص') || t.includes('vacc');
        }).sort((a,b)=> (toJsDate(b.eventDate||b.date||b.createdAt||b.timestamp) - toJsDate(a.eventDate||a.date||a.createdAt||a.timestamp)));
        vaccTbody.innerHTML = vaccs.map(v => {
          const name = v.vaccineName || v.vaccinationName || v.name || v.vaccine || '—';
          const dt   = fmt.format(toJsDate(v.eventDate||v.date||v.createdAt||v.timestamp));
          const dose = v.doseType || v.dose || v.booster || '—';
          return `<tr><td style="padding:8px; border-bottom:1px solid var(--border);">${name}</td><td style="padding:8px; border-bottom:1px solid var(--border);">${dt}</td><td style="padding:8px; border-bottom:1px solid var(--border);">${dose}</td></tr>`;
        }).join('');
      }

      // ذكاء الألبان — اليومي/الشهري/الموسم
      const milkEvents = rows.map(r => ({
        dt: toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp),
        milk: (r.milkKg ?? r.milk ?? r.dailyMilk ?? r.quantity ?? r.amount)
      })).filter(x => x.dt && (x.milk ?? null) != null);

      const today = new Date();
      const month = today.getMonth();
      const year  = today.getFullYear();

      const sum = (arr) => arr.reduce((a,b)=> a + Number(b.milk||0), 0);

      const todayMilk = sum(milkEvents.filter(x => isSameDay(x.dt, today)));
      const monthMilk = sum(milkEvents.filter(x => x.dt.getMonth()===month && x.dt.getFullYear()===year));
      const seasonMilk = lastCalving ? sum(milkEvents.filter(x => x.dt >= lastCalving)) : null;

      if (milkTodayEl)  milkTodayEl.textContent  = todayMilk ? String(todayMilk) : '—';
      if (milkMonthEl)  milkMonthEl.textContent  = monthMilk ? String(monthMilk) : '—';
      if (milkSeasonEl) milkSeasonEl.textContent = (seasonMilk!=null) ? String(seasonMilk) : '—';

      // حساب الأسبوع (آخر 7 أيام)
      try {
        const today2 = new Date();
        const weekAgo2 = new Date(today2.getFullYear(), today2.getMonth(), today2.getDate()-6);
        const sum2 = (arr) => arr.reduce((a,b)=> a + Number(b.milk||0), 0);
        const weekMilk2  = sum2(milkEvents.filter(x => x.dt >= weekAgo2));
        if (milkWeekEl) milkWeekEl.textContent = weekMilk2 ? String(weekMilk2) : '—';
      } catch {}
}

    // رسم منحنى إنتاج اللبن اليومي (Chart.js)
    async function loadMilkSeries(docId, number, preRows) {
      const st = document.getElementById('milkStatus');
      const canvas = document.getElementById('milkChart');
      try {
        let rows = preRows;
        if (!rows) rows = await loadAllEvents(docId, number);
        const series = rows.map(r => {
          const milk = (r.milkKg ?? r.milk ?? r.dailyMilk ?? r.quantity ?? r.amount);
          const dt = toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp);
          return { dt, milk };
        }).filter(r => r.dt && (r.milk ?? null) != null);
        if (series.length === 0) { if (st) st.textContent = 'لا توجد قراءات لإنتاج اللبن بعد.'; return; }
        series.sort((a,b)=> a.dt - b.dt);
        const labels = series.map(r => new Intl.DateTimeFormat('ar-EG', { month: 'short', day: 'numeric' }).format(r.dt));
        const data   = series.map(r => Number(r.milk));
        if (typeof Chart === 'undefined') { if (st) st.textContent = 'تعذّر تحميل مكتبة الرسم.'; return; }
        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: 'إنتاج اللبن (كجم)', data, tension: 0.3, fill: false, borderWidth: 2, pointRadius: 2 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 6 } }, y: { beginAtZero: true } } }
        });
        if (st) st.textContent = `آخر ${data.length} قراءة.`;
      } catch (e) {
        console.error('milk chart error', e);
        if (st) st.textContent = 'حدث خطأ أثناء تحميل القراءات.';
      }
    }

    // 4) تحميل الوثيقة حسب docId من الاستعلام ?id=...
    let docId = getQP('id') || getQP('docId') || getQP('number');

    if (!docId) {
      infoBox.style.display = 'none';
      errBox.style.display = 'block';
      errBox.querySelector('.status').textContent = 'لا يوجد معرّف للحيوان في الرابط.';
      throw new Error('Missing ?id');
    }

    status.textContent = 'جارِ التحقق من المستخدم…';

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        status.textContent = 'لم يتم تسجيل الدخول — سيتم تحويلك إلى صفحة الدخول…';
        setTimeout(() => { location.href = 'login.html'; }, 900);
        return;
      }

      try {
        status.textContent = 'جارِ تحميل بيانات الحيوان…';
        const ref = doc(db, 'animals', docId);
        const snap = await getDoc(ref);
        if (!snap.exists()) throw new Error('document-not-found');
        const a = snap.data();

        // دعم حقول قديمة وحديثة
        const numberFromUrl = getQP('animalNumber') || getQP('number') || getQP('cowNumber') || getQP('buffaloNumber') || getQP('animal_no') || '';
        const number = (a.number || a.animalNumber || a.animal_no || a.tag || a.earTag || a.earNo || a.code || a.idNumber || a.animalId || numberFromUrl || '—');
        const typeRaw = (a.type || a.animalType || '').toString();
        const typeNorm = typeRaw.trim().toLowerCase();
        let tType = 'الحيوان';
        const breed  = a.breed || '—';
        const prod   = a.productionStatus || a.prodStatus || '—';
        const repro  = a.reproductiveStatus || a.reproStatus || '—';
        const milk   = (a.dailyMilkProduction ?? a.milk ?? '—');
        const lactDoc = (a.lactationNumber ?? a.lactNum ?? a.parity ?? a.seasonNumber ?? a.lactation ?? null);
        if (vLact) vLact.textContent = (lactDoc != null) ? String(lactDoc) : '—';
        const lastC  = a.lastCalvingDate || a.lastCalving || null;
        const lastI  = a.lastInseminationDate || a.lastInsem || null;
        const dob    = a.birthDate || a.dob || null;
        vBreed.textContent  = breed;
        vProd.textContent   = prod;
        vRepro.textContent  = repro;
        if (vGroup) vGroup.textContent = (a.group || a.groupName || a.pen || a.barnGroup || '—');
        if (vLastC) vLastC.textContent = asDate(lastC);
        if (vLastI) vLastI.textContent = asDate(lastI);
        vDob.textContent    = asDate(dob);
        // تحديث عنوان الصفحة بالنوع ورقم الحيوان
        if (titleEl) {
          tType = 'الحيوان';
          if (/بقر/.test(typeNorm) || /cow/.test(typeNorm)) tType = 'البقرة';
          else if (/جاموس/.test(typeNorm) || /buffalo/.test(typeNorm)) tType = 'الجاموسة';
          titleEl.textContent = `بطاقة ${tType}${(number && number !== '—') ? ` رقم (${number})` : ''}`;
        }
        if (badgeEl) {
          if (number && number !== '—') { badgeEl.textContent = String(number); badgeEl.style.display = 'inline-flex'; }
          else { badgeEl.style.display = 'none'; }
        }
        

        // تحميل الأجواء الذكية + الرسم البياني
        const events = await loadAllEvents(docId, number);
        await fillSmartSections(events, a);
        // تحديث رقم موسم الحليب من عدد الولادات إن لم يكن موجودًا في الوثيقة
        try {
          const calvCount = events.filter(r => {
            const t = (r.type || r.eventType || '').toString().toLowerCase();
            return t.includes('ولاد') || t.includes('calv');
          }).length;
          if (vLact && (vLact.textContent === '—' || vLact.textContent === '' )) {
            vLact.textContent = calvCount ? String(calvCount) : '—';
          }
        } catch {}
        await loadMilkSeries(docId, number, events);

        // حفظ آخر حيوان لسهولة الإبحار الذكي
        localStorage.setItem('lastAnimalDocId', docId);
        if (number && number !== '—') localStorage.setItem('lastAnimalNumber', number);

        // زر تسجيل حدث: نمرر كل ما يفيد الصفحة التالية
        const urlNumParam2 = getQP('animalNumber') || getQP('number') || getQP('cowNumber') || getQP('buffaloNumber') || getQP('animal_no') || '';
        const numForLink2 = (number && number !== '—') ? String(number) : String(urlNumParam2 || '');
        const typeForLink = (a.type || a.animalType || '');
        const qp2 = new URLSearchParams({
          docId,
          animalDocId: docId,
          animalNumber: numForLink2,
          number: numForLink2,
          cowNumber: numForLink2,
          buffaloNumber: numForLink2,
          animal_no: numForLink2,
          type: typeForLink,
          animalType: typeForLink
        });
        btnAddEvent.href = `add-event.html?${qp2.toString()}`;

        infoBox.classList.remove('loading');
        status.innerHTML = '<span class="ok">✓ تم تحميل بطاقة الحيوان بنجاح.</span>';
      } catch (err) {
        console.error(err);
        infoBox.style.display = 'none';
        errBox.style.display = 'block';
        const msg = (err?.message === 'document-not-found')
          ? 'الوثيقة غير موجودة.'
          : 'حدث خطأ أثناء تحميل البيانات.';
        errBox.querySelector('.status').textContent = msg;
      }
    });
  </script>
</body>
</html>
