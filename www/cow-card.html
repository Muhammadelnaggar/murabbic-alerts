<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #1b8f3a;
      --yellow: #fff9cc;
      --text: #222;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic", sans-serif;
      background: var(--yellow);
      color: var(--text);
    }
    header {
      background: var(--green);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px; flex-wrap: wrap;
    }
    header .title {
      font-size: 26px;
      font-weight: 800;
      line-height: 1.2;
    }
    main { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    
    .item { padding: 14px; border-radius: 12px; border: 1px dashed var(--border); background:#fff; display:block; }
    .label { font-size: 16px; font-weight: 800; color: var(--green); margin: 0 0 6px; }
    .value { font-size: 19px; font-weight: 800; color: #111; }
    .toolbar { display:flex; flex-wrap: wrap; gap:10px; margin: 16px 0 0; }
    .btn {
      appearance: none; border: 0; cursor: pointer;
      background: var(--green); color: #fff; font-weight: 700;
      padding: 10px 14px; border-radius: 999px; transition: transform .05s ease;
      text-decoration: none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn.secondary { background: #fff; color: var(--green); border: 2px solid var(--green); }
    .btn:active { transform: translateY(1px); }
    .status { margin-top: 12px; font-size: 14px; color: var(--muted); }
    .error { color: #b91c1c; font-weight: 700; }
    .ok { color: var(--green); font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .loading { opacity: .7; }
      /* ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© */
    .tabs { display:flex; gap:8px; padding:8px 16px; position: sticky; top: 0; background: var(--yellow); z-index: 5; border-bottom: 1px solid var(--border); }
    .tab { appearance:none; border:1px solid var(--green); background:#fff; color:var(--green); font-weight:700; padding:8px 12px; border-radius:999px; cursor:pointer; }
    .tab.active { background: var(--green); color:#fff; }
    .tab-section { display:block; }
    .tab-section.active { display:block; }
    .section-title{font-size:22px;font-weight:900;color:var(--green);margin:0 0 10px;}
    .cow-value{display:flex;align-items:center;gap:12px;margin:6px 0 12px;}
    .badge-score{font-size:24px;font-weight:900;letter-spacing:2px;background:#e8f5ea;color:#14532d;border:2px solid var(--green);border-radius:12px;padding:6px 10px;min-width:140px;text-align:center;}
    .cow-value .hint{color:var(--muted);font-size:13px;}
      .page-actions{position:fixed; inset-inline:0; bottom:0; background:var(--yellow); padding:12px 16px calc(12px + env(safe-area-inset-bottom)); border-top:1px solid var(--border); box-shadow:0 -8px 24px rgba(0,0,0,.08); z-index:1000; display:flex; flex-direction:column; gap:10px; align-items:center;}
    main{padding-bottom:calc(200px + env(safe-area-inset-bottom));}
      .page-actions .actions-secondary{display:flex; gap:10px; flex-wrap:wrap; justify-content:center;}
    .page-actions .btn.main{width:100%; max-width:520px; font-size:17px; padding:14px 18px;}
      .badge-number{display:none;background:#fff;color:var(--green);border:2px solid var(--green);border-radius:999px;padding:4px 12px;font-weight:900;font-size:16px;line-height:1;}
  </style>
</head>
<body>
  <header>
    <div class="title" id="page-title">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</div>
    <span id="badge-number" class="badge-number" title="Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†">â€”</span>
  </header>
  </header>
<!-- KPIs: Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† -->
<section id="animal-kpis" class="card kpis" aria-label="Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†">
  <div class="kpi">
    <div class="kpi-label">DIM (Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ù„Ø¨Ù†)</div>
    <div id="kpi-dim" class="kpi-val">â€”</div>
  </div>
  <div class="kpi">
    <div class="kpi-label">Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­</div>
    <div id="kpi-last-ins" class="kpi-val">â€”</div>
  </div>
  <div class="kpi">
    <div class="kpi-label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
    <div id="kpi-status" class="kpi-val">â€”</div>
  </div>
</section>

  <!-- [ANIMAL-KPIS] Ø´Ø±Ø§Ø¦Ø· Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù† -->
  <div id="kpi-timeline-card" style="margin:8px 12px 0;"></div>

  <!-- Ø¨Ù‚ÙŠØ© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙŠÙƒÙ…Ù‘Ù„ Ù‡Ù†Ø§... -->

  <main>
    
    <section class="tab-section active" id="tab-overview">
      <div id="info" class="card loading">
        <div class="row">
          <div class="card" id="veCard" style="display:none; margin-top:10px; border:1px solid #c5e1a5; border-radius:12px; padding:12px; background:#f1f8e9">
  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
    <span style="background:#dcedc8;border:1px solid #c5e1a5;border-radius:999px;padding:6px 10px;display:inline-flex;gap:6px;align-items:center">
      <b>ğŸ“· Ø¢Ø®Ø± ØªÙ‚ÙŠÙŠÙ… Ø¨ØµØ±ÙŠ</b>
    </span>
    <span id="veDate" style="font-weight:bold;color:#2e7d32">â€”</span>
    <span id="veGrade" style="margin-inline-start:auto;font-weight:bold;">â€”</span>
  </div>
  <div style="margin-top:8px; display:flex; gap:12px; flex-wrap:wrap">
    <div style="background:#fff;border:1px solid #e0ebd3;border-radius:10px;padding:8px 10px;min-width:120px;text-align:center">
      <div class="muted">Ø§Ù„Ø¯Ø±Ø¬Ø©</div>
      <b id="veScore">â€”</b>
    </div>
    <div style="background:#fff;border:1px solid #e0ebd3;border-radius:10px;padding:8px 10px;min-width:160px;flex:1">
      <div class="muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø®ØªØµØ±Ø©</div>
      <ul id="veFlags" style="margin:6px 16px; padding:0 0 0 14px"></ul>
    </div>
  </div>
</div>

          <div class="item"><div class="label">Ø§Ù„Ø³Ù„Ø§Ù„Ø©</div><div id="v-breed" class="value">â€”</div></div>
          <div class="item"><div class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</div><div id="v-dob" class="value">â€”</div></div>
          <div class="item"><div class="label">Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨</div><div id="v-dim" class="value">â€”</div></div>
          <div class="item"><div class="label">Ø±Ù‚Ù… Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨</div><div id="v-lact" class="value">â€”</div></div>
          <div class="item"><div class="label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</div><div id="v-prod" class="value">â€”</div></div>
          <div class="item"><div class="label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©</div><div id="v-repro" class="value">â€”</div></div>
          <div class="item"><div class="label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div><div id="v-group" class="value">â€”</div></div>
        </div>
        
        <div id="status" class="status">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
      </div>
    </section>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ© -->
    <div id="reproCard" class="card" style="margin-top:12px;">
      <h3 class="section-title">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©</h3>
      <div class="row">
        <div class="item"><div class="label">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙ„Ù‚ÙŠØ­</div><div id="sm-insem-count" class="value">â€”</div></div>
        <div class="item"><div class="label">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­</div><div id="sm-last-insem" class="value">â€”</div></div>
        <div class="item"><div class="label">Ø§Ù„Ø£ÙŠØ§Ù… Ù…Ù†Ø° Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­</div><div id="sm-days-since-insem" class="value">â€”</div></div>
        <div class="item"><div class="label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¯Ø© Ø¨ÙŠÙ† Ø§Ù„ØªÙ„Ù‚ÙŠØ­Ø§Øª (ÙŠÙˆÙ…)</div><div id="sm-insem-avg-interval" class="value">â€”</div></div>
        <div class="item"><div class="label">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù…Ù„ (Ù„Ùˆ Ø¹Ø´Ø§Ø±)</div><div id="sm-gestation-days" class="value">â€”</div></div>
        <div class="item"><div class="label">Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©</div><div id="sm-calving-ease" class="value">â€”</div></div>
        <div class="item"><div class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div><div id="sm-expected-calving" class="value">â€”</div></div>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© -->
    <section id="milk-section">
      <div id="milkCard" class="card" style="margin-top:12px;">
        <h3 class="section-title">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</h3>
        <div class="row">
          <div class="item"><div class="label">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ… (ÙƒØ¬Ù…)</div><div id="sm-milk-today" class="value">â€”</div></div>
          <div class="item"><div class="label">Ø¥Ù†ØªØ§Ø¬ Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù… (ÙƒØ¬Ù…)</div><div id="sm-milk-week" class="value">â€”</div></div>
          <div class="item"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (ÙƒØ¬Ù…)</div><div id="sm-milk-month" class="value">â€”</div></div>
          <div class="item"><div class="label">Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ù…Ù†Ø° Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…ÙˆØ³Ù… (ÙƒØ¬Ù…)</div><div id="sm-milk-season" class="value">â€”</div></div>
        </div>
        <h3 class="section-title" style="margin:12px 0 8px;">Ù…Ù†Ø­Ù†Ù‰ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
        <div id="milkWrap" style="height:260px; position:relative;">
          <canvas id="milkChart" aria-label="Ù…Ù†Ø­Ù†Ù‰ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†" role="img"></canvas>
        </div>
        <div id="milkStatus" class="status">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øªâ€¦</div>
      </div>
    </section>

    <div id="errorBox" class="card" style="display:none">
      <div class="error">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†.</div>
      <div class="status">ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. Ø¥Ø°Ø§ ÙØªØ­Øª Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙØ§Ù„Ù…ÙØªØ±Ø¶ Ø£Ù† ÙŠØ¹Ù…Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
      <div class="toolbar"><a class="btn secondary" href="animal-list.html">Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</a></div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© -->
    <div id="healthCard" class="card" style="margin-top:12px;">
      <h3 class="section-title">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©</h3>
      <div class="row">
        <div class="item"><div class="label">Ø¢Ø®Ø± ØªØ´Ø®ÙŠØµ</div><div id="sm-last-diagnosis" class="value">â€”</div></div>
        <div class="item"><div class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ´Ø®ÙŠØµ</div><div id="sm-last-diagnosis-date" class="value">â€”</div></div>
      </div>
      <h3 class="section-title" style="margin:12px 0 8px;">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†Ø§Øª</h3>
      <div style="overflow-x:auto;">
        <table id="vaccTable" style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align:right; border-bottom:1px solid var(--border); padding:8px;">Ø§Ø³Ù… Ø§Ù„ØªØ­ØµÙŠÙ†</th>
              <th style="text-align:right; border-bottom:1px solid var(--border); padding:8px;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ†</th>
              <th style="text-align:right; border-bottom:1px solid var(--border); padding:8px;">Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¹Ø©</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ -->
    <div id="evalCard" class="card" style="margin-top:12px;">
      <h3 class="section-title">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ</h3>
      <div class="hint">Ù‚ÙŠÙ…Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù…Ø¨Ø³Ù‘Ø·Ø© Ù…ÙˆØ¬Ù‘Ù‡Ø© Ù„Ù„Ù…Ø±Ø¨ÙŠ (Cow Value)</div>
      </div>
      <div class="row">
        <div class="item"><div class="label">Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</div><div class="value" id="ev-prod-class">â€”</div></div>
        <div class="item"><div class="label">Ù…Ø¤Ø´Ø± Ø§Ù„Ø®ØµÙˆØ¨Ø©</div><div class="value" id="ev-fertility">â€”</div></div>
        <div class="item"><div class="label">Ù…Ø¤Ø´Ø± Ø§Ù„ØµØ­Ø©</div><div class="value" id="ev-health">â€”</div></div>
        <div class="item"><div class="label">ØªÙƒÙ„ÙØ©/ÙƒØ¬Ù… Ù„Ø¨Ù† (ØªÙ‚Ø¯ÙŠØ±ÙŠ)</div><div class="value" id="ev-cost-milk">â€”</div></div>
      </div>
      <h3 class="section-title" style="margin:12px 0 8px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙ†ÙŠØ©</h3>
      <ul id="evalList" style="margin:0; padding-inline-start:18px; line-height:1.9;">
        <li>â€”</li>
      </ul>
    </div>

    <div class="toolbar page-actions">
      <a id="btn-add-event" class="btn main" href="#">+ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</a>
      <div class="actions-secondary">
        <a id="btn-dashboard" class="btn secondary" href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a id="btn-back-list" class="btn secondary" href="animal-list.html">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</a>
      </div>
    </div>
  </main>

  <!-- ØªØ¹ØªÙ…Ø¯ Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ Ù…Ù„Ù firebase-config.js Ø§Ù„Ø°ÙŠ ÙŠÙ‡ÙŠØ¦ Firebase ÙˆÙŠØµØ¯Ù‘Ø± auth Ùˆ db -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    // 1) Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase v10 (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù†Ø³Ø®Ø© Ù…Ø´Ø±ÙˆØ¹Ùƒ) + auth/db Ù…Ù† firebase-config.js
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { doc, getDoc, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { auth, db } from './js/firebase-config.js';

// 2) Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø¥Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    // one-page layout: no tabs
    const infoBox = document.getElementById('info');
    const errBox  = document.getElementById('errorBox');
    const status  = document.getElementById('status');
    const titleEl = document.getElementById('page-title');
    const vBreed  = document.getElementById('v-breed');
    const vProd   = document.getElementById('v-prod');
    const vRepro  = document.getElementById('v-repro');
    const vLastC  = document.getElementById('v-lastCalving');
    const vLastI  = document.getElementById('v-lastInsem');
    const vDob    = document.getElementById('v-dob');
    const vLact   = document.getElementById('v-lact');
    const vDim    = document.getElementById('v-dim');
    const vGroup  = document.getElementById('v-group');
    const badgeEl = document.getElementById('badge-number');
    const btnAddEvent = document.getElementById('btn-add-event');

    // 3) Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
    

    // 3) Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
    const fmt = new Intl.DateTimeFormat('ar-EG', { dateStyle: 'medium' });
    const asDate = (x) => {
      if (!x) return 'â€”';
      // ÙŠÙ‚Ø¨Ù„ Timestamp Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Firestore Ø£Ùˆ Ù†Øµ ISO Ø£Ùˆ ØªØ§Ø±ÙŠØ® JS
      try {
        if (typeof x?.toDate === 'function') return fmt.format(x.toDate());
        const d = (typeof x === 'string') ? new Date(x) : x;
        if (!isNaN(d)) return fmt.format(d);
      } catch {}
      return 'â€”';
    };

    const getQP = (key) => new URLSearchParams(location.search).get(key);

    // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­ÙŠÙˆØ§Ù† (Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø©)
    async function loadAllEvents(docId, number) {
      const eventsRef = collection(db, 'events');
      let snap = await getDocs(query(eventsRef, where('animalDocId','==', docId)));
      let rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      if ((!rows || rows.length === 0) && number) {
        snap = await getDocs(query(eventsRef, where('animalNumber','==', String(number))));
        rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }
      return rows;
    }

    // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªÙˆØ§Ø±ÙŠØ®
    const toJsDate = (x) => {
      if (!x) return null;
      try { if (typeof x.toDate === 'function') return x.toDate(); } catch {}
      const d = (typeof x === 'string') ? new Date(x) : x;
      return isNaN(d) ? null : d;
    };
    const daysBetween = (a,b) => {
      if (!a || !b) return null;
      const ms = Math.abs(b - a);
      return Math.floor(ms / (1000*60*60*24));
    };
    const isSameDay = (a,b) => a && b && a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø¬ÙˆØ§Ø¡ Ø§Ù„Ø°ÙƒÙŠØ©
    async function fillSmartSections(rows, animalDoc) {
      const get = (id) => document.getElementById(id);
      const reproStatusEl = get('sm-repro-status');
      const lastInsemEl   = get('sm-last-insem');
      const insemCountEl  = get('sm-insem-count');
      const insemLastInt  = get('sm-insem-last-interval');
      const insemAvgInt   = get('sm-insem-avg-interval');

      const prodStatusEl  = get('sm-prod-status');
      const dimEl         = get('sm-dim');

      const lastDiagEl    = get('sm-last-diagnosis');
      const lastDiagDtEl  = get('sm-last-diagnosis-date');

      const milkTodayEl   = get('sm-milk-today');
      const milkWeekEl    = get('sm-milk-week');
      const milkMonthEl   = get('sm-milk-month');
      const milkSeasonEl  = get('sm-milk-season');

      const daysSinceInsemEl = get('sm-days-since-insem');
      const gestDaysEl    = get('sm-gestation-days');
      const expectedCalvingEl = get('sm-expected-calving');
      const calvingEaseEl = get('sm-calving-ease');

      const vaccTbody = document.querySelector('#vaccTable tbody');

      // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©
      const repro = animalDoc.reproductiveStatus || animalDoc.reproStatus || 'â€”';
      if (reproStatusEl) reproStatusEl.textContent = repro;

      const insemEvents = rows.filter(r => {
        const t = (r.type || r.eventType || '').toString().toLowerCase();
        return t.includes('ØªÙ„Ù‚ÙŠ') || t.includes('insemin');
      }).map(r => toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp)).filter(Boolean).sort((a,b)=>a-b);

      if (insemCountEl) insemCountEl.textContent = insemEvents.length ? String(insemEvents.length) : 'â€”';
      if (lastInsemEl)  lastInsemEl.textContent  = insemEvents.length ? fmt.format(insemEvents[insemEvents.length-1]) : 'â€”';

      if (insemEvents.length >= 2) {
        const intervals = insemEvents.slice(1).map((d,i)=> daysBetween(insemEvents[i], d)).filter(v=>v!=null);
        const lastInt   = intervals[intervals.length-1];
        const avgInt    = Math.round(intervals.reduce((a,b)=>a+b,0)/intervals.length);
        if (insemLastInt) insemLastInt.textContent = String(lastInt);
        if (insemAvgInt)  insemAvgInt.textContent  = String(avgInt);
      } else {
        if (insemLastInt) insemLastInt.textContent = 'â€”';
        if (insemAvgInt)  insemAvgInt.textContent  = 'â€”';
      }

      // Ø£ÙŠØ§Ù… Ù…Ù†Ø° Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­ + Ø­Ø³Ø§Ø¨ Ø­Ù…Ù„ ÙˆØªØ§Ø±ÙŠØ® ÙˆÙ„Ø§Ø¯Ø© Ù…ØªÙˆÙ‚Ø¹
      const lastInsem = insemEvents.length ? insemEvents[insemEvents.length-1] : null;
      if (lastInsemEl) lastInsemEl.textContent = lastInsem ? fmt.format(lastInsem) : 'â€”';
      if (daysSinceInsemEl) daysSinceInsemEl.textContent = lastInsem ? String(daysBetween(lastInsem, new Date())) : 'â€”';

      const aType = animalDoc.type || animalDoc.animalType || '';
      let gestStd = 280; // Ø£Ø¨Ù‚Ø§Ø±
      if (/Ø¬Ø§Ù…ÙˆØ³/i.test(aType) || /buffalo/i.test(aType)) gestStd = 310; // Ø¬Ø§Ù…ÙˆØ³

      const reproTxt = animalDoc.reproductiveStatus || animalDoc.reproStatus || '';
      const isPreg = /Ø¹Ø´Ø§Ø±|preg/i.test(reproTxt);
      if (isPreg && lastInsem) {
        const gd = daysBetween(lastInsem, new Date());
        if (gestDaysEl)    gestDaysEl.textContent = String(gd);
        const exp = new Date(lastInsem.getTime());
        exp.setDate(exp.getDate() + gestStd);
        if (expectedCalvingEl) expectedCalvingEl.textContent = fmt.format(exp);
      } else {
        if (gestDaysEl)    gestDaysEl.textContent = 'â€”';
        if (expectedCalvingEl) expectedCalvingEl.textContent = 'â€”';
      }

      // Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©
      const lastCalvingEvent = rows.filter(r => {
        const t = (r.type || r.eventType || '').toString().toLowerCase();
        return t.includes('ÙˆÙ„Ø§Ø¯') || t.includes('calv');
      }).sort((a,b)=> (toJsDate(b.eventDate||b.date||b.createdAt||b.timestamp) - toJsDate(a.eventDate||a.date||a.createdAt||a.timestamp)))[0];
      if (calvingEaseEl) calvingEaseEl.textContent = lastCalvingEvent ? (lastCalvingEvent.calvingEase || lastCalvingEvent.ease || lastCalvingEvent.dystocia || lastCalvingEvent.score || 'â€”') : 'â€”';

      // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© + DIM (ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)
      let lastCalving = animalDoc.lastCalvingDate || animalDoc.lastCalving || null;
      lastCalving = toJsDate(lastCalving);
      if (!lastCalving) {
        const calvings = rows.filter(r => {
          const t = (r.type || r.eventType || '').toString().toLowerCase();
          return t.includes('ÙˆÙ„Ø§Ø¯') || t.includes('calv');
        }).map(r => toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp)).filter(Boolean).sort((a,b)=>b-a);
        if (calvings.length) lastCalving = calvings[0];
      }
      if (vDim) vDim.textContent = lastCalving ? String(daysBetween(lastCalving, new Date())) : 'â€”';

      // Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµØ­ÙŠ â€” Ø¢Ø®Ø± ØªØ´Ø®ÙŠØµ
      const diagnosisEvents = rows.filter(r => {
        const t = (r.type || r.eventType || '').toString().toLowerCase();
        return t.includes('ØªØ´Ø®ÙŠØµ') || t.includes('Ù…Ø±Ø¶') || t.includes('diagnos') || t.includes('disease');
      }).sort((a,b)=> (toJsDate(b.eventDate||b.date||b.createdAt||b.timestamp) - toJsDate(a.eventDate||a.date||a.createdAt||a.timestamp)));

      if (diagnosisEvents.length) {
        const last = diagnosisEvents[0];
        const name = last.diseaseName || last.diagnosis || last.diagnosisName || last.disease || 'â€”';
        if (lastDiagEl)   lastDiagEl.textContent   = name;
        if (lastDiagDtEl) lastDiagDtEl.textContent = fmt.format(toJsDate(last.eventDate||last.date||last.createdAt||last.timestamp));
      } else {
        if (lastDiagEl)   lastDiagEl.textContent   = 'â€”';
        if (lastDiagDtEl) lastDiagDtEl.textContent = 'â€”';
      }

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­ØµÙŠÙ†Ø§Øª
      if (vaccTbody) {
        const vaccs = rows.filter(r => {
          const t = (r.type || r.eventType || '').toString().toLowerCase();
          return t.includes('ØªØ­Øµ') || t.includes('vacc');
        }).sort((a,b)=> (toJsDate(b.eventDate||b.date||b.createdAt||b.timestamp) - toJsDate(a.eventDate||a.date||a.createdAt||a.timestamp)));
        vaccTbody.innerHTML = vaccs.map(v => {
          const name = v.vaccineName || v.vaccinationName || v.name || v.vaccine || 'â€”';
          const dt   = fmt.format(toJsDate(v.eventDate||v.date||v.createdAt||v.timestamp));
          const dose = v.doseType || v.dose || v.booster || 'â€”';
          return `<tr><td style="padding:8px; border-bottom:1px solid var(--border);">${name}</td><td style="padding:8px; border-bottom:1px solid var(--border);">${dt}</td><td style="padding:8px; border-bottom:1px solid var(--border);">${dose}</td></tr>`;
        }).join('');
      }

      // Ø°ÙƒØ§Ø¡ Ø§Ù„Ø£Ù„Ø¨Ø§Ù† â€” Ø§Ù„ÙŠÙˆÙ…ÙŠ/Ø§Ù„Ø´Ù‡Ø±ÙŠ/Ø§Ù„Ù…ÙˆØ³Ù…
      const milkEvents = rows.map(r => ({
        dt: toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp),
        milk: (r.milkKg ?? r.milk ?? r.dailyMilk ?? r.quantity ?? r.amount)
      })).filter(x => x.dt && (x.milk ?? null) != null);

      const today = new Date();
      const month = today.getMonth();
      const year  = today.getFullYear();

      const sum = (arr) => arr.reduce((a,b)=> a + Number(b.milk||0), 0);

      const todayMilk = sum(milkEvents.filter(x => isSameDay(x.dt, today)));
      const monthMilk = sum(milkEvents.filter(x => x.dt.getMonth()===month && x.dt.getFullYear()===year));
      const seasonMilk = lastCalving ? sum(milkEvents.filter(x => x.dt >= lastCalving)) : null;

      if (milkTodayEl)  milkTodayEl.textContent  = todayMilk ? String(todayMilk) : 'â€”';
      if (milkMonthEl)  milkMonthEl.textContent  = monthMilk ? String(monthMilk) : 'â€”';
      if (milkSeasonEl) milkSeasonEl.textContent = (seasonMilk!=null) ? String(seasonMilk) : 'â€”';

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)
      try {
        const today2 = new Date();
        const weekAgo2 = new Date(today2.getFullYear(), today2.getMonth(), today2.getDate()-6);
        const sum2 = (arr) => arr.reduce((a,b)=> a + Number(b.milk||0), 0);
        const weekMilk2  = sum2(milkEvents.filter(x => x.dt >= weekAgo2));
        if (milkWeekEl) milkWeekEl.textContent = weekMilk2 ? String(weekMilk2) : 'â€”';
      } catch {}
}

    // Ø±Ø³Ù… Ù…Ù†Ø­Ù†Ù‰ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ (Chart.js)
    async function loadMilkSeries(docId, number, preRows) {
      const st = document.getElementById('milkStatus');
      const canvas = document.getElementById('milkChart');
      try {
        let rows = preRows;
        if (!rows) rows = await loadAllEvents(docId, number);
        const series = rows.map(r => {
          const milk = (r.milkKg ?? r.milk ?? r.dailyMilk ?? r.quantity ?? r.amount);
          const dt = toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp);
          return { dt, milk };
        }).filter(r => r.dt && (r.milk ?? null) != null);
        if (series.length === 0) { if (st) st.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† Ø¨Ø¹Ø¯.'; return; }
        series.sort((a,b)=> a.dt - b.dt);
        const labels = series.map(r => new Intl.DateTimeFormat('ar-EG', { month: 'short', day: 'numeric' }).format(r.dt));
        const data   = series.map(r => Number(r.milk));
        if (typeof Chart === 'undefined') { if (st) st.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø³Ù….'; return; }
        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: 'Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† (ÙƒØ¬Ù…)', data, tension: 0.3, fill: false, borderWidth: 2, pointRadius: 2 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 6 } }, y: { beginAtZero: true } } }
        });
        if (st) st.textContent = `Ø¢Ø®Ø± ${data.length} Ù‚Ø±Ø§Ø¡Ø©.`;
      } catch (e) {
        console.error('milk chart error', e);
        if (st) st.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª.';
      }
    }

    // 4) ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø­Ø³Ø¨ docId Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ?id=...
    let docId = getQP('id') || getQP('docId') || getQP('number');

    if (!docId) {
      infoBox.style.display = 'none';
      errBox.style.display = 'block';
      errBox.querySelector('.status').textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù‘Ù Ù„Ù„Ø­ÙŠÙˆØ§Ù† ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.';
      throw new Error('Missing ?id');
    }

    status.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…â€¦';

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        status.textContent = 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„â€¦';
        setTimeout(() => { location.href = 'login.html'; }, 900);
        return;
      }

      try {
        status.textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†â€¦';
        const ref = doc(db, 'animals', docId);
        const snap = await getDoc(ref);
        if (!snap.exists()) throw new Error('document-not-found');
        const a = snap.data();

        // Ø¯Ø¹Ù… Ø­Ù‚ÙˆÙ„ Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ­Ø¯ÙŠØ«Ø©
        const numberFromUrl = getQP('animalNumber') || getQP('number') || getQP('cowNumber') || getQP('buffaloNumber') || getQP('animal_no') || '';
        const number = (a.number || a.animalNumber || a.animal_no || a.tag || a.earTag || a.earNo || a.code || a.idNumber || a.animalId || numberFromUrl || 'â€”');
        const typeRaw = (a.type || a.animalType || '').toString();
        const typeNorm = typeRaw.trim().toLowerCase();
        let tType = 'Ø§Ù„Ø­ÙŠÙˆØ§Ù†';
        const breed  = a.breed || 'â€”';
        const prod   = a.productionStatus || a.prodStatus || 'â€”';
        const repro  = a.reproductiveStatus || a.reproStatus || 'â€”';
        const milk   = (a.dailyMilkProduction ?? a.milk ?? 'â€”');
        const lactDoc = (a.lactationNumber ?? a.lactNum ?? a.parity ?? a.seasonNumber ?? a.lactation ?? null);
        if (vLact) vLact.textContent = (lactDoc != null) ? String(lactDoc) : 'â€”';
        const lastC  = a.lastCalvingDate || a.lastCalving || null;
        const lastI  = a.lastInseminationDate || a.lastInsem || null;
        const dob    = a.birthDate || a.dob || null;
        vBreed.textContent  = breed;
        vProd.textContent   = prod;
        vRepro.textContent  = repro;
        if (vGroup) vGroup.textContent = (a.group || a.groupName || a.pen || a.barnGroup || 'â€”');
        if (vLastC) vLastC.textContent = asDate(lastC);
        if (vLastI) vLastI.textContent = asDate(lastI);
        vDob.textContent    = asDate(dob);
        // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ù†ÙˆØ¹ ÙˆØ±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†
        if (titleEl) {
          tType = 'Ø§Ù„Ø­ÙŠÙˆØ§Ù†';
          if (/Ø¨Ù‚Ø±/.test(typeNorm) || /cow/.test(typeNorm)) tType = 'Ø§Ù„Ø¨Ù‚Ø±Ø©';
          else if (/Ø¬Ø§Ù…ÙˆØ³/.test(typeNorm) || /buffalo/.test(typeNorm)) tType = 'Ø§Ù„Ø¬Ø§Ù…ÙˆØ³Ø©';
          titleEl.textContent = `Ø¨Ø·Ø§Ù‚Ø© ${tType}${(number && number !== 'â€”') ? ` Ø±Ù‚Ù… (${number})` : ''}`;
        }
        if (badgeEl) {
          if (number && number !== 'â€”') { badgeEl.textContent = String(number); badgeEl.style.display = 'inline-flex'; }
          else { badgeEl.style.display = 'none'; }
        }
        

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¬ÙˆØ§Ø¡ Ø§Ù„Ø°ÙƒÙŠØ© + Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        const events = await loadAllEvents(docId, number);
        await fillSmartSections(events, a);
        // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ ÙÙŠ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
        try {
          const calvCount = events.filter(r => {
            const t = (r.type || r.eventType || '').toString().toLowerCase();
            return t.includes('ÙˆÙ„Ø§Ø¯') || t.includes('calv');
          }).length;
          if (vLact && (vLact.textContent === 'â€”' || vLact.textContent === '' )) {
            vLact.textContent = calvCount ? String(calvCount) : 'â€”';
          }
        } catch {}
        await loadMilkSeries(docId, number, events);

        // Ø­ÙØ¸ Ø¢Ø®Ø± Ø­ÙŠÙˆØ§Ù† Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¨Ø­Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ
        localStorage.setItem('lastAnimalDocId', docId);
        if (number && number !== 'â€”') localStorage.setItem('lastAnimalNumber', number);

        // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø«: Ù†Ù…Ø±Ø± ÙƒÙ„ Ù…Ø§ ÙŠÙÙŠØ¯ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        const urlNumParam2 = getQP('animalNumber') || getQP('number') || getQP('cowNumber') || getQP('buffaloNumber') || getQP('animal_no') || '';
        const numForLink2 = (number && number !== 'â€”') ? String(number) : String(urlNumParam2 || '');
        const typeForLink = (a.type || a.animalType || '');
        const qp2 = new URLSearchParams({
          docId,
          animalDocId: docId,
          animalNumber: numForLink2,
          number: numForLink2,
          cowNumber: numForLink2,
          buffaloNumber: numForLink2,
          animal_no: numForLink2,
          type: typeForLink,
          animalType: typeForLink
        });
        btnAddEvent.href = `add-event.html?${qp2.toString()}`;

        infoBox.classList.remove('loading');
        status.innerHTML = '<span class="ok">âœ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­.</span>';
      } catch (err) {
        console.error(err);
        infoBox.style.display = 'none';
        errBox.style.display = 'block';
        const msg = (err?.message === 'document-not-found')
          ? 'Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.'
          : 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
        errBox.querySelector('.status').textContent = msg;
      }
    });
  </script>
  <script type="module">
  // Ø§Ù…Ø³Ùƒ Ø£ÙŠ Ø²Ø±/Ù„ÙŠÙ†Ùƒ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©
  const cowCardTargets = document.querySelectorAll(
    '[data-page="cow-card.html"], a[href$="cow-card.html"], a[href*="cow-card.html"], #btnCowCard'
  );

  function openCowCardWith(id){
    if (!id) return;
    localStorage.setItem('lastAnimalId', id);
    const qs = `animalId=${encodeURIComponent(id)}&number=${encodeURIComponent(id)}`;
    location.href = `cow-card.html?${qs}`;
  }

  function showMiniPrompt(){
    if (document.getElementById('quickPrompt')) return; // Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„
    const box = document.createElement('div');
    box.id = 'quickPrompt';
    box.style.cssText = `
      position:fixed; inset:auto 12px 12px 12px; z-index:9999;
      background:#f1f8e9; border:1px solid #c5e1a5; border-radius:12px;
      padding:12px; display:flex; gap:8px; align-items:center;
    `;
    box.innerHTML = `
      <span style="font-weight:bold;color:#2e7d32;white-space:nowrap">Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†:</span>
      <input id="qpInput" type="text" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 105"
             style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px">
      <button id="qpGo"
              style="padding:10px 14px;border:0;border-radius:8px;background:#2e7d32;color:#fff;font-weight:bold">
        ÙØªØ­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
      </button>
      <button id="qpClose"
              style="padding:10px 14px;border:1px solid #2e7d32;border-radius:8px;background:#fff;color:#2e7d32;font-weight:bold">
        Ø¥Ù„ØºØ§Ø¡
      </button>
    `;
    document.body.appendChild(box);
    const input = box.querySelector('#qpInput');
    const goBtn = box.querySelector('#qpGo');
    const clsBtn= box.querySelector('#qpClose');

    function go(){
      const v = (input.value || '').trim();
      if (v) { box.remove(); openCowCardWith(v); }
      else { input.focus(); }
    }
    goBtn.addEventListener('click', go);
    input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') go(); });
    clsBtn.addEventListener('click', ()=> box.remove());
    input.focus();
  }

  function handleCowCardClick(e){
    e.preventDefault();
    const qp = new URLSearchParams(location.search);
    const id = qp.get('animalId') || localStorage.getItem('lastAnimalId') || '';
    if (id) { openCowCardWith(id); }
    else { showMiniPrompt(); }
  }

  cowCardTargets.forEach(el => {
    el.addEventListener('click', handleCowCardClick);
  });
</script>
<script type="module">
  import { db } from './js/firebase-config.js';
  import { collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // Ø§Ø¬Ù„Ø¨ Ù…Ø¹Ø±Ù Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø¢Ø®Ø± Ù…Ø®ØªØ§Ø± Ù…Ø­Ù„ÙŠÙ‹Ø§
  const qs = new URLSearchParams(location.search);
  const animalId = qs.get('animalId') || qs.get('number') || localStorage.getItem('lastAnimalId') || '';

  const box     = document.getElementById('veCard');
  const elDate  = document.getElementById('veDate');
  const elScore = document.getElementById('veScore');
  const elGrade = document.getElementById('veGrade');
  const elFlags = document.getElementById('veFlags');

  // Ù†Ø¬Ø±Ù‘Ø¨ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ø³Ù… ÙƒÙˆÙ„ÙƒØ´Ù† Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ (Ø­Ø³Ø¨ Ù…Ø§ Ø­ÙØ¸ØªÙ‡ ÙÙŠ visual-eval.html)
  async function fetchLastVisualEval(id){
    if (!id) return null;
    const tryCollections = ['visualEvaluations', 'visual-evaluations', 'evaluations'];
    for (const colName of tryCollections){
      try{
        const q = query(
          collection(db, colName),
          where('animalId', '==', String(id)),
          orderBy('createdAt','desc'),
          limit(1)
        );
        const snap = await getDocs(q);
        if (!snap.empty) return { ...snap.docs[0].data(), id: snap.docs[0].id, _col: colName };
      }catch(e){
        // ØªØ¬Ø§Ù‡Ù„ ÙˆÙ†Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡
      }
    }
    return null;
  }

  function gradeLabel(score){
    if (score == null) return 'â€”';
    const s = Number(score);
    if (s >= 85) return 'Ù…Ù…ØªØ§Ø² ğŸŸ¢';
    if (s >= 70) return 'Ø¬ÙŠØ¯ âœ…';
    if (s >= 55) return 'Ù…Ù‚Ø¨ÙˆÙ„ âš ï¸';
    return 'Ø¨Ø­Ø§Ø¬Ø© Ù„ØªØ­Ø³ÙŠÙ† ğŸ”´';
  }

  function renderEval(ev){
    if (!ev){ box.style.display='none'; return; }
    const dt = ev.eventDate ? new Date(ev.eventDate) : (ev.createdAt?.toDate ? ev.createdAt.toDate() : null);
    elDate.textContent  = dt ? dt.toLocaleDateString('ar-EG') : 'â€”';
    elScore.textContent = ev.score != null ? Math.round(ev.score) : 'â€”';
    elGrade.textContent = gradeLabel(ev.score);

    elFlags.innerHTML = '';
    const flags = ev.flags || ev.issues || ev.findings || []; // ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø­Ù‚ÙˆÙ„ Ù…Ø­ØªÙ…Ù„Ø©
    if (Array.isArray(flags) && flags.length){
      flags.slice(0,5).forEach(f=>{
        const li=document.createElement('li'); li.textContent = f; elFlags.appendChild(li);
      });
    } else {
      const li=document.createElement('li'); li.textContent = 'Ù„Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ø§Ø±Ø²Ø©'; elFlags.appendChild(li);
    }
    box.style.display = 'block';
  }

  (async ()=>{
    const last = await fetchLastVisualEval(animalId);
    renderEval(last);
  })();
</script>
  <!-- ... Ø¨Ù‚ÙŠØ© Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„ØµÙØ­Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª -->
 <script src="js/cow-kpis.js?v=1"></script>

</body>
</html>



 

   





