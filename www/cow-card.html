<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>بطاقة الحيوان</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #1b8f3a;
      --yellow: #fff9cc;
      --text: #222;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic", sans-serif;
      background: var(--yellow);
      color: var(--text);
    }
    header {
      background: var(--green);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header .title {
      font-size: 20px;
      font-weight: 700;
      line-height: 1.2;
    }
    main { padding: 16px; max-width: 900px; margin: 0 auto; }
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    .row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
    .item { padding: 12px; border-radius: 12px; border: 1px dashed var(--border); background:#fff; }
    .label { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .value { font-size: 16px; font-weight: 700; color: #111; }
    .toolbar { display:flex; flex-wrap: wrap; gap:10px; margin: 16px 0 0; }
    .btn {
      appearance: none; border: 0; cursor: pointer;
      background: var(--green); color: #fff; font-weight: 700;
      padding: 10px 14px; border-radius: 999px; transition: transform .05s ease;
      text-decoration: none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn.secondary { background: #fff; color: var(--green); border: 2px solid var(--green); }
    .btn:active { transform: translateY(1px); }
    .status { margin-top: 12px; font-size: 14px; color: var(--muted); }
    .error { color: #b91c1c; font-weight: 700; }
    .ok { color: var(--green); font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .loading { opacity: .7; }
  </style>
</head>
<body>
  <header>
    <div class="title">بطاقة الحيوان</div>
  </header>

  <main>
    <div id="info" class="card loading">
      <div class="row">
        <div class="item"><div class="label">رقم الحيوان</div><div id="v-number" class="value">—</div></div>
        <div class="item"><div class="label">نوع الحيوان</div><div id="v-type" class="value">—</div></div>
        <div class="item"><div class="label">السلالة</div><div id="v-breed" class="value">—</div></div>
        <div class="item"><div class="label">الحالة الإنتاجية</div><div id="v-prod" class="value">—</div></div>
        <div class="item"><div class="label">الحالة التناسلية</div><div id="v-repro" class="value">—</div></div>
        <div class="item"><div class="label">إنتاج اللبن اليومي (كجم)</div><div id="v-milk" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ آخر ولادة</div><div id="v-lastCalving" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ آخر تلقيح</div><div id="v-lastInsem" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ الميلاد</div><div id="v-dob" class="value">—</div></div>
        </div>
      <div class="toolbar">
        <a id="btn-add-event" class="btn" href="#">+ تسجيل حدث لهذا الحيوان</a>
        <a id="btn-dashboard" class="btn secondary" href="dashboard.html">لوحة التحكم</a>
        <a id="btn-back-list" class="btn secondary" href="animal-list.html">قائمة الحيوانات</a>
      </div>
      <div id="status" class="status">جارِ التحميل…</div>
    </div>

    <div id="errorBox" class="card" style="display:none">
      <div class="error">تعذّر تحميل بيانات الحيوان.</div>
      <div class="status">تأكد من الرابط أو من الصلاحيات. إذا فتحت الصفحة من قائمة الحيوانات فالمفترض أن يعمل الرابط تلقائيًا.</div>
      <div class="toolbar"><a class="btn secondary" href="animal-list.html">الرجوع لقائمة الحيوانات</a></div>
    </div>
  </main>

  <!-- تعتمد الصفحة على ملف firebase-config.js الذي يهيئ Firebase ويصدّر auth و db -->

  <script type="module">
    // 1) استيراد Firebase v10 (مطابقة لنسخة مشروعك) + auth/db من firebase-config.js
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { auth, db } from './js/firebase-config.js';

// 2) المراجع إلى عناصر الواجهة
    const infoBox = document.getElementById('info');
    const errBox  = document.getElementById('errorBox');
    const status  = document.getElementById('status');

    const vNumber = document.getElementById('v-number');
    const vType   = document.getElementById('v-type');
    const vBreed  = document.getElementById('v-breed');
    const vProd   = document.getElementById('v-prod');
    const vRepro  = document.getElementById('v-repro');
    const vMilk   = document.getElementById('v-milk');
    const vLastC  = document.getElementById('v-lastCalving');
    const vLastI  = document.getElementById('v-lastInsem');
    const vDob    = document.getElementById('v-dob');const btnAddEvent = document.getElementById('btn-add-event');

    // 3) أدوات مساعدة
    const fmt = new Intl.DateTimeFormat('ar-EG', { dateStyle: 'medium' });
    const asDate = (x) => {
      if (!x) return '—';
      // يقبل Timestamp الخاص بـ Firestore أو نص ISO أو تاريخ JS
      try {
        if (typeof x?.toDate === 'function') return fmt.format(x.toDate());
        const d = (typeof x === 'string') ? new Date(x) : x;
        if (!isNaN(d)) return fmt.format(d);
      } catch {}
      return '—';
    };

    const getQP = (key) => new URLSearchParams(location.search).get(key);

    // 4) تحميل الوثيقة حسب docId من الاستعلام ?id=...
    let docId = getQP('id') || getQP('docId') || getQP('number');

    if (!docId) {
      infoBox.style.display = 'none';
      errBox.style.display = 'block';
      errBox.querySelector('.status').textContent = 'لا يوجد معرّف للحيوان في الرابط.';
      throw new Error('Missing ?id');
    }

    status.textContent = 'جارِ التحقق من المستخدم…';

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        status.textContent = 'لم يتم تسجيل الدخول — سيتم تحويلك إلى صفحة الدخول…';
        setTimeout(() => { location.href = 'login.html'; }, 900);
        return;
      }

      try {
        status.textContent = 'جارِ تحميل بيانات الحيوان…';
        const ref = doc(db, 'animals', docId);
        const snap = await getDoc(ref);
        if (!snap.exists()) throw new Error('document-not-found');
        const a = snap.data();

        // دعم حقول قديمة وحديثة
        const number = a.number || a.animalId || '—';
        const type   = a.type || a.animalType || '—';
        const breed  = a.breed || '—';
        const prod   = a.productionStatus || a.prodStatus || '—';
        const repro  = a.reproductiveStatus || a.reproStatus || '—';
        const milk   = (a.dailyMilkProduction ?? a.milk ?? '—');
        const lastC  = a.lastCalvingDate || a.lastCalving || null;
        const lastI  = a.lastInseminationDate || a.lastInsem || null;
        const dob    = a.birthDate || a.dob || null;

        vNumber.textContent = number;
        vType.textContent   = type;
        vBreed.textContent  = breed;
        vProd.textContent   = prod;
        vRepro.textContent  = repro;
        vMilk.textContent   = (milk === '—') ? '—' : String(milk);
        vLastC.textContent  = asDate(lastC);
        vLastI.textContent  = asDate(lastI);
        vDob.textContent    = asDate(dob);// حفظ آخر حيوان لسهولة الإبحار الذكي
        localStorage.setItem('lastAnimalDocId', docId);
        if (number && number !== '—') localStorage.setItem('lastAnimalNumber', number);

        // زر تسجيل حدث: نمرر كل ما يفيد الصفحة التالية
        const qp = new URLSearchParams({ docId, animalNumber: String(number || '') });
        btnAddEvent.href = `add-event.html?${qp.toString()}`;

        infoBox.classList.remove('loading');
        status.innerHTML = '<span class="ok">✓ تم تحميل بطاقة الحيوان بنجاح.</span>';
      } catch (err) {
        console.error(err);
        infoBox.style.display = 'none';
        errBox.style.display = 'block';
        const msg = (err?.message === 'document-not-found')
          ? 'الوثيقة غير موجودة.'
          : 'حدث خطأ أثناء تحميل البيانات.';
        errBox.querySelector('.status').textContent = msg;
      }
    });
  </script>
</body>
</html>
