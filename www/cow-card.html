<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุจุทุงูุฉ ุงูุญููุงู โ ูุนุงููุฉ</title>
  <style>
    :root{--bg:#fff9db;--card:#fff;--border:#c5e1a5;--green:#2e7d32;--text:#143b24;--muted:#f6fff2}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.4;color:#143b24;padding:18px}
    .wrap{max-width:920px;margin:0 auto}
    .openbar{display:flex;gap:8px;align-items:center;justify-content:center;margin:0 0 8px;flex-wrap:wrap}
    .openbar input{width:160px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fcfff8}
    .openbar button{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#e8f5e9;color:#1b5e20;font-weight:700;cursor:pointer}
    .openbar small{color:#2b593a}
    .kind-badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fcfff8;font-weight:700}
    .title{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;margin:0 0 10px}
    .title h1{margin:0;font-size:clamp(18px,4.6vw,28px);color:#14532d}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:700;font-size:13px;color:#0f5132}
    .chip[data-variant="ok"]{background:#e8f5e9;border-color:#c8e6c9;color:#1b5e20}
    .chip[data-variant="warn"]{background:#fff8e1;border-color:#ffe0b2;color:#7a4f00}
    .chip[data-variant="danger"]{background:#ffebee;border-color:#ffcdd2;color:#7f1d1d}
    .chip-repro::before{content:"๐ผ ";} .chip-prod::before{content:"๐ ";} .chip-health::before{content:"๐ฉบ ";}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .card h3{margin:0 0 10px;color:#17623b;font-size:18px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .fi{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fcfff8}
    .fi span{color:#2b593a;font-size:13px}
    .fi b{color:#0f5132; direction:ltr; unicode-bidi:plaintext; font-variant-numeric:tabular-nums}
    .milk-gauge-box{width:min(360px,92vw);aspect-ratio:2/1;position:relative;margin:8px auto;display:grid;place-items:center}
    .milk-gauge-box svg{position:absolute;inset:0;width:100%;height:100%;display:block}
    .milk-gauge-box svg *{vector-effect:non-scaling-stroke;shape-rendering:geometricPrecision}
    .milk-gauge-box .val{position:absolute;bottom:8%;inset-inline:0;text-align:center;font-weight:800;color:#065f46;font-size:clamp(14px,4vw,18px)}
    .legend{display:flex;gap:10px;justify-content:center;font-size:12px;color:#355}
    .leg{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .kpi3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:6px 0 10px}
    @media (max-width:560px){.kpi3{grid-template-columns:1fr}}
    .kpi{border:1px solid var(--border);background:#fcfff8;border-radius:12px;padding:10px;text-align:center}
    .kpi .lbl{font-size:12px;color:#2b593a}
    .kpi .val{font-weight:800;color:#14532d;font-size:clamp(16px,4.6vw,20px)}
    .chart-scroll{overflow-x:auto;overflow-y:hidden;border:1px dashed #c5e1a5;border-radius:12px;background:#fff}
    .prod-chart{display:block;height:240px}
    @media (max-width:560px){.prod-chart{height:200px}}
    .hint{font-size:12px;color:#456;margin-top:6px;text-align:center}
    .hl{display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;align-items:center}
    .hl.head{font-weight:700;color:#0f5132}
    .hl>div{border:1px solid var(--border);background:#fcfff8;border-radius:10px;padding:8px}
    @media (max-width:560px){.hl{grid-template-columns:100px 1fr}}
    @media (max-width:560px){.hl .note{grid-column:1 / -1}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="openbar" id="openbar">
      <small>ุงูุชุญ ุจุงูุฑูู:</small>
      <input id="openNumber" inputmode="numeric" placeholder="ูุซุงู: 3" />
      <span class="kind-badge">ุงูููุน: <span id="kindVal">โ</span></span>
      <button id="openBtn">ูุชุญ</button>
    </div>

    <div class="title" aria-label="ุนููุงู ุจุทุงูุฉ ุงูุญููุงู">
      <h1 id="cardTitle">ุจุทุงูุฉ ุงูุญููุงู ุฑูู โ</h1>
      <div class="chips" role="group" aria-label="ุญุงูุงุช ุงูุญููุงู">
        <div class="chip chip-repro"  id="chipRepro"  data-variant="ok">โ</div>
        <div class="chip chip-prod"   id="chipProd"   data-variant="ok">โ</div>
        <div class="chip chip-health" id="chipHealth" data-variant="ok">โ</div>
      </div>
    </div>

    <section class="card" aria-label="ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ">
      <h3>ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h3>
      <div class="grid" id="basicInfo">
        <div class="fi"><span>ุชุงุฑูุฎ ุงููููุงุฏ</span><b id="fiBirth">โ</b></div>
        <div class="fi"><span>ุชุงุฑูุฎ ุขุฎุฑ ููุงุฏุฉ</span><b id="fiLastCalving">โ</b></div>
        <div class="fi"><span>ุฑูู ููุณู ุงูุญููุจ</span><b id="fiLactNo">โ</b></div>
        <div class="fi"><span>ุนุฏุฏ ุฃูุงู ุงูุญููุจ DIM</span><b id="fiDIM">โ</b></div>
        <div class="fi"><span>ุนูุฑ ุงูุญูู (ููู)</span><b id="fiGestAge">โ</b></div>
        <div class="fi"><span>ุงูุณูุงูุฉ</span><b id="fiBreed">โ</b></div>
        <div class="fi"><span>ุงููุฌููุนุฉ</span><b id="fiGroup">โ</b></div>
      </div>
    </section>

    <section class="card" aria-label="ุชูููู ุณูุงุช ุงููุจู">
      <h3>ุชูููู ุณูุงุช ุงููุจู</h3>
      <div class="milk-gauge-box">
        <svg viewBox="0 0 100 50" preserveAspectRatio="xMidYMid meet">
          <path id="gBg" d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e5e7eb" stroke-width="12" stroke-linecap="round"/>
          <g id="gSlices"></g>
          <g id="needle" transform="rotate(180 50 50)">
            <line x1="50" y1="50" x2="50" y2="14" stroke="#111" stroke-width="1.8" />
            <circle cx="50" cy="50" r="2.2" fill="#111" />
          </g>
        </svg>
        <div class="val" id="milkGaugeVal" aria-live="polite">โ</div>
      </div>
      <div class="legend" aria-hidden="true">
        <span class="leg"><span class="dot"></span>ุถุนูู</span>
        <span class="leg"><span class="dot"></span>ูุชูุณุท</span>
        <span class="leg"><span class="dot"></span>ุฌูุฏ</span>
        <span class="leg"><span class="dot"></span>ููุชุงุฒ</span>
      </div>
    </section>

    <section class="card" aria-label="ุฅูุชุงุฌ ุงููุจู">
      <h3>ุฅูุชุงุฌ ุงููุจู</h3>
      <div class="kpi3">
        <div class="kpi"><div class="lbl">ุฅูุชุงุฌ ุงูููู</div><div class="val" id="kpiMilkToday">โ</div></div>
        <div class="kpi"><div class="lbl">ุฅูุชุงุฌ ุงูููุณู</div><div class="val" id="kpiSeason">โ</div></div>
        <div class="kpi"><div class="lbl">ุฅูุชุงุฌ 305 ููู</div><div class="val" id="kpi305">โ</div></div>
      </div>
      <div class="chart-scroll" id="milkScroll">
        <svg id="milkChart" class="prod-chart" viewBox="0 0 100 60" preserveAspectRatio="none" aria-label="ูุฎุทุท ุฅูุชุงุฌ ุงููุจู"></svg>
      </div>
      <div class="hint">ูุนุฑุถ ูุงูู ูุชุฑุฉ ุงูุญููุจ โ ุงุณุญุจ/ุชูุฑูุฑ ุฃููููุง ููุดุงูุฏุฉ ูู ุงูุฃูุงู (ูุฌู/ููู)</div>
    </section>

    <section class="card" aria-label="ุงูุญุงูุฉ ุงูุชูุงุณููุฉ">
      <h3>ุงูุญุงูุฉ ุงูุชูุงุณููุฉ</h3>
      <div class="grid">
        <div class="fi"><span>ุชุงุฑูุฎ ุขุฎุฑ ุชูููุญ</span><b id="fiLastIns">โ</b></div>
        <div class="fi"><span>ูุชูุณุท ุฎุฏูุงุช/ุญูู</span><b id="fiSPC">โ</b></div>
        <div class="fi"><span>ูุนุฏู ุงูุฃูุงู ุจูู ุงูุชูููุญ</span><b id="fiServiceInterval">โ</b></div>
        <div class="fi"><span>ุชุงุฑูุฎ ุขุฎุฑ ุดูุงุน</span><b id="fiLastHeat">โ</b></div>
        <div class="fi"><span>ุงูุฃูุงู ุจูู ุงูุดูุงุน</span><b id="fiHeatInterval">โ</b></div>
        <div class="fi"><span>ุจุฑูุชูููู Ovsynch</span><b id="fiOvsynch">โ</b></div>
      </div>
    </section>

    <section class="card" aria-label="ุงูุญุงูุฉ ุงูุตุญูุฉ">
      <h3>ุงูุญุงูุฉ ุงูุตุญูุฉ</h3>
      <div class="grid">
        <div class="fi"><span>ุงูุญุงูุฉ ุงูุญุงููุฉ</span><b id="fiHealth">โ</b></div>
        <div class="fi"><span>ุขุฎุฑ ูุญุต</span><b id="fiLastCheck">โ</b></div>
      </div>
      <div style="margin-top:10px">
        <div class="hl head">
          <div>ุงูุชุงุฑูุฎ</div><div>ุงูุชุดุฎูุต</div><div class="note">ููุงุญุธุฉ</div>
        </div>
        <div id="healthList"></div>
      </div>
    </section>
  </div>

<script type="module">
  /* ===== 1) Firebase init ุขูู ูู firebase-config.js ===== */
  const cfgMod = await import('/js/firebase-config.js');

  // ูุญุงูู ูู ุงูุฃุดูุงู ุงูููููุฉ ูููููููุฌ
  const firebaseConfig =
    cfgMod.config || cfgMod.default?.config || cfgMod.default || cfgMod;

  const [{ initializeApp, getApps }, {
    getFirestore, collection, doc, getDoc, getDocs, query, where, limit
  }] = await Promise.all([
    import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js'),
    import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js')
  ]);

  // ูู ุงูููู ูุฏูููุง app/db ุฌุงูุฒูู ุงุณุชุฎุฏูููุ ูุฅูุง ูุนูู app ูู config
  const preApp = cfgMod.app || cfgMod.default?.app || null;
  const app = preApp || (getApps().length ? getApps()[0] : initializeApp(firebaseConfig));
  const preDb  = cfgMod.db  || cfgMod.default?.db  || null;
  const DB = preDb || getFirestore(app);

  /* ===== 2) UID ูููุณุชุฃุฌุฑ ุงูุญุงูู ===== */
  const UID =
    localStorage.getItem('userId') ||
    localStorage.getItem('tenantId') ||
    (window.tenant && (window.tenant.userId || window.tenant.uid)) ||
    window.TENANT_USER_ID || '';

  /* ===== 3) ูุณุงุนุฏูุง ูุจูุบ ุงูุฎุทุฃ ุนูู ุงูุตูุญุฉ ุจุฏู ูุง ูุฏููุฎ ===== */
  const errBox = document.createElement('div');
  errBox.style.cssText = 'position:fixed;inset-inline:12px;bottom:12px;background:#ffebee;color:#7f1d1d;border:1px solid #ffcdd2;border-radius:10px;padding:10px;font:12px system-ui;display:none;z-index:9999';
  document.body.appendChild(errBox);
  const showErr = (msg)=>{ errBox.textContent = msg; errBox.style.display='block'; };

  /* ===== 4) ุฃุฏูุงุช ูุงุฌูุฉ ูุชููุฆุฉ ุจุณูุทุฉ ===== */
  const $=id=>document.getElementById(id);
  const put=(id,v)=>{const n=$(id); if(n) n.textContent=(v ?? 'โ');};
  const fmtD=(s)=> s? new Date(s).toLocaleDateString('ar-EG') : 'โ';
  const NF = new Intl.NumberFormat('ar-EG');
  const todayStr = new Date().toISOString().slice(0,10);
  const url = new URL(location.href);
  const openbar=$('openbar'), openInput=$('openNumber'), openBtn=$('openBtn'), kindValEl=$('kindVal');

  const normKind = (k)=>{ const s=String(k??'').trim().toLowerCase();
    if(/^(cow|ุจูุฑ|ุจูุฑุฉ)$/.test(s)) return 'cow';
    if(/^(buffalo|ุฌุงููุณ|ุฌุงููุณู|ุฌุงููุณุฉ)$/.test(s)) return 'buffalo';
    return '';
  };
  const kindNameAr  = (k)=> k==='buffalo' ? 'ุฌุงููุณุฉ' : k==='cow' ? 'ุจูุฑุฉ' : 'ุญููุงู';
  const kindTitleAr = (k)=> k==='buffalo' ? 'ุจุทุงูุฉ ุงูุฌุงููุณุฉ' : k==='cow' ? 'ุจุทุงูุฉ ุงูุจูุฑุฉ' : 'ุจุทุงูุฉ ุงูุญููุงู';
  const extractKind = (o={})=>{
    const c=[o.animaltype,o.kind,o.type,o.category,o.species,o.animalType,o.animal_kind,o.animalClass,o['ููุน'],o['ุงูููุน'],o['ุงููุตููุฉ']];
    for(const v of c){ const k=normKind(v); if(k) return k; } return '';
  };

  /* ===== 5) ุชุทุจูุน ุจูุงูุงุช ุงูุญููุงู + ุงูุฃุญุฏุงุซ ===== */
  function normalizeAnimalDoc(d={}) {
    return {
      id: d.id,
      number: d.number ?? d.animalNumber ?? d.no ?? d['ุฑูู'] ?? null,
      kind: extractKind(d),
      birthDate: d.birthDate ?? d.birth_date ?? d.dob ?? d['ุชุงุฑูุฎ ุงููููุงุฏ'] ?? null,
      lastCalvingDate: d.lastCalvingDate ?? d.lastCalving ?? d.calvingDate ?? d['ุชุงุฑูุฎ ุขุฎุฑ ููุงุฏุฉ'] ?? null,
      lactationNumber: d.lactationNumber ?? d.lactNo ?? d['ุฑูู ููุณู ุงูุญููุจ'] ?? null,
      breed: d.breed ?? d.breedName ?? d['ุงูุณูุงูุฉ'] ?? null,
      group: d.group ?? d['ุงููุฌููุนุฉ'] ?? null,
      pregnancyDate: d.pregnancyDate ?? d.pregnantFrom ?? d['ุชุงุฑูุฎ ุงูุญูู'] ?? null,
      reproductiveStatus: d.reproductiveStatus ?? d['ุงูุญุงูุฉ ุงูุชูุงุณููุฉ'] ?? null,
      productionStatus:   d.productionStatus   ?? d['ุญุงูุฉ ุงูุฅูุชุงุฌ'] ?? null,
      healthStatus:       d.healthStatus       ?? d['ุงูุญุงูุฉ ุงูุตุญูุฉ'] ?? 'ุณููู',
      lastCheckDate: d.lastCheckDate ?? d.healthCheckDate ?? d['ุขุฎุฑ ูุญุต'] ?? null,
      milkTraitsScore: Number(d.milkTraitsScore ?? d.milk_score ?? 0) || 0,
      ovsynch: d.ovsynch ?? null
    };
  }

  const TYPE_RULES = [
    ['milk',        /(daily[_\s-]?milk|milk\s*daily|milk$|ูุจู|ุงูุชุงุฌ)/i],
    ['calving',     /(calving|ููุงุฏ|ููุงุณ)/i],
    ['insemination',/(insemin|ุชูููุญ|ุฎุฏู)/i],
    ['heat',        /(heat|estrus|ุดูุงุน)/i],
    ['pregnancy',   /(pregnan|ุญูู|ุงูุฌุงุจู|ููุฌุจ)/i],
    ['disease',     /(mastitis|lameness|disease|ill|ูุฑุถ|ุงูุชูุงุจ|ุนุฑุฌ)/i],
  ];
  const evType = (e)=>{ const s=String(e.type??e.eventType??e.event??e.name??e.kind??e.category??'').toLowerCase();
    for(const [T,rx] of TYPE_RULES) if(rx.test(s)) return T; return 'other';
  };
  const evDate = (e)=>{ const d=e.eventDate??e.date??e.day??e.createdAt??e.ts??''; return d? new Date(d).toISOString().slice(0,10) : ''; };
  const toNum  = (v)=>{ const n=Number(v); return Number.isFinite(n)?n:0; };
  function evMilkKg(e){
    const direct = toNum(e.milkKg ?? e.total ?? e.kg ?? e.milk ?? e.amount);
    if (direct>0) return direct;
    let sum=0;
    const partKey = /(^(am|pm|morning|noon|evening|morn|mid|eve)$)|(^milk\d$)|(^milk_(am|pm|morning|noon|evening)$)|(^ุตุจุงุญ$|^ุธูุฑ$|^ูุณุงุก$|^ุญูุจุฉ\d$|^ุญูุจู\d$)/i;
    for(const [k,v] of Object.entries(e)) if(partKey.test(k)) sum += toNum(v);
    return sum;
  }

  /* ===== 6) ุฌูุจ ุงูุญููุงูุงุช ููุณุชุฎุฏู UID ุฃููุงู (ุจุฏูู ูุคุดุฑุงุช ูุฑููุจุฉ) ===== */
  async function fetchAnimalByNumber(n){
    if(!n) return null;
    const A=collection(DB,'animals');
    const nStr=String(n).trim(); const nNum=Number(nStr);

    // (ุฃ) ุงุฌูุจ ุญููุงูุงุช ุงููุณุชุฎุฏู (index ุจุณูุท ุนูู userId)ุ ุซู ุทุงุจู ูุญูููุง
    if (UID){
      const s = await getDocs(query(A, where('userId','==', UID), limit(200)));
      let hit=null;
      s.forEach(d=>{
        const v={id:d.id, ...d.data()};
        if (
          String(v.number)===nStr || String(v.animalNumber)===nStr ||
          Number(v.number)===nNum  || Number(v.animalNumber)===nNum
        ) hit=v;
      });
      if (hit) return normalizeAnimalDoc(hit);
    }

    // (ุจ) ุงุญุชูุงุทู: ุงุณุชุนูุงูุงุช ุจุณูุทุฉ ุจุงูุฑูู ููุท ุซู ููุชุฑุฉ UID ุฅู ููุฌุฏ
    const qs = [
      query(A, where('number','==', nStr), limit(5)),
      Number.isFinite(nNum)? query(A, where('number','==', nNum), limit(5)) : null,
      query(A, where('animalNumber','==', nStr), limit(5)),
      Number.isFinite(nNum)? query(A, where('animalNumber','==', nNum), limit(5)) : null,
    ].filter(Boolean);
    for (const qy of qs){
      const s = await getDocs(qy);
      if (!s.empty){
        let chosen = s.docs[0];
        if (UID){
          s.forEach(d=>{
            const v=d.data();
            if (v.userId===UID || v.ownerUid===UID) chosen=d;
          });
        }
        const data = chosen.data();
        if (UID && data && (data.userId!==UID) && (data.ownerUid!==UID)) continue;
        return normalizeAnimalDoc({id:chosen.id, ...data});
      }
    }
    return null;
  }

  async function fetchAnimal({number, animalId}){
    const { idParam } = {};
    if (animalId){
      const dd=await getDoc(doc(DB,'animals', animalId));
      if (dd.exists()){
        const ad = {id:dd.id, ...dd.data()};
        if (!UID || ad.userId===UID || ad.ownerUid===UID) return normalizeAnimalDoc(ad);
        throw new Error('ุบูุฑ ูุณููุญ');
      }
    }
    const a=await fetchAnimalByNumber(number);
    if (a) return a;
    throw new Error('ูุง ููุฌุฏ ุญููุงู ูุทุงุจู');
  }

  async function fetchEvents(animal){
    const E=collection(DB,'events'); const rows=[];
    if (animal.id){
      const s = await getDocs(query(E, where('animalId','==', animal.id)));
      s.forEach(d=>rows.push({id:d.id, ...d.data()}));
    }
    if (animal.number!=null){
      const nStr=String(animal.number), nNum=Number(nStr);
      const ql=[
        query(E, where('animalNumber','==', nStr)),
        Number.isFinite(nNum)? query(E, where('animalNumber','==', nNum)) : null,
        query(E, where('number','==', nStr)),
        Number.isFinite(nNum)? query(E, where('number','==', nNum)) : null,
      ].filter(Boolean);
      for(const qy of ql){
        const s=await getDocs(qy);
        s.forEach(d=>rows.push({id:d.id, ...d.data()}));
      }
    }
    const filtered = UID ? rows.filter(r => !r.userId || r.userId===UID || r.ownerUid===UID) : rows;
    const uniq=new Map(filtered.map(r=>[r.id,r]));
    return [...uniq.values()].sort((a,b)=> (evDate(a)).localeCompare(evDate(b)));
  }

  /* ===== 7) ุจูุงุก ุงูุญุงูุฉ + ุงูุฑุณู ===== */
  function buildState(animal, events){
    const st={
      number: animal.number ?? animal.id?.slice(-6),
      reproductiveStatus: animal.reproductiveStatus || 'โ',
      productionStatus:   animal.productionStatus || 'โ',
      healthStatus:       animal.healthStatus || 'ุณููู',
      birthDate: animal.birthDate || null,
      lastCalvingDate: animal.lastCalvingDate || null,
      lactationNumber: animal.lactationNumber ?? null,
      daysInMilk: null,
      gestationDays: null,
      lastInseminationDate: null,
      pregnancyDate: animal.pregnancyDate || null,
      breed: animal.breed || 'โ',
      group: animal.group || 'โ',
      milkTraitsScore: animal.milkTraitsScore ?? 0,
      servicesCount: 0, inseminations: [], estrusDates: [], ovsynch: animal.ovsynch || null,
      milkTodayKg: null, seasonTotalKg: null, m305Kg: null, milkSeries: [],
      lastCheckDate: animal.lastCheckDate || null, healthHistory: []
    };

    const milkTmp=[]; let season=0;
    for(const e of events){
      const t=evType(e), d=evDate(e);
      if(t==='calving' && d) st.lastCalvingDate = d;
      if(t==='insemination' && d){ st.inseminations.push(d); }
      if(t==='heat' && d){ st.estrusDates.push(d); }
      if(t==='pregnancy'){ st.pregnancyDate = st.pregnancyDate || d || e.pregnancyDate || null; st.reproductiveStatus='ุญุงูู'; }
      if(t==='disease'){
        st.healthHistory.push({date:d||'', diagnosis:e.diagnosis||e.note||e.eventType||'โ', note:e.note||''});
        st.healthStatus='ุญุงูุงุช ุตุญูุฉ ูุณุฌูุฉ'; st.lastCheckDate = st.lastCheckDate || d || null;
      }
      if(t==='milk'){
        const kg=evMilkKg(e);
        if(kg>0){ season+=kg; milkTmp.push({d,kg}); if(d===todayStr) st.milkTodayKg=kg; }
      }
    }

    if(st.lastCalvingDate){
      const ms=Date.now()-new Date(st.lastCalvingDate).getTime();
      st.daysInMilk=Math.max(0,Math.floor(ms/86400000));
    }
    st.inseminations.sort(); st.servicesCount=st.inseminations.length;
    st.lastInseminationDate = st.inseminations.at(-1) || null;
    st.estrusDates.sort();

    st.seasonTotalKg = season || null;
    if(st.daysInMilk>0 && season>0){ st.m305Kg = Math.round((season/st.daysInMilk)*305); }

    if(milkTmp.length){
      const base = st.lastCalvingDate ? new Date(st.lastCalvingDate).getTime() : null;
      st.milkSeries = milkTmp.filter(p=>p.d).map(p=>{
        const di = base ? Math.max(0,Math.floor((new Date(p.d).getTime()-base)/86400000)) : 0;
        return {d:di, v:p.kg};
      }).sort((a,b)=>a.d-b.d);
    }

    if(st.daysInMilk!=null){
      st.productionStatus = st.daysInMilk<60 ? 'ุญููุจ ูุจูุฑ' : st.daysInMilk<200 ? 'ุญููุจ ูุชูุณุท' : 'ุญููุจ ูุชุฃุฎุฑ';
    }
    return st;
  }

  function renderGauge(score){
    score=Math.max(0,Math.min(100,Number(score)||0));
    const g=document.getElementById('gSlices'); if(!g) return; g.innerHTML='';
    const colors=['#ef5350','#ffb74d','#fff176','#66bb6a'], steps=[0,25,50,75,100];
    const arc=(cx,cy,r,a0,a1)=>{const A=(x)=>x*Math.PI/180, p=(ang)=>[cx+r*Math.cos(A(ang)), cy+r*Math.sin(A(ang))];
      const [x0,y0]=p(a0),[x1,y1]=p(a1); return `M ${x0.toFixed(3)} ${y0.toFixed(3)} A ${r} ${r} 0 0 1 ${x1.toFixed(3)} ${y1.toFixed(3)}`;};
    for(let i=0;i<4;i++){const s=steps[i],e=steps[i+1],a0=180-(s/100)*180,a1=180-(e/100)*180;
      const p=document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('d',arc(50,50,40,a0,a1)); p.setAttribute('fill','none');
      p.setAttribute('stroke',colors[i]); p.setAttribute('stroke-width','12'); p.setAttribute('stroke-linecap','round'); g.appendChild(p);
    }
    const ang=180-(score/100)*180; const needle=document.getElementById('needle'); if(needle) needle.setAttribute('transform',`rotate(${ang} 50 50)`);
    const label=score>=75?'ููุชุงุฒ':score>=50?'ุฌูุฏ':score>=25?'ูุชูุณุท':'ุถุนูู';
    put('milkGaugeVal',`${label} โ ${score}%`);
  }

  function renderMilkChart(series){
    const svg=$('milkChart'), sc=$('milkScroll'); if(!svg||!sc||!Array.isArray(series)||!series.length){svg.innerHTML='';return;}
    const base=Math.max(sc.clientWidth,320), pxPer=Math.max(6,Math.min(11,Math.round(base/28))), pad=10;
    const data=series.map((p,i)=>({x:i,y:Number(p.v)||0})), N=data.length, W=pad*2+(N-1)*pxPer+20;
    svg.setAttribute('viewBox',`0 0 ${W} 60`); svg.style.width=W+'px';
    const maxY=Math.max(...data.map(d=>d.y),1), minY=Math.min(...data.map(d=>d.y),0), yR=Math.max(1,maxY-minY);
    const sx=(i)=>pad+(i*pxPer), sy=(v)=>60-6-((v-minY)*(60-12)/yR);
    svg.innerHTML='';
    const grid=document.createElementNS('http://www.w3.org/2000/svg','g');
    for(let i=1;i<=3;i++){const y=6+i*(60-12)/3; const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
      ln.setAttribute('x1',6); ln.setAttribute('x2',W-6); ln.setAttribute('y1',y); ln.setAttribute('y2',y);
      ln.setAttribute('stroke','#e9f5dc'); ln.setAttribute('stroke-width','0.6'); grid.appendChild(ln);}
    svg.appendChild(grid);
    let d=''; data.forEach((p,i)=>{d+=(i?' L ':'M ')+sx(i).toFixed(2)+' '+sy(p.y).toFixed(2);});
    const area=d+` L ${sx(N-1).toFixed(2)} ${60-6} L ${sx(0).toFixed(2)} ${60-6} Z`;
    const ap=document.createElementNS('http://www.w3.org/2000/svg','path'); ap.setAttribute('d',area); ap.setAttribute('fill','#cdeccd'); ap.setAttribute('opacity','0.6'); svg.appendChild(ap);
    const lp=document.createElementNS('http://www.w3.org/2000/svg','path'); lp.setAttribute('d',d); lp.setAttribute('fill','none'); lp.setAttribute('stroke','#2e7d32'); lp.setAttribute('stroke-width','1.2'); svg.appendChild(lp);
    const cx=sx(N-1), cy=sy(data[N-1].y); const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
    dot.setAttribute('cx',cx); dot.setAttribute('cy',cy); dot.setAttribute('r',2); dot.setAttribute('fill','#1b5e20'); svg.appendChild(dot);
    setTimeout(()=>{sc.scrollLeft=svg.scrollWidth;},0); addEventListener('resize',()=>renderMilkChart(series),{once:true});
  }

  function avgDaysBetween(dts){ if(!dts||dts.length<2) return null;
    const ms=dts.map(d=>new Date(d).getTime()).sort((a,b)=>a-b);
    const dif=[]; for(let i=1;i<ms.length;i++) dif.push((ms[i]-ms[i-1])/86400000);
    return Math.round(dif.reduce((a,b)=>a+b,0)/dif.length);
  }
  function setChip(el,text){ if(!el) return; const t=String(text||'').toLowerCase(); let v='ok';
    if(/ููุชูุญ|ุฎุทุฑ ููุฎูุถ|ูุชูุณุท/.test(t)) v='warn'; if(/ุญุงุฏ|ุดุฏูุฏ|ูุฑุถ|ููุงุณ ูุชุนุซุฑ/.test(t)) v='danger';
    el.textContent=text||'โ'; el.setAttribute('data-variant',v);
  }
  function renderCard(state, kind){
    $('cardTitle').textContent = `${kindTitleAr(kind)} ุฑูู ${state.number ?? 'โ'}`;
    setChip($('chipRepro'),state.reproductiveStatus); setChip($('chipProd'),state.productionStatus); setChip($('chipHealth'),state.healthStatus);
    put('fiBirth',fmtD(state.birthDate)); put('fiLastCalving',fmtD(state.lastCalvingDate));
    put('fiLactNo',state.lactationNumber!=null?NF.format(state.lactationNumber):'โ');
    put('fiDIM',state.daysInMilk!=null?NF.format(state.daysInMilk):'โ');
    let g=state.gestationDays, ref=state.pregnancyDate||state.lastInseminationDate;
    if(g==null&&ref){const ms=Date.now()-new Date(ref).getTime(); g=Math.max(0,Math.floor(ms/86400000));}
    put('fiGestAge',g!=null?NF.format(g):'โ'); put('fiBreed',state.breed||'โ'); put('fiGroup',state.group||'โ');
    renderGauge(state.milkTraitsScore);
    put('kpiMilkToday',state.milkTodayKg!=null?`${Number(state.milkTodayKg).toFixed(1)} ูุฌู`:'โ');
    put('kpiSeason',state.seasonTotalKg!=null?`${NF.format(Math.round(state.seasonTotalKg))} ูุฌู`:'โ');
    put('kpi305',state.m305Kg!=null?`${NF.format(Math.round(state.m305Kg))} ูุฌู`:'โ');
    renderMilkChart(state.milkSeries);
    put('fiLastIns',fmtD(state.lastInseminationDate));
    const spc=state.servicesCount; put('fiSPC',spc!=null?NF.format(spc):'โ');
    const svcI=avgDaysBetween(state.inseminations); put('fiServiceInterval',svcI!=null?`${NF.format(svcI)} ููู`:'โ');
    const lastHeat=(state.estrusDates&&state.estrusDates.length)?state.estrusDates.at(-1):null; put('fiLastHeat',fmtD(lastHeat));
    const hI=avgDaysBetween(state.estrusDates); put('fiHeatInterval',hI!=null?`${NF.format(hI)} ููู`:'โ');
    if(state.ovsynch&&state.ovsynch.active){ put('fiOvsynch',`${state.ovsynch.name||'Ovsynch'} โ ุจุฏุฃ ${fmtD(state.ovsynch.started)}`); } else put('fiOvsynch','โ');
    put('fiHealth',state.healthStatus||'โ'); put('fiLastCheck',fmtD(state.lastCheckDate));
    const hl=$('healthList'); hl.innerHTML='';
    if(Array.isArray(state.healthHistory)&&state.healthHistory.length){
      state.healthHistory.slice(-6).forEach(it=>{
        const row=document.createElement('div'); row.className='hl';
        const d=document.createElement('div'); d.textContent=fmtD(it.date);
        const dx=document.createElement('div'); dx.textContent=it.diagnosis||'โ';
        const nt=document.createElement('div'); nt.className='note'; nt.textContent=it.note||'';
        row.appendChild(d); row.appendChild(dx); row.appendChild(nt); hl.appendChild(row);
      });
    } else {
      const row=document.createElement('div'); row.className='hl';
      ['โ','ูุง ุชูุฌุฏ ุณุฌูุงุช',''].forEach((t,i)=>{const c=document.createElement('div'); if(i===2)c.className='note'; c.textContent=t; row.appendChild(c);});
      hl.appendChild(row);
    }
  }

  /* ===== 8) ุชุญููู ูุชุดุบูู ===== */
  async function loadAndRender({number, animalId, type}){
    try{
      let kind = normKind(type);
      const animal = await fetchAnimal({number, animalId});
      if(!kind) kind = animal.kind || normKind(localStorage.getItem('lastKind'));
      if(kind){ localStorage.setItem('lastKind',kind); if(kindValEl) kindValEl.textContent = kindNameAr(kind); }

      localStorage.setItem('currentAnimalId', String(animal.id || ''));
      if (animal.number!=null){
        localStorage.setItem('currentAnimalNumber', String(animal.number));
        localStorage.setItem('lastAnimalNumber', String(animal.number));
      }

      const events = await fetchEvents(animal);
      const state  = buildState(animal, events);
      renderCard(state, kind);
    }catch(e){
      showErr(e?.message || String(e));
      $('cardTitle').textContent='ุชุนุฐูุฑ ุชุญููู ุจุทุงูุฉ ุงูุญููุงู';
    }
  }

  const numberParam = url.searchParams.get('number') || url.searchParams.get('animalNumber') || '';
  const idParam     = url.searchParams.get('animalId') || '';
  const typeParam   = (url.searchParams.get('type') || url.searchParams.get('kind') || url.searchParams.get('animaltype') || '').toLowerCase();

  if (numberParam || idParam){
    if (openbar) openbar.style.display='none';
    if (typeParam && kindValEl) kindValEl.textContent = kindNameAr(normKind(typeParam));
    loadAndRender({number:numberParam, animalId:idParam, type:typeParam});
  } else {
    const lastNum = localStorage.getItem('currentAnimalNumber') || localStorage.getItem('lastAnimalNumber') || '';
    if(lastNum && openInput){ openInput.value=lastNum; (async()=>{ try{const a=await fetchAnimalByNumber(lastNum); if(kindValEl) kindValEl.textContent=kindNameAr(a? a.kind : '');}catch{}})(); }
    if(openBtn){
      openBtn.addEventListener('click', ()=>{
        const n=(openInput.value||'').trim(); if(!n) return;
        loadAndRender({number:n}).catch(()=>{ $('cardTitle').textContent='ูุง ููุฌุฏ ุญููุงู ุจูุฐุง ุงูุฑูู'; });
      });
    }
  }
</script>

</body>
</html>

