<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Murabbik – بطاقة الحيوان</title>
  <style>
/* ألوان نقاط الليجند للجوج */
.legend .leg:nth-child(1) .dot{background:#ef5350}
.legend .leg:nth-child(2) .dot{background:#ffb74d}
.legend .leg:nth-child(3) .dot{background:#fff176}
.legend .leg:nth-child(4) .dot{background:#66bb6a}

/* === جدول الأحداث: صفّ واحد ظاهر + تمرير للباقي === */
.ev-scroll{ height:auto !important; max-height:none !important; }     /* لا نخنق التمرير هنا */
.ev-scroll.single-row{
  overflow:auto !important;                      /* تمرير واضح */
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
}
/* أول صف مفتوح بالكامل حتى على الموبايل */
.ev-scroll.single-row .ev-row--open .ev-note{
  -webkit-line-clamp:unset !important;
  white-space:normal !important;
}
.ev-scroll.single-row .ev-more{ display:none !important; }

/* جدول الأحداث */
.ev-table{ width:100%; border-collapse:separate; border-spacing:0; }
.ev-table thead th{
  position:sticky; top:0; z-index:1;
  background:#f8fff5; text-align:right;
  border-bottom:1px solid var(--border);
}
.ev-table th,.ev-table td{
  padding:10px; border-bottom:1px solid var(--border);
  font:13px/1.5 system-ui; vertical-align:top;
}
.ev-table tr:hover td{ background:#f7fff2; }
.ev-date{ white-space:nowrap; color:#0f5132; font-weight:800; }
.ev-type{ color:#14532d; font-weight:800; }
.ev-note{ color:#355; }
.ev-more{ display:none; }  /* ديسكتوب */

/* موبايل */
@media (max-width:560px){
  .ev-scroll.single-row{ max-height:none !important; }
  .ev-table{ table-layout: fixed; }
  .ev-table th,.ev-table td{ padding:8px; font-size:12px; line-height:1.35; }
  .ev-date,.ev-type{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .ev-note{
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }
  tr.ev-row--open .ev-note{
    -webkit-line-clamp:unset;
    white-space:normal;
  }
  .ev-more{
    display:inline-block;
    margin-top:6px;
    font:12px/1 system-ui;
    color:#1b5e20;
    border:0; background:transparent; padding:0; cursor:pointer;
  }
  tr.ev-row--open .ev-more{ display:none; }
}

:root{--bg:#fffdf5;--card:#ffffff;--border:#d9efd0;--ink:#134e35;--muted:#f7fff2;--acc:#2e7d32}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.45;color:var(--ink);padding:18px}
.wrap{max-width:980px;margin:0 auto}
.openbar{display:flex;gap:8px;align-items:center;justify-content:center;margin:0 0 12px;flex-wrap:wrap}
.openbar small{opacity:.8}
.openbar input{width:160px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fcfff8}
.openbar button{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#e8f5e9;color:#1b5e20;font-weight:700;cursor:pointer}
.kind-badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fcfff8;font-weight:700}
.title{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;margin:0 0 12px}
.title h1{margin:0;font-size:clamp(18px,4.6vw,28px);color:#14532d}
.chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.chip{background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:700;font-size:13px;color:#0f5132}
.chip[data-variant="ok"]{background:#e8f5e9;border-color:#c8e6c9;color:#1b5e20}
.chip[data-variant="warn"]{background:#fff8e1;border-color:#ffe0b2;color:#7a4f00}
.chip[data-variant="danger"]{background:#ffebee;border-color:#ffcdd2;color:#7f1d1d}
.chip-repro::before{content:"🍼 ";} .chip-prod::before{content:"📈 ";} .chip-health::before{content:"🩺 ";}

.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.card h3{margin:0 0 10px;color:#17623b;font-size:18px}

.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media (max-width:560px){.grid{grid-template-columns:1fr}}
.fi{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fcfff8}
.fi span{color:#2b593a;font-size:13px}
.fi b{color:#0f5132;direction:ltr;unicode-bidi:plaintext;font-variant-numeric:tabular-nums;word-break:break-word}

.milk-gauge-box{width:min(360px,92vw);aspect-ratio:2/1;position:relative;margin:8px auto;display:grid;place-items:center}
.milk-gauge-box svg{position:absolute;inset:0;width:100%;height:100%;display:block}
.milk-gauge-box svg *{vector-effect:non-scaling-stroke;shape-rendering:geometricPrecision}
.milk-gauge-box .val{position:absolute;bottom:8%;inset-inline:0;text-align:center;font-weight:800;color:#065f46;font-size:clamp(14px,4vw,18px)}
.legend{display:flex;gap:10px;justify-content:center;font-size:12px;color:#355}
.leg{display:inline-flex;align-items:center;gap:6px}
.dot{width:10px;height:10px;border-radius:50%}

.kpi3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:6px 0 10px}
@media (max-width:560px){.kpi3{grid-template-columns:1fr}}
.kpi{border:1px solid var(--border);background:#fcfff8;border-radius:12px;padding:10px;text-align:center}
.kpi .lbl{font-size:12px;color:#2b593a}
.kpi .val{font-weight:800;color:#14532d;font-size:clamp(16px,4.6vw,20px)}

.chart-scroll{overflow-x:auto;overflow-y:hidden;border:1px dashed #c5e1a5;border-radius:12px;background:#fff}
.prod-chart{display:block;height:240px}
@media (max-width:560px){.prod-chart{height:200px}}
.hint{font-size:12px;color:#456;margin-top:6px;text-align:center}

.hl{display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;align-items:center}
.hl.head{font-weight:700;color:#0f5132}
.hl>div{border:1px solid var(--border);background:#fcfff8;border-radius:12px;padding:8px}
@media (max-width:560px){.hl{grid-template-columns:100px 1fr}}
@media (max-width:560px){.hl .note{grid-column:1 / -1}}

.notice{margin:10px 0;padding:10px;border:1px dashed var(--border);background:#fcfff8;border-radius:12px;color:#14532d;font:13px system-ui}

/* === Timeline (أحداث الحيوان) === */
.timeline-card{position:relative}
.tl-wrap{overflow-x:auto; overflow-y:hidden; border:1px solid var(--border); border-radius:12px; background:#fff;}
.tl-svg{display:block; height:120px;}
.tl-legend{display:none}
.tl-legend .leg{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#fcfff8}
.tl-dot{cursor:pointer}
.tl-tooltip{
  position:absolute;
  transform:translate(-50%,-8px);
  background:#0b3d2a; color:#fff; border-radius:8px; padding:8px 10px; font:12px/1.4 system-ui;
  box-shadow:0 6px 18px rgba(0,0,0,.18); pointer-events:none; z-index:50; display:none; max-width:min(80vw,320px)
}
.tl-tooltip b{display:block; font-weight:800; margin-bottom:4px}
.tl-date{opacity:.9; font-variant-numeric:tabular-nums}

/* ألوان النقاط حسب نوع الحدث */
:root{
  --tl-milk:#2e7d32; --tl-calving:#1b5e20; --tl-insem:#0d9488; --tl-preg:#a16207;
  --tl-heat:#ef6c00; --tl-dry:#6b7280; --tl-disease:#c62828; --tl-other:#4b5563;
}
/* إبراز صف الحدث عند القفز من التايملاين (لن نستخدم القفز الآن) */
.ev-row--focus{
  outline:2px solid #2e7d32;
  background:#f1faee !important;
  transition: background .4s ease;
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="openbar" id="openbar">
      <small>افتح بالرقم:</small>
      <input id="openNumber" inputmode="numeric" placeholder="مثال: 108" />
      <span class="kind-badge">النوع: <span id="kindVal">—</span></span>
      <button id="openBtn">فتح</button>
    </div>

    <div class="title" aria-label="عنوان بطاقة الحيوان">
      <h1 id="cardTitle">بطاقة الحيوان رقم —</h1>
      <div class="chips" role="group" aria-label="حالات الحيوان">
        <div class="chip chip-repro"  id="chipRepro"  data-variant="ok">—</div>
        <div class="chip chip-prod"   id="chipProd"   data-variant="ok">—</div>
        <div class="chip chip-health" id="chipHealth" data-variant="ok">—</div>
      </div>
    </div>

    <section class="card" aria-label="المعلومات الأساسية">
      <h3>المعلومات الأساسية</h3>
      <div class="grid" id="basicInfo">
        <div class="fi"><span>تاريخ الميلاد</span><b id="fiBirth">—</b></div>
        <div class="fi"><span>تاريخ آخر ولادة</span><b id="fiLastCalving">—</b></div>
        <div class="fi"><span>رقم موسم الحليب</span><b id="fiLactNo">—</b></div>
        <div class="fi"><span>عدد أيام الحليب DIM</span><b id="fiDIM">—</b></div>
        <div class="fi"><span>عمر الحمل (يوم)</span><b id="fiGestAge">—</b></div>
        <div class="fi"><span>السلالة</span><b id="fiBreed">—</b></div>
        <div class="fi"><span>المجموعة</span><b id="fiGroup">—</b></div>
      </div>
    </section>

    <section class="card timeline-card" aria-label="الخط الزمني للأحداث">
      <h3>الخط الزمني</h3>
      <div class="tl-wrap" id="timelineBox"></div>
      <div class="tl-tooltip" id="tlTip" role="status" aria-live="polite"></div>
      <div class="hint">اسحب أفقياً للتنقل — اضغط/المس النقاط لعرض تفاصيل الحدث.</div>
    </section>

    <section class="card" aria-label="تقييم سمات اللبن">
      <h3>تقييم سمات اللبن</h3>
      <div class="milk-gauge-box">
        <svg viewBox="0 0 100 50" preserveAspectRatio="xMidYMid meet">
          <path id="gBg" d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e5e7eb" stroke-width="12" stroke-linecap="round"/>
          <g id="gSlices"></g>
          <g id="needle" transform="rotate(180 50 50)">
            <line x1="50" y1="50" x2="50" y2="14" stroke="#111" stroke-width="1.8" />
            <circle cx="50" cy="50" r="2.2" fill="#111" />
          </g>
        </svg>
        <div class="val" id="milkGaugeVal" aria-live="polite">—</div>
      </div>
      <div class="legend" aria-hidden="true">
        <span class="leg"><span class="dot"></span>ضعيف</span>
        <span class="leg"><span class="dot"></span>متوسط</span>
        <span class="leg"><span class="dot"></span>جيد</span>
        <span class="leg"><span class="dot"></span>ممتاز</span>
      </div>
    </section>

    <section class="card" aria-label="إنتاج اللبن">
      <h3>إنتاج اللبن</h3>
      <div class="kpi3">
        <div class="kpi"><div class="lbl">إنتاج اليوم</div><div class="val" id="kpiMilkToday">—</div></div>
        <div class="kpi"><div class="lbl">إنتاج الموسم</div><div class="val" id="kpiSeason">—</div></div>
        <div class="kpi"><div class="lbl">إنتاج 305 يوم</div><div class="val" id="kpi305">—</div></div>
      </div>
      <div class="chart-scroll" id="milkScroll">
        <svg id="milkChart" class="prod-chart" viewBox="0 0 100 60" preserveAspectRatio="none" aria-label="مخطط إنتاج اللبن"></svg>
      </div>
      <div class="hint">يعرض كامل فترة الحليب — اسحب/تمرير أفقيًا لمشاهدة كل الأيام (كجم/يوم)</div>
    </section>

    <section class="card" aria-label="الحالة التناسلية">
      <h3>الحالة التناسلية</h3>
      <div class="grid">
        <div class="fi"><span>تاريخ آخر تلقيح</span><b id="fiLastIns">—</b></div>
        <div class="fi"><span>معدل الأيام بين التلقيح</span><b id="fiServiceInterval">—</b></div>
        <div class="fi"><span>تاريخ آخر شياع</span><b id="fiLastHeat">—</b></div>
        <div class="fi"><span>الأيام بين الشياع</span><b id="fiHeatInterval">—</b></div>
        <div class="fi"><span>بروتوكول Ovsynch</span><b id="fiOvsynch">—</b></div>
        <div class="fi"><span>عدد مرات التلقيح</span><b id="fiServicesCount">—</b></div>
      </div>
    </section>

    <section class="card" aria-label="الحالة الصحية">
      <h3>الحالة الصحية</h3>
      <div class="grid">
        <div class="fi"><span>الحالة الحالية</span><b id="fiHealth">—</b></div>
        <div class="fi"><span>آخر فحص</span><b id="fiLastCheck">—</b></div>
      </div>
      <div style="margin-top:10px">
        <div id="healthList"></div>
      </div>
    </section>

    <!-- جميع الأحداث المسجّلة -->
    <section class="card" aria-label="الأحداث المسجّلة">
      <h3>الأحداث المسجّلة</h3>
      <div id="evList"></div>
    </section>
  </div>

  <script type="module">
/* ======================= Firebase ======================= */
const fb = await import('/js/firebase-config.js');
if (fb.ensureAuth) await fb.ensureAuth();
const fs = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
const DB = fb.db || fs.getFirestore();
const { collection, doc, getDoc, getDocs, query, where, limit } = fs;
const userNow = fb?.auth?.currentUser || null;
const UID = userNow?.uid ?? null;

// ثوابت أسماء الحقول
const ANIM_OWNER_FIELD = 'ownerUid'; // في animals
const EVENT_USER_FIELD = 'userId';   // في events

// مساعد لاستخراج تاريخ الحدث
const evDate = (e={}) =>
  e.eventDate ||
  e.date ||
  e.day ||
  (e.createdAt?.toDate?.()?.toISOString?.().slice(0,10)) ||
  (e.createdAt instanceof Date ? e.createdAt.toISOString().slice(0,10) : null);

/* ======================= Helpers ======================= */
const $=(id)=>document.getElementById(id);
const put=(id,v)=>{const n=$(id); if(n) n.textContent=(v ?? '—');};
const fmtD=(s)=> s? new Date(s).toLocaleDateString('ar-EG') : '—';
const NF = new Intl.NumberFormat('ar-EG');
const todayStr = new Date().toISOString().slice(0,10);
const url = new URL(location.href);
const openbar=$('openbar'), openInput=$('openNumber'), openBtn=$('openBtn'), kindValEl=$('kindVal');

const toPercent = (v)=>{
  if (v == null) return 0;
  let n = (typeof v === 'string')
    ? parseFloat(v.replace(/[^\d.-]+/g,''))
    : Number(v);
  if (!Number.isFinite(n)) return 0;
  if (typeof v === 'string' && v.includes('%')) {/* as-is */}
  else if (n >= 0 && n <= 1) n *= 100;
  return Math.max(0, Math.min(100, Math.round(n)));
};

/* ======================= أسماء الأحداث = أسماء الصفحات بالعربي ======================= */
function _pick(e, keys){
  for (const k of keys){
    const v = e?.[k];
    if (v != null && String(v).trim() !== '') return String(v).trim();
  }
  return null;
}
function eventLabel(e = {}) {
  // 1) حقول عربية صريحة / عنوان صفحة بالعربي
  const ar = _pick(e, [
    'اسم_الحدث','العنوان','عنوان_الصفحة','pageTitleAr','page_name_ar','page_ar',
    'eventNameAr','nameAr','titleAr','labelAr','تشخيص'
  ]);
  if (ar) return ar;

  // 2) أسماء صفحات إنجليزية نعرّبها (أسماء صفحات فقط)
  const page = (_pick(e, ['page','pageName','page_title','screen']) || '').toLowerCase();
  const type = (_pick(e, ['type','eventType']) || '').toLowerCase();
  const MAP = {
    'milking_traits':'تقييم سمات اللبن',
    'insemination':'تلقيح',
    'pregnancy':'تشخيص حمل',
    'pregnancy_diagnosis':'تشخيص حمل',
    'calving':'ولادة',
    'dry_off':'تجفيف',
    'heat':'شياع',
    'lameness':'عرج',
    'mastitis':'التهاب الضرع',
    'closeup':'قرب الولادة'
  };
  const key = (page || type).replace(/\s+/g,'_');
  if (MAP[key]) return MAP[key];

  // 3) لو الاسم موجود عامًّا
  const name = _pick(e, ['name','title','eventName','label']);
  if (name){
    const s = name.trim().toLowerCase();
    if (s === 'cow' || s === 'buffalo') return 'حدث';
    if (MAP[s]) return MAP[s];
    return name; // إن كان عربي نتركه
  }

  // 4) ترجمة نوع الحدث fallback
  const TYPE_AR = {
    milk:'إنتاج اللبن', calving:'ولادة', insemination:'تلقيح',
    pregnancy:'تشخيص حمل', heat:'شياع', dry:'تجفيف',
    disease:'حالة صحية', other:'حدث'
  };
  return TYPE_AR[evType(e)] || 'حدث';
}

const normKind=(k)=>{const s=String(k??'').trim().toLowerCase();
  if(/^(cow|بقر|بقرة)$/.test(s)) return 'cow';
  if(/^(buffalo|جاموس|جاموسه|جاموسة)$/.test(s)) return 'buffalo';
  return '';
};
const kindNameAr=(k)=> k==='buffalo' ? 'جاموسة' : k==='cow' ? 'بقرة' : 'حيوان';
const kindTitleAr=(k)=> k==='buffalo' ? 'بطاقة الجاموسة' : k==='cow' ? 'بطاقة البقرة' : 'بطاقة الحيوان';

function isDryKeyword(s=''){s=String(s).toLowerCase().trim();return /(dry\s*-?\s*off|^dry$|جاف(ة)?|تجفيف)/i.test(s);}
function normProdStatus(v){if(v==null) return null; return isDryKeyword(v)?'جاف':String(v).trim();}

function isPregKeyword(s=''){s=String(s).toLowerCase().trim();return /(pregnan|حامل|عِ?شار|عشار|ايجابي|موجب)/i.test(s);}
function normReproStatus(v){if(v==null) return null; return isPregKeyword(v)?'عِشار':String(v).trim();}

// يحوّل أي Timestamp/Maps إلى JSON بسيط
function plainify(obj){
  if (!obj || typeof obj !== 'object') return obj;
  if (typeof obj.toDate === 'function') { try { return obj.toDate().toISOString(); } catch { return obj.toString?.() ?? obj; } }
  if (Array.isArray(obj)) return obj.map(plainify);
  const out = {}; for (const [k,v] of Object.entries(obj)) out[k]=plainify(v); return out;
}

function normalizeAnimalDoc(d = {}){
  const x = plainify(d);
  const normalized = {
    id: x.id,
    number: x.number ?? x.animalNumber ?? x.no ?? x['رقم'] ?? null,
    kind: normKind(x.animalType ?? x.kind ?? x.type ?? x['النوع'] ?? x['الفصيلة'] ?? x.animalTypeAr),
    birthDate: x.birthDate ?? x.birth_date ?? x.dob ?? x['تاريخ الميلاد'] ?? null,
    lastCalvingDate: x.lastCalvingDate ?? x.lastCalving ?? x.calvingDate ?? x['تاريخ آخر ولادة'] ?? null,
    lactationNumber: x.lactationNumber ?? x.lactNo ?? x['رقم موسم الحليب'] ?? null,
    breed: x.breed ?? x.breedName ?? x['السلالة'] ?? null,
    group: x.group ?? x['المجموعة'] ?? null,

    pregnancyDate: x.pregnancyDate ?? x.pregnantFrom ?? x['تاريخ الحمل'] ?? null,
    reproductiveStatus: normReproStatus(x.reproductiveStatus ?? x['الحالة التناسلية'] ?? x.reproStatus ?? x.statusRepro) ?? null,
    lastInseminationDate: x.lastInseminationDate ?? x.lastServiceDate ?? x['تاريخ آخر تلقيح'] ?? null,
    servicesCount: x.servicesCount ?? x.inseminationsCount ?? x.SPC ?? x['عدد مرات التلقيح'] ?? null,
    estrusDates: x.estrusDates ?? x.heatDates ?? x['تواريخ الشياع'] ?? [],
    serviceIntervalDays: x.serviceIntervalDays ?? x.serviceInterval ?? x['معدل الأيام بين التلقيح'] ?? null,
    heatIntervalDays: x.heatIntervalDays ?? x.heatInterval ?? x['الأيام بين الشياع'] ?? null,

    productionStatus: normProdStatus(x.productionStatus ?? x['حالة الإنتاج'] ?? x.prodStatus ?? x.status) ?? null,
    milkTodayKg:   x.milkTodayKg   ?? x.todayMilk   ?? x.dailyMilk   ?? x.daily_milk   ?? x['إنتاج اليوم']   ?? null,
    seasonTotalKg: x.seasonTotalKg ?? x.milkSeason  ?? x['إنتاج الموسم']  ?? null,
    m305Kg:        x.m305Kg        ?? x.milk305     ?? x['إنتاج 305 يوم'] ?? null,

    healthStatus:  x.healthStatus  ?? x['الحالة الصحية'] ?? 'سليم',
    lastCheckDate: x.lastCheckDate ?? x.healthCheckDate  ?? x['آخر فحص'] ?? null,

    milkTraitsScore: toPercent(x.milkTraitsScore ?? x.milk_score ?? 0),
    ovsynch: x.ovsynch ?? null,
  };
  return { ...x, ...normalized };
}

const TYPE_RULES = [
  ['milk', /(daily[_\s-]?milk|milk\s*daily|milk$|لبن|انتاج)/i],
  ['calving', /(calving|ولاد|نفاس)/i],
  ['insemination', /(insemin|ai\b|a\.i\.|تلقيح|خدم|خدمة)/i],
  ['pregnancy', /(pregnan|حامل|عِ?شار|عشار|ايجابي|موجب)/i],
  ['heat', /(heat|estrus|شياع|شبق)/i],
  ['dry', /(dry\s*-?\s*off|^dry$|جاف(ة)?|تجفيف)/i],
  ['disease', /(mastitis|lameness|disease|ill|مرض|التهاب|عرج)/i],
];

const MILK_PART_KEY =
  /(^(am|pm|morning|noon|evening|morn|mid|eve)$)|(^milk\d$)|(^milk_(am|pm|morning|noon|evening)$)|(^صباح$|^ظهر$|^مساء$|^حلبة\d$|^حلبه\d$)/i;

const MILK_DIRECT_KEYS = ['dailyMilk','daily_milk','milkKg','total','kg','milk','amount'];

const toNum = (v) => { const n = Number(v); return Number.isFinite(n) ? n : 0; };

const evType = (e = {}) => {
  const s = String(e.type ?? e.eventType ?? e.event ?? e.name ?? e.kind ?? e.category ?? '').toLowerCase();
  for (const [T, rx] of TYPE_RULES) if (rx.test(s)) return T;
  if (MILK_DIRECT_KEYS.some(k => toNum(e[k]) > 0)) return 'milk';
  for (const [k, v] of Object.entries(e)) if (MILK_PART_KEY.test(k) && toNum(v) > 0) return 'milk';
  return 'other';
};

function evMilkKg(e = {}) {
  for (const k of MILK_DIRECT_KEYS) {
    const n = toNum(e[k]);
    if (n > 0) return n;
  }
  let sum = 0;
  for (const [k, v] of Object.entries(e)) if (MILK_PART_KEY.test(k)) sum += toNum(v);
  return sum;
}

/* صف واحد للأحداث: قياس ذكي + مراقبة تغيّر المقاس */
function activateSingleRowScroll(){
  const wrap  = document.querySelector('#evList .ev-scroll');
  const table = wrap?.querySelector('table');
  const head  = table?.tHead || null;
  const body  = table?.tBodies?.[0] || null;
  const first = body?.rows?.[0] || null;
  if(!wrap || !table || !first) return;

  wrap.classList.add('single-row');
  first.classList.add('ev-row--open');

  const measure = ()=>{
    const hHead = Math.ceil(head?.getBoundingClientRect().height || 0);
    const hRow  = Math.ceil(first.getBoundingClientRect().height || 0);
    if (hRow < 8) { setTimeout(measure, 40); return; }   // انتظر حتى يرسم الصف
    wrap.style.maxHeight = (hHead + hRow + 2) + 'px';    // +2 للحدود
  };

  const ro = new ResizeObserver(measure);
  ro.observe(first);
  if (head) ro.observe(head);
  ro.observe(wrap);

  const mo = new MutationObserver(measure);
  mo.observe(body, {childList:true, subtree:true, characterData:true});

  measure();
  window.addEventListener('resize', measure);
  window.addEventListener('orientationchange', measure);
}

/* ======================= Firestore ======================= */
async function fetchAnimalByNumber(n){
  if (n == null || String(n).trim() === '') return null;
  const nStr = String(n).trim();
  const nNum = Number(nStr);
  const A = collection(DB, 'animals');

  try {
    const d = await getDoc(doc(DB, 'animals', nStr));
    if (d.exists()) {
      const data = d.data();
      if (!UID || data?.[ANIM_OWNER_FIELD] === UID) {
        return normalizeAnimalDoc({ id: d.id, ...data });
      }
    }
  } catch {}

  if (Number.isFinite(nNum)) {
    try {
      const q1 = UID
        ? query(A, where(ANIM_OWNER_FIELD,'==',UID), where('animalNumber','==',nNum), limit(1))
        : query(A, where('animalNumber','==',nNum), limit(1));
      const s1 = await getDocs(q1);
      if (!s1.empty) { const d = s1.docs[0]; return normalizeAnimalDoc({ id:d.id, ...d.data() }); }
    } catch {}
  }

  try {
    const q2 = UID
      ? query(A, where(ANIM_OWNER_FIELD,'==',UID), where('animalNumber','==',nStr), limit(1))
      : query(A, where('animalNumber','==',nStr), limit(1));
    const s2 = await getDocs(q2);
    if (!s2.empty) { const d = s2.docs[0]; return normalizeAnimalDoc({ id:d.id, ...d.data() }); }
  } catch {}

  return null;
}

async function fetchAnimal({ number, animalId } = {}) {
  if (animalId) {
    const d = await getDoc(doc(DB,'animals', String(animalId)));
    if (d.exists()) {
      const data = d.data();
      if (!UID || data?.[ANIM_OWNER_FIELD] === UID) {
        return normalizeAnimalDoc({ id:d.id, ...data });
      }
    }
  }
  const a = await fetchAnimalByNumber(number);
  if (a) return a;
  throw new Error('لا يوجد حيوان مطابق');
}

async function fetchEvents(animal){
  const E = collection(DB, 'events');
  const rows = [];

  try {
    if (animal.id) {
      const qById = UID
        ? query(E, where('animalId','==', String(animal.id)), where(EVENT_USER_FIELD,'==',UID))
        : query(E, where('animalId','==', String(animal.id)));
      const sById = await getDocs(qById);
      sById.forEach(d => rows.push({ id:d.id, ...d.data() }));
    }

    if (animal.number != null) {
      const nStr = String(animal.number);
      const nNum = Number(nStr);

      const baseQs = [
        query(E, where('animalNumber','==', nStr)),
        query(E, where('number','==', nStr)),
        ...(Number.isFinite(nNum) ? [
          query(E, where('animalNumber','==', nNum)),
          query(E, where('number','==', nNum)),
        ] : []),
      ];

      for (const q0 of baseQs) {
        const qf = UID ? query(q0, where(EVENT_USER_FIELD,'==',UID)) : q0;
        const s  = await getDocs(qf);
        s.forEach(d => rows.push({ id:d.id, ...d.data() }));
      }
    }
  } catch (e) {
    console.error('[fetchEvents] error:', e);
  }

  const uniq = new Map(rows.map(r => [r.id, r]));
  return [...uniq.values()].sort((a,b) => (evDate(a)||'').localeCompare(evDate(b)||''));
}

/* ======================= Build state ======================= */
function buildState(animal, events){
  const st={
    number: animal.number ?? animal.id?.slice(-6),
    reproductiveStatus: animal.reproductiveStatus || '—',
    productionStatus:   animal.productionStatus   || '—',
    healthStatus:       animal.healthStatus       || 'سليم',
    birthDate:       animal.birthDate       || null,
    lastCalvingDate: animal.lastCalvingDate || null,
    lactationNumber: animal.lactationNumber ?? null,
    daysInMilk: null, gestationDays: null,
    pregnancyDate: animal.pregnancyDate || null,
    breed: animal.breed || '—', group: animal.group || '—',
    milkTraitsScore: animal.milkTraitsScore ?? 0,
    inseminations: [], estrusDates: Array.isArray(animal.estrusDates)?[...animal.estrusDates]:[],
    lastInseminationDate: animal.lastInseminationDate ?? null, servicesCount: animal.servicesCount ?? null,
    serviceIntervalDays: animal.serviceIntervalDays ?? null, heatIntervalDays: animal.heatIntervalDays ?? null,
    milkTodayKg: animal.milkTodayKg ?? null, seasonTotalKg: animal.seasonTotalKg ?? null, m305Kg: animal.m305Kg ?? null,
    milkSeries: [],
    lastCheckDate: animal.lastCheckDate || null, healthHistory: [],
    ovsynch: animal.ovsynch || null, isDry: false,
    __animalRaw: animal,
  };

  const milkTmp=[]; let season=0;
  for (const e of events){
    const t=evType(e), d=evDate(e);
    if (t==='dry') st.isDry=true, st.productionStatus='جاف';
    if (t==='pregnancy') st.reproductiveStatus='عِشار';
    if (t==='calving' && d) st.lastCalvingDate=d;
    if (t==='insemination' && d) st.inseminations.push(d);
    if (t==='heat' && d) st.estrusDates.push(d);
    if (t==='pregnancy'){ st.pregnancyDate = st.pregnancyDate || d || e.pregnancyDate || null; st.reproductiveStatus='عِشار'; }
    if (t==='disease'){
      st.healthHistory.push({ date:d||'', diagnosis:eventLabel(e), note:e.note||'' });
      st.healthStatus='حالات صحية مسجلة'; st.lastCheckDate=st.lastCheckDate || d || null;
    }
    if (t==='milk'){
      const kg=evMilkKg(e);
      if (kg>0){ season+=kg; milkTmp.push({ d, kg }); if (d===todayStr) st.milkTodayKg=kg; }
    }
  }

  if (st.lastCalvingDate){
    const ms=Date.now()-new Date(st.lastCalvingDate).getTime();
    st.daysInMilk=Math.max(0,Math.floor(ms/86400000));
  }

  st.inseminations.sort();
  if (!st.lastInseminationDate) st.lastInseminationDate=st.inseminations.at(-1) || null;
  if (st.servicesCount==null) st.servicesCount=st.inseminations.length || null;
  st.estrusDates.sort();

  if (st.seasonTotalKg==null) st.seasonTotalKg=season || null;

  if (milkTmp.length){
    const base=st.lastCalvingDate?new Date(st.lastCalvingDate).getTime():null;
    st.milkSeries=milkTmp.filter(p=>p.d).map(p=>{
      const di=base?Math.max(0,Math.floor((new Date(p.d).getTime()-base)/86400000)):0;
      return { d:di, v:p.kg };
    }).sort((a,b)=>a.d-b.d);
  }

  if (st.m305Kg==null && st.daysInMilk>0 && (st.seasonTotalKg||0)>0){
    st.m305Kg=Math.round((st.seasonTotalKg/st.daysInMilk)*305);
  }

  if (st.isDry) st.productionStatus='جاف';
  else if (!animal.productionStatus && st.daysInMilk!=null){
    st.productionStatus = st.daysInMilk<60?'حليب مبكر' : st.daysInMilk<200?'حليب متوسط' : 'حليب متأخر';
  }

  // سكور سمات اللبن من الأحداث لو مش موجود
  if ((st.milkTraitsScore == null || Number(st.milkTraitsScore) === 0) && Array.isArray(events) && events.length) {
    const CAND_KEYS = ['overallScore','overall_score','overall','milkTraitsScore','traitsScore','milk_score','score','milkTraits','traits','quality'];
    const pullScore = (root)=>{
      const stack = [root];
      while (stack.length){
        const obj = stack.pop();
        if (!obj || typeof obj !== 'object') continue;
        for (const [k,v] of Object.entries(obj)){
          if (CAND_KEYS.includes(String(k))) {
            if (v != null && (typeof v === 'number' || typeof v === 'string')) return v;
          }
          if (v && typeof v === 'object') stack.push(v);
        }
      }
      return null;
    };
    for (let i = events.length - 1; i >= 0; i--) {
      const raw = pullScore(events[i]);
      if (raw != null) { st.milkTraitsScore = toPercent(raw); break; }
    }
  }
  return st;
}

/* ======================= UI (قياس/رسم) ======================= */
function arcPath(cx,cy,r,a0,a1){
  const A=(x)=>x*Math.PI/180, P=(ang)=>[cx+r*Math.cos(A(ang)), cy+r*Math.sin(A(ang))];
  const [x0,y0]=P(a0),[x1,y1]=P(a1);
  return`M ${x0.toFixed(3)} ${y0.toFixed(3)} A ${r} ${r} 0 0 1 ${x1.toFixed(3)} ${y1.toFixed(3)}`;
}
function renderGauge(score){
  score=Math.max(0,Math.min(100,Number(score)||0));
  const g=$('gSlices'); if(!g) return; g.innerHTML='';
  const colors=['#ef5350','#ffb74d','#fff176','#66bb6a'], steps=[0,25,50,75,100];
  for(let i=0;i<4;i++){
    const s=steps[i],e=steps[i+1],a0=180-(s/100)*180,a1=180-(e/100)*180;
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',arcPath(50,50,40,a0,a1));
    p.setAttribute('fill','none'); p.setAttribute('stroke',colors[i]);
    p.setAttribute('stroke-width','12'); p.setAttribute('stroke-linecap','round');
    g.appendChild(p);
  }
  const ang=180-(score/100)*180; const needle=$('needle'); if(needle) needle.setAttribute('transform',`rotate(${ang} 50 50)`);
  const label=score>=75?'ممتاز':score>=50?'جيد':score>=25?'متوسط':'ضعيف';
  put('milkGaugeVal',`${label} — ${score}%`);
}
function renderMilkChart(series){
  const svg=$('milkChart'), sc=$('milkScroll');
  if(!svg||!sc||!Array.isArray(series)||!series.length){ svg.innerHTML=''; return; }
  const base=Math.max(sc.clientWidth,320), pxPer=Math.max(6,Math.min(11,Math.round(base/28))), pad=10;
  const data=series.map((p,i)=>({x:i,y:Number(p.v)||0})), N=data.length, W=pad*2+(N-1)*pxPer+20;
  svg.setAttribute('viewBox',`0 0 ${W} 60`); svg.style.width=W+'px';
  const maxY=Math.max(...data.map(d=>d.y),1), minY=Math.min(...data.map(d=>d.y),0), yR=Math.max(1,maxY-minY);
  const sx=(i)=>pad+(i*pxPer), sy=(v)=>60-6-((v-minY)*(60-12)/yR);
  svg.innerHTML='';
  const grid=document.createElementNS('http://www.w3.org/2000/svg','g');
  for(let i=1;i<=3;i++){
    const y=6+i*(60-12)/3;
    const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',6); ln.setAttribute('x2',W-6);
    ln.setAttribute('y1',y); ln.setAttribute('y2',y);
    ln.setAttribute('stroke','#e9f5dc'); ln.setAttribute('stroke-width','0.6');
    grid.appendChild(ln);
  }
  svg.appendChild(grid);
  let d=''; data.forEach((p,i)=>{ d+=(i?' L ':'M ')+sx(i).toFixed(2)+' '+sy(p.y).toFixed(2); });
  const area=d+` L ${sx(N-1).toFixed(2)} ${60-6} L ${sx(0).toFixed(2)} ${60-6} Z`;
  const ap=document.createElementNS('http://www.w3.org/2000/svg','path'); ap.setAttribute('d',area); ap.setAttribute('fill','#cdeccd'); ap.setAttribute('opacity','0.6'); svg.appendChild(ap);
  const lp=document.createElementNS('http://www.w3.org/2000/svg','path'); lp.setAttribute('d',d); lp.setAttribute('fill','none'); lp.setAttribute('stroke','#2e7d32'); lp.setAttribute('stroke-width','1.2'); svg.appendChild(lp);
  const cx=sx(N-1), cy=sy(data[N-1].y); const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
  dot.setAttribute('cx',cx); dot.setAttribute('cy',cy); dot.setAttribute('r',2); dot.setAttribute('fill','#1b5e20'); svg.appendChild(dot);
  setTimeout(()=>{ sc.scrollLeft = sc.scrollWidth; }, 0);

  addEventListener('resize',()=>renderMilkChart(series),{once:true});
}

/* === Timeline === */
function _colorForType(t){
  switch(t){
    case 'calving': return getComputedStyle(document.documentElement).getPropertyValue('--tl-calving') || '#1b5e20';
    case 'insemination': return getComputedStyle(document.documentElement).getPropertyValue('--tl-insem') || '#0d9488';
    case 'pregnancy': return getComputedStyle(document.documentElement).getPropertyValue('--tl-preg') || '#a16207';
    case 'heat': return getComputedStyle(document.documentElement).getPropertyValue('--tl-heat') || '#ef6c00';
    case 'dry': return getComputedStyle(document.documentElement).getPropertyValue('--tl-dry') || '#6b7280';
    case 'disease': return getComputedStyle(document.documentElement).getPropertyValue('--tl-disease') || '#c62828';
    case 'milk': return getComputedStyle(document.documentElement).getPropertyValue('--tl-milk') || '#2e7d32';
    default: return getComputedStyle(document.documentElement).getPropertyValue('--tl-other') || '#4b5563';
  }
}
function _fmtDate(d){ try{ return new Date(d).toLocaleDateString('ar-EG'); }catch{ return d||'—'; } }

function renderTimeline(events, state){
  const box = document.getElementById('timelineBox');
  if (!box) return;
  box.innerHTML = '';

  const rows = (Array.isArray(events)?events:[])
    .map(e => ({ e, d: evDate(e) }))
    .filter(x => x.d);

  if (!rows.length){
    const empty = document.createElement('div');
    empty.style.cssText='padding:10px;color:#456;font:13px system-ui';
    empty.textContent = 'لا توجد أحداث بعد.';
    box.appendChild(empty);
    return;
  }

  let minT = Infinity, maxT = -Infinity;
  for (const r of rows){
    const t = +new Date(r.d);
    if (t < minT) minT = t;
    if (t > maxT) maxT = t;
  }
  if (!Number.isFinite(minT) || !Number.isFinite(maxT)) return;
  if (maxT - minT < 86400000){ minT -= 3*86400000; maxT += 3*86400000; }

  const padL = 40, padR = 40, padT = 28, padB = 38;
  const dotsW = Math.max(600, rows.length * 40);
  const W = padL + dotsW + padR, H = 120;
  const Y = Math.round(H/2) + 6;

  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('class','tl-svg');
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.style.width = W+'px';

  const axis = document.createElementNS(svgNS, 'line');
  axis.setAttribute('x1', padL); axis.setAttribute('x2', W-padR);
  axis.setAttribute('y1', Y);    axis.setAttribute('y2', Y);
  axis.setAttribute('stroke', '#cfe9c8'); axis.setAttribute('stroke-width','2');
  svg.appendChild(axis);

  const ticks = 6;
  for (let i=0;i<=ticks;i++){
    const t = minT + (i*(maxT-minT)/ticks);
    const x = padL + ((t-minT)/(maxT-minT))*(W-padL-padR);

    const line = document.createElementNS(svgNS,'line');
    line.setAttribute('x1',x); line.setAttribute('x2',x);
    line.setAttribute('y1',Y-16); line.setAttribute('y2',Y+16);
    line.setAttribute('stroke','#e9f5dc'); line.setAttribute('stroke-width','0.8');
    svg.appendChild(line);

    const lbl = document.createElementNS(svgNS,'text');
    lbl.setAttribute('x',x); lbl.setAttribute('y',H-padB+26);
    lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('font-size','10');
    lbl.setAttribute('fill','#355');
    lbl.textContent = new Date(t).toLocaleDateString('ar-EG');
    svg.appendChild(lbl);
  }

  const tip = document.getElementById('tlTip');
  function showTipAt(svgEl, x, y, title, details, dateStr){
    if (!tip) return;
    tip.style.display='block';
    const svgRect  = svgEl.getBoundingClientRect();
    const hostRect = box.closest('.timeline-card').getBoundingClientRect();
    const sx = svgRect.left + (x / W) * svgRect.width;
    const sy = svgRect.top  + (y / H) * svgRect.height;
    tip.style.left = (sx - hostRect.left) + 'px';
    tip.style.top  = (sy - hostRect.top  - 14) + 'px';
    tip.innerHTML = `<b>${title||'—'}</b><div>${details||''}</div><div class="tl-date">${_fmtDate(dateStr)||''}</div>`;
  }
  function hideTip(){ if (tip) tip.style.display='none'; }
  box.addEventListener('scroll', hideTip, { passive:true });
  document.addEventListener('pointerdown', (ev)=>{ if(!box.contains(ev.target)) hideTip(); }, { passive:true });

  rows.forEach(({e,d})=>{
    const t = +new Date(d);
    const x = padL + ((t-minT)/(maxT-minT))*(W-padL-padR);
    const y = Y;

    const tpe = evType(e);
    const color = _colorForType(tpe);

    const stem = document.createElementNS(svgNS,'line');
    stem.setAttribute('x1',x); stem.setAttribute('x2',x);
    stem.setAttribute('y1',y-14); stem.setAttribute('y2',y+14);
    stem.setAttribute('stroke', color); stem.setAttribute('stroke-width','1');
    stem.setAttribute('opacity','0.5');
    svg.appendChild(stem);

    const dot = document.createElementNS(svgNS,'circle');
    dot.setAttribute('cx', x); dot.setAttribute('cy', y);
    dot.setAttribute('r', 6);
    dot.setAttribute('fill', color);
    dot.setAttribute('class', 'tl-dot');
    dot.setAttribute('tabindex','0');
    dot.setAttribute('role','button');
    dot.setAttribute('aria-label', `${eventLabel(e)} — ${_fmtDate(d)}`);
    svg.appendChild(dot);

    const hit = document.createElementNS(svgNS,'circle');
    hit.setAttribute('cx', x); hit.setAttribute('cy', y);
    hit.setAttribute('r', 16);
    hit.setAttribute('fill', 'transparent');
    hit.style.cursor = 'pointer';
    svg.appendChild(hit);

    const title   = eventLabel(e);
    const details = compactEventDetails(e);
    const dateStr = d;

    const openTip  = ()=> showTipAt(svg, x, y, title, details, dateStr);
    const closeTip = hideTip;

    // Hint فقط – بدون قفز للجدول
    hit.addEventListener('mouseenter', openTip);
    hit.addEventListener('mouseleave', closeTip);
    hit.addEventListener('click', (ev)=>{ ev.stopPropagation(); openTip(); });
    hit.addEventListener('touchstart', ()=>{ openTip(); clearTimeout(hit._to); hit._to=setTimeout(closeTip,2200); }, {passive:true});
    hit.addEventListener('touchend', closeTip,   {passive:true});
    hit.addEventListener('touchcancel', closeTip,{passive:true});
    dot.addEventListener('focus', openTip);
    dot.addEventListener('blur',  closeTip);
    dot.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter' || ev.key===' ') openTip(); });
  });

  const scroller = document.createElement('div');
  scroller.style.width = W+'px';
  scroller.appendChild(svg);
  box.appendChild(scroller);

  setTimeout(()=>{ box.scrollLeft = box.scrollWidth; }, 0);
}

function avgDaysBetween(dts){ if(!dts||dts.length<2) return null;
  const ms=dts.map(d=>new Date(d).getTime()).sort((a,b)=>a-b);
  const dif=[]; for(let i=1;i<ms.length;i++) dif.push((ms[i]-ms[i-1])/86400000);
  return Math.round(dif.reduce((a,b)=>a+b,0)/dif.length);
}
function setChip(el,text){ if(!el) return; const t=String(text||'').toLowerCase(); let v='ok';
  if(/مفتوح|خطر منخفض|متوسط/.test(t)) v='warn'; if(/حاد|شديد|مرض|نفاس متعثر/.test(t)) v='danger';
  el.textContent=text||'—'; el.setAttribute('data-variant',v);
}

/* ======================= حقول إضافية ======================= */
function addFi(containerId, label, value) {
  if (value == null || value === '' || (Array.isArray(value) && !value.length)) return;
  const box = document.getElementById(containerId);
  if (!box) return;
  const fi = document.createElement('div');
  fi.className = 'fi';
  const sp = document.createElement('span'); sp.textContent = label;
  const b  = document.createElement('b');   b.textContent = Array.isArray(value) ? value.join('، ') : String(value);
  fi.appendChild(sp); fi.appendChild(b); box.appendChild(fi);
}

const EXTRA_FIELD_MAP = [
  { keys: ['earTag','ear_tag','tag','رقم_الترقيم'],           label: 'رقم الترقيم',         target: 'basicInfo' },
  { keys: ['rfid','RFID'],                                    label: 'RFID',                target: 'basicInfo' },
  { keys: ['color','لون'],                                    label: 'اللون',               target: 'basicInfo' },
  { keys: ['originFarm','origin','المزرعة_المنشأ'],           label: 'مزرعة المنشأ',        target: 'basicInfo' },
  { keys: ['pen','housing','الحظيرة','المجموعة_السكنية'],     label: 'الحظيرة/المكان',      target: 'basicInfo' },
  { keys: ['bodyWeight','weight','الوزن'],                    label: 'الوزن (كجم)',         target: 'basicInfo' },
  { keys: ['birthWeight','weightAtBirth','وزن_الولادة'],      label: 'وزن الولادة (كجم)',   target: 'basicInfo' },

  { keys: ['milkFat','fat%','fat','دهن'],                     label: 'دهن %',               target: 'milkScroll' },
  { keys: ['milkProtein','protein%','protein','بروتين'],      label: 'بروتين %',            target: 'milkScroll' },
  { keys: ['milkLactose','lactose%','لاكتوز'],               label: 'لاكتوز %',            target: 'milkScroll' },
  { keys: ['milkSNF','snf','مواد_صلبة_لادهنية'],             label: 'SNF %',               target: 'milkScroll' },

  { keys: ['expectedCalvingDate','dueDate','موعد_الولادة'],   label: 'موعد الولادة المتوقع', target: 'fiServiceInterval' },
  { keys: ['pregnancyResult','pregStatus','نتيجة_الحمل'],     label: 'نتيجة الحمل',         target: 'fiServiceInterval' },
  { keys: ['bull','sire','الأب','الثور'],                     label: 'الثور/الأب',          target: 'fiServiceInterval' },

  { keys: ['vaccinations','vaccinationProgram','التحصينات'],  label: 'التحصينات',           target: 'healthList' },
  { keys: ['lastMastitisDate','mastitisDate','التهاب_الضرع_آخر'], label: 'آخر التهاب ضرع', target: 'healthList' },
  { keys: ['lamenessScore','LS','عرج'],                        label: 'درجة العرج',         target: 'healthList' },

  { keys: ['bcs','bodyScore','BCS','حالة_الجسم'],             label: 'حالة الجسم (BCS)',    target: 'basicInfo' },
  { keys: ['fecesScore','manureScore','درجة_الروث'],          label: 'درجة الروث',          target: 'basicInfo' },
];

function firstDefined(obj, keys) {
  for (const k of keys) if (obj[k] != null && obj[k] !== '') return obj[k];
  return null;
}

function renderExtrasIntoSections(animal) {
  const BLOCK = new Set(['ownerUid','owner','uid','user','userId','__name__','__path__','id','createdAt','updatedAt']);
  const safeAnimal = {};
  for (const [k,v] of Object.entries(animal)) if (!BLOCK.has(k)) safeAnimal[k] = v;

  const milkScroll = document.getElementById('milkScroll');
  let prodGrid;
  if (milkScroll) {
    prodGrid = document.createElement('div');
    prodGrid.className = 'grid';
    prodGrid.style.margin = '8px 0';
    milkScroll.parentElement.insertBefore(prodGrid, milkScroll);
  }

  for (const def of EXTRA_FIELD_MAP) {
    const val = firstDefined(safeAnimal, def.keys);
    if (val == null) continue;

    let containerEl = null;
    if (def.target === 'milkScroll' && prodGrid) {
      containerEl = prodGrid;
    } else if (def.target === 'fiServiceInterval') {
      const sec = Array.from(document.querySelectorAll('section.card h3'))
        .find(h => h.textContent.trim().includes('الحالة التناسلية'));
      if (sec) containerEl = sec.parentElement.querySelector('.grid');
    } else if (def.target === 'healthList') {
      const sec = Array.from(document.querySelectorAll('section.card h3'))
        .find(h => h.textContent.trim().includes('الحالة الصحية'));
      if (sec) containerEl = sec.parentElement.querySelector('.grid');
    } else {
      containerEl = document.getElementById(def.target);
    }
    if (!containerEl) continue;

    const fi = document.createElement('div'); fi.className = 'fi';
    const sp = document.createElement('span'); sp.textContent = def.label;
    const b  = document.createElement('b');   b.textContent = Array.isArray(val) ? val.join('، ') : String(val);
    fi.appendChild(sp); fi.appendChild(b);
    containerEl.appendChild(fi);
  }
}

/* === تفاصيل الحدث المختصرة === */
function compactEventDetails(e){
  const t = evType(e);
  if (t === 'milk'){
    const kg = evMilkKg(e);
    if (kg > 0) return `لبن: ${kg} كجم`;
  }
  if (t === 'disease'){
    const dx = eventLabel(e);
    const nt = e.note ? ` — ${e.note}` : '';
    return `تشخيص: ${dx}${nt}`;
  }
  if (t === 'insemination'){
    const bull = e.bull || e.semen || e.sire || e.straw || '—';
    return `تلقيح (ثور/سائل): ${bull}`;
  }
  if (t === 'pregnancy'){
    const res = e.result || e.status || 'موجب';
    return `تشخيص حمل: ${res}`;
  }
  if (t === 'dry'){ return 'تجفيف الحليب'; }
  if (t === 'calving'){
    const sex  = e.calfSex || e.sex || '—';
    const diff = e.difficulty || e.assist || 'طبيعي';
    return `ولادة — جنس العجل: ${sex} — ${diff}`;
  }
  const keys = ['value','amount','kg','note','details','desc','comment'];
  for (const k of keys){
    if (e[k] != null){
      const v = e[k];
      const txt = Array.isArray(v) ? v.join('، ')
               : (typeof v === 'number' ? NF.format(v)
               : String(v));
      return `${k}: ${txt}`;
    }
  }
  try {
    return JSON.stringify({
      type: e.type || e.eventType || '—',
      ...(['eventDate','date','day'].reduce((a,kk)=>{
        if (e[kk]) a[kk] = e[kk];
        return a;
      }, {}))
    });
  } catch {
    return '—';
  }
}

/* === جدول الأحداث === */
function renderEventsList(events){
  const box = document.getElementById('evList');
  if (!box) return;
  box.innerHTML = '';

  const wrap  = document.createElement('div'); wrap.className = 'ev-scroll';
  const table = document.createElement('table'); table.className = 'ev-table';
  table.innerHTML = `
    <thead>
      <tr>
        <th style="width:140px">التاريخ</th>
        <th style="width:160px">اسم الحدث</th>
        <th>التفاصيل</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector('tbody');

  if (!Array.isArray(events) || !events.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="ev-date">—</td>
      <td class="ev-type">لا توجد أحداث</td>
      <td class="ev-note">—</td>
    `;
    tbody.appendChild(tr);
    wrap.appendChild(table);
    box.appendChild(wrap);
  } else {
    const rows = [...events].map(e => ({ e, d: evDate(e) || '' }))
      .sort((a,b) => (b.d||'').localeCompare(a.d||''));

    for (const {e, d} of rows){
      const tr = document.createElement('tr');
      tr.id = e.id ? `evrow-${e.id}` : '';
      tr.setAttribute('aria-selected','false');

      const dateTd = document.createElement('td');
      dateTd.className = 'ev-date';
      dateTd.textContent = d ? new Date(d).toLocaleDateString('ar-EG') : '—';

      const nameTd = document.createElement('td');
      nameTd.className = 'ev-type';
      nameTd.textContent = eventLabel(e);  /* الاسم بالعربي */

      const detTd = document.createElement('td');
      detTd.className = 'ev-note';
      detTd.textContent = compactEventDetails(e) || '—';

      const moreBtn = document.createElement('button');
      moreBtn.type = 'button';
      moreBtn.className = 'ev-more';
      moreBtn.setAttribute('aria-expanded','false');
      moreBtn.textContent = 'عرض الكل';
      moreBtn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const open = tr.classList.toggle('ev-row--open');
        moreBtn.setAttribute('aria-expanded', String(open));
      });
      detTd.appendChild(moreBtn);

      tr.appendChild(dateTd);
      tr.appendChild(nameTd);
      tr.appendChild(detTd);
      tbody.appendChild(tr);
    }

    wrap.appendChild(table);
    box.appendChild(wrap);
  }

  // فتح/قفل الصف بالسطر كله (مفيد للموبايل)
  tbody.addEventListener('click', (e)=>{
    const tr = e.target.closest('tr');
    if (!tr) return;
    tr.classList.toggle('ev-row--open');
  });

  // قفل العلبة على ارتفاع صف واحد بعد بناء الجدول
  activateSingleRowScroll();
}

// (موجودة لكن لن تُستعمل الآن لأننا منعنا القفز من التايملاين)
function focusEventRow(eid){
  const tr = document.getElementById(`evrow-${eid}`);
  if (!tr) return;
  tr.classList.add('ev-row--focus');
  tr.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  setTimeout(()=> tr.classList.remove('ev-row--focus'), 1600);
}

/* ======================= ربط الأقسام ======================= */
function renderCard(state, kind){
  $('cardTitle').textContent = `${kindTitleAr(kind)} رقم ${state.number ?? '—'}`;
  setChip($('chipRepro'),state.reproductiveStatus); setChip($('chipProd'),state.productionStatus); setChip($('chipHealth'),state.healthStatus);

  put('fiBirth',fmtD(state.birthDate)); put('fiLastCalving',fmtD(state.lastCalvingDate));
  put('fiLactNo',state.lactationNumber!=null?NF.format(state.lactationNumber):'—');

  const hideDIM = state.isDry || state.productionStatus === 'جاف';
  put('fiDIM', (!hideDIM && state.daysInMilk!=null) ? NF.format(state.daysInMilk) : '—');

  let g=state.gestationDays, ref=state.pregnancyDate||state.lastInseminationDate;
  if(g==null&&ref){const ms=Date.now()-new Date(ref).getTime(); g=Math.max(0,Math.floor(ms/86400000));}
  put('fiGestAge',g!=null?NF.format(g):'—'); put('fiBreed',state.breed||'—'); put('fiGroup',state.group||'—');

  renderGauge(state.milkTraitsScore);
  put('kpiMilkToday',state.milkTodayKg!=null?`${Number(state.milkTodayKg).toFixed(1)} كجم`:'—');
  put('kpiSeason',state.seasonTotalKg!=null?`${NF.format(Math.round(state.seasonTotalKg))} كجم`:'—');
  put('kpi305',state.m305Kg!=null?`${NF.format(Math.round(state.m305Kg))} كجم`:'—');
  renderMilkChart(state.milkSeries);

  put('fiLastIns',fmtD(state.lastInseminationDate));
  const spc = state.servicesCount;
  put('fiServicesCount', spc != null ? NF.format(spc) : '—');
  const svcI = state.serviceIntervalDays ?? avgDaysBetween(state.inseminations);
  put('fiServiceInterval', svcI != null ? `${NF.format(svcI)} يوم` : '—');
  const lastHeat=(state.estrusDates&&state.estrusDates.length)?state.estrusDates.at(-1):null; put('fiLastHeat',fmtD(lastHeat));
  const hI = state.heatIntervalDays ?? avgDaysBetween(state.estrusDates);
  put('fiHeatInterval', hI != null ? `${NF.format(hI)} يوم` : '—');
  put('fiOvsynch', state.ovsynch ?? '—');
  put('fiHealth',state.healthStatus||'—'); put('fiLastCheck',fmtD(state.lastCheckDate));
  const hl=$('healthList'); hl.innerHTML='';
  if(Array.isArray(state.healthHistory)&&state.healthHistory.length){
    state.healthHistory.slice(-6).forEach(it=>{
      const row=document.createElement('div'); row.className='hl';
      const d=document.createElement('div'); d.textContent=fmtD(it.date);
      const dx=document.createElement('div'); dx.textContent=it.diagnosis||'—';
      const nt=document.createElement('div'); nt.className='note'; nt.textContent=it.note||'';
      row.appendChild(d); row.appendChild(dx); row.appendChild(nt); hl.appendChild(row);
    });
  } else {
    const row=document.createElement('div'); row.className='hl';
    ['—','لا توجد سجلات',''].forEach((t,i)=>{const c=document.createElement('div'); if(i===2)c.className='note'; c.textContent=t; row.appendChild(c);});
    hl.appendChild(row);
  }

  renderExtrasIntoSections(state.__animalRaw || {});
}

/* ======================= Load & Run ======================= */
async function loadAndRender({number, animalId, type}){
  try{
    let kind = normKind(type);
    const animal = await fetchAnimal({number, animalId});
    if(!kind) kind = animal.kind || normKind(localStorage.getItem('lastKind'));
    if(kind){ localStorage.setItem('lastKind',kind); if(kindValEl) kindValEl.textContent = kindNameAr(kind); }

    if (animal.id) localStorage.setItem('currentAnimalId', String(animal.id));
    if (animal.number!=null) {
      localStorage.setItem('currentAnimalNumber', String(animal.number));
      localStorage.setItem('lastAnimalNumber', String(animal.number));
    }

    const events = await fetchEvents(animal);
    const state  = buildState(animal, events);

    if(!events.length){
      const tip=document.createElement('div'); tip.className='notice';
      tip.innerHTML=`لا توجد أحداث مسجلة بعد. <a href="/add-event.html?number=${encodeURIComponent(state.number||'')}" style="font-weight:700;color:#1b5e20">أضف أول حدث الآن</a>.`;
      document.querySelector('.wrap')?.prepend(tip);
    }

    renderCard(state, kind);
    renderTimeline(events, state);
    renderEventsList(events);

  }catch(e){
    console.error(e);
    $('cardTitle').textContent='تعذّر تحميل بطاقة الحيوان';
  }
}

const numberParam = url.searchParams.get('number') || url.searchParams.get('animalNumber') || '';
const idParam     = url.searchParams.get('animalId') || '';
const typeParam   = (url.searchParams.get('type') || url.searchParams.get('kind') || url.searchParams.get('animaltype') || '').toLowerCase();

if (numberParam || idParam){
  if (openbar) openbar.style.display='none';
  if (typeParam && kindValEl) kindValEl.textContent = kindNameAr(normKind(typeParam));
  loadAndRender({number:numberParam, animalId:idParam, type:typeParam});
} else {
  const lastNum = localStorage.getItem('currentAnimalNumber') || localStorage.getItem('lastAnimalNumber') || '';
  if(lastNum && openInput){ openInput.value=lastNum; }
  if(openBtn){ openBtn.addEventListener('click', ()=>{ const n=(openInput.value||'').trim(); if(!n) return; loadAndRender({number:n}); }); }
}

/* تأكيد إعادة القياس بعد التحميل والخطوط */
window.addEventListener('load', ()=> {
  requestAnimationFrame(()=>requestAnimationFrame(activateSingleRowScroll));
});
if (document.fonts && document.fonts.ready) {
  document.fonts.ready.then(()=> setTimeout(activateSingleRowScroll, 0));
}

  </script>
</body>
</html>
