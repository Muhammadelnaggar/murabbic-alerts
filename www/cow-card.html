<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>بطاقة الحيوان</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #1b8f3a;
      --yellow: #fff9cc;
      --text: #222;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic", sans-serif;
      background: var(--yellow);
      color: var(--text);
    }
    header {
      background: var(--green);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header .title {
      font-size: 20px;
      font-weight: 700;
      line-height: 1.2;
    }
    main { padding: 16px; max-width: 900px; margin: 0 auto; }
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    .row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
    .item { padding: 12px; border-radius: 12px; border: 1px dashed var(--border); background:#fff; }
    .label { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .value { font-size: 16px; font-weight: 700; color: #111; }
    .toolbar { display:flex; flex-wrap: wrap; gap:10px; margin: 16px 0 0; }
    .btn {
      appearance: none; border: 0; cursor: pointer;
      background: var(--green); color: #fff; font-weight: 700;
      padding: 10px 14px; border-radius: 999px; transition: transform .05s ease;
      text-decoration: none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn.secondary { background: #fff; color: var(--green); border: 2px solid var(--green); }
    .btn:active { transform: translateY(1px); }
    .status { margin-top: 12px; font-size: 14px; color: var(--muted); }
    .error { color: #b91c1c; font-weight: 700; }
    .ok { color: var(--green); font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .loading { opacity: .7; }
      /* تبويب الصفحة الواحدة */
    .tabs { display:flex; gap:8px; padding:8px 16px; position: sticky; top: 0; background: var(--yellow); z-index: 5; border-bottom: 1px solid var(--border); }
    .tab { appearance:none; border:1px solid var(--green); background:#fff; color:var(--green); font-weight:700; padding:8px 12px; border-radius:999px; cursor:pointer; }
    .tab.active { background: var(--green); color:#fff; }
    .tab-section { display:none; }
    .tab-section.active { display:block; }
  </style>
</head>
<body>
  <header>
    <div class="title" id="page-title">بطاقة الحيوان</div>
  </header>

  <main>
    <nav class="tabs">
      <button class="tab active" data-tab="tab-overview">البيانات</button>
      <button class="tab" data-tab="tab-repro">تناسلي</button>
      <button class="tab" data-tab="tab-prod">إنتاجي</button>
      <button class="tab" data-tab="tab-health">صحي</button>
      <button class="tab" data-tab="tab-milk">الألبان</button>
    </nav>
    <section class="tab-section active" id="tab-overview">
      <div id="info" class="card loading">
      <div class="row">
        <div class="item"><div class="label">السلالة</div><div id="v-breed" class="value">—</div></div>
        <div class="item"><div class="label">الحالة الإنتاجية</div><div id="v-prod" class="value">—</div></div>
        <div class="item"><div class="label">الحالة التناسلية</div><div id="v-repro" class="value">—</div></div>
        <div class="item"><div class="label">إنتاج اللبن اليومي (كجم)</div><div id="v-milk" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ آخر ولادة</div><div id="v-lastCalving" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ آخر تلقيح</div><div id="v-lastInsem" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ الميلاد</div><div id="v-dob" class="value">—</div></div>
        </div>
      <div class="toolbar">
        <a id="btn-add-event" class="btn" href="#">+ تسجيل حدث لهذا الحيوان</a>
        <a id="btn-dashboard" class="btn secondary" href="dashboard.html">لوحة التحكم</a>
        <a id="btn-back-list" class="btn secondary" href="animal-list.html">قائمة الحيوانات</a>
      </div>
      <div id="status" class="status">جارِ التحميل…</div>
    </div>
    </section>

    <!-- الذكاء التناسلي -->
    <section class="tab-section" id="tab-repro">
      <div id="smartRepro" class="card" style="margin-top:12px;">
      <div class="label" style="font-size:14px;color:#1b8f3a;font-weight:700;margin-bottom:8px;">الذكاء التناسلي</div>
      <div class="row">
        <div class="item"><div class="label">الحالة التناسلية الحالية</div><div id="sm-repro-status" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ آخر تلقيح</div><div id="sm-last-insem" class="value">—</div></div>
        <div class="item"><div class="label">عدد مرات التلقيح</div><div id="sm-insem-count" class="value">—</div></div>
        <div class="item"><div class="label">أيام بين آخر تلقيحين</div><div id="sm-insem-last-interval" class="value">—</div></div>
        <div class="item"><div class="label">متوسط الأيام بين التلقيحات</div><div id="sm-insem-avg-interval" class="value">—</div></div>
      </div>
    </div>
      </div>
    </section>

    <!-- الذكاء الإنتاجي -->
    <section class="tab-section" id="tab-prod">
      <div id="smartProd" class="card" style="margin-top:12px;">
      <div class="label" style="font-size:14px;color:#1b8f3a;font-weight:700;margin-bottom:8px;">الذكاء الإنتاجي</div>
      <div class="row">
        <div class="item"><div class="label">الحالة الإنتاجية</div><div id="sm-prod-status" class="value">—</div></div>
        <div class="item"><div class="label">أيام الحليب (DIM)</div><div id="sm-dim" class="value">—</div></div>
      </div>
    </div>
      </div>
    </section>

    <!-- الذكاء الصحي -->
    <section class="tab-section" id="tab-health">
      <div id="smartHealth" class="card" style="margin-top:12px;">
      <div class="label" style="font-size:14px;color:#1b8f3a;font-weight:700;margin-bottom:8px;">الذكاء الصحي</div>
      <div class="row">
        <div class="item"><div class="label">آخر تشخيص</div><div id="sm-last-diagnosis" class="value">—</div></div>
        <div class="item"><div class="label">تاريخ التشخيص</div><div id="sm-last-diagnosis-date" class="value">—</div></div>
      </div>
    </div>

          </div>
    </section>

    <section class="tab-section" id="tab-milk">
      <div id="milkCard" class="card" style="margin-top:12px;">
      <div class="label" style="font-size:14px;color:#1b8f3a;font-weight:700;margin-bottom:8px;">ذكاء الألبان</div>
      <div class="row">
        <div class="item"><div class="label">إنتاج اليوم (كجم)</div><div id="sm-milk-today" class="value">—</div></div>
        <div class="item"><div class="label">إجمالي هذا الشهر (كجم)</div><div id="sm-milk-month" class="value">—</div></div>
        <div class="item"><div class="label">التراكمي منذ بداية الموسم (كجم)</div><div id="sm-milk-season" class="value">—</div></div>
      </div>
      <div class="label" style="font-size:14px;color:#1b8f3a;font-weight:700;margin:12px 0 8px;">منحنى إنتاج اللبن اليومي</div>
      <div id="milkWrap" style="height:260px; position:relative;">
        <canvas id="milkChart" aria-label="منحنى إنتاج اللبن" role="img"></canvas>
      </div>
      <div id="milkStatus" class="status">جارِ تحميل القراءات…</div>
    </div>

          </div>
    </section>

    <div id="errorBox" class="card" style="display:none">
      <div class="error">تعذّر تحميل بيانات الحيوان.</div>
      <div class="status">تأكد من الرابط أو من الصلاحيات. إذا فتحت الصفحة من قائمة الحيوانات فالمفترض أن يعمل الرابط تلقائيًا.</div>
      <div class="toolbar"><a class="btn secondary" href="animal-list.html">الرجوع لقائمة الحيوانات</a></div>
    </div>
  </main>

  <!-- تعتمد الصفحة على ملف firebase-config.js الذي يهيئ Firebase ويصدّر auth و db -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    // 1) استيراد Firebase v10 (مطابقة لنسخة مشروعك) + auth/db من firebase-config.js
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { doc, getDoc, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { auth, db } from './js/firebase-config.js';

// 2) المراجع إلى عناصر الواجهة
    const tabs    = document.querySelectorAll('.tab');
    const sections= document.querySelectorAll('.tab-section');
    const infoBox = document.getElementById('info');
    const errBox  = document.getElementById('errorBox');
    const status  = document.getElementById('status');
    const titleEl = document.getElementById('page-title');
    const vBreed  = document.getElementById('v-breed');
    const vProd   = document.getElementById('v-prod');
    const vRepro  = document.getElementById('v-repro');
    const vMilk   = document.getElementById('v-milk');
    const vLastC  = document.getElementById('v-lastCalving');
    const vLastI  = document.getElementById('v-lastInsem');
    const vDob    = document.getElementById('v-dob');const btnAddEvent = document.getElementById('btn-add-event');

    // 3) أدوات مساعدة
    function setTab(id) {
      sections.forEach(s => s.classList.toggle('active', s.id === id));
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === id));
      try { localStorage.setItem('cardTab', id); } catch {}
    }
    tabs.forEach(btn => btn.addEventListener('click', (e) => {
      e.preventDefault();
      const id = btn.dataset.tab;
      setTab(id);
      const usp = new URLSearchParams(location.search);
      usp.set('tab', id);
      history.replaceState(null, '', location.pathname + '?' + usp.toString());
    }));
    const initTab = getQP('tab') || (typeof localStorage !== 'undefined' && localStorage.getItem('cardTab')) || 'tab-overview';
    setTab(initTab);

    // 3) أدوات مساعدة
    const fmt = new Intl.DateTimeFormat('ar-EG', { dateStyle: 'medium' });
    const asDate = (x) => {
      if (!x) return '—';
      // يقبل Timestamp الخاص بـ Firestore أو نص ISO أو تاريخ JS
      try {
        if (typeof x?.toDate === 'function') return fmt.format(x.toDate());
        const d = (typeof x === 'string') ? new Date(x) : x;
        if (!isNaN(d)) return fmt.format(d);
      } catch {}
      return '—';
    };

    const getQP = (key) => new URLSearchParams(location.search).get(key);

    // تحميل كل أحداث الحيوان (مرّة واحدة)
    async function loadAllEvents(docId, number) {
      const eventsRef = collection(db, 'events');
      let snap = await getDocs(query(eventsRef, where('animalDocId','==', docId)));
      let rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      if ((!rows || rows.length === 0) && number) {
        snap = await getDocs(query(eventsRef, where('animalNumber','==', String(number))));
        rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }
      return rows;
    }

    // أدوات مساعدة للتواريخ
    const toJsDate = (x) => {
      if (!x) return null;
      try { if (typeof x.toDate === 'function') return x.toDate(); } catch {}
      const d = (typeof x === 'string') ? new Date(x) : x;
      return isNaN(d) ? null : d;
    };
    const daysBetween = (a,b) => {
      if (!a || !b) return null;
      const ms = Math.abs(b - a);
      return Math.floor(ms / (1000*60*60*24));
    };
    const isSameDay = (a,b) => a && b && a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();

    // تعبئة الأجواء الذكية
    async function fillSmartSections(rows, animalDoc) {
      const get = (id) => document.getElementById(id);
      const reproStatusEl = get('sm-repro-status');
      const lastInsemEl   = get('sm-last-insem');
      const insemCountEl  = get('sm-insem-count');
      const insemLastInt  = get('sm-insem-last-interval');
      const insemAvgInt   = get('sm-insem-avg-interval');

      const prodStatusEl  = get('sm-prod-status');
      const dimEl         = get('sm-dim');

      const lastDiagEl    = get('sm-last-diagnosis');
      const lastDiagDtEl  = get('sm-last-diagnosis-date');

      const milkTodayEl   = get('sm-milk-today');
      const milkMonthEl   = get('sm-milk-month');
      const milkSeasonEl  = get('sm-milk-season');

      // الحالة التناسلية
      const repro = animalDoc.reproductiveStatus || animalDoc.reproStatus || '—';
      if (reproStatusEl) reproStatusEl.textContent = repro;

      const insemEvents = rows.filter(r => {
        const t = (r.type || r.eventType || '').toString().toLowerCase();
        return t.includes('تلقي') || t.includes('insemin');
      }).map(r => toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp)).filter(Boolean).sort((a,b)=>a-b);

      if (insemCountEl) insemCountEl.textContent = insemEvents.length ? String(insemEvents.length) : '—';
      if (lastInsemEl)  lastInsemEl.textContent  = insemEvents.length ? fmt.format(insemEvents[insemEvents.length-1]) : '—';

      if (insemEvents.length >= 2) {
        const intervals = insemEvents.slice(1).map((d,i)=> daysBetween(insemEvents[i], d)).filter(v=>v!=null);
        const lastInt   = intervals[intervals.length-1];
        const avgInt    = Math.round(intervals.reduce((a,b)=>a+b,0)/intervals.length);
        if (insemLastInt) insemLastInt.textContent = String(lastInt);
        if (insemAvgInt)  insemAvgInt.textContent  = String(avgInt);
      } else {
        if (insemLastInt) insemLastInt.textContent = '—';
        if (insemAvgInt)  insemAvgInt.textContent  = '—';
      }

      // الحالة الإنتاجية + DIM
      const prod = animalDoc.productionStatus || animalDoc.prodStatus || '—';
      if (prodStatusEl) prodStatusEl.textContent = prod;

      let lastCalving = animalDoc.lastCalvingDate || animalDoc.lastCalving || null;
      lastCalving = toJsDate(lastCalving);
      if (!lastCalving) {
        const calvings = rows.filter(r => {
          const t = (r.type || r.eventType || '').toString().toLowerCase();
          return t.includes('ولاد') || t.includes('calv');
        }).map(r => toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp)).filter(Boolean).sort((a,b)=>b-a);
        if (calvings.length) lastCalving = calvings[0];
      }
      if (dimEl) dimEl.textContent = lastCalving ? String(daysBetween(lastCalving, new Date())) : '—';

      // الذكاء الصحي — آخر تشخيص
      const diagnosisEvents = rows.filter(r => {
        const t = (r.type || r.eventType || '').toString().toLowerCase();
        return t.includes('تشخيص') || t.includes('مرض') || t.includes('diagnos') || t.includes('disease');
      }).sort((a,b)=> (toJsDate(b.eventDate||b.date||b.createdAt||b.timestamp) - toJsDate(a.eventDate||a.date||a.createdAt||a.timestamp)));

      if (diagnosisEvents.length) {
        const last = diagnosisEvents[0];
        const name = last.diseaseName || last.diagnosis || last.diagnosisName || last.disease || '—';
        if (lastDiagEl)   lastDiagEl.textContent   = name;
        if (lastDiagDtEl) lastDiagDtEl.textContent = fmt.format(toJsDate(last.eventDate||last.date||last.createdAt||last.timestamp));
      } else {
        if (lastDiagEl)   lastDiagEl.textContent   = '—';
        if (lastDiagDtEl) lastDiagDtEl.textContent = '—';
      }

      // ذكاء الألبان — اليومي/الشهري/الموسم
      const milkEvents = rows.map(r => ({
        dt: toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp),
        milk: (r.milkKg ?? r.milk ?? r.dailyMilk ?? r.quantity ?? r.amount)
      })).filter(x => x.dt && (x.milk ?? null) != null);

      const today = new Date();
      const month = today.getMonth();
      const year  = today.getFullYear();

      const sum = (arr) => arr.reduce((a,b)=> a + Number(b.milk||0), 0);

      const todayMilk = sum(milkEvents.filter(x => isSameDay(x.dt, today)));
      const monthMilk = sum(milkEvents.filter(x => x.dt.getMonth()===month && x.dt.getFullYear()===year));
      const seasonMilk = lastCalving ? sum(milkEvents.filter(x => x.dt >= lastCalving)) : null;

      if (milkTodayEl)  milkTodayEl.textContent  = todayMilk ? String(todayMilk) : '—';
      if (milkMonthEl)  milkMonthEl.textContent  = monthMilk ? String(monthMilk) : '—';
      if (milkSeasonEl) milkSeasonEl.textContent = (seasonMilk!=null) ? String(seasonMilk) : '—';
    }

    // رسم منحنى إنتاج اللبن اليومي (يعتمد على نفس الأحداث إن توفّرت)
    async function loadMilkSeries(docId, number, preRows) {
      const card   = document.getElementById('milkCard');
      const st     = document.getElementById('milkStatus');
      const canvas = document.getElementById('milkChart');
      if (!card) return;
      try {
        let rows = preRows;
        if (!rows) rows = await loadAllEvents(docId, number);

        const series = rows.map(r => {
          const milk = (r.milkKg ?? r.milk ?? r.dailyMilk ?? r.quantity ?? r.amount);
          const dt = toJsDate(r.eventDate || r.date || r.createdAt || r.timestamp);
          return { dt, milk };
        }).filter(r => r.dt && (r.milk ?? null) != null);

        if (series.length === 0) { st.textContent = 'لا توجد قراءات لإنتاج اللبن بعد.'; return; }

        series.sort((a,b) => a.dt - b.dt);
        const labels = series.map(r => new Intl.DateTimeFormat('ar-EG', { month: 'short', day: 'numeric' }).format(r.dt));
        const data   = series.map(r => Number(r.milk));

        if (typeof Chart === 'undefined') { st.textContent = 'تعذّر تحميل مكتبة الرسم.'; return; }

        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: 'إنتاج اللبن (كجم)', data, tension: 0.3, fill: false, borderWidth: 2, pointRadius: 2 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 6 } }, y: { beginAtZero: true } } }
        });
        st.textContent = `آخر ${data.length} قراءة.`;
      } catch (e) {
        console.error('milk chart error', e);
        st.textContent = 'حدث خطأ أثناء تحميل القراءات.';
      }
    }

    // 4) تحميل الوثيقة حسب docId من الاستعلام ?id=...
    let docId = getQP('id') || getQP('docId') || getQP('number');

    if (!docId) {
      infoBox.style.display = 'none';
      errBox.style.display = 'block';
      errBox.querySelector('.status').textContent = 'لا يوجد معرّف للحيوان في الرابط.';
      throw new Error('Missing ?id');
    }

    status.textContent = 'جارِ التحقق من المستخدم…';

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        status.textContent = 'لم يتم تسجيل الدخول — سيتم تحويلك إلى صفحة الدخول…';
        setTimeout(() => { location.href = 'login.html'; }, 900);
        return;
      }

      try {
        status.textContent = 'جارِ تحميل بيانات الحيوان…';
        const ref = doc(db, 'animals', docId);
        const snap = await getDoc(ref);
        if (!snap.exists()) throw new Error('document-not-found');
        const a = snap.data();

        // دعم حقول قديمة وحديثة
        const number = a.number || a.animalId || '—';
        const type   = a.type || a.animalType || '—';
        const breed  = a.breed || '—';
        const prod   = a.productionStatus || a.prodStatus || '—';
        const repro  = a.reproductiveStatus || a.reproStatus || '—';
        const milk   = (a.dailyMilkProduction ?? a.milk ?? '—');
        const lastC  = a.lastCalvingDate || a.lastCalving || null;
        const lastI  = a.lastInseminationDate || a.lastInsem || null;
        const dob    = a.birthDate || a.dob || null;
        vBreed.textContent  = breed;
        vProd.textContent   = prod;
        vRepro.textContent  = repro;
        vMilk.textContent   = (milk === '—') ? '—' : String(milk);
        vLastC.textContent  = asDate(lastC);
        vLastI.textContent  = asDate(lastI);
        vDob.textContent    = asDate(dob);
        // تحديث عنوان الصفحة بالنوع ورقم الحيوان
        if (titleEl) {
          const t = (type && type !== '—')
            ? ((type === 'بقرة' || type === 'cow' || type === 'Cow') ? 'البقرة'
              : (type === 'جاموسة' || type === 'buffalo' || type === 'Buffalo') ? 'الجاموسة' : 'الحيوان')
            : 'الحيوان';
          titleEl.textContent = `بطاقة ${t}${(number && number !== '—') ? ` رقم (${number})` : ''}`;
        }

        // تحميل الأجواء الذكية + الرسم البياني
        const events = await loadAllEvents(docId, number);
        await fillSmartSections(events, a);
        await loadMilkSeries(docId, number, events);

        // حفظ آخر حيوان لسهولة الإبحار الذكي
        localStorage.setItem('lastAnimalDocId', docId);
        if (number && number !== '—') localStorage.setItem('lastAnimalNumber', number);

        // زر تسجيل حدث: نمرر كل ما يفيد الصفحة التالية
        const qp = new URLSearchParams({ docId, animalNumber: String(number || '') });
        btnAddEvent.href = `add-event.html?${qp.toString()}`;

        infoBox.classList.remove('loading');
        status.innerHTML = '<span class="ok">✓ تم تحميل بطاقة الحيوان بنجاح.</span>';
      } catch (err) {
        console.error(err);
        infoBox.style.display = 'none';
        errBox.style.display = 'block';
        const msg = (err?.message === 'document-not-found')
          ? 'الوثيقة غير موجودة.'
          : 'حدث خطأ أثناء تحميل البيانات.';
        errBox.querySelector('.status').textContent = msg;
      }
    });
  </script>
</body>
</html>
