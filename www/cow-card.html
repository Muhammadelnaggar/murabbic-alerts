<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุจุทุงูุฉ ุงูุจูุฑุฉ โ ูุนุงููุฉ</title>
  <style>
    :root{--bg:#fff9db;--card:#fff;--border:#c5e1a5;--green:#2e7d32;--text:#143b24;--muted:#f6fff2}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.4;color:#143b24;padding:18px}
    .wrap{max-width:920px;margin:0 auto}

    /* ุนููุงู + ุดุฑุงุฆุท ุงูุญุงูุฉ */
    .title{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;margin:0 0 10px}
    .title h1{margin:0;font-size:clamp(18px,4.6vw,28px);color:#14532d}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:700;font-size:13px;color:#0f5132}
    .chip[data-variant="ok"]{background:#e8f5e9;border-color:#c8e6c9;color:#1b5e20}
    .chip[data-variant="warn"]{background:#fff8e1;border-color:#ffe0b2;color:#7a4f00}
    .chip[data-variant="danger"]{background:#ffebee;border-color:#ffcdd2;color:#7f1d1d}
    .chip-repro::before{content:"๐ผ ";} .chip-prod::before{content:"๐ ";} .chip-health::before{content:"๐ฉบ ";}

    /* ุฃูุณุงู ุงูุจุทุงูุฉ */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .card h3{margin:0 0 10px;color:#17623b;font-size:18px}

    /* ุดุจูุฉ ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ */
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .fi{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fcfff8}
    .fi span{color:#2b593a;font-size:13px}
    .fi b{color:#0f5132; direction:ltr; unicode-bidi:plaintext; font-variant-numeric:tabular-nums}

    /* ูุคุดุฑ ุณูุงุช ุงููุจู */
    .milk-gauge-box{width:min(360px,92vw);aspect-ratio:2/1;position:relative;margin:8px auto;display:grid;place-items:center}
    .milk-gauge-box svg{position:absolute;inset:0;width:100%;height:100%;display:block}
    .milk-gauge-box svg *{vector-effect:non-scaling-stroke;shape-rendering:geometricPrecision}
    .milk-gauge-box .val{position:absolute;bottom:8%;inset-inline:0;text-align:center;font-weight:800;color:#065f46;font-size:clamp(14px,4vw,18px)}
    .legend{display:flex;gap:10px;justify-content:center;font-size:12px;color:#355}
    .leg{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}

    /* ุฅูุชุงุฌ ุงููุจู: KPIs + ูุฎุทุท */
    .kpi3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:6px 0 10px}
    @media (max-width:560px){.kpi3{grid-template-columns:1fr}}
    .kpi{border:1px solid var(--border);background:#fcfff8;border-radius:12px;padding:10px;text-align:center}
    .kpi .lbl{font-size:12px;color:#2b593a}
    .kpi .val{font-weight:800;color:#14532d;font-size:clamp(16px,4.6vw,20px)}

    /* ูุฎุทุท ุงูุฅูุชุงุฌ */
    .chart-scroll{overflow-x:auto;overflow-y:hidden;border:1px dashed #c5e1a5;border-radius:12px;background:#fff}
    .prod-chart{display:block;height:240px}
    @media (max-width:560px){.prod-chart{height:200px}}
    .hint{font-size:12px;color:#456;margin-top:6px;text-align:center}

    /* ุฌุฏูู ุงูุญุงูุฉ ุงูุตุญูุฉ ุงููุฎุชุตุฑ */
    .hl{display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;align-items:center}
    .hl.head{font-weight:700;color:#0f5132}
    .hl>div{border:1px solid var(--border);background:#fcfff8;border-radius:10px;padding:8px}
    @media (max-width:560px){.hl{grid-template-columns:100px 1fr}}
    @media (max-width:560px){.hl .note{grid-column:1 / -1}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ุนููุงู + ุดุฑุงุฆุท -->
    <div class="title" aria-label="ุนููุงู ุจุทุงูุฉ ุงูุญููุงู">
      <h1 id="cardTitle">ุจุทุงูุฉ ุงูุจูุฑุฉ ุฑูู โ</h1>
      <div class="chips" role="group" aria-label="ุญุงูุงุช ุงูุญููุงู">
        <div class="chip chip-repro"  id="chipRepro"  data-variant="ok">โ</div>
        <div class="chip chip-prod"   id="chipProd"   data-variant="ok">โ</div>
        <div class="chip chip-health" id="chipHealth" data-variant="ok">โ</div>
      </div>
    </div>

    <!-- ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ -->
    <section class="card" aria-label="ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ">
      <h3>ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h3>
      <div class="grid" id="basicInfo">
        <div class="fi"><span>ุชุงุฑูุฎ ุงููููุงุฏ</span><b id="fiBirth">โ</b></div>
        <div class="fi"><span>ุชุงุฑูุฎ ุขุฎุฑ ููุงุฏุฉ</span><b id="fiLastCalving">โ</b></div>
        <div class="fi"><span>ุฑูู ููุณู ุงูุญููุจ</span><b id="fiLactNo">โ</b></div>
        <div class="fi"><span>ุนุฏุฏ ุฃูุงู ุงูุญููุจ DIM</span><b id="fiDIM">โ</b></div>
        <div class="fi"><span>ุนูุฑ ุงูุญูู (ููู)</span><b id="fiGestAge">โ</b></div>
        <div class="fi"><span>ุงูุณูุงูุฉ</span><b id="fiBreed">โ</b></div>
        <div class="fi"><span>ุงููุฌููุนุฉ</span><b id="fiGroup">โ</b></div>
      </div>
    </section>

    <!-- ุชูููู ุณูุงุช ุงููุจู -->
    <section class="card" aria-label="ุชูููู ุณูุงุช ุงููุจู">
      <h3>ุชูููู ุณูุงุช ุงููุจู</h3>
      <div class="milk-gauge-box">
        <svg viewBox="0 0 100 50" preserveAspectRatio="xMidYMid meet">
          <path id="gBg" d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e5e7eb" stroke-width="12" stroke-linecap="round"/>
          <g id="gSlices"></g>
          <g id="needle" transform="rotate(180 50 50)">
            <line x1="50" y1="50" x2="50" y2="14" stroke="#111" stroke-width="1.8" />
            <circle cx="50" cy="50" r="2.2" fill="#111" />
          </g>
        </svg>
        <div class="val" id="milkGaugeVal" aria-live="polite">โ</div>
      </div>
      <div class="legend" aria-hidden="true">
        <span class="leg"><span class="dot" style="background:#ef5350"></span>ุถุนูู</span>
        <span class="leg"><span class="dot" style="background:#ffb74d"></span>ูุชูุณุท</span>
        <span class="leg"><span class="dot" style="background:#fff176"></span>ุฌูุฏ</span>
        <span class="leg"><span class="dot" style="background:#66bb6a"></span>ููุชุงุฒ</span>
      </div>
    </section>

    <!-- ุฅูุชุงุฌ ุงููุจู -->
    <section class="card" aria-label="ุฅูุชุงุฌ ุงููุจู">
      <h3>ุฅูุชุงุฌ ุงููุจู</h3>
      <div class="kpi3">
        <div class="kpi"><div class="lbl">ุฅูุชุงุฌ ุงูููู</div><div class="val" id="kpiMilkToday">โ</div></div>
        <div class="kpi"><div class="lbl">ุฅูุชุงุฌ ุงูููุณู</div><div class="val" id="kpiSeason">โ</div></div>
        <div class="kpi"><div class="lbl">ุฅูุชุงุฌ 305 ููู</div><div class="val" id="kpi305">โ</div></div>
      </div>
      <div class="chart-scroll" id="milkScroll">
        <svg id="milkChart" class="prod-chart" viewBox="0 0 100 60" preserveAspectRatio="none" aria-label="ูุฎุทุท ุฅูุชุงุฌ ุงููุจู"></svg>
      </div>
      <div class="hint">ูุนุฑุถ ูุงูู ูุชุฑุฉ ุงูุญููุจ โ ุงุณุญุจ/ุชูุฑูุฑ ุฃููููุง ููุดุงูุฏุฉ ูู ุงูุฃูุงู (ูุฌู/ููู)</div>
    </section>

    <!-- ุงูุญุงูุฉ ุงูุชูุงุณููุฉ -->
    <section class="card" aria-label="ุงูุญุงูุฉ ุงูุชูุงุณููุฉ">
      <h3>ุงูุญุงูุฉ ุงูุชูุงุณููุฉ</h3>
      <div class="grid">
        <div class="fi"><span>ุชุงุฑูุฎ ุขุฎุฑ ุชูููุญ</span><b id="fiLastIns">โ</b></div>
        <div class="fi"><span>ูุชูุณุท ุฎุฏูุงุช/ุญูู</span><b id="fiSPC">โ</b></div>
        <div class="fi"><span>ูุนุฏู ุงูุฃูุงู ุจูู ุงูุชูููุญ</span><b id="fiServiceInterval">โ</b></div>
        <div class="fi"><span>ุชุงุฑูุฎ ุขุฎุฑ ุดูุงุน</span><b id="fiLastHeat">โ</b></div>
        <div class="fi"><span>ุงูุฃูุงู ุจูู ุงูุดูุงุน</span><b id="fiHeatInterval">โ</b></div>
        <div class="fi"><span>ุจุฑูุชูููู Ovsynch</span><b id="fiOvsynch">โ</b></div>
      </div>
    </section>

    <!-- ุงูุญุงูุฉ ุงูุตุญูุฉ -->
    <section class="card" aria-label="ุงูุญุงูุฉ ุงูุตุญูุฉ">
      <h3>ุงูุญุงูุฉ ุงูุตุญูุฉ</h3>
      <div class="grid">
        <div class="fi"><span>ุงูุญุงูุฉ ุงูุญุงููุฉ</span><b id="fiHealth">โ</b></div>
        <div class="fi"><span>ุขุฎุฑ ูุญุต</span><b id="fiLastCheck">โ</b></div>
      </div>
      <div style="margin-top:10px">
        <div class="hl head">
          <div>ุงูุชุงุฑูุฎ</div><div>ุงูุชุดุฎูุต</div><div class="note">ููุงุญุธุฉ</div>
        </div>
        <div id="healthList"></div>
      </div>
    </section>
  </div>

  <!-- Firestore + ุฑุจุท ุงูุจูุงูุงุช (ุจุฏูู ุฃู ุนูุงุตุฑ ุชูุงุฑูุฑ ูููุณุชุฎุฏู) -->
  <script type="module">
    // Firebase / Firestore
    const appMod = await import('/js/firebase-config.js');
    const { getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy, limit } =
      await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
    const app = appMod.app || appMod.default || appMod;
    const db  = appMod.db  || getFirestore(app.app || app);

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const put=(id,v)=>{const n=$(id); if(n) n.textContent = (v ?? 'โ');};
    const fmtD=(s)=> s? new Date(s).toLocaleDateString('ar-EG') : 'โ';
    const NF = new Intl.NumberFormat('ar-EG');
    const todayStr = new Date().toISOString().slice(0,10);

    function variantFor(txt){
      const t = String(txt||'').toLowerCase();
      if (/ุณููู|ุญุงูู|ุทุจูุนู|ูุฑูุญ/.test(t)) return 'ok';
      if (/ููุชูุญ|ุฎุทุฑ ููุฎูุถ|ูุชูุณุท/.test(t)) return 'warn';
      if (/ุญุงุฏ|ุดุฏูุฏ|ูุฑุถ|ููุงุณ ูุชุนุซุฑ/.test(t)) return 'danger';
      return 'ok';
    }
    function setChip(el, text){ if(!el) return; el.textContent = text || 'โ'; el.setAttribute('data-variant', variantFor(text)); }
    function polar(cx, cy, r, ang){ const a=(ang*Math.PI)/180; return [cx + r*Math.cos(a), cy + r*Math.sin(a)]; }
    function arcPath(cx, cy, r, a0, a1){ const [x0,y0]=polar(cx,cy,r,a0), [x1,y1]=polar(cx,cy,r,a1); return `M ${x0.toFixed(3)} ${y0.toFixed(3)} A ${r} ${r} 0 0 1 ${x1.toFixed(3)} ${y1.toFixed(3)}`; }

    // ููุงุชูุญ ุงูุฏุฎูู
    const url = new URL(location.href);
    const numberParam  = url.searchParams.get('number') || url.searchParams.get('animalNumber') || url.searchParams.get('num') || '';
    const animalIdParam= url.searchParams.get('animalId') || '';
    const userId = (window.__tenant?.userId || localStorage.getItem('userId') || '').trim();

    // ุฌูุจ ุงูุญููุงู
    async function loadAnimal(){
      if (!userId) throw new Error('userId ุบูุฑ ูุชุงุญ');
      if (animalIdParam){
        const d = await getDoc(doc(db, 'animals', animalIdParam));
        if (d.exists() && d.data().userId === userId) return { id:d.id, ...d.data() };
      }
      if (numberParam){
        const key = `${userId}#${numberParam}`;
        let snap = await getDocs(query(collection(db,'animals'), where('userId_number','==', key), limit(1)));
        if (snap.empty){
          snap = await getDocs(query(collection(db,'animals'),
                   where('userId','==', userId), where('number','==', numberParam), limit(1)));
        }
        const docu = snap.docs[0];
        if (docu) return { id: docu.id, ...docu.data() };
      }
      throw new Error('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุญููุงู');
    }

    // ุฌูุจ ุงูุฃุญุฏุงุซ
    async function loadEvents(animal){
      let evSnap = await getDocs(query(
        collection(db,'events'),
        where('userId','==', userId),
        where('animalId','==', animal.id)
      ));
      if (evSnap.empty && (animal.number || numberParam)){
        evSnap = await getDocs(query(
          collection(db,'events'),
          where('userId','==', userId),
          where('animalNumber','==', String(animal.number || numberParam))
        ));
      }
      return evSnap.docs.map(d=>({ id:d.id, ...d.data() }))
                        .sort((a,b)=> String(a.eventDate).localeCompare(String(b.eventDate)));
    }

    // ุญุณุงุจ ุงูููุงููุณ
    function computeState(animal, events){
      const state = {
        number: animal.number ?? animal.id?.slice(-6),
        reproductiveStatus: 'โ',
        productionStatus: 'โ',
        healthStatus: 'ุณููู',

        birthDate: animal.birthDate || null,
        lastCalvingDate: null,
        lactationNumber: animal.lactationNumber ?? null,
        daysInMilk: null,
        gestationDays: null,
        lastInseminationDate: null,
        pregnancyDate: animal.pregnancyDate || null,
        breed: animal.breed || 'โ',
        group: animal.group || 'โ',
        milkTraitsScore: animal.milkTraitsScore ?? 0,

        servicesCount: 0,
        inseminations: [],
        estrusDates: [],
        ovsynch: animal.ovsynch || null,

        milkTodayKg: null,
        seasonTotalKg: null,
        m305Kg: null,
        milkSeries: [],

        lastCheckDate: animal.lastCheckDate || null,
        healthHistory: []
      };

      const byType = (t)=> events.filter(e => (e.type===t || e.eventType===t));
      const milkEv = byType('daily_milk').concat(byType('ูุจู ูููู'));
      const calvEv = byType('calving').concat(byType('ููุงุฏุฉ'));
      const insEv  = byType('insemination').concat(byType('ุชูููุญ'));
      const heatEv = byType('heat').concat(byType('ุดูุงุน'));
      const diseaseEv = events.filter(e => /ูุฑุถ|mastitis|lameness|ุงูุชูุงุจ|ุนุฑุฌ/i.test(String(e.type)+' '+String(e.eventType)));

      const lastCalving = calvEv.slice(-1)[0];
      state.lastCalvingDate = lastCalving?.eventDate || animal.lastCalvingDate || null;

      if (state.lastCalvingDate){
        const ms = Date.now() - new Date(state.lastCalvingDate).getTime();
        state.daysInMilk = Math.max(0, Math.floor(ms/86400000));
      }

      state.inseminations = insEv.map(e=> e.eventDate).filter(Boolean);
      state.servicesCount = state.inseminations.length;
      state.lastInseminationDate = state.inseminations.slice(-1)[0] || null;

      state.estrusDates = heatEv.map(e=> e.eventDate).filter(Boolean);

      if (milkEv.length){
        const series = [];
        let seasonSum = 0;
        const calvDay = state.lastCalvingDate ? new Date(state.lastCalvingDate).getTime() : null;

        for (const e of milkEv){
          const kg = Number(e.milkKg ?? 0);
          seasonSum += kg;
          if (e.eventDate){
            if (calvDay){
              const di = Math.floor((new Date(e.eventDate).getTime() - calvDay)/86400000);
              series.push({ d: Math.max(0, di), v: kg });
            } else {
              series.push({ d: series.length, v: kg });
            }
          }
          if (e.eventDate === todayStr) state.milkTodayKg = kg;
        }
        state.seasonTotalKg = seasonSum || null;
        if (state.daysInMilk && state.daysInMilk>0 && state.seasonTotalKg!=null){
          const avg = state.seasonTotalKg / state.daysInMilk;
          state.m305Kg = Math.round(avg * 305);
        }
        state.milkSeries = series.sort((a,b)=>a.d-b.d);
      }

      state.healthHistory = diseaseEv.map(d => ({
        date: d.eventDate || '',
        diagnosis: d.diagnosis || d.eventType || d.type || 'โ',
        note: d.note || ''
      }));

      state.reproductiveStatus = state.pregnancyDate ? 'ุญุงูู'
