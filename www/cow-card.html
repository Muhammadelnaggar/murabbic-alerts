<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù‚Ø±Ø© â€“ Ù…Ø¹Ø§ÙŠÙ†Ø©</title>
  <style>
    :root{--bg:#fff9db;--card:#fff;--border:#c5e1a5;--green:#2e7d32;--text:#114;--muted:#f6fff2}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.4;color:#143b24;padding:18px}
    .wrap{max-width:920px;margin:0 auto}

    /* Ø¹Ù†ÙˆØ§Ù† + Ø´Ø±Ø§Ø¦Ø· Ø§Ù„Ø­Ø§Ù„Ø© */
    .title{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;margin:0 0 10px}
    .title h1{margin:0;font-size:clamp(18px,4.6vw,28px);color:#14532d}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:700;font-size:13px;color:#0f5132}
    .chip-repro::before{content:"ğŸ¼ ";}
    .chip-prod::before{content:"ğŸ“ˆ ";}
    .chip-health::before{content:"ğŸ©º ";}

    /* Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .card h3{margin:0 0 10px;color:#17623b;font-size:18px}

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .fi{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fcfff8}
    .fi span{color:#2b593a;font-size:13px}
    .fi b{color:#0f5132}

    /* Ù…Ø¤Ø´Ø± Ø³Ù…Ø§Øª Ø§Ù„Ù„Ø¨Ù† (SVG Ù†ØµÙ Ø¯Ø§Ø¦Ø±Ø© Responsive) */
    .milk-gauge-box{width:min(360px,92vw);aspect-ratio:2/1;position:relative;margin:8px auto;display:grid;place-items:center}
    .milk-gauge-box svg{position:absolute;inset:0;width:100%;height:100%;display:block}
    .milk-gauge-box .val{position:absolute;bottom:8%;inset-inline:0;text-align:center;font-weight:800;color:#065f46;font-size:clamp(14px,4vw,18px)}
    .legend{display:flex;gap:10px;justify-content:center;font-size:12px;color:#355}
    .leg{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}

    /* Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†: KPIs + Ù…Ø®Ø·Ø· */
    .kpi3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:6px 0 10px}
    @media (max-width:560px){.kpi3{grid-template-columns:1fr}}
    .kpi{border:1px solid var(--border);background:#fcfff8;border-radius:12px;padding:10px;text-align:center}
    .kpi .lbl{font-size:12px;color:#2b593a}
    .kpi .val{font-weight:800;color:#14532d;font-size:clamp(16px,4.6vw,20px)}

    /* Ù…Ø®Ø·Ø· Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠ Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ù„ÙŠØ¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    .chart-scroll{overflow-x:auto;overflow-y:hidden;border:1px dashed #c5e1a5;border-radius:12px;background:#fff}
    .prod-chart{display:block;height:240px}
    @media (max-width:560px){.prod-chart{height:200px}}
    .hint{font-size:12px;color:#456;margin-top:6px;text-align:center}

    /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ù…Ø®ØªØµØ± */
    .hl{display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;align-items:center}
    .hl.head{font-weight:700;color:#0f5132}
    .hl>div{border:1px solid var(--border);background:#fcfff8;border-radius:10px;padding:8px}
    @media (max-width:560px){.hl{grid-template-columns:100px 1fr}}
    @media (max-width:560px){.hl .note{grid-column:1 / -1}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Ø¹Ù†ÙˆØ§Ù† + Ø´Ø±Ø§Ø¦Ø· -->
    <div class="title">
      <h1 id="cardTitle">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù‚Ø±Ø© Ø±Ù‚Ù… â€”</h1>
      <div class="chips">
        <div class="chip chip-repro" id="chipRepro">â€”</div>
        <div class="chip chip-prod"  id="chipProd">â€”</div>
        <div class="chip chip-health" id="chipHealth">â€”</div>
      </div>
    </div>

    <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <section class="card">
      <h3>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
      <div class="grid" id="basicInfo">
        <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</span><b id="fiBirth">â€”</b></div>
        <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙˆÙ„Ø§Ø¯Ø©</span><b id="fiLastCalving">â€”</b></div>
        <div class="fi"><span>Ø±Ù‚Ù… Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨</span><b id="fiLactNo">â€”</b></div>
        <div class="fi"><span>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ DIM</span><b id="fiDIM">â€”</b></div>
        <div class="fi"><span>Ø¹Ù…Ø± Ø§Ù„Ø­Ù…Ù„ (ÙŠÙˆÙ…)</span><b id="fiGestAge">â€”</b></div>
        <div class="fi"><span>Ø§Ù„Ø³Ù„Ø§Ù„Ø©</span><b id="fiBreed">â€”</b></div>
        <div class="fi"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span><b id="fiGroup">â€”</b></div>
      </div>
    </section>

    <!-- ØªÙ‚ÙŠÙŠÙ… Ø³Ù…Ø§Øª Ø§Ù„Ù„Ø¨Ù† -->
    <section class="card">
      <h3>ØªÙ‚ÙŠÙŠÙ… Ø³Ù…Ø§Øª Ø§Ù„Ù„Ø¨Ù†</h3>
      <div class="milk-gauge-box">
        <svg viewBox="0 0 100 50" preserveAspectRatio="none">
          <!-- Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© -->
          <path id="gBg" d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e5e7eb" stroke-width="12" stroke-linecap="round"/>
          <!-- Ø³ÙŠÙØ­Ù‚Ù† Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¹Ø¨Ø± JS -->
          <g id="gSlices"></g>
          <!-- Ø§Ù„Ø¥Ø¨Ø±Ø© -->
          <g id="needle" transform="rotate(180 50 50)">
            <line x1="50" y1="50" x2="50" y2="14" stroke="#111" stroke-width="1.6" />
            <circle cx="50" cy="50" r="2.2" fill="#111" />
          </g>
        </svg>
        <div class="val" id="milkGaugeVal">â€”</div>
      </div>
      <div class="legend">
        <span class="leg"><span class="dot" style="background:#ef5350"></span>Ø¶Ø¹ÙŠÙ</span>
        <span class="leg"><span class="dot" style="background:#ffb74d"></span>Ù…ØªÙˆØ³Ø·</span>
        <span class="leg"><span class="dot" style="background:#fff176"></span>Ø¬ÙŠØ¯</span>
        <span class="leg"><span class="dot" style="background:#66bb6a"></span>Ù…Ù…ØªØ§Ø²</span>
      </div>
    </section>

    <!-- Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†: KPIs + Ù…Ø®Ø·Ø· ÙƒØ§Ù…Ù„ Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨ -->
    <section class="card">
      <h3>Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†</h3>
      <div class="kpi3">
        <div class="kpi"><div class="lbl">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…</div><div class="val" id="kpiMilkToday">â€”</div></div>
        <div class="kpi"><div class="lbl">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù…ÙˆØ³Ù…</div><div class="val" id="kpiSeason">â€”</div></div>
        <div class="kpi"><div class="lbl">Ø¥Ù†ØªØ§Ø¬ 305 ÙŠÙˆÙ…</div><div class="val" id="kpi305">â€”</div></div>
      </div>
      <div class="chart-scroll" id="milkScroll">
        <svg id="milkChart" class="prod-chart" viewBox="0 0 100 60" preserveAspectRatio="none" aria-label="Ù…Ø®Ø·Ø· Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù†"></svg>
      </div>
      <div class="hint">ÙŠØ¹Ø±Ø¶ ÙƒØ§Ù…Ù„ ÙØªØ±Ø© Ø§Ù„Ø­Ù„ÙŠØ¨ â€” Ø§Ø³Ø­Ø¨/ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠÙ‹Ø§ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù… (ÙƒØ¬Ù…/ÙŠÙˆÙ…)</div>
    </section>

    <!-- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ© (Ù…ÙˆØ³Ø¹Ø©) -->
    <section class="card"><h3>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø§Ø³Ù„ÙŠØ©</h3>
      <div class="grid">
        <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªÙ„Ù‚ÙŠØ­</span><b id="fiLastIns">â€”</b></div>
        <div class="fi"><span>Ù…ØªÙˆØ³Ø· Ø®Ø¯Ù…Ø§Øª/Ø­Ù…Ù„</span><b id="fiSPC">â€”</b></div>
        <div class="fi"><span>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† Ø§Ù„ØªÙ„Ù‚ÙŠØ­</span><b id="fiServiceInterval">â€”</b></div>
        <div class="fi"><span>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø´ÙŠØ§Ø¹</span><b id="fiLastHeat">â€”</b></div>
        <div class="fi"><span>Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† Ø§Ù„Ø´ÙŠØ§Ø¹</span><b id="fiHeatInterval">â€”</b></div>
        <div class="fi"><span>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ovsynch</span><b id="fiOvsynch">â€”</b></div>
      </div>
    </section>

    <!-- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© -->
    <section class="card"><h3>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©</h3>
      <div class="grid">
        <div class="fi"><span>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span><b id="fiHealth">â€”</b></div>
        <div class="fi"><span>Ø¢Ø®Ø± ÙØ­Øµ</span><b id="fiLastCheck">â€”</b></div>
      </div>
      <div style="margin-top:10px">
        <div class="hl head">
          <div>Ø§Ù„ØªØ§Ø±ÙŠØ®</div><div>Ø§Ù„ØªØ´Ø®ÙŠØµ</div><div class="note">Ù…Ù„Ø§Ø­Ø¸Ø©</div>
        </div>
        <div id="healthList"></div>
      </div>
    </section>
  </div>
<script src="js/mbk-animals.js?v=2"></script>

<script>
  // ====== Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø§Ø­Ù‚Ù‹Ø§) ======
  const state = {
    number: 2,
    reproductiveStatus: 'Ù…ÙØªÙˆØ­Ø©',          // Ø´Ø§Ø±Ø© ØªÙ†Ø§Ø³Ù„ÙŠØ© Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    productionStatus: 'Ø­Ù„ÙŠØ¨ Ù…Ø¨ÙƒØ±',          // Ø´Ø§Ø±Ø© Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    healthStatus: 'Ø³Ù„ÙŠÙ…',                    // Ø´Ø§Ø±Ø© ØµØ­ÙŠØ© Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†

    birthDate: '2021-03-25',
    lastCalvingDate: '2025-06-30',
    lactationNumber: 3,
    daysInMilk: 147,
    gestationDays: null,                     // Ù„Ùˆ null ÙŠÙØ­ØªØ³Ø¨ Ù…Ù† lastInseminationDate
    lastInseminationDate: '2025-07-15',
    breed: 'Ù‡ÙˆÙ„Ø´ØªØ§ÙŠÙ†',
    group: 'Ø£-Ø§Ù„Ø­Ù„Ø§Ø¨Ø§Øª',
    milkTraitsScore: 78,                     // 0..100

    // â€”â€”â€” ØªÙ†Ø§Ø³Ù„ÙŠ â€”â€”â€”
    servicesCount: 2,
    pregnancyDate: '2025-09-02',
    inseminations: ['2025-07-15','2025-08-08'],
    estrusDates: ['2025-07-01','2025-07-23','2025-08-14','2025-09-05'],
    ovsynch: { active:true, name:'Ovsynch', started:'2025-07-02' },

    // â€”â€”â€” Ø§Ù„Ø¥Ù†ØªØ§Ø¬ â€”â€”â€” (Ø³Ù„Ø³Ù„Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ù„ÙŠØ¨)
    milkTodayKg: 23.4,
    seasonTotalKg: 3150,
    m305Kg: 6800,
    milkSeries: (function(){
      // ØªÙˆÙ„ÙŠØ¯ 150 ÙŠÙˆÙ… ÙƒÙ…Ø«Ø§Ù„
      const N = 150; const arr=[]; for(let i=0;i<N;i++){ arr.push({d:i, v: 17 + Math.sin(i/4)*2.5 + (i>40? (i-40)*0.08:0)}); } return arr;
    })(),

    // â€”â€”â€” ØµØ­Ø© â€”â€”â€”
    lastCheckDate: '2025-09-10',
    healthHistory: [
      {date:'2025-08-10', diagnosis:'Ø­Ù…Ù‰ Ø§Ù„Ù„Ø¨Ù†', note:'Ø®ÙÙŠÙØ© â€“ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø³Ø±ÙŠØ¹Ø©'},
      {date:'2025-08-28', diagnosis:'Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¶Ø±Ø¹ Ø®ÙÙŠÙ', note:'Ø±Ø¨Ø¹ Ø®Ù„ÙÙŠ ÙŠÙ…ÙŠÙ†'},
      {date:'2025-09-10', diagnosis:'Ø³Ù„ÙŠÙ…', note:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}
    ]
  };

  const $ = (id)=>document.getElementById(id);
  const put=(id,v)=>{const n=$(id); if(n) n.textContent = (v ?? 'â€”');};
  const fmtD=(s)=> s? new Date(s).toLocaleDateString('ar-EG') : 'â€”';

  // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† + Ø§Ù„Ø´Ø±Ø§Ø¦Ø·
  put('cardTitle', `Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù‚Ø±Ø© Ø±Ù‚Ù… ${state.number ?? 'â€”'}`);
  put('chipRepro', state.reproductiveStatus || 'â€”');
  put('chipProd',  state.productionStatus  || 'â€”');
  put('chipHealth', state.healthStatus || 'â€”');

  // Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  put('fiBirth', fmtD(state.birthDate));
  put('fiLastCalving', fmtD(state.lastCalvingDate));
  put('fiLactNo', state.lactationNumber);
  put('fiDIM', state.daysInMilk);
  put('fiBreed', state.breed);
  put('fiGroup', state.group);

  // Ø¹Ù…Ø± Ø§Ù„Ø­Ù…Ù„ (ÙŠÙˆÙ…)
  let gestDays = state.gestationDays;
  if (gestDays == null && state.lastInseminationDate) {
    const ms = Date.now() - new Date(state.lastInseminationDate).getTime();
    gestDays = Math.max(0, Math.floor(ms / 86400000));
  }
  put('fiGestAge', (gestDays!=null)?gestDays:'â€”');

  // ====== ØªÙ‚ÙŠÙŠÙ… Ø³Ù…Ø§Øª Ø§Ù„Ù„Ø¨Ù† (SVG) ======
  function polar(cx, cy, r, ang){
    const a = (ang*Math.PI)/180; return [cx + r*Math.cos(a), cy + r*Math.sin(a)];
  }
  function arcPath(cx, cy, r, a0, a1){
    const [x0,y0] = polar(cx,cy,r,a0), [x1,y1]=polar(cx,cy,r,a1);
    return `M ${x0.toFixed(3)} ${y0.toFixed(3)} A ${r} ${r} 0 0 1 ${x1.toFixed(3)} ${y1.toFixed(3)}`;
  }
  (function renderGauge(score){
    score = Math.max(0, Math.min(100, Number(score)||0));
    const g = document.getElementById('gSlices');
    if(!g) return; g.innerHTML = '';
    const colors = ['#ef5350','#ffb74d','#fff176','#66bb6a']; // Ø¶Ø¹ÙŠÙâ†’Ù…Ù…ØªØ§Ø²
    const steps  = [0,25,50,75,100];
    for(let i=0;i<4;i++){
      const s = steps[i], e = steps[i+1];
      const a0 = 180 - (s/100)*180;
      const a1 = 180 - (e/100)*180;
      const p = document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('d', arcPath(50,50,40,a0,a1));
      p.setAttribute('fill','none');
      p.setAttribute('stroke', colors[i]);
      p.setAttribute('stroke-width','12');
      p.setAttribute('stroke-linecap','round');
      g.appendChild(p);
    }
    const ang = 180 - (score/100)*180; // 0..100 â†¦ 180..0
    const needle = document.getElementById('needle');
    if(needle){ needle.setAttribute('transform',`rotate(${ang} 50 50)`); }
    const valEl = document.getElementById('milkGaugeVal');
    if(valEl){ valEl.textContent = `${score}%`; }
  })(state.milkTraitsScore);

  // ====== KPIs Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† ======
  put('kpiMilkToday', (state.milkTodayKg!=null? state.milkTodayKg.toFixed(1)+' ÙƒØ¬Ù…' : 'â€”'));
  put('kpiSeason', (state.seasonTotalKg!=null? state.seasonTotalKg.toLocaleString('ar-EG')+' ÙƒØ¬Ù…' : 'â€”'));
  put('kpi305', (state.m305Kg!=null? state.m305Kg.toLocaleString('ar-EG')+' ÙƒØ¬Ù…' : 'â€”'));

  // ====== Ø±Ø³Ù… Ù…Ø®Ø·Ø· Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ù„Ø¨Ù† (ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ÙˆØ³Ù… + ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠ) ======
  (function renderMilkChart(series){
    const svg = document.getElementById('milkChart');
    const sc  = document.getElementById('milkScroll');
    if(!svg || !series || !series.length) return;
    const data = series.map((p,i)=>({x:i, y:Number(p.v)||0}));
    const N = data.length;
    const pad = 10; // Ù‡Ø§Ù…Ø´ Ø¯Ø§Ø®Ù„ÙŠ
    const pxPer = (window.innerWidth<560)? 6 : 7; // Ø¹Ø±Ø¶ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„
    const W = pad*2 + (N-1)*pxPer + 20; // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„
    const H = (svg.clientHeight||240);   // Ø§Ø±ØªÙØ§Ø¹ ÙØ¹Ù„ÙŠ Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„

    // Ø§Ø¬Ø¹Ù„ Ø§Ù„SVG Ø£Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ±
    svg.setAttribute('viewBox', `0 0 ${W} 60`);
    svg.style.width = W + 'px';

    const maxY = Math.max(...data.map(d=>d.y), 1);
    const minY = Math.min(...data.map(d=>d.y), 0);
    const yRange = Math.max(1, maxY - minY);
    const sx = (i)=> pad + (i*pxPer);
    const sy = (v)=> 60 - 6 - ((v - minY) * (60-12)/yRange);

    // Ù…Ø³Ø§Ø± Ø§Ù„Ø®Ø·
    let d = '';
    data.forEach((p,i)=>{ d += (i? ' L ':'M ') + sx(i).toFixed(2) + ' ' + sy(p.y).toFixed(2); });
    // Ù…Ù†Ø·Ù‚Ø© ØªØ­Øª Ø§Ù„Ø®Ø·
    const area = d + ` L ${sx(N-1).toFixed(2)} ${60-6} L ${sx(0).toFixed(2)} ${60-6} Z`;

    svg.innerHTML = '';
    // Ø´Ø¨ÙƒØ© Ø®ÙÙŠÙØ©
    const grid = document.createElementNS('http://www.w3.org/2000/svg','g');
    for(let i=1;i<=3;i++){
      const y = 6 + i*(60-12)/3; const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', 6); line.setAttribute('x2', W-6); line.setAttribute('y1', y); line.setAttribute('y2', y);
      line.setAttribute('stroke', '#e9f5dc'); line.setAttribute('stroke-width', '0.6');
      grid.appendChild(line);
    }
    svg.appendChild(grid);

    const ap = document.createElementNS('http://www.w3.org/2000/svg','path');
    ap.setAttribute('d', area); ap.setAttribute('fill', '#cdeccd'); ap.setAttribute('opacity','0.6');
    svg.appendChild(ap);

    const lp = document.createElementNS('http://www.w3.org/2000/svg','path');
    lp.setAttribute('d', d); lp.setAttribute('fill','none'); lp.setAttribute('stroke','#2e7d32'); lp.setAttribute('stroke-width','1.2');
    svg.appendChild(lp);

    // Ù†Ù‚Ø·Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
    const cx = sx(N-1), cy = sy(data[N-1].y);
    const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
    dot.setAttribute('cx', cx); dot.setAttribute('cy', cy); dot.setAttribute('r', 2); dot.setAttribute('fill', '#1b5e20');
    svg.appendChild(dot);

    // ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ù„Ø³Ù„Ø© (Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ)
    setTimeout(()=>{ sc.scrollLeft = svg.scrollWidth; }, 0);
  })(state.milkSeries);

  // ====== ØªÙ†Ø§Ø³Ù„ÙŠ (Ø­Ø³Ø§Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©) ======
  function avgDaysBetween(dates){
    if(!dates || dates.length<2) return null;
    const ms = dates.map(d=> new Date(d).getTime()).sort((a,b)=>a-b);
    const diffs = []; for(let i=1;i<ms.length;i++){ diffs.push((ms[i]-ms[i-1])/86400000); }
    const avg = diffs.reduce((a,b)=>a+b,0)/diffs.length; return Math.round(avg);
  }

  put('fiLastIns', fmtD(state.lastInseminationDate));

  // SPC: Ø¹Ø¯Ø¯ Ø®Ø¯Ù…Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø­Ù…Ù„ ÙÙŠ Ù…ÙˆØ³Ù… Ø¬Ø§Ø±ÙŠ (ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)
  let spc = state.servicesCount;
  if(Array.isArray(state.inseminations) && state.pregnancyDate){
    const pd = new Date(state.pregnancyDate).getTime();
    spc = state.inseminations.filter(d=> new Date(d).getTime() <= pd).length || spc;
  }
  put('fiSPC', (spc!=null)? spc : 'â€”');

  const serviceInt = avgDaysBetween(state.inseminations);
  put('fiServiceInterval', serviceInt!=null? (serviceInt+' ÙŠÙˆÙ…') : 'â€”');

  const lastHeat = (state.estrusDates && state.estrusDates.length) ? state.estrusDates[state.estrusDates.length-1] : null;
  put('fiLastHeat', fmtD(lastHeat));
  const heatInt = avgDaysBetween(state.estrusDates);
  put('fiHeatInterval', heatInt!=null? (heatInt+' ÙŠÙˆÙ…') : 'â€”');

  if(state.ovsynch && state.ovsynch.active){
    put('fiOvsynch', `${state.ovsynch.name||'Ovsynch'} â€” Ø¨Ø¯Ø£ ${fmtD(state.ovsynch.started)}`);
  } else { put('fiOvsynch','â€”'); }

  // ====== ØµØ­Ø© ======
  put('fiHealth', state.healthStatus||'â€”');
  put('fiLastCheck', fmtD(state.lastCheckDate));
  const hl = document.getElementById('healthList');
  if(Array.isArray(state.healthHistory) && state.healthHistory.length){
    state.healthHistory.forEach(it=>{
      const row = document.createElement('div'); row.className='hl';
      const d=document.createElement('div'); d.textContent = fmtD(it.date);
      const dx=document.createElement('div'); dx.textContent = it.diagnosis || 'â€”';
      const nt=document.createElement('div'); nt.className='note'; nt.textContent = it.note || '';
      row.appendChild(d); row.appendChild(dx); row.appendChild(nt);
      hl.appendChild(row);
    });
  }
</script>
</body>
</html>

